<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">math</span> <span class="keyword">import</span> <span class="identifier">ceil</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">norm</span><span class="punctuation">,</span> <span class="identifier">randint</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">experimental</span> <span class="keyword">import</span> <span class="identifier">enable_halving_search_cv</span>  <span class="comment"># noqa</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">StratifiedKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">StratifiedShuffleSplit</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">LeaveOneGroupOut</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">LeavePGroupsOut</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GroupKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GroupShuffleSplit</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">HalvingGridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">HalvingRandomSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">KFold</span><span class="punctuation">,</span> <span class="identifier">ShuffleSplit</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span><span class="punctuation">.</span><span class="identifier">_search_successive_halving</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">_SubsampleMetaSplitter</span><span class="punctuation">,</span> <span class="identifier">_top_k</span><span class="punctuation">,</span> <span class="identifier">_refit_callable</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="identifier">DummyClassifier</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Dummy classifier that accepts parameters a, b, ... z.

    These parameter don't affect the predictions and are useful for fast
    grid searching."""</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'stratified'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">constant</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="identifier">strategy</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                         <span class="identifier">constant</span><span class="arithmetic-assignment">=</span><span class="identifier">constant</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="identifier">deep</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">char</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">ord</span><span class="grouping">(</span><span class="string-literal">'a'), ord('z'</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">params</span><span class="grouping">[</span><span class="identifier">chr</span><span class="grouping">(</span><span class="identifier">char</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'whatever'</span>
        <span class="keyword">return</span> <span class="identifier">params</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingGridSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="grouping">(</span><span class="string-literal">'aggressive_elimination,'</span>
     <span class="string-literal">'max_resources,'</span>
     <span class="string-literal">'expected_n_iterations,'</span>
     <span class="string-literal">'expected_n_required_iterations,'</span>
     <span class="string-literal">'expected_n_possible_iterations,'</span>
     <span class="string-literal">'expected_n_remaining_candidates,'</span>
     <span class="string-literal">'expected_n_candidates,'</span>
     <span class="string-literal">'expected_n_resources,'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span>
         <span class="comment"># notice how it loops at the beginning</span>
         <span class="comment"># also, the number of candidates evaluated at the last iteration is</span>
         <span class="comment"># &lt;= factor</span>
         <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">'limited'</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="comment"># no aggressive elimination: we end up with less iterations, and</span>
         <span class="comment"># the number of candidates at the last iter is &gt; factor, which isn't</span>
         <span class="comment"># ideal</span>
         <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">'limited'</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="comment">#  # When the amount of resource isn't limited, aggressive_elimination</span>
        <span class="comment">#  # has no effect. Here the default min_resources='exhaust' will take</span>
        <span class="comment">#  # over.</span>
         <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">'unlimited'</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">37</span><span class="punctuation">,</span> <span class="int-literal">111</span><span class="punctuation">,</span> <span class="int-literal">333</span><span class="punctuation">,</span> <span class="int-literal">999</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">'unlimited'</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">37</span><span class="punctuation">,</span> <span class="int-literal">111</span><span class="punctuation">,</span> <span class="int-literal">333</span><span class="punctuation">,</span> <span class="int-literal">999</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_aggressive_elimination</span><span class="grouping">(</span>
        <span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">aggressive_elimination</span><span class="punctuation">,</span> <span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">expected_n_iterations</span><span class="punctuation">,</span>
        <span class="identifier">expected_n_required_iterations</span><span class="punctuation">,</span> <span class="identifier">expected_n_possible_iterations</span><span class="punctuation">,</span>
        <span class="identifier">expected_n_remaining_candidates</span><span class="punctuation">,</span> <span class="identifier">expected_n_candidates</span><span class="punctuation">,</span>
        <span class="identifier">expected_n_resources</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the aggressive_elimination parameter.</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': ('l1', 'l2'), 'b'</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">max_resources</span> <span class="relational-operator">==</span> <span class="string-literal">'limited'</span><span class="punctuation">:</span>
        <span class="identifier">max_resources</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">180</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">max_resources</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span>
             <span class="identifier">aggressive_elimination</span><span class="arithmetic-assignment">=</span><span class="identifier">aggressive_elimination</span><span class="punctuation">,</span>
             <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>  <span class="comment"># just for test coverage</span>

    <span class="keyword">if</span> <span class="identifier">Est</span> <span class="relational-operator">is</span> <span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">:</span>
        <span class="comment"># same number of candidates as with the grid</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">min_resources</span><span class="arithmetic-assignment">=</span><span class="string-literal">'exhaust'</span><span class="grouping">)</span>

    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_required_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_required_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_possible_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_possible_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_resources_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_resources</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_candidates_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_candidates</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_remaining_candidates_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_remaining_candidates</span>
    <span class="keyword">assert</span> <span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_candidates_</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">factor</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_remaining_candidates_</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingGridSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="grouping">(</span><span class="string-literal">'min_resources,'</span>
     <span class="string-literal">'max_resources,'</span>
     <span class="string-literal">'expected_n_iterations,'</span>
     <span class="string-literal">'expected_n_possible_iterations,'</span>
     <span class="string-literal">'expected_n_resources,'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span>
         <span class="comment"># with enough resources</span>
         <span class="grouping">(</span><span class="string-literal">'smallest', 'auto'</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="comment"># with enough resources but min_resources set manually</span>
         <span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">150</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="comment"># without enough resources, only one iteration can be done</span>
         <span class="grouping">(</span><span class="string-literal">'smallest'</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="comment"># with exhaust: use as much resources as possible at the last iter</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust', 'auto'</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">333</span><span class="punctuation">,</span> <span class="int-literal">999</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">333</span><span class="punctuation">,</span> <span class="int-literal">999</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">999</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">333</span><span class="punctuation">,</span> <span class="int-literal">999</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">600</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">600</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">599</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">199</span><span class="punctuation">,</span> <span class="int-literal">597</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">300</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_max_resources</span><span class="grouping">(</span>
        <span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">min_resources</span><span class="punctuation">,</span> <span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">expected_n_iterations</span><span class="punctuation">,</span>
        <span class="identifier">expected_n_possible_iterations</span><span class="punctuation">,</span>
        <span class="identifier">expected_n_resources</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the min_resources and max_resources parameters, and how they affect</span>
    <span class="comment"># the number of resources used at each iteration</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': [1, 2], 'b'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">min_resources</span><span class="arithmetic-assignment">=</span><span class="identifier">min_resources</span><span class="punctuation">,</span>
             <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="identifier">max_resources</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">Est</span> <span class="relational-operator">is</span> <span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">:</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="grouping">)</span>  <span class="comment"># same number as with the grid</span>

    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">expected_n_required_iterations</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>  <span class="comment"># given 6 combinations and factor = 3</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_required_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_required_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_possible_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_possible_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_resources_</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_resources</span>
    <span class="keyword">if</span> <span class="identifier">min_resources</span> <span class="relational-operator">==</span> <span class="string-literal">'exhaust'</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_possible_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_iterations_</span> <span class="relational-operator">==</span>
                <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_resources_</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingGridSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'max_resources, n_iterations, n_possible_iterations'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># all resources are used</span>
        <span class="grouping">(</span><span class="int-literal">1024</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">700</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">512</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">511</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">31</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># max_resources == min_resources, only one iteration is</span>
                    <span class="comment"># possible</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_iterations</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">n_iterations</span><span class="punctuation">,</span> <span class="identifier">n_possible_iterations</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test the number of actual iterations that were run depending on</span>
    <span class="comment"># max_resources</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1024</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': [1, 2], 'b'</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">factor</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="identifier">factor</span><span class="punctuation">,</span>
             <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">min_resources</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">Est</span> <span class="relational-operator">is</span> <span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">:</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>  <span class="comment"># same as for HalvingGridSearchCV</span>
    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_required_iterations_</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">n_iterations</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_possible_iterations_</span> <span class="relational-operator">==</span> <span class="identifier">n_possible_iterations</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingGridSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_resource_parameter</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the resource parameter</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': [1, 2], 'b'</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">resource</span><span class="arithmetic-assignment">=</span><span class="string-literal">'c'</span><span class="punctuation">,</span>
             <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_resources_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">r_i</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">param_c</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'n_resources'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'param_c'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">r_i</span> <span class="relational-operator">==</span> <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'c'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">param_c</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">ValueError</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Cannot use resource=1234 which is not supported '</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HalvingGridSearchCV</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                 <span class="identifier">resource</span><span class="arithmetic-assignment">=</span><span class="string-literal">'1234'</span><span class="punctuation">,</span> <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">ValueError</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Cannot use parameter c as the resource since it is part '</span>
                  <span class="string-literal">'of the searched parameters.'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': [1, 2], 'b': [1, 2], 'c'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span>
        <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HalvingGridSearchCV</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                 <span class="identifier">resource</span><span class="arithmetic-assignment">=</span><span class="string-literal">'c'</span><span class="punctuation">,</span> <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'max_resources, n_candidates, expected_n_candidates'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="int-literal">512</span><span class="punctuation">,</span> <span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># generate exactly as much as needed</span>
        <span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="string-literal">'exhaust'</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># ask for less than what we could</span>
        <span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># ask for more than 'reasonable'</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_random_search</span><span class="grouping">(</span><span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">n_candidates</span><span class="punctuation">,</span> <span class="identifier">expected_n_candidates</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test random search and make sure the number of generated candidates is</span>
    <span class="comment"># as expected</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1024</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': norm, 'b'</span><span class="punctuation">:</span> <span class="identifier">norm</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span>
                               <span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="identifier">n_candidates</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                               <span class="identifier">max_resources</span><span class="arithmetic-assignment">=</span><span class="identifier">max_resources</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                               <span class="identifier">min_resources</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_candidates_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_candidates</span>
    <span class="keyword">if</span> <span class="identifier">n_candidates</span> <span class="relational-operator">==</span> <span class="string-literal">'exhaust'</span><span class="punctuation">:</span>
        <span class="comment"># Make sure 'exhaust' makes the last iteration use as much resources as</span>
        <span class="comment"># we can</span>
        <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_resources_</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">max_resources</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'param_distributions, expected_n_candidates'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># all lists, sample less than n_candidates</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># not all list, respect n_candidates</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_random_search_discrete_distributions</span><span class="grouping">(</span><span class="identifier">param_distributions</span><span class="punctuation">,</span>
                                              <span class="identifier">expected_n_candidates</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure random search samples the appropriate number of candidates when</span>
    <span class="comment"># we ask for more than what's possible. How many parameters are sampled</span>
    <span class="comment"># depends whether the distributions are 'all lists' or not (see</span>
    <span class="comment"># ParameterSampler for details). This is somewhat redundant with the checks</span>
    <span class="comment"># in ParameterSampler but interaction bugs were discovered during</span>
    <span class="comment"># developement of SH</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1024</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_distributions</span><span class="punctuation">,</span>
                               <span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_candidates_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_n_candidates</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingGridSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'params, expected_error_message'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'scoring': {'accuracy', 'accuracy'</span><span class="grouping">}</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'Multimetric scoring is not supported'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'resource': 'not_a_parameter'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'Cannot use resource=not_a_parameter which is not supported'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'resource': 'a', 'max_resources'</span><span class="punctuation">:</span> <span class="int-literal">100</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'Cannot use parameter a as the resource since it is part of'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_resources': 'not_auto'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'max_resources must be either'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_resources'</span><span class="punctuation">:</span> <span class="float-literal">100.5</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'max_resources must be either'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_resources'</span><span class="punctuation">:</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'max_resources must be either'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'min_resources': 'bad str'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'min_resources must be either'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'min_resources'</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'min_resources must be either'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'min_resources'</span><span class="punctuation">:</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">'min_resources must be either'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_resources': 'auto', 'resource': 'b'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">"max_resources can only be 'auto' if resource='n_samples'"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'min_resources': 15, 'max_resources'</span><span class="punctuation">:</span> <span class="int-literal">14</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">"min_resources_=15 is greater than max_resources_=14"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'cv'</span><span class="punctuation">:</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="string-literal">"must yield consistent folds"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'cv'</span><span class="punctuation">:</span> <span class="identifier">ShuffleSplit</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="string-literal">"must yield consistent folds"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_input_errors</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">expected_error_message</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_error_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'params, expected_error_message'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'n_candidates': 'exhaust', 'min_resources': 'exhaust'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="string-literal">"cannot be both set to 'exhaust'"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'n_candidates': 'bad'}, "either 'exhaust'</span> <span class="logical-operator">or</span> <span class="identifier">a</span> <span class="identifier">positive</span> <span class="identifier">integer</span><span class="invalid">"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'n_candidates': 0}, "either 'exhaust'</span> <span class="logical-operator">or</span> <span class="identifier">a</span> <span class="identifier">positive</span> <span class="identifier">integer</span><span class="invalid">"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_input_errors_randomized</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">expected_error_message</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># tests specific to HalvingRandomSearchCV</span>

    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_error_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'fraction, subsample_test, expected_train_size, expected_test_size'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_subsample_splitter_shapes</span><span class="grouping">(</span><span class="identifier">fraction</span><span class="punctuation">,</span> <span class="identifier">subsample_test</span><span class="punctuation">,</span>
                                   <span class="identifier">expected_train_size</span><span class="punctuation">,</span> <span class="identifier">expected_test_size</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure splits returned by SubsampleMetaSplitter are of appropriate</span>
    <span class="comment"># size</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_SubsampleMetaSplitter</span><span class="grouping">(</span><span class="identifier">base_cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">fraction</span><span class="arithmetic-assignment">=</span><span class="identifier">fraction</span><span class="punctuation">,</span>
                                <span class="identifier">subsample_test</span><span class="arithmetic-assignment">=</span><span class="identifier">subsample_test</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span> <span class="relational-operator">in</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_train_size</span>
        <span class="keyword">assert</span> <span class="identifier">test</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_test_size</span>
        <span class="keyword">if</span> <span class="identifier">subsample_test</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">test</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">fraction</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">test</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">base_cv</span><span class="punctuation">.</span><span class="identifier">get_n_splits</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'subsample_test'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_subsample_splitter_determinism</span><span class="grouping">(</span><span class="identifier">subsample_test</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure _SubsampleMetaSplitter is consistent across calls to split():</span>
    <span class="comment"># - we're OK having training sets differ (they're always sampled with a</span>
    <span class="comment">#   different fraction anyway)</span>
    <span class="comment"># - when we don't subsample the test set, we want it to be always the same.</span>
    <span class="comment">#   This check is the most important. This is ensured by the determinism</span>
    <span class="comment">#   of the base_cv.</span>

    <span class="comment"># Note: we could force both train and test splits to be always the same if</span>
    <span class="comment"># we drew an int seed in _SubsampleMetaSplitter.__init__</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_SubsampleMetaSplitter</span><span class="grouping">(</span><span class="identifier">base_cv</span><span class="arithmetic-assignment">=</span><span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">fraction</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="punctuation">,</span>
                                <span class="identifier">subsample_test</span><span class="arithmetic-assignment">=</span><span class="identifier">subsample_test</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="identifier">folds_a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">folds_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">train_a</span><span class="punctuation">,</span> <span class="identifier">test_a</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">train_b</span><span class="punctuation">,</span> <span class="identifier">test_b</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">folds_a</span><span class="punctuation">,</span> <span class="identifier">folds_b</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">train_a</span> <span class="relational-operator">==</span> <span class="identifier">train_b</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">subsample_test</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">test_a</span> <span class="relational-operator">==</span> <span class="identifier">test_b</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">test_a</span> <span class="relational-operator">==</span> <span class="identifier">test_b</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test_a</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test_b</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'k, itr, expected'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'c'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'a', 'c'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'d', 'b', 'a', 'c'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'d', 'b', 'a', 'c'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>

    <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'e'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'f', 'e'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'f', 'e'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>

    <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'i'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'g', 'h', 'i'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_top_k</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">itr</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>  <span class="comment"># this isn't a 'real world' result dict</span>
        <span class="string-literal">'iter'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="string-literal">'mean_test_score'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="string-literal">'params': ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i'</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="identifier">got</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_top_k</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">itr</span><span class="arithmetic-assignment">=</span><span class="identifier">itr</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">got</span> <span class="relational-operator">==</span> <span class="identifier">expected</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_refit_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>  <span class="comment"># this isn't a 'real world' result dict</span>
        <span class="string-literal">'iter'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'mean_test_score'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'params': np.array(['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="keyword">assert</span> <span class="identifier">_refit_callable</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">8</span>  <span class="comment"># index of 'i'</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingGridSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_cv_results</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that the cv_results_ matches correctly the logic of the</span>
    <span class="comment"># tournament: in particular that the candidates continued in each</span>
    <span class="comment"># successive iteration are those that were best in the previous iteration</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': ('l1', 'l2'), 'b'</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># generate random scores: we want to avoid ties, which would otherwise</span>
    <span class="comment"># mess with the ordering and make testing harder</span>
    <span class="keyword">def</span> <span class="identifier">scorer</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scorer</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">Est</span> <span class="relational-operator">is</span> <span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">:</span>
        <span class="comment"># same number of candidates as with the grid</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">min_resources</span><span class="arithmetic-assignment">=</span><span class="string-literal">'exhaust'</span><span class="grouping">)</span>

    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># non-regression check for</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/19203</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'iter'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'n_resources'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>

    <span class="identifier">cv_results_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">)</span>

    <span class="comment"># just make sure we don't have ties</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="grouping">)</span>

    <span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'params_str'] = cv_results_df['params'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span>
    <span class="identifier">table</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_results_df</span><span class="punctuation">.</span><span class="identifier">pivot</span><span class="grouping">(</span><span class="identifier">index</span><span class="arithmetic-assignment">=</span><span class="string-literal">'params_str', columns='iter'</span><span class="punctuation">,</span>
                                <span class="identifier">values</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mean_test_score'</span><span class="grouping">)</span>

    <span class="comment"># table looks like something like this:</span>
    <span class="comment"># iter                    0      1       2        3   4   5</span>
    <span class="comment"># params_str</span>
    <span class="comment"># {'a': 'l2', 'b': 23} 0.75    NaN     NaN      NaN NaN NaN</span>
    <span class="comment"># {'a': 'l1', 'b': 30} 0.90  0.875     NaN      NaN NaN NaN</span>
    <span class="comment"># {'a': 'l1', 'b': 0}  0.75    NaN     NaN      NaN NaN NaN</span>
    <span class="comment"># {'a': 'l2', 'b': 3}  0.85  0.925  0.9125  0.90625 NaN NaN</span>
    <span class="comment"># {'a': 'l1', 'b': 5}  0.80    NaN     NaN      NaN NaN NaN</span>
    <span class="comment"># ...</span>

    <span class="comment"># where a NaN indicates that the candidate wasn't evaluated at a given</span>
    <span class="comment"># iteration, because it wasn't part of the top-K at some previous</span>
    <span class="comment"># iteration. We here make sure that candidates that aren't in the top-k at</span>
    <span class="comment"># any given iteration are indeed not evaluated at the subsequent</span>
    <span class="comment"># iterations.</span>
    <span class="identifier">nan_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">isna</span><span class="grouping">(</span><span class="identifier">table</span><span class="grouping">)</span>
    <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_iterations_</span>
    <span class="keyword">for</span> <span class="identifier">it</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_iter</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">already_discarded_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_mask</span><span class="grouping">[</span><span class="identifier">it</span><span class="grouping">]</span>

        <span class="comment"># make sure that if a candidate is already discarded, we don't evaluate</span>
        <span class="comment"># it later</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">already_discarded_mask</span> <span class="bitwise-operator">&</span> <span class="identifier">nan_mask</span><span class="grouping">[</span><span class="identifier">it</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span>
                <span class="identifier">already_discarded_mask</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># make sure that the number of discarded candidate is correct</span>
        <span class="identifier">discarded_now_mask</span> <span class="arithmetic-assignment">=</span> <span class="bitwise-operator">~</span><span class="identifier">already_discarded_mask</span> <span class="bitwise-operator">&</span> <span class="identifier">nan_mask</span><span class="grouping">[</span><span class="identifier">it</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">kept_mask</span> <span class="arithmetic-assignment">=</span> <span class="bitwise-operator">~</span><span class="identifier">already_discarded_mask</span> <span class="bitwise-operator">&</span> <span class="bitwise-operator">~</span><span class="identifier">discarded_now_mask</span>
        <span class="keyword">assert</span> <span class="identifier">kept_mask</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_candidates_</span><span class="grouping">[</span><span class="identifier">it</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>

        <span class="comment"># make sure that all discarded candidates have a lower score than the</span>
        <span class="comment"># kept candidates</span>
        <span class="identifier">discarded_max_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">table</span><span class="grouping">[</span><span class="identifier">it</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">discarded_now_mask</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">kept_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">table</span><span class="grouping">[</span><span class="identifier">it</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">kept_mask</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">discarded_max_score</span> <span class="relational-operator">&lt;</span> <span class="identifier">kept_min_score</span>

    <span class="comment"># We now make sure that the best candidate is chosen only from the last</span>
    <span class="comment"># iteration.</span>
    <span class="comment"># We also make sure this is true even if there were higher scores in</span>
    <span class="comment"># earlier rounds (this isn't generally the case, but worth ensuring it's</span>
    <span class="comment"># possible).</span>

    <span class="identifier">last_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'iter'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">idx_best_last_iter</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'iter'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">last_iter</span><span class="grouping">]</span>
        <span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">idxmax</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">idx_best_all_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">idxmax</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">best_params_</span> <span class="relational-operator">==</span> <span class="identifier">cv_results_df</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">idx_best_last_iter</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">idx_best_last_iter</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span>
            <span class="identifier">cv_results_df</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">idx_best_all_iters</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'mean_test_score'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">idx_best_last_iter</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span> <span class="relational-operator">!=</span>
            <span class="identifier">cv_results_df</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">idx_best_all_iters</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingGridSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_base_estimator_inputs</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure that the base estimators are passed the correct parameters and</span>
    <span class="comment"># number of samples at each iteration.</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="keyword">class</span> <span class="identifier">FastClassifierBookKeeping</span><span class="grouping">(</span><span class="identifier">FastClassifier</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1024</span>
    <span class="identifier">n_splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'a': ('l1', 'l2'), 'b'</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FastClassifierBookKeeping</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">sh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_splits</span><span class="punctuation">,</span>
             <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">refit</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">Est</span> <span class="relational-operator">is</span> <span class="identifier">HalvingRandomSearchCV</span><span class="punctuation">:</span>
        <span class="comment"># same number of candidates as with the grid</span>
        <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_candidates</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">min_resources</span><span class="arithmetic-assignment">=</span><span class="string-literal">'exhaust'</span><span class="grouping">)</span>

    <span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">t</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">)</span>
    <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">y</span> <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">t</span><span class="punctuation">,</span>
                                                <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="comment"># Lists are of length n_splits * n_iter * n_candidates_at_i.</span>
    <span class="comment"># Each chunk of size n_splits corresponds to the n_splits folds for the</span>
    <span class="comment"># same candidate at the same iteration, so they contain equal values. We</span>
    <span class="comment"># subsample such that the lists are of length n_iter * n_candidates_at_it</span>
    <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">n_splits</span><span class="grouping">]</span>
    <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">n_splits</span><span class="grouping">]</span>

    <span class="identifier">cv_results_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="grouping">)</span>

    <span class="identifier">uniques</span><span class="punctuation">,</span> <span class="identifier">counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_resources_</span> <span class="relational-operator">==</span> <span class="identifier">uniques</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">sh</span><span class="punctuation">.</span><span class="identifier">n_candidates_</span> <span class="relational-operator">==</span> <span class="identifier">counts</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'params'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">cv_results_df</span><span class="grouping">[</span><span class="string-literal">'n_resources'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HalvingGridSearchCV</span><span class="punctuation">,</span> <span class="identifier">HalvingRandomSearchCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_groups_support</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check if ValueError (when groups is None) propagates to</span>
    <span class="comment"># HalvingGridSearchCV and HalvingRandomSearchCV</span>
    <span class="comment"># And also check if groups is correctly passed to the cv object</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'C'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="identifier">group_cvs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">LeaveOneGroupOut</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LeavePGroupsOut</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">GroupKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">GroupShuffleSplit</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"The 'groups' parameter should not be None."</span>
    <span class="keyword">for</span> <span class="identifier">cv</span> <span class="relational-operator">in</span> <span class="identifier">group_cvs</span><span class="punctuation">:</span>
        <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="identifier">groups</span><span class="grouping">)</span>

    <span class="identifier">non_group_cvs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">StratifiedKFold</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">StratifiedShuffleSplit</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">cv</span> <span class="relational-operator">in</span> <span class="identifier">non_group_cvs</span><span class="punctuation">:</span>
        <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">grid</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="comment"># Should not raise an error</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    </pre>
  </body>
</html>