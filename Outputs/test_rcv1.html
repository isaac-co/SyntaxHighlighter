<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Test the rcv1 loader, if the data is available,
or if specifically requested via environment variable
(e.g. for travis cron job)."""</span>

<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_common</span> <span class="keyword">import</span> <span class="identifier">check_return_X_y</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>


<span class="keyword">def</span> <span class="identifier">test_fetch_rcv1</span><span class="grouping">(</span><span class="identifier">fetch_rcv1_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_rcv1_fxt</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">Y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data1</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">data1</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">cat_list</span><span class="punctuation">,</span> <span class="identifier">s1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data1</span><span class="punctuation">.</span><span class="identifier">target_names</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">data1</span><span class="punctuation">.</span><span class="identifier">sample_id</span>

    <span class="comment"># test sparsity</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">Y1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="int-literal">60915113</span> <span class="relational-operator">==</span> <span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">size</span>
    <span class="keyword">assert</span> <span class="int-literal">2606875</span> <span class="relational-operator">==</span> <span class="identifier">Y1</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">size</span>

    <span class="comment"># test shapes</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="int-literal">804414</span><span class="punctuation">,</span> <span class="int-literal">47236</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="int-literal">804414</span><span class="punctuation">,</span> <span class="int-literal">103</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">Y1</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="int-literal">804414</span><span class="punctuation">,</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">s1</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="int-literal">103</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cat_list</span><span class="grouping">)</span>

    <span class="comment"># test ordering of categories</span>
    <span class="identifier">first_categories</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'C11', 'C12', 'C13', 'C14', 'C15', 'C151'</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">first_categories</span><span class="punctuation">,</span> <span class="identifier">cat_list</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test number of sample for some categories</span>
    <span class="identifier">some_categories</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'GMIL', 'E143', 'CCAT'</span><span class="grouping">)</span>
    <span class="identifier">number_non_zero_in_cat</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1206</span><span class="punctuation">,</span> <span class="int-literal">381327</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">num</span><span class="punctuation">,</span> <span class="identifier">cat</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">number_non_zero_in_cat</span><span class="punctuation">,</span> <span class="identifier">some_categories</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">j</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cat_list</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">cat</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">num</span> <span class="relational-operator">==</span> <span class="identifier">Y1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">size</span>

    <span class="comment"># test shuffling and subset</span>
    <span class="identifier">data2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_rcv1_fxt</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'train'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">77</span><span class="grouping">)</span>
    <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data2</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">data2</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">s2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data2</span><span class="punctuation">.</span><span class="identifier">sample_id</span>

    <span class="comment"># test return_X_y option</span>
    <span class="identifier">fetch_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">fetch_rcv1_fxt</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'train'</span><span class="grouping">)</span>
    <span class="identifier">check_return_X_y</span><span class="grouping">(</span><span class="identifier">data2</span><span class="punctuation">,</span> <span class="identifier">fetch_func</span><span class="grouping">)</span>

    <span class="comment"># The first 23149 samples are the training samples</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">s1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">23149</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">s2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># test some precise values</span>
    <span class="identifier">some_sample_ids</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">2286</span><span class="punctuation">,</span> <span class="int-literal">3274</span><span class="punctuation">,</span> <span class="int-literal">14042</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">sample_id</span> <span class="relational-operator">in</span> <span class="identifier">some_sample_ids</span><span class="punctuation">:</span>
        <span class="identifier">idx1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s1</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">sample_id</span><span class="grouping">)</span>
        <span class="identifier">idx2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s2</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">sample_id</span><span class="grouping">)</span>

        <span class="identifier">feature_values_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X1</span><span class="grouping">[</span><span class="identifier">idx1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">feature_values_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X2</span><span class="grouping">[</span><span class="identifier">idx2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">feature_values_1</span><span class="punctuation">,</span> <span class="identifier">feature_values_2</span><span class="grouping">)</span>

        <span class="identifier">target_values_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y1</span><span class="grouping">[</span><span class="identifier">idx1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">target_values_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y2</span><span class="grouping">[</span><span class="identifier">idx2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">target_values_1</span><span class="punctuation">,</span> <span class="identifier">target_values_2</span><span class="grouping">)</span>

    </pre>
  </body>
</html>