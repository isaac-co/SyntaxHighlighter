<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">""" Test the graphical_lasso module.
"""</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>

<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">covariance</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">graphical_lasso</span><span class="punctuation">,</span> <span class="identifier">GraphicalLasso</span><span class="punctuation">,</span>
                                <span class="identifier">GraphicalLassoCV</span><span class="punctuation">,</span> <span class="identifier">empirical_covariance</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_sparse_spd_matrix</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">datasets</span>


<span class="keyword">def</span> <span class="identifier">test_graphical_lasso</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sample data from a sparse multivariate normal</span>
    <span class="identifier">dim</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">prec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_sparse_spd_matrix</span><span class="grouping">(</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.95</span><span class="punctuation">,</span>
                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">prec</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">dim</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">alpha</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.25</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">covs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">icovs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'cd', 'lars'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">cov_</span><span class="punctuation">,</span> <span class="identifier">icov_</span><span class="punctuation">,</span> <span class="identifier">costs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                                 <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>
            <span class="identifier">covs</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cov_</span>
            <span class="identifier">icovs</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">icov_</span>
            <span class="identifier">costs</span><span class="punctuation">,</span> <span class="identifier">dual_gap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">costs</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
            <span class="comment"># Check that the costs always decrease (doesn't hold if alpha == 0)</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">alpha</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">costs</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># Check that the 2 approaches give similar results</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">covs</span><span class="grouping">[</span><span class="string-literal">'cd'], covs['lars'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">icovs</span><span class="grouping">[</span><span class="string-literal">'cd'], icovs['lars'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>

    <span class="comment"># Smoke test the estimator</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GraphicalLasso</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.25</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">covs</span><span class="grouping">[</span><span class="string-literal">'cd'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">covs</span><span class="grouping">[</span><span class="string-literal">'lars'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>

    <span class="comment"># For a centered matrix, assume_centered could be chosen True or False</span>
    <span class="comment"># Check that this returns indeed the same result for centered data</span>
    <span class="identifier">Z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">precs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">prec_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GraphicalLasso</span><span class="grouping">(</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">Z</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">precision_</span>
        <span class="identifier">precs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">prec_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">precs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">precs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_graphical_lasso_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Hard-coded solution from R glasso package for alpha=1.0</span>
    <span class="comment"># (need to set penalize.diagonal to FALSE)</span>
    <span class="identifier">cov_R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="float-literal">0.68112222</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">0.265820</span><span class="punctuation">,</span> <span class="float-literal">0.02464314</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.00000000</span><span class="punctuation">,</span> <span class="float-literal">0.1887129</span><span class="punctuation">,</span> <span class="float-literal">0.000000</span><span class="punctuation">,</span> <span class="float-literal">0.00000000</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.26582000</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">3.095503</span><span class="punctuation">,</span> <span class="float-literal">0.28697200</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.02464314</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">0.286972</span><span class="punctuation">,</span> <span class="float-literal">0.57713289</span><span class="grouping">]</span>
        <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">icov_R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="float-literal">1.5190747</span><span class="punctuation">,</span> <span class="float-literal">0.000000</span><span class="punctuation">,</span> <span class="float-literal">-0.1304475</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">5.299055</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">-0.1304475</span><span class="punctuation">,</span> <span class="float-literal">0.000000</span><span class="punctuation">,</span> <span class="float-literal">0.3498624</span><span class="punctuation">,</span> <span class="float-literal">-0.1683946</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">0.000000</span><span class="punctuation">,</span> <span class="float-literal">-0.1683946</span><span class="punctuation">,</span> <span class="float-literal">1.8164353</span><span class="grouping">]</span>
        <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'cd', 'lars'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">icov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                    <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">cov_R</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">icov</span><span class="punctuation">,</span> <span class="identifier">icov_R</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_graph_lasso_2D</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Hard-coded solution from Python skggm package</span>
    <span class="comment"># obtained by calling `quic(emp_cov, lam=.1, tol=1e-8)`</span>
    <span class="identifier">cov_skggm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">3.09550269</span><span class="punctuation">,</span> <span class="float-literal">1.186972</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">1.186972</span><span class="punctuation">,</span> <span class="float-literal">0.57713289</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">icov_skggm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.52836773</span><span class="punctuation">,</span> <span class="float-literal">-3.14334831</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="float-literal">-3.14334831</span><span class="punctuation">,</span>  <span class="float-literal">8.19753385</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'cd', 'lars'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">icov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                    <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">cov_skggm</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">icov</span><span class="punctuation">,</span> <span class="identifier">icov_skggm</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_graphical_lasso_iris_singular</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Small subset of rows to test the rank-deficient case</span>
    <span class="comment"># Need to choose samples such that none of the variances are zero</span>
    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">13</span><span class="grouping">)</span>

    <span class="comment"># Hard-coded solution from R glasso package for alpha=0.01</span>
    <span class="identifier">cov_R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="float-literal">0.08</span><span class="punctuation">,</span> <span class="float-literal">0.056666662595</span><span class="punctuation">,</span> <span class="float-literal">0.00229729713223</span><span class="punctuation">,</span> <span class="float-literal">0.00153153142149</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.056666662595</span><span class="punctuation">,</span> <span class="float-literal">0.082222222222</span><span class="punctuation">,</span> <span class="float-literal">0.00333333333333</span><span class="punctuation">,</span> <span class="float-literal">0.00222222222222</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.002297297132</span><span class="punctuation">,</span> <span class="float-literal">0.003333333333</span><span class="punctuation">,</span> <span class="float-literal">0.00666666666667</span><span class="punctuation">,</span> <span class="float-literal">0.00009009009009</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.001531531421</span><span class="punctuation">,</span> <span class="float-literal">0.002222222222</span><span class="punctuation">,</span> <span class="float-literal">0.00009009009009</span><span class="punctuation">,</span> <span class="float-literal">0.00222222222222</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">icov_R</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="float-literal">24.42244057</span><span class="punctuation">,</span> <span class="float-literal">-16.831679593</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">-16.83168201</span><span class="punctuation">,</span> <span class="float-literal">24.351841681</span><span class="punctuation">,</span> <span class="float-literal">-6.206896552</span><span class="punctuation">,</span> <span class="float-literal">-12.5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-6.206896171</span><span class="punctuation">,</span> <span class="float-literal">153.103448276</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-12.499999143</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">462.5</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'cd', 'lars'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">icov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                    <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">cov_R</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">icov</span><span class="punctuation">,</span> <span class="identifier">icov_R</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_graphical_lasso_cv</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sample data from a sparse multivariate normal</span>
    <span class="identifier">dim</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">prec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_sparse_spd_matrix</span><span class="grouping">(</span><span class="identifier">dim</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.96</span><span class="punctuation">,</span>
                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">prec</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">dim</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="comment"># Capture stdout, to smoke test the verbose mode</span>
    <span class="identifier">orig_stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StringIO</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="comment"># We need verbose very high so that Parallel prints on stdout</span>
        <span class="identifier">GraphicalLassoCV</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">finally</span><span class="punctuation">:</span>
        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orig_stdout</span>

    <span class="comment"># Smoke test with specified alphas</span>
    <span class="identifier">GraphicalLassoCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove in 1.1 when grid_scores_ is deprecated</span>
<span class="keyword">def</span> <span class="identifier">test_graphical_lasso_cv_grid_scores_and_cv_alphas_deprecated</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">n_alphas</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_refinements</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">true_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">mean</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="arithmetic-assignment">=</span><span class="identifier">true_cov</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="grouping">)</span>
    <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GraphicalLassoCV</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">splits</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">n_alphas</span><span class="punctuation">,</span>
                           <span class="identifier">n_refinements</span><span class="arithmetic-assignment">=</span><span class="identifier">n_refinements</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">total_alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_refinements</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_alphas</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"The grid_scores_ attribute is deprecated in version 0\.24 in "</span>
           <span class="identifier">r</span><span class="string-literal">"favor of cv_results_ and will be removed in version 1\.1 "</span>
           <span class="identifier">r</span><span class="string-literal">"\(renaming of 0\.26\)."</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">cov</span><span class="punctuation">.</span><span class="identifier">grid_scores_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">total_alphas</span><span class="punctuation">,</span> <span class="identifier">splits</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"The cv_alphas_ attribute is deprecated in version 0\.24 in "</span>
           <span class="identifier">r</span><span class="string-literal">"favor of cv_results_\['alpha'\] and will be removed in version "</span>
           <span class="identifier">r</span><span class="string-literal">"1\.1 \(renaming of 0\.26\)"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">.</span><span class="identifier">cv_alphas_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">total_alphas</span>


<span class="keyword">def</span> <span class="identifier">test_graphical_lasso_cv_scores</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">splits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">n_alphas</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_refinements</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">true_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">multivariate_normal</span><span class="grouping">(</span><span class="identifier">mean</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="arithmetic-assignment">=</span><span class="identifier">true_cov</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="grouping">)</span>
    <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GraphicalLassoCV</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">splits</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">n_alphas</span><span class="punctuation">,</span>
                           <span class="identifier">n_refinements</span><span class="arithmetic-assignment">=</span><span class="identifier">n_refinements</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">cv_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cov</span><span class="punctuation">.</span><span class="identifier">cv_results_</span>
    <span class="comment"># alpha and one for each split</span>

    <span class="identifier">total_alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_refinements</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_alphas</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'alphas'</span><span class="grouping">]</span>
    <span class="identifier">split_keys</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'split{}_score'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">splits</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">keys</span> <span class="arithmetic-operator">+</span> <span class="identifier">split_keys</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">cv_results</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">cv_results</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">total_alphas</span>

    <span class="identifier">cv_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cov</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">split_keys</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">expected_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_scores</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">expected_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv_scores</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">"mean_score"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">expected_mean</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">"std_score"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">expected_std</span><span class="grouping">)</span>

    </pre>
  </body>
</html>