<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
     - - - - - -- - - - - - - - - - - - - - - - - - - - - - -
    Name - - CNN - Convolution Neural Network For Photo Recognizing
    Goal - - Recognize Handing Writing Word Photo
    Detail：Total 5 layers neural network
            * Convolution layer
            * Pooling layer
            * Input layer layer of BP
            * Hidden layer of BP
            * Output layer of BP
    Author: Stephen Lee
    Github: 245885195@qq.com
    Date: 2017.9.20
    - - - - - -- - - - - - - - - - - - - - - - - - - - - - -
"""</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">matplotlib</span> <span class="keyword">import</span> <span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>


<span class="keyword">class</span> <span class="identifier">CNN</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span>
        <span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">conv1_get</span><span class="punctuation">,</span> <span class="identifier">size_p1</span><span class="punctuation">,</span> <span class="identifier">bp_num1</span><span class="punctuation">,</span> <span class="identifier">bp_num2</span><span class="punctuation">,</span> <span class="identifier">bp_num3</span><span class="punctuation">,</span> <span class="identifier">rate_w</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="identifier">rate_t</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        :param conv1_get: [a,c,d]，size, number, step of convolution kernel
        :param size_p1: pooling size
        :param bp_num1: units number of flatten layer
        :param bp_num2: units number of hidden layer
        :param bp_num3: units number of output layer
        :param rate_w: rate of weight learning
        :param rate_t: rate of threshold learning
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bp_num1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bp_num2</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bp_num3</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conv1_get</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">step_conv1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conv1_get</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size_p1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rate_w</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_thre</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rate_t</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mat</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mat</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp3</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mat</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp2</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp3</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="keyword">def</span> <span class="identifier">save_model</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">save_path</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># save model dict with pickle</span>
        <span class="identifier">model_dic</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">"num_bp1"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp1</span><span class="punctuation">,</span>
            <span class="string-literal">"num_bp2"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp2</span><span class="punctuation">,</span>
            <span class="string-literal">"num_bp3"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">num_bp3</span><span class="punctuation">,</span>
            <span class="string-literal">"conv1"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="punctuation">,</span>
            <span class="string-literal">"step_conv1"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">step_conv1</span><span class="punctuation">,</span>
            <span class="string-literal">"size_pooling1"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span><span class="punctuation">,</span>
            <span class="string-literal">"rate_weight"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_weight</span><span class="punctuation">,</span>
            <span class="string-literal">"rate_thre"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_thre</span><span class="punctuation">,</span>
            <span class="string-literal">"w_conv1"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span><span class="punctuation">,</span>
            <span class="string-literal">"wkj"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span><span class="punctuation">,</span>
            <span class="string-literal">"vji"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span><span class="punctuation">,</span>
            <span class="string-literal">"thre_conv1"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span><span class="punctuation">,</span>
            <span class="string-literal">"thre_bp2"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span><span class="punctuation">,</span>
            <span class="string-literal">"thre_bp3"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span><span class="punctuation">,</span>
        <span class="grouping">}</span>
        <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">save_path</span><span class="punctuation">,</span> <span class="string-literal">"wb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
            <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dump</span><span class="grouping">(</span><span class="identifier">model_dic</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>

        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Model saved： %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">save_path</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">ReadModel</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># read saved model</span>
        <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">model_path</span><span class="punctuation">,</span> <span class="string-literal">"rb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
            <span class="identifier">model_dic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span>

        <span class="identifier">conv_get</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"conv1"</span><span class="grouping">)</span>
        <span class="identifier">conv_get</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"step_conv1"</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">size_p1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"size_pooling1"</span><span class="grouping">)</span>
        <span class="identifier">bp1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"num_bp1"</span><span class="grouping">)</span>
        <span class="identifier">bp2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"num_bp2"</span><span class="grouping">)</span>
        <span class="identifier">bp3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"num_bp3"</span><span class="grouping">)</span>
        <span class="identifier">r_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"rate_weight"</span><span class="grouping">)</span>
        <span class="identifier">r_t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"rate_thre"</span><span class="grouping">)</span>
        <span class="comment"># create model instance</span>
        <span class="identifier">conv_ins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CNN</span><span class="grouping">(</span><span class="identifier">conv_get</span><span class="punctuation">,</span> <span class="identifier">size_p1</span><span class="punctuation">,</span> <span class="identifier">bp1</span><span class="punctuation">,</span> <span class="identifier">bp2</span><span class="punctuation">,</span> <span class="identifier">bp3</span><span class="punctuation">,</span> <span class="identifier">r_w</span><span class="punctuation">,</span> <span class="identifier">r_t</span><span class="grouping">)</span>
        <span class="comment"># modify model parameter</span>
        <span class="identifier">conv_ins</span><span class="punctuation">.</span><span class="identifier">w_conv1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"w_conv1"</span><span class="grouping">)</span>
        <span class="identifier">conv_ins</span><span class="punctuation">.</span><span class="identifier">wkj</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"wkj"</span><span class="grouping">)</span>
        <span class="identifier">conv_ins</span><span class="punctuation">.</span><span class="identifier">vji</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"vji"</span><span class="grouping">)</span>
        <span class="identifier">conv_ins</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"thre_conv1"</span><span class="grouping">)</span>
        <span class="identifier">conv_ins</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"thre_bp2"</span><span class="grouping">)</span>
        <span class="identifier">conv_ins</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_dic</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"thre_bp3"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">conv_ins</span>

    <span class="keyword">def</span> <span class="identifier">sig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">do_round</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">round</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">convolute</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">convs</span><span class="punctuation">,</span> <span class="identifier">w_convs</span><span class="punctuation">,</span> <span class="identifier">thre_convs</span><span class="punctuation">,</span> <span class="identifier">conv_step</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># convolution process</span>
        <span class="identifier">size_conv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">convs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">num_conv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">convs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">size_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="comment"># get the data slice of original image data, data_focus</span>
        <span class="identifier">data_focus</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">i_focus</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size_data</span> <span class="arithmetic-operator">-</span> <span class="identifier">size_conv</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">conv_step</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">j_focus</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size_data</span> <span class="arithmetic-operator">-</span> <span class="identifier">size_conv</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">conv_step</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">focus</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="grouping">[</span>
                    <span class="identifier">i_focus</span> <span class="punctuation">:</span> <span class="identifier">i_focus</span> <span class="arithmetic-operator">+</span> <span class="identifier">size_conv</span><span class="punctuation">,</span> <span class="identifier">j_focus</span> <span class="punctuation">:</span> <span class="identifier">j_focus</span> <span class="arithmetic-operator">+</span> <span class="identifier">size_conv</span>
                <span class="grouping">]</span>
                <span class="identifier">data_focus</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">focus</span><span class="grouping">)</span>
        <span class="comment"># calculate the feature map of every single kernel, and saved as list of matrix</span>
        <span class="identifier">data_featuremap</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">Size_FeatureMap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size_data</span> <span class="arithmetic-operator">-</span> <span class="identifier">size_conv</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">conv_step</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i_map</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_conv</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">featuremap</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">i_focus</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data_focus</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">net_focus</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">data_focus</span><span class="grouping">[</span><span class="identifier">i_focus</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">w_convs</span><span class="grouping">[</span><span class="identifier">i_map</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="arithmetic-operator">-</span> <span class="identifier">thre_convs</span><span class="grouping">[</span><span class="identifier">i_map</span><span class="grouping">]</span>
                <span class="grouping">)</span>
                <span class="identifier">featuremap</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sig</span><span class="grouping">(</span><span class="identifier">net_focus</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">featuremap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">featuremap</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span>
                <span class="identifier">Size_FeatureMap</span><span class="punctuation">,</span> <span class="identifier">Size_FeatureMap</span>
            <span class="grouping">)</span>
            <span class="identifier">data_featuremap</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">featuremap</span><span class="grouping">)</span>

        <span class="comment"># expanding the data slice to One dimenssion</span>
        <span class="identifier">focus1_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">each_focus</span> <span class="relational-operator">in</span> <span class="identifier">data_focus</span><span class="punctuation">:</span>
            <span class="identifier">focus1_list</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">Expand_Mat</span><span class="grouping">(</span><span class="identifier">each_focus</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">focus_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">focus1_list</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">focus_list</span><span class="punctuation">,</span> <span class="identifier">data_featuremap</span>

    <span class="keyword">def</span> <span class="identifier">pooling</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">featuremaps</span><span class="punctuation">,</span> <span class="identifier">size_pooling</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="string-literal">"average_pool"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># pooling process</span>
        <span class="identifier">size_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">featuremaps</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">size_pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">size_map</span> <span class="arithmetic-operator">/</span> <span class="identifier">size_pooling</span><span class="grouping">)</span>
        <span class="identifier">featuremap_pooled</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">i_map</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">featuremaps</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">featuremaps</span><span class="grouping">[</span><span class="identifier">i_map</span><span class="grouping">]</span>
            <span class="identifier">map_pooled</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">i_focus</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size_map</span><span class="punctuation">,</span> <span class="identifier">size_pooling</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">for</span> <span class="identifier">j_focus</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size_map</span><span class="punctuation">,</span> <span class="identifier">size_pooling</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">focus</span> <span class="arithmetic-assignment">=</span> <span class="identifier">map</span><span class="grouping">[</span>
                        <span class="identifier">i_focus</span> <span class="punctuation">:</span> <span class="identifier">i_focus</span> <span class="arithmetic-operator">+</span> <span class="identifier">size_pooling</span><span class="punctuation">,</span>
                        <span class="identifier">j_focus</span> <span class="punctuation">:</span> <span class="identifier">j_focus</span> <span class="arithmetic-operator">+</span> <span class="identifier">size_pooling</span><span class="punctuation">,</span>
                    <span class="grouping">]</span>
                    <span class="keyword">if</span> <span class="identifier">type</span> <span class="relational-operator">==</span> <span class="string-literal">"average_pool"</span><span class="punctuation">:</span>
                        <span class="comment"># average pooling</span>
                        <span class="identifier">map_pooled</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span><span class="identifier">focus</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="keyword">elif</span> <span class="identifier">type</span> <span class="relational-operator">==</span> <span class="string-literal">"max_pooling"</span><span class="punctuation">:</span>
                        <span class="comment"># max pooling</span>
                        <span class="identifier">map_pooled</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">focus</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">map_pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">map_pooled</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">size_pooled</span><span class="punctuation">,</span> <span class="identifier">size_pooled</span><span class="grouping">)</span>
            <span class="identifier">featuremap_pooled</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">map_pooled</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">featuremap_pooled</span>

    <span class="keyword">def</span> <span class="identifier">_expand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># expanding three dimension data to one dimension list</span>
        <span class="identifier">data_expanded</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">shapes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">data_listed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shapes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">shapes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">data_listed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_listed</span><span class="punctuation">.</span><span class="identifier">getA</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">data_expanded</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">data_listed</span><span class="grouping">)</span>
        <span class="identifier">data_expanded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">data_expanded</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">data_expanded</span>

    <span class="keyword">def</span> <span class="identifier">_expand_mat</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data_mat</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># expanding matrix to one dimension list</span>
        <span class="identifier">data_mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">data_mat</span><span class="grouping">)</span>
        <span class="identifier">shapes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">data_mat</span><span class="grouping">)</span>
        <span class="identifier">data_expanded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_mat</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shapes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">shapes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">data_expanded</span>

    <span class="keyword">def</span> <span class="identifier">_calculate_gradient_from_pool</span><span class="grouping">(</span>
        <span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">out_map</span><span class="punctuation">,</span> <span class="identifier">pd_pool</span><span class="punctuation">,</span> <span class="identifier">num_map</span><span class="punctuation">,</span> <span class="identifier">size_map</span><span class="punctuation">,</span> <span class="identifier">size_pooling</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        calculate the gradient from the data slice of pool layer
        pd_pool: list of matrix
        out_map: the shape of data slice(size_map*size_map)
        return: pd_all: list of matrix, [num, size_map, size_map]
        """</span>
        <span class="identifier">pd_all</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">i_pool</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">i_map</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_map</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">pd_conv1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size_map</span><span class="punctuation">,</span> <span class="identifier">size_map</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size_map</span><span class="punctuation">,</span> <span class="identifier">size_pooling</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size_map</span><span class="punctuation">,</span> <span class="identifier">size_pooling</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">pd_conv1</span><span class="grouping">[</span><span class="identifier">i</span> <span class="punctuation">:</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="identifier">size_pooling</span><span class="punctuation">,</span> <span class="identifier">j</span> <span class="punctuation">:</span> <span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="identifier">size_pooling</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd_pool</span><span class="grouping">[</span>
                        <span class="identifier">i_pool</span>
                    <span class="grouping">]</span>
                    <span class="identifier">i_pool</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i_pool</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
            <span class="identifier">pd_conv2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span>
                <span class="identifier">pd_conv1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">out_map</span><span class="grouping">[</span><span class="identifier">i_map</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">out_map</span><span class="grouping">[</span><span class="identifier">i_map</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="grouping">)</span>
            <span class="identifier">pd_all</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">pd_conv2</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">pd_all</span>

    <span class="keyword">def</span> <span class="identifier">train</span><span class="grouping">(</span>
        <span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">patterns</span><span class="punctuation">,</span> <span class="identifier">datas_train</span><span class="punctuation">,</span> <span class="identifier">datas_teach</span><span class="punctuation">,</span> <span class="identifier">n_repeat</span><span class="punctuation">,</span> <span class="identifier">error_accuracy</span><span class="punctuation">,</span> <span class="identifier">draw_e</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># model traning</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"----------------------Start Training-------------------------"</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">" - - Shape: Train_Data  "</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">datas_train</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">" - - Shape: Teach_Data  "</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">datas_teach</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">rp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">all_mse</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">mse</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10000</span>
        <span class="keyword">while</span> <span class="identifier">rp</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_repeat</span> <span class="logical-operator">and</span> <span class="identifier">mse</span> <span class="relational-operator">&gt;=</span> <span class="identifier">error_accuracy</span><span class="punctuation">:</span>
            <span class="identifier">error_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"-------------Learning Time %d--------------"</span> <span class="arithmetic-operator">%</span> <span class="identifier">rp</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">datas_train</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># print('------------Learning Image: %d--------------'%p)</span>
                <span class="identifier">data_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">datas_train</span><span class="grouping">[</span><span class="identifier">p</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">data_teach</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">datas_teach</span><span class="grouping">[</span><span class="identifier">p</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">data_focus1</span><span class="punctuation">,</span> <span class="identifier">data_conved1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">convolute</span><span class="grouping">(</span>
                    <span class="identifier">data_train</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span><span class="punctuation">,</span>
                    <span class="identifier">conv_step</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">step_conv1</span><span class="punctuation">,</span>
                <span class="grouping">)</span>
                <span class="identifier">data_pooled1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pooling</span><span class="grouping">(</span><span class="identifier">data_conved1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span><span class="grouping">)</span>
                <span class="identifier">shape_featuremap1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">data_conved1</span><span class="grouping">)</span>
                <span class="comment">"""
                print('  -----original shape   ', np.shape(data_train))
                print('  ---- after convolution  ',np.shape(data_conv1))
                print('  -----after pooling  ',np.shape(data_pooled1))
               """</span>
                <span class="identifier">data_bp_input</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_expand</span><span class="grouping">(</span><span class="identifier">data_pooled1</span><span class="grouping">)</span>
                <span class="identifier">bp_out1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_bp_input</span>

                <span class="identifier">bp_net_j</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">bp_out1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span>
                <span class="identifier">bp_out2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sig</span><span class="grouping">(</span><span class="identifier">bp_net_j</span><span class="grouping">)</span>
                <span class="identifier">bp_net_k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">bp_out2</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span>
                <span class="identifier">bp_out3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sig</span><span class="grouping">(</span><span class="identifier">bp_net_k</span><span class="grouping">)</span>

                <span class="comment"># --------------Model Leaning ------------------------</span>
                <span class="comment"># calculate error and gradient---------------</span>
                <span class="identifier">pd_k_all</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span>
                    <span class="grouping">(</span><span class="identifier">data_teach</span> <span class="arithmetic-operator">-</span> <span class="identifier">bp_out3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">bp_out3</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">bp_out3</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="grouping">)</span>
                <span class="identifier">pd_j_all</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">pd_k_all</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">bp_out2</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">bp_out2</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="grouping">)</span>
                <span class="identifier">pd_i_all</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">pd_j_all</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span><span class="grouping">)</span>

                <span class="identifier">pd_conv1_pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd_i_all</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span><span class="grouping">)</span>
                <span class="identifier">pd_conv1_pooled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd_conv1_pooled</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">getA</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">pd_conv1_all</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_calculate_gradient_from_pool</span><span class="grouping">(</span>
                    <span class="identifier">data_conved1</span><span class="punctuation">,</span>
                    <span class="identifier">pd_conv1_pooled</span><span class="punctuation">,</span>
                    <span class="identifier">shape_featuremap1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">shape_featuremap1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span><span class="punctuation">,</span>
                <span class="grouping">)</span>
                <span class="comment"># weight and threshold learning process---------</span>
                <span class="comment"># convolution layer</span>
                <span class="keyword">for</span> <span class="identifier">k_conv</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">pd_conv_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_expand_mat</span><span class="grouping">(</span><span class="identifier">pd_conv1_all</span><span class="grouping">[</span><span class="identifier">k_conv</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">_</span><span class="invalid">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">pd_conv_list</span><span class="punctuation">,</span> <span class="identifier">data_focus1</span><span class="grouping">)</span>

                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span><span class="grouping">[</span><span class="identifier">k_conv</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span><span class="grouping">[</span><span class="identifier">k_conv</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">_</span><span class="invalid">w</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span>
                        <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="grouping">)</span>

                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span><span class="grouping">[</span><span class="identifier">k_conv</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span><span class="grouping">[</span><span class="identifier">k_conv</span><span class="grouping">]</span>
                        <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">pd_conv1_all</span><span class="grouping">[</span><span class="identifier">k_conv</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_thre</span>
                    <span class="grouping">)</span>
                <span class="comment"># all connected layer</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span> <span class="arithmetic-operator">+</span> <span class="identifier">pd_k_all</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">*</span> <span class="identifier">bp_out2</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_weight</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span> <span class="arithmetic-operator">+</span> <span class="identifier">pd_j_all</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">*</span> <span class="identifier">bp_out1</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_weight</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span> <span class="arithmetic-operator">-</span> <span class="identifier">pd_k_all</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_thre</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span> <span class="arithmetic-operator">-</span> <span class="identifier">pd_j_all</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rate_thre</span>
                <span class="comment"># calculate the sum error of all single image</span>
                <span class="identifier">errors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">data_teach</span> <span class="arithmetic-operator">-</span> <span class="identifier">bp_out3</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">error_count</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">errors</span>
                <span class="comment"># print('   ----Teach      ',data_teach)</span>
                <span class="comment"># print('   ----BP_output  ',bp_out3)</span>
            <span class="identifier">rp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rp</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
            <span class="identifier">mse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">error_count</span> <span class="arithmetic-operator">/</span> <span class="identifier">patterns</span>
            <span class="identifier">all_mse</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">mse</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">draw_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">yplot</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">error_accuracy</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_repeat</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">all_mse</span><span class="punctuation">,</span> <span class="string-literal">"+-"</span><span class="grouping">)</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">yplot</span><span class="punctuation">,</span> <span class="string-literal">"r--"</span><span class="grouping">)</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Learning Times"</span><span class="grouping">)</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"All_mse"</span><span class="grouping">)</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">grid</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"------------------Training Complished---------------------"</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">" - - Training epoch: ", rp, "     - - Mse: %.6f"</span> <span class="arithmetic-operator">%</span> <span class="identifier">mse</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">draw_e</span><span class="punctuation">:</span>
            <span class="identifier">draw_error</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">mse</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">datas_test</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># model predict</span>
        <span class="identifier">produce_out</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"-------------------Start Testing-------------------------"</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">" - - Shape: Test_Data  "</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">datas_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">datas_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">data_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">datas_test</span><span class="grouping">[</span><span class="identifier">p</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">data_focus1</span><span class="punctuation">,</span> <span class="identifier">data_conved1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">convolute</span><span class="grouping">(</span>
                <span class="identifier">data_test</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span><span class="punctuation">,</span>
                <span class="identifier">conv_step</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">step_conv1</span><span class="punctuation">,</span>
            <span class="grouping">)</span>
            <span class="identifier">data_pooled1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pooling</span><span class="grouping">(</span><span class="identifier">data_conved1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span><span class="grouping">)</span>
            <span class="identifier">data_bp_input</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_expand</span><span class="grouping">(</span><span class="identifier">data_pooled1</span><span class="grouping">)</span>

            <span class="identifier">bp_out1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data_bp_input</span>
            <span class="identifier">bp_net_j</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bp_out1</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vji</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp2</span>
            <span class="identifier">bp_out2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sig</span><span class="grouping">(</span><span class="identifier">bp_net_j</span><span class="grouping">)</span>
            <span class="identifier">bp_net_k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bp_out2</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wkj</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_bp3</span>
            <span class="identifier">bp_out3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sig</span><span class="grouping">(</span><span class="identifier">bp_net_k</span><span class="grouping">)</span>
            <span class="identifier">produce_out</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">bp_out3</span><span class="punctuation">.</span><span class="identifier">getA</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">do_round</span><span class="punctuation">,</span> <span class="identifier">each</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">each</span> <span class="relational-operator">in</span> <span class="identifier">produce_out</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">res</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">convolution</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># return the data of image after convoluting process so we can check it out</span>
        <span class="identifier">data_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
        <span class="identifier">data_focus1</span><span class="punctuation">,</span> <span class="identifier">data_conved1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">convolute</span><span class="grouping">(</span>
            <span class="identifier">data_test</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv1</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w_conv1</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thre_conv1</span><span class="punctuation">,</span>
            <span class="identifier">conv_step</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">step_conv1</span><span class="punctuation">,</span>
        <span class="grouping">)</span>
        <span class="identifier">data_pooled1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pooling</span><span class="grouping">(</span><span class="identifier">data_conved1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">size_pooling1</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">data_conved1</span><span class="punctuation">,</span> <span class="identifier">data_pooled1</span>


<span class="keyword">if</span> <span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">"__main__"</span><span class="punctuation">:</span>
    <span class="comment">"""
    I will put the example on other file
    """</span>

    </pre>
  </body>
</html>