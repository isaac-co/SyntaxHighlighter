<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Extract Box Editor for the manual adjustments tool """</span>
<span class="keyword">import</span> <span class="identifier">gettext</span>
<span class="keyword">import</span> <span class="identifier">platform</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span> <span class="keyword">import</span> <span class="identifier">AlignedFace</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">custom_widgets</span> <span class="keyword">import</span> <span class="identifier">RightClickMenu</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_config</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">Editor</span><span class="punctuation">,</span> <span class="identifier">logger</span>


<span class="comment"># LOCALES</span>
<span class="identifier">_LANG</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gettext</span><span class="punctuation">.</span><span class="identifier">translation</span><span class="grouping">(</span><span class="string-literal">"tools.manual", localedir="locales"</span><span class="punctuation">,</span> <span class="identifier">fallback</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_LANG</span><span class="punctuation">.</span><span class="identifier">gettext</span>


<span class="keyword">class</span> <span class="identifier">ExtractBox</span><span class="grouping">(</span><span class="identifier">Editor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The Extract Box Editor.

    Adjust the calculated Extract Box to shift all of the 68 point landmarks in place.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The canvas that holds the image and annotations
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The _detected_faces data for this manual session
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_right_click_menu</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RightClickMenu</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Delete Face"</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_delete_current_face</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                <span class="grouping">[</span><span class="string-literal">"Del"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">control_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Extract Box Editor\nMove the extract box that has been generated by the "</span>
                         <span class="string-literal">"aligner. Click and drag:\n\n"</span>
                         <span class="string-literal">" - Inside the bounding box to relocate the landmarks.\n"</span>
                         <span class="string-literal">" - The corner anchors to resize the landmarks.\n"</span>
                         <span class="string-literal">" - Outside of the corners to rotate the landmarks."</span><span class="grouping">)</span>
        <span class="identifier">key_bindings</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"&lt;Delete&gt;"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_delete_current_face</span><span class="grouping">}</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span>
                         <span class="identifier">control_text</span><span class="arithmetic-assignment">=</span><span class="identifier">control_text</span><span class="punctuation">,</span> <span class="identifier">key_bindings</span><span class="arithmetic-assignment">=</span><span class="identifier">key_bindings</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_corner_order</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The position index of bounding box corners """</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="string-literal">"top", "left"</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="int-literal">3</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="string-literal">"top", "right"</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="int-literal">2</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="string-literal">"bottom", "right"</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="int-literal">1</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="string-literal">"bottom", "left"</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">update_annotation</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Draw the latest Extract Boxes around the faces. """</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_color</span>
        <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_roi</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_iterator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Drawing Extract Box: (idx: %s)"</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
                <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">aligned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"face"</span><span class="grouping">)</span>
                <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale_to_display</span><span class="grouping">(</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">original_roi</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">box</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">10</span>
            <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">font</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">"Default", 20, "bold"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="string-literal">"eb_text", "text"</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
            <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="string-literal">"eb_box", "polygon"</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_anchor_annotation</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updated extract box annotations"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_anchor_annotation</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">extract_box</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the anchor annotations for each corner of the extract box.

        The anchors only display when the extract box editor is active.

        Parameters
        ----------
        face_index: int
            The index of the face being annotated
        extract_box: :class:`numpy.ndarray`
            The scaled extract box to get the corner anchors for
        color: str
            The hex color of the extract box line
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_active</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">hide_annotation</span><span class="grouping">(</span><span class="string-literal">"eb_anc_dsp"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">hide_annotation</span><span class="grouping">(</span><span class="string-literal">"eb_anc_grb"</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="identifier">fill_color</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"gray"</span>
        <span class="identifier">activefill_color</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"white" if self._is_active else ""</span>
        <span class="identifier">anchor_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_anchor_points</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">extract_box</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                 <span class="identifier">extract_box</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                 <span class="identifier">extract_box</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                 <span class="identifier">extract_box</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">anc_dsp</span><span class="punctuation">,</span> <span class="identifier">anc_grb</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">anchor_points</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">dsp_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">fill_color</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">grb_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"", fill=""</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">activefill</span><span class="arithmetic-assignment">=</span><span class="identifier">activefill_color</span><span class="grouping">)</span>
            <span class="identifier">dsp_key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"eb_anc_dsp_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
            <span class="identifier">grb_key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"eb_anc_grb_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">dsp_key</span><span class="punctuation">,</span> <span class="string-literal">"oval"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">anc_dsp</span><span class="punctuation">,</span> <span class="identifier">dsp_kwargs</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">grb_key</span><span class="punctuation">,</span> <span class="string-literal">"oval"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">anc_grb</span><span class="punctuation">,</span> <span class="identifier">grb_kwargs</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updated extract box anchor annotations"</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; MOUSE HANDLING &gt;&gt;</span>
    <span class="comment"># Mouse cursor display</span>
    <span class="keyword">def</span> <span class="identifier">_update_cursor</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the cursor when it is hovering over an extract box and update
        :attr:`_mouse_location` with the current cursor position.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The current tkinter mouse event
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_cursor_anchors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_cursor_box</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_cursor_rotate</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

    <span class="keyword">def</span> <span class="identifier">_check_cursor_anchors</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the cursor is over a corner anchor.

        If it is, set the appropriate cursor type and set :attr:`_mouse_location` to
        ("anchor", `face index`, `corner_index`)

        Returns
        -------
        bool
            ``True`` if cursor is over an anchor point otherwise ``False``
        """</span>
        <span class="identifier">anchors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"eb_anc_grb"</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">item_ids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"current"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">anchors</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">item_ids</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>
        <span class="identifier">item_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">item_ids</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">gettags</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">tag</span> <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span> <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"face_")).split("_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">corner_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">tag</span> <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span>
                              <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"eb_anc_grb_"</span><span class="grouping">)</span>
                              <span class="logical-operator">and</span> <span class="string-literal">"face_" not in tag).split("_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"{}_{}_corner"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_corner_order</span><span class="grouping">[</span><span class="identifier">corner_idx</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"anchor"</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">corner_idx</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">_check_cursor_box</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the cursor is inside an extract box.

        If it is, set the appropriate cursor type and set :attr:`_mouse_location` to
        ("box", `face index`)

        Returns
        -------
        bool
            ``True`` if cursor is over a rotate point otherwise ``False``
        """</span>
        <span class="identifier">extract_boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"eb_box"</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">item_ids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"current"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">extract_boxes</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">item_ids</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>
        <span class="identifier">item_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">item_ids</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fleur"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"box", next(int(tag.split("_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                                            <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">gettags</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
                                            <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"face_"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">_check_cursor_rotate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the cursor is in an area to rotate the extract box.

        If it is, set the appropriate cursor type and set :attr:`_mouse_location` to
        ("rotate", `face index`)

        Notes
        -----
        This code is executed after the check has been completed to see if the mouse is inside
        the extract box. For this reason, we don't bother running a check to see if the mouse
        is inside the box, as this code will never run if that is the case.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The current tkinter mouse event

        Returns
        -------
        bool
            ``True`` if cursor is over a rotate point otherwise ``False``
        """</span>
        <span class="identifier">distance</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
        <span class="identifier">boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
                          <span class="keyword">for</span> <span class="identifier">item_id</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"eb_box"</span><span class="grouping">)</span>
                          <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemcget</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="punctuation">,</span> <span class="string-literal">"state") != "hidden"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">points</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">boxes</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">any</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">position</span> <span class="relational-operator">&gt;</span> <span class="identifier">point</span> <span class="arithmetic-operator">-</span> <span class="identifier">distance</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">position</span> <span class="relational-operator">&lt;</span> <span class="identifier">point</span> <span class="arithmetic-operator">+</span> <span class="identifier">distance</span><span class="grouping">)</span>
                   <span class="keyword">for</span> <span class="identifier">point</span> <span class="relational-operator">in</span> <span class="identifier">points</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"exchange"</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"rotate"</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span>
                <span class="keyword">return</span> <span class="bool-literal">True</span>
        <span class="keyword">return</span> <span class="bool-literal">False</span>

    <span class="comment"># Mouse click actions</span>
    <span class="keyword">def</span> <span class="identifier">set_mouse_click_actions</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add context menu to OS specific right click action. """</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_mouse_click_actions</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Button-2&gt;" if platform.system() == "Darwin" else "&lt;Button-3&gt;"</span><span class="punctuation">,</span>
                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_context_menu</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_drag_start</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The action to perform when the user starts clicking and dragging the mouse.

        Selects the correct extract box action based on the initial cursor position.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_resize</span><span class="punctuation">,</span> <span class="identifier">rotate</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_rotate</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_move</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">callback</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">_drag_stop</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=unused-argument</span>
        <span class="comment">""" Trigger a viewport thumbnail update on click + drag release

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event. Required but unused.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">post_edit_trigger</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                                 <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_move</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Updates the underlying detected faces landmarks based on mouse dragging delta,
        which moves the Extract box on a drag event.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">shift_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">shift_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">scaled_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_from_display</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">shift_x</span><span class="punctuation">,</span> <span class="identifier">shift_y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">do_offset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                         <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                         <span class="arithmetic-operator">*</span><span class="identifier">scaled_shift</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_resize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Resizes the landmarks contained within an extract box on a corner anchor drag event.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">face_tag</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"eb_box_face_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="grouping">)</span>
        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">face_tag</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_in_bounds</span><span class="grouping">(</span><span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="punctuation">,</span> <span class="identifier">position</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Drag out of bounds. Not updating"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">position</span>
            <span class="keyword">return</span>

        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span>
        <span class="identifier">distance</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">center</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">center</span> <span class="arithmetic-operator">-</span> <span class="identifier">position</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="arithmetic-operator">*</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">scaling_factor</span><span class="grouping">)</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="float-literal">0.5</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">distance</span> <span class="arithmetic-operator">/</span> <span class="identifier">size</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"face_index: %s, center: %s, start: %s, position: %s, distance: %s, "</span>
                     <span class="string-literal">"size: %s, scale: %s"</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">position</span><span class="punctuation">,</span> <span class="identifier">distance</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span>
                     <span class="identifier">scale</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">size</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span> <span class="relational-operator">&lt;</span> <span class="int-literal">20</span><span class="punctuation">:</span>
            <span class="comment"># Don't over shrink the box</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Box would size to less than 20px. Not updating"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">position</span>
            <span class="keyword">return</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">landmarks_scale</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                               <span class="identifier">face_idx</span><span class="punctuation">,</span>
                                               <span class="identifier">scale</span><span class="punctuation">,</span>
                                               <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_from_display</span><span class="grouping">(</span><span class="identifier">center</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">position</span>

    <span class="keyword">def</span> <span class="identifier">_check_in_bounds</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="punctuation">,</span> <span class="identifier">position</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Ensure that a resize drag does is not going to cross the center point from it's initial
        corner location.

        Parameters
        ----------
        center: :class:`numpy.ndarray`
            The (`x`, `y`) center point of the face extract box
        box: :class:`numpy.ndarray`
            The canvas coordinates of the extract box polygon's corners
        position: : class:`numpy.ndarray`
            The current (`x`, `y`) position of the mouse cursor

        Returns
        -------
        bool
            ``True`` if the drag operation does not cross the center point otherwise ``False``
        """</span>
        <span class="comment"># Generate lines that span the full frame (x and y) along the center point</span>
        <span class="identifier">center_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">center</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">center</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">center_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_display_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Generate a line coming from the current corner location to the current cursor position</span>
        <span class="identifier">full_line</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">position</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"center: %s, center_x_line: %s, center_y_line: %s, full_line: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">center_x</span><span class="punctuation">,</span> <span class="identifier">center_y</span><span class="punctuation">,</span> <span class="identifier">full_line</span><span class="grouping">)</span>

        <span class="comment"># Check whether any of the generated lines intersect</span>
        <span class="keyword">for</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">center_x</span><span class="punctuation">,</span> <span class="identifier">center_y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_ccw</span><span class="grouping">(</span><span class="identifier">full_line</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">line</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_ccw</span><span class="grouping">(</span><span class="identifier">full_line</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">line</span><span class="grouping">)</span> <span class="logical-operator">and</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_ccw</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">full_line</span><span class="punctuation">,</span> <span class="identifier">line</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_ccw</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">full_line</span><span class="punctuation">,</span> <span class="identifier">line</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"line: %s crosses center: %s"</span><span class="punctuation">,</span> <span class="identifier">full_line</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="grouping">)</span>
                <span class="keyword">return</span> <span class="bool-literal">False</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_is_ccw</span><span class="grouping">(</span><span class="identifier">point_a</span><span class="punctuation">,</span> <span class="identifier">point_b</span><span class="punctuation">,</span> <span class="identifier">point_c</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether 3 points are counter clockwise from each other.

        Parameters
        ----------
        point_a: :class:`numpy.ndarray`
            The first (`x`, `y`) point to check for counter clockwise ordering
        point_b: :class:`numpy.ndarray`
            The second (`x`, `y`) point to check for counter clockwise ordering
        point_c: :class:`numpy.ndarray`
            The third (`x`, `y`) point to check for counter clockwise ordering

        Returns
        -------
        bool
            ``True`` if the 3 points are provided in counter clockwise order otherwise ``False``
        """</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">point_c</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">point_a</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">point_b</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">point_a</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
                <span class="grouping">(</span><span class="identifier">point_b</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">point_a</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">point_c</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">point_a</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_rotate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Rotates the landmarks contained within an extract box on a corner rotate drag event.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">face_tag</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"eb_box_face_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="grouping">)</span>
        <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">face_tag</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">init_to_center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">center</span>
        <span class="identifier">new_to_center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">position</span> <span class="arithmetic-operator">-</span> <span class="identifier">center</span>
        <span class="identifier">angle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rad2deg</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arctan2</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">new_to_center</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arctan2</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">init_to_center</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"face_index: %s, box: %s, center: %s, init_to_center: %s, new_to_center: %s"</span>
                     <span class="string-literal">"center: %s, angle: %s"</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">init_to_center</span><span class="punctuation">,</span> <span class="identifier">new_to_center</span><span class="punctuation">,</span>
                     <span class="identifier">center</span><span class="punctuation">,</span> <span class="identifier">angle</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">landmarks_rotate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span>
                                                <span class="identifier">face_idx</span><span class="punctuation">,</span>
                                                <span class="identifier">angle</span><span class="punctuation">,</span>
                                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale_from_display</span><span class="grouping">(</span><span class="identifier">center</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"current_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">position</span>

    <span class="keyword">def</span> <span class="identifier">_get_scale</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain the scaling for the extract box resize """</span>

    <span class="keyword">def</span> <span class="identifier">_context_menu</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create a right click context menu to delete the alignment that is being
        hovered over. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="string-literal">"box"</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_right_click_menu</span><span class="punctuation">.</span><span class="identifier">popup</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_delete_current_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Called by the right click delete event. Deletes the face that the mouse is currently
        over.

        Parameters
        ----------
        args: tuple (unused)
            The event parameter is passed in by the hot key binding, so args is required
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="string-literal">"box"</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    </pre>
  </body>
</html>