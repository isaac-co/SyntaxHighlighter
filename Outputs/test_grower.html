<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">pytest</span> <span class="keyword">import</span> <span class="identifier">approx</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">OneHotEncoder</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">grower</span> <span class="keyword">import</span> <span class="identifier">TreeGrower</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">binning</span> <span class="keyword">import</span> <span class="identifier">_BinMapper</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">X_BINNED_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">X_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">Y_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">G_H_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">X_BITSET_INNER_DTYPE</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_make_training_data</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="identifier">constant_hessian</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10000</span>

    <span class="comment"># Generate some test data directly binned so as to test the grower code</span>
    <span class="comment"># independently of the binning logic.</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">true_decision_function</span><span class="grouping">(</span><span class="identifier">input_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Ground truth decision function

        This is a very simple yet asymmetric decision tree. Therefore the
        grower code should have no trouble recovering the decision function
        from 10000 training samples.
        """</span>
        <span class="keyword">if</span> <span class="identifier">input_features</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">input_features</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span> <span class="keyword">else</span> <span class="int-literal">1</span>

    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">true_decision_function</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">X_binned</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_DTYPE</span><span class="grouping">)</span>

    <span class="comment"># Assume a square loss applied to an initial model that always predicts 0</span>
    <span class="comment"># (hardcoded for this test):</span>
    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">shape_hessians</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">constant_hessian</span> <span class="keyword">else</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape_hessians</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span>


<span class="keyword">def</span> <span class="identifier">_check_children_consistency</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">left</span><span class="punctuation">,</span> <span class="identifier">right</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the samples are correctly dispatched from a parent to its</span>
    <span class="comment"># children</span>
    <span class="keyword">assert</span> <span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">left_child</span> <span class="relational-operator">is</span> <span class="identifier">left</span>
    <span class="keyword">assert</span> <span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">right_child</span> <span class="relational-operator">is</span> <span class="identifier">right</span>

    <span class="comment"># each sample from the parent is propagated to one of the two children</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">left</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">right</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span>
            <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">left</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">union</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">right</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># samples are sent either to the left or the right node, never to both</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">left</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">right</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'n_bins, constant_hessian, stopping_param, shrinkage'</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">"min_gain_to_split"</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">"min_gain_to_split"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">"min_gain_to_split"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_grow_tree</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">constant_hessian</span><span class="punctuation">,</span> <span class="identifier">stopping_param</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_training_data</span><span class="grouping">(</span>
        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">constant_hessian</span><span class="arithmetic-assignment">=</span><span class="identifier">constant_hessian</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">stopping_param</span> <span class="relational-operator">==</span> <span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">:</span>
        <span class="identifier">stopping_param</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"max_leaf_nodes"</span><span class="punctuation">:</span> <span class="int-literal">3</span><span class="grouping">}</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">stopping_param</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"min_gain_to_split"</span><span class="punctuation">:</span> <span class="float-literal">0.01</span><span class="grouping">}</span>

    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="identifier">shrinkage</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">stopping_param</span><span class="grouping">)</span>

    <span class="comment"># The root node is not yet splitted, but the best possible split has</span>
    <span class="comment"># already been evaluated:</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">left_child</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">right_child</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

    <span class="identifier">root_split</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">split_info</span>
    <span class="keyword">assert</span> <span class="identifier">root_split</span><span class="punctuation">.</span><span class="identifier">feature_idx</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">root_split</span><span class="punctuation">.</span><span class="identifier">bin_idx</span> <span class="relational-operator">==</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">splittable_nodes</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="comment"># Calling split next applies the next split and computes the best split</span>
    <span class="comment"># for each of the two newly introduced children nodes.</span>
    <span class="identifier">left_node</span><span class="punctuation">,</span> <span class="identifier">right_node</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">split_next</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># All training samples have ben splitted in the two nodes, approximately</span>
    <span class="comment"># 50%/50%</span>
    <span class="identifier">_check_children_consistency</span><span class="grouping">(</span><span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">,</span> <span class="identifier">left_node</span><span class="punctuation">,</span> <span class="identifier">right_node</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">left_node</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.4</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">left_node</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.6</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>

    <span class="keyword">if</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">min_gain_to_split</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="comment"># The left node is too pure: there is no gain to split it further.</span>
        <span class="keyword">assert</span> <span class="identifier">left_node</span><span class="punctuation">.</span><span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">gain</span> <span class="relational-operator">&lt;</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">min_gain_to_split</span>
        <span class="keyword">assert</span> <span class="identifier">left_node</span> <span class="relational-operator">in</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">finalized_leaves</span>

    <span class="comment"># The right node can still be splitted further, this time on feature #1</span>
    <span class="identifier">split_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">right_node</span><span class="punctuation">.</span><span class="identifier">split_info</span>
    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">gain</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">feature_idx</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">split_info</span><span class="punctuation">.</span><span class="identifier">bin_idx</span> <span class="relational-operator">==</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">right_node</span><span class="punctuation">.</span><span class="identifier">left_child</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="keyword">assert</span> <span class="identifier">right_node</span><span class="punctuation">.</span><span class="identifier">right_child</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

    <span class="comment"># The right split has not been applied yet. Let's do it now:</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">splittable_nodes</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="identifier">right_left_node</span><span class="punctuation">,</span> <span class="identifier">right_right_node</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">split_next</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">_check_children_consistency</span><span class="grouping">(</span><span class="identifier">right_node</span><span class="punctuation">,</span> <span class="identifier">right_left_node</span><span class="punctuation">,</span> <span class="identifier">right_right_node</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">right_left_node</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">right_left_node</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">right_right_node</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">right_right_node</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.4</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>

    <span class="comment"># All the leafs are pure, it is not possible to split any further:</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">splittable_nodes</span>

    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">_apply_shrinkage</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Check the values of the leaves:</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">left_child</span><span class="punctuation">.</span><span class="identifier">value</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">shrinkage</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">right_child</span><span class="punctuation">.</span><span class="identifier">left_child</span><span class="punctuation">.</span><span class="identifier">value</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">shrinkage</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">right_child</span><span class="punctuation">.</span><span class="identifier">right_child</span><span class="punctuation">.</span><span class="identifier">value</span> <span class="relational-operator">==</span> <span class="identifier">approx</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">shrinkage</span><span class="punctuation">,</span>
                                                               <span class="identifier">rel</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_predictor_from_grower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Build a tree on the toy 3-leaf dataset to extract the predictor.</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span>
    <span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_training_data</span><span class="grouping">(</span>
        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span>
    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span>
                        <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">n_nodes</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>  <span class="comment"># (2 decision nodes + 3 leaves)</span>

    <span class="comment"># Check that the node structure can be converted into a predictor</span>
    <span class="comment"># object to perform predictions at scale</span>
    <span class="comment"># We pass undefined binning_thresholds because we won't use predict anyway</span>
    <span class="identifier">predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span>
        <span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>
    <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="string-literal">'is_leaf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    <span class="comment"># Probe some predictions for each leaf of the tree</span>
    <span class="comment"># each group of 3 samples corresponds to a condition in _make_training_data</span>
    <span class="identifier">input_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">99</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">254</span><span class="grouping">]</span><span class="punctuation">,</span>

        <span class="grouping">[</span><span class="int-literal">129</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">129</span><span class="punctuation">,</span> <span class="int-literal">85</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">254</span><span class="punctuation">,</span> <span class="int-literal">85</span><span class="grouping">]</span><span class="punctuation">,</span>

        <span class="grouping">[</span><span class="int-literal">129</span><span class="punctuation">,</span> <span class="int-literal">86</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">129</span><span class="punctuation">,</span> <span class="int-literal">254</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">242</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">missing_values_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict_binned</span><span class="grouping">(</span><span class="identifier">input_data</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="grouping">)</span>
    <span class="identifier">expected_targets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">predictions</span><span class="punctuation">,</span> <span class="identifier">expected_targets</span><span class="grouping">)</span>

    <span class="comment"># Check that training set can be recovered exactly:</span>
    <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict_binned</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">all_gradients</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'n_samples, min_samples_leaf, n_bins, constant_hessian, noise'</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">56</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">101</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="int-literal">55</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="int-literal">301</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_samples_leaf</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="punctuation">,</span>
                          <span class="identifier">constant_hessian</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># data = linear target, 3 features, 1 irrelevant.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">noise</span><span class="punctuation">:</span>
        <span class="identifier">y_scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="identifier">noise</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">y_scale</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">shape_hessian</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">constant_hessian</span> <span class="keyword">else</span> <span class="identifier">all_gradients</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape_hessian</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">min_samples_leaf</span><span class="punctuation">,</span>
                        <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span>
        <span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">n_samples</span> <span class="relational-operator">&gt;=</span> <span class="identifier">min_samples_leaf</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">node</span> <span class="relational-operator">in</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">node</span><span class="grouping">[</span><span class="string-literal">'is_leaf'</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">assert</span> <span class="identifier">node</span><span class="grouping">[</span><span class="string-literal">'count'</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="identifier">min_samples_leaf</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'is_leaf'</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'count'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_samples, min_samples_leaf'</span><span class="punctuation">,</span> <span class="grouping">[</span>
                         <span class="grouping">(</span><span class="int-literal">99</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_samples_leaf_root</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure root node isn't split if n_samples is not at least twice</span>
    <span class="comment"># min_samples_leaf</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span>

    <span class="comment"># data = linear target, 3 features, 1 irrelevant.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">min_samples_leaf</span><span class="punctuation">,</span>
                        <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_samples</span> <span class="relational-operator">&gt;=</span> <span class="identifier">min_samples_leaf</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">finalized_leaves</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">2</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">finalized_leaves</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">p</span><span class="grouping">(</span><span class="identifier">grower</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># To assert that stumps are created when max_depth=1</span>
    <span class="keyword">for</span> <span class="identifier">leaf</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">left_child</span><span class="punctuation">,</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">right_child</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">leaf</span><span class="punctuation">.</span><span class="identifier">left_child</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
        <span class="keyword">assert</span> <span class="identifier">leaf</span><span class="punctuation">.</span><span class="identifier">right_child</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'max_depth'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_max_depth</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure max_depth parameter works as expected</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>

    <span class="comment"># data = linear target, 3 features, 1 irrelevant.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">depth</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">leaf</span><span class="punctuation">.</span><span class="identifier">depth</span> <span class="keyword">for</span> <span class="identifier">leaf</span> <span class="relational-operator">in</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">finalized_leaves</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">depth</span> <span class="relational-operator">==</span> <span class="identifier">max_depth</span>

    <span class="keyword">if</span> <span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">p</span><span class="grouping">(</span><span class="identifier">grower</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_input_validation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_training_data</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X_binned_float</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotImplementedError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"X_binned must be of type uint8"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned_float</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="grouping">)</span>

    <span class="identifier">X_binned_C_array</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">u</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">ValueError</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"X_binned should be passed as Fortran contiguous array"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned_C_array</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_init_parameters_validation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_training_data</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"min_gain_to_split=-1 must be positive"</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                   <span class="identifier">min_gain_to_split</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"min_hessian_to_split=-1 must be positive"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                   <span class="identifier">min_hessian_to_split</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_missing_value_predict_only</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that missing values are supported at predict time even if they</span>
    <span class="comment"># were not encountered in the training data: the missing values are</span>
    <span class="comment"># assigned to whichever child has the most samples.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>

    <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">hessians</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                        <span class="identifier">has_missing_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># We pass undefined binning_thresholds because we won't use predict anyway</span>
    <span class="identifier">predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span>
        <span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="comment"># go from root to a leaf, always following node with the most samples.</span>
    <span class="comment"># That's the path nans are supposed to take</span>
    <span class="identifier">node</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">while</span> <span class="logical-operator">not</span> <span class="identifier">node</span><span class="grouping">[</span><span class="string-literal">'is_leaf'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">[</span><span class="string-literal">'left'</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">[</span><span class="string-literal">'right'</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">node</span> <span class="arithmetic-assignment">=</span> <span class="identifier">left</span> <span class="keyword">if</span> <span class="identifier">left</span><span class="grouping">[</span><span class="string-literal">'count'] &gt; right['count'</span><span class="grouping">]</span> <span class="keyword">else</span> <span class="identifier">right</span>

    <span class="identifier">prediction_main_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node</span><span class="grouping">[</span><span class="string-literal">'value'</span><span class="grouping">]</span>

    <span class="comment"># now build X_test with only nans, and make sure all predictions are equal</span>
    <span class="comment"># to prediction_main_path</span>
    <span class="identifier">all_nans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">fill_value</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span>
    <span class="identifier">known_cat_bitsets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BITSET_INNER_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">f_idx_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">all_nans</span><span class="punctuation">,</span> <span class="identifier">known_cat_bitsets</span><span class="punctuation">,</span> <span class="identifier">f_idx_map</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">==</span> <span class="identifier">prediction_main_path</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_split_on_nan_with_infinite_values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the split on nan situations are respected even when there are</span>
    <span class="comment"># samples with +inf values (we set the threshold to +inf when we have a</span>
    <span class="comment"># split on nan so this test makes sure this does not introduce edge-case</span>
    <span class="comment"># bugs). We need to use the private API so that we can also test</span>
    <span class="comment"># predict_binned().</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># the gradient values will force a split on nan situation</span>
    <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">has_missing_values</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">hessians</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins_non_missing</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span>
                        <span class="identifier">has_missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">has_missing_values</span><span class="punctuation">,</span>
                        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span>
        <span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span>
    <span class="grouping">)</span>

    <span class="comment"># sanity check: this was a split on nan</span>
    <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'num_threshold'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
    <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'bin_threshold'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_bins_non_missing</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="identifier">known_cat_bitsets</span><span class="punctuation">,</span> <span class="identifier">f_idx_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">make_known_categories_bitsets</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Make sure in particular that the +inf sample is mapped to the left child</span>
    <span class="comment"># Note that lightgbm "fails" here and will assign the inf sample to the</span>
    <span class="comment"># right child, even though it's a "split on nan" situation.</span>
    <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">known_cat_bitsets</span><span class="punctuation">,</span> <span class="identifier">f_idx_map</span><span class="grouping">)</span>
    <span class="identifier">predictions_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict_binned</span><span class="grouping">(</span>
        <span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="arithmetic-assignment">=</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">missing_values_bin_idx_</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">predictions</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">gradients</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">predictions_binned</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">gradients</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grow_tree_categories</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that the grower produces the right predictor tree when a split is</span>
    <span class="comment"># categorical</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>

    <span class="identifier">all_gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">11</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">all_hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>
    <span class="identifier">is_categorical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>

    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">all_gradients</span><span class="punctuation">,</span> <span class="identifier">all_hessians</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">shrinkage</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                        <span class="identifier">is_categorical</span><span class="arithmetic-assignment">=</span><span class="identifier">is_categorical</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">n_nodes</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    <span class="identifier">categories</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span><span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">categories</span><span class="grouping">)</span>
    <span class="identifier">root</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">root</span><span class="grouping">[</span><span class="string-literal">'count'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">23</span>
    <span class="keyword">assert</span> <span class="identifier">root</span><span class="grouping">[</span><span class="string-literal">'depth'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">root</span><span class="grouping">[</span><span class="string-literal">'is_categorical'</span><span class="grouping">]</span>

    <span class="identifier">left</span><span class="punctuation">,</span> <span class="identifier">right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="identifier">root</span><span class="grouping">[</span><span class="string-literal">'left']], predictor.nodes[root['right'</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="comment"># arbitrary validation, but this means ones go to the left.</span>
    <span class="keyword">assert</span> <span class="identifier">left</span><span class="grouping">[</span><span class="string-literal">'count'] &gt;= right['count'</span><span class="grouping">]</span>

    <span class="comment"># check binned category value (1)</span>
    <span class="identifier">expected_binned_cat_bitset</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">7</span>
    <span class="identifier">binned_cat_bitset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">binned_left_cat_bitsets</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned_cat_bitset</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">expected_binned_cat_bitset</span><span class="grouping">)</span>

    <span class="comment"># check raw category value (9)</span>
    <span class="identifier">expected_raw_cat_bitsets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">9</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">7</span>
    <span class="identifier">raw_cat_bitsets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">raw_left_cat_bitsets</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">raw_cat_bitsets</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">expected_raw_cat_bitsets</span><span class="grouping">)</span>

    <span class="comment"># Note that since there was no missing values during training, the missing</span>
    <span class="comment"># values aren't part of the bitsets. However, we expect the missing values</span>
    <span class="comment"># to go to the biggest child (i.e. the left one).</span>
    <span class="comment"># The left child has a value of -1 = negative gradient.</span>
    <span class="keyword">assert</span> <span class="identifier">root</span><span class="grouping">[</span><span class="string-literal">'missing_go_to_left'</span><span class="grouping">]</span>

    <span class="comment"># make sure binned missing values are mapped to the left child during</span>
    <span class="comment"># prediction</span>
    <span class="identifier">prediction_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict_binned</span><span class="grouping">(</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_BINNED_DTYPE</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">prediction_binned</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># negative gradient</span>

    <span class="comment"># make sure raw missing values are mapped to the left child during</span>
    <span class="comment"># prediction</span>
    <span class="identifier">known_cat_bitsets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>  <span class="comment"># ignored anyway</span>
    <span class="identifier">f_idx_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>
    <span class="identifier">prediction</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">known_cat_bitsets</span><span class="punctuation">,</span>
                                   <span class="identifier">f_idx_map</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">prediction</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'min_samples_leaf'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_unique_categories'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'target', ('binary', 'random', 'equal'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ohe_equivalence</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="punctuation">,</span> <span class="identifier">n_unique_categories</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that native categorical splits are equivalent to using a OHE,</span>
    <span class="comment"># when given enough depth</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="invalid">_</span><span class="int-literal">000</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_unique_categories</span><span class="punctuation">,</span>
                           <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>

    <span class="identifier">X_ohe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OneHotEncoder</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="grouping">)</span>
    <span class="identifier">X_ohe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X_ohe</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">target</span> <span class="relational-operator">==</span> <span class="string-literal">'equal'</span><span class="punctuation">:</span>
        <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_binned</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">target</span> <span class="relational-operator">==</span> <span class="string-literal">'binary'</span><span class="punctuation">:</span>
        <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_binned</span> <span class="arithmetic-operator">%</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">gradients</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gradients</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">G_H_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">grower_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'min_samples_leaf'</span><span class="punctuation">:</span> <span class="identifier">min_samples_leaf</span><span class="punctuation">,</span>
        <span class="string-literal">'max_depth'</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="punctuation">,</span>
        <span class="string-literal">'max_leaf_nodes'</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="punctuation">,</span>
    <span class="grouping">}</span>

    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">hessians</span><span class="punctuation">,</span> <span class="identifier">is_categorical</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="arithmetic-operator">**</span><span class="identifier">grower_params</span><span class="grouping">)</span>
    <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># we pass undefined bin_thresholds because we won't use predict()</span>
    <span class="identifier">predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span>
        <span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_unique_categories</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">preds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">predict_binned</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="arithmetic-assignment">=</span><span class="int-literal">255</span><span class="grouping">)</span>

    <span class="identifier">grower_ohe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_ohe</span><span class="punctuation">,</span> <span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">hessians</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">grower_params</span><span class="grouping">)</span>
    <span class="identifier">grower_ohe</span><span class="punctuation">.</span><span class="identifier">grow</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">predictor_ohe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower_ohe</span><span class="punctuation">.</span><span class="identifier">make_predictor</span><span class="grouping">(</span>
        <span class="identifier">binning_thresholds</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X_ohe</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_unique_categories</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">preds_ohe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predictor_ohe</span><span class="punctuation">.</span><span class="identifier">predict_binned</span><span class="grouping">(</span><span class="identifier">X_ohe</span><span class="punctuation">,</span> <span class="identifier">missing_values_bin_idx</span><span class="arithmetic-assignment">=</span><span class="int-literal">255</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">get_max_depth</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">predictor_ohe</span><span class="punctuation">.</span><span class="identifier">get_max_depth</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">target</span> <span class="relational-operator">==</span> <span class="string-literal">'binary'</span> <span class="logical-operator">and</span> <span class="identifier">n_unique_categories</span> <span class="relational-operator">&gt;</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="comment"># OHE needs more splits to achieve the same predictions</span>
        <span class="keyword">assert</span> <span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">get_max_depth</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">predictor_ohe</span><span class="punctuation">.</span><span class="identifier">get_max_depth</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">preds</span><span class="punctuation">,</span> <span class="identifier">preds_ohe</span><span class="grouping">)</span>

    </pre>
  </body>
</html>