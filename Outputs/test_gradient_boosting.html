<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span><span class="punctuation">,</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_low_rank_matrix</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">KBinsDiscretizer</span><span class="punctuation">,</span> <span class="identifier">MinMaxScaler</span><span class="punctuation">,</span> <span class="identifier">OneHotEncoder</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span><span class="punctuation">,</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">is_regressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_poisson_deviance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">make_column_transformer</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="keyword">import</span> <span class="identifier">_LOSSES</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="keyword">import</span> <span class="identifier">LeastSquares</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">loss</span> <span class="keyword">import</span> <span class="identifier">BinaryCrossEntropy</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">grower</span> <span class="keyword">import</span> <span class="identifier">TreeGrower</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">binning</span> <span class="keyword">import</span> <span class="identifier">_BinMapper</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">shuffle</span>


<span class="identifier">X_classification</span><span class="punctuation">,</span> <span class="identifier">y_classification</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">X_regression</span><span class="punctuation">,</span> <span class="identifier">y_regression</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">X_multi_classification</span><span class="punctuation">,</span> <span class="identifier">y_multi_classification</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
    <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
<span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_make_dumb_dataset</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Make a dumb dataset to test early stopping."""</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X_dumb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y_dumb</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_dumb</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int64'</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X_dumb</span><span class="punctuation">,</span> <span class="identifier">y_dumb</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'GradientBoosting, X, y'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span> <span class="identifier">X_classification</span><span class="punctuation">,</span> <span class="identifier">y_classification</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="punctuation">,</span> <span class="identifier">X_regression</span><span class="punctuation">,</span> <span class="identifier">y_regression</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'params, err_msg'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'loss': 'blah'}, 'Loss blah is not supported for'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'learning_rate': 0}, 'learning_rate=0 must be strictly positive'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'learning_rate': -1}, 'learning_rate=-1 must be strictly positive'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_iter': 0}, 'max_iter=0 must not be smaller than 1'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_leaf_nodes': 0}, 'max_leaf_nodes=0 should not be smaller than 2'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_leaf_nodes': 1}, 'max_leaf_nodes=1 should not be smaller than 2'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_depth': 0}, 'max_depth=0 should not be smaller than 1'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'min_samples_leaf': 0}, 'min_samples_leaf=0 should not be smaller'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'l2_regularization': -1}, 'l2_regularization=-1 must be positive'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_bins': 1}, 'max_bins=1 should be no smaller than 2 and no larger'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'max_bins': 256}, 'max_bins=256 should be no smaller than 2 and no'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'n_iter_no_change': -1}, 'n_iter_no_change=-1 must be positive'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'validation_fraction': -1}, 'validation_fraction=-1 must be strictly'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'validation_fraction': 0}, 'validation_fraction=0 must be strictly'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'tol': -1}, 'tol=-1 must not be smaller than 0'</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_init_parameters_validation</span><span class="grouping">(</span><span class="identifier">GradientBoosting</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">GradientBoosting</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_invalid_classification_loss</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">binary_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"binary_crossentropy"</span><span class="grouping">)</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"loss='binary_crossentropy' is not defined for multiclass "</span>
               <span class="string-literal">"classification with n_classes=3, use "</span>
               <span class="string-literal">"loss='categorical_crossentropy' instead"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">binary_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'scoring, validation_fraction, early_stopping, n_iter_no_change, tol'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use scorer</span>
        <span class="grouping">(</span><span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use scorer on train</span>
        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># same with default scorer</span>
        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'loss'</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use loss</span>
        <span class="grouping">(</span><span class="string-literal">'loss'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use loss on training data</span>
        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># no early stopping</span>
        <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_early_stopping_regression</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">validation_fraction</span><span class="punctuation">,</span>
                                   <span class="identifier">early_stopping</span><span class="punctuation">,</span> <span class="identifier">n_iter_no_change</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">200</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span>
        <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>  <span class="comment"># just for coverage</span>
        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># easier to overfit fast</span>
        <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="punctuation">,</span>
        <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
        <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="identifier">early_stopping</span><span class="punctuation">,</span>
        <span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="identifier">validation_fraction</span><span class="punctuation">,</span>
        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
        <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter_no_change</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">early_stopping</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">n_iter_no_change</span> <span class="relational-operator">&lt;=</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_iter</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'data'</span><span class="punctuation">,</span> <span class="grouping">(</span>
    <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_clusters_per_class</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'scoring, validation_fraction, early_stopping, n_iter_no_change, tol'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'accuracy'</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use scorer</span>
        <span class="grouping">(</span><span class="string-literal">'accuracy'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use scorer on training data</span>
        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># same with default scorer</span>
        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'loss'</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use loss</span>
        <span class="grouping">(</span><span class="string-literal">'loss'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1e-1</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># use loss on training data</span>
        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># no early stopping</span>
        <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_early_stopping_classification</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">validation_fraction</span><span class="punctuation">,</span>
                                       <span class="identifier">early_stopping</span><span class="punctuation">,</span> <span class="identifier">n_iter_no_change</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>

    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span>
        <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>  <span class="comment"># just for coverage</span>
        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>  <span class="comment"># easier to overfit fast</span>
        <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="punctuation">,</span>
        <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
        <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="identifier">early_stopping</span><span class="punctuation">,</span>
        <span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="identifier">validation_fraction</span><span class="punctuation">,</span>
        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
        <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter_no_change</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">early_stopping</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">n_iter_no_change</span> <span class="relational-operator">&lt;=</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_iter</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'GradientBoosting, X, y'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">_make_dumb_dataset</span><span class="grouping">(</span><span class="int-literal">10000</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">_make_dumb_dataset</span><span class="grouping">(</span><span class="int-literal">10001</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">_make_dumb_dataset</span><span class="grouping">(</span><span class="int-literal">10000</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">_make_dumb_dataset</span><span class="grouping">(</span><span class="int-literal">10001</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_early_stopping_default</span><span class="grouping">(</span><span class="identifier">GradientBoosting</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that early stopping is enabled by default if and only if there</span>
    <span class="comment"># are more than 10000 samples</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GradientBoosting</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">10000</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&lt;</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">max_iter</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">max_iter</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'scores, n_iter_no_change, tol, stopping'</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># not enough iterations</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># not enough iterations</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># not enough iterations</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># significant improvement</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># significant improvement</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.999</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># significant improvement</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span> <span class="arithmetic-operator">-</span> <span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># significant improvement</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># no significant improvement</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># no significant improvement</span>
        <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>  <span class="comment"># no significant improvement</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_should_stop</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">n_iter_no_change</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">stopping</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span>
        <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter_no_change</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">_should_stop</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">stopping</span>


<span class="keyword">def</span> <span class="identifier">test_absolute_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For coverage only.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'absolute_error'</span><span class="punctuation">,</span>
                                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.9</span>


<span class="keyword">def</span> <span class="identifier">test_absolute_error_sample_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># non regression test for issue #19400</span>
    <span class="comment"># make sure no error is thrown during fit of</span>
    <span class="comment"># HistGradientBoostingRegressor with absolute_error loss function</span>
    <span class="comment"># and passing sample_weight</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'absolute_error'</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'y'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_poisson_y_positive</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that ValueError is raised if either one y_i &lt; 0 or sum(y_i) &lt;= 0.</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"loss='poisson' requires non-negative y and sum\(y\) &gt; 0."</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'poisson'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_poisson</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For Poisson distributed target, Poisson loss should give better results</span>
    <span class="comment"># than least squares measured in Poisson deviance as metric.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_low_rank_matrix</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_train</span><span class="arithmetic-operator">+</span><span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                             <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="comment"># We create a log-linear Poisson model and downscale coef as it will get</span>
    <span class="comment"># exponentiated.</span>
    <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">poisson</span><span class="grouping">(</span><span class="identifier">lam</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">X</span> <span class="punctuation">@</span> <span class="identifier">coef</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_test</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">gbdt_pois</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'poisson'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">gbdt_ls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">gbdt_pois</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">gbdt_ls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">dummy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">metric_pois</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_poisson_deviance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">gbdt_pois</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># squared_error might produce non-positive predictions =&gt; clip</span>
        <span class="identifier">metric_ls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_poisson_deviance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">gbdt_ls</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1e-15</span><span class="punctuation">,</span>
                                                     <span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">metric_dummy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_poisson_deviance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">dummy</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">metric_pois</span> <span class="relational-operator">&lt;</span> <span class="identifier">metric_ls</span>
        <span class="keyword">assert</span> <span class="identifier">metric_pois</span> <span class="relational-operator">&lt;</span> <span class="identifier">metric_dummy</span>


<span class="keyword">def</span> <span class="identifier">test_binning_train_validation_are_separated</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure training and validation data are binned separately.</span>
    <span class="comment"># See issue 13926</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">validation_fraction</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.2</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span>
        <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="identifier">validation_fraction</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span>
    <span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_classification</span><span class="punctuation">,</span> <span class="identifier">y_classification</span><span class="grouping">)</span>
    <span class="identifier">mapper_training_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">_bin_mapper</span>

    <span class="comment"># Note that since the data is small there is no subsampling and the</span>
    <span class="comment"># random_state doesn't matter</span>
    <span class="identifier">mapper_whole_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mapper_whole_data</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_classification</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_classification</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">mapper_training_data</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span> <span class="relational-operator">==</span>
                  <span class="identifier">int</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">validation_fraction</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">mapper_training_data</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span> <span class="relational-operator">!=</span>
                  <span class="identifier">mapper_whole_data</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_missing_values_trivial</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># sanity check for missing values support. With only one feature and</span>
    <span class="comment"># y == isnan(X), the gbdt is supposed to reach perfect accuracy on the</span>
    <span class="comment"># training set.</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'problem', ('classification', 'regression'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'missing_proportion, expected_min_score_classification, '</span>
    <span class="string-literal">'expected_min_score_regression'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.97</span><span class="punctuation">,</span> <span class="float-literal">.89</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="float-literal">.93</span><span class="punctuation">,</span> <span class="float-literal">.81</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="float-literal">.79</span><span class="punctuation">,</span> <span class="float-literal">.52</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_values_resilience</span><span class="grouping">(</span><span class="identifier">problem</span><span class="punctuation">,</span> <span class="identifier">missing_proportion</span><span class="punctuation">,</span>
                                   <span class="identifier">expected_min_score_classification</span><span class="punctuation">,</span>
                                   <span class="identifier">expected_min_score_regression</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the estimators can deal with missing values and still yield</span>
    <span class="comment"># decent predictions</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="keyword">if</span> <span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'regression'</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                               <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
        <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">expected_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_min_score_regression</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                   <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                   <span class="identifier">n_repeated</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
        <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">expected_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_min_score_classification</span>

    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">missing_proportion</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="identifier">expected_min_score</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'data'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'binary_crossentropy', 'categorical_crossentropy'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_zero_division_hessians</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># non regression test for issue #14018</span>
    <span class="comment"># make sure we avoid zero division errors when computing the leaves values.</span>

    <span class="comment"># If the learning rate is too high, the raw predictions are bad and will</span>
    <span class="comment"># saturate the softmax (or sigmoid in binary classif). This leads to</span>
    <span class="comment"># probabilities being exactly 0 or 1, gradients being constant, and</span>
    <span class="comment"># hessians being zero.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_small_trainset</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that the small trainset is stratified and has the expected</span>
    <span class="comment"># length (10k samples)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20000</span>
    <span class="identifier">original_distrib</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">:</span> <span class="float-literal">0.4</span><span class="grouping">}</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">prop</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="identifier">prop</span><span class="grouping">)</span>
         <span class="relational-operator">in</span> <span class="identifier">original_distrib</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Compute the small training set</span>
    <span class="identifier">X_small</span><span class="punctuation">,</span> <span class="identifier">y_small</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">_get_small_trainset</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                                                 <span class="identifier">sample_weight_train</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="comment"># Compute the class distribution in the small training set</span>
    <span class="identifier">unique</span><span class="punctuation">,</span> <span class="identifier">counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_small</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">small_distrib</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">:</span> <span class="identifier">count</span> <span class="arithmetic-operator">/</span> <span class="int-literal">10000</span> <span class="keyword">for</span> <span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="identifier">count</span><span class="grouping">)</span>
                     <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">unique</span><span class="punctuation">,</span> <span class="identifier">counts</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="comment"># Test that the small training set has the expected length</span>
    <span class="keyword">assert</span> <span class="identifier">X_small</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">10000</span>
    <span class="keyword">assert</span> <span class="identifier">y_small</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">10000</span>

    <span class="comment"># Test that the class distributions in the whole dataset and in the small</span>
    <span class="comment"># training set are identical</span>
    <span class="keyword">assert</span> <span class="identifier">small_distrib</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">original_distrib</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_missing_values_minmax_imputation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Compare the buit-in missing value handling of Histogram GBC with an</span>
    <span class="comment"># a-priori missing value imputation strategy that should yield the same</span>
    <span class="comment"># results in terms of decision function.</span>
    <span class="comment">#</span>
    <span class="comment"># Each feature (containing NaNs) is replaced by 2 features:</span>
    <span class="comment"># - one where the nans are replaced by min(feature) - 1</span>
    <span class="comment"># - one where the nans are replaced by max(feature) + 1</span>
    <span class="comment"># A split where nans go to the left has an equivalent split in the</span>
    <span class="comment"># first (min) feature, and a split where nans go to the right has an</span>
    <span class="comment"># equivalent split in the second (max) feature.</span>
    <span class="comment">#</span>
    <span class="comment"># Assuming the data is such that there is never a tie to select the best</span>
    <span class="comment"># feature to split on during training, the learned decision trees should be</span>
    <span class="comment"># strictly equivalent (learn a sequence of splits that encode the same</span>
    <span class="comment"># decision function).</span>
    <span class="comment">#</span>
    <span class="comment"># The MinMaxImputer transformer is meant to be a toy implementation of the</span>
    <span class="comment"># "Missing In Attributes" (MIA) missing value handling for decision trees</span>
    <span class="comment"># https://www.sciencedirect.com/science/article/abs/pii/S0167865508000305</span>
    <span class="comment"># The implementation of MIA as an imputation transformer was suggested by</span>
    <span class="comment"># "Remark 3" in https://arxiv.org/abs/1902.06931</span>

    <span class="keyword">class</span> <span class="identifier">MinMaxImputer</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">mm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MinMaxScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_min_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mm</span><span class="punctuation">.</span><span class="identifier">data_min_</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_max_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mm</span><span class="punctuation">.</span><span class="identifier">data_max_</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

        <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_min</span><span class="punctuation">,</span> <span class="identifier">X_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">nan_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">X_min</span><span class="grouping">[</span><span class="identifier">nan_mask</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_min_</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
                <span class="identifier">X_max</span><span class="grouping">[</span><span class="identifier">nan_mask</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_max_</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X_min</span><span class="punctuation">,</span> <span class="identifier">X_max</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">make_missing_value_data</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

        <span class="comment"># Pre-bin the data to ensure a deterministic handling by the 2</span>
        <span class="comment"># strategies and also make it easier to insert np.nan in a structured</span>
        <span class="comment"># way:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KBinsDiscretizer</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">encode</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ordinal"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="comment"># First feature has missing values completely at random:</span>
        <span class="identifier">rnd_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.9</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">rnd_mask</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

        <span class="comment"># Second and third features have missing values for extreme values</span>
        <span class="comment"># (censoring missingness):</span>
        <span class="identifier">low_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">low_mask</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

        <span class="identifier">high_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">high_mask</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

        <span class="comment"># Make the last feature nan pattern very informative:</span>
        <span class="identifier">y_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="int-literal">70</span><span class="grouping">)</span>
        <span class="identifier">y_max_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="relational-operator">&gt;=</span> <span class="identifier">y_max</span>
        <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">y_max_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_max</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">y_max_mask</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

        <span class="comment"># Check that there is at least one missing value in each feature:</span>
        <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">any</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Let's use a test set to check that the learned decision function is</span>
        <span class="comment"># the same as evaluated on unseen data. Otherwise it could just be the</span>
        <span class="comment"># case that we find two independent ways to overfit the training set.</span>
        <span class="keyword">return</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="comment"># n_samples need to be large enough to minimize the likelihood of having</span>
    <span class="comment"># several candidate splits with the same gain value in a given tree.</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_missing_value_data</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Use a small number of leaf nodes and iterations so as to keep</span>
    <span class="comment"># under-fitting models to minimize the likelihood of ties when training the</span>
    <span class="comment"># model.</span>
    <span class="identifier">gbm1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                                         <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">gbm1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">gbm2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">MinMaxImputer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">gbm1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gbm2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="comment"># Check that the model reach the same score:</span>
    <span class="keyword">assert</span> <span class="identifier">gbm1</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="invalid">\</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">gbm2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">gbm1</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="invalid">\</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">gbm2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check the individual prediction match as a finer grained</span>
    <span class="comment"># decision function check.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gbm1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">gbm2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gbm1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">gbm2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_infinite_values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Basic test for infinite values</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_consistent_lengths</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.3</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">r</span><span class="string-literal">"sample_weight.shape == \(3,\), expected"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Found input variables with inconsistent number"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gbdt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_infinite_values_missing_values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># High level test making sure that inf and nan values are properly handled</span>
    <span class="comment"># when both are present. This is similar to</span>
    <span class="comment"># test_split_on_nan_with_infinite_values() in test_grower.py, though we</span>
    <span class="comment"># cannot check the predictions for binned values here.</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y_isnan</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_isinf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>

    <span class="identifier">stump_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                               <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">stump_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_isinf</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_isinf</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">stump_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_isnan</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_isnan</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_crossentropy_binary_problem</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># categorical_crossentropy should only be used if there are more than two</span>
    <span class="comment"># classes present. PR #14869</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">gbrt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'categorical_crossentropy'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"'categorical_crossentropy' is not suitable for"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gbrt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"scoring"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'loss'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_string_target_early_stopping</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression tests for #14709 where the targets need to be encoded before</span>
    <span class="comment"># to compute the score</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'x'] * 50 + ['y'</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>
    <span class="identifier">gbrt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="identifier">gbrt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_zero_sample_weights_regression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure setting a SW to zero amounts to ignoring the corresponding</span>
    <span class="comment"># sample</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="comment"># ignore the first 2 training samples by setting their weight to 0</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span>


<span class="keyword">def</span> <span class="identifier">test_zero_sample_weights_classification</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure setting a SW to zero amounts to ignoring the corresponding</span>
    <span class="comment"># sample</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="comment"># ignore the first 2 training samples by setting their weight to 0</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'binary_crossentropy'</span><span class="punctuation">,</span>
                                        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="comment"># ignore the first 2 training samples by setting their weight to 0</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'categorical_crossentropy'</span><span class="punctuation">,</span>
                                        <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'problem'</span><span class="punctuation">,</span> <span class="grouping">(</span>
    <span class="string-literal">'regression'</span><span class="punctuation">,</span>
    <span class="string-literal">'binary_classification'</span><span class="punctuation">,</span>
    <span class="string-literal">'multiclass_classification'</span>
<span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'duplication', ('half', 'all'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sample_weight_effect</span><span class="grouping">(</span><span class="identifier">problem</span><span class="punctuation">,</span> <span class="identifier">duplication</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># High level test to make sure that duplicating a sample is equivalent to</span>
    <span class="comment"># giving it weight of 2.</span>

    <span class="comment"># fails for n_samples &gt; 255 because binning does not take sample weights</span>
    <span class="comment"># into account. Keeping n_samples &lt;= 255 makes</span>
    <span class="comment"># sure only unique values are used so SW have no effect on binning.</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">255</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="keyword">if</span> <span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'regression'</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                               <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">Klass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="keyword">if</span> <span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'binary_classification'</span> <span class="keyword">else</span> <span class="int-literal">3</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                   <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                   <span class="identifier">n_clusters_per_class</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                   <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">Klass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span>

    <span class="comment"># This test can't pass if min_samples_leaf &gt; 1 because that would force 2</span>
    <span class="comment"># samples to be in the same node in est_sw, while these samples would be</span>
    <span class="comment"># free to be separate in est_dup: est_dup would just group together the</span>
    <span class="comment"># duplicated samples.</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Klass</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Create dataset with duplicate and corresponding sample weights</span>
    <span class="keyword">if</span> <span class="identifier">duplication</span> <span class="relational-operator">==</span> <span class="string-literal">'half'</span><span class="punctuation">:</span>
        <span class="identifier">lim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">lim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span>
    <span class="identifier">X_dup</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">lim</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_dup</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">lim</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">lim</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="identifier">est_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">est_dup</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_dup</span><span class="punctuation">,</span> <span class="identifier">y_dup</span><span class="grouping">)</span>

    <span class="comment"># checking raw_predict is stricter than just predict for classification</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">est_sw</span><span class="punctuation">.</span><span class="identifier">_raw_predict</span><span class="grouping">(</span><span class="identifier">X_dup</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">est_dup</span><span class="punctuation">.</span><span class="identifier">_raw_predict</span><span class="grouping">(</span><span class="identifier">X_dup</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'loss_name', ('squared_error', 'absolute_error'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sum_hessians_are_sample_weight</span><span class="grouping">(</span><span class="identifier">loss_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For losses with constant hessians, the sum_hessians field of the</span>
    <span class="comment"># histograms must be equal to the sum of the sample weight of samples at</span>
    <span class="comment"># the corresponding bin.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_LOSSES</span><span class="grouping">[</span><span class="identifier">loss_name</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">hessians</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">init_gradients_and_hessians</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">prediction_dim</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">raw_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">update_gradients_and_hessians</span><span class="grouping">(</span><span class="identifier">gradients</span><span class="punctuation">,</span> <span class="identifier">hessians</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                       <span class="identifier">raw_predictions</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>

    <span class="comment"># build sum_sample_weight which contains the sum of the sample weights at</span>
    <span class="comment"># each bin (for each feature). This must be equal to the sum_hessians</span>
    <span class="comment"># field of the corresponding histogram</span>
    <span class="identifier">sum_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">sample_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">sum_sw</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="punctuation">,</span> <span class="identifier">X_binned</span><span class="grouping">[</span><span class="identifier">sample_idx</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span>
                <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">sample_idx</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Build histogram</span>
    <span class="identifier">grower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeGrower</span><span class="grouping">(</span><span class="identifier">X_binned</span><span class="punctuation">,</span> <span class="identifier">gradients</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">hessians</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">n_bins</span><span class="grouping">)</span>
    <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">histogram_builder</span><span class="punctuation">.</span><span class="identifier">compute_histograms_brute</span><span class="grouping">(</span>
        <span class="identifier">grower</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">sample_indices</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">bin_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">histograms</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="punctuation">,</span> <span class="identifier">bin_idx</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'sum_hessians'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span>
                <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">sum_sw</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="punctuation">,</span> <span class="identifier">bin_idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rel</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_max_depth_max_leaf_nodes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non regression test for</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/16179</span>
    <span class="comment"># there was a bug when the max_depth and the max_leaf_nodes criteria were</span>
    <span class="comment"># met at the same time, which would lead to max_leaf_nodes not being</span>
    <span class="comment"># respected.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                         <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">_predictors</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">get_max_depth</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">get_n_leaf_nodes</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>  <span class="comment"># would be 4 prior to bug fix</span>


<span class="keyword">def</span> <span class="identifier">test_early_stopping_on_test_set_with_warm_start</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non regression test for #16661 where second fit fails with</span>
    <span class="comment"># warm_start=True, early_stopping is on, and no validation set</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span>
        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'loss'</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># does not raise on second call</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
                                 <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_single_node_trees</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure it's still possible to build single-node trees. In that case</span>
    <span class="comment"># the value of the root is set to 0. That's a correct value: if the tree is</span>
    <span class="comment"># single-node that's because min_gain_to_split is not respected right from</span>
    <span class="comment"># the root, so we don't want the tree to have any impact on the</span>
    <span class="comment"># predictions.</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>  <span class="comment"># constant target will lead to a single root node</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">predictor</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span> <span class="keyword">for</span> <span class="identifier">predictor</span> <span class="relational-operator">in</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">_predictors</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">predictor</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">nodes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'value'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
               <span class="keyword">for</span> <span class="identifier">predictor</span> <span class="relational-operator">in</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">_predictors</span><span class="grouping">)</span>
    <span class="comment"># Still gives correct predictions thanks to the baseline prediction</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est, loss, X, y'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span>
        <span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
        <span class="identifier">BinaryCrossEntropy</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">X_classification</span><span class="punctuation">,</span>
        <span class="identifier">y_classification</span>
    <span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span>
        <span class="identifier">HistGradientBoostingRegressor</span><span class="punctuation">,</span>
        <span class="identifier">LeastSquares</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">X_regression</span><span class="punctuation">,</span>
        <span class="identifier">y_regression</span>
    <span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_custom_loss</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'HistGradientBoosting, X, y'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span> <span class="identifier">X_classification</span><span class="punctuation">,</span> <span class="identifier">y_classification</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="punctuation">,</span> <span class="identifier">X_regression</span><span class="punctuation">,</span> <span class="identifier">y_regression</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
        <span class="identifier">X_multi_classification</span><span class="punctuation">,</span> <span class="identifier">y_multi_classification</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_staged_predict</span><span class="grouping">(</span><span class="identifier">HistGradientBoosting</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="comment"># Test whether staged predictor eventually gives</span>
    <span class="comment"># the same prediction.</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
        <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoosting</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>

    <span class="comment"># test raise NotFittedError if not fitted</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">staged_predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="comment"># test if the staged predictions of each iteration</span>
    <span class="comment"># are equal to the corresponding predictions of the same estimator</span>
    <span class="comment"># trained from scratch.</span>
    <span class="comment"># this also test limit case when max_iter = 1</span>
    <span class="identifier">method_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="grouping">[</span><span class="string-literal">'predict'</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">is_regressor</span><span class="grouping">(</span><span class="identifier">gb</span><span class="grouping">)</span>
        <span class="keyword">else</span> <span class="grouping">[</span><span class="string-literal">'predict', 'predict_proba', 'decision_function'</span><span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method_name</span> <span class="relational-operator">in</span> <span class="identifier">method_names</span><span class="punctuation">:</span>

        <span class="identifier">staged_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">gb</span><span class="punctuation">,</span> <span class="string-literal">'staged_'</span> <span class="arithmetic-operator">+</span> <span class="identifier">method_name</span><span class="grouping">)</span>
        <span class="identifier">staged_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">staged_method</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">staged_predictions</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>
        <span class="keyword">for</span> <span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">staged_predictions</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">staged_method</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">aux</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoosting</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="grouping">)</span>
            <span class="identifier">aux</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
            <span class="identifier">pred_aux</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">aux</span><span class="punctuation">,</span> <span class="identifier">method_name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">staged_predictions</span><span class="punctuation">,</span> <span class="identifier">pred_aux</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">staged_predictions</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">pred_aux</span><span class="punctuation">.</span><span class="identifier">shape</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"insert_missing"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Est"</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HistGradientBoostingRegressor</span><span class="punctuation">,</span>
                                 <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"bool_categorical_parameter"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_unknown_categories_nan</span><span class="grouping">(</span><span class="identifier">insert_missing</span><span class="punctuation">,</span> <span class="identifier">Est</span><span class="punctuation">,</span>
                                <span class="identifier">bool_categorical_parameter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure no error is raised at predict if a category wasn't seen during</span>
    <span class="comment"># fit. We also make sure they're treated as nans.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">f1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">f2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">f1</span><span class="punctuation">,</span> <span class="identifier">f2</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">%</span> <span class="int-literal">2</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="keyword">if</span> <span class="identifier">bool_categorical_parameter</span><span class="punctuation">:</span>
        <span class="identifier">categorical_features</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">categorical_features</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">insert_missing</span><span class="punctuation">:</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="identifier">categorical_features</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">is_categorical_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Make sure no error is raised on unknown categories and nans</span>
    <span class="comment"># unknown categories will be treated as nans</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="grouping">)</span>
    <span class="identifier">X_test</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
    <span class="identifier">X_test</span><span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_categorical_encoding_strategies</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check native categorical handling vs different encoding strategies. We</span>
    <span class="comment"># make sure that native encoding needs only 1 split to achieve a perfect</span>
    <span class="comment"># prediction on a simple dataset. In contrast, OneHotEncoded data needs</span>
    <span class="comment"># more depth / splits, and treating categories as ordered (just using</span>
    <span class="comment"># OrdinalEncoder) requires even more depth.</span>

    <span class="comment"># dataset with one random continuous feature, and one categorical feature</span>
    <span class="comment"># with values in [0, 5], e.g. from an OrdinalEncoder.</span>
    <span class="comment"># class == 1 iff categorical value in {0, 2, 4}</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="invalid">_</span><span class="int-literal">000</span>
    <span class="identifier">f1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">f2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">f1</span><span class="punctuation">,</span> <span class="identifier">f2</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">%</span> <span class="int-literal">2</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="comment"># make sure dataset is balanced so that the baseline_prediction doesn't</span>
    <span class="comment"># influence predictions too much with max_iter = 1</span>
    <span class="keyword">assert</span> <span class="float-literal">0.49</span> <span class="relational-operator">&lt;</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.51</span>

    <span class="identifier">clf_cat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span>
        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Using native categorical encoding, we get perfect predictions with just</span>
    <span class="comment"># one split</span>
    <span class="keyword">assert</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">clf_cat</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="comment"># quick sanity check for the bitset: 0, 2, 4 = 2**0 + 2**2 + 2**4 = 21</span>
    <span class="identifier">expected_left_bitset</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">21</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">left_bitset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_cat</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">_predictors</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">raw_left_cat_bitsets</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">left_bitset</span><span class="punctuation">,</span> <span class="identifier">expected_left_bitset</span><span class="grouping">)</span>

    <span class="comment"># Treating categories as ordered, we need more depth / more splits to get</span>
    <span class="comment"># the same predictions</span>
    <span class="identifier">clf_no_cat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                                                <span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">clf_no_cat</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.9</span>

    <span class="identifier">clf_no_cat</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">clf_no_cat</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="comment"># Using OHEd data, we need less splits than with pure OEd data, but we</span>
    <span class="comment"># still need more splits than with the native categorical splits</span>
    <span class="identifier">ct</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_column_transformer</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">OneHotEncoder</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">remainder</span><span class="arithmetic-assignment">=</span><span class="string-literal">'passthrough'</span><span class="grouping">)</span>
    <span class="identifier">X_ohe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ct</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clf_no_cat</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">clf_no_cat</span><span class="punctuation">,</span> <span class="identifier">X_ohe</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.9</span>

    <span class="identifier">clf_no_cat</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">clf_no_cat</span><span class="punctuation">,</span> <span class="identifier">X_ohe</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
                                 <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"categorical_features, monotonic_cst, expected_msg"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"hello", "world"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">"categorical_features must be an array-like of bools or array-like of "</span>
      <span class="string-literal">"ints."</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"categorical_features set as integer indices must be in "</span>
      <span class="identifier">r</span><span class="string-literal">"\[0, n_features - 1\]"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">"categorical_features set as a boolean mask must have shape "</span>
     <span class="identifier">r</span><span class="string-literal">"\(n_features,\)"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
     <span class="string-literal">"Categorical features cannot have monotonic constraints"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_categorical_spec_errors</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">categorical_features</span><span class="punctuation">,</span> <span class="identifier">monotonic_cst</span><span class="punctuation">,</span>
                                 <span class="identifier">expected_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test errors when categories are specified incorrectly</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                               <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="identifier">categorical_features</span><span class="punctuation">,</span>
              <span class="identifier">monotonic_cst</span><span class="arithmetic-assignment">=</span><span class="identifier">monotonic_cst</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
                                 <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'categorical_features'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'as_array'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_categorical_spec_no_categories</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">categorical_features</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure we can properly detect that no categorical features are present</span>
    <span class="comment"># even if the categorical_features parameter is not None</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">:</span>
        <span class="identifier">categorical_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">categorical_features</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="identifier">categorical_features</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">is_categorical_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
                                 <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_categorical_bad_encoding_errors</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test errors when categories are encoded incorrectly</span>

    <span class="identifier">gb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">categorical_features</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Categorical feature at index 0 is expected to have a "</span>
           <span class="string-literal">"cardinality &lt;= 2"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Categorical feature at index 0 is expected to be encoded with "</span>
           <span class="string-literal">"values &lt; 2"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># nans are ignored in the counts</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">gb</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">HistGradientBoostingClassifier</span><span class="punctuation">,</span>
                                 <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_uint8_predict</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non regression test for</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18408</span>
    <span class="comment"># Make sure X can be of dtype uint8 (i.e. X_BINNED_DTYPE) in predict. It</span>
    <span class="comment"># will be converted to X_DTYPE.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove in v1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"old_loss, new_loss"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">"least_squares", "squared_error"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"least_absolute_deviation", "absolute_error"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_loss_deprecated</span><span class="grouping">(</span><span class="identifier">old_loss</span><span class="punctuation">,</span> <span class="identifier">new_loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">old_loss</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"The loss '{old_loss}' was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingRegressor</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">new_loss</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>