<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
===================
Quantile regression
===================

This example illustrates how quantile regression can predict non-trivial
conditional quantiles.

The left figure shows the case when the error distribution is normal,
but has non-constant variance, i.e. with heteroscedasticity.

The right figure shows an example of an asymmetric error distribution,
namely the Pareto distribution.
"""</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="comment"># Authors: David Dale &lt;dale.david@mail.ru&gt;</span>
<span class="comment">#          Christian Lorentzen &lt;lorentzen.ch@gmail.com&gt;</span>
<span class="comment">#          Guillaume Lemaitre &lt;glemaitre58@gmail.com&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="comment"># %%</span>
<span class="comment"># Dataset generation</span>
<span class="comment"># ------------------</span>
<span class="comment">#</span>
<span class="comment"># To illustrate the behaviour of quantile regression, we will generate two</span>
<span class="comment"># synthetic datasets. The true generative random processess for both datasets</span>
<span class="comment"># will be composed by the same expected value with a linear relationship with a</span>
<span class="comment"># single feature `x`.</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
<span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">start</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">stop</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
<span class="identifier">y_true_mean</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span>

<span class="comment"># %%</span>
<span class="comment"># We will create two subsequent problems by changing the distribution of the</span>
<span class="comment"># target `y` while keeping the same expected value:</span>
<span class="comment">#</span>
<span class="comment"># - in the first case, a heteroscedastic Normal noise is added;</span>
<span class="comment"># - in the second case, an asymmetric Pareto noise is added.</span>
<span class="identifier">y_normal</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_true_mean</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span>
    <span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
<span class="identifier">y_pareto</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_true_mean</span> <span class="arithmetic-operator">+</span> <span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">pareto</span><span class="grouping">(</span><span class="identifier">a</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">a</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Let's first visualize the datasets as well as the distribution of the</span>
<span class="comment"># residuals `y - mean(y)`.</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">axs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span>
    <span class="identifier">nrows</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">ncols</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sharex</span><span class="arithmetic-assignment">=</span><span class="string-literal">"row", sharey="row"</span>
<span class="grouping">)</span>

<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y_true_mean</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"True mean"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y_normal</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black", alpha=0.5, label="Observations"</span>
<span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">y_true_mean</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_normal</span><span class="punctuation">,</span> <span class="identifier">edgecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black"</span><span class="grouping">)</span>


<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y_true_mean</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"True mean"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y_pareto</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black", alpha=0.5, label="Observations"</span>
<span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">y_true_mean</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pareto</span><span class="punctuation">,</span> <span class="identifier">edgecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black"</span><span class="grouping">)</span>

<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">"Dataset with heteroscedastic Normal distributed targets"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">"Dataset with asymmetric Pareto distributed target"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span>
    <span class="string-literal">"Residuals distribution for heteroscedastic Normal distributed targets"</span>
<span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span>
    <span class="string-literal">"Residuals distribution for asymmetric Pareto distributed target"</span>
<span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">"y"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">"Counts"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">"x"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">"x"</span><span class="grouping">)</span>
<span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">"Residuals"</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">"Residuals"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># With the heteroscedastic Normal distributed target, we observe that the</span>
<span class="comment"># variance of the noise is increasing when the value of the feature `x` is</span>
<span class="comment"># increasing.</span>
<span class="comment">#</span>
<span class="comment"># With the asymmetric Pareto distributed target, we observe that the positive</span>
<span class="comment"># residuals are bounded.</span>
<span class="comment">#</span>
<span class="comment"># These types of noisy targets make the estimation via</span>
<span class="comment"># :class:`~sklearn.linear_model.LinearRegression` less efficient, i.e. we need</span>
<span class="comment"># more data to get stable results and, in addition, large outliers can have a</span>
<span class="comment"># huge impact on the fitted coefficients. (Stated otherwise: in a setting with</span>
<span class="comment"># constant variance, ordinary least squares estimators converge much faster to</span>
<span class="comment"># the *true* coefficients with increasing sample size.)</span>
<span class="comment">#</span>
<span class="comment"># In this asymmetric setting, the median or different quantiles give additional</span>
<span class="comment"># insights. On top of that, median estimation is much more robust to outliers</span>
<span class="comment"># and heavy tailed distributions. But note that extreme quantiles are estimated</span>
<span class="comment"># by very view data points. 95% quantile are more or less estimated by the 5%</span>
<span class="comment"># largest values and thus also a bit sensitive outliers.</span>
<span class="comment">#</span>
<span class="comment"># In the remainder of this tutorial, we will show how</span>
<span class="comment"># :class:`~sklearn.linear_model.QuantileRegressor` can be used in practice and</span>
<span class="comment"># give the intuition into the properties of the fitted models. Finally,</span>
<span class="comment"># we will compare the both :class:`~sklearn.linear_model.QuantileRegressor`</span>
<span class="comment"># and :class:`~sklearn.linear_model.LinearRegression`.</span>
<span class="comment">#</span>
<span class="comment"># Fitting a `QuantileRegressor`</span>
<span class="comment"># -----------------------------</span>
<span class="comment">#</span>
<span class="comment"># In this section, we want to estimate the conditional median as well as</span>
<span class="comment"># a low and high quantile fixed at 5% and 95%, respectively. Thus, we will get</span>
<span class="comment"># three linear models, one for each quantile.</span>
<span class="comment">#</span>
<span class="comment"># We will use the quantiles at 5% and 95% to find the outliers in the training</span>
<span class="comment"># sample beyond the central 90% interval.</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">QuantileRegressor</span>

<span class="identifier">quantiles</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">]</span>
<span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
<span class="identifier">out_bounds_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">y_true_mean</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bool_</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">quantile</span> <span class="relational-operator">in</span> <span class="identifier">quantiles</span><span class="punctuation">:</span>
    <span class="identifier">qr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuantileRegressor</span><span class="grouping">(</span><span class="identifier">quantile</span><span class="arithmetic-assignment">=</span><span class="identifier">quantile</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">qr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_normal</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">predictions</span><span class="grouping">[</span><span class="identifier">quantile</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred</span>

    <span class="keyword">if</span> <span class="identifier">quantile</span> <span class="relational-operator">==</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">quantiles</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out_bounds_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span>
            <span class="identifier">out_bounds_predictions</span><span class="punctuation">,</span> <span class="identifier">y_pred</span> <span class="relational-operator">&gt;=</span> <span class="identifier">y_normal</span>
        <span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">quantile</span> <span class="relational-operator">==</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">quantiles</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out_bounds_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span>
            <span class="identifier">out_bounds_predictions</span><span class="punctuation">,</span> <span class="identifier">y_pred</span> <span class="relational-operator">&lt;=</span> <span class="identifier">y_normal</span>
        <span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Now, we can plot the three linear models and the distinguished samples that</span>
<span class="comment"># are within the central 90% interval from samples that are outside this</span>
<span class="comment"># interval.</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_true_mean</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black", linestyle="dashed", label="True mean"</span><span class="grouping">)</span>

<span class="keyword">for</span> <span class="identifier">quantile</span><span class="punctuation">,</span> <span class="identifier">y_pred</span> <span class="relational-operator">in</span> <span class="identifier">predictions</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"Quantile: {quantile}"</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="grouping">[</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">y_normal</span><span class="grouping">[</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black"</span><span class="punctuation">,</span>
    <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">"+"</span><span class="punctuation">,</span>
    <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
    <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Outside interval"</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">y_normal</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black"</span><span class="punctuation">,</span>
    <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
    <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Inside interval"</span><span class="punctuation">,</span>
<span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"x"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"y"</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Quantiles of heteroscedastic Normal distributed target"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Since the noise is still Normally distributed, in particular is symmetric,</span>
<span class="comment"># the true conditional mean and the true conditional median coincide. Indeed,</span>
<span class="comment"># we see that the estimated median almost hits the true mean. We observe the</span>
<span class="comment"># effect of having an increasing noise variance on the 5% and 95% quantiles:</span>
<span class="comment"># the slopes of those quantiles are very different and the interval between</span>
<span class="comment"># them becomes wider with increasing `x`.</span>
<span class="comment">#</span>
<span class="comment"># To get an additional intuition regarding the meaning of the 5% and 95%</span>
<span class="comment"># quantiles estimators, one can count the number of samples above and below the</span>
<span class="comment"># predicted quantiles (represented by a cross on the above plot), considering</span>
<span class="comment"># that we have a total of 100 samples.</span>
<span class="comment">#</span>
<span class="comment"># We can repeat the same experiment using the asymmetric Pareto distributed</span>
<span class="comment"># target.</span>
<span class="identifier">quantiles</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">]</span>
<span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
<span class="identifier">out_bounds_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">y_true_mean</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bool_</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">quantile</span> <span class="relational-operator">in</span> <span class="identifier">quantiles</span><span class="punctuation">:</span>
    <span class="identifier">qr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuantileRegressor</span><span class="grouping">(</span><span class="identifier">quantile</span><span class="arithmetic-assignment">=</span><span class="identifier">quantile</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">qr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_pareto</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">predictions</span><span class="grouping">[</span><span class="identifier">quantile</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred</span>

    <span class="keyword">if</span> <span class="identifier">quantile</span> <span class="relational-operator">==</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">quantiles</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out_bounds_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span>
            <span class="identifier">out_bounds_predictions</span><span class="punctuation">,</span> <span class="identifier">y_pred</span> <span class="relational-operator">&gt;=</span> <span class="identifier">y_pareto</span>
        <span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">quantile</span> <span class="relational-operator">==</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">quantiles</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out_bounds_predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span>
            <span class="identifier">out_bounds_predictions</span><span class="punctuation">,</span> <span class="identifier">y_pred</span> <span class="relational-operator">&lt;=</span> <span class="identifier">y_pareto</span>
        <span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_true_mean</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black", linestyle="dashed", label="True mean"</span><span class="grouping">)</span>

<span class="keyword">for</span> <span class="identifier">quantile</span><span class="punctuation">,</span> <span class="identifier">y_pred</span> <span class="relational-operator">in</span> <span class="identifier">predictions</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"Quantile: {quantile}"</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="grouping">[</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">y_pareto</span><span class="grouping">[</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black"</span><span class="punctuation">,</span>
    <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">"+"</span><span class="punctuation">,</span>
    <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
    <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Outside interval"</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">y_pareto</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">out_bounds_predictions</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black"</span><span class="punctuation">,</span>
    <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
    <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Inside interval"</span><span class="punctuation">,</span>
<span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"x"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"y"</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Quantiles of asymmetric Pareto distributed target"</span><span class="grouping">)</span>


<span class="comment"># %%</span>
<span class="comment"># Due to the asymmetry of the distribution of the noise, we observe that the</span>
<span class="comment"># true mean and estimated conditional median are different. We also observe</span>
<span class="comment"># that each quantile model has different parameters to better fit the desired</span>
<span class="comment"># quantile. Note that ideally, all quantiles would be parallel in this case,</span>
<span class="comment"># which would become more visible with more data points or less extreme</span>
<span class="comment"># quantiles, e.g. 10% and 90%.</span>
<span class="comment">#</span>
<span class="comment"># Comparing `QuantileRegressor` and `LinearRegression`</span>
<span class="comment"># ----------------------------------------------------</span>
<span class="comment">#</span>
<span class="comment"># In this section, we will linger on the difference regarding the error that</span>
<span class="comment"># :class:`~sklearn.linear_model.QuantileRegressor` and</span>
<span class="comment"># :class:`~sklearn.linear_model.LinearRegression` are minimizing.</span>
<span class="comment">#</span>
<span class="comment"># Indeed, :class:`~sklearn.linear_model.LinearRegression` is a least squares</span>
<span class="comment"># approach minimizing the mean squared error (MSE) between the training and</span>
<span class="comment"># predicted targets. In contrast,</span>
<span class="comment"># :class:`~sklearn.linear_model.QuantileRegressor` with `quantile=0.5`</span>
<span class="comment"># minimizes the mean absolute error (MAE) instead.</span>
<span class="comment">#</span>
<span class="comment"># Let's first compute the training errors of such models in terms of mean</span>
<span class="comment"># squared error and mean absolute error. We will use the asymmetric Pareto</span>
<span class="comment"># distributed target to make it more interesting as mean and median are not</span>
<span class="comment"># equal.</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_absolute_error</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_squared_error</span>

<span class="identifier">linear_regression</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">quantile_regression</span> <span class="arithmetic-assignment">=</span> <span class="identifier">QuantileRegressor</span><span class="grouping">(</span><span class="identifier">quantile</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="identifier">y_pred_lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linear_regression</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_pareto</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
<span class="identifier">y_pred_qr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">quantile_regression</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_pareto</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

<span class="identifier">print</span><span class="grouping">(</span>
    <span class="identifier">f</span><span class="comment">"""Training error (in-sample performance)
    {linear_regression.__class__.__name__}:
    MAE = {mean_absolute_error(y_pareto, y_pred_lr):.3f}
    MSE = {mean_squared_error(y_pareto, y_pred_lr):.3f}
    {quantile_regression.__class__.__name__}:
    MAE = {mean_absolute_error(y_pareto, y_pred_qr):.3f}
    MSE = {mean_squared_error(y_pareto, y_pred_qr):.3f}
    """</span>
<span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># On the training set, we see that MAE is lower for</span>
<span class="comment"># :class:`~sklearn.linear_model.QuantileRegressor` than</span>
<span class="comment"># :class:`~sklearn.linear_model.LinearRegression`. In contrast to that, MSE is</span>
<span class="comment"># lower for :class:`~sklearn.linear_model.LinearRegression` than</span>
<span class="comment"># :class:`~sklearn.linear_model.QuantileRegressor`. These results confirms that</span>
<span class="comment"># MAE is the loss minimized by :class:`~sklearn.linear_model.QuantileRegressor`</span>
<span class="comment"># while MSE is the loss minimized</span>
<span class="comment"># :class:`~sklearn.linear_model.LinearRegression`.</span>
<span class="comment">#</span>
<span class="comment"># We can make a similar evaluation but looking a the test error obtained by</span>
<span class="comment"># cross-validation.</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">cross_validate</span>

<span class="identifier">cv_results_lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_validate</span><span class="grouping">(</span>
    <span class="identifier">linear_regression</span><span class="punctuation">,</span>
    <span class="identifier">X</span><span class="punctuation">,</span>
    <span class="identifier">y_pareto</span><span class="punctuation">,</span>
    <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
    <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"neg_mean_absolute_error", "neg_mean_squared_error"</span><span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="identifier">cv_results_qr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_validate</span><span class="grouping">(</span>
    <span class="identifier">quantile_regression</span><span class="punctuation">,</span>
    <span class="identifier">X</span><span class="punctuation">,</span>
    <span class="identifier">y_pareto</span><span class="punctuation">,</span>
    <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
    <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"neg_mean_absolute_error", "neg_mean_squared_error"</span><span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span>
    <span class="identifier">f</span><span class="comment">"""Test error (cross-validated performance)
    {linear_regression.__class__.__name__}:
    MAE = {-cv_results_lr["test_neg_mean_absolute_error"].mean():.3f}
    MSE = {-cv_results_lr["test_neg_mean_squared_error"].mean():.3f}
    {quantile_regression.__class__.__name__}:
    MAE = {-cv_results_qr["test_neg_mean_absolute_error"].mean():.3f}
    MSE = {-cv_results_qr["test_neg_mean_squared_error"].mean():.3f}
    """</span>
<span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We reach similar conclusions on the out-of-sample evaluation.</span>

    </pre>
  </body>
</html>