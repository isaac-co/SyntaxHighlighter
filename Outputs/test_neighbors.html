<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">bsr_matrix</span><span class="punctuation">,</span> <span class="identifier">coo_matrix</span><span class="punctuation">,</span> <span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="punctuation">,</span>
                          <span class="identifier">dok_matrix</span><span class="punctuation">,</span> <span class="identifier">lil_matrix</span><span class="punctuation">,</span> <span class="identifier">issparse</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">metrics</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">neighbors</span><span class="punctuation">,</span> <span class="identifier">datasets</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">DataConversionWarning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">EfficiencyWarning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">VALID_METRICS_SPARSE</span><span class="punctuation">,</span> <span class="identifier">VALID_METRICS</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">_is_sorted_by_data</span><span class="punctuation">,</span> <span class="identifier">_check_precomputed</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">sp_version</span><span class="punctuation">,</span> <span class="identifier">parse_version</span>

<span class="keyword">import</span> <span class="identifier">joblib</span>

<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="comment"># load and shuffle iris dataset</span>
<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="comment"># load and shuffle digits</span>
<span class="identifier">digits</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_digits</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="identifier">SPARSE_TYPES</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bsr_matrix</span><span class="punctuation">,</span> <span class="identifier">coo_matrix</span><span class="punctuation">,</span> <span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">dok_matrix</span><span class="punctuation">,</span>
                <span class="identifier">lil_matrix</span><span class="grouping">)</span>
<span class="identifier">SPARSE_OR_DENSE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SPARSE_TYPES</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">,</span><span class="grouping">)</span>

<span class="identifier">ALGORITHMS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'ball_tree', 'brute', 'kd_tree', 'auto'</span><span class="grouping">)</span>
<span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
<span class="identifier">JOBLIB_BACKENDS</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">parallel</span><span class="punctuation">.</span><span class="identifier">BACKENDS</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># Filter deprecation warnings.</span>
<span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">)</span>
<span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span>
    <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_weight_func</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Weight function to replace lambda d: d ** -2.
    The lambda function is not valid because:
    if d==0 then 0^-2 is not valid. """</span>

    <span class="comment"># Dist could be multidimensional, flatten it so all values</span>
    <span class="comment"># can be looped</span>
    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">divide</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ignore'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">dist</span>
    <span class="keyword">return</span> <span class="identifier">retval</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>


<span class="keyword">def</span> <span class="identifier">test_unsupervised_kneighbors</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                 <span class="identifier">n_query_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test unsupervised neighbors methods</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_query_pts</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">P</span><span class="punctuation">:</span>
        <span class="identifier">results_nodist</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

        <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
            <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                               <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                                               <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="identifier">p</span><span class="grouping">)</span>
            <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

            <span class="identifier">results_nodist</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">test</span><span class="punctuation">,</span>
                                                   <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results_nodist</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"NearestNeighbors"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span>
                                              <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="punctuation">,</span>
                                              <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_unsupervised_inputs</span><span class="grouping">(</span><span class="identifier">NearestNeighbors</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test unsupervised inputs for neighbors estimators</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">nbrs_fid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">nbrs_fid</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">dist1</span><span class="punctuation">,</span> <span class="identifier">ind1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs_fid</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">data</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">nbrs_fid</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">BallTree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KDTree</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">dist2</span><span class="punctuation">,</span> <span class="identifier">ind2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist1</span><span class="punctuation">,</span> <span class="identifier">dist2</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind1</span><span class="punctuation">,</span> <span class="identifier">ind2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_n_neighbors_datatype</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test to check whether n_neighbors is integer</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">expected_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"n_neighbors does not take .*float.* "</span> <span class="invalid">\</span>
                   <span class="string-literal">"value, enter integer value"</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Expected n_neighbors &gt; 0. Got -3"</span>

    <span class="identifier">neighbors_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors_</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors_</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors_</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_not_fitted_error_gets_raised</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">neighbors_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors_</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors_</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">EfficiencyWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_precomputed</span><span class="grouping">(</span><span class="identifier">make_train_test</span><span class="punctuation">,</span> <span class="identifier">estimators</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Tests unsupervised NearestNeighbors with a distance matrix."""</span>
    <span class="comment"># Note: smaller samples may result in spurious test success</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">DXX</span><span class="punctuation">,</span> <span class="identifier">DYX</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_train_test</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'kneighbors'</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># TODO: also test radius_neighbors, but requires different assertion</span>

        <span class="comment"># As a feature matrix (n_samples by n_features)</span>
        <span class="identifier">nbrs_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">nbrs_X</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">ind_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">nbrs_X</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

        <span class="comment"># As a dense distance matrix (n_samples by n_samples)</span>
        <span class="identifier">nbrs_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="punctuation">,</span>
                                            <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
        <span class="identifier">nbrs_D</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DXX</span><span class="grouping">)</span>
        <span class="identifier">dist_D</span><span class="punctuation">,</span> <span class="identifier">ind_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">nbrs_D</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">DYX</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">dist_D</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind_X</span><span class="punctuation">,</span> <span class="identifier">ind_D</span><span class="grouping">)</span>

        <span class="comment"># Check auto works too</span>
        <span class="identifier">nbrs_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                            <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
        <span class="identifier">nbrs_D</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DXX</span><span class="grouping">)</span>
        <span class="identifier">dist_D</span><span class="punctuation">,</span> <span class="identifier">ind_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">nbrs_D</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">DYX</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">dist_D</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind_X</span><span class="punctuation">,</span> <span class="identifier">ind_D</span><span class="grouping">)</span>

        <span class="comment"># Check X=None in prediction</span>
        <span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">ind_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">nbrs_X</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">dist_D</span><span class="punctuation">,</span> <span class="identifier">ind_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">nbrs_D</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">dist_D</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind_X</span><span class="punctuation">,</span> <span class="identifier">ind_D</span><span class="grouping">)</span>

        <span class="comment"># Must raise a ValueError if the matrix is not of correct shape</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">nbrs_D</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">Est</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">n_neighbors</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">pred_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'precomputed'</span>
        <span class="identifier">pred_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DXX</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">DYX</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred_X</span><span class="punctuation">,</span> <span class="identifier">pred_D</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_precomputed_dense</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">make_train_test</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="punctuation">,</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span>
    <span class="grouping">]</span>
    <span class="identifier">check_precomputed</span><span class="grouping">(</span><span class="identifier">make_train_test</span><span class="punctuation">,</span> <span class="identifier">estimators</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'fmt', ['csr', 'lil'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_precomputed_sparse_knn</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">make_train_test</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># We do not test RadiusNeighborsClassifier and RadiusNeighborsRegressor</span>
    <span class="comment"># since the precomputed neighbors graph is built with k neighbors only.</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
    <span class="identifier">check_precomputed</span><span class="grouping">(</span><span class="identifier">make_train_test</span><span class="punctuation">,</span> <span class="identifier">estimators</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'fmt', ['csr', 'lil'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_precomputed_sparse_radius</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">make_train_test</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span>
                                          <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span>
                                          <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fmt</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># We do not test KNeighborsClassifier and KNeighborsRegressor</span>
    <span class="comment"># since the precomputed neighbors graph is built with a radius.</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="punctuation">,</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
    <span class="identifier">check_precomputed</span><span class="grouping">(</span><span class="identifier">make_train_test</span><span class="punctuation">,</span> <span class="identifier">estimators</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_is_sorted_by_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that _is_sorted_by_data works as expected. In CSR sparse matrix,</span>
    <span class="comment"># entries in each row can be sorted by indices, by data, or unsorted.</span>
    <span class="comment"># _is_sorted_by_data should return True when entries are sorted by data,</span>
    <span class="comment"># and False in all other cases.</span>

    <span class="comment"># Test with sorted 1D array</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># Test with unsorted 1D array</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test when the data is sorted in each sample, but not necessarily</span>
    <span class="comment"># between samples</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test with duplicates entries in X.indptr</span>
    <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">EfficiencyWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_check_precomputed</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that _check_precomputed returns a graph sorted by data</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_precomputed</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>

    <span class="comment"># est with a different number of nonzero entries for each sample</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_precomputed</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">EfficiencyWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_precomputed_sparse_invalid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">dist_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">)</span>
    <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="grouping">)</span>
    <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">dist_csr</span><span class="grouping">)</span>
    <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># Ensures enough number of nearest neighbors</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">dist_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">)</span>
    <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">dist_csr</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"2 neighbors per samples are required, but some samples have only 1"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Checks error with inconsistent distance matrix</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">dist_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Negative values in data passed to precomputed distance matrix."</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">dist_csr</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_precomputed_cross_validation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure array is split correctly</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">Est</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">metric_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">precomp_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">metric_score</span><span class="punctuation">,</span> <span class="identifier">precomp_score</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_unsupervised_radius_neighbors</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                       <span class="identifier">n_query_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                       <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test unsupervised radius-based query</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_query_pts</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">P</span><span class="punctuation">:</span>
        <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

        <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
            <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                               <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                                               <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="identifier">p</span><span class="grouping">)</span>
            <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

            <span class="identifier">ind1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

            <span class="comment"># sort the results: this is not done automatically for</span>
            <span class="comment"># radius searches</span>
            <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">i1</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span><span class="punctuation">,</span> <span class="identifier">ind1</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">j</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">d</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span>
                <span class="identifier">i</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span>
                <span class="identifier">i1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i1</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span>
            <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">ind</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">ind1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_classifier</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                               <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                               <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-neighbors classification</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">y_str</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                                 <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                 <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="comment"># Test prediction with y_str</span>
            <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_str</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_str</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_classifier_float_labels</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                            <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-neighbors classification</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="grouping">)</span>
    <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_classifier_predict_proba</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test KNeighborsClassifier.predict_proba() method</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">cls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># cityblock dist</span>
    <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">real_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">real_prob</span><span class="punctuation">,</span> <span class="identifier">y_prob</span><span class="grouping">)</span>
    <span class="comment"># Check that it also works with non integer labels</span>
    <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">real_prob</span><span class="punctuation">,</span> <span class="identifier">y_prob</span><span class="grouping">)</span>
    <span class="comment"># Check that it works with weights='distance'</span>
    <span class="identifier">cls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span>
        <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
    <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">real_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.6</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">real_prob</span><span class="punctuation">,</span> <span class="identifier">y_prob</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_classifier</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                                     <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                     <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                     <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based classification</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">y_str</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                                        <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                        <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_str</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_str</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_classifier_when_no_neighbors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based classifier when no neighbors found.</span>
    <span class="comment"># In this case it should rise an informative exception</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>

    <span class="identifier">z1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.01</span><span class="punctuation">,</span> <span class="float-literal">2.01</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># no outliers</span>
    <span class="identifier">z2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>    <span class="comment"># one outlier</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">outlier_label</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="identifier">rnc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span>
                <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnc</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                          <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="identifier">outlier_label</span><span class="grouping">)</span>
                <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z1</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">outlier_label</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_classifier_outlier_labeling</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based classifier when no neighbors found and outliers</span>
    <span class="comment"># are labeled.</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.99</span><span class="punctuation">,</span> <span class="float-literal">0.99</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">0.98</span><span class="punctuation">,</span> <span class="float-literal">0.98</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.01</span><span class="punctuation">,</span> <span class="float-literal">2.01</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>

    <span class="identifier">z1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.01</span><span class="punctuation">,</span> <span class="float-literal">2.01</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># no outliers</span>
    <span class="identifier">z2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">1.4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.01</span><span class="punctuation">,</span> <span class="float-literal">2.01</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>    <span class="comment"># one outlier</span>
    <span class="identifier">correct_labels1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">correct_labels2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">outlier_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                                      <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                      <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                                                      <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">correct_labels1</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z1</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">correct_labels2</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z2</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">outlier_proba</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">z2</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test outlier_labeling of using predict_proba()</span>
    <span class="identifier">RNC</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test outlier_label scalar verification</span>
    <span class="keyword">def</span> <span class="identifier">check_array_exception</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_array_exception</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># test invalid outlier_label dtype</span>
    <span class="keyword">def</span> <span class="identifier">check_dtype_exception</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">'a'</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_dtype_exception</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># test most frequent</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="string-literal">'most_frequent'</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test manual label in y</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test manual label out of y warning</span>
    <span class="keyword">def</span> <span class="identifier">check_warning</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_warning</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># test multi output same outlier label</span>
    <span class="identifier">y_multi</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_multi</span><span class="grouping">)</span>
    <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test multi output different outlier label</span>
    <span class="identifier">y_multi</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_multi</span><span class="grouping">)</span>
    <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test inconsistent outlier label list length</span>
    <span class="keyword">def</span> <span class="identifier">check_exception</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNC</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_multi</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_exception</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_classifier_zero_distance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based classifier, when distance to a sample is zero.</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>

    <span class="identifier">z1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">correct_labels1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                                      <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                      <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">invalid</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ignore"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># Ignore the warning raised in _weight_func when making</span>
                <span class="comment"># predictions with null distances resulting in np.inf values.</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">correct_labels1</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z1</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_neighbors_regressors_zero_distance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based regressor, when distance to a sample is zero.</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.5</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.2</span>
    <span class="identifier">z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.1</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">rnn_correct_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.25</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">knn_correct_unif</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.25</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">knn_correct_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.25</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="comment"># we don't test for weights=_weight_func since user will be expected</span>
        <span class="comment"># to handle zero distances themselves in the function.</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">rnn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                                     <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                     <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rnn_correct_labels</span><span class="punctuation">,</span> <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">corr_labels</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                        <span class="grouping">[</span><span class="identifier">knn_correct_unif</span><span class="punctuation">,</span> <span class="identifier">knn_correct_dist</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                                <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">corr_labels</span><span class="punctuation">,</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">z</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_boundary_handling</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test whether points lying on boundary are handled consistently

    Also ensures that even with only one query point, an object array
    is returned rather than a 2d array.
    """</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.01</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">3.0</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                          <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">object</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_returns_array_of_objects</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that we can pass precomputed distances to</span>
    <span class="comment"># NearestNeighbors.radius_neighbors()</span>
    <span class="comment"># non-regression test for</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/16036</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">setdiag</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                      <span class="identifier">leaf_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span>
                                      <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">neigh_dist</span><span class="punctuation">,</span> <span class="identifier">neigh_ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">expected_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>
    <span class="identifier">expected_dist</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">expected_ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>
    <span class="identifier">expected_ind</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">neigh_dist</span><span class="punctuation">,</span> <span class="identifier">expected_dist</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">neigh_ind</span><span class="punctuation">,</span> <span class="identifier">expected_ind</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"algorithm", "metric"], [("ball_tree", "euclidean"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="grouping">(</span><span class="string-literal">"kd_tree", "euclidean"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="grouping">(</span><span class="string-literal">"brute", "euclidean"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="grouping">(</span><span class="string-literal">"brute", "precomputed"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_sort_results</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius_neighbors[_graph] output when sort_result is True</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"precomputed"</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">"distance"</span><span class="grouping">)</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># self.radius_neighbors</span>
    <span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span>
                                                <span class="identifier">sort_results</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">ii</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">distances</span><span class="grouping">[</span><span class="identifier">ii</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">distances</span><span class="grouping">[</span><span class="identifier">ii</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># sort_results=True and return_distance=False</span>
    <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">!=</span> <span class="string-literal">"precomputed"</span><span class="punctuation">:</span>  <span class="comment"># no need to raise with precomputed graph</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"return_distance must be True"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">sort_results</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                   <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># self.radius_neighbors_graph</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">"distance"</span><span class="punctuation">,</span>
                                         <span class="identifier">sort_results</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_is_sorted_by_data</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_RadiusNeighborsClassifier_multioutput</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-NN classifier on multioutput data</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40</span>
    <span class="identifier">n_output</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_output</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">_weight_func</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALGORITHMS</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Stack single output prediction</span>
        <span class="identifier">y_pred_so</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">o</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_output</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">rnn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                      <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">o</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">y_pred_so</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">y_pred_so</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">y_pred_so</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="keyword">assert</span> <span class="identifier">y_pred_so</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="comment"># Multioutput prediction</span>
        <span class="identifier">rnn_mo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                     <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">rnn_mo</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="identifier">y_pred_mo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnn_mo</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">y_pred_mo</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_mo</span><span class="punctuation">,</span> <span class="identifier">y_pred_so</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_classifier_sparse</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                                      <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                      <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                      <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-NN classifier on sparse matrices</span>
    <span class="comment"># Like the above, but with various types of sparse matrices</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">X</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.2</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">sparsemat</span> <span class="relational-operator">in</span> <span class="identifier">SPARSE_TYPES</span><span class="punctuation">:</span>
        <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                             <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
        <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">sparsemat</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">sparsev</span> <span class="relational-operator">in</span> <span class="identifier">SPARSE_TYPES</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_eps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparsev</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_eps</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_KNeighborsClassifier_multioutput</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-NN classifier on multioutput data</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>
    <span class="identifier">n_output</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_output</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">_weight_func</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALGORITHMS</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Stack single output prediction</span>
        <span class="identifier">y_pred_so</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">y_pred_proba_so</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">o</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_output</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                 <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">o</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">y_pred_so</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">y_pred_proba_so</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">y_pred_so</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">y_pred_so</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="keyword">assert</span> <span class="identifier">y_pred_so</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y_pred_proba_so</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_output</span>

        <span class="comment"># Multioutput prediction</span>
        <span class="identifier">knn_mo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">knn_mo</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="identifier">y_pred_mo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn_mo</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">y_pred_mo</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_mo</span><span class="punctuation">,</span> <span class="identifier">y_pred_so</span><span class="grouping">)</span>

        <span class="comment"># Check proba</span>
        <span class="identifier">y_pred_proba_mo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn_mo</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y_pred_proba_mo</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_output</span>

        <span class="keyword">for</span> <span class="identifier">proba_mo</span><span class="punctuation">,</span> <span class="identifier">proba_so</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">y_pred_proba_mo</span><span class="punctuation">,</span> <span class="identifier">y_pred_proba_so</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">proba_mo</span><span class="punctuation">,</span> <span class="identifier">proba_so</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_regressor</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                              <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                              <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                              <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-neighbors regression</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">y_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                                <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1E-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_target</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_KNeighborsRegressor_multioutput_uniform_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-neighbors in multi-output regression with uniform weight</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40</span>
    <span class="identifier">n_output</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_output</span><span class="grouping">)</span>

    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALGORITHMS</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'uniform'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                            <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

        <span class="identifier">neigh_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">y_pred_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
                               <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">neigh_idx</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="keyword">assert</span> <span class="identifier">y_pred_idx</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_idx</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_regressor_multioutput</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                                          <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                          <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                          <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-neighbors in multi-output regression</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="identifier">y_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span>

    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">_weight_func</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALGORITHMS</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                            <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                            <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1E-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_target</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_target</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_regressor</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                                    <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                    <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                    <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based neighbors regression</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">y_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span>

    <span class="identifier">weight_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_weight_func</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">weight_func</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                                       <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                       <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
            <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1E-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_target</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">radius</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># test that nan is returned when no nearby observations</span>
    <span class="keyword">for</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span>
                                                   <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                   <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
        <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">X_test_nan</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>
        <span class="identifier">empty_warning_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"One or more samples have no neighbors "</span>
                             <span class="string-literal">"within specified radius; predicting NaN."</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span><span class="identifier">empty_warning_msg</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test_nan</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">pred</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_RadiusNeighborsRegressor_multioutput_with_uniform_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius neighbors in multi-output regression (uniform weight)</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">40</span>
    <span class="identifier">n_output</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_output</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALGORITHMS</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'uniform'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">rnn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span> <span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                  <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

        <span class="identifier">neigh_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">y_pred_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
                               <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">neigh_idx</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">y_pred_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y_pred_idx</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">y_pred_idx</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_idx</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_RadiusNeighborsRegressor_multioutput</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                                              <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                              <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test k-neighbors in multi-output regression with various weight</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="identifier">y_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span>
    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'uniform', 'distance'</span><span class="punctuation">,</span> <span class="identifier">_weight_func</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALGORITHMS</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">rnn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span>
                                                 <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1E-5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_test_pts</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">epsilon</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_target</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_target</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">EfficiencyWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kneighbors_regressor_sparse</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">40</span><span class="punctuation">,</span>
                                     <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                     <span class="identifier">n_test_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                     <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius-based regression on sparse matrices</span>
    <span class="comment"># Like the above, but with various types of sparse matrices</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.25</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">sparsemat</span> <span class="relational-operator">in</span> <span class="identifier">SPARSE_TYPES</span><span class="punctuation">:</span>
        <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                            <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span>
        <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">sparsemat</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">knn_pre</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                                <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
        <span class="identifier">knn_pre</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">sparsev</span> <span class="relational-operator">in</span> <span class="identifier">SPARSE_OR_DENSE</span><span class="punctuation">:</span>
            <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparsev</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.95</span>

            <span class="identifier">X2_pre</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparsev</span><span class="grouping">(</span><span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">knn_pre</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2_pre</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.95</span>


<span class="keyword">def</span> <span class="identifier">test_neighbors_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sanity checks on the iris dataset</span>
    <span class="comment"># Puts three points of each label in the plane and performs a</span>
    <span class="comment"># nearest neighbor query on points near the decision boundary.</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                             <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>

        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.95</span>

        <span class="identifier">rgs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">rgs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">rgs</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.95</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_neighbors_digits</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sanity check on the digits dataset</span>
    <span class="comment"># the 'brute' algorithm has been observed to fail if the input</span>
    <span class="comment"># dtype is uint8 due to overflow in distance calculations.</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'uint8'</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">train_test_boundary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.8</span><span class="grouping">)</span>
    <span class="identifier">train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">train_test_boundary</span><span class="grouping">)</span>
    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">train_test_boundary</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">Y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">Y_test</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="grouping">)</span>
    <span class="identifier">score_uint8</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">Y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">Y_test</span><span class="grouping">)</span>
    <span class="identifier">score_float</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span>
        <span class="identifier">X_test</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score_uint8</span> <span class="relational-operator">==</span> <span class="identifier">score_float</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test kneighbors_graph to build the k-Nearest Neighbor graph.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># n_neighbors = 1</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="punctuation">,</span>
                                   <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.00</span><span class="punctuation">,</span> <span class="float-literal">1.40716026</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># n_neighbors = 2</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="punctuation">,</span>
                                   <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">2.23606798</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.40716026</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">2.23606798</span><span class="punctuation">,</span> <span class="float-literal">1.40716026</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># n_neighbors = 3</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="punctuation">,</span>
                                   <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kneighbors_graph_sparse</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test kneighbors_graph to build the k-Nearest Neighbor graph</span>
    <span class="comment"># for sparse input.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">Xcsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_neighbors</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">mode</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"connectivity", "distance"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span>
                                           <span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                           <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">Xcsr</span><span class="punctuation">,</span>
                                           <span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                           <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius_neighbors_graph to build the Nearest Neighbor graph.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="punctuation">,</span>
                                         <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.40716026</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.40716026</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_graph_sparse</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">36</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test radius_neighbors_graph to build the Nearest Neighbor graph</span>
    <span class="comment"># for sparse input.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">Xcsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_neighbors</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">mode</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"connectivity", "distance"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span>
                                                 <span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                                 <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">Xcsr</span><span class="punctuation">,</span>
                                                 <span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                                 <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_neighbors_badargs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test bad argument values: these should all raise ValueErrors</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xsparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blah'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">cls</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="punctuation">,</span>
                <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blah'</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blah'</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ball_tree', metric='haversine'</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">Xsparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'haversine', algorithm='brute'</span><span class="grouping">)</span>
        <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Haversine distance only valid in 2 dimensions"</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X3</span><span class="grouping">)</span>

        <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">)</span> <span class="logical-operator">or</span>
                <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blah'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nbrs</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blah'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_neighbors_metrics</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                           <span class="identifier">n_query_pts</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test computing the neighbors for various metrics</span>
    <span class="comment"># create a symmetric matrix</span>
    <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">VI</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">V</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">metrics</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'euclidean'</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'manhattan'</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'minkowski'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'minkowski'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'minkowski'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'minkowski'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'chebyshev'</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'seuclidean'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">V</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'wminkowski'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'mahalanobis'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">VI</span><span class="arithmetic-assignment">=</span><span class="identifier">VI</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'haversine'</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">algorithms</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'brute', 'ball_tree', 'kd_tree'</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_query_pts</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">metric_params</span> <span class="relational-operator">in</span> <span class="identifier">metrics</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"wminkowski" and sp_version &gt;= parse_version("1.8.0"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># wminkowski will be removed in SciPy 1.8.0</span>
            <span class="keyword">continue</span>
        <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metric_params</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="string-literal">'p'</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">algorithms</span><span class="punctuation">:</span>
            <span class="comment"># KD tree doesn't support all metrics</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'kd_tree'</span> <span class="logical-operator">and</span>
                    <span class="identifier">metric</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KDTree</span><span class="punctuation">.</span><span class="identifier">valid_metrics</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                                                 <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span>
                                                 <span class="identifier">metric_params</span><span class="arithmetic-assignment">=</span><span class="identifier">metric_params</span><span class="grouping">)</span>
                <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">neigh</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                               <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                                               <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="identifier">p</span><span class="punctuation">,</span>
                                               <span class="identifier">metric_params</span><span class="arithmetic-assignment">=</span><span class="identifier">metric_params</span><span class="grouping">)</span>

            <span class="comment"># Haversine distance only accepts 2D data</span>
            <span class="identifier">feature_sl</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
                          <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">'haversine'</span> <span class="keyword">else</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_sl</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="comment"># wminkoski is deprecated in SciPy 1.6.0 and removed in 1.8.0</span>
            <span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">T</span><span class="invalid">o</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"wminkowski"</span> <span class="logical-operator">and</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'brute'</span>
                    <span class="logical-operator">and</span> <span class="identifier">sp_version</span> <span class="relational-operator">&gt;=</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">"1.6.0"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">T</span><span class="invalid">o</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DeprecationWarning</span>

            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">T</span><span class="invalid">o</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">algorithm</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neigh</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">test</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_sl</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                      <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="string-literal">'brute'][0], results['ball_tree'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="string-literal">'brute'][1], results['ball_tree'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="string-literal">'kd_tree'</span> <span class="relational-operator">in</span> <span class="identifier">results</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="string-literal">'brute'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                      <span class="identifier">results</span><span class="grouping">[</span><span class="string-literal">'kd_tree'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="string-literal">'brute'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                      <span class="identifier">results</span><span class="grouping">[</span><span class="string-literal">'kd_tree'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_callable_metric</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">def</span> <span class="identifier">custom_metric</span><span class="grouping">(</span><span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">x2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">nbrs1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                       <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_metric</span><span class="grouping">)</span>
    <span class="identifier">nbrs2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="punctuation">,</span>
                                       <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">custom_metric</span><span class="grouping">)</span>

    <span class="identifier">nbrs1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">nbrs2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">dist1</span><span class="punctuation">,</span> <span class="identifier">ind1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs1</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">dist2</span><span class="punctuation">,</span> <span class="identifier">ind2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nbrs2</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist1</span><span class="punctuation">,</span> <span class="identifier">dist2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_valid_brute_metric_for_auto_algorithm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">)</span>
    <span class="identifier">Xcsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># check that there is a metric that is valid for brute</span>
    <span class="comment"># but not ball_tree (so we actually test something)</span>
    <span class="keyword">assert</span> <span class="string-literal">"cosine"</span> <span class="relational-operator">in</span> <span class="identifier">VALID_METRICS</span><span class="grouping">[</span><span class="string-literal">'brute'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="string-literal">"cosine"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">VALID_METRICS</span><span class="grouping">[</span><span class="string-literal">'ball_tree'</span><span class="grouping">]</span>

    <span class="comment"># Metric which don't required any additional parameter</span>
    <span class="identifier">require_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'mahalanobis', 'wminkowski', 'seuclidean'</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="identifier">VALID_METRICS</span><span class="grouping">[</span><span class="string-literal">'brute'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">!=</span> <span class="string-literal">'precomputed'</span> <span class="logical-operator">and</span> <span class="identifier">metric</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">require_params</span><span class="punctuation">:</span>
            <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                            <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                            <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">!=</span> <span class="string-literal">'haversine'</span><span class="punctuation">:</span>
                <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">'precomputed'</span><span class="punctuation">:</span>
            <span class="identifier">X_precomputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">Y_precomputed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">DXX</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_precomputed</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
            <span class="identifier">DYX</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">Y_precomputed</span><span class="punctuation">,</span> <span class="identifier">X_precomputed</span><span class="punctuation">,</span>
                                             <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
            <span class="identifier">nb_p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
            <span class="identifier">nb_p</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DXX</span><span class="grouping">)</span>
            <span class="identifier">nb_p</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">DYX</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="identifier">VALID_METRICS_SPARSE</span><span class="grouping">[</span><span class="string-literal">'brute'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">!=</span> <span class="string-literal">'precomputed'</span> <span class="logical-operator">and</span> <span class="identifier">metric</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">require_params</span><span class="punctuation">:</span>
            <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                            <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">Xcsr</span><span class="grouping">)</span>
            <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">Xcsr</span><span class="grouping">)</span>

    <span class="comment"># Metric with parameter</span>
    <span class="identifier">VI</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">list_metrics</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'seuclidean'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">V</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">12</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'wminkowski'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">w</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">12</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">'mahalanobis'</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">VI</span><span class="arithmetic-assignment">=</span><span class="identifier">VI</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">params</span> <span class="relational-operator">in</span> <span class="identifier">list_metrics</span><span class="punctuation">:</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                        <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span>
                                        <span class="identifier">metric_params</span><span class="arithmetic-assignment">=</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_metric_params_interface</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">metric_params</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'p'</span><span class="punctuation">:</span> <span class="int-literal">3</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">SyntaxWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_predict_sparse_ball_kd_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">nbrs1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'kd_tree'</span><span class="grouping">)</span>
    <span class="identifier">nbrs2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ball_tree'</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">model</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">nbrs1</span><span class="punctuation">,</span> <span class="identifier">nbrs2</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_non_euclidean_kneighbors</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="comment"># Find a reasonable radius.</span>
    <span class="identifier">dist_array</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">dist_array</span><span class="grouping">)</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dist_array</span><span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span>

    <span class="comment"># Test kneighbors_graph</span>
    <span class="keyword">for</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'manhattan', 'chebyshev'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">nbrs_graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="punctuation">,</span>
            <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">nbrs1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">nbrs_graph</span><span class="punctuation">,</span> <span class="identifier">nbrs1</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Test radiusneighbors_graph</span>
    <span class="keyword">for</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'manhattan', 'chebyshev'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">nbrs_graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'connectivity'</span><span class="punctuation">,</span>
            <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">nbrs1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">nbrs_graph</span><span class="punctuation">,</span> <span class="identifier">nbrs1</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="comment"># Raise error when wrong parameters are supplied,</span>
    <span class="identifier">X_nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'manhattan'</span><span class="grouping">)</span>
    <span class="identifier">X_nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X_nbrs</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="identifier">X_nbrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'manhattan'</span><span class="grouping">)</span>
    <span class="identifier">X_nbrs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X_nbrs</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">nparray</span><span class="punctuation">,</span> <span class="identifier">list_check</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="identifier">ind</span><span class="punctuation">,</span> <span class="identifier">ele</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">nparray</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ele</span><span class="punctuation">,</span> <span class="identifier">list_check</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_k_and_radius_neighbors_train_is_not_query</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test kneighbors et.al when query is not training data</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>

        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">test_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>

        <span class="comment"># Test neighbors.</span>
        <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Test the graph variants.</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">test_data</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_k_and_radius_neighbors_X_None</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test kneighbors et.al when query is None</span>
    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>

        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Test the graph variants.</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="identifier">kng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">graph</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="identifier">kng</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">graph</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">graph</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">graph</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_k_and_radius_neighbors_duplicates</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test behavior of kneighbors when duplicates are present in query</span>

    <span class="keyword">for</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="identifier">ALGORITHMS</span><span class="punctuation">:</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Do not do anything special to duplicates.</span>
        <span class="identifier">kng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">kng</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kng</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kng</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">check_object_arrays</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="punctuation">,</span>
                                        <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
        <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">sort_indices</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Mask the first duplicates when n_duplicates &gt; n_neighbors.</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="grouping">)</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Test that zeros are explicitly marked in kneighbors_graph.</span>
        <span class="identifier">kng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">kng</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kng</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kng</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_include_self_neighbors_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test include_self parameter in neighbors_graph</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">kng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span>
    <span class="identifier">kng_not_self</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kng</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kng_not_self</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span>
    <span class="identifier">rng_not_self</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="identifier">include_self</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rng_not_self</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'algorithm'</span><span class="punctuation">,</span> <span class="identifier">ALGORITHMS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_same_knn_parallel</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                        <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                         <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">dist_parallel</span><span class="punctuation">,</span> <span class="identifier">ind_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">graph_parallel</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_parallel</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">dist_parallel</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind</span><span class="punctuation">,</span> <span class="identifier">ind_parallel</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">graph</span><span class="punctuation">,</span> <span class="identifier">graph_parallel</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'algorithm'</span><span class="punctuation">,</span> <span class="identifier">ALGORITHMS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_same_radius_neighbors_parallel</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                        <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                              <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">dist_parallel</span><span class="punctuation">,</span> <span class="identifier">ind_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">radius_neighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">graph_parallel</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">radius_neighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_parallel</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dist_parallel</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ind</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ind_parallel</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">graph</span><span class="punctuation">,</span> <span class="identifier">graph_parallel</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'backend'</span><span class="punctuation">,</span> <span class="identifier">JOBLIB_BACKENDS</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'algorithm'</span><span class="punctuation">,</span> <span class="identifier">ALGORITHMS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_knn_forcing_backend</span><span class="grouping">(</span><span class="identifier">backend</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test which ensure the knn methods are properly working</span>
    <span class="comment"># even when forcing the global joblib backend.</span>
    <span class="keyword">with</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">parallel_backend</span><span class="grouping">(</span><span class="identifier">backend</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                            <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                             <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                                             <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dtype_convert</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">E</span><span class="invalid">S</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">15</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">E</span><span class="invalid">S</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">ch</span> <span class="keyword">for</span> <span class="identifier">ch</span> <span class="relational-operator">in</span> <span class="string-literal">'ABCDEFGHIJKLMNOPQRSTU'</span><span class="grouping">[</span><span class="punctuation">:</span><span class="invalid">C</span><span class="invalid">L</span><span class="invalid">A</span><span class="invalid">S</span><span class="invalid">S</span><span class="invalid">E</span><span class="invalid">S</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">result</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sparse_metric_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">sparse_metric</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># Metric accepting sparse matrix input (only)</span>
        <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">item</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">[</span>  <span class="comment"># Population matrix</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">[</span>  <span class="comment"># Query matrix</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                    <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse_metric</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">N</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># GS indices of nearest neighbours in `X` for `sparse_metric`</span>
    <span class="identifier">gold_standard_nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">gold_standard_nn</span><span class="grouping">)</span>


<span class="comment"># ignore conversion to boolean in pairwise_distances</span>
<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">DataConversionWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_boolean_distance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression test for #4523</span>
    <span class="comment"># 'brute': uses scipy.spatial.distance through pairwise_distances</span>
    <span class="comment"># 'ball_tree': uses sklearn.neighbors._dist_metrics</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">NN</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span>

    <span class="identifier">nn1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NN</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"jaccard"</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'brute'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">nn2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NN</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"jaccard"</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ball_tree'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">nn1</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">nn2</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_radius_neighbors_predict_proba</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="identifier">seed</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                            <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                            <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
        <span class="identifier">X_tr</span><span class="punctuation">,</span> <span class="identifier">X_te</span><span class="punctuation">,</span> <span class="identifier">y_tr</span><span class="punctuation">,</span> <span class="identifier">y_te</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">outlier_label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="identifier">seed</span><span class="grouping">)</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsClassifier</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                                  <span class="identifier">outlier_label</span><span class="arithmetic-assignment">=</span><span class="identifier">outlier_label</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_tr</span><span class="punctuation">,</span> <span class="identifier">y_tr</span><span class="grouping">)</span>
        <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_te</span><span class="grouping">)</span>
        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_te</span><span class="grouping">)</span>
        <span class="identifier">proba_label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">proba</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">proba_label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">proba</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">outlier_label</span><span class="punctuation">,</span> <span class="identifier">proba_label</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">proba_label</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_with_nearest_neighbors_transformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test chaining KNeighborsTransformer and classifiers/regressors</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">n_neighbors</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">12</span>
    <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.5</span>
    <span class="comment"># We precompute more neighbors than necessary, to have equivalence between</span>
    <span class="comment"># k-neighbors estimator after radius-neighbors transformer, and vice-versa.</span>
    <span class="identifier">factor</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="identifier">k_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsTransformer</span><span class="grouping">(</span>
        <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
    <span class="identifier">k_trans_factor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsTransformer</span><span class="grouping">(</span>
        <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_neighbors</span> <span class="arithmetic-operator">*</span> <span class="identifier">factor</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>

    <span class="identifier">r_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsTransformer</span><span class="grouping">(</span>
        <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
    <span class="identifier">r_trans_factor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsTransformer</span><span class="grouping">(</span>
        <span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">radius</span> <span class="arithmetic-operator">*</span> <span class="identifier">factor</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>

    <span class="identifier">k_reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="grouping">)</span>
    <span class="identifier">r_reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">RadiusNeighborsRegressor</span><span class="grouping">(</span><span class="identifier">radius</span><span class="arithmetic-assignment">=</span><span class="identifier">radius</span><span class="grouping">)</span>

    <span class="identifier">test_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">k_trans</span><span class="punctuation">,</span> <span class="identifier">k_reg</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">k_trans_factor</span><span class="punctuation">,</span> <span class="identifier">r_reg</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="grouping">(</span><span class="identifier">r_trans</span><span class="punctuation">,</span> <span class="identifier">r_reg</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">r_trans_factor</span><span class="punctuation">,</span> <span class="identifier">k_reg</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">trans</span><span class="punctuation">,</span> <span class="identifier">reg</span> <span class="relational-operator">in</span> <span class="identifier">test_list</span><span class="punctuation">:</span>
        <span class="comment"># compare the chained version and the compact version</span>
        <span class="identifier">reg_compact</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">reg</span><span class="grouping">)</span>
        <span class="identifier">reg_precomp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">reg</span><span class="grouping">)</span>
        <span class="identifier">reg_precomp</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>

        <span class="identifier">reg_chain</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">trans</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reg_precomp</span><span class="grouping">)</span>

        <span class="identifier">y_pred_chain</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg_chain</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>
        <span class="identifier">y_pred_compact</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg_compact</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred_chain</span><span class="punctuation">,</span> <span class="identifier">y_pred_compact</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'X, metric, metric_params, expected_algo'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'precomputed', None, 'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'euclidean', None, 'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'euclidean', None, 'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'euclidean', None, 'kd_tree'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'seuclidean', {'V': [2]*5}, 'ball_tree'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'correlation', None, 'brute'</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_auto_algorithm</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">metric_params</span><span class="punctuation">,</span> <span class="identifier">expected_algo</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">(</span>
        <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
        <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
        <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span>
        <span class="identifier">metric_params</span><span class="arithmetic-assignment">=</span><span class="identifier">metric_params</span>
    <span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">_fit_method</span> <span class="relational-operator">==</span> <span class="identifier">expected_algo</span>


<span class="comment"># TODO: Remove in 1.1</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"NearestNeighbors"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span>
                                              <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">KNeighborsRegressor</span><span class="punctuation">,</span>
                                              <span class="identifier">neighbors</span><span class="punctuation">.</span><span class="identifier">NearestNeighbors</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_deprecated</span><span class="grouping">(</span><span class="identifier">NearestNeighbors</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"Attribute _pairwise was deprecated in version 0\.24"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nn</span><span class="punctuation">.</span><span class="identifier">_pairwise</span>

    </pre>
  </body>
</html>