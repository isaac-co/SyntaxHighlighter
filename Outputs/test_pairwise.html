<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">types</span> <span class="keyword">import</span> <span class="identifier">GeneratorType</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>

<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">dok_matrix</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">issparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">spatial</span><span class="punctuation">.</span><span class="identifier">distance</span> <span class="keyword">import</span> <span class="identifier">cosine</span><span class="punctuation">,</span> <span class="identifier">cityblock</span><span class="punctuation">,</span> <span class="identifier">minkowski</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">spatial</span><span class="punctuation">.</span><span class="identifier">distance</span> <span class="keyword">import</span> <span class="identifier">cdist</span><span class="punctuation">,</span> <span class="identifier">pdist</span><span class="punctuation">,</span> <span class="identifier">squareform</span>
<span class="keyword">try</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">spatial</span><span class="punctuation">.</span><span class="identifier">distance</span> <span class="keyword">import</span> <span class="identifier">wminkowski</span>
<span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
    <span class="comment"># In scipy 1.6.0, wminkowski is deprecated and minkowski</span>
    <span class="comment"># should be used instead.</span>
    <span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">spatial</span><span class="punctuation">.</span><span class="identifier">distance</span> <span class="keyword">import</span> <span class="identifier">minkowski</span> <span class="keyword">as</span> <span class="identifier">wminkowski</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">sp_version</span><span class="punctuation">,</span> <span class="identifier">parse_version</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">config_context</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">euclidean_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">nan_euclidean_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">manhattan_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">haversine_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">linear_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">chi2_kernel</span><span class="punctuation">,</span> <span class="identifier">additive_chi2_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">polynomial_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">rbf_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">laplacian_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">sigmoid_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">cosine_similarity</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">cosine_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances_chunked</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances_argmin_min</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances_argmin</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_kernels</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">PAIRWISE_KERNEL_FUNCTIONS</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">PAIRWISE_DISTANCE_FUNCTIONS</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">PAIRWISE_BOOLEAN_FUNCTIONS</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">PAIRED_DISTANCES</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">check_pairwise_arrays</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">check_paired_arrays</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">paired_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">paired_euclidean_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">paired_manhattan_distances</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">_euclidean_distances_upcast</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">normalize</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">DataConversionWarning</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_distances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the pairwise_distance helper function.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Euclidean distance should be equivalent to calling the function.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Euclidean distance, with Y != X.</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>
    <span class="comment"># Check to ensure NaNs work with pairwise_distances.</span>
    <span class="identifier">X_masked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y_masked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_masked</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">Y_masked</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">S_masked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_masked</span><span class="punctuation">,</span> <span class="identifier">Y_masked</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"nan_euclidean"</span><span class="grouping">)</span>
    <span class="identifier">S2_masked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X_masked</span><span class="punctuation">,</span> <span class="identifier">Y_masked</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S_masked</span><span class="punctuation">,</span> <span class="identifier">S2_masked</span><span class="grouping">)</span>
    <span class="comment"># Test with tuples as X and Y</span>
    <span class="identifier">X_tuples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">row</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y_tuples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">row</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">Y</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_tuples</span><span class="punctuation">,</span> <span class="identifier">Y_tuples</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test haversine distance</span>
    <span class="comment"># The data should be valid latitude and longitude</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"haversine"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">haversine_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test haversine distance, with Y != X</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="arithmetic-operator">*</span><span class="int-literal">2</span><span class="arithmetic-operator">*</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="arithmetic-operator">*</span><span class="int-literal">2</span><span class="arithmetic-operator">*</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"haversine"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">haversine_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># "cityblock" uses scikit-learn metric, cityblock (function) is</span>
    <span class="comment"># scipy.spatial.</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cityblock"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">cityblock</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># The manhattan metric should be equivalent to cityblock.</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">cityblock</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test cosine as a string metric versus cosine callable</span>
    <span class="comment"># The string "cosine" uses sklearn.metric,</span>
    <span class="comment"># while the function cosine is scipy.spatial</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cosine"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">cosine</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test with sparse X and Y,</span>
    <span class="comment"># currently only supported for Euclidean, L1 and cosine.</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cosine"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cosine_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">manhattan_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">tobsr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="punctuation">.</span><span class="identifier">tocoo</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">manhattan_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test with scipy.spatial.distance metric, with a kwd</span>
    <span class="identifier">kwds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"p"</span><span class="punctuation">:</span> <span class="float-literal">2.0</span><span class="grouping">}</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">minkowski</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># same with Y = None</span>
    <span class="identifier">kwds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"p"</span><span class="punctuation">:</span> <span class="float-literal">2.0</span><span class="grouping">}</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">minkowski</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test that scipy distance metrics throw an error if sparse matrix given</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y_sparse</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="grouping">)</span>

    <span class="comment"># Test that a value error is raised if the metric is unknown</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"blah"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'metric'</span><span class="punctuation">,</span> <span class="identifier">PAIRWISE_BOOLEAN_FUNCTIONS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_boolean_distance</span><span class="grouping">(</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that we convert to boolean arrays for boolean distances</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>

    <span class="comment"># ignore conversion to boolean in pairwise_distances</span>
    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">DataConversionWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">Z</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Z</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
            <span class="identifier">res</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">res</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">res</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>

    <span class="comment"># non-boolean arrays are converted to boolean for boolean</span>
    <span class="comment"># distance metrics with a data conversion warning</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Data was converted to boolean for metric %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">metric</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">DataConversionWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>

    <span class="comment"># Check that the warning is raised if X is boolean by Y is not boolean:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">DataConversionWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>

    <span class="comment"># Check that no warning is raised if X is already boolean and Y is None:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">records</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">records</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_no_data_conversion_warning</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># No warnings issued if metric is not a boolean distance function</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">records</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">records</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'func'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="identifier">pairwise_kernels</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_precomputed</span><span class="grouping">(</span><span class="identifier">func</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test correct shape</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'.* shape .*'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="comment"># with two args</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'.* shape .*'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="comment"># even if shape[1] agrees (although thus second arg is spurious)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'.* shape .*'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>

    <span class="comment"># Test not copied (if appropriate dtype)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">S</span> <span class="relational-operator">is</span> <span class="identifier">S2</span>
    <span class="comment"># with two args</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"precomputed"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">S</span> <span class="relational-operator">is</span> <span class="identifier">S2</span>

    <span class="comment"># Test always returns float dtype</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'int'), metric='precomputed'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">'f'</span> <span class="relational-operator">==</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span>

    <span class="comment"># Test converts list to array-like</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_precomputed_non_negative</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test non-negative values</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'.* non-negative values.*'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>


<span class="identifier">_minkowski_kwds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'w': np.arange(1, 5).astype('double', copy=False), 'p'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>
<span class="identifier">_wminkowski_kwds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'w': np.arange(1, 5).astype('double', copy=False), 'p'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>


<span class="keyword">def</span> <span class="identifier">callable_rbf_kernel</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Callable version of pairwise.rbf_kernel.</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_2d</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">K</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'func, metric, kwds'</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="string-literal">'euclidean'</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span>
             <span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="identifier">minkowski</span><span class="punctuation">,</span> <span class="identifier">_minkowski_kwds</span><span class="punctuation">,</span>
             <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skipif</span><span class="grouping">(</span>
                 <span class="identifier">sp_version</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">"1.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski does not accept the w "</span>
                        <span class="string-literal">"parameter prior to scipy 1.0."</span>
             <span class="grouping">)</span>
         <span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span>
             <span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="string-literal">'minkowski'</span><span class="punctuation">,</span> <span class="identifier">_minkowski_kwds</span><span class="punctuation">,</span>
             <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skipif</span><span class="grouping">(</span>
                 <span class="identifier">sp_version</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">"1.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski does not accept the w "</span>
                        <span class="string-literal">"parameter prior to scipy 1.0."</span>
             <span class="grouping">)</span>
         <span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span>
             <span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="identifier">wminkowski</span><span class="punctuation">,</span> <span class="identifier">_wminkowski_kwds</span><span class="punctuation">,</span>
             <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skipif</span><span class="grouping">(</span>
                 <span class="identifier">sp_version</span> <span class="relational-operator">&gt;=</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">"1.6.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">"wminkowski is now minkowski "</span>
                        <span class="string-literal">"and it has been already tested."</span>
             <span class="grouping">)</span>
         <span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span>
             <span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="string-literal">'wminkowski'</span><span class="punctuation">,</span> <span class="identifier">_wminkowski_kwds</span><span class="punctuation">,</span>
             <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skipif</span><span class="grouping">(</span>
                 <span class="identifier">sp_version</span> <span class="relational-operator">&gt;=</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">"1.6.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">"wminkowski is now minkowski "</span>
                        <span class="string-literal">"and it has been already tested."</span>
             <span class="grouping">)</span>
         <span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="identifier">pairwise_kernels</span><span class="punctuation">,</span> <span class="string-literal">'polynomial', {'degree'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="grouping">(</span><span class="identifier">pairwise_kernels</span><span class="punctuation">,</span> <span class="identifier">callable_rbf_kernel</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'gamma'</span><span class="punctuation">:</span> <span class="float-literal">.1</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'array_constr'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'dtype'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_parallel</span><span class="grouping">(</span><span class="identifier">func</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">kwds</span><span class="punctuation">,</span> <span class="identifier">array_constr</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">array_constr</span><span class="grouping">(</span><span class="int-literal">5</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">array_constr</span><span class="grouping">(</span><span class="int-literal">5</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">exc</span><span class="punctuation">:</span>
        <span class="comment"># Not all metrics support sparse input</span>
        <span class="comment"># ValueError may be triggered by bad callable</span>
        <span class="keyword">if</span> <span class="identifier">array_constr</span> <span class="relational-operator">is</span> <span class="identifier">csr_matrix</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">type</span><span class="grouping">(</span><span class="identifier">exc</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_callable_nonstrict_metric</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># paired_distances should allow callable metric where metric(x, x) != 0</span>
    <span class="comment"># Knowing that the callable is a strict metric would allow the diagonal to</span>
    <span class="comment"># be left uncalculated and set to 0.</span>
    <span class="keyword">assert</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">:</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>


<span class="comment"># Test with all metrics that should be in PAIRWISE_KERNEL_FUNCTIONS.</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'metric'</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">"rbf", "laplacian", "sigmoid", "polynomial", "linear"</span><span class="punctuation">,</span>
         <span class="string-literal">"chi2", "additive_chi2"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_kernels</span><span class="grouping">(</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the pairwise_kernels helper function.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PAIRWISE_KERNEL_FUNCTIONS</span><span class="grouping">[</span><span class="identifier">metric</span><span class="grouping">]</span>
    <span class="comment"># Test with Y=None</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>
    <span class="comment"># Test with Y=Y</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">function</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>
    <span class="comment"># Test with tuples as X and Y</span>
    <span class="identifier">X_tuples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">row</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y_tuples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">v</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">row</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">Y</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X_tuples</span><span class="punctuation">,</span> <span class="identifier">Y_tuples</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="comment"># Test with sparse X and Y</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"chi2", "additive_chi2"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># these don't support sparse matrices yet</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_sparse</span><span class="punctuation">,</span>
                             <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
        <span class="keyword">return</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_sparse</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_kernels_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the pairwise_kernels helper function</span>
    <span class="comment"># with a callable function, with given keywords.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">metric</span> <span class="arithmetic-assignment">=</span> <span class="identifier">callable_rbf_kernel</span>
    <span class="identifier">kwds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'gamma'</span><span class="punctuation">:</span> <span class="float-literal">0.1</span><span class="grouping">}</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="comment"># callable function, X=Y</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwds</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_kernels_filter_param</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"gamma": 0.1, "blabla": ":)"</span><span class="grouping">}</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"rbf"</span><span class="punctuation">,</span> <span class="identifier">filter_params</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"rbf"</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'metric, func'</span><span class="punctuation">,</span> <span class="identifier">PAIRED_DISTANCES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_paired_distances</span><span class="grouping">(</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">func</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the pairwise_distance helper function.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># Euclidean distance should be equivalent to calling the function.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># Euclidean distance, with Y != X.</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">paired_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>
    <span class="identifier">S3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S3</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="identifier">PAIRWISE_DISTANCE_FUNCTIONS</span><span class="punctuation">:</span>
        <span class="comment"># Check the pairwise_distances implementation</span>
        <span class="comment"># gives the same value</span>
        <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PAIRWISE_DISTANCE_FUNCTIONS</span><span class="grouping">[</span><span class="identifier">metric</span><span class="grouping">]</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">distances</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_paired_distances_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the pairwise_distance helper function</span>
    <span class="comment"># with the callable implementation</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># Euclidean distance should be equivalent to calling the function.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># Euclidean distance, with Y != X.</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">paired_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'manhattan'</span><span class="grouping">)</span>
    <span class="identifier">S2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">paired_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">S2</span><span class="grouping">)</span>

    <span class="comment"># Test that a value error is raised when the lengths of X and Y should not</span>
    <span class="comment"># differ</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">paired_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check pairwise minimum distances computation for any metric</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">Xsp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dok_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Ysp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

    <span class="identifier">expected_idx</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">expected_vals</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">expected_vals_sq</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span>

    <span class="comment"># euclidean metric</span>
    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="identifier">idx2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx2</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">vals</span><span class="punctuation">,</span> <span class="identifier">expected_vals</span><span class="grouping">)</span>
    <span class="comment"># sparse matrix case</span>
    <span class="identifier">idxsp</span><span class="punctuation">,</span> <span class="identifier">valssp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">Xsp</span><span class="punctuation">,</span> <span class="identifier">Ysp</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idxsp</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">valssp</span><span class="punctuation">,</span> <span class="identifier">expected_vals</span><span class="grouping">)</span>
    <span class="comment"># We don't want np.matrix here</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">idxsp</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">valssp</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span>

    <span class="comment"># euclidean metric squared</span>
    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean"</span><span class="punctuation">,</span>
                                              <span class="identifier">metric_kwargs</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">"squared"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">vals</span><span class="punctuation">,</span> <span class="identifier">expected_vals_sq</span><span class="grouping">)</span>

    <span class="comment"># Non-euclidean scikit-learn metric</span>
    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="identifier">idx2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx2</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">vals</span><span class="punctuation">,</span> <span class="identifier">expected_vals</span><span class="grouping">)</span>
    <span class="comment"># sparse matrix case</span>
    <span class="identifier">idxsp</span><span class="punctuation">,</span> <span class="identifier">valssp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">Xsp</span><span class="punctuation">,</span> <span class="identifier">Ysp</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idxsp</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">valssp</span><span class="punctuation">,</span> <span class="identifier">expected_vals</span><span class="grouping">)</span>

    <span class="comment"># Non-euclidean Scipy distance (callable)</span>
    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">minkowski</span><span class="punctuation">,</span>
                                              <span class="identifier">metric_kwargs</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">"p"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">vals</span><span class="punctuation">,</span> <span class="identifier">expected_vals</span><span class="grouping">)</span>

    <span class="comment"># Non-euclidean Scipy distance (string)</span>
    <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">vals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"minkowski"</span><span class="punctuation">,</span>
                                              <span class="identifier">metric_kwargs</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">"p"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">expected_idx</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">vals</span><span class="punctuation">,</span> <span class="identifier">expected_vals</span><span class="grouping">)</span>

    <span class="comment"># Compare with naive implementation</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">97</span><span class="punctuation">,</span> <span class="int-literal">149</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">111</span><span class="punctuation">,</span> <span class="int-literal">149</span><span class="grouping">)</span>

    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="identifier">dist_orig_ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dist</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">dist_orig_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dist</span><span class="grouping">[</span><span class="identifier">dist_orig_ind</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">dist_orig_ind</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">dist_chunked_ind</span><span class="punctuation">,</span> <span class="identifier">dist_chunked_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_argmin_min</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"manhattan"</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist_orig_ind</span><span class="punctuation">,</span> <span class="identifier">dist_chunked_ind</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dist_orig_val</span><span class="punctuation">,</span> <span class="identifier">dist_chunked_val</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_reduce_func</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">dist</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_chunked_reduce</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">400</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># Reduced Euclidean distance</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span>
    <span class="identifier">S_chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">reduce_func</span><span class="arithmetic-assignment">=</span><span class="identifier">_reduce_func</span><span class="punctuation">,</span>
                                          <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="arithmetic-operator">-</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="punctuation">,</span> <span class="identifier">GeneratorType</span><span class="grouping">)</span>
    <span class="identifier">S_chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span>
    <span class="comment"># atol is for diagonal where S is explicitly zeroed on the diagonal</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_chunked_reduce_none</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that the reduce func is allowed to return None</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">S_chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span>
                                          <span class="identifier">reduce_func</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="punctuation">,</span>
                                          <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="arithmetic-operator">-</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="punctuation">,</span> <span class="identifier">GeneratorType</span><span class="grouping">)</span>
    <span class="identifier">S_chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">chunk</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">for</span> <span class="identifier">chunk</span> <span class="relational-operator">in</span> <span class="identifier">S_chunks</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'good_reduce'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">dok_matrix</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_chunked_reduce_valid</span><span class="grouping">(</span><span class="identifier">good_reduce</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">S_chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">reduce_func</span><span class="arithmetic-assignment">=</span><span class="identifier">good_reduce</span><span class="punctuation">,</span>
                                          <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">64</span><span class="grouping">)</span>
    <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'bad_reduce', 'err_type', 'message'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">D</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">'length 11\..* input: 10\.'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">D</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">'length \(10, 11\)\..* input: 10\.'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">D</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">'length \(9, 10\)\..* input: 10\.'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">'returned 7\. Expected sequence\(s\) of length 10\.'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">'returned \(7, 8\)\. Expected sequence\(s\) of length 10\.'</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">D</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">TypeError</span><span class="punctuation">,</span>
     <span class="identifier">r</span><span class="string-literal">', 9\)\. Expected sequence\(s\) of length 10\.'</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_chunked_reduce_invalid</span><span class="grouping">(</span><span class="identifier">bad_reduce</span><span class="punctuation">,</span> <span class="identifier">err_type</span><span class="punctuation">,</span>
                                                   <span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">S_chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">reduce_func</span><span class="arithmetic-assignment">=</span><span class="identifier">bad_reduce</span><span class="punctuation">,</span>
                                          <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">64</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">err_type</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">S_chunks</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">gen</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="identifier">working_memory</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">gen</span><span class="punctuation">,</span> <span class="identifier">GeneratorType</span><span class="grouping">)</span>
    <span class="identifier">blockwise_distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">gen</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="keyword">if</span> <span class="identifier">Y</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">Y</span>
    <span class="identifier">min_block_mib</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">8</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="arithmetic-operator">-</span><span class="int-literal">20</span>

    <span class="keyword">for</span> <span class="identifier">block</span> <span class="relational-operator">in</span> <span class="identifier">blockwise_distances</span><span class="punctuation">:</span>
        <span class="identifier">memory_used</span> <span class="arithmetic-assignment">=</span> <span class="identifier">block</span><span class="punctuation">.</span><span class="identifier">nbytes</span>
        <span class="keyword">assert</span> <span class="identifier">memory_used</span> <span class="relational-operator">&lt;=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">working_memory</span><span class="punctuation">,</span> <span class="identifier">min_block_mib</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">20</span>

    <span class="identifier">blockwise_distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">blockwise_distances</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">blockwise_distances</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'metric'</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'euclidean', 'l2', 'sqeuclidean'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_chunked_diagonal</span><span class="grouping">(</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e10</span><span class="grouping">)</span>
    <span class="identifier">chunks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                             <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">chunks</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">chunks</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'metric'</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'euclidean', 'l2', 'sqeuclidean'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_parallel_pairwise_distances_diagonal</span><span class="grouping">(</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e10</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">distances</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-10</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_chunked</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the pairwise_distance helper function.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># Euclidean distance should be equivalent to calling the function.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="comment"># Test small amounts of memory</span>
    <span class="keyword">for</span> <span class="identifier">power</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="identifier">power</span><span class="punctuation">,</span>
                                         <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="comment"># X as list</span>
    <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="comment"># Euclidean distance, with Y != X.</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="comment"># absurdly large working_memory</span>
    <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">10000</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="comment"># "cityblock" uses scikit-learn metric, cityblock (function) is</span>
    <span class="comment"># scipy.spatial.</span>
    <span class="identifier">check_pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cityblock'</span><span class="grouping">)</span>
    <span class="comment"># Test that a value error is raised if the metric is unknown</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"blah"</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Test precomputed returns all at once</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">gen</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span>
                                     <span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="arithmetic-operator">-</span><span class="int-literal">16</span><span class="punctuation">,</span>
                                     <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">gen</span><span class="punctuation">,</span> <span class="identifier">GeneratorType</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">gen</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="identifier">D</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">StopIteration</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">gen</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"x_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"y_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_known_result</span><span class="grouping">(</span><span class="identifier">x_array_constr</span><span class="punctuation">,</span> <span class="identifier">y_array_constr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check the pairwise Euclidean distances computation on known result</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_array_constr</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_array_constr</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"y_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_with_norms</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">y_array_constr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that we still get the right answers with {X,Y}_norm_squared</span>
    <span class="comment"># and that we get a wrong answer with wrong {X,Y}_norm_squared</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># norms will only be used if their dtype is float64</span>
    <span class="identifier">X_norm_sq</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">Y_norm_sq</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_array_constr</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">D1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">X_norm_sq</span><span class="grouping">)</span>
    <span class="identifier">D3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_norm_sq</span><span class="grouping">)</span>
    <span class="identifier">D4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">X_norm_sq</span><span class="punctuation">,</span>
                             <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_norm_sq</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D2</span><span class="punctuation">,</span> <span class="identifier">D1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D3</span><span class="punctuation">,</span> <span class="identifier">D1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D4</span><span class="punctuation">,</span> <span class="identifier">D1</span><span class="grouping">)</span>

    <span class="comment"># check we get the wrong answer with wrong {X,Y}_norm_squared</span>
    <span class="identifier">wrong_D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>
                                  <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">X_norm_sq</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">Y_norm_sq</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">wrong_D</span><span class="punctuation">,</span> <span class="identifier">D1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_norm_shapes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check all accepted shapes for the norms or appropriate error messages.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X_norm_squared</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">Y_norm_squared</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">Y</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">D1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>
                             <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">X_norm_squared</span><span class="punctuation">,</span>
                             <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_norm_squared</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>
                             <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">X_norm_squared</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_norm_squared</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">D3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>
                             <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">X_norm_squared</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_norm_squared</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D2</span><span class="punctuation">,</span> <span class="identifier">D1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D3</span><span class="punctuation">,</span> <span class="identifier">D1</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Incompatible dimensions for X"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">X_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">X_norm_squared</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Incompatible dimensions for Y"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y_norm_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_norm_squared</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"x_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"y_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">x_array_constr</span><span class="punctuation">,</span> <span class="identifier">y_array_constr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that euclidean distances gives same result as scipy cdist</span>
    <span class="comment"># when X and Y != X are provided</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">Y</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_array_constr</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_array_constr</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="comment"># the default rtol=1e-7 is too close to the float32 precision</span>
    <span class="comment"># and fails due to rounding errors.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"x_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_sym</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">x_array_constr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that euclidean distances gives same result as scipy pdist</span>
    <span class="comment"># when only X is provided</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squareform</span><span class="grouping">(</span><span class="identifier">pdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_array_constr</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># the default rtol=1e-7 is too close to the float32 precision</span>
    <span class="comment"># and fails due to rounding errors.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"batch_size"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">101</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"x_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"y_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_upcast</span><span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">x_array_constr</span><span class="punctuation">,</span>
                                    <span class="identifier">y_array_constr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check batches handling when Y != X (#13910)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">Y</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_array_constr</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_array_constr</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_euclidean_distances_upcast</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="identifier">batch_size</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># the default rtol=1e-7 is too close to the float32 precision</span>
    <span class="comment"># and fails due to rounding errors.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"batch_size"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">101</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"x_array_constr"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"dense", "sparse"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_upcast_sym</span><span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">x_array_constr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check batches handling when X is Y (#13910)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squareform</span><span class="grouping">(</span><span class="identifier">pdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_array_constr</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_euclidean_distances_upcast</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="identifier">batch_size</span><span class="grouping">)</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># the default rtol=1e-7 is too close to the float32 precision</span>
    <span class="comment"># and fails due to rounding errors.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"dtype, eps, rtol"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="float-literal">1e-5</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span>
         <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="float-literal">1e-8</span><span class="punctuation">,</span> <span class="float-literal">0.99</span><span class="punctuation">,</span>
         <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">'failing due to lack of precision'</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dim"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1000000</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_euclidean_distances_extreme_values</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">eps</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="punctuation">,</span> <span class="identifier">dim</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that euclidean distances is correct with float32 input thanks to</span>
    <span class="comment"># upcasting. On float64 there are still precision issues.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">dim</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="identifier">eps</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">dim</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"squared"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nan_euclidean_distances_equal_to_euclidean_distance</span><span class="grouping">(</span><span class="identifier">squared</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># with no nan values</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1337</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>

    <span class="identifier">normal_distance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="identifier">squared</span><span class="grouping">)</span>
    <span class="identifier">nan_distance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="identifier">squared</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">normal_distance</span><span class="punctuation">,</span> <span class="identifier">nan_distance</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"X"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"Y"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nan_euclidean_distances_infinite_values</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">excinfo</span><span class="punctuation">:</span>
        <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">exp_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Input contains infinity or a value too large for "</span>
               <span class="string-literal">"dtype('float64')."</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">exp_msg</span> <span class="relational-operator">==</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">excinfo</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"X, X_diag, missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nan_euclidean_distances_2x2</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_diag</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">exp_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">X_diag</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">X_diag</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_dist</span><span class="punctuation">,</span> <span class="identifier">dist</span><span class="grouping">)</span>

    <span class="identifier">dist_sq</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_dist</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">dist_sq</span><span class="grouping">)</span>

    <span class="identifier">dist_two</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_dist</span><span class="punctuation">,</span> <span class="identifier">dist_two</span><span class="grouping">)</span>

    <span class="identifier">dist_two_copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_dist</span><span class="punctuation">,</span> <span class="identifier">dist_two_copy</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nan_euclidean_distances_complete_nan</span><span class="grouping">(</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">exp_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_dist</span><span class="punctuation">,</span> <span class="identifier">dist</span><span class="grouping">)</span>

    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">exp_dist</span><span class="punctuation">,</span> <span class="identifier">dist</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nan_euclidean_distances_not_trival</span><span class="grouping">(</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check for symmetry</span>
    <span class="identifier">D1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>  <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D1</span><span class="punctuation">,</span> <span class="identifier">D2</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="comment"># Check with explicit formula and squared=True</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">5.0</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">7</span> <span class="arithmetic-operator">-</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check with explicit formula and squared=False</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="float-literal">5.0</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">6</span> <span class="arithmetic-operator">-</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check when Y = X is explicitly passed</span>
    <span class="identifier">D3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="identifier">D4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="identifier">D5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D3</span><span class="punctuation">,</span> <span class="identifier">D4</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D4</span><span class="punctuation">,</span> <span class="identifier">D5</span><span class="grouping">)</span>

    <span class="comment"># Check copy = True against copy = False</span>
    <span class="identifier">D6</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">D7</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">D6</span><span class="punctuation">,</span> <span class="identifier">D7</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"missing_value"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nan_euclidean_distances_one_feature_match_positive</span><span class="grouping">(</span><span class="identifier">missing_value</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># First feature is the only feature that is non-nan and in both</span>
    <span class="comment"># samples. The result of `nan_euclidean_distances` with squared=True</span>
    <span class="comment"># should be non-negative. The non-squared version should all be close to 0.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-122.27</span><span class="punctuation">,</span> <span class="int-literal">648</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="float-literal">37.85</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">-122.27</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="punctuation">,</span> <span class="float-literal">2.34701493</span><span class="punctuation">,</span> <span class="identifier">missing_value</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">dist_squared</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="punctuation">,</span>
                                           <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">dist_squared</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nan_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="identifier">missing_value</span><span class="punctuation">,</span>
                                   <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_cosine_distances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check the pairwise Cosine distances computation</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1337</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">910</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cosine_distances</span><span class="grouping">(</span><span class="identifier">XA</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># check that all elements are in [0, 2]</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">D</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">D</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="comment"># check that diagonal elements are equal to 0</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag_indices_from</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cosine_distances</span><span class="grouping">(</span><span class="identifier">XB</span><span class="grouping">)</span>
    <span class="comment"># check that all elements are in [0, 2]</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">D2</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">D2</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="comment"># check that diagonal elements are equal to 0 and non diagonal to 2</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D2</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># check large random matrix</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">5000</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cosine_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># check that diagonal elements are equal to 0</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag_indices_from</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">D</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">D</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">D</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_haversine_distances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check haversine distance with distances computation</span>
    <span class="keyword">def</span> <span class="identifier">slow_haversine_distances</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">diff_lat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">diff_lon</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">diff_lat</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cos</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cos</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">diff_lon</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
        <span class="grouping">)</span>
        <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arcsin</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">c</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">D1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">slow_haversine_distances</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">Y</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">haversine_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D1</span><span class="punctuation">,</span> <span class="identifier">D2</span><span class="grouping">)</span>
    <span class="comment"># Test haversine distance does not accept X where n_feature != 2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Haversine distance only valid in 2 dimensions"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">haversine_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="comment"># Paired distances</span>

<span class="keyword">def</span> <span class="identifier">test_paired_euclidean_distances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check the paired Euclidean distances computation</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">paired_euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_paired_manhattan_distances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check the paired manhattan distances computation</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">paired_manhattan_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">D</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_chi_square_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K_add</span> <span class="arithmetic-assignment">=</span> <span class="identifier">additive_chi2_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">float</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">j</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">chi2</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">chi2_exp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">chi2</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K_add</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">chi2</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">chi2_exp</span><span class="grouping">)</span>

    <span class="comment"># check diagonal is ones for data with itself</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># check off-diagonal is &lt; 1 but &gt; 0:</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">K</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">K</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># check that float32 is preserved</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>

    <span class="comment"># check integer type gets converted,</span>
    <span class="comment"># check that zeros are handled</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">float</span>

    <span class="comment"># check that kernel of similar things is greater than dissimilar ones</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.3</span><span class="punctuation">,</span> <span class="float-literal">.7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.9</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">K</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">K</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">K</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">K</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>

    <span class="comment"># test negative input</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># different n_features in X and Y</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="float-literal">.2</span><span class="punctuation">,</span> <span class="float-literal">.6</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># sparse matrices</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">additive_chi2_kernel</span><span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'kernel'</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="identifier">linear_kernel</span><span class="punctuation">,</span> <span class="identifier">polynomial_kernel</span><span class="punctuation">,</span> <span class="identifier">rbf_kernel</span><span class="punctuation">,</span>
         <span class="identifier">laplacian_kernel</span><span class="punctuation">,</span> <span class="identifier">sigmoid_kernel</span><span class="punctuation">,</span> <span class="identifier">cosine_similarity</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_symmetry</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Valid kernels should be symmetric</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'kernel'</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="identifier">linear_kernel</span><span class="punctuation">,</span> <span class="identifier">polynomial_kernel</span><span class="punctuation">,</span> <span class="identifier">rbf_kernel</span><span class="punctuation">,</span>
         <span class="identifier">laplacian_kernel</span><span class="punctuation">,</span> <span class="identifier">sigmoid_kernel</span><span class="punctuation">,</span> <span class="identifier">cosine_similarity</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_sparse</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_linear_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linear_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># the diagonal elements of a linear kernel are their squared norm</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rbf_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># the diagonal elements of a rbf kernel are 1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_laplacian_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">laplacian_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># the diagonal elements of a laplacian kernel are 1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># off-diagonal elements are &lt; 1 but &gt; 0:</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">K</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">K</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'metric, pairwise_func'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'linear'</span><span class="punctuation">,</span> <span class="identifier">linear_kernel</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="string-literal">'cosine'</span><span class="punctuation">,</span> <span class="identifier">cosine_similarity</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_similarity_sparse_output</span><span class="grouping">(</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">pairwise_func</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xcsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Ycsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="comment"># should be sparse</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_func</span><span class="grouping">(</span><span class="identifier">Xcsr</span><span class="punctuation">,</span> <span class="identifier">Ycsr</span><span class="punctuation">,</span> <span class="identifier">dense_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">K1</span><span class="grouping">)</span>

    <span class="comment"># should be dense, and equal to K1</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">dense_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">K2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">.</span><span class="identifier">todense</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="comment"># show the kernel output equal to the sparse.todense()</span>
    <span class="identifier">K3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">.</span><span class="identifier">todense</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_cosine_similarity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the cosine_similarity.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xcsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Ycsr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">Y_</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="grouping">(</span><span class="identifier">Xcsr</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">Xcsr</span><span class="punctuation">,</span> <span class="identifier">Ycsr</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Test that the cosine is kernel is equal to a linear kernel when data</span>
        <span class="comment"># has been previously normalized by L2-norm.</span>
        <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cosine"</span><span class="grouping">)</span>
        <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalize</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">Y_</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">Y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalize</span><span class="grouping">(</span><span class="identifier">Y_</span><span class="grouping">)</span>
        <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="arithmetic-assignment">=</span><span class="identifier">Y_</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_dense_matrices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure that pairwise array check works for dense matrices.</span>
    <span class="comment"># Check that if XB is None, XB is returned as reference to XA</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">40</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">XA_checked</span> <span class="relational-operator">is</span> <span class="identifier">XB_checked</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XA_checked</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_XB_returned</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure that if XA and XB are given correctly, they return as equal.</span>
    <span class="comment"># Check that if XB is not None, it is returned equal.</span>
    <span class="comment"># Note that the second dimension of XB is the same as XA.</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">40</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">32</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XA_checked</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XB</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span><span class="grouping">)</span>

    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">40</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_paired_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XA_checked</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XB</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_different_dimensions</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure an error is raised if the dimensions are different.</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">45</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">32</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>

    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">4</span> <span class="arithmetic-operator">*</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_paired_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_invalid_dimensions</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure an error is raised on 1D input arrays.</span>
    <span class="comment"># The modified tests are not 1D. In the old test, the array was internally</span>
    <span class="comment"># converted to 2D anyways</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">45</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">45</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_sparse_arrays</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensures that checks return valid sparse matrices.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XA_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">XA</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XB_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">XB</span><span class="grouping">)</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA_sparse</span><span class="punctuation">,</span> <span class="identifier">XB_sparse</span><span class="grouping">)</span>
    <span class="comment"># compare their difference because testing csr matrices for</span>
    <span class="comment"># equality with '==' does not work as expected.</span>
    <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">XA_checked</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">XA_sparse</span> <span class="arithmetic-operator">-</span> <span class="identifier">XA_checked</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">XB_checked</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">XB_sparse</span> <span class="arithmetic-operator">-</span> <span class="identifier">XB_checked</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>

    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XA_2_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA_sparse</span><span class="punctuation">,</span> <span class="identifier">XA_sparse</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">XA_checked</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">XA_sparse</span> <span class="arithmetic-operator">-</span> <span class="identifier">XA_checked</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">XA_2_checked</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">XA_2_checked</span> <span class="arithmetic-operator">-</span> <span class="identifier">XA_checked</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">tuplify</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Turns a numpy matrix (any n-dimensional array) into tuples.</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">s</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="comment"># Tuplify each sub-array in the input.</span>
        <span class="keyword">return</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">tuplify</span><span class="grouping">(</span><span class="identifier">row</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="comment"># Single dimension input, just return tuple of contents.</span>
        <span class="keyword">return</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">r</span> <span class="keyword">for</span> <span class="identifier">r</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_tuple_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensures that checks return valid tuples.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XA_tuples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuplify</span><span class="grouping">(</span><span class="identifier">XA</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">XB_tuples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuplify</span><span class="grouping">(</span><span class="identifier">XB</span><span class="grouping">)</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA_tuples</span><span class="punctuation">,</span> <span class="identifier">XB_tuples</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XA_tuples</span><span class="punctuation">,</span> <span class="identifier">XA_checked</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">XB_tuples</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_check_preserve_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensures that type float32 is preserved.</span>
    <span class="identifier">XA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">40</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">XB</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">40</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">XA_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>

    <span class="comment"># both float32</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span> <span class="identifier">XB</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">XA_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>
    <span class="keyword">assert</span> <span class="identifier">XB_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>

    <span class="comment"># mismatched A</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="identifier">XB</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">XA_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">float</span>
    <span class="keyword">assert</span> <span class="identifier">XB_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">float</span>

    <span class="comment"># mismatched B</span>
    <span class="identifier">XA_checked</span><span class="punctuation">,</span> <span class="identifier">XB_checked</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_pairwise_arrays</span><span class="grouping">(</span><span class="identifier">XA</span><span class="punctuation">,</span>
                                                   <span class="identifier">XB</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">XA_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">float</span>
    <span class="keyword">assert</span> <span class="identifier">XB_checked</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">float</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_jobs"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"metric", ["seuclidean", "mahalanobis"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dist_function"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">pairwise_distances</span><span class="punctuation">,</span> <span class="identifier">pairwise_distances_chunked</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_data_derived_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">dist_function</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that pairwise_distances give the same result in sequential and</span>
    <span class="comment"># parallel, when metric has data-derived parameters.</span>
    <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">working_memory</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># to have more than 1 chunk</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">expected_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squareform</span><span class="grouping">(</span><span class="identifier">pdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">dist_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">expected_dist</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"metric", ["seuclidean", "mahalanobis"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pairwise_distances_data_derived_params_error</span><span class="grouping">(</span><span class="identifier">metric</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that pairwise_distances raises an error when Y is passed but</span>
    <span class="comment"># metric has data-derived params that are not provided by the user.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">fr</span><span class="string-literal">"The '(V|VI)' parameter is required for the "</span>
                             <span class="identifier">fr</span><span class="string-literal">"{metric} metric"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'metric'</span><span class="punctuation">,</span> <span class="grouping">[</span>
            <span class="string-literal">'braycurtis', 'canberra', 'chebyshev'</span><span class="punctuation">,</span>
            <span class="string-literal">'correlation', 'hamming', 'mahalanobis', 'minkowski', 'seuclidean'</span><span class="punctuation">,</span>
            <span class="string-literal">'sqeuclidean', 'cityblock', 'cosine', 'euclidean'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">"dtype"</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"y_is_x", [True, False], ids=["Y is X", "Y is not X"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_numeric_pairwise_distances_datatypes</span><span class="grouping">(</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">y_is_x</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that pairwise distances gives the same result as pdist and cdist</span>
    <span class="comment"># regardless of input datatype when using any scipy metric for comparing</span>
    <span class="comment"># numeric vectors</span>
    <span class="comment">#</span>
    <span class="comment"># This test is necessary because pairwise_distances used to throw an</span>
    <span class="comment"># error when using metric='seuclidean' and the input data was not</span>
    <span class="comment"># of type np.float64 (#15730)</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">y_is_x</span><span class="punctuation">:</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span>
        <span class="identifier">expected_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squareform</span><span class="grouping">(</span><span class="identifier">pdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">expected_dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cdist</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
        <span class="comment"># precompute parameters for seuclidean & mahalanobis when x is not y</span>
        <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">'seuclidean'</span><span class="punctuation">:</span>
            <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'V'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">ddof</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="keyword">elif</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">'mahalanobis'</span><span class="punctuation">:</span>
            <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'VI'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">}</span>

    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>

    <span class="comment"># the default rtol=1e-7 is too close to the float32 precision</span>
    <span class="comment"># and fails due to rounding errors</span>
    <span class="identifier">rtol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-5</span> <span class="keyword">if</span> <span class="identifier">dtype</span> <span class="relational-operator">is</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span> <span class="keyword">else</span> <span class="float-literal">1e-7</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dist</span><span class="punctuation">,</span> <span class="identifier">expected_dist</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="identifier">rtol</span><span class="grouping">)</span>

    </pre>
  </body>
</html>