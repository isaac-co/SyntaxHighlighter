<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
==================================================
Probability Calibration for 3-class classification
==================================================

This example illustrates how sigmoid :ref:`calibration &lt;calibration&gt;` changes
predicted probabilities for a 3-class classification problem. Illustrated is
the standard 2-simplex, where the three corners correspond to the three
classes. Arrows point from the probability vectors predicted by an uncalibrated
classifier to the probability vectors predicted by the same classifier after
sigmoid calibration on a hold-out validation set. Colors indicate the true
class of an instance (red: class 1, green: class 2, blue: class 3).
"""</span>

<span class="comment"># %%</span>
<span class="comment"># Data</span>
<span class="comment"># ----</span>
<span class="comment"># Below, we generate a classification dataset with 2000 samples, 2 features</span>
<span class="comment"># and 3 target classes. We then split the data as follows:</span>
<span class="comment">#</span>
<span class="comment"># * train: 600 samples (for training the classifier)</span>
<span class="comment"># * valid: 400 samples (for calibrating predicted probabilities)</span>
<span class="comment"># * test: 1000 samples</span>
<span class="comment">#</span>
<span class="comment"># Note that we also create `X_train_valid` and `y_train_valid`, which consists</span>
<span class="comment"># of both the train and valid subsets. This is used when we only want to train</span>
<span class="comment"># the classifier but not calibrate the predicted probabilities.</span>

<span class="comment"># Author: Jan Hendrik Metzen &lt;jhm@informatik.uni-bremen.de&gt;</span>
<span class="comment"># License: BSD Style.</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_blobs</span>

<span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2000</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                  <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">5.0</span><span class="grouping">)</span>
<span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">600</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">600</span><span class="grouping">]</span>
<span class="identifier">X_valid</span><span class="punctuation">,</span> <span class="identifier">y_valid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">600</span><span class="punctuation">:</span><span class="int-literal">1000</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">600</span><span class="punctuation">:</span><span class="int-literal">1000</span><span class="grouping">]</span>
<span class="identifier">X_train_valid</span><span class="punctuation">,</span> <span class="identifier">y_train_valid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">1000</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">1000</span><span class="grouping">]</span>
<span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1000</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">1000</span><span class="punctuation">:</span><span class="grouping">]</span>

<span class="comment"># %%</span>
<span class="comment"># Fitting and calibration</span>
<span class="comment"># -----------------------</span>
<span class="comment">#</span>
<span class="comment"># First, we will train a :class:`~sklearn.ensemble.RandomForestClassifier`</span>
<span class="comment"># with 25 base estimators (trees) on the concatenated train and validation</span>
<span class="comment"># data (1000 samples). This is the uncalibrated classifier.</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestClassifier</span>

<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">25</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train_valid</span><span class="punctuation">,</span> <span class="identifier">y_train_valid</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># To train the calibrated classifier, we start with the same</span>
<span class="comment"># :class:`~sklearn.ensemble.RandomForestClassifier` but train it using only</span>
<span class="comment"># the train data subset (600 samples) then calibrate, with `method='sigmoid'`,</span>
<span class="comment"># using the valid data subset (400 samples) in a 2-stage process.</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">calibration</span> <span class="keyword">import</span> <span class="identifier">CalibratedClassifierCV</span>

<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">25</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">cal_clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CalibratedClassifierCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sigmoid", cv="prefit"</span><span class="grouping">)</span>
<span class="identifier">cal_clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_valid</span><span class="punctuation">,</span> <span class="identifier">y_valid</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Compare probabilities</span>
<span class="comment"># ---------------------</span>
<span class="comment"># Below we plot a 2-simplex with arrows showing the change in predicted</span>
<span class="comment"># probabilities of the test samples.</span>

<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">colors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"r", "g", "b"</span><span class="grouping">]</span>

<span class="identifier">clf_probs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
<span class="identifier">cal_clf_probs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cal_clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
<span class="comment"># Plot arrows</span>
<span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">clf_probs</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">arrow</span><span class="grouping">(</span><span class="identifier">clf_probs</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">clf_probs</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">cal_clf_probs</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">clf_probs</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">cal_clf_probs</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">clf_probs</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">[</span><span class="identifier">y_test</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">head_width</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>

<span class="comment"># Plot perfect predictions, at each vertex</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'ro'</span><span class="punctuation">,</span> <span class="identifier">ms</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Class 1"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'go'</span><span class="punctuation">,</span> <span class="identifier">ms</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Class 2"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'bo'</span><span class="punctuation">,</span> <span class="identifier">ms</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Class 3"</span><span class="grouping">)</span>

<span class="comment"># Plot boundaries of unit simplex</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Simplex"</span><span class="grouping">)</span>

<span class="comment"># Annotate points 6 points around the simplex, and mid point inside simplex</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($\frac{1}{3}$, $\frac{1}{3}$, $\frac{1}{3}$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="arithmetic-operator">/</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="arithmetic-operator">/</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="arithmetic-operator">/</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="float-literal">.23</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="arithmetic-operator">/</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="arithmetic-operator">/</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'ko'</span><span class="punctuation">,</span> <span class="identifier">ms</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($\frac{1}{2}$, $0$, $\frac{1}{2}$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="float-literal">.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($0$, $\frac{1}{2}$, $\frac{1}{2}$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.0</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($\frac{1}{2}$, $\frac{1}{2}$, $0$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.6</span><span class="punctuation">,</span> <span class="float-literal">.6</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($0$, $0$, $1$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($1$, $0$, $0$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">annotate</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'($0$, $1$, $0$)'</span><span class="punctuation">,</span>
             <span class="identifier">xy</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xytext</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">xycoords</span><span class="arithmetic-assignment">=</span><span class="string-literal">'data'</span><span class="punctuation">,</span>
             <span class="identifier">arrowprops</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="punctuation">,</span> <span class="identifier">shrink</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">horizontalalignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center', verticalalignment='center'</span><span class="grouping">)</span>
<span class="comment"># Add grid</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">grid</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="punctuation">,</span> <span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Change of predicted probabilities on test samples "</span>
          <span class="string-literal">"after sigmoid calibration"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Probability class 1"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Probability class 2"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlim</span><span class="grouping">(</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"best"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># In the figure above, each vertex of the simplex represents</span>
<span class="comment"># a perfectly predicted class (e.g., 1, 0, 0). The mid point</span>
<span class="comment"># inside the simplex represents predicting the three classes with equal</span>
<span class="comment"># probability (i.e., 1/3, 1/3, 1/3). Each arrow starts at the</span>
<span class="comment"># uncalibrated probabilities and end with the arrow head at the calibrated</span>
<span class="comment"># probability. The color of the arrow represents the true class of that test</span>
<span class="comment"># sample.</span>
<span class="comment">#</span>
<span class="comment"># The uncalibrated classifier is overly confident in its predictions and</span>
<span class="comment"># incurs a large :ref:`log loss &lt;log_loss&gt;`. The calibrated classifier incurs</span>
<span class="comment"># a lower :ref:`log loss &lt;log_loss&gt;` due to two factors. First, notice in the</span>
<span class="comment"># figure above that the arrows generally point away from the edges of the</span>
<span class="comment"># simplex, where the probability of one class is 0. Second, a large proportion</span>
<span class="comment"># of the arrows point towards the true class, e.g., green arrows (samples where</span>
<span class="comment"># the true class is 'green') generally point towards the green vertex. This</span>
<span class="comment"># results in fewer over-confident, 0 predicted probabilities and at the same</span>
<span class="comment"># time an increase in the the predicted probabilities of the correct class.</span>
<span class="comment"># Thus, the calibrated classifier produces more accurate predicted probablities</span>
<span class="comment"># that incur a lower :ref:`log loss &lt;log_loss&gt;`</span>
<span class="comment">#</span>
<span class="comment"># We can show this objectively by comparing the :ref:`log loss &lt;log_loss&gt;` of</span>
<span class="comment"># the uncalibrated and calibrated classifiers on the predictions of the 1000</span>
<span class="comment"># test samples. Note that an alternative would have been to increase the number</span>
<span class="comment"># of base estimators (trees) of the</span>
<span class="comment"># :class:`~sklearn.ensemble.RandomForestClassifier` which would have resulted</span>
<span class="comment"># in a similar decrease in :ref:`log loss &lt;log_loss&gt;`.</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">log_loss</span>

<span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">log_loss</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">clf_probs</span><span class="grouping">)</span>
<span class="identifier">cal_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">log_loss</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">cal_clf_probs</span><span class="grouping">)</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Log-loss of"</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">" * uncalibrated classifier: {score:.3f}"</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">" * calibrated classifier: {cal_score:.3f}"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Finally we generate a grid of possibile uncalibrated probabilities over</span>
<span class="comment"># the 2-simplex, compute the corresponding calibrated probabilities and</span>
<span class="comment"># plot arrows for each. The arrows are colored according the highest</span>
<span class="comment"># uncalibrated probability. This illustrates the learned calibration map:</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="comment"># Generate grid of probability values</span>
<span class="identifier">p1d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span>
<span class="identifier">p0</span><span class="punctuation">,</span> <span class="identifier">p1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">meshgrid</span><span class="grouping">(</span><span class="identifier">p1d</span><span class="punctuation">,</span> <span class="identifier">p1d</span><span class="grouping">)</span>
<span class="identifier">p2</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">p0</span> <span class="arithmetic-operator">-</span> <span class="identifier">p1</span>
<span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">p0</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">p1</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">p2</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">p</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">]</span>

<span class="comment"># Use the three class-wise calibrators to compute calibrated probabilities</span>
<span class="identifier">calibrated_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cal_clf</span><span class="punctuation">.</span><span class="identifier">calibrated_classifiers_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
<span class="identifier">prediction</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">calibrator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">this_p</span><span class="grouping">)</span>
                        <span class="keyword">for</span> <span class="identifier">calibrator</span><span class="punctuation">,</span> <span class="identifier">this_p</span> <span class="relational-operator">in</span>
                        <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">calibrated_classifier</span><span class="punctuation">.</span><span class="identifier">calibrators</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

<span class="comment"># Re-normalize the calibrated predictions to make sure they stay inside the</span>
<span class="comment"># simplex. This same renormalization step is performed internally by the</span>
<span class="comment"># predict method of CalibratedClassifierCV on multiclass problems.</span>
<span class="identifier">prediction</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">prediction</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>

<span class="comment"># Plot changes in predicted probabilities induced by the calibrators</span>
<span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">prediction</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">arrow</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">prediction</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">prediction</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">p</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">head_width</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># Plot the boundaries of the unit simplex</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Simplex"</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">grid</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.4</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="punctuation">,</span> <span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="arithmetic-operator">-</span><span class="identifier">x</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'k'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Learned sigmoid calibration map"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Probability class 1"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Probability class 2"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlim</span><span class="grouping">(</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>