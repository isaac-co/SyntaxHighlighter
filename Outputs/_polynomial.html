<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
This file contains preprocessing tools based on polynomials.
"""</span>
<span class="keyword">import</span> <span class="identifier">numbers</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">chain</span><span class="punctuation">,</span> <span class="identifier">combinations</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">combinations_with_replacement</span> <span class="keyword">as</span> <span class="identifier">combinations_w_r</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">interpolate</span> <span class="keyword">import</span> <span class="identifier">BSpline</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">special</span> <span class="keyword">import</span> <span class="identifier">comb</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_array</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">linspace</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span><span class="punctuation">,</span> <span class="identifier">FLOAT_DTYPES</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_csr_polynomial_expansion</span> <span class="keyword">import</span> <span class="identifier">_csr_polynomial_expansion</span>


<span class="identifier">__all__</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
    <span class="string-literal">"SplineTransformer"</span><span class="punctuation">,</span>
<span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Generate polynomial and interaction features.

    Generate a new feature matrix consisting of all polynomial combinations
    of the features with degree less than or equal to the specified degree.
    For example, if an input sample is two dimensional and of the form
    [a, b], the degree-2 polynomial features are [1, a, b, a^2, ab, b^2].

    Read more in the :ref:`User Guide &lt;polynomial_features&gt;`.

    Parameters
    ----------
    degree : int, default=2
        The degree of the polynomial features.

    interaction_only : bool, default=False
        If true, only interaction features are produced: features that are
        products of at most ``degree`` *distinct* input features (so not
        ``x[1] ** 2``, ``x[0] * x[2] ** 3``, etc.).

    include_bias : bool, default=True
        If True (default), then include a bias column, the feature in which
        all polynomial powers are zero (i.e. a column of ones - acts as an
        intercept term in a linear model).

    order : {'C', 'F'}, default='C'
        Order of output array in the dense case. 'F' order is faster to
        compute, but may slow down subsequent estimators.

        .. versionadded:: 0.21

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.preprocessing import PolynomialFeatures
    &gt;&gt;&gt; X = np.arange(6).reshape(3, 2)
    &gt;&gt;&gt; X
    array([[0, 1],
           [2, 3],
           [4, 5]])
    &gt;&gt;&gt; poly = PolynomialFeatures(2)
    &gt;&gt;&gt; poly.fit_transform(X)
    array([[ 1.,  0.,  1.,  0.,  0.,  1.],
           [ 1.,  2.,  3.,  4.,  6.,  9.],
           [ 1.,  4.,  5., 16., 20., 25.]])
    &gt;&gt;&gt; poly = PolynomialFeatures(interaction_only=True)
    &gt;&gt;&gt; poly.fit_transform(X)
    array([[ 1.,  0.,  1.,  0.],
           [ 1.,  2.,  3.,  6.],
           [ 1.,  4.,  5., 20.]])

    Attributes
    ----------
    powers_ : ndarray of shape (n_output_features, n_input_features)
        powers_[i, j] is the exponent of the jth input in the ith output.

    n_input_features_ : int
        The total number of input features.

    n_output_features_ : int
        The total number of polynomial output features. The number of output
        features is computed by iterating over all suitably sized combinations
        of input features.

    See Also
    --------
    SplineTransformer : Transformer that generates univariate B-spline bases
        for features

    Notes
    -----
    Be aware that the number of features in the output array scales
    polynomially in the number of features of the input array, and
    exponentially in the degree. High degrees can cause overfitting.

    See :ref:`examples/linear_model/plot_polynomial_interpolation.py
    &lt;sphx_glr_auto_examples_linear_model_plot_polynomial_interpolation.py&gt;`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'C'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">degree</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interaction_only</span> <span class="arithmetic-assignment">=</span> <span class="identifier">interaction_only</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">include_bias</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">order</span> <span class="arithmetic-assignment">=</span> <span class="identifier">order</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_combinations</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">comb</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">combinations</span> <span class="keyword">if</span> <span class="identifier">interaction_only</span> <span class="keyword">else</span> <span class="identifier">combinations_w_r</span><span class="grouping">)</span>
        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">include_bias</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">chain</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">l</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">comb</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">)</span>
                                   <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">degree</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_num_combinations</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Calculate number of terms in polynomial expansion

        This should be equivalent to counting the number of terms returned by
        _combinations(...) but much faster.
        """</span>

        <span class="keyword">if</span> <span class="identifier">interaction_only</span><span class="punctuation">:</span>
            <span class="identifier">combinations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sum</span><span class="grouping">(</span>
                <span class="grouping">[</span>
                    <span class="identifier">comb</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">exact</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">degree</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="grouping">]</span>
            <span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">combinations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">comb</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">exact</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

        <span class="keyword">if</span> <span class="identifier">include_bias</span><span class="punctuation">:</span>
            <span class="identifier">combinations</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

        <span class="keyword">return</span> <span class="identifier">combinations</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">powers_</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">combinations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_combinations</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_input_features_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="punctuation">,</span>
                                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interaction_only</span><span class="punctuation">,</span>
                                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">c</span><span class="punctuation">,</span> <span class="identifier">minlength</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_input_features_</span><span class="grouping">)</span>
                          <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">combinations</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Return feature names for output features

        Parameters
        ----------
        input_features : list of str of shape (n_features,), default=None
            String names for input features if available. By default,
            "x0", "x1", ... "xn_features" is used.

        Returns
        -------
        output_feature_names : list of str of shape (n_output_features,)
        """</span>
        <span class="identifier">powers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">powers_</span>
        <span class="keyword">if</span> <span class="identifier">input_features</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">input_features</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'x%d'</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">powers</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">row</span> <span class="relational-operator">in</span> <span class="identifier">powers</span><span class="punctuation">:</span>
            <span class="identifier">inds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">row</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">inds</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">" ".join("%s^%d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">input_features</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">exp</span><span class="grouping">)</span>
                                <span class="keyword">if</span> <span class="identifier">exp</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span> <span class="keyword">else</span> <span class="identifier">input_features</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">]</span>
                                <span class="keyword">for</span> <span class="identifier">ind</span><span class="punctuation">,</span> <span class="identifier">exp</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">inds</span><span class="punctuation">,</span> <span class="identifier">row</span><span class="grouping">[</span><span class="identifier">inds</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"1"</span>
            <span class="identifier">feature_names</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">feature_names</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Compute number of output features.


        Parameters
        ----------
        X : {array-like, sparse matrix} of shape (n_samples, n_features)
            The data.

        y : None
            Ignored.

        Returns
        -------
        self : object
            Fitted transformer.
        """</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_input_features_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_output_features_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_num_combinations</span><span class="grouping">(</span>
            <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span>
        <span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Transform data to polynomial features.

        Parameters
        ----------
        X : {array-like, sparse matrix} of shape (n_samples, n_features)
            The data to transform, row by row.

            Prefer CSR over CSC for sparse input (for speed), but CSC is
            required if the degree is 4 or higher. If the degree is less than
            4 and the input format is CSC, it will be converted to CSR, have
            its polynomial features generated, then converted back to CSC.

            If the degree is 2 or 3, the method described in "Leveraging
            Sparsity to Speed Up Polynomial Feature Expansions of CSR Matrices
            Using K-Simplex Numbers" by Andrew Nystrom and John Hughes is
            used, which is much faster than the method used on CSC input. For
            this reason, a CSC input will be converted to CSR, and the output
            will be converted back to CSC prior to being returned, hence the
            preference of CSR.

        Returns
        -------
        XP : {ndarray, sparse matrix} of shape (n_samples, NP)
            The matrix of features, where NP is the number of polynomial
            features generated from the combination of inputs. If a sparse
            matrix is provided, it will be converted into a sparse
            ``csr_matrix``.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'F'</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">FLOAT_DTYPES</span><span class="punctuation">,</span> <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'csr', 'csc'</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="keyword">if</span> <span class="identifier">n_features</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_input_features_</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"X shape does not match training shape"</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">isspmatrix_csr</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span> <span class="relational-operator">&gt;</span> <span class="int-literal">3</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">to_stack</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="punctuation">:</span>
                <span class="identifier">to_stack</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">to_stack</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">deg</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="arithmetic-operator">+</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">Xp_next</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_csr_polynomial_expansion</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span>
                                                    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interaction_only</span><span class="punctuation">,</span>
                                                    <span class="identifier">deg</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">Xp_next</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                    <span class="keyword">break</span>
                <span class="identifier">to_stack</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">Xp_next</span><span class="grouping">)</span>
            <span class="identifier">XP</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="identifier">to_stack</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'csr'</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">isspmatrix_csc</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span> <span class="relational-operator">&lt;</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">isspmatrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">combinations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_combinations</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="punctuation">,</span>
                                                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interaction_only</span><span class="punctuation">,</span>
                                                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="grouping">)</span>
                <span class="identifier">columns</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
                <span class="keyword">for</span> <span class="identifier">comb</span> <span class="relational-operator">in</span> <span class="identifier">combinations</span><span class="punctuation">:</span>
                    <span class="keyword">if</span> <span class="identifier">comb</span><span class="punctuation">:</span>
                        <span class="identifier">out_col</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
                        <span class="keyword">for</span> <span class="identifier">col_idx</span> <span class="relational-operator">in</span> <span class="identifier">comb</span><span class="punctuation">:</span>
                            <span class="identifier">out_col</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">col_idx</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">out_col</span><span class="grouping">)</span>
                        <span class="identifier">columns</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">out_col</span><span class="grouping">)</span>
                    <span class="keyword">else</span><span class="punctuation">:</span>
                        <span class="identifier">bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
                        <span class="identifier">columns</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">bias</span><span class="grouping">)</span>
                <span class="identifier">XP</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="identifier">columns</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">XP</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_output_features_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">order</span><span class="grouping">)</span>

                <span class="comment"># What follows is a faster implementation of:</span>
                <span class="comment"># for i, comb in enumerate(combinations):</span>
                <span class="comment">#     XP[:, i] = X[:, comb].prod(1)</span>
                <span class="comment"># This implementation uses two optimisations.</span>
                <span class="comment"># First one is broadcasting,</span>
                <span class="comment"># multiply ([X1, ..., Xn], X1) -&gt; [X1 X1, ..., Xn X1]</span>
                <span class="comment"># multiply ([X2, ..., Xn], X2) -&gt; [X2 X2, ..., Xn X2]</span>
                <span class="comment"># ...</span>
                <span class="comment"># multiply ([X[:, start:end], X[:, start]) -&gt; ...</span>
                <span class="comment"># Second optimisation happens for degrees &gt;= 3.</span>
                <span class="comment"># Xi^3 is computed reusing previous computation:</span>
                <span class="comment"># Xi^3 = Xi^2 * Xi.</span>

                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="punctuation">:</span>
                    <span class="identifier">XP</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
                    <span class="identifier">current_col</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">current_col</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

                <span class="comment"># d = 0</span>
                <span class="identifier">XP</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">current_col</span><span class="punctuation">:</span><span class="identifier">current_col</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_features</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span>
                <span class="identifier">index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">current_col</span><span class="punctuation">,</span>
                                   <span class="identifier">current_col</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">current_col</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">n_features</span>
                <span class="identifier">index</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">current_col</span><span class="grouping">)</span>

                <span class="comment"># d &gt;= 1</span>
                <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">new_index</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
                    <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">index</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
                    <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">index</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span>
                        <span class="identifier">new_index</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">current_col</span><span class="grouping">)</span>
                        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">interaction_only</span><span class="punctuation">:</span>
                            <span class="identifier">start</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">index</span><span class="grouping">[</span><span class="identifier">feature_idx</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span>
                                      <span class="identifier">index</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span><span class="grouping">)</span>
                        <span class="identifier">next_col</span> <span class="arithmetic-assignment">=</span> <span class="identifier">current_col</span> <span class="arithmetic-operator">+</span> <span class="identifier">end</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span>
                        <span class="keyword">if</span> <span class="identifier">next_col</span> <span class="relational-operator">&lt;=</span> <span class="identifier">current_col</span><span class="punctuation">:</span>
                            <span class="keyword">break</span>
                        <span class="comment"># XP[:, start:end] are terms of degree d - 1</span>
                        <span class="comment"># that exclude feature #feature_idx.</span>
                        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">XP</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="punctuation">:</span><span class="identifier">feature_idx</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">XP</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">current_col</span><span class="punctuation">:</span><span class="identifier">next_col</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">casting</span><span class="arithmetic-assignment">=</span><span class="string-literal">'no'</span><span class="grouping">)</span>
                        <span class="identifier">current_col</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next_col</span>

                    <span class="identifier">new_index</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">current_col</span><span class="grouping">)</span>
                    <span class="identifier">index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_index</span>

        <span class="keyword">return</span> <span class="identifier">XP</span>


<span class="comment"># TODO:</span>
<span class="comment"># - sparse support (either scipy or own cython solution)?</span>
<span class="keyword">class</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Generate univariate B-spline bases for features.

    Generate a new feature matrix consisting of
    `n_splines=n_knots + degree - 1` (`n_knots - 1` for
    `extrapolation="periodic"`) spline basis functions
    (B-splines) of polynomial order=`degree` for each feature.

    Read more in the :ref:`User Guide &lt;spline_transformer&gt;`.

    .. versionadded:: 1.0

    Parameters
    ----------
    n_knots : int, default=5
        Number of knots of the splines if `knots` equals one of
        {'uniform', 'quantile'}. Must be larger or equal 2.

    degree : int, default=3
        The polynomial degree of the spline basis. Must be a non-negative
        integer.

    knots : {'uniform', 'quantile'} or array-like of shape \
        (n_knots, n_features), default='uniform'
        Set knot positions such that first knot &lt;= features &lt;= last knot.

        - If 'uniform', `n_knots` number of knots are distributed uniformly
          from min to max values of the features.
        - If 'quantile', they are distributed uniformly along the quantiles of
          the features.
        - If an array-like is given, it directly specifies the sorted knot
          positions including the boundary knots. Note that, internally,
          `degree` number of knots are added before the first knot, the same
          after the last knot.

    extrapolation : {'error', 'constant', 'linear', 'continue', 'periodic'}, \
        default='constant'
        If 'error', values outside the min and max values of the training
        features raises a `ValueError`. If 'constant', the value of the
        splines at minimum and maximum value of the features is used as
        constant extrapolation. If 'linear', a linear extrapolation is used.
        If 'continue', the splines are extrapolated as is, i.e. option
        `extrapolate=True` in :class:`scipy.interpolate.BSpline`. If
        'periodic', periodic splines with a periodicity equal to the distance
        between the first and last knot are used. Periodic splines enforce
        equal function values and derivatives at the first and last knot.
        For example, this makes it possible to avoid introducing an arbitrary
        jump between Dec 31st and Jan 1st in spline features derived from a
        naturally periodic "day-of-year" input feature. In this case it is
        recommended to manually set the knot values to control the period.

    include_bias : bool, default=True
        If True (default), then the last spline element inside the data range
        of a feature is dropped. As B-splines sum to one over the spline basis
        functions for each data point, they implicitly include a bias term,
        i.e. a column of ones. It acts as an intercept term in a linear models.

    order : {'C', 'F'}, default='C'
        Order of output array. 'F' order is faster to compute, but may slow
        down subsequent estimators.

    Attributes
    ----------
    bsplines_ : list of shape (n_features,)
        List of BSplines objects, one for each feature.

    n_features_in_ : int
        The total number of input features.

    n_features_out_ : int
        The total number of output features, which is computed as
        `n_features * n_splines`, where `n_splines` is
        the number of bases elements of the B-splines,
        `n_knots + degree - 1` for non-periodic splines and
        `n_knots - 1` for periodic ones.
        If `include_bias=False`, then it is only
        `n_features * (n_splines - 1)`.

    See Also
    --------
    KBinsDiscretizer : Transformer that bins continuous data into intervals.

    PolynomialFeatures : Transformer that generates polynomial and interaction
        features.

    Notes
    -----
    High degrees and a high number of knots can cause overfitting.

    See :ref:`examples/linear_model/plot_polynomial_interpolation.py
    &lt;sphx_glr_auto_examples_linear_model_plot_polynomial_interpolation.py&gt;`.

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.preprocessing import SplineTransformer
    &gt;&gt;&gt; X = np.arange(6).reshape(6, 1)
    &gt;&gt;&gt; spline = SplineTransformer(degree=2, n_knots=3)
    &gt;&gt;&gt; spline.fit_transform(X)
    array([[0.5 , 0.5 , 0.  , 0.  ],
           [0.18, 0.74, 0.08, 0.  ],
           [0.02, 0.66, 0.32, 0.  ],
           [0.  , 0.32, 0.66, 0.02],
           [0.  , 0.08, 0.74, 0.18],
           [0.  , 0.  , 0.5 , 0.5 ]])
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span>
        <span class="identifier">self</span><span class="punctuation">,</span>
        <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="arithmetic-operator">*</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="string-literal">"uniform"</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
        <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="punctuation">,</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_knots</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">degree</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knots</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extrapolation</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span> <span class="arithmetic-assignment">=</span> <span class="identifier">include_bias</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">order</span> <span class="arithmetic-assignment">=</span> <span class="identifier">order</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_get_base_knot_positions</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="string-literal">"uniform"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Calculate base knot positions.

        Base knots such that first knot &lt;= feature &lt;= last knot. For the
        B-spline construction with scipy.interpolate.BSpline, 2*degree knots
        beyond the base interval are added.

        Returns
        -------
        knots : ndarray of shape (n_knots, n_features), dtype=np.float64
            Knot positions (points) of base interval.
        """</span>
        <span class="keyword">if</span> <span class="identifier">knots</span> <span class="relational-operator">==</span> <span class="string-literal">"quantile"</span><span class="punctuation">:</span>
            <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span>
                <span class="int-literal">100</span>
                <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">start</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">stop</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="identifier">n_knots</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
            <span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># knots == 'uniform':</span>
            <span class="comment"># Note that the variable `knots` has already been validated and</span>
            <span class="comment"># `else` is therefore safe.</span>
            <span class="identifier">x_min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">amin</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">x_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">amax</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linspace</span><span class="grouping">(</span>
                <span class="identifier">start</span><span class="arithmetic-assignment">=</span><span class="identifier">x_min</span><span class="punctuation">,</span>
                <span class="identifier">stop</span><span class="arithmetic-assignment">=</span><span class="identifier">x_max</span><span class="punctuation">,</span>
                <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="identifier">n_knots</span><span class="punctuation">,</span>
                <span class="identifier">endpoint</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
            <span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">knots</span>

    <span class="keyword">def</span> <span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Return feature names for output features.

        Parameters
        ----------
        input_features : list of str of shape (n_features,), default=None
            String names for input features if available. By default,
            "x0", "x1", ... "xn_features" is used.

        Returns
        -------
        output_feature_names : list of str of shape (n_output_features,)
        """</span>
        <span class="identifier">n_splines</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bsplines_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">c</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">input_features</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">input_features</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"x%d"</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_splines</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">feature_names</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"{input_features[i]}_sp_{j}"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">feature_names</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute knot positions of splines.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            The data.

        y : None
            Ignored.

        Returns
        -------
        self : object
            Fitted transformer.
        """</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span>
            <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="identifier">ensure_min_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
            <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="grouping">)</span>
        <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span>
            <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span>
        <span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"degree must be a non-negative integer."</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span>
            <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_knots</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_knots</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">2</span>
        <span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"n_knots must be a positive integer &gt;= 2."</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">knots</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">knots</span> <span class="relational-operator">in</span> <span class="grouping">[</span>
            <span class="string-literal">"uniform"</span><span class="punctuation">,</span>
            <span class="string-literal">"quantile"</span><span class="punctuation">,</span>
        <span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">base_knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_base_knot_positions</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_knots</span><span class="punctuation">,</span> <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">knots</span>
            <span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">base_knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">knots</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">base_knots</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                    <span class="string-literal">"Number of knots, knots.shape[0], must be &gt;= " "2."</span>
                <span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="identifier">base_knots</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">n_features</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"knots.shape[1] == n_features is violated."</span><span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">base_knots</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"knots must be sorted without duplicates."</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span>
            <span class="string-literal">"error"</span><span class="punctuation">,</span>
            <span class="string-literal">"constant"</span><span class="punctuation">,</span>
            <span class="string-literal">"linear"</span><span class="punctuation">,</span>
            <span class="string-literal">"continue"</span><span class="punctuation">,</span>
            <span class="string-literal">"periodic"</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"extrapolation must be one of 'error', "</span>
                <span class="string-literal">"'constant', 'linear', 'continue' or 'periodic'."</span>
            <span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">bool</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bool_</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"include_bias must be bool."</span><span class="grouping">)</span>

        <span class="comment"># number of knots for base interval</span>
        <span class="identifier">n_knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_knots</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"periodic"</span> <span class="logical-operator">and</span> <span class="identifier">n_knots</span> <span class="relational-operator">&lt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"Periodic splines require degree &lt; n_knots. Got n_knots="</span>
                <span class="identifier">f</span><span class="string-literal">"{n_knots} and degree={self.degree}."</span>
            <span class="grouping">)</span>

        <span class="comment"># number of splines basis functions</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">!=</span> <span class="string-literal">"periodic"</span><span class="punctuation">:</span>
            <span class="identifier">n_splines</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_knots</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># periodic splines have self.degree less degrees of freedom</span>
            <span class="identifier">n_splines</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_knots</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

        <span class="identifier">degree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span>
        <span class="identifier">n_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span>
        <span class="comment"># We have to add degree number of knots below, and degree number knots</span>
        <span class="comment"># above the base knots in order to make the spline basis complete.</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"periodic"</span><span class="punctuation">:</span>
            <span class="comment"># For periodic splines the spacing of the first / last degree knots</span>
            <span class="comment"># needs to be a continuation of the spacing of the last / first</span>
            <span class="comment"># base knots.</span>
            <span class="identifier">period</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_knots</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">base_knots</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span>
                <span class="identifier">base_knots</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">degree</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">period</span><span class="punctuation">,</span>
                <span class="identifier">base_knots</span><span class="punctuation">,</span>
                <span class="identifier">base_knots</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">degree</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">period</span>
            <span class="grouping">]</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># Eilers & Marx in "Flexible smoothing with B-splines and</span>
            <span class="comment"># penalties" https://doi.org/10.1214/ss/1038425655 advice</span>
            <span class="comment"># against repeating first and last knot several times, which</span>
            <span class="comment"># would have inferior behaviour at boundaries if combined with</span>
            <span class="comment"># a penalty (hence P-Spline). We follow this advice even if our</span>
            <span class="comment"># splines are unpenalized. Meaning we do not:</span>
            <span class="comment"># knots = np.r_[</span>
            <span class="comment">#     np.tile(base_knots.min(axis=0), reps=[degree, 1]),</span>
            <span class="comment">#     base_knots,</span>
            <span class="comment">#     np.tile(base_knots.max(axis=0), reps=[degree, 1])</span>
            <span class="comment"># ]</span>
            <span class="comment"># Instead, we reuse the distance of the 2 fist/last knots.</span>
            <span class="identifier">dist_min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_knots</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">base_knots</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">dist_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">base_knots</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">base_knots</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span>

            <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span>
                <span class="identifier">linspace</span><span class="grouping">(</span>
                    <span class="identifier">base_knots</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">degree</span> <span class="arithmetic-operator">*</span> <span class="identifier">dist_min</span><span class="punctuation">,</span>
                    <span class="identifier">base_knots</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">dist_min</span><span class="punctuation">,</span>
                    <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">base_knots</span><span class="punctuation">,</span>
                <span class="identifier">linspace</span><span class="grouping">(</span>
                    <span class="identifier">base_knots</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">dist_max</span><span class="punctuation">,</span>
                    <span class="identifier">base_knots</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">degree</span> <span class="arithmetic-operator">*</span> <span class="identifier">dist_max</span><span class="punctuation">,</span>
                    <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">]</span>

        <span class="comment"># With a diagonal coefficient matrix, we get back the spline basis</span>
        <span class="comment"># elements, i.e. the design matrix of the spline.</span>
        <span class="comment"># Note, BSpline appreciates C-contiguous float64 arrays as c=coef.</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_splines</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"periodic"</span><span class="punctuation">:</span>
            <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">degree</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">extrapolate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"periodic", "continue"</span><span class="grouping">]</span>

        <span class="identifier">bsplines</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
            <span class="identifier">BSpline</span><span class="punctuation">.</span><span class="identifier">construct_fast</span><span class="grouping">(</span>
                <span class="identifier">knots</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">extrapolate</span><span class="arithmetic-assignment">=</span><span class="identifier">extrapolate</span>
            <span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bsplines_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bsplines</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_features_out_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_out</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Transform each feature data to B-splines.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            The data to transform.

        Returns
        -------
        XBS : ndarray of shape (n_samples, n_features * n_splines)
            The matrix of features, where n_splines is the number of bases
            elements of the B-splines, n_knots + degree - 1.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span>
        <span class="grouping">)</span>

        <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">n_splines</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bsplines_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">c</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">degree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">degree</span>

        <span class="comment"># Note that scipy BSpline returns float64 arrays and converts input</span>
        <span class="comment"># x=X[:, i] to c-contiguous float64.</span>
        <span class="identifier">n_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_features_out_</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">FLOAT_DTYPES</span><span class="punctuation">:</span>
            <span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>
        <span class="identifier">XBS</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_out</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">order</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">spl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bsplines_</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"continue", "error", "periodic"</span><span class="grouping">)</span><span class="punctuation">:</span>

                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"periodic"</span><span class="punctuation">:</span>
                    <span class="comment"># With periodic extrapolation we map x to the segment</span>
                    <span class="comment"># [spl.t[k], spl.t[n]].</span>
                    <span class="comment"># This is equivalent to BSpline(.., extrapolate="periodic")</span>
                    <span class="comment"># for scipy&gt;=1.0.0.</span>
                    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">k</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
                    <span class="comment"># Assign to new array to avoid inplace operation</span>
                    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">[</span><span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">[</span><span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">k</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
                        <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">[</span><span class="identifier">n</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">[</span><span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">k</span><span class="grouping">]</span>
                    <span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span>

                <span class="identifier">XBS</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>

            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">xmin</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">[</span><span class="identifier">degree</span><span class="grouping">]</span>
                <span class="identifier">xmax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">degree</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">xmin</span> <span class="relational-operator">&lt;=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span> <span class="bitwise-operator">&</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">xmax</span><span class="grouping">)</span>
                <span class="identifier">XBS</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span>
                    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span>
                <span class="grouping">)</span>

            <span class="comment"># Note for extrapolation:</span>
            <span class="comment"># 'continue' is already returned as is by scipy BSplines</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"error"</span><span class="punctuation">:</span>
                <span class="comment"># BSpline with extrapolate=False does not raise an error, but</span>
                <span class="comment"># output np.nan.</span>
                <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">XBS</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                        <span class="string-literal">"X contains values beyond the limits of the knots."</span>
                    <span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"constant"</span><span class="punctuation">:</span>
                <span class="comment"># Set all values beyond xmin and xmax to the value of the</span>
                <span class="comment"># spline basis functions at those two positions.</span>
                <span class="comment"># Only the first degree and last degree number of splines</span>
                <span class="comment"># have non-zero values at the boundaries.</span>

                <span class="comment"># spline values at boundaries</span>
                <span class="identifier">f_min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">xmin</span><span class="grouping">)</span>
                <span class="identifier">f_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">xmax</span><span class="grouping">)</span>
                <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">xmin</span>
                <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">XBS</span><span class="grouping">[</span>
                        <span class="identifier">mask</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span> <span class="arithmetic-operator">+</span> <span class="identifier">degree</span><span class="grouping">)</span>
                    <span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f_min</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">degree</span><span class="grouping">]</span>

                <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">xmax</span>
                <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">XBS</span><span class="grouping">[</span>
                        <span class="identifier">mask</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span> <span class="arithmetic-operator">-</span> <span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f_max</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">degree</span><span class="punctuation">:</span><span class="grouping">]</span>
            <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"linear"</span><span class="punctuation">:</span>
                <span class="comment"># Continue the degree first and degree last spline bases</span>
                <span class="comment"># linearly beyond the boundaries, with slope = derivative at</span>
                <span class="comment"># the boundary.</span>
                <span class="comment"># Note that all others have derivative = value = 0 at the</span>
                <span class="comment"># boundaries.</span>

                <span class="comment"># spline values at boundaries</span>
                <span class="identifier">f_min</span><span class="punctuation">,</span> <span class="identifier">f_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">xmin</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">xmax</span><span class="grouping">)</span>
                <span class="comment"># spline derivatives = slopes at boundaries</span>
                <span class="identifier">fp_min</span><span class="punctuation">,</span> <span class="identifier">fp_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">xmax</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
                <span class="comment"># Compute the linear continuation.</span>
                <span class="keyword">if</span> <span class="identifier">degree</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                    <span class="comment"># For degree=1, the derivative of 2nd spline is not zero at</span>
                    <span class="comment"># boundary. For degree=0 it is the same as 'constant'.</span>
                    <span class="identifier">degree</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
                <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">xmin</span>
                    <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">XBS</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span> <span class="arithmetic-operator">+</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                            <span class="identifier">f_min</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">xmin</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">fp_min</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span>
                        <span class="grouping">)</span>

                    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">xmax</span>
                    <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_splines</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">j</span>
                        <span class="identifier">XBS</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_splines</span> <span class="arithmetic-operator">+</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                            <span class="identifier">f_max</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">xmax</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">fp_max</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span>
                        <span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">include_bias</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">XBS</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># We throw away one spline basis per feature.</span>
            <span class="comment"># We chose the last one.</span>
            <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
                <span class="identifier">j</span> <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">XBS</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">n_splines</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span>
            <span class="grouping">]</span>
            <span class="keyword">return</span> <span class="identifier">XBS</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">]</span>

    </pre>
  </body>
</html>