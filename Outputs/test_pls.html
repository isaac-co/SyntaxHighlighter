<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
                           <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_linnerud</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cross_decomposition</span><span class="punctuation">.</span><span class="identifier">_pls</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">_center_scale_xy</span><span class="punctuation">,</span>
    <span class="identifier">_get_first_singular_vectors_power_method</span><span class="punctuation">,</span>
    <span class="identifier">_get_first_singular_vectors_svd</span><span class="punctuation">,</span>
    <span class="identifier">_svd_flip_1d</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cross_decomposition</span> <span class="keyword">import</span> <span class="identifier">CCA</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cross_decomposition</span> <span class="keyword">import</span> <span class="identifier">PLSSVD</span><span class="punctuation">,</span> <span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">svd_flip</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">M</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">M</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pls_canonical_basics</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Basic checks for PLSCanonical</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSCanonical</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_x_scores</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_y_scores</span><span class="grouping">)</span>

    <span class="comment"># Check X = TP' and Y = UQ'</span>
    <span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_x_scores</span>
    <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span>
    <span class="identifier">U</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_y_scores</span>
    <span class="identifier">Q</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span>
    <span class="comment"># Need to scale first</span>
    <span class="identifier">Xc</span><span class="punctuation">,</span> <span class="identifier">Yc</span><span class="punctuation">,</span> <span class="identifier">x_mean</span><span class="punctuation">,</span> <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">x_std</span><span class="punctuation">,</span> <span class="identifier">y_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_center_scale_xy</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xc</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Yc</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">Q</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check that rotations on training data lead to scores</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">,</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_x_scores</span><span class="grouping">)</span>
    <span class="identifier">Xt</span><span class="punctuation">,</span> <span class="identifier">Yt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">,</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_x_scores</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Yt</span><span class="punctuation">,</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_y_scores</span><span class="grouping">)</span>

    <span class="comment"># Check that inverse_transform works</span>
    <span class="identifier">X_back</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_back</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sanity_check_pls_regression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sanity check for PLSRegression</span>
    <span class="comment"># The results were checked against the R-packages plspm, misOmics and pls</span>

    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSRegression</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">expected_x_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.61330704</span><span class="punctuation">,</span> <span class="float-literal">-0.00443647</span><span class="punctuation">,</span>  <span class="float-literal">0.78983213</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.74697144</span><span class="punctuation">,</span> <span class="float-literal">-0.32172099</span><span class="punctuation">,</span> <span class="float-literal">-0.58183269</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.25668686</span><span class="punctuation">,</span>  <span class="float-literal">0.94682413</span><span class="punctuation">,</span> <span class="float-literal">-0.19399983</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_x_loadings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.61470416</span><span class="punctuation">,</span> <span class="float-literal">-0.24574278</span><span class="punctuation">,</span>  <span class="float-literal">0.78983213</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.65625755</span><span class="punctuation">,</span> <span class="float-literal">-0.14396183</span><span class="punctuation">,</span> <span class="float-literal">-0.58183269</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.51733059</span><span class="punctuation">,</span>  <span class="float-literal">1.00609417</span><span class="punctuation">,</span> <span class="float-literal">-0.19399983</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">+0.32456184</span><span class="punctuation">,</span>  <span class="float-literal">0.29892183</span><span class="punctuation">,</span>  <span class="float-literal">0.20316322</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">+0.42439636</span><span class="punctuation">,</span>  <span class="float-literal">0.61970543</span><span class="punctuation">,</span>  <span class="float-literal">0.19320542</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.13143144</span><span class="punctuation">,</span> <span class="float-literal">-0.26348971</span><span class="punctuation">,</span> <span class="float-literal">-0.17092916</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_loadings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">+0.32456184</span><span class="punctuation">,</span>  <span class="float-literal">0.29892183</span><span class="punctuation">,</span>  <span class="float-literal">0.20316322</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">+0.42439636</span><span class="punctuation">,</span>  <span class="float-literal">0.61970543</span><span class="punctuation">,</span>  <span class="float-literal">0.19320542</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.13143144</span><span class="punctuation">,</span> <span class="float-literal">-0.26348971</span><span class="punctuation">,</span> <span class="float-literal">-0.17092916</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_loadings</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_weights</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_loadings</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_weights</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># The R / Python difference in the signs should be consistent across</span>
    <span class="comment"># loadings, weights, etc.</span>
    <span class="identifier">x_loadings_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_x_loadings</span><span class="grouping">)</span>
    <span class="identifier">x_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_x_weights</span><span class="grouping">)</span>
    <span class="identifier">y_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_y_weights</span><span class="grouping">)</span>
    <span class="identifier">y_loadings_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_y_loadings</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_loadings_sign_flip</span><span class="punctuation">,</span> <span class="identifier">x_weights_sign_flip</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_loadings_sign_flip</span><span class="punctuation">,</span> <span class="identifier">y_weights_sign_flip</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sanity_check_pls_regression_constant_column_Y</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check behavior when the first column of Y is constant</span>
    <span class="comment"># The results are checked against a modified version of plsreg2</span>
    <span class="comment"># from the R-package plsdepot</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSRegression</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">expected_x_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.6273573</span><span class="punctuation">,</span> <span class="float-literal">0.007081799</span><span class="punctuation">,</span> <span class="float-literal">0.7786994</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.7493417</span><span class="punctuation">,</span> <span class="float-literal">-0.277612681</span><span class="punctuation">,</span> <span class="float-literal">-0.6011807</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.2119194</span><span class="punctuation">,</span> <span class="float-literal">0.960666981</span><span class="punctuation">,</span> <span class="float-literal">-0.1794690</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_x_loadings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.6273512</span><span class="punctuation">,</span> <span class="float-literal">-0.22464538</span><span class="punctuation">,</span> <span class="float-literal">0.7786994</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.6643156</span><span class="punctuation">,</span> <span class="float-literal">-0.09871193</span><span class="punctuation">,</span> <span class="float-literal">-0.6011807</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.5125877</span><span class="punctuation">,</span> <span class="float-literal">1.01407380</span><span class="punctuation">,</span> <span class="float-literal">-0.1794690</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_loadings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="punctuation">,</span> <span class="float-literal">0.0000000</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.4357300</span><span class="punctuation">,</span> <span class="float-literal">0.5828479</span><span class="punctuation">,</span> <span class="float-literal">0.2174802</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.1353739</span><span class="punctuation">,</span> <span class="float-literal">-0.2486423</span><span class="punctuation">,</span> <span class="float-literal">-0.1810386</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_weights</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_loadings</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># For the PLSRegression with default parameters, y_loadings == y_weights</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_loadings</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_loadings</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">x_loadings_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">expected_x_loadings</span> <span class="arithmetic-operator">/</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span><span class="grouping">)</span>
    <span class="identifier">x_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">expected_x_weights</span> <span class="arithmetic-operator">/</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span>
    <span class="comment"># we ignore the first full-zeros row for y</span>
    <span class="identifier">y_loadings_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">expected_y_loadings</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span>
                                   <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_loadings_sign_flip</span><span class="punctuation">,</span> <span class="identifier">x_weights_sign_flip</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_loadings_sign_flip</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_loadings_sign_flip</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sanity_check_pls_canonical</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sanity check for PLSCanonical</span>
    <span class="comment"># The results were checked against the R-package plspm</span>

    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSCanonical</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pls</span> <span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">expected_x_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.61330704</span><span class="punctuation">,</span>  <span class="float-literal">0.25616119</span><span class="punctuation">,</span> <span class="float-literal">-0.74715187</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.74697144</span><span class="punctuation">,</span>  <span class="float-literal">0.11930791</span><span class="punctuation">,</span>  <span class="float-literal">0.65406368</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.25668686</span><span class="punctuation">,</span> <span class="float-literal">-0.95924297</span><span class="punctuation">,</span> <span class="float-literal">-0.11817271</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_x_rotations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.61330704</span><span class="punctuation">,</span>  <span class="float-literal">0.41591889</span><span class="punctuation">,</span> <span class="float-literal">-0.62297525</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.74697144</span><span class="punctuation">,</span>  <span class="float-literal">0.31388326</span><span class="punctuation">,</span>  <span class="float-literal">0.77368233</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.25668686</span><span class="punctuation">,</span> <span class="float-literal">-0.89237972</span><span class="punctuation">,</span> <span class="float-literal">-0.24121788</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">+0.58989127</span><span class="punctuation">,</span>  <span class="float-literal">0.7890047</span><span class="punctuation">,</span>   <span class="float-literal">0.1717553</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">+0.77134053</span><span class="punctuation">,</span> <span class="float-literal">-0.61351791</span><span class="punctuation">,</span>  <span class="float-literal">0.16920272</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.23887670</span><span class="punctuation">,</span> <span class="float-literal">-0.03267062</span><span class="punctuation">,</span>  <span class="float-literal">0.97050016</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_rotations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">+0.58989127</span><span class="punctuation">,</span>  <span class="float-literal">0.7168115</span><span class="punctuation">,</span>  <span class="float-literal">0.30665872</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">+0.77134053</span><span class="punctuation">,</span> <span class="float-literal">-0.70791757</span><span class="punctuation">,</span>  <span class="float-literal">0.19786539</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.23887670</span><span class="punctuation">,</span> <span class="float-literal">-0.00343595</span><span class="punctuation">,</span>  <span class="float-literal">0.94162826</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_rotations_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_rotations</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_weights</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_rotations_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_rotations</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_weights</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">x_rotations_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_rotations_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_x_rotations</span><span class="grouping">)</span>
    <span class="identifier">x_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_x_weights</span><span class="grouping">)</span>
    <span class="identifier">y_rotations_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_rotations_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_y_rotations</span><span class="grouping">)</span>
    <span class="identifier">y_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_y_weights</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_rotations_sign_flip</span><span class="punctuation">,</span> <span class="identifier">x_weights_sign_flip</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_rotations_sign_flip</span><span class="punctuation">,</span> <span class="identifier">y_weights_sign_flip</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_x_scores</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_y_scores</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sanity_check_pls_canonical_random</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sanity check for PLSCanonical on random data</span>
    <span class="comment"># The results were checked against the R-package plspm</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span>
    <span class="identifier">p_noise</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">q_noise</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="comment"># 2 latents vars:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">11</span><span class="grouping">)</span>
    <span class="identifier">l1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n</span><span class="grouping">)</span>
    <span class="identifier">l2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n</span><span class="grouping">)</span>
    <span class="identifier">latents</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">l1</span><span class="punctuation">,</span> <span class="identifier">l1</span><span class="punctuation">,</span> <span class="identifier">l2</span><span class="punctuation">,</span> <span class="identifier">l2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">latents</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span> <span class="arithmetic-operator">*</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">latents</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span> <span class="arithmetic-operator">*</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">p_noise</span> <span class="arithmetic-operator">*</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">p_noise</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">q_noise</span> <span class="arithmetic-operator">*</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">q_noise</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSCanonical</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">expected_x_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.65803719</span><span class="punctuation">,</span>  <span class="float-literal">0.19197924</span><span class="punctuation">,</span>  <span class="float-literal">0.21769083</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.7009113</span><span class="punctuation">,</span>  <span class="float-literal">0.13303969</span><span class="punctuation">,</span> <span class="float-literal">-0.15376699</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.13528197</span><span class="punctuation">,</span> <span class="float-literal">-0.68636408</span><span class="punctuation">,</span>  <span class="float-literal">0.13856546</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.16854574</span><span class="punctuation">,</span> <span class="float-literal">-0.66788088</span><span class="punctuation">,</span> <span class="float-literal">-0.12485304</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.03232333</span><span class="punctuation">,</span> <span class="float-literal">-0.04189855</span><span class="punctuation">,</span>  <span class="float-literal">0.40690153</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.1148816</span><span class="punctuation">,</span> <span class="float-literal">-0.09643158</span><span class="punctuation">,</span>  <span class="float-literal">0.1613305</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.04792138</span><span class="punctuation">,</span> <span class="float-literal">-0.02384992</span><span class="punctuation">,</span>  <span class="float-literal">0.17175319</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.06781</span><span class="punctuation">,</span> <span class="float-literal">-0.01666137</span><span class="punctuation">,</span> <span class="float-literal">-0.18556747</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.00266945</span><span class="punctuation">,</span> <span class="float-literal">-0.00160224</span><span class="punctuation">,</span>  <span class="float-literal">0.11893098</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.00849528</span><span class="punctuation">,</span> <span class="float-literal">-0.07706095</span><span class="punctuation">,</span>  <span class="float-literal">0.1570547</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.00949471</span><span class="punctuation">,</span> <span class="float-literal">-0.02964127</span><span class="punctuation">,</span>  <span class="float-literal">0.34657036</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.03572177</span><span class="punctuation">,</span>  <span class="float-literal">0.0945091</span><span class="punctuation">,</span>  <span class="float-literal">0.3414855</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.05584937</span><span class="punctuation">,</span> <span class="float-literal">-0.02028961</span><span class="punctuation">,</span> <span class="float-literal">-0.57682568</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.05744254</span><span class="punctuation">,</span> <span class="float-literal">-0.01482333</span><span class="punctuation">,</span> <span class="float-literal">-0.17431274</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_x_loadings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.65649254</span><span class="punctuation">,</span>  <span class="float-literal">0.1847647</span><span class="punctuation">,</span>  <span class="float-literal">0.15270699</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.67554234</span><span class="punctuation">,</span>  <span class="float-literal">0.15237508</span><span class="punctuation">,</span> <span class="float-literal">-0.09182247</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.19219925</span><span class="punctuation">,</span> <span class="float-literal">-0.67750975</span><span class="punctuation">,</span>  <span class="float-literal">0.08673128</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.2133631</span><span class="punctuation">,</span> <span class="float-literal">-0.67034809</span><span class="punctuation">,</span> <span class="float-literal">-0.08835483</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.03178912</span><span class="punctuation">,</span> <span class="float-literal">-0.06668336</span><span class="punctuation">,</span>  <span class="float-literal">0.43395268</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.15684588</span><span class="punctuation">,</span> <span class="float-literal">-0.13350241</span><span class="punctuation">,</span>  <span class="float-literal">0.20578984</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.03337736</span><span class="punctuation">,</span> <span class="float-literal">-0.03807306</span><span class="punctuation">,</span>  <span class="float-literal">0.09871553</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.06199844</span><span class="punctuation">,</span>  <span class="float-literal">0.01559854</span><span class="punctuation">,</span> <span class="float-literal">-0.1881785</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.00406146</span><span class="punctuation">,</span> <span class="float-literal">-0.00587025</span><span class="punctuation">,</span>  <span class="float-literal">0.16413253</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.00374239</span><span class="punctuation">,</span> <span class="float-literal">-0.05848466</span><span class="punctuation">,</span>  <span class="float-literal">0.19140336</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.00139214</span><span class="punctuation">,</span> <span class="float-literal">-0.01033161</span><span class="punctuation">,</span>  <span class="float-literal">0.32239136</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.05292828</span><span class="punctuation">,</span>  <span class="float-literal">0.0953533</span><span class="punctuation">,</span>  <span class="float-literal">0.31916881</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.04031924</span><span class="punctuation">,</span> <span class="float-literal">-0.01961045</span><span class="punctuation">,</span> <span class="float-literal">-0.65174036</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.06172484</span><span class="punctuation">,</span> <span class="float-literal">-0.06597366</span><span class="punctuation">,</span> <span class="float-literal">-0.1244497</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.66101097</span><span class="punctuation">,</span>  <span class="float-literal">0.18672553</span><span class="punctuation">,</span>  <span class="float-literal">0.22826092</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.69347861</span><span class="punctuation">,</span>  <span class="float-literal">0.18463471</span><span class="punctuation">,</span> <span class="float-literal">-0.23995597</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.14462724</span><span class="punctuation">,</span> <span class="float-literal">-0.66504085</span><span class="punctuation">,</span>  <span class="float-literal">0.17082434</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.22247955</span><span class="punctuation">,</span> <span class="float-literal">-0.6932605</span><span class="punctuation">,</span> <span class="float-literal">-0.09832993</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.07035859</span><span class="punctuation">,</span>  <span class="float-literal">0.00714283</span><span class="punctuation">,</span>  <span class="float-literal">0.67810124</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.07765351</span><span class="punctuation">,</span> <span class="float-literal">-0.0105204</span><span class="punctuation">,</span> <span class="float-literal">-0.44108074</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.00917056</span><span class="punctuation">,</span>  <span class="float-literal">0.04322147</span><span class="punctuation">,</span>  <span class="float-literal">0.10062478</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.01909512</span><span class="punctuation">,</span>  <span class="float-literal">0.06182718</span><span class="punctuation">,</span>  <span class="float-literal">0.28830475</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.01756709</span><span class="punctuation">,</span>  <span class="float-literal">0.04797666</span><span class="punctuation">,</span>  <span class="float-literal">0.32225745</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">expected_y_loadings</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.68568625</span><span class="punctuation">,</span>  <span class="float-literal">0.1674376</span><span class="punctuation">,</span>  <span class="float-literal">0.0969508</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.68782064</span><span class="punctuation">,</span>  <span class="float-literal">0.20375837</span><span class="punctuation">,</span> <span class="float-literal">-0.1164448</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.11712173</span><span class="punctuation">,</span> <span class="float-literal">-0.68046903</span><span class="punctuation">,</span>  <span class="float-literal">0.12001505</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.17860457</span><span class="punctuation">,</span> <span class="float-literal">-0.6798319</span><span class="punctuation">,</span> <span class="float-literal">-0.05089681</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.06265739</span><span class="punctuation">,</span> <span class="float-literal">-0.0277703</span><span class="punctuation">,</span>  <span class="float-literal">0.74729584</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.0914178</span><span class="punctuation">,</span>  <span class="float-literal">0.00403751</span><span class="punctuation">,</span> <span class="float-literal">-0.5135078</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.02196918</span><span class="punctuation">,</span> <span class="float-literal">-0.01377169</span><span class="punctuation">,</span>  <span class="float-literal">0.09564505</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.03288952</span><span class="punctuation">,</span>  <span class="float-literal">0.09039729</span><span class="punctuation">,</span>  <span class="float-literal">0.31858973</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.04287624</span><span class="punctuation">,</span>  <span class="float-literal">0.05254676</span><span class="punctuation">,</span>  <span class="float-literal">0.27836841</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_loadings</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_x_weights</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_loadings</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">expected_y_weights</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">x_loadings_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_x_loadings</span><span class="grouping">)</span>
    <span class="identifier">x_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_x_weights</span><span class="grouping">)</span>
    <span class="identifier">y_weights_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_y_weights</span><span class="grouping">)</span>
    <span class="identifier">y_loadings_sign_flip</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_loadings_</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected_y_loadings</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_loadings_sign_flip</span><span class="punctuation">,</span> <span class="identifier">x_weights_sign_flip</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_loadings_sign_flip</span><span class="punctuation">,</span> <span class="identifier">y_weights_sign_flip</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_x_scores</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">x</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">_y_scores</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_convergence_fail</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure ConvergenceWarning is raised if max_iter is too small</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">pls_nipals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSCanonical</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pls_nipals</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">'ignore:.*scores_ was deprecated'</span><span class="grouping">)</span>  <span class="comment"># 1.1</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PLSSVD</span><span class="punctuation">,</span> <span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_attibutes_shapes</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure attributes are of the correct shape depending on n_components</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">attr</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_components</span>
               <span class="keyword">for</span> <span class="identifier">attr</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_scores_</span><span class="punctuation">,</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_scores_</span><span class="punctuation">,</span> <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_weights_</span><span class="punctuation">,</span>
                            <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">y_weights_</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="punctuation">,</span> <span class="identifier">CCA</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_univariate_equivalence</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure 2D Y with 1 column is equivalent to 1D Y</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">one_d_coeff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span>
    <span class="identifier">two_d_coeff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="keyword">assert</span> <span class="identifier">one_d_coeff</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">two_d_coeff</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">one_d_coeff</span><span class="punctuation">,</span> <span class="identifier">two_d_coeff</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="punctuation">,</span> <span class="identifier">CCA</span><span class="punctuation">,</span> <span class="identifier">PLSSVD</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_copy</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that the "copy" keyword works</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">X_orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># copy=True won't modify inplace</span>
    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_orig</span><span class="grouping">)</span>

    <span class="comment"># copy=False will modify inplace</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_orig</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">Est</span> <span class="relational-operator">is</span> <span class="identifier">PLSSVD</span><span class="punctuation">:</span>
        <span class="keyword">return</span>  <span class="comment"># PLSSVD does not support copy param in predict or transform</span>

    <span class="identifier">X_orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_orig</span><span class="grouping">)</span>

    <span class="identifier">X_orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_orig</span><span class="grouping">)</span>

    <span class="comment"># Make sure copy=True gives same transform and predictions as predict=False</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_generate_test_scale_and_stability_datasets</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Generate dataset for test_scale_and_stability"""</span>
    <span class="comment"># dataset for non-regression 7818</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">Q</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Q</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">1000</span>
    <span class="keyword">yield</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span>

    <span class="comment"># Data set where one of the features is constaint</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_linnerud</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="comment"># causes X[:, -1].std() to be zero</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
    <span class="keyword">yield</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">-0.2</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">6.2</span><span class="punctuation">,</span> <span class="float-literal">5.9</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">11.9</span><span class="punctuation">,</span> <span class="float-literal">12.3</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span>

    <span class="comment"># Seeds that provide a non-regression test for #18746, where CCA fails</span>
    <span class="identifier">seeds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">530</span><span class="punctuation">,</span> <span class="int-literal">741</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">seed</span> <span class="relational-operator">in</span> <span class="identifier">seeds</span><span class="punctuation">:</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">yield</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">CCA</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="punctuation">,</span> <span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSSVD</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'X, Y'</span><span class="punctuation">,</span> <span class="identifier">_generate_test_scale_and_stability_datasets</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_scale_and_stability</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""scale=True is equivalent to scale=False on centered/scaled data
    This allows to check numerical stability over platforms as well"""</span>

    <span class="identifier">X_s</span><span class="punctuation">,</span> <span class="identifier">Y_s</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_center_scale_xy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">X_score</span><span class="punctuation">,</span> <span class="identifier">Y_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">X_s_score</span><span class="punctuation">,</span> <span class="identifier">Y_s_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_s</span><span class="punctuation">,</span> <span class="identifier">Y_s</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_s_score</span><span class="punctuation">,</span> <span class="identifier">X_score</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Y_s_score</span><span class="punctuation">,</span> <span class="identifier">Y_score</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PLSSVD</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="punctuation">,</span> <span class="identifier">CCA</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_components'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_components_bounds</span><span class="grouping">(</span><span class="identifier">Est</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># n_components should be in [1, min(n_samples, n_features, n_targets)]</span>
    <span class="comment"># TODO: catch error instead of warning in 1.1</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"n_components=3 will be used instead"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="comment"># make sure upper bound of rank is used as a fallback</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_components'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_components_bounds_pls_regression</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For PLSRegression, the upper bound for n_components is n_features</span>
    <span class="comment"># TODO: catch error instead of warning in 1.1</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSRegression</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"n_components=5 will be used instead"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="comment"># make sure upper bound of rank is used as a fallback</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PLSSVD</span><span class="punctuation">,</span> <span class="identifier">CCA</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_scores_deprecations</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure x_scores_ and y_scores_ are deprecated.</span>
    <span class="comment"># It's not deprecated for PLSRegression because y_score_ is different from</span>
    <span class="comment"># transform(Y_train)</span>
    <span class="comment"># TODO: remove attributes and test in 1.1</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"x_scores_ was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">x_scores_</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"y_scores_ was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">y_scores_</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Est'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="punctuation">,</span> <span class="identifier">CCA</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_norm_y_weights_deprecation</span><span class="grouping">(</span><span class="identifier">Est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Est</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"norm_y_weights was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">norm_y_weights</span>


<span class="comment"># TODO: Remove test in 1.1</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="identifier">PLSRegression</span><span class="punctuation">,</span> <span class="identifier">PLSCanonical</span><span class="punctuation">,</span> <span class="identifier">CCA</span><span class="punctuation">,</span> <span class="identifier">PLSSVD</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'attribute'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">"x_mean_", "y_mean_", "x_std_", "y_std_"</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_mean_and_std_deprecation</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">attribute</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"{attribute} was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">attribute</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_samples, n_features'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_singular_value_helpers</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure SVD and power method give approximately the same results</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">u1</span><span class="punctuation">,</span> <span class="identifier">v1</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_first_singular_vectors_power_method</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>
                                                         <span class="identifier">norm_y_weights</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">u2</span><span class="punctuation">,</span> <span class="identifier">v2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_first_singular_vectors_svd</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">_svd_flip_1d</span><span class="grouping">(</span><span class="identifier">u1</span><span class="punctuation">,</span> <span class="identifier">v1</span><span class="grouping">)</span>
    <span class="identifier">_svd_flip_1d</span><span class="grouping">(</span><span class="identifier">u2</span><span class="punctuation">,</span> <span class="identifier">v2</span><span class="grouping">)</span>

    <span class="identifier">rtol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">u1</span><span class="punctuation">,</span> <span class="identifier">u2</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="identifier">rtol</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">v1</span><span class="punctuation">,</span> <span class="identifier">v2</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="identifier">rtol</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_one_component_equivalence</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># PLSSVD, PLSRegression and PLSCanonical should all be equivalent when</span>
    <span class="comment"># n_components is 1</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSRegression</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">canonical</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSCanonical</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">svd</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">svd</span><span class="punctuation">,</span> <span class="identifier">canonical</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_svd_flip_1d</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure svd_flip_1d is equivalent to svd_flip</span>
    <span class="identifier">u</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">u_expected</span><span class="punctuation">,</span> <span class="identifier">v_expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_flip</span><span class="grouping">(</span><span class="identifier">u</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">_svd_flip_1d</span><span class="grouping">(</span><span class="identifier">u</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">)</span>  <span class="comment"># inplace</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">u</span><span class="punctuation">,</span> <span class="identifier">u_expected</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">u</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">v_expected</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loadings_converges</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that CCA converges. Non-regression test for #19549."""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>

    <span class="identifier">cca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">cca</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># ConvergenceWarning is not raised</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">record</span>

    <span class="comment"># Loadings converges to reasonable values</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">cca</span><span class="punctuation">.</span><span class="identifier">x_loadings_</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pls_constant_y</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Checks warning when y is constant. Non-regression test for #19831"""</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="identifier">pls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PLSRegression</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Y residual is constant at iteration"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pls</span><span class="punctuation">.</span><span class="identifier">x_rotations_</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

    </pre>
  </body>
</html>