<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Authors: Lars Buitinck</span>
<span class="comment">#          Dan Blanchard &lt;dblanchard@ets.org&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">random</span> <span class="keyword">import</span> <span class="identifier">Random</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span> <span class="keyword">import</span> <span class="identifier">DictVectorizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_selection</span> <span class="keyword">import</span> <span class="identifier">SelectKBest</span><span class="punctuation">,</span> <span class="identifier">chi2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'sparse'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'dtype'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int16</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'sort'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'iterable'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_dictvectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">sort</span><span class="punctuation">,</span> <span class="identifier">iterable</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">"foo": 1, "bar"</span><span class="punctuation">:</span> <span class="int-literal">3</span><span class="grouping">}</span><span class="punctuation">,</span>
         <span class="grouping">{</span><span class="string-literal">"bar": 4, "baz"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="punctuation">,</span>
         <span class="grouping">{</span><span class="string-literal">"bar": 1, "quux": 1, "quuux"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">]</span>

    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">sort</span><span class="arithmetic-assignment">=</span><span class="identifier">sort</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">iter</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">iterable</span> <span class="keyword">else</span> <span class="identifier">D</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">sparse</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">14</span>
    <span class="keyword">assert</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">D</span>

    <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
        <span class="comment"># CSR matrices can't be compared for equality</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">iter</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">iterable</span>
                                            <span class="keyword">else</span> <span class="identifier">D</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">iter</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">iterable</span>
                                          <span class="keyword">else</span> <span class="identifier">D</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">sort</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">feature_names_</span> <span class="relational-operator">==</span>
                     <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">feature_names_</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_feature_selection</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make two feature dicts with two useful features and a bunch of useless</span>
    <span class="comment"># ones, in terms of chi2</span>
    <span class="identifier">d1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"useless%d"</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">useful1</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">useful2</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">d2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"useless%d"</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="identifier">useful1</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">useful2</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">indices</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">d1</span><span class="punctuation">,</span> <span class="identifier">d2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">d1</span><span class="punctuation">,</span> <span class="identifier">d2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">chi2</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">restrict</span><span class="grouping">(</span><span class="identifier">sel</span><span class="punctuation">.</span><span class="identifier">get_support</span><span class="grouping">(</span><span class="identifier">indices</span><span class="arithmetic-assignment">=</span><span class="identifier">indices</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="arithmetic-assignment">=</span><span class="identifier">indices</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="string-literal">"useful1", "useful2"</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_one_of_k</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">D_in</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">"version": "1", "ham"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="grouping">{</span><span class="string-literal">"version": "2", "spam"</span><span class="punctuation">:</span> <span class="float-literal">.3</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="grouping">{</span><span class="string-literal">"version=3": True, "spam"</span><span class="punctuation">:</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">D_in</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">D_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">D_out</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">{</span><span class="string-literal">"version=1": 1, "ham"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span>

    <span class="identifier">names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">"version=2"</span> <span class="relational-operator">in</span> <span class="identifier">names</span>
    <span class="keyword">assert</span> <span class="string-literal">"version"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">names</span>


<span class="keyword">def</span> <span class="identifier">test_iterable_value</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">D_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'ham', 'spam', 'version=1', 'version=2', 'version=3'</span><span class="grouping">]</span>
    <span class="identifier">X_expected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">D_in</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">"version": ["1", "2", "1"], "ham"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="grouping">{</span><span class="string-literal">"version": "2", "spam"</span><span class="punctuation">:</span> <span class="float-literal">.3</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="grouping">{</span><span class="string-literal">"version=3": True, "spam"</span><span class="punctuation">:</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">D_in</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_expected</span><span class="grouping">)</span>

    <span class="identifier">D_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">D_out</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">{</span><span class="string-literal">"version=1": 2, "version=2": 1, "ham"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span>

    <span class="identifier">names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">names</span> <span class="relational-operator">==</span> <span class="identifier">D_names</span>


<span class="keyword">def</span> <span class="identifier">test_iterable_not_string_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">error_value</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Unsupported type &lt;class 'int'&gt; in iterable value. "</span>
                   <span class="string-literal">"Only iterables of string are supported."</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'foo': '1', 'bar': '2'</span><span class="grouping">}</span><span class="punctuation">,</span>
          <span class="grouping">{</span><span class="string-literal">'foo': '3', 'baz': '1'</span><span class="grouping">}</span><span class="punctuation">,</span>
          <span class="grouping">{</span><span class="string-literal">'foo': [1, 'three'</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">error</span><span class="punctuation">:</span>
        <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">D2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">error</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">error_value</span>


<span class="keyword">def</span> <span class="identifier">test_mapping_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">error_value</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Unsupported value type &lt;class 'dict'&gt; "</span>
                   <span class="string-literal">"for foo: {'one': 1, 'three': 3}.\n"</span>
                   <span class="string-literal">"Mapping objects are not supported."</span><span class="grouping">)</span>
    <span class="identifier">D2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'foo': '1', 'bar': '2'</span><span class="grouping">}</span><span class="punctuation">,</span>
          <span class="grouping">{</span><span class="string-literal">'foo': '3', 'baz': '1'</span><span class="grouping">}</span><span class="punctuation">,</span>
          <span class="grouping">{</span><span class="string-literal">'foo': {'one': 1, 'three'</span><span class="punctuation">:</span> <span class="int-literal">3</span><span class="grouping">}</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">error</span><span class="punctuation">:</span>
        <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">D2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">error</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">error_value</span>


<span class="keyword">def</span> <span class="identifier">test_unseen_or_no_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">"camelot": 0, "spamalot"</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">sparse</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">D</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"push the pram a lot"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">{</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">ValueError</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="string-literal">"empty"</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">e</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_deterministic_vocabulary</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Generate equal dictionaries with different memory layouts</span>
    <span class="identifier">items</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"%03d"</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Random</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">d_sorted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">items</span><span class="grouping">)</span>
    <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">items</span><span class="grouping">)</span>
    <span class="identifier">d_shuffled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">items</span><span class="grouping">)</span>

    <span class="comment"># check that the memory layout does not impact the resulting vocabulary</span>
    <span class="identifier">v_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">d_sorted</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">v_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">d_shuffled</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">v_1</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span> <span class="relational-operator">==</span> <span class="identifier">v_2</span><span class="punctuation">.</span><span class="identifier">vocabulary_</span>


<span class="keyword">def</span> <span class="identifier">test_n_features_in</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For vectorizers, n_features_in_ does not make sense and does not exist.</span>
    <span class="identifier">dv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">dv</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'foo': 1, 'bar': 2}, {'foo': 3, 'baz'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">dv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">dv</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dictvectorizer_dense_sparse_equivalence</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the equivalence between between sparse and dense DictVectorizer.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/19978
    """</span>
    <span class="identifier">movie_entry_fit</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="grouping">{</span><span class="string-literal">"category": ["thriller", "drama"], "year"</span><span class="punctuation">:</span> <span class="int-literal">2003</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">"category": ["animation", "family"], "year"</span><span class="punctuation">:</span> <span class="int-literal">2011</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">"year"</span><span class="punctuation">:</span> <span class="int-literal">1974</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
    <span class="identifier">movie_entry_transform</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">"category": ["thriller"], "unseen_feature": "3"</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="identifier">dense_vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">sparse_vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DictVectorizer</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">dense_vector_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dense_vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">movie_entry_fit</span><span class="grouping">)</span>
    <span class="identifier">sparse_vector_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">movie_entry_fit</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">dense_vector_fit</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">sparse_vector_fit</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dense_vector_fit</span><span class="punctuation">,</span> <span class="identifier">sparse_vector_fit</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">dense_vector_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dense_vectorizer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">movie_entry_transform</span><span class="grouping">)</span>
    <span class="identifier">sparse_vector_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_vectorizer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span>
        <span class="identifier">movie_entry_transform</span>
    <span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">dense_vector_transform</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">sparse_vector_transform</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dense_vector_transform</span><span class="punctuation">,</span> <span class="identifier">sparse_vector_transform</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">dense_inverse_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dense_vectorizer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span>
        <span class="identifier">dense_vector_transform</span>
    <span class="grouping">)</span>
    <span class="identifier">sparse_inverse_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_vectorizer</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span>
        <span class="identifier">sparse_vector_transform</span>
    <span class="grouping">)</span>

    <span class="identifier">expected_inverse</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">"category=thriller"</span><span class="punctuation">:</span> <span class="float-literal">1.0</span><span class="grouping">}</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">dense_inverse_transform</span> <span class="relational-operator">==</span> <span class="identifier">expected_inverse</span>
    <span class="keyword">assert</span> <span class="identifier">sparse_inverse_transform</span> <span class="relational-operator">==</span> <span class="identifier">expected_inverse</span>

    </pre>
  </body>
</html>