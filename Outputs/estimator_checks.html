<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">types</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">from</span> <span class="identifier">copy</span> <span class="keyword">import</span> <span class="identifier">deepcopy</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span><span class="punctuation">,</span> <span class="identifier">wraps</span>
<span class="keyword">from</span> <span class="identifier">inspect</span> <span class="keyword">import</span> <span class="identifier">signature</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">rankdata</span>
<span class="keyword">import</span> <span class="identifier">joblib</span>

<span class="keyword">from</span> <span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">IS_PYPY</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">config_context</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">_get_args</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">set_random_state</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">SkipTest</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">create_memmap_backed_data</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span>
<span class="keyword">from</span> <span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">is_scalar_nan</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Ridge</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">clone</span><span class="punctuation">,</span>
    <span class="identifier">ClusterMixin</span><span class="punctuation">,</span>
    <span class="identifier">is_classifier</span><span class="punctuation">,</span>
    <span class="identifier">is_regressor</span><span class="punctuation">,</span>
    <span class="identifier">is_outlier_detector</span><span class="punctuation">,</span>
    <span class="identifier">RegressorMixin</span><span class="punctuation">,</span>
    <span class="identifier">_is_pairwise</span><span class="punctuation">,</span>
<span class="grouping">)</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">accuracy_score</span><span class="punctuation">,</span> <span class="identifier">adjusted_rand_score</span><span class="punctuation">,</span> <span class="identifier">f1_score</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">random_projection</span> <span class="keyword">import</span> <span class="identifier">BaseRandomProjection</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">feature_selection</span> <span class="keyword">import</span> <span class="identifier">SelectKBest</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">DataConversionWarning</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">SkipTestWarning</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">ShuffleSplit</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">model_selection</span><span class="punctuation">.</span><span class="identifier">_validation</span> <span class="keyword">import</span> <span class="identifier">_safe_split</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">rbf_kernel</span><span class="punctuation">,</span> <span class="identifier">linear_kernel</span><span class="punctuation">,</span> <span class="identifier">pairwise_distances</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="keyword">import</span> <span class="identifier">shuffle</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_tags</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">_DEFAULT_TAGS</span><span class="punctuation">,</span>
    <span class="identifier">_safe_tags</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">has_fit_parameter</span><span class="punctuation">,</span> <span class="identifier">_num_samples</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">scale</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">load_iris</span><span class="punctuation">,</span>
    <span class="identifier">make_blobs</span><span class="punctuation">,</span>
    <span class="identifier">make_multilabel_classification</span><span class="punctuation">,</span>
    <span class="identifier">make_regression</span>
<span class="grouping">)</span>

<span class="identifier">REGRESSION_DATASET</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
<span class="identifier">CROSS_DECOMPOSITION</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'PLSCanonical', 'PLSRegression', 'CCA', 'PLSSVD'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">_yield_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">pairwise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="keyword">yield</span> <span class="identifier">check_no_attributes_set_in_init</span>
    <span class="keyword">yield</span> <span class="identifier">check_estimators_dtypes</span>
    <span class="keyword">yield</span> <span class="identifier">check_fit_score_takes_y</span>
    <span class="keyword">yield</span> <span class="identifier">check_sample_weights_pandas_series</span>
    <span class="keyword">yield</span> <span class="identifier">check_sample_weights_not_an_array</span>
    <span class="keyword">yield</span> <span class="identifier">check_sample_weights_list</span>
    <span class="keyword">yield</span> <span class="identifier">check_sample_weights_shape</span>
    <span class="keyword">if</span> <span class="identifier">has_fit_parameter</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"sample_weight"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">pairwise</span><span class="punctuation">:</span>
        <span class="comment"># We skip pairwise because the data is not pairwise</span>
        <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_sample_weights_invariance</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ones'</span><span class="grouping">)</span>
        <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_sample_weights_invariance</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'zeros'</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="identifier">check_estimators_fit_returns_self</span>
    <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_estimators_fit_returns_self</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># Check that all estimator yield informative messages when</span>
    <span class="comment"># trained on empty datasets</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_complex_data</span>
        <span class="keyword">yield</span> <span class="identifier">check_dtype_object</span>
        <span class="keyword">yield</span> <span class="identifier">check_estimators_empty_data_messages</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
        <span class="comment"># cross-decomposition's "transform" returns X and Y</span>
        <span class="keyword">yield</span> <span class="identifier">check_pipeline_consistency</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"allow_nan"] and not tags["no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># Test that all estimators check their input for NaN's and infs</span>
        <span class="keyword">yield</span> <span class="identifier">check_estimators_nan_inf</span>

    <span class="keyword">if</span> <span class="identifier">pairwise</span><span class="punctuation">:</span>
        <span class="comment"># Check that pairwise estimator throws error on non-square input</span>
        <span class="keyword">yield</span> <span class="identifier">check_nonsquare_error</span>

    <span class="keyword">yield</span> <span class="identifier">check_estimators_overwrite_params</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'sparsify'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_sparsify_coefficients</span>

    <span class="keyword">yield</span> <span class="identifier">check_estimator_sparse_data</span>

    <span class="comment"># Test that estimators can be pickled, and once pickled</span>
    <span class="comment"># give the same answer as before.</span>
    <span class="keyword">yield</span> <span class="identifier">check_estimators_pickle</span>

    <span class="keyword">yield</span> <span class="identifier">check_estimator_get_tags_default_keys</span>

<span class="keyword">def</span> <span class="identifier">_yield_classifier_checks</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>

    <span class="comment"># test classifiers can handle non-array data and pandas objects</span>
    <span class="keyword">yield</span> <span class="identifier">check_classifier_data_not_an_array</span>
    <span class="comment"># test classifiers trained on a single label always return this label</span>
    <span class="keyword">yield</span> <span class="identifier">check_classifiers_one_label</span>
    <span class="keyword">yield</span> <span class="identifier">check_classifiers_classes</span>
    <span class="keyword">yield</span> <span class="identifier">check_estimators_partial_fit_n_features</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"multioutput"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_classifier_multioutput</span>
    <span class="comment"># basic consistency testing</span>
    <span class="keyword">yield</span> <span class="identifier">check_classifiers_train</span>
    <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_classifiers_train</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_classifiers_train</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                  <span class="identifier">X_dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="identifier">check_classifiers_regression_target</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"multilabel"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_classifiers_multilabel_representation_invariance</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_supervised_y_no_nan</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'multioutput_only'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check_supervised_y_2d</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"requires_fit"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_estimators_unfitted</span>
    <span class="keyword">if</span> <span class="string-literal">'class_weight'</span> <span class="relational-operator">in</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_class_weight_classifiers</span>

    <span class="keyword">yield</span> <span class="identifier">check_non_transformer_estimators_n_iter</span>
    <span class="comment"># test if predict_proba is a monotonic transformation of decision_function</span>
    <span class="keyword">yield</span> <span class="identifier">check_decision_proba_consistency</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_supervised_y_no_nan</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks that the Estimator targets are not NaN.</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">888</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">match</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Input contains NaN, infinity or a value too large for "</span>
        <span class="identifier">r</span><span class="string-literal">"dtype\('float64'\)."</span>
    <span class="grouping">)</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Estimator {name} should have raised error on fitting "</span>
        <span class="string-literal">"array y with NaN value."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">match</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_yield_regressor_checks</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="grouping">)</span>
    <span class="comment"># TODO: test with intercept</span>
    <span class="comment"># TODO: test with multiple responses</span>
    <span class="comment"># basic testing</span>
    <span class="keyword">yield</span> <span class="identifier">check_regressors_train</span>
    <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_regressors_train</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_regressors_train</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                  <span class="identifier">X_dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="identifier">check_regressor_data_not_an_array</span>
    <span class="keyword">yield</span> <span class="identifier">check_estimators_partial_fit_n_features</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"multioutput"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_regressor_multioutput</span>
    <span class="keyword">yield</span> <span class="identifier">check_regressors_no_decision_function</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'multioutput_only'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_supervised_y_2d</span>
    <span class="keyword">yield</span> <span class="identifier">check_supervised_y_no_nan</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">!=</span> <span class="string-literal">'CCA'</span><span class="punctuation">:</span>
        <span class="comment"># check that the regressor handles int input</span>
        <span class="keyword">yield</span> <span class="identifier">check_regressors_int</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"requires_fit"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_estimators_unfitted</span>
    <span class="keyword">yield</span> <span class="identifier">check_non_transformer_estimators_n_iter</span>


<span class="keyword">def</span> <span class="identifier">_yield_transformer_checks</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="grouping">)</span>
    <span class="comment"># All transformers should either deal with sparse data or raise an</span>
    <span class="comment"># exception with type TypeError and an intelligible error message</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_transformer_data_not_an_array</span>
    <span class="comment"># these don't actually fit the data, so don't raise errors</span>
    <span class="keyword">yield</span> <span class="identifier">check_transformer_general</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"preserves_dtype"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_transformer_preserve_dtypes</span>
    <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_transformer_general</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"stateless"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_transformers_unfitted</span>
    <span class="comment"># Dependent on external solvers and hence accessing the iter</span>
    <span class="comment"># param is non-trivial.</span>
    <span class="identifier">external_solver</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'Isomap', 'KernelPCA', 'LocallyLinearEmbedding'</span><span class="punctuation">,</span>
                       <span class="string-literal">'RandomizedLasso', 'LogisticRegressionCV'</span><span class="grouping">]</span>

    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">external_solver</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_transformer_n_iter</span>


<span class="keyword">def</span> <span class="identifier">_yield_clustering_checks</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">yield</span> <span class="identifier">check_clusterer_compute_labels_predict</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'WardAgglomeration'</span><span class="punctuation">,</span> <span class="string-literal">"FeatureAgglomeration"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># this is clustering on the features</span>
        <span class="comment"># let's not test that here.</span>
        <span class="keyword">yield</span> <span class="identifier">check_clustering</span>
        <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_clustering</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">yield</span> <span class="identifier">check_estimators_partial_fit_n_features</span>
    <span class="keyword">yield</span> <span class="identifier">check_non_transformer_estimators_n_iter</span>


<span class="keyword">def</span> <span class="identifier">_yield_outliers_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="comment"># checks for outlier detectors that have a fit_predict method</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'fit_predict'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_outliers_fit_predict</span>

    <span class="comment"># checks for estimators that can be used on a test set</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_outliers_train</span>
        <span class="keyword">yield</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check_outliers_train</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="comment"># test outlier detectors can handle non-array data</span>
        <span class="keyword">yield</span> <span class="identifier">check_classifier_data_not_an_array</span>
        <span class="comment"># test if NotFittedError is raised</span>
        <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"requires_fit"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check_estimators_unfitted</span>


<span class="keyword">def</span> <span class="identifier">_yield_all_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">"2darray" not in tags["X_types"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Can't test estimator {} which requires input "</span>
                      <span class="string-literal">" of type {}".format(name, tags["X_types"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">SkipTestWarning</span><span class="grouping">)</span>
        <span class="keyword">return</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"_skip_test"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Explicit SKIP via _skip_test tag for estimator "</span>
                      <span class="string-literal">"{}."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">SkipTestWarning</span><span class="grouping">)</span>
        <span class="keyword">return</span>

    <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check</span>
    <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_classifier_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check</span>
    <span class="keyword">if</span> <span class="identifier">is_regressor</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_regressor_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'transform'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_transformer_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">ClusterMixin</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_clustering_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check</span>
    <span class="keyword">if</span> <span class="identifier">is_outlier_detector</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_outliers_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check</span>
    <span class="keyword">yield</span> <span class="identifier">check_parameters_default_constructible</span>
    <span class="keyword">yield</span> <span class="identifier">check_methods_sample_order_invariance</span>
    <span class="keyword">yield</span> <span class="identifier">check_methods_subset_invariance</span>
    <span class="keyword">yield</span> <span class="identifier">check_fit2d_1sample</span>
    <span class="keyword">yield</span> <span class="identifier">check_fit2d_1feature</span>
    <span class="keyword">yield</span> <span class="identifier">check_get_params_invariance</span>
    <span class="keyword">yield</span> <span class="identifier">check_set_params</span>
    <span class="keyword">yield</span> <span class="identifier">check_dict_unchanged</span>
    <span class="keyword">yield</span> <span class="identifier">check_dont_overwrite_parameters</span>
    <span class="keyword">yield</span> <span class="identifier">check_fit_idempotent</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_n_features_in</span>
        <span class="keyword">yield</span> <span class="identifier">check_fit1d</span>
        <span class="keyword">yield</span> <span class="identifier">check_fit2d_predict1d</span>
        <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"requires_y"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">yield</span> <span class="identifier">check_requires_y_none</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"requires_positive_X"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">check_fit_non_negative</span>


<span class="keyword">def</span> <span class="identifier">_get_check_estimator_ids</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Create pytest ids for checks.

    When `obj` is an estimator, this returns the pprint version of the
    estimator (with `print_changed_only=True`). When `obj` is a function, the
    name of the function is returned with its keyword arguments.

    `_get_check_estimator_ids` is designed to be used as the `id` in
    `pytest.mark.parametrize` where `check_estimator(..., generate_only=True)`
    is yielding estimators and checks.

    Parameters
    ----------
    obj : estimator or function
        Items generated by `check_estimator`.

    Returns
    -------
    id : str or None

    See Also
    --------
    check_estimator
    """</span>
    <span class="keyword">if</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">obj</span><span class="punctuation">,</span> <span class="identifier">partial</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">__name__</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">keywords</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">func</span><span class="punctuation">.</span><span class="identifier">__name__</span>

        <span class="identifier">kwstring</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">",".join(["{}={}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">)</span>
                             <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">keywords</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="string-literal">"{}({})"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">func</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">kwstring</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">obj</span><span class="punctuation">,</span> <span class="string-literal">"get_params"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">print_changed_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">sub</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"\s", ""</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_construct_instance</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Construct Estimator instance if possible."""</span>
    <span class="identifier">required_parameters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="string-literal">"_required_parameters"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">required_parameters</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">required_parameters</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"estimator"], ["base_estimator"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">RegressorMixin</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">required_parameters</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Heterogeneous ensemble classes (i.e. stacking, voting)</span>
            <span class="keyword">if</span> <span class="identifier">issubclass</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">RegressorMixin</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
                    <span class="grouping">(</span><span class="string-literal">"est1"</span><span class="punctuation">,</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">"est2"</span><span class="punctuation">,</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
                    <span class="grouping">(</span><span class="string-literal">"est1"</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">(</span><span class="string-literal">"est2"</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Can't instantiate estimator {Estimator.__name__} "</span>
                   <span class="identifier">f</span><span class="string-literal">"parameters {required_parameters}"</span><span class="grouping">)</span>
            <span class="comment"># raise additional warning to be shown by pytest</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">msg</span><span class="punctuation">,</span> <span class="identifier">SkipTestWarning</span><span class="grouping">)</span>
            <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">estimator</span>


<span class="keyword">def</span> <span class="identifier">_maybe_mark_xfail</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="punctuation">,</span> <span class="identifier">pytest</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Mark (estimator, check) pairs as XFAIL if needed (see conditions in</span>
    <span class="comment"># _should_be_skipped_or_marked())</span>
    <span class="comment"># This is similar to _maybe_skip(), but this one is used by</span>
    <span class="comment"># @parametrize_with_checks() instead of check_estimator()</span>

    <span class="identifier">should_be_marked</span><span class="punctuation">,</span> <span class="identifier">reason</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_should_be_skipped_or_marked</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">should_be_marked</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">param</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="punctuation">,</span>
                            <span class="identifier">marks</span><span class="arithmetic-assignment">=</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">xfail</span><span class="grouping">(</span><span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="identifier">reason</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_maybe_skip</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Wrap a check so that it's skipped if needed (see conditions in</span>
    <span class="comment"># _should_be_skipped_or_marked())</span>
    <span class="comment"># This is similar to _maybe_mark_xfail(), but this one is used by</span>
    <span class="comment"># check_estimator() instead of @parametrize_with_checks which requires</span>
    <span class="comment"># pytest</span>
    <span class="identifier">should_be_skipped</span><span class="punctuation">,</span> <span class="identifier">reason</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_should_be_skipped_or_marked</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">should_be_skipped</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">check</span>

    <span class="identifier">check_name</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">check</span><span class="punctuation">.</span><span class="identifier">func</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">check</span><span class="punctuation">,</span> <span class="identifier">partial</span><span class="grouping">)</span>
                  <span class="keyword">else</span> <span class="identifier">check</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">wraps</span><span class="grouping">(</span><span class="identifier">check</span><span class="grouping">)</span>
    <span class="keyword">def</span> <span class="identifier">wrapped</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span>
            <span class="identifier">f</span><span class="string-literal">"Skipping {check_name} for {estimator.__class__.__name__}: "</span>
            <span class="identifier">f</span><span class="string-literal">"{reason}"</span>
        <span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">wrapped</span>


<span class="keyword">def</span> <span class="identifier">_should_be_skipped_or_marked</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Return whether a check should be skipped (when using check_estimator())</span>
    <span class="comment"># or marked as XFAIL (when using @parametrize_with_checks()), along with a</span>
    <span class="comment"># reason.</span>
    <span class="comment"># Currently, a check should be skipped or marked if</span>
    <span class="comment"># the check is in the _xfail_checks tag of the estimator</span>

    <span class="identifier">check_name</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">check</span><span class="punctuation">.</span><span class="identifier">func</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">check</span><span class="punctuation">,</span> <span class="identifier">partial</span><span class="grouping">)</span>
                  <span class="keyword">else</span> <span class="identifier">check</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="identifier">xfail_checks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'_xfail_checks'</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="grouping">{</span><span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">check_name</span> <span class="relational-operator">in</span> <span class="identifier">xfail_checks</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">xfail_checks</span><span class="grouping">[</span><span class="identifier">check_name</span><span class="grouping">]</span>

    <span class="keyword">return</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="string-literal">'placeholder reason that will never be used'</span>


<span class="keyword">def</span> <span class="identifier">parametrize_with_checks</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Pytest specific decorator for parametrizing estimator checks.

    The `id` of each check is set to be a pprint version of the estimator
    and the name of the check with its keyword arguments.
    This allows to use `pytest -k` to specify which tests to run::

        pytest test_check_estimators.py -k check_estimators_fit_returns_self

    Parameters
    ----------
    estimators : list of estimators instances
        Estimators to generated checks for.

        .. versionchanged:: 0.24
           Passing a class was deprecated in version 0.23, and support for
           classes was removed in 0.24. Pass an instance instead.

        .. versionadded:: 0.24

    Returns
    -------
    decorator : `pytest.mark.parametrize`

    Examples
    --------
    &gt;&gt;&gt; from sklearn.utils.estimator_checks import parametrize_with_checks
    &gt;&gt;&gt; from sklearn.linear_model import LogisticRegression
    &gt;&gt;&gt; from sklearn.tree import DecisionTreeRegressor

    &gt;&gt;&gt; @parametrize_with_checks([LogisticRegression(),
    ...                           DecisionTreeRegressor()])
    ... def test_sklearn_compatible_estimator(estimator, check):
    ...     check(estimator)

    """</span>
    <span class="keyword">import</span> <span class="identifier">pytest</span>

    <span class="keyword">if</span> <span class="identifier">any</span><span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Passing a class was deprecated in version 0.23 "</span>
               <span class="string-literal">"and isn't supported anymore from 0.24."</span>
               <span class="string-literal">"Please pass an instance instead."</span><span class="grouping">)</span>
        <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">checks_generator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">estimator</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">:</span>
            <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__name__</span>
            <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_all_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">check</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="grouping">)</span>
                <span class="keyword">yield</span> <span class="identifier">_maybe_mark_xfail</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="punctuation">,</span> <span class="identifier">pytest</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"estimator, check"</span><span class="punctuation">,</span> <span class="identifier">checks_generator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="identifier">_get_check_estimator_ids</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_estimator</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">generate_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check if estimator adheres to scikit-learn conventions.

    This estimator will run an extensive test-suite for input validation,
    shapes, etc, making sure that the estimator complies with `scikit-learn`
    conventions as detailed in :ref:`rolling_your_own_estimator`.
    Additional tests for classifiers, regressors, clustering or transformers
    will be run if the Estimator class inherits from the corresponding mixin
    from sklearn.base.

    Setting `generate_only=True` returns a generator that yields (estimator,
    check) tuples where the check can be called independently from each
    other, i.e. `check(estimator)`. This allows all checks to be run
    independently and report the checks that are failing.

    scikit-learn provides a pytest specific decorator,
    :func:`~sklearn.utils.parametrize_with_checks`, making it easier to test
    multiple estimators.

    Parameters
    ----------
    Estimator : estimator object
        Estimator instance to check.

        .. versionchanged:: 0.24
           Passing a class was deprecated in version 0.23, and support for
           classes was removed in 0.24.

    generate_only : bool, default=False
        When `False`, checks are evaluated when `check_estimator` is called.
        When `True`, `check_estimator` returns a generator that yields
        (estimator, check) tuples. The check is run by calling
        `check(estimator)`.

        .. versionadded:: 0.22

    Returns
    -------
    checks_generator : generator
        Generator that yields (estimator, check) tuples. Returned when
        `generate_only=True`.
    """</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Passing a class was deprecated in version 0.23 "</span>
               <span class="string-literal">"and isn't supported anymore from 0.24."</span>
               <span class="string-literal">"Please pass an instance instead."</span><span class="grouping">)</span>
        <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__name__</span>

    <span class="keyword">def</span> <span class="identifier">checks_generator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">_yield_all_checks</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">check</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_maybe_skip</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="grouping">)</span>
            <span class="keyword">yield</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">check</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">generate_only</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">checks_generator</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">check</span> <span class="relational-operator">in</span> <span class="identifier">checks_generator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">check</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">SkipTest</span> <span class="keyword">as</span> <span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="punctuation">:</span>
            <span class="comment"># SkipTest is thrown when pandas can't be imported, or by checks</span>
            <span class="comment"># that are in the xfail_checks tag</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">(</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">SkipTestWarning</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">global</span> <span class="identifier">REGRESSION_DATASET</span>
    <span class="keyword">if</span> <span class="identifier">REGRESSION_DATASET</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span>
            <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
            <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
        <span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">REGRESSION_DATASET</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span>
    <span class="keyword">return</span> <span class="identifier">REGRESSION_DATASET</span>


<span class="keyword">def</span> <span class="identifier">_set_checking_parameters</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># set parameters to speed up some estimators and</span>
    <span class="comment"># avoid deprecated behaviour</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="keyword">if</span> <span class="grouping">(</span><span class="string-literal">"n_iter" in params and name != "TSNE"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">"max_iter"</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">min</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># LinearSVR, LinearSVC</span>
        <span class="keyword">if</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'LinearSVR', 'LinearSVC'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
        <span class="comment"># NMF</span>
        <span class="keyword">if</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">'NMF'</span><span class="punctuation">:</span>
            <span class="comment"># FIXME : init should be removed in 1.1</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvda'</span><span class="grouping">)</span>
        <span class="comment"># MLP</span>
        <span class="keyword">if</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'MLPClassifier', 'MLPRegressor'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">"n_resampling"</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="comment"># randomized lasso</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_resampling</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">"n_estimators"</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">min</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_estimators</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">"max_trials"</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="comment"># RANSAC</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_trials</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">"n_init"</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="comment"># K-Means</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'TruncatedSVD'</span><span class="punctuation">:</span>
        <span class="comment"># TruncatedSVD doesn't run with n_components = n_features</span>
        <span class="comment"># This is ugly :-/</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_best"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_best</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">"SelectFdr"</span><span class="punctuation">:</span>
        <span class="comment"># be tolerant of noisy datasets (not actually speed)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">"TheilSenRegressor"</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">max_subpopulation</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>

    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">BaseRandomProjection</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Due to the jl lemma and often very few samples, the number</span>
        <span class="comment"># of components of the random matrix projection will be probably</span>
        <span class="comment"># greater than the number of features.</span>
        <span class="comment"># So we impose a smaller number (avoid "auto" mode)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">SelectKBest</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># SelectKBest has a default of k=10</span>
        <span class="comment"># which is more feature than we have in most case.</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'HistGradientBoostingClassifier'</span><span class="punctuation">,</span>
                <span class="string-literal">'HistGradientBoostingRegressor'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># The default min_samples_leaf (20) isn't appropriate for small</span>
        <span class="comment"># datasets (only very shallow trees are built) that the checks use.</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'DummyClassifier'</span><span class="punctuation">:</span>
        <span class="comment"># the default strategy prior would output constant predictions and fail</span>
        <span class="comment"># for check_classifiers_predictions</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">'stratified'</span><span class="grouping">)</span>

    <span class="comment"># Speed-up by reducing the number of CV or splits for CV estimators</span>
    <span class="identifier">loo_cv</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'RidgeCV'</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">loo_cv</span> <span class="logical-operator">and</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'cv'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'n_splits'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'OneHotEncoder'</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">handle_unknown</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ignore'</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">_NotAnArray</span><span class="punctuation">:</span>
    <span class="comment">"""An object that is convertible to an array.

    Parameters
    ----------
    data : array-like
        The data.
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__array__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data</span>

    <span class="keyword">def</span> <span class="identifier">__array_function__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">func</span><span class="punctuation">,</span> <span class="identifier">types</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">func</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">"may_share_memory"</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="bool-literal">True</span>
        <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">"Don't want to call array_function {}!"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
            <span class="identifier">func</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_is_pairwise_metric</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Returns True if estimator accepts pairwise metric.

    Parameters
    ----------
    estimator : object
        Estimator object to test.

    Returns
    -------
    out : bool
        True if _pairwise is set to True and False otherwise.
    """</span>
    <span class="identifier">metric</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"metric"</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">bool</span><span class="grouping">(</span><span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">'precomputed'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">linear_kernel</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">if</span> <span class="identifier">_is_pairwise_metric</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">def</span> <span class="identifier">_generate_sparse_matrix</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Generate sparse matrices with {32,64}bit indices of diverse format.

        Parameters
        ----------
        X_csr: CSR Matrix
            Input matrix in CSR format.

        Returns
        -------
        out: iter(Matrices)
            In format['dok', 'lil', 'dia', 'bsr', 'csr', 'csc', 'coo',
            'coo_64', 'csc_64', 'csr_64']
    """</span>

    <span class="keyword">assert</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">==</span> <span class="string-literal">'csr'</span>
    <span class="keyword">yield</span> <span class="string-literal">'csr'</span><span class="punctuation">,</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">sparse_format</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'dok', 'lil', 'dia', 'bsr', 'csc', 'coo'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">yield</span> <span class="identifier">sparse_format</span><span class="punctuation">,</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">sparse_format</span><span class="grouping">)</span>

    <span class="comment"># Generate large indices matrix only if its supported by scipy</span>
    <span class="identifier">X_coo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="string-literal">'coo'</span><span class="grouping">)</span>
    <span class="identifier">X_coo</span><span class="punctuation">.</span><span class="identifier">row</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_coo</span><span class="punctuation">.</span><span class="identifier">row</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int64'</span><span class="grouping">)</span>
    <span class="identifier">X_coo</span><span class="punctuation">.</span><span class="identifier">col</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_coo</span><span class="punctuation">.</span><span class="identifier">col</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int64'</span><span class="grouping">)</span>
    <span class="keyword">yield</span> <span class="string-literal">"coo_64"</span><span class="punctuation">,</span> <span class="identifier">X_coo</span>

    <span class="keyword">for</span> <span class="identifier">sparse_format</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'csc', 'csr'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">sparse_format</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int64'</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int64'</span><span class="grouping">)</span>
        <span class="keyword">yield</span> <span class="identifier">sparse_format</span> <span class="arithmetic-operator">+</span> <span class="string-literal">"_64"</span><span class="punctuation">,</span> <span class="identifier">X</span>


<span class="keyword">def</span> <span class="identifier">check_estimator_sparse_data</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">&lt;</span> <span class="float-literal">.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">4</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">40</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="comment"># catch deprecation warnings</span>
    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">matrix_format</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="identifier">_generate_sparse_matrix</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># catch deprecation warnings</span>
        <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'Scaler', 'StandardScaler'</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">n</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="comment"># fit and predict</span>
        <span class="keyword">if</span> <span class="string-literal">"64"</span> <span class="relational-operator">in</span> <span class="identifier">matrix_format</span><span class="punctuation">:</span>
            <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"Estimator {name} doesn't seem to support {matrix_format} "</span>
                <span class="string-literal">"matrix, and is not failing gracefully, e.g. by using "</span>
                <span class="string-literal">"check_array(X, accept_large_sparse=False)"</span>
            <span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"Estimator {name} doesn't seem to fail gracefully on sparse "</span>
                <span class="string-literal">"data: error message should state explicitly that sparse "</span>
                <span class="string-literal">"input is not supported if this is not the case."</span>
            <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"sparse", "Sparse"</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="identifier">may_pass</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"predict"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'multioutput_only'</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="identifier">pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="identifier">pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'predict_proba'</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">probs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'binary_only'</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="identifier">expected_probs_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">expected_probs_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
                <span class="keyword">assert</span> <span class="identifier">probs</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">expected_probs_shape</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_sample_weights_pandas_series</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that estimators will accept a 'sample_weight' parameter of</span>
    <span class="comment"># type pandas.Series in the 'fit' function.</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">has_fit_parameter</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"sample_weight"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">import</span> <span class="identifier">pandas</span> <span class="keyword">as</span> <span class="identifier">pd</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"multioutput_only"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">ValueError</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Estimator {0} raises error if "</span>
                                 <span class="string-literal">"'sample_weight' parameter is of "</span>
                                 <span class="string-literal">"type pandas.Series"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span><span class="string-literal">"pandas is not installed: not testing for "</span>
                           <span class="string-literal">"input of type pandas.Series to class weight."</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_sample_weights_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that estimators will accept a 'sample_weight' parameter of</span>
    <span class="comment"># type _NotAnArray in the 'fit' function.</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">has_fit_parameter</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"sample_weight"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">12</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"multioutput_only"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_sample_weights_list</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that estimators will accept a 'sample_weight' parameter of</span>
    <span class="comment"># type list in the 'fit' function.</span>
    <span class="keyword">if</span> <span class="identifier">has_fit_parameter</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="string-literal">"sample_weight"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
        <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                          <span class="identifier">estimator_orig</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="int-literal">3</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span>
        <span class="comment"># Test that estimators don't raise any exception</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_sample_weights_shape</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that estimators raise an error if sample_weight</span>
    <span class="comment"># shape mismatches the input</span>
    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">has_fit_parameter</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="string-literal">"sample_weight"</span><span class="grouping">)</span> <span class="logical-operator">and</span>
            <span class="logical-operator">not</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                      <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_sample_weights_invariance</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ones"</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For kind="ones" check that the estimators yield same results for</span>
    <span class="comment"># unit weights and no weights</span>
    <span class="comment"># For kind="zeros" check that setting sample_weight to 0 is equivalent</span>
    <span class="comment"># to removing corresponding samples.</span>
    <span class="identifier">estimator1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">estimator2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                  <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'ones'</span><span class="punctuation">:</span>
        <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X1</span>
        <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y1</span>
        <span class="identifier">sw2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"For {name} sample_weight=None is not equivalent to "</span>
                   <span class="identifier">f</span><span class="string-literal">"sample_weight=ones"</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'zeros'</span><span class="punctuation">:</span>
        <span class="comment"># Construct a dataset that is very different to (X, y) if weights</span>
        <span class="comment"># are disregarded, but identical to (X, y) given weights.</span>
        <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">X1</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="int-literal">3</span> <span class="arithmetic-operator">-</span> <span class="identifier">y1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">sw2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">sw2</span><span class="grouping">[</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y1</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="identifier">sw2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="identifier">sw2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"For {name}, a zero sample_weight is not equivalent "</span>
                   <span class="identifier">f</span><span class="string-literal">"to removing the sample"</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># pragma: no cover</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span>

    <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator1</span><span class="punctuation">,</span> <span class="identifier">y1</span><span class="grouping">)</span>
    <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator2</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>

    <span class="identifier">estimator1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">estimator2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">y2</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sw2</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"predict", "predict_proba"</span><span class="punctuation">,</span>
                   <span class="string-literal">"decision_function", "transform"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator1</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
            <span class="identifier">X_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator2</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_pred1</span><span class="punctuation">,</span> <span class="identifier">X_pred2</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">UserWarning</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_dtype_object</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that estimators treat dtype object as numeric if possible</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">object</span><span class="grouping">)</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"predict"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"transform"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Unknown label type"</span><span class="punctuation">,</span> <span class="identifier">may_pass</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">object</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="string-literal">'string' not in tags['X_types'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'foo': 'bar'</span><span class="grouping">}</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"argument must be a string.* number"</span>
        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="comment"># Estimators supporting string will not call np.asarray to convert the</span>
        <span class="comment"># data to numeric and therefore, the error will not be raised.</span>
        <span class="comment"># Checking for each element dtype in the input array will be costly.</span>
        <span class="comment"># Refer to #11401 for full discussion.</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_complex_data</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="comment"># check that estimators raise an exception on providing complex data</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="complex-literal">1j</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Something both valid for classification and regression</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="complex-literal">1j</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Complex data not supported"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_dict_unchanged</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># this estimator raises</span>
    <span class="comment"># ValueError: Found array with 0 feature(s) (shape=(23, 0))</span>
    <span class="comment"># while a minimum of 1 is required.</span>
    <span class="comment"># error</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'SpectralCoclustering'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">return</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'RANSACRegressor'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_best"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_best</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                   <span class="string-literal">"predict_proba"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">dict_before</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__dict__</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__dict__</span> <span class="relational-operator">==</span> <span class="identifier">dict_before</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">'Estimator changes __dict__ during %s'</span> <span class="arithmetic-operator">%</span> <span class="identifier">method</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_is_public_parameter</span><span class="grouping">(</span><span class="identifier">attr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">attr</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">'_') or attr.endswith('_'</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_dont_overwrite_parameters</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that fit method only changes or sets private attributes</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="punctuation">,</span> <span class="string-literal">"deprecated_original"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># to not check deprecated classes</span>
        <span class="keyword">return</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">dict_before_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__dict__</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">dict_after_fit</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__dict__</span>

    <span class="identifier">public_keys_after_fit</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">key</span> <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">dict_after_fit</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>
                             <span class="keyword">if</span> <span class="identifier">_is_public_parameter</span><span class="grouping">(</span><span class="identifier">key</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">attrs_added_by_fit</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">key</span> <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">public_keys_after_fit</span>
                          <span class="keyword">if</span> <span class="identifier">key</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">dict_before_fit</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="comment"># check that fit doesn't add any public attribute</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">attrs_added_by_fit</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">'Estimator adds public attribute(s) during' ' the fit method.'</span>
            <span class="string-literal">' Estimators are only allowed to add private attributes'</span>
            <span class="string-literal">' either started with _ or ended'</span>
            <span class="string-literal">' with _ but %s added'</span>
            <span class="arithmetic-operator">%</span> <span class="string-literal">', '</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">attrs_added_by_fit</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check that fit doesn't change any public attribute</span>
    <span class="identifier">attrs_changed_by_fit</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">key</span> <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">public_keys_after_fit</span>
                            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">dict_before_fit</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span>
                                <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="identifier">dict_after_fit</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">attrs_changed_by_fit</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">'Estimator changes public attribute(s) during'</span>
            <span class="string-literal">' the fit method. Estimators are only allowed'</span>
            <span class="string-literal">' to change attributes started'</span>
            <span class="string-literal">' or ended with _, but'</span>
            <span class="string-literal">' %s changed'</span>
            <span class="arithmetic-operator">%</span> <span class="string-literal">', '</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">attrs_changed_by_fit</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_fit2d_predict1d</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check by fitting a 2d array and predicting with a 1d array</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                   <span class="string-literal">"predict_proba"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="string-literal">"Reshape your data"</span><span class="punctuation">,</span>
                                 <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_apply_on_subsets</span><span class="grouping">(</span><span class="identifier">func</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># apply function on the whole set and on mini batches</span>
    <span class="identifier">result_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">result_by_batch</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">func</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
                       <span class="keyword">for</span> <span class="identifier">batch</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="grouping">]</span>

    <span class="comment"># func can output tuple (e.g. score_samples)</span>
    <span class="keyword">if</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">result_full</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">tuple</span><span class="punctuation">:</span>
        <span class="identifier">result_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">result_full</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">result_by_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">result_by_batch</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">result_full</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">result_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">result_full</span><span class="punctuation">.</span><span class="identifier">A</span>
        <span class="identifier">result_by_batch</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">A</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">result_by_batch</span><span class="grouping">]</span>

    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">result_full</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">result_by_batch</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_methods_subset_invariance</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that method gives invariant results if applied</span>
    <span class="comment"># on mini batches or the whole set</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                   <span class="string-literal">"score_samples", "predict_proba"</span><span class="grouping">]</span><span class="punctuation">:</span>

        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"{method} of {name} is not invariant when applied "</span>
               <span class="string-literal">"to a subset."</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">result_full</span><span class="punctuation">,</span> <span class="identifier">result_by_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_apply_on_subsets</span><span class="grouping">(</span>
                <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">result_full</span><span class="punctuation">,</span> <span class="identifier">result_by_batch</span><span class="punctuation">,</span>
                            <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_methods_sample_order_invariance</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that method gives invariant results if applied</span>
    <span class="comment"># on a subset with different sample order</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'binary_only'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                   <span class="string-literal">"score_samples", "predict_proba"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"{method} of {name} is not invariant when applied to a dataset"</span>
               <span class="string-literal">"with different sample order."</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                                         <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                         <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-9</span><span class="punctuation">,</span>
                                         <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_fit2d_1sample</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that fitting a 2d array with only one sample either works or</span>
    <span class="comment"># returns an informative message. The error message should either mention</span>
    <span class="comment"># the number of samples or the number of classes.</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># min_cluster_size cannot be less than the data size for OPTICS.</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'OPTICS'</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">min_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">msgs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"1 sample", "n_samples = 1", "n_samples=1", "one sample"</span><span class="punctuation">,</span>
            <span class="string-literal">"1 class", "one class"</span><span class="grouping">]</span>

    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msgs</span><span class="punctuation">,</span> <span class="identifier">may_pass</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_fit2d_1feature</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check fitting a 2d array with only 1 feature either works or returns</span>
    <span class="comment"># informative message</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="comment"># ensure two labels in subsample for RandomizedLogisticRegression</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'RandomizedLogisticRegression'</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">sample_fraction</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="comment"># ensure non skipped trials for RANSACRegressor</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'RANSACRegressor'</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">residual_threshold</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">msgs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">r</span><span class="string-literal">"1 feature\(s\)", "n_features = 1", "n_features=1"</span><span class="grouping">]</span>

    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msgs</span><span class="punctuation">,</span> <span class="identifier">may_pass</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_fit1d</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check fitting 1d X array raises a ValueError</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_components"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_transformer_general</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">readonly_memmap</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">_check_transformer</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_transformer_data_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># We need to make sure that we have non negative data, for things</span>
    <span class="comment"># like NMF</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="float-literal">.1</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="grouping">)</span>
    <span class="identifier">this_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">this_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">_check_transformer</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">this_X</span><span class="punctuation">,</span> <span class="identifier">this_y</span><span class="grouping">)</span>
    <span class="comment"># try the same with some list</span>
    <span class="identifier">_check_transformer</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_transformers_unfitted</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">transformer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"The unfitted "</span>
        <span class="identifier">f</span><span class="string-literal">"transformer {name} does not raise an error when "</span>
        <span class="string-literal">"transform is called. Perhaps use "</span>
        <span class="string-literal">"check_is_fitted in transform."</span><span class="punctuation">,</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_check_transformer</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer_orig</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">transformer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">transformer_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="grouping">)</span>

    <span class="comment"># fit</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">y_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">2</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_NotAnArray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">y_</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>

    <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>
    <span class="comment"># fit_transform method should work on non fitted estimator</span>
    <span class="identifier">transformer_clone</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="grouping">)</span>
    <span class="identifier">X_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer_clone</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">y_</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_pred</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">x_pred</span> <span class="relational-operator">in</span> <span class="identifier">X_pred</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">x_pred</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="comment"># check for consistent n_samples</span>
        <span class="keyword">assert</span> <span class="identifier">X_pred</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="punctuation">,</span> <span class="string-literal">'transform'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
            <span class="identifier">X_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>
            <span class="identifier">X_pred3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">y_</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">X_pred3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">y_</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">transformer_orig</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'non_deterministic'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">name</span> <span class="arithmetic-operator">+</span> <span class="string-literal">' is non deterministic'</span>
            <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_pred</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_pred2</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">x_pred</span><span class="punctuation">,</span> <span class="identifier">x_pred2</span><span class="punctuation">,</span> <span class="identifier">x_pred3</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">X_pred</span><span class="punctuation">,</span> <span class="identifier">X_pred2</span><span class="punctuation">,</span> <span class="identifier">X_pred3</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
                    <span class="identifier">x_pred</span><span class="punctuation">,</span> <span class="identifier">x_pred2</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span>
                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fit_transform and transform outcomes "</span>
                            <span class="string-literal">"not consistent in %s"</span>
                    <span class="arithmetic-operator">%</span> <span class="identifier">transformer</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
                    <span class="identifier">x_pred</span><span class="punctuation">,</span> <span class="identifier">x_pred3</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span>
                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"consecutive fit_transform outcomes "</span>
                            <span class="string-literal">"not consistent in %s"</span>
                    <span class="arithmetic-operator">%</span> <span class="identifier">transformer</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
                <span class="identifier">X_pred</span><span class="punctuation">,</span> <span class="identifier">X_pred2</span><span class="punctuation">,</span>
                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fit_transform and transform outcomes "</span>
                        <span class="string-literal">"not consistent in %s"</span>
                <span class="arithmetic-operator">%</span> <span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
                <span class="identifier">X_pred</span><span class="punctuation">,</span> <span class="identifier">X_pred3</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span>
                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"consecutive fit_transform outcomes "</span>
                        <span class="string-literal">"not consistent in %s"</span>
                <span class="arithmetic-operator">%</span> <span class="identifier">transformer</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">_num_samples</span><span class="grouping">(</span><span class="identifier">X_pred2</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>
            <span class="keyword">assert</span> <span class="identifier">_num_samples</span><span class="grouping">(</span><span class="identifier">X_pred3</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>

        <span class="comment"># raises error on malformed input for transform</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="string-literal">'shape'</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="invalid">\</span>
           <span class="logical-operator">not</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"stateless"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="invalid">\</span>
           <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="logical-operator">and</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>

            <span class="comment"># If it's not an array, it does not have a 'T' property</span>
            <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                <span class="identifier">ValueError</span><span class="punctuation">,</span>
                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"The transformer {name} does not raise an error "</span>
                <span class="string-literal">"when the number of features in transform is different from "</span>
                <span class="string-literal">"the number of features in fit."</span>
            <span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_pipeline_consistency</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'non_deterministic'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">name</span> <span class="arithmetic-operator">+</span> <span class="string-literal">' is non deterministic'</span>
        <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>

    <span class="comment"># check that make_pipeline(est) gives same score as est</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">rbf_kernel</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">funcs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"score", "fit_transform"</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">func_name</span> <span class="relational-operator">in</span> <span class="identifier">funcs</span><span class="punctuation">:</span>
        <span class="identifier">func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">func_name</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">func</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">func_pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">func_name</span><span class="grouping">)</span>
            <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">result_pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">func_pipeline</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">result</span><span class="punctuation">,</span> <span class="identifier">result_pipe</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_fit_score_takes_y</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that all estimators accept an optional y</span>
    <span class="comment"># in fit and score so they can be used in pipelines</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="int-literal">3</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">funcs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"fit", "score", "partial_fit", "fit_predict", "fit_transform"</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">func_name</span> <span class="relational-operator">in</span> <span class="identifier">funcs</span><span class="punctuation">:</span>
        <span class="identifier">func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">func_name</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">func</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">signature</span><span class="grouping">(</span><span class="identifier">func</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">parameters</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"self"</span><span class="punctuation">:</span>
                <span class="comment"># if_delegate_has_method makes methods into functions</span>
                <span class="comment"># with an explicit "self", so need to shift arguments</span>
                <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
            <span class="keyword">assert</span> <span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"y", "Y"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="string-literal">"Expected y or Y as second argument for method "</span>
                    <span class="string-literal">"%s of %s. Got arguments: %r."</span>
                    <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">func_name</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_dtypes</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train_32</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">X_train_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X_train_32</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">X_train_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train_32</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="identifier">X_train_int_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train_32</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="grouping">)</span>
    <span class="identifier">X_train_int_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train_32</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train_int_64</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function", "predict_proba"</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">X_train</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">X_train_32</span><span class="punctuation">,</span> <span class="identifier">X_train_64</span><span class="punctuation">,</span> <span class="identifier">X_train_int_64</span><span class="punctuation">,</span> <span class="identifier">X_train_int_32</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
        <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">methods</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_transformer_preserve_dtypes</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">transformer_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that dtype are preserved meaning if input X is of some dtype</span>
    <span class="comment"># X_transformed should be from the same dtype.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span>
        <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
        <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">transformer_orig</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">transformer_orig</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"preserves_dtype"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X_cast</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">transformer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">transformer_orig</span><span class="grouping">)</span>
        <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">transformer</span><span class="grouping">)</span>
        <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_cast</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># cross-decompostion returns a tuple of (x_scores, y_scores)</span>
            <span class="comment"># when given y with fit_transform; only check the first element</span>
            <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_trans</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

        <span class="comment"># check that the output dtype is preserved</span>
        <span class="keyword">assert</span> <span class="identifier">X_trans</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="identifier">f</span><span class="string-literal">'Estimator transform dtype: {X_trans.dtype} - '</span>
            <span class="identifier">f</span><span class="string-literal">'original/expected dtype: {dtype.__name__}'</span>
        <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_empty_data_messages</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">e</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">X_zero_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="comment"># The precise message can change depending on whether X or y is</span>
    <span class="comment"># validated first. Let us test the type of exception only:</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"The estimator {name} does not raise an error when an "</span>
        <span class="string-literal">"empty data is used to train. Perhaps use check_array in train."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_zero_samples</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X_zero_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># the following y should be accepted by both classifiers and regressors</span>
    <span class="comment"># and ignored by unsupervised models</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span>
        <span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">r</span><span class="string-literal">"0 feature\(s\) \(shape=\(\d*, 0\)\) while a minimum of \d* "</span>
        <span class="string-literal">"is required."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_zero_features</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_nan_inf</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks that Estimator X's do not contain NaN or inf.</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train_finite</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">X_train_nan</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_train_nan</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">X_train_inf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_train_inf</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">error_string_fit</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Estimator doesn't check for NaN and inf in fit."</span>
    <span class="identifier">error_string_predict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Estimator doesn't check for NaN and inf in"</span>
                            <span class="string-literal">" predict."</span><span class="grouping">)</span>
    <span class="identifier">error_string_transform</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Estimator doesn't check for NaN and inf in"</span>
                              <span class="string-literal">" transform."</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">X_train</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">X_train_nan</span><span class="punctuation">,</span> <span class="identifier">X_train_inf</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># catch deprecation warnings</span>
        <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
            <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="comment"># try to fit</span>
            <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"inf", "NaN"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">error_string_fit</span>
            <span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="comment"># actually fit</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train_finite</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

            <span class="comment"># predict</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"predict"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                    <span class="identifier">ValueError</span><span class="punctuation">,</span>
                    <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"inf", "NaN"</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">error_string_predict</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>

            <span class="comment"># transform</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"transform"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                    <span class="identifier">ValueError</span><span class="punctuation">,</span>
                    <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"inf", "NaN"</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">error_string_transform</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_nonsquare_error</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that error is thrown when non-square data provided."""</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
        <span class="identifier">ValueError</span><span class="punctuation">,</span>
        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"The pairwise estimator {name} does not raise an error "</span>
        <span class="string-literal">"on non-square data"</span><span class="punctuation">,</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_pickle</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that we can pickle all estimators."""</span>
    <span class="identifier">check_methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                     <span class="string-literal">"predict_proba"</span><span class="grouping">]</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>

    <span class="comment"># some estimators can't do features less than 0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">rbf_kernel</span><span class="grouping">)</span>

    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="comment"># include NaN values when the estimator should deal with them</span>
    <span class="keyword">if</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'allow_nan'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># set randomly 10 elements to np.nan</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">replace</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># pickle and unpickle!</span>
    <span class="identifier">pickled_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">module_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__module__</span>
    <span class="keyword">if</span> <span class="identifier">module_name</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">'sklearn.'</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="grouping">(</span>
        <span class="string-literal">"test_" in module_name or module_name.endswith("_testing"</span><span class="grouping">)</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># strict check for sklearn estimators that are not implemented in test</span>
        <span class="comment"># modules.</span>
        <span class="keyword">assert</span> <span class="identifier">b</span><span class="string-literal">"version"</span> <span class="relational-operator">in</span> <span class="identifier">pickled_estimator</span>
    <span class="identifier">unpickled_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickled_estimator</span><span class="grouping">)</span>

    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">check_methods</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">result</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">result</span><span class="punctuation">:</span>
        <span class="identifier">unpickled_result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">unpickled_estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">result</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">unpickled_result</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_partial_fit_n_features</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check if number of features changes between calls to partial_fit.</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="string-literal">'partial_fit'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">NotImplementedError</span><span class="punctuation">:</span>
        <span class="keyword">return</span>

    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
        <span class="identifier">ValueError</span><span class="punctuation">,</span>
        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"The estimator {name} does not raise an error when the "</span>
        <span class="string-literal">"number of features changes between calls to partial_fit."</span><span class="punctuation">,</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_classifier_multioutput</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_labels</span><span class="punctuation">,</span> <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                                          <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span>
                                          <span class="identifier">n_labels</span><span class="arithmetic-assignment">=</span><span class="identifier">n_labels</span><span class="punctuation">,</span>
                                          <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"The shape of the prediction for multioutput data is "</span>
        <span class="string-literal">"incorrect. Expected {}, got {}."</span>
        <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_labels</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'i'</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">decision</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"The shape of the decision function output for "</span>
            <span class="string-literal">"multioutput data is incorrect. Expected {}, got {}."</span>
            <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">dec_pred</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">decision</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">dec_exp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="identifier">dec_pred</span><span class="grouping">]</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dec_exp</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'poor_score'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">assert</span> <span class="identifier">y_prob</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="string-literal">"The shape of the probability for multioutput data is"</span>
                    <span class="string-literal">" incorrect. Expected {}, got {}."</span>
                    <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_prob</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">y_pred</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span>
                <span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'poor_score'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">y_prob</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">"The shape of the probability for multioutput data is"</span>
                <span class="string-literal">" incorrect. Expected {}, got {}."</span>
                <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_prob</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span><span class="grouping">)</span> <span class="logical-operator">and</span>
            <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">y_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span>
            <span class="identifier">y_decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rankdata</span><span class="grouping">(</span><span class="identifier">y_proba</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rankdata</span><span class="grouping">(</span><span class="identifier">y_decision</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_regressor_multioutput</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">_is_pairwise_metric</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                           <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="string-literal">'float64'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"Multioutput predictions by a regressor are expected to be"</span>
        <span class="string-literal">" floating-point precision. Got {} instead"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"The shape of the prediction for multioutput data is incorrect."</span>
        <span class="string-literal">" Expected {}, got {}."</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_clustering</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">clusterer_orig</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clusterer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">clusterer_orig</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">X_noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">readonly_memmap</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X_noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X_noise</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="comment"># catch deprecation and neighbors warnings</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="punctuation">,</span> <span class="string-literal">"n_clusters"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'AffinityPropagation'</span><span class="punctuation">:</span>
        <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">preference</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">100</span><span class="grouping">)</span>
        <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>

    <span class="comment"># fit</span>
    <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># with lists</span>
    <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">labels_</span>
    <span class="keyword">assert</span> <span class="identifier">pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">adjusted_rand_score</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.4</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'non_deterministic'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="identifier">record</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">pred2</span><span class="grouping">)</span>

    <span class="comment"># fit_predict(X) and labels_ should be of type int</span>
    <span class="keyword">assert</span> <span class="identifier">pred</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="string-literal">'int32'), np.dtype('int64'</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">pred2</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="string-literal">'int32'), np.dtype('int64'</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="comment"># Add noise to X to test the possible values of the labels</span>
    <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X_noise</span><span class="grouping">)</span>

    <span class="comment"># There should be at least one sample in every cluster. Equivalently</span>
    <span class="comment"># labels_ should contain all the consecutive values between its</span>
    <span class="comment"># min and its max.</span>
    <span class="identifier">labels_sorted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">labels</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">labels_sorted</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">labels_sorted</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                <span class="identifier">labels_sorted</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Labels are expected to start at 0 (no noise) or -1 (if noise)</span>
    <span class="keyword">assert</span> <span class="identifier">labels_sorted</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="comment"># Labels should be less than n_clusters - 1</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="punctuation">,</span> <span class="string-literal">'n_clusters'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">n_clusters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="punctuation">,</span> <span class="string-literal">'n_clusters'</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">n_clusters</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span> <span class="relational-operator">&gt;=</span> <span class="identifier">labels_sorted</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="comment"># else labels should be less than max(labels_) which is necessarily true</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_clusterer_compute_labels_predict</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">clusterer_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that predict is invariant of compute_labels."""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clusterer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">clusterer_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clusterer</span><span class="punctuation">,</span> <span class="string-literal">"compute_labels"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># MiniBatchKMeans</span>
        <span class="identifier">X_pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">compute_labels</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">X_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clusterer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_pred1</span><span class="punctuation">,</span> <span class="identifier">X_pred2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_classifiers_one_label</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">error_string_fit</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Classifier can't train when only one class is present."</span>
    <span class="identifier">error_string_predict</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Classifier can't predict when only one class is "</span>
                            <span class="string-literal">"present."</span><span class="grouping">)</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="comment"># catch deprecation warnings</span>
    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"class"</span><span class="punctuation">,</span> <span class="identifier">may_pass</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">error_string_fit</span>
        <span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">cm</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">c</span><span class="invalid">h</span><span class="invalid">e</span><span class="invalid">d</span><span class="punctuation">:</span>
            <span class="comment"># ValueError was raised with proper error message</span>
            <span class="keyword">return</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">error_string_predict</span>
        <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>  <span class="comment"># Warnings are raised by decision function</span>
<span class="keyword">def</span> <span class="identifier">check_classifiers_train</span><span class="grouping">(</span>
    <span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">X_dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float64"</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">y_m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_m</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_dtype</span><span class="grouping">)</span>
    <span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">y_m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">y_m</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">X_m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_m</span><span class="grouping">)</span>
    <span class="comment"># generate binary problem from multi-class one</span>
    <span class="identifier">y_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_m</span><span class="grouping">[</span><span class="identifier">y_m</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">X_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_m</span><span class="grouping">[</span><span class="identifier">y_m</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'BernoulliNB', 'MultinomialNB', 'ComplementNB'</span><span class="punctuation">,</span>
                <span class="string-literal">'CategoricalNB'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X_m</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X_m</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X_b</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X_b</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">readonly_memmap</span><span class="punctuation">:</span>
        <span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">y_m</span><span class="punctuation">,</span> <span class="identifier">X_b</span><span class="punctuation">,</span> <span class="identifier">y_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">y_m</span><span class="punctuation">,</span> <span class="identifier">X_b</span><span class="punctuation">,</span> <span class="identifier">y_b</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">problems</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">X_b</span><span class="punctuation">,</span> <span class="identifier">y_b</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'binary_only'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">problems</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">y_m</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">problems</span><span class="punctuation">:</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span>
        <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
        <span class="comment"># raises error on malformed input for fit</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                <span class="identifier">ValueError</span><span class="punctuation">,</span>
                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"The classifier {name} does not raise an error when "</span>
                <span class="string-literal">"incorrect/malformed input data for fit is passed. The number "</span>
                <span class="string-literal">"of training examples is not the same as the number of "</span>
                <span class="string-literal">"labels. Perhaps use check_X_y in fit."</span><span class="punctuation">,</span>
            <span class="grouping">)</span><span class="punctuation">:</span>
                <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># fit</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># with lists</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"classes_"</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>
        <span class="comment"># training set performance</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'poor_score'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">accuracy_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.83</span>

        <span class="comment"># raises error on malformed input for predict</span>
        <span class="identifier">msg_pairwise</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="string-literal">"The classifier {} does not raise an error when shape of X in "</span>
            <span class="string-literal">" {} is not equal to (n_test_samples, n_training_samples)"</span><span class="grouping">)</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The classifier {} does not raise an error when the number of "</span>
               <span class="string-literal">"features in {} is different from the number of features in "</span>
               <span class="string-literal">"fit."</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                    <span class="identifier">ValueError</span><span class="punctuation">,</span>
                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_pairwise</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"predict"</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"predict"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="comment"># decision_function agrees with predict</span>
                <span class="identifier">decision</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">n_classes</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"multioutput_only"</span><span class="grouping">]</span><span class="punctuation">:</span>
                        <span class="keyword">assert</span> <span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>
                    <span class="keyword">else</span><span class="punctuation">:</span>
                        <span class="keyword">assert</span> <span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
                    <span class="identifier">dec_pred</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dec_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>
                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">decision</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

                <span class="comment"># raises error on malformed input for decision_function</span>
                <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="keyword">if</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                            <span class="identifier">ValueError</span><span class="punctuation">,</span>
                            <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_pairwise</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                                <span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span>
                            <span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="grouping">)</span><span class="punctuation">:</span>
                            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="keyword">else</span><span class="punctuation">:</span>
                        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                            <span class="identifier">ValueError</span><span class="punctuation">,</span>
                            <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="grouping">)</span><span class="punctuation">:</span>
                            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">NotImplementedError</span><span class="punctuation">:</span>
                <span class="keyword">pass</span>

        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># predict_proba agrees with predict</span>
            <span class="identifier">y_prob</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">y_prob</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
            <span class="comment"># check that probas for all classes sum to one</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="comment"># raises error on malformed input for predict_proba</span>
                <span class="keyword">if</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                        <span class="identifier">ValueError</span><span class="punctuation">,</span>
                        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_pairwise</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
                        <span class="identifier">ValueError</span><span class="punctuation">,</span>
                        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"predict_log_proba"</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># predict_log_proba is a transformation of predict_proba</span>
                <span class="identifier">y_log_prob</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_log_prob</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-9</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">y_log_prob</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">y_prob</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_outlier_corruption</span><span class="grouping">(</span><span class="identifier">num_outliers</span><span class="punctuation">,</span> <span class="identifier">expected_outliers</span><span class="punctuation">,</span> <span class="identifier">decision</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check for deviation from the precise given contamination level that may</span>
    <span class="comment"># be due to ties in the anomaly scores.</span>
    <span class="keyword">if</span> <span class="identifier">num_outliers</span> <span class="relational-operator">&lt;</span> <span class="identifier">expected_outliers</span><span class="punctuation">:</span>
        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">num_outliers</span>
        <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_outliers</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_outliers</span>
        <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">num_outliers</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="comment"># ensure that all values in the 'critical area' are tied,</span>
    <span class="comment"># leading to the observed discrepancy between provided</span>
    <span class="comment"># and actual contamination levels.</span>
    <span class="identifier">sorted_decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">decision</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'The number of predicted outliers is not equal to the expected '</span>
           <span class="string-literal">'number of outliers and this difference is not explained by the '</span>
           <span class="string-literal">'number of ties in the decision_function values'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">sorted_decision</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">msg</span>


<span class="keyword">def</span> <span class="identifier">check_outliers_train</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">300</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">readonly_memmap</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="comment"># fit</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># with lists</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'i'</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">output</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">decision</span><span class="punctuation">,</span> <span class="identifier">scores</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="string-literal">'float'</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>

    <span class="comment"># raises error on malformed input for predict</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="comment"># decision_function agrees with predict</span>
    <span class="identifier">dec_pred</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">decision</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">dec_pred</span><span class="grouping">[</span><span class="identifier">dec_pred</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dec_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

    <span class="comment"># raises error on malformed input for decision_function</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="comment"># decision_function is a translation of score_samples</span>
    <span class="identifier">y_dec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scores</span> <span class="arithmetic-operator">-</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">offset_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_dec</span><span class="punctuation">,</span> <span class="identifier">decision</span><span class="grouping">)</span>

    <span class="comment"># raises error on malformed input for score_samples</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="comment"># contamination parameter (not for OneClassSVM which has the nu parameter)</span>
    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'contamination'</span><span class="grouping">)</span>
            <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'novelty'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># proportion of outliers equal to contamination parameter when not</span>
        <span class="comment"># set to 'auto'. This is true for the training set and cannot thus be</span>
        <span class="comment"># checked as follows for estimators with a novelty parameter such as</span>
        <span class="comment"># LocalOutlierFactor (tested in check_outliers_fit_predict)</span>
        <span class="identifier">expected_outliers</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
        <span class="identifier">contamination</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_outliers</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">contamination</span><span class="arithmetic-assignment">=</span><span class="identifier">contamination</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">num_outliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="comment"># num_outliers should be equal to expected_outliers unless</span>
        <span class="comment"># there are ties in the decision_function values. this can</span>
        <span class="comment"># only be tested for estimators with a decision_function</span>
        <span class="comment"># method, i.e. all estimators except LOF which is already</span>
        <span class="comment"># excluded from this if branch.</span>
        <span class="keyword">if</span> <span class="identifier">num_outliers</span> <span class="relational-operator">!=</span> <span class="identifier">expected_outliers</span><span class="punctuation">:</span>
            <span class="identifier">decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">check_outlier_corruption</span><span class="grouping">(</span><span class="identifier">num_outliers</span><span class="punctuation">,</span> <span class="identifier">expected_outliers</span><span class="punctuation">,</span> <span class="identifier">decision</span><span class="grouping">)</span>

        <span class="comment"># raises error when contamination is a scalar and not in [0,1]</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"contamination must be in \(0, 0.5]"</span>
        <span class="keyword">for</span> <span class="identifier">contamination</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="float-literal">2.3</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">contamination</span><span class="arithmetic-assignment">=</span><span class="identifier">contamination</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_classifiers_multilabel_representation_invariance</span><span class="grouping">(</span>
    <span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span>
<span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                                          <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_labels</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                          <span class="identifier">length</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">allow_unlabeled</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">80</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">80</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">80</span><span class="punctuation">:</span><span class="grouping">]</span>

    <span class="identifier">y_train_list_of_lists</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y_train_list_of_arrays</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">y_pred_list_of_lists</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
        <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train_list_of_lists</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">y_pred_list_of_arrays</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
        <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train_list_of_arrays</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_list_of_arrays</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_list_of_lists</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">y_pred_list_of_arrays</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">y_pred_list_of_lists</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">y_pred_list_of_arrays</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">y_pred_list_of_lists</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_fit_returns_self</span><span class="grouping">(</span>
    <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check if self is returned when calling fit."""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">21</span><span class="grouping">)</span>
    <span class="comment"># some want non-negative input</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">readonly_memmap</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="identifier">estimator</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_unfitted</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that predict raises an exception in an unfitted estimator.

    Unfitted estimators should raise a NotFittedError.
    """</span>
    <span class="comment"># Common test for Regressors, Classifiers and Outlier detection estimators</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'decision_function', 'predict', 'predict_proba'</span><span class="punctuation">,</span>
                   <span class="string-literal">'predict_log_proba'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_supervised_y_2d</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span>
        <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span>
    <span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="int-literal">3</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="comment"># fit</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="comment"># Check that when a 2D y is given, a DataConversionWarning is</span>
    <span class="comment"># raised</span>
    <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="identifier">record</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">w</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">"always"</span><span class="punctuation">,</span> <span class="identifier">DataConversionWarning</span><span class="grouping">)</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">"ignore"</span><span class="punctuation">,</span> <span class="identifier">RuntimeWarning</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_pred_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"expected 1 DataConversionWarning, got: %s"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
        <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">w_x</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">w_x</span> <span class="relational-operator">in</span> <span class="identifier">w</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">'multioutput'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># check that we warned if we don't support multi-output</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">msg</span>
        <span class="keyword">assert</span> <span class="string-literal">"DataConversionWarning('A column-vector y"</span> <span class="invalid">\</span>
               <span class="string-literal">" was passed when a 1d array was expected"</span> <span class="relational-operator">in</span> <span class="identifier">msg</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_pred_2d</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_classifiers_predictions</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'BernoulliNB'</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="relational-operator">&gt;</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>

    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">decision</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">decision</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="identifier">dec_pred</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">decision</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
            <span class="identifier">dec_exp</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="identifier">dec_pred</span><span class="grouping">]</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dec_exp</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span>
                               <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"decision_function does not match "</span>
                               <span class="string-literal">"classifier for %r: expected '%s', got '%s'"</span> <span class="arithmetic-operator">%</span>
                               <span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">dec_exp</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">'decision_function_shape', 'ovr') == 'ovr'</span><span class="punctuation">:</span>
            <span class="identifier">decision_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">decision</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
            <span class="identifier">y_exp</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="identifier">decision_y</span><span class="grouping">]</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_exp</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span>
                               <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"decision_function does not match "</span>
                               <span class="string-literal">"classifier for %r: expected '%s', got '%s'"</span> <span class="arithmetic-operator">%</span>
                               <span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">y_exp</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># training set performance</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">!=</span> <span class="string-literal">"ComplementNB"</span><span class="punctuation">:</span>
        <span class="comment"># This is a pathological data set for ComplementNB.</span>
        <span class="comment"># For some specific cases 'ComplementNB' predicts less classes</span>
        <span class="comment"># than expected</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span>
                       <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Unexpected classes_ attribute for %r: "</span>
                       <span class="string-literal">"expected '%s', got '%s'"</span> <span class="arithmetic-operator">%</span>
                       <span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">str</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_choose_check_classifiers_labels</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_names</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Semisupervised classifers use -1 as the indicator for an unlabeled</span>
    <span class="comment"># sample.</span>
    <span class="keyword">return</span> <span class="identifier">y</span> <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"LabelPropagation"</span><span class="punctuation">,</span>
                         <span class="string-literal">"LabelSpreading"</span><span class="punctuation">,</span>
                         <span class="string-literal">"SelfTrainingClassifier"</span><span class="grouping">]</span> <span class="keyword">else</span> <span class="identifier">y_names</span>


<span class="keyword">def</span> <span class="identifier">check_classifiers_classes</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_multiclass</span><span class="punctuation">,</span> <span class="identifier">y_multiclass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                            <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">X_multiclass</span><span class="punctuation">,</span> <span class="identifier">y_multiclass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X_multiclass</span><span class="punctuation">,</span> <span class="identifier">y_multiclass</span><span class="punctuation">,</span>
                                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">X_multiclass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_multiclass</span><span class="grouping">)</span>
    <span class="comment"># We need to make sure that we have non negative data, for things</span>
    <span class="comment"># like NMF</span>
    <span class="identifier">X_multiclass</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X_multiclass</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="float-literal">.1</span>

    <span class="identifier">X_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_multiclass</span><span class="grouping">[</span><span class="identifier">y_multiclass</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">y_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_multiclass</span><span class="grouping">[</span><span class="identifier">y_multiclass</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">X_multiclass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X_multiclass</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
    <span class="identifier">X_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X_binary</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>

    <span class="identifier">labels_multiclass</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"one", "two", "three"</span><span class="grouping">]</span>
    <span class="identifier">labels_binary</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"one", "two"</span><span class="grouping">]</span>

    <span class="identifier">y_names_multiclass</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">labels_multiclass</span><span class="punctuation">,</span> <span class="identifier">y_multiclass</span><span class="grouping">)</span>
    <span class="identifier">y_names_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">labels_binary</span><span class="punctuation">,</span> <span class="identifier">y_binary</span><span class="grouping">)</span>

    <span class="identifier">problems</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">X_binary</span><span class="punctuation">,</span> <span class="identifier">y_binary</span><span class="punctuation">,</span> <span class="identifier">y_names_binary</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'binary_only'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">problems</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X_multiclass</span><span class="punctuation">,</span> <span class="identifier">y_multiclass</span><span class="punctuation">,</span> <span class="identifier">y_names_multiclass</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_names</span> <span class="relational-operator">in</span> <span class="identifier">problems</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">y_names_i</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">y_names</span><span class="punctuation">,</span> <span class="identifier">y_names</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'O'</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_choose_check_classifiers_labels</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_names_i</span><span class="grouping">)</span>
            <span class="identifier">check_classifiers_predictions</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>

    <span class="identifier">labels_binary</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">y_names_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">labels_binary</span><span class="punctuation">,</span> <span class="identifier">y_binary</span><span class="grouping">)</span>
    <span class="identifier">y_binary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_choose_check_classifiers_labels</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">y_binary</span><span class="punctuation">,</span> <span class="identifier">y_names_binary</span><span class="grouping">)</span>
    <span class="identifier">check_classifiers_predictions</span><span class="grouping">(</span><span class="identifier">X_binary</span><span class="punctuation">,</span> <span class="identifier">y_binary</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_regressors_int</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">regressor_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">regressor_orig</span><span class="grouping">)</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">regressor_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># separate estimators to control random seeds</span>
    <span class="identifier">regressor_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">regressor_orig</span><span class="grouping">)</span>
    <span class="identifier">regressor_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">regressor_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">regressor_1</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">regressor_2</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>

    <span class="comment"># fit</span>
    <span class="identifier">regressor_1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>
    <span class="identifier">pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regressor_1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">regressor_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regressor_2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pred1</span><span class="punctuation">,</span> <span class="identifier">pred2</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_regressors_train</span><span class="grouping">(</span>
    <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">regressor_orig</span><span class="punctuation">,</span> <span class="identifier">readonly_memmap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">X_dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_dtype</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">regressor_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>  <span class="comment"># X is already scaled</span>
    <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">regressor_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
        <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>

    <span class="keyword">if</span> <span class="identifier">readonly_memmap</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="string-literal">'alphas') and hasattr(regressor, 'alpha'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># linear regressors need to set alpha, but not generalized CV ones</span>
        <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.01</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'PassiveAggressiveRegressor'</span><span class="punctuation">:</span>
        <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.01</span>

    <span class="comment"># raises error on malformed input for fit</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span>
        <span class="identifier">ValueError</span><span class="punctuation">,</span>
        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"The classifier {name} does not raise an error when "</span>
        <span class="string-literal">"incorrect/malformed input data for fit is passed. The number of "</span>
        <span class="string-literal">"training examples is not the same as the number of labels. Perhaps "</span>
        <span class="string-literal">"use check_X_y in fit."</span><span class="punctuation">,</span>
    <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># fit</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="grouping">)</span>
    <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>
    <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_</span><span class="punctuation">.</span><span class="identifier">shape</span>

    <span class="comment"># TODO: find out why PLS and CCA fail. RANSAC is random</span>
    <span class="comment"># and furthermore assumes the presence of outliers, hence</span>
    <span class="comment"># skipped</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"poor_score"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_regressors_no_decision_function</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">regressor_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that regressors don't have a decision_function, predict_proba, or</span>
    <span class="comment"># predict_log_proba method.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">regressor_orig</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">regressor_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">funcs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"decision_function", "predict_proba", "predict_log_proba"</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">func_name</span> <span class="relational-operator">in</span> <span class="identifier">funcs</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="identifier">func_name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_class_weight_classifiers</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'binary_only'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">problems</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">problems</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">n_centers</span> <span class="relational-operator">in</span> <span class="identifier">problems</span><span class="punctuation">:</span>
        <span class="comment"># create a very noisy dataset</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="identifier">n_centers</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
        <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="punctuation">,</span>
                                                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="comment"># can't use gram_if_pairwise() here, setting up gram matrix manually</span>
        <span class="keyword">if</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="grouping">)</span>
            <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="grouping">)</span>

        <span class="identifier">n_centers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">n_centers</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.0001</span><span class="grouping">}</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.0001</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="float-literal">0.0001</span><span class="grouping">}</span>

        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"n_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"max_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"min_weight_fraction_leaf"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"n_iter_no_change"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>

        <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="comment"># XXX: Generally can use 0.89 here. On Windows, LinearSVC gets</span>
        <span class="comment">#      0.88 (Issue #9111)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'poor_score'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.87</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_class_weight_balanced_classifiers</span><span class="grouping">(</span>
    <span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">weights</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"n_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"max_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred_balanced</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred_balanced</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
            <span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_class_weight_balanced_linear_classifier</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test class weights with non-contiguous class labels."""</span>
    <span class="comment"># this is run on classes, not instances, though this should be changed</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="invalid">C</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"n_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># This is a very small dataset, default n_iter are likely to prevent</span>
        <span class="comment"># convergence</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">"max_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="string-literal">'cv'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>

    <span class="comment"># Let the model compute the class frequencies</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="grouping">)</span>
    <span class="identifier">coef_balanced</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Count each label occurrence to reweight manually</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">}</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="grouping">)</span>
    <span class="identifier">coef_manual</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">coef_balanced</span><span class="punctuation">,</span> <span class="identifier">coef_manual</span><span class="punctuation">,</span>
                    <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Classifier %s is not computing"</span>
                    <span class="string-literal">" class_weight=balanced properly."</span>
                    <span class="arithmetic-operator">%</span> <span class="identifier">name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_overwrite_params</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">21</span><span class="grouping">)</span>
    <span class="comment"># some want non-negative input</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">rbf_kernel</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="comment"># Make a physical copy of the original estimator parameters before fitting.</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">original_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">deepcopy</span><span class="grouping">(</span><span class="identifier">params</span><span class="grouping">)</span>

    <span class="comment"># Fit the model</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Compare the state of the model parameters with the original parameters</span>
    <span class="identifier">new_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">param_name</span><span class="punctuation">,</span> <span class="identifier">original_value</span> <span class="relational-operator">in</span> <span class="identifier">original_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">new_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_params</span><span class="grouping">[</span><span class="identifier">param_name</span><span class="grouping">]</span>

        <span class="comment"># We should never change or mutate the internal state of input</span>
        <span class="comment"># parameters by default. To check this we use the joblib.hash function</span>
        <span class="comment"># that introspects recursively any subobjects to compute a checksum.</span>
        <span class="comment"># The only exception to this rule of immutable constructor parameters</span>
        <span class="comment"># is possible RandomState instance but in this check we explicitly</span>
        <span class="comment"># fixed the random_state params recursively to be integer seeds.</span>
        <span class="keyword">assert</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">hash</span><span class="grouping">(</span><span class="identifier">new_value</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">hash</span><span class="grouping">(</span><span class="identifier">original_value</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"Estimator %s should not change or mutate "</span>
            <span class="string-literal">" the parameter %s from %s to %s during fit."</span>
            <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">param_name</span><span class="punctuation">,</span> <span class="identifier">original_value</span><span class="punctuation">,</span> <span class="identifier">new_value</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_no_attributes_set_in_init</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check setting during init."""</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="comment"># Clone fails if the estimator does not store</span>
        <span class="comment"># all parameters as an attribute during init</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">AttributeError</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">AttributeError</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Estimator {name} should store all "</span>
                             <span class="string-literal">"parameters as an attribute during init."</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="punctuation">,</span> <span class="string-literal">"deprecated_original"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span>

    <span class="identifier">init_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_args</span><span class="grouping">(</span><span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">IS_PYPY</span><span class="punctuation">:</span>
        <span class="comment"># __init__ signature has additional objects in PyPy</span>
        <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'obj'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">init_params</span><span class="punctuation">:</span>
                <span class="identifier">init_params</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">key</span><span class="grouping">)</span>
    <span class="identifier">parents_init_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">param</span> <span class="keyword">for</span> <span class="identifier">params_parent</span> <span class="relational-operator">in</span>
                           <span class="grouping">(</span><span class="identifier">_get_args</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">parent</span> <span class="relational-operator">in</span>
                            <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__mro__</span><span class="grouping">)</span>
                           <span class="keyword">for</span> <span class="identifier">param</span> <span class="relational-operator">in</span> <span class="identifier">params_parent</span><span class="grouping">]</span>

    <span class="comment"># Test for no setting apart from parameters during init</span>
    <span class="identifier">invalid_attr</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">vars</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">init_params</span><span class="grouping">)</span>
                    <span class="arithmetic-operator">-</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">parents_init_params</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">invalid_attr</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"Estimator %s should not set any attribute apart"</span>
            <span class="string-literal">" from parameters during init. Found attributes %s."</span>
            <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">invalid_attr</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_sparsify_coefficients</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pred_orig</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test sparsify with dense inputs</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">sparsify</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">pred_orig</span><span class="grouping">)</span>

    <span class="comment"># pickle and unpickle with sparse coef_</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">pred_orig</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_classifier_data_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">obj_type</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"NotAnArray", "PandasDataframe"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">check_estimators_data_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                           <span class="identifier">obj_type</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_regressor_data_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">obj_type</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"NotAnArray", "PandasDataframe"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">check_estimators_data_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                           <span class="identifier">obj_type</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_estimators_data_not_an_array</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">obj_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span><span class="string-literal">"Skipping check_estimators_data_not_an_array "</span>
                       <span class="string-literal">"for cross decomposition module as estimators "</span>
                       <span class="string-literal">"are not deterministic."</span><span class="grouping">)</span>
    <span class="comment"># separate estimators to control random seeds</span>
    <span class="identifier">estimator_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">estimator_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator_1</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator_2</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">obj_type</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"NotAnArray"</span><span class="punctuation">,</span> <span class="string-literal">'PandasDataframe'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Data type {0} not supported"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">obj_type</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">obj_type</span> <span class="relational-operator">==</span> <span class="string-literal">"NotAnArray"</span><span class="punctuation">:</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_NotAnArray</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="comment"># Here pandas objects (Series and DataFrame) are tested explicitly</span>
        <span class="comment"># because some estimators may handle them (especially their indexing)</span>
        <span class="comment"># specially.</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">import</span> <span class="identifier">pandas</span> <span class="keyword">as</span> <span class="identifier">pd</span>
            <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">y_</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">Series</span><span class="grouping">(</span><span class="identifier">y_</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">y_</span><span class="grouping">)</span>
            <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">SkipTest</span><span class="grouping">(</span><span class="string-literal">"pandas is not installed: not checking estimators "</span>
                           <span class="string-literal">"for pandas objects."</span><span class="grouping">)</span>

    <span class="comment"># fit</span>
    <span class="identifier">estimator_1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>
    <span class="identifier">pred1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>
    <span class="identifier">estimator_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pred1</span><span class="punctuation">,</span> <span class="identifier">pred2</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_parameters_default_constructible</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test default-constructibility</span>
    <span class="comment"># get rid of deprecation warnings</span>

    <span class="identifier">Estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span>

    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_construct_instance</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span>
        <span class="comment"># test cloning</span>
        <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
        <span class="comment"># test __repr__</span>
        <span class="identifier">repr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
        <span class="comment"># test that set_params returns self</span>
        <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="identifier">estimator</span>

        <span class="comment"># test if init does nothing but set parameters</span>
        <span class="comment"># this is important for grid_search etc.</span>
        <span class="comment"># We get the default parameters from init and then</span>
        <span class="comment"># compare these against the actual values of the attributes.</span>

        <span class="comment"># this comes from getattr. Gets rid of deprecation decorator.</span>
        <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="punctuation">,</span> <span class="string-literal">'deprecated_original'</span><span class="punctuation">,</span>
                       <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">)</span>

        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">def</span> <span class="identifier">param_filter</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment">"""Identify hyper parameters of an estimator."""</span>
                <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">!=</span> <span class="string-literal">'self'</span> <span class="logical-operator">and</span>
                        <span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">!=</span> <span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">VAR_KEYWORD</span> <span class="logical-operator">and</span>
                        <span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">!=</span> <span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">VAR_POSITIONAL</span><span class="grouping">)</span>

            <span class="identifier">init_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">p</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">signature</span><span class="grouping">(</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">parameters</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span>
                           <span class="keyword">if</span> <span class="identifier">param_filter</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="keyword">except</span> <span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># init is not a python function.</span>
            <span class="comment"># true for mixins</span>
            <span class="keyword">return</span>
        <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="comment"># they can need a non-default argument</span>
        <span class="identifier">init_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">init_params</span><span class="grouping">[</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span>
            <span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'_required_parameters'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span>

        <span class="keyword">for</span> <span class="identifier">init_param</span> <span class="relational-operator">in</span> <span class="identifier">init_params</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span> <span class="relational-operator">!=</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">"parameter %s for %s has no default value"</span>
                <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">init_param</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">allowed_types</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
                <span class="identifier">str</span><span class="punctuation">,</span>
                <span class="identifier">int</span><span class="punctuation">,</span>
                <span class="identifier">float</span><span class="punctuation">,</span>
                <span class="identifier">bool</span><span class="punctuation">,</span>
                <span class="identifier">tuple</span><span class="punctuation">,</span>
                <span class="identifier">type</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">type</span><span class="punctuation">,</span>
                <span class="identifier">types</span><span class="punctuation">.</span><span class="identifier">FunctionType</span><span class="punctuation">,</span>
                <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">Memory</span><span class="punctuation">,</span>
            <span class="grouping">}</span>
            <span class="comment"># Any numpy numeric such as np.int32.</span>
            <span class="identifier">allowed_types</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">core</span><span class="punctuation">.</span><span class="identifier">numerictypes</span><span class="punctuation">.</span><span class="identifier">allTypes</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">init_param</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">allowed_types</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="identifier">f</span><span class="string-literal">"Parameter '{init_param.name}' of estimator "</span>
                    <span class="identifier">f</span><span class="string-literal">"'{Estimator.__name__}' is of type "</span>
                    <span class="identifier">f</span><span class="string-literal">"{type(init_param.default).__name__} which is not "</span>
                    <span class="identifier">f</span><span class="string-literal">"allowed. All init parameters have to be immutable to "</span>
                    <span class="identifier">f</span><span class="string-literal">"make cloning possible. Therefore we restrict the set of "</span>
                    <span class="identifier">f</span><span class="string-literal">"legal types to "</span>
                    <span class="identifier">f</span><span class="string-literal">"{set(type.__name__ for type in allowed_types)}."</span>
            <span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># deprecated parameter, not in get_params</span>
                <span class="keyword">assert</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="identifier">f</span><span class="string-literal">"Estimator parameter '{init_param.name}' of estimator "</span>
                    <span class="identifier">f</span><span class="string-literal">"'{Estimator.__name__}' is not returned by get_params. "</span>
                    <span class="identifier">f</span><span class="string-literal">"If it is deprecated, set its default value to None."</span>
                <span class="grouping">)</span>
                <span class="keyword">continue</span>

            <span class="identifier">param_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="grouping">[</span><span class="identifier">init_param</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">param_value</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">param_value</span><span class="punctuation">,</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">failure_text</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                    <span class="identifier">f</span><span class="string-literal">"Parameter {init_param.name} was mutated on init. All "</span>
                    <span class="identifier">f</span><span class="string-literal">"parameters must be stored unchanged."</span>
                <span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">is_scalar_nan</span><span class="grouping">(</span><span class="identifier">param_value</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="comment"># Allows to set default parameters to np.nan</span>
                    <span class="keyword">assert</span> <span class="identifier">param_value</span> <span class="relational-operator">is</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">failure_text</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="identifier">param_value</span> <span class="relational-operator">==</span> <span class="identifier">init_param</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">failure_text</span>


<span class="keyword">def</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Estimators with a `requires_positive_y` tag only accept strictly positive</span>
    <span class="comment"># data</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"requires_positive_y"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Create strictly positive y. The minimal increment above 0 is 1, as</span>
        <span class="comment"># y could be of integer dtype.</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># Estimators with a `binary_only` tag only accept up to two unique y values</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"binary_only"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># Estimators in mono_output_task_error raise ValueError if y is of 1-D</span>
    <span class="comment"># Convert into a 2-D y for those estimators.</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"multioutput_only"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">y</span>


<span class="keyword">def</span> <span class="identifier">_enforce_estimator_tags_x</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Pairwise estimators only accept</span>
    <span class="comment"># X of shape (`n_samples`, `n_samples`)</span>
    <span class="keyword">if</span> <span class="identifier">_is_pairwise</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="comment"># Estimators with `1darray` in `X_types` tag only accept</span>
    <span class="comment"># X of shape (`n_samples`,)</span>
    <span class="keyword">if</span> <span class="string-literal">'1darray' in _safe_tags(estimator, key='X_types'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="comment"># Estimators with a `requires_positive_X` tag only accept</span>
    <span class="comment"># strictly positive data</span>
    <span class="keyword">if</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">'requires_positive_X'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_non_transformer_estimators_n_iter</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that estimators that are not transformers with a parameter</span>
    <span class="comment"># max_iter, return the attribute of n_iter_ at least 1.</span>

    <span class="comment"># These models are dependent on external solvers like</span>
    <span class="comment"># libsvm and accessing the iter parameter is non-trivial.</span>
    <span class="comment"># SelfTrainingClassifier does not perform an iteration if all samples are</span>
    <span class="comment"># labeled, hence n_iter_ = 0 is valid.</span>
    <span class="identifier">not_run_check_n_iter</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'Ridge', 'SVR', 'NuSVR', 'NuSVC'</span><span class="punctuation">,</span>
                            <span class="string-literal">'RidgeClassifier', 'SVC', 'RandomizedLasso'</span><span class="punctuation">,</span>
                            <span class="string-literal">'LogisticRegressionCV', 'LinearSVC'</span><span class="punctuation">,</span>
                            <span class="string-literal">'LogisticRegression', 'SelfTrainingClassifier'</span><span class="grouping">]</span>

    <span class="comment"># Tested in test_transformer_n_iter</span>
    <span class="identifier">not_run_check_n_iter</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">CROSS_DECOMPOSITION</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">not_run_check_n_iter</span><span class="punctuation">:</span>
        <span class="keyword">return</span>

    <span class="comment"># LassoLars stops early for the default alpha=1.0 the iris dataset.</span>
    <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'LassoLars'</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'max_iter'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

        <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_transformer_n_iter</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that transformers with a parameter max_iter, return the</span>
    <span class="comment"># attribute of n_iter_ at least 1.</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"max_iter"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
            <span class="comment"># Check using default data</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span>
            <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">-0.2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">-0.2</span><span class="grouping">]</span><span class="grouping">]</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.1</span>
        <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_</span><span class="grouping">)</span>

        <span class="comment"># These return a n_iter per component.</span>
        <span class="keyword">if</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">CROSS_DECOMPOSITION</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">iter_</span> <span class="relational-operator">in</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_iter_</span><span class="punctuation">:</span>
                <span class="keyword">assert</span> <span class="identifier">iter_</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_get_params_invariance</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks if get_params(deep=False) is a subset of get_params(deep=True)</span>
    <span class="identifier">e</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">shallow_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">deep_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">deep_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span>
               <span class="identifier">shallow_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_set_params</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that get_params() returns the same thing</span>
    <span class="comment"># before and after set_params() with some fuzz</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">orig_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"get_params result does not match what was passed to set_params"</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">orig_params</span><span class="grouping">)</span>
    <span class="identifier">curr_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">orig_params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">curr_params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">msg</span>
    <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">curr_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">orig_params</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">msg</span>

    <span class="comment"># some fuzz values</span>
    <span class="identifier">test_values</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>

    <span class="identifier">test_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">deepcopy</span><span class="grouping">(</span><span class="identifier">orig_params</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">param_name</span> <span class="relational-operator">in</span> <span class="identifier">orig_params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orig_params</span><span class="grouping">[</span><span class="identifier">param_name</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">value</span> <span class="relational-operator">in</span> <span class="identifier">test_values</span><span class="punctuation">:</span>
            <span class="identifier">test_params</span><span class="grouping">[</span><span class="identifier">param_name</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">value</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">test_params</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">ValueError</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
                <span class="identifier">e_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
                <span class="comment"># Exception occurred, possibly parameter validation</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"{0} occurred during set_params of param {1} on "</span>
                              <span class="string-literal">"{2}. It is recommended to delay parameter "</span>
                              <span class="string-literal">"validation until fit."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">e_type</span><span class="punctuation">,</span>
                                                             <span class="identifier">param_name</span><span class="punctuation">,</span>
                                                             <span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>

                <span class="identifier">change_warning_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Estimator's parameters changed after "</span> <span class="invalid">\</span>
                                     <span class="string-literal">"set_params raised {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">e_type</span><span class="grouping">)</span>
                <span class="identifier">params_before_exception</span> <span class="arithmetic-assignment">=</span> <span class="identifier">curr_params</span>
                <span class="identifier">curr_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
                <span class="keyword">try</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">params_before_exception</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                            <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">curr_params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">curr_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="keyword">assert</span> <span class="identifier">params_before_exception</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">v</span>
                <span class="keyword">except</span> <span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
                    <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">change_warning_msg</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">curr_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
                <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">test_params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                        <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">curr_params</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">msg</span>
                <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">curr_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="identifier">test_params</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">msg</span>
        <span class="identifier">test_params</span><span class="grouping">[</span><span class="identifier">param_name</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_classifiers_regression_target</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check if classifier throws an exception when fed regression targets</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_regression_dataset</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>  <span class="comment"># be sure that X is non-negative</span>
    <span class="identifier">e</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Unknown label type: "</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="string-literal">"no_validation"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_decision_proba_consistency</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether an estimator having both decision_function and</span>
    <span class="comment"># predict_proba methods has outputs with perfect rank correlation.</span>

    <span class="identifier">centers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                      <span class="identifier">centers</span><span class="arithmetic-assignment">=</span><span class="identifier">centers</span><span class="punctuation">,</span> <span class="identifier">cluster_std</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"decision_function"</span><span class="grouping">)</span> <span class="logical-operator">and</span>
            <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="comment"># Since the link function from decision_function() to predict_proba()</span>
        <span class="comment"># is sometimes not precise enough (typically expit), we round to the</span>
        <span class="comment"># 10th decimal to avoid numerical issues: we compare the rank</span>
        <span class="comment"># with deterministic ties rather than get platform specific rank</span>
        <span class="comment"># inversions in case of machine level differences.</span>
        <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">decimals</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">decimals</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rankdata</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rankdata</span><span class="grouping">(</span><span class="identifier">b</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_outliers_fit_predict</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check fit_predict for outlier detectors.</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">300</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_blobs</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y_pred</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'i'</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check fit_predict = fit.predict when the estimator has both a predict and</span>
    <span class="comment"># a fit_predict method. recall that it is already assumed here that the</span>
    <span class="comment"># estimator has a fit_predict method</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_pred_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred_2</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"contamination"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># proportion of outliers equal to contamination parameter when not</span>
        <span class="comment"># set to 'auto'</span>
        <span class="identifier">expected_outliers</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">30</span>
        <span class="identifier">contamination</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">expected_outliers</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="identifier">n_samples</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">contamination</span><span class="arithmetic-assignment">=</span><span class="identifier">contamination</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">num_outliers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y_pred</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="comment"># num_outliers should be equal to expected_outliers unless</span>
        <span class="comment"># there are ties in the decision_function values. this can</span>
        <span class="comment"># only be tested for estimators with a decision_function</span>
        <span class="comment"># method</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">num_outliers</span> <span class="relational-operator">!=</span> <span class="identifier">expected_outliers</span> <span class="logical-operator">and</span>
                <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'decision_function'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">decision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">check_outlier_corruption</span><span class="grouping">(</span><span class="identifier">num_outliers</span><span class="punctuation">,</span> <span class="identifier">expected_outliers</span><span class="punctuation">,</span> <span class="identifier">decision</span><span class="grouping">)</span>

        <span class="comment"># raises error when contamination is a scalar and not in [0,1]</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"contamination must be in \(0, 0.5]"</span>
        <span class="keyword">for</span> <span class="identifier">contamination</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="float-literal">-0.001</span><span class="punctuation">,</span> <span class="float-literal">0.5001</span><span class="punctuation">,</span> <span class="float-literal">2.3</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">contamination</span><span class="arithmetic-assignment">=</span><span class="identifier">contamination</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_fit_non_negative</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that proper warning is raised for non-negative X</span>
    <span class="comment"># when tag requires_positive_X is present</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_fit_idempotent</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that est.fit(X) is the same as est.fit(X).fit(X). Ideally we would</span>
    <span class="comment"># check that the estimated parameters during training (e.g. coefs_) are</span>
    <span class="comment"># the same, but having a universal comparison function for those</span>
    <span class="comment"># attributes is difficult and full of edge cases. So instead we check that</span>
    <span class="comment"># predict(), predict_proba(), decision_function() and transform() return</span>
    <span class="comment"># the same results.</span>

    <span class="identifier">check_methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                     <span class="string-literal">"predict_proba"</span><span class="grouping">]</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">'warm_start'</span> <span class="relational-operator">in</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">is_regressor</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">ShuffleSplit</span><span class="grouping">(</span><span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_split</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">train</span><span class="grouping">)</span>
    <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_split</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test</span><span class="punctuation">,</span> <span class="identifier">train</span><span class="grouping">)</span>

    <span class="comment"># Fit for the first time</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">method</span><span class="punctuation">:</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
              <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">check_methods</span>
              <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="comment"># Fit again</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">check_methods</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">new_result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">issubdtype</span><span class="grouping">(</span><span class="identifier">new_result</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">floating</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">*</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">new_result</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">*</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
                <span class="identifier">result</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">new_result</span><span class="punctuation">,</span>
                <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="float-literal">1e-9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Idempotency check failed for method {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span>
            <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_n_features_in</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that n_features_in_ attribute doesn't exist until fit is</span>
    <span class="comment"># called, and that its value is correct.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">'warm_start'</span> <span class="relational-operator">in</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">is_regressor</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span>
            <span class="string-literal">"As of scikit-learn 0.23, estimators should expose a "</span>
            <span class="string-literal">"n_features_in_ attribute, unless the 'no_validation' tag is "</span>
            <span class="string-literal">"True. This attribute should be equal to the number of features "</span>
            <span class="string-literal">"passed to the fit method. "</span>
            <span class="string-literal">"An error will be raised from version 1.0 (renaming of 0.25) "</span>
            <span class="string-literal">"when calling check_estimator(). "</span>
            <span class="string-literal">"See SLEP010: "</span>
            <span class="string-literal">"https://scikit-learn-enhancement-proposals.readthedocs.io/en/latest/slep010/proposal.html"</span><span class="punctuation">,</span>  <span class="comment"># noqa</span>
            <span class="identifier">FutureWarning</span>
        <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_requires_y_none</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that an estimator with requires_y=True fails gracefully when</span>
    <span class="comment"># given y=None</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="identifier">warning_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"As of scikit-learn 0.23, estimators should have a "</span>
                   <span class="string-literal">"'requires_y' tag set to the appropriate value. "</span>
                   <span class="string-literal">"The default value of the tag is False. "</span>
                   <span class="string-literal">"An error will be raised from version 1.0 when calling "</span>
                   <span class="string-literal">"check_estimator() if the tag isn't properly set."</span><span class="grouping">)</span>

    <span class="identifier">expected_err_msgs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"requires y to be passed, but the target y is None"</span><span class="punctuation">,</span>
        <span class="string-literal">"Expected array-like (array or non-string sequence), got None"</span><span class="punctuation">,</span>
        <span class="string-literal">"y should be a 1d array"</span>
    <span class="grouping">)</span>

    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">ValueError</span> <span class="keyword">as</span> <span class="identifier">ve</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">any</span><span class="grouping">(</span><span class="identifier">msg</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">ve</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">msg</span> <span class="relational-operator">in</span> <span class="identifier">expected_err_msgs</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">warning_msg</span><span class="punctuation">,</span> <span class="identifier">FutureWarning</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">check_n_features_in_after_fitting</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure that n_features_in are checked after fitting</span>
    <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_safe_tags</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="grouping">(</span><span class="string-literal">"2darray" not in tags["X_types"] and "sparse" not in tags["X_types"</span><span class="grouping">]</span> <span class="logical-operator">or</span>
            <span class="identifier">tags</span><span class="grouping">[</span><span class="string-literal">"no_validation"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="identifier">set_random_state</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">'warm_start'</span> <span class="relational-operator">in</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">150</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_x</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_pairwise_estimator_convert_X</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">is_regressor</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_enforce_estimator_tags_y</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># check methods will check n_features_in_</span>
    <span class="identifier">check_methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"predict", "transform", "decision_function"</span><span class="punctuation">,</span>
                     <span class="string-literal">"predict_proba", "score"</span><span class="grouping">]</span>
    <span class="identifier">X_bad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"X has 1 features, but \\w+ is expecting {X.shape[1]} "</span>
           <span class="string-literal">"features as input"</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">check_methods</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>

        <span class="identifier">callable_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">"score"</span><span class="punctuation">:</span>
            <span class="identifier">callable_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">callable_method</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">callable_method</span><span class="grouping">(</span><span class="identifier">X_bad</span><span class="grouping">)</span>

    <span class="comment"># partial_fit will check in the second call</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"partial_fit"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">with</span> <span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X_bad</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_estimator_get_tags_default_keys</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">estimator_orig</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that if _get_tags is implemented, it contains all keys from</span>
    <span class="comment"># _DEFAULT_KEYS</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">estimator_orig</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="string-literal">"_get_tags"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span>

    <span class="identifier">tags_keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">_get_tags</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">k</span><span class="invalid">e</span><span class="invalid">y</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">_DEFAULT_TAGS</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">tags_keys</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">k</span><span class="invalid">e</span><span class="invalid">y</span><span class="invalid">s</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">k</span><span class="invalid">e</span><span class="invalid">y</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"{name}._get_tags() is missing entries for the following default tags"</span>
        <span class="identifier">f</span><span class="string-literal">": {default_tags_keys - tags_keys.intersection(default_tags_keys)}"</span>
    <span class="grouping">)</span>

    </pre>
  </body>
</html>