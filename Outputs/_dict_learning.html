<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">""" Dictionary learning.
"""</span>
<span class="comment"># Author: Vlad Niculae, Gael Varoquaux, Alexandre Gramfort</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>

<span class="keyword">from</span> <span class="identifier">math</span> <span class="keyword">import</span> <span class="identifier">ceil</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Parallel</span><span class="punctuation">,</span> <span class="identifier">effective_n_jobs</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">deprecated</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">check_array</span><span class="punctuation">,</span> <span class="identifier">check_random_state</span><span class="punctuation">,</span> <span class="identifier">gen_even_slices</span><span class="punctuation">,</span>
                     <span class="identifier">gen_batches</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">randomized_svd</span><span class="punctuation">,</span> <span class="identifier">row_norms</span><span class="punctuation">,</span> <span class="identifier">svd_flip</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">e</span><span class="invalid">d</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Lasso</span><span class="punctuation">,</span> <span class="identifier">orthogonal_mp_gram</span><span class="punctuation">,</span> <span class="identifier">LassoLars</span><span class="punctuation">,</span> <span class="identifier">Lars</span>


<span class="keyword">def</span> <span class="identifier">_check_positive_coding</span><span class="grouping">(</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">positive</span> <span class="logical-operator">and</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"omp", "lars"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"Positive constraint not supported for '{}' "</span>
                <span class="string-literal">"coding method."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">method</span><span class="grouping">)</span>
            <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_sparse_encode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">gram</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lasso_lars'</span><span class="punctuation">,</span>
                   <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">copy_cov</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                   <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                   <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Generic sparse coding.

    Each column of the result is the solution to a Lasso problem.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Data matrix.

    dictionary : ndarray of shape (n_components, n_features)
        The dictionary matrix against which to solve the sparse coding of
        the data. Some of the algorithms assume normalized rows.

    gram : ndarray of shape (n_components, n_components) or None
        Precomputed Gram matrix, `dictionary * dictionary'`
        gram can be `None` if method is 'threshold'.

    cov : ndarray of shape (n_components, n_samples), default=None
        Precomputed covariance, `dictionary * X'`.

    algorithm : {'lasso_lars', 'lasso_cd', 'lars', 'omp', 'threshold'}, \
            default='lasso_lars'
        The algorithm used:

        * `'lars'`: uses the least angle regression method
          (`linear_model.lars_path`);
        * `'lasso_lars'`: uses Lars to compute the Lasso solution;
        * `'lasso_cd'`: uses the coordinate descent method to compute the
          Lasso solution (`linear_model.Lasso`). lasso_lars will be faster if
          the estimated components are sparse;
        * `'omp'`: uses orthogonal matching pursuit to estimate the sparse
          solution;
        * `'threshold'`: squashes to zero all coefficients less than
          regularization from the projection `dictionary * data'`.

    regularization : int or float, default=None
        The regularization parameter. It corresponds to alpha when
        algorithm is `'lasso_lars'`, `'lasso_cd'` or `'threshold'`.
        Otherwise it corresponds to `n_nonzero_coefs`.

    init : ndarray of shape (n_samples, n_components), default=None
        Initialization value of the sparse code. Only used if
        `algorithm='lasso_cd'`.

    max_iter : int, default=1000
        Maximum number of iterations to perform if `algorithm='lasso_cd'` or
        `'lasso_lars'`.

    copy_cov : bool, default=True
        Whether to copy the precomputed covariance matrix; if `False`, it may
        be overwritten.

    check_input : bool, default=True
        If `False`, the input arrays `X` and dictionary will not be checked.

    verbose : int, default=0
        Controls the verbosity; the higher, the more messages.

    positive: bool, default=False
        Whether to enforce a positivity constraint on the sparse code.

        .. versionadded:: 0.20

    Returns
    -------
    code : ndarray of shape (n_components, n_features)
        The sparse codes.

    See Also
    --------
    sklearn.linear_model.lars_path
    sklearn.linear_model.orthogonal_mp
    sklearn.linear_model.Lasso
    SparseCoder
    """</span>
    <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Dictionary and X have different numbers of features:"</span>
                         <span class="string-literal">"dictionary.shape: {} X.shape{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                             <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">cov</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">algorithm</span> <span class="relational-operator">!=</span> <span class="string-literal">'lasso_cd'</span><span class="punctuation">:</span>
        <span class="comment"># overwriting cov is safe</span>
        <span class="identifier">copy_cov</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">_check_positive_coding</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'lasso_lars'</span><span class="punctuation">:</span>
        <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">regularization</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_features</span>  <span class="comment"># account for scaling</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">err_mgt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">seterr</span><span class="grouping">(</span><span class="identifier">all</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ignore'</span><span class="grouping">)</span>

            <span class="comment"># Not passing in verbose=max(0, verbose-1) because Lars.fit already</span>
            <span class="comment"># corrects the verbosity level.</span>
            <span class="identifier">lasso_lars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LassoLars</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                   <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                   <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="identifier">gram</span><span class="punctuation">,</span> <span class="identifier">fit_path</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                   <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="grouping">)</span>
            <span class="identifier">lasso_lars</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="arithmetic-assignment">=</span><span class="identifier">cov</span><span class="grouping">)</span>
            <span class="identifier">new_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lasso_lars</span><span class="punctuation">.</span><span class="identifier">coef_</span>
        <span class="keyword">finally</span><span class="punctuation">:</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">seterr</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">err_mgt</span><span class="grouping">)</span>

    <span class="keyword">elif</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'lasso_cd'</span><span class="punctuation">:</span>
        <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">regularization</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_features</span>  <span class="comment"># account for scaling</span>

        <span class="comment"># TODO: Make verbosity argument for Lasso?</span>
        <span class="comment"># sklearn.linear_model.coordinate_descent.enet_path has a verbosity</span>
        <span class="comment"># argument that we could pass in from Lasso.</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Lasso</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="identifier">gram</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                    <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">init</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">init</span>

        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="identifier">check_input</span><span class="grouping">)</span>
        <span class="identifier">new_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="keyword">elif</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'lars'</span><span class="punctuation">:</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">err_mgt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">seterr</span><span class="grouping">(</span><span class="identifier">all</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ignore'</span><span class="grouping">)</span>

            <span class="comment"># Not passing in verbose=max(0, verbose-1) because Lars.fit already</span>
            <span class="comment"># corrects the verbosity level.</span>
            <span class="identifier">lars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Lars</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                        <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="identifier">gram</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">fit_path</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">lars</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="arithmetic-assignment">=</span><span class="identifier">cov</span><span class="grouping">)</span>
            <span class="identifier">new_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lars</span><span class="punctuation">.</span><span class="identifier">coef_</span>
        <span class="keyword">finally</span><span class="punctuation">:</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">seterr</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">err_mgt</span><span class="grouping">)</span>

    <span class="keyword">elif</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'threshold'</span><span class="punctuation">:</span>
        <span class="identifier">new_code</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">regularization</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">positive</span><span class="punctuation">:</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">new_code</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">new_code</span><span class="grouping">)</span>

    <span class="keyword">elif</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'omp'</span><span class="punctuation">:</span>
        <span class="identifier">new_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orthogonal_mp_gram</span><span class="grouping">(</span>
            <span class="identifier">Gram</span><span class="arithmetic-assignment">=</span><span class="identifier">gram</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="arithmetic-assignment">=</span><span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">norms_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">row_norms</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">copy_Xy</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_cov</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Sparse coding method must be "lasso_lars" '</span>
                         <span class="string-literal">'"lasso_cd", "lasso", "threshold" or "omp", got %s.'</span>
                         <span class="arithmetic-operator">%</span> <span class="identifier">algorithm</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">new_code</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">new_code</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">new_code</span>


<span class="comment"># XXX : could be moved to the linear_model module</span>
<span class="keyword">def</span> <span class="identifier">sparse_encode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">gram</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                  <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lasso_lars'</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                  <span class="identifier">copy_cov</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                  <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Sparse coding

    Each row of the result is the solution to a sparse coding problem.
    The goal is to find a sparse array `code` such that::

        X ~= code * dictionary

    Read more in the :ref:`User Guide &lt;SparseCoder&gt;`.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Data matrix.

    dictionary : ndarray of shape (n_components, n_features)
        The dictionary matrix against which to solve the sparse coding of
        the data. Some of the algorithms assume normalized rows for meaningful
        output.

    gram : ndarray of shape (n_components, n_components), default=None
        Precomputed Gram matrix, `dictionary * dictionary'`.

    cov : ndarray of shape (n_components, n_samples), default=None
        Precomputed covariance, `dictionary' * X`.

    algorithm : {'lasso_lars', 'lasso_cd', 'lars', 'omp', 'threshold'}, \
            default='lasso_lars'
        The algorithm used:

        * `'lars'`: uses the least angle regression method
          (`linear_model.lars_path`);
        * `'lasso_lars'`: uses Lars to compute the Lasso solution;
        * `'lasso_cd'`: uses the coordinate descent method to compute the
          Lasso solution (`linear_model.Lasso`). lasso_lars will be faster if
          the estimated components are sparse;
        * `'omp'`: uses orthogonal matching pursuit to estimate the sparse
          solution;
        * `'threshold'`: squashes to zero all coefficients less than
          regularization from the projection `dictionary * data'`.

    n_nonzero_coefs : int, default=None
        Number of nonzero coefficients to target in each column of the
        solution. This is only used by `algorithm='lars'` and `algorithm='omp'`
        and is overridden by `alpha` in the `omp` case. If `None`, then
        `n_nonzero_coefs=int(n_features / 10)`.

    alpha : float, default=None
        If `algorithm='lasso_lars'` or `algorithm='lasso_cd'`, `alpha` is the
        penalty applied to the L1 norm.
        If `algorithm='threshold'`, `alpha` is the absolute value of the
        threshold below which coefficients will be squashed to zero.
        If `algorithm='omp'`, `alpha` is the tolerance parameter: the value of
        the reconstruction error targeted. In this case, it overrides
        `n_nonzero_coefs`.
        If `None`, default to 1.

    copy_cov : bool, default=True
        Whether to copy the precomputed covariance matrix; if `False`, it may
        be overwritten.

    init : ndarray of shape (n_samples, n_components), default=None
        Initialization value of the sparse codes. Only used if
        `algorithm='lasso_cd'`.

    max_iter : int, default=1000
        Maximum number of iterations to perform if `algorithm='lasso_cd'` or
        `'lasso_lars'`.

    n_jobs : int, default=None
        Number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    check_input : bool, default=True
        If `False`, the input arrays X and dictionary will not be checked.

    verbose : int, default=0
        Controls the verbosity; the higher, the more messages.

    positive : bool, default=False
        Whether to enforce positivity when finding the encoding.

        .. versionadded:: 0.20

    Returns
    -------
    code : ndarray of shape (n_samples, n_components)
        The sparse codes

    See Also
    --------
    sklearn.linear_model.lars_path
    sklearn.linear_model.orthogonal_mp
    sklearn.linear_model.Lasso
    SparseCoder
    """</span>
    <span class="keyword">if</span> <span class="identifier">check_input</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'lasso_cd'</span><span class="punctuation">:</span>
            <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'C', dtype='float64'</span><span class="grouping">)</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'C', dtype='float64'</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="grouping">)</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">gram</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">algorithm</span> <span class="relational-operator">!=</span> <span class="string-literal">'threshold'</span><span class="punctuation">:</span>
        <span class="identifier">gram</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">cov</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">algorithm</span> <span class="relational-operator">!=</span> <span class="string-literal">'lasso_cd'</span><span class="punctuation">:</span>
        <span class="identifier">copy_cov</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">algorithm</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'lars', 'omp'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">regularization</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_nonzero_coefs</span>
        <span class="keyword">if</span> <span class="identifier">regularization</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">regularization</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">/</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">regularization</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="keyword">if</span> <span class="identifier">regularization</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">regularization</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>

    <span class="keyword">if</span> <span class="identifier">effective_n_jobs</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span> <span class="logical-operator">or</span> <span class="identifier">algorithm</span> <span class="relational-operator">==</span> <span class="string-literal">'threshold'</span><span class="punctuation">:</span>
        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_encode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span>
                              <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">gram</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="arithmetic-assignment">=</span><span class="identifier">cov</span><span class="punctuation">,</span>
                              <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">algorithm</span><span class="punctuation">,</span>
                              <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">copy_cov</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_cov</span><span class="punctuation">,</span>
                              <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span>
                              <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
                              <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                              <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span>
                              <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">code</span>

    <span class="comment"># Enter parallel code block</span>
    <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">gen_even_slices</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">effective_n_jobs</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">code_views</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Parallel</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="grouping">)</span><span class="grouping">(</span>
        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">_sparse_encode</span><span class="grouping">)</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">this_slice</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">gram</span><span class="punctuation">,</span>
            <span class="identifier">cov</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">this_slice</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">cov</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="none-literal">None</span><span class="punctuation">,</span>
            <span class="identifier">algorithm</span><span class="punctuation">,</span>
            <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">copy_cov</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_cov</span><span class="punctuation">,</span>
            <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">[</span><span class="identifier">this_slice</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">init</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="none-literal">None</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
            <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span>
            <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">this_slice</span> <span class="relational-operator">in</span> <span class="identifier">slices</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">this_slice</span><span class="punctuation">,</span> <span class="identifier">this_view</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">slices</span><span class="punctuation">,</span> <span class="identifier">code_views</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">code</span><span class="grouping">[</span><span class="identifier">this_slice</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">this_view</span>
    <span class="keyword">return</span> <span class="identifier">code</span>


<span class="keyword">def</span> <span class="identifier">_update_dict</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Update the dense dictionary factor in place.

    Parameters
    ----------
    dictionary : ndarray of shape (n_components, n_features)
        Value of the dictionary at the previous iteration.

    Y : ndarray of shape (n_samples, n_features)
        Data matrix.

    code : ndarray of shape (n_samples, n_components)
        Sparse coding of the data against which to optimize the dictionary.

    A : ndarray of shape (n_components, n_components), default=None
        Together with `B`, sufficient stats of the online model to update the
        dictionary.

    B : ndarray of shape (n_features, n_components), default=None
        Together with `A`, sufficient stats of the online model to update the
        dictionary.

    verbose: bool, default=False
        Degree of output the procedure will print.

    random_state : int, RandomState instance or None, default=None
        Used for randomly initializing the dictionary. Pass an int for
        reproducible results across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    positive : bool, default=False
        Whether to enforce positivity when finding the dictionary.

        .. versionadded:: 0.20
    """</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">code</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">A</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">code</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="punctuation">@</span> <span class="identifier">code</span>
    <span class="keyword">if</span> <span class="identifier">B</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="punctuation">@</span> <span class="identifier">code</span>

    <span class="identifier">n_unused</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">A</span><span class="grouping">[</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">1e-6</span><span class="punctuation">:</span>
            <span class="comment"># 1e-6 is arbitrary but consistent with the spams implementation</span>
            <span class="identifier">dictionary</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">B</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="punctuation">@</span> <span class="identifier">dictionary</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">A</span><span class="grouping">[</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># kth atom is almost never used -&gt; sample a new one from the data</span>
            <span class="identifier">newd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">]</span>

            <span class="comment"># add small noise to avoid making the sparse coding ill conditioned</span>
            <span class="identifier">noise_level</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.01</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">newd</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># avoid 0 std</span>
            <span class="identifier">noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">noise_level</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">newd</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="identifier">dictionary</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">newd</span> <span class="arithmetic-operator">+</span> <span class="identifier">noise</span>
            <span class="identifier">code</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="identifier">n_unused</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

        <span class="keyword">if</span> <span class="identifier">positive</span><span class="punctuation">:</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">dictionary</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Projection on the constraint set ||V_k|| == 1</span>
        <span class="identifier">dictionary</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="logical-operator">and</span> <span class="identifier">n_unused</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"{n_unused} unused atoms resampled."</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">dict_learning</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-8</span><span class="punctuation">,</span>
                  <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lars'</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">code_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                  <span class="identifier">callback</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                  <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">method_max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Solves a dictionary learning matrix factorization problem.

    Finds the best dictionary and the corresponding sparse code for
    approximating the data matrix X by solving::

        (U^*, V^*) = argmin 0.5 || X - U V ||_Fro^2 + alpha * || U ||_1,1
                     (U,V)
                    with || V_k ||_2 = 1 for all  0 &lt;= k &lt; n_components

    where V is the dictionary and U is the sparse code. ||.||_Fro stands for
    the Frobenius norm and ||.||_1,1 stands for the entry-wise matrix norm
    which is the sum of the absolute values of all the entries in the matrix.

    Read more in the :ref:`User Guide &lt;DictionaryLearning&gt;`.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Data matrix.

    n_components : int
        Number of dictionary atoms to extract.

    alpha : int
        Sparsity controlling parameter.

    max_iter : int, default=100
        Maximum number of iterations to perform.

    tol : float, default=1e-8
        Tolerance for the stopping condition.

    method : {'lars', 'cd'}, default='lars'
        The method used:

        * `'lars'`: uses the least angle regression method to solve the lasso
           problem (`linear_model.lars_path`);
        * `'cd'`: uses the coordinate descent method to compute the
          Lasso solution (`linear_model.Lasso`). Lars will be faster if
          the estimated components are sparse.

    n_jobs : int, default=None
        Number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    dict_init : ndarray of shape (n_components, n_features), default=None
        Initial value for the dictionary for warm restart scenarios. Only used
        if `code_init` and `dict_init` are not None.

    code_init : ndarray of shape (n_samples, n_components), default=None
        Initial value for the sparse code for warm restart scenarios. Only used
        if `code_init` and `dict_init` are not None.

    callback : callable, default=None
        Callable that gets invoked every five iterations

    verbose : bool, default=False
        To control the verbosity of the procedure.

    random_state : int, RandomState instance or None, default=None
        Used for randomly initializing the dictionary. Pass an int for
        reproducible results across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    return_n_iter : bool, default=False
        Whether or not to return the number of iterations.

    positive_dict : bool, default=False
        Whether to enforce positivity when finding the dictionary.

        .. versionadded:: 0.20

    positive_code : bool, default=False
        Whether to enforce positivity when finding the code.

        .. versionadded:: 0.20

    method_max_iter : int, default=1000
        Maximum number of iterations to perform.

        .. versionadded:: 0.22

    Returns
    -------
    code : ndarray of shape (n_samples, n_components)
        The sparse code factor in the matrix factorization.

    dictionary : ndarray of shape (n_components, n_features),
        The dictionary factor in the matrix factorization.

    errors : array
        Vector of errors at each iteration.

    n_iter : int
        Number of iterations run. Returned only if `return_n_iter` is
        set to True.

    See Also
    --------
    dict_learning_online
    DictionaryLearning
    MiniBatchDictionaryLearning
    SparsePCA
    MiniBatchSparsePCA
    """</span>
    <span class="keyword">if</span> <span class="identifier">method</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'lars', 'cd'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Coding method %r not supported as a fit algorithm.'</span>
                         <span class="arithmetic-operator">%</span> <span class="identifier">method</span><span class="grouping">)</span>

    <span class="identifier">_check_positive_coding</span><span class="grouping">(</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="grouping">)</span>

    <span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'lasso_'</span> <span class="arithmetic-operator">+</span> <span class="identifier">method</span>

    <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># Avoid integer division problems</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="grouping">)</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>

    <span class="comment"># Init the code and the dictionary with SVD of Y</span>
    <span class="keyword">if</span> <span class="identifier">code_init</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">dict_init</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">code_init</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'F'</span><span class="grouping">)</span>
        <span class="comment"># Don't copy V, it will happen below</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_init</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">svd</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">full_matrices</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="comment"># flip the initial code's sign to enforce deterministic output</span>
        <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svd_flip</span><span class="grouping">(</span><span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="grouping">)</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">S</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">dictionary</span>
    <span class="identifier">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">&lt;=</span> <span class="identifier">r</span><span class="punctuation">:</span>  <span class="comment"># True even if n_components=None</span>
        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">code</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dictionary</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">code</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-operator">-</span> <span class="identifier">r</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">dictionary</span><span class="punctuation">,</span>
                           <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">-</span> <span class="identifier">r</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="comment"># Fortran-order dict better suited for the sparse coding which is the</span>
    <span class="comment"># bottleneck of this algorithm.</span>
    <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="grouping">)</span>

    <span class="identifier">errors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="identifier">current_cost</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[dict_learning]', end=' '</span><span class="grouping">)</span>

    <span class="comment"># If max_iter is 0, number of iterations returned should be zero</span>
    <span class="identifier">ii</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

    <span class="keyword">for</span> <span class="identifier">ii</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">dt</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">"."</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">flush</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Iteration % 3i "</span>
                  <span class="string-literal">"(elapsed time: % 3is, % 4.1fmn, current cost % 7.3f)"</span>
                  <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">dt</span><span class="punctuation">,</span> <span class="identifier">dt</span> <span class="arithmetic-operator">/</span> <span class="int-literal">60</span><span class="punctuation">,</span> <span class="identifier">current_cost</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Update code</span>
        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_encode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                             <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive_code</span><span class="punctuation">,</span>
                             <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">method_max_iter</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="grouping">)</span>

        <span class="comment"># Update dictionary in place</span>
        <span class="identifier">_update_dict</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span>
                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive_dict</span><span class="grouping">)</span>

        <span class="comment"># Cost function</span>
        <span class="identifier">current_cost</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">code</span> <span class="punctuation">@</span> <span class="identifier">dictionary</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="grouping">)</span>
                        <span class="arithmetic-operator">+</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">code</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">errors</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">current_cost</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">ii</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">dE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">errors</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">errors</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="comment"># assert(dE &gt;= -tol * errors[-1])</span>
            <span class="keyword">if</span> <span class="identifier">dE</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol</span> <span class="arithmetic-operator">*</span> <span class="identifier">errors</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                    <span class="comment"># A line return</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">""</span><span class="grouping">)</span>
                <span class="keyword">elif</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"--- Convergence reached after %d iterations"</span> <span class="arithmetic-operator">%</span> <span class="identifier">ii</span><span class="grouping">)</span>
                <span class="keyword">break</span>
        <span class="keyword">if</span> <span class="identifier">ii</span> <span class="arithmetic-operator">%</span> <span class="int-literal">5</span> <span class="relational-operator">==</span> <span class="int-literal">0</span> <span class="logical-operator">and</span> <span class="identifier">callback</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">callback</span><span class="grouping">(</span><span class="identifier">locals</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">errors</span><span class="punctuation">,</span> <span class="identifier">ii</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">errors</span>


<span class="keyword">def</span> <span class="identifier">dict_learning_online</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                         <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">callback</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                         <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                         <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lars'</span><span class="punctuation">,</span> <span class="identifier">iter_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">inner_stats</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                         <span class="identifier">method_max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Solves a dictionary learning matrix factorization problem online.

    Finds the best dictionary and the corresponding sparse code for
    approximating the data matrix X by solving::

        (U^*, V^*) = argmin 0.5 || X - U V ||_Fro^2 + alpha * || U ||_1,1
                     (U,V)
                     with || V_k ||_2 = 1 for all  0 &lt;= k &lt; n_components

    where V is the dictionary and U is the sparse code. ||.||_Fro stands for
    the Frobenius norm and ||.||_1,1 stands for the entry-wise matrix norm
    which is the sum of the absolute values of all the entries in the matrix.
    This is accomplished by repeatedly iterating over mini-batches by slicing
    the input data.

    Read more in the :ref:`User Guide &lt;DictionaryLearning&gt;`.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Data matrix.

    n_components : int, default=2
        Number of dictionary atoms to extract.

    alpha : float, default=1
        Sparsity controlling parameter.

    n_iter : int, default=100
        Number of mini-batch iterations to perform.

    return_code : bool, default=True
        Whether to also return the code U or just the dictionary `V`.

    dict_init : ndarray of shape (n_components, n_features), default=None
        Initial value for the dictionary for warm restart scenarios.

    callback : callable, default=None
        callable that gets invoked every five iterations.

    batch_size : int, default=3
        The number of samples to take in each batch.

    verbose : bool, default=False
        To control the verbosity of the procedure.

    shuffle : bool, default=True
        Whether to shuffle the data before splitting it in batches.

    n_jobs : int, default=None
        Number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    method : {'lars', 'cd'}, default='lars'
        * `'lars'`: uses the least angle regression method to solve the lasso
          problem (`linear_model.lars_path`);
        * `'cd'`: uses the coordinate descent method to compute the
          Lasso solution (`linear_model.Lasso`). Lars will be faster if
          the estimated components are sparse.

    iter_offset : int, default=0
        Number of previous iterations completed on the dictionary used for
        initialization.

    random_state : int, RandomState instance or None, default=None
        Used for initializing the dictionary when ``dict_init`` is not
        specified, randomly shuffling the data when ``shuffle`` is set to
        ``True``, and updating the dictionary. Pass an int for reproducible
        results across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    return_inner_stats : bool, default=False
        Return the inner statistics A (dictionary covariance) and B
        (data approximation). Useful to restart the algorithm in an
        online setting. If `return_inner_stats` is `True`, `return_code` is
        ignored.

    inner_stats : tuple of (A, B) ndarrays, default=None
        Inner sufficient statistics that are kept by the algorithm.
        Passing them at initialization is useful in online settings, to
        avoid losing the history of the evolution.
        `A` `(n_components, n_components)` is the dictionary covariance matrix.
        `B` `(n_features, n_components)` is the data approximation matrix.

    return_n_iter : bool, default=False
        Whether or not to return the number of iterations.

    positive_dict : bool, default=False
        Whether to enforce positivity when finding the dictionary.

        .. versionadded:: 0.20

    positive_code : bool, default=False
        Whether to enforce positivity when finding the code.

        .. versionadded:: 0.20

    method_max_iter : int, default=1000
        Maximum number of iterations to perform when solving the lasso problem.

        .. versionadded:: 0.22

    Returns
    -------
    code : ndarray of shape (n_samples, n_components),
        The sparse code (only returned if `return_code=True`).

    dictionary : ndarray of shape (n_components, n_features),
        The solutions to the dictionary learning problem.

    n_iter : int
        Number of iterations run. Returned only if `return_n_iter` is
        set to `True`.

    See Also
    --------
    dict_learning
    DictionaryLearning
    MiniBatchDictionaryLearning
    SparsePCA
    MiniBatchSparsePCA
    """</span>
    <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">method</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'lars', 'cd'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Coding method not supported as a fit algorithm.'</span><span class="grouping">)</span>

    <span class="identifier">_check_positive_coding</span><span class="grouping">(</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="grouping">)</span>

    <span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'lasso_'</span> <span class="arithmetic-operator">+</span> <span class="identifier">method</span>

    <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="comment"># Avoid integer division problems</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="grouping">)</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>

    <span class="comment"># Init V with SVD of X</span>
    <span class="keyword">if</span> <span class="identifier">dict_init</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_init</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">randomized_svd</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span>
                                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">S</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">dictionary</span>
    <span class="identifier">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">&lt;=</span> <span class="identifier">r</span><span class="punctuation">:</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dictionary</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">dictionary</span><span class="punctuation">,</span>
                           <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span> <span class="arithmetic-operator">-</span> <span class="identifier">r</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[dict_learning]', end=' '</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">shuffle</span><span class="punctuation">:</span>
        <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span>

    <span class="comment"># Fortran-order dict better suited for the sparse coding which is the</span>
    <span class="comment"># bottleneck of this algorithm.</span>
    <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'F'</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span>
                             <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">require</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">requirements</span><span class="arithmetic-assignment">=</span><span class="string-literal">'W'</span><span class="grouping">)</span>

    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'C'</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">batches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gen_batches</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="grouping">)</span>
    <span class="identifier">batches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">cycle</span><span class="grouping">(</span><span class="identifier">batches</span><span class="grouping">)</span>

    <span class="comment"># The covariance of the dictionary</span>
    <span class="keyword">if</span> <span class="identifier">inner_stats</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># The data approximation</span>
        <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inner_stats</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">B</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inner_stats</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># If n_iter is zero, we need to return zero.</span>
    <span class="identifier">ii</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iter_offset</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="keyword">for</span> <span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">batch</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">iter_offset</span><span class="punctuation">,</span> <span class="identifier">iter_offset</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_iter</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">batches</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">this_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train</span><span class="grouping">[</span><span class="identifier">batch</span><span class="grouping">]</span>
        <span class="identifier">dt</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">"."</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">flush</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;</span> <span class="int-literal">10</span> <span class="logical-operator">or</span> <span class="identifier">ii</span> <span class="arithmetic-operator">%</span> <span class="identifier">ceil</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">verbose</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Iteration % 3i (elapsed time: % 3is, % 4.1fmn)"</span>
                      <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">dt</span><span class="punctuation">,</span> <span class="identifier">dt</span> <span class="arithmetic-operator">/</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">this_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_encode</span><span class="grouping">(</span><span class="identifier">this_X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span>
                                  <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="punctuation">,</span>
                                  <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                  <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive_code</span><span class="punctuation">,</span>
                                  <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">method_max_iter</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="grouping">)</span>

        <span class="comment"># Update the auxiliary variables</span>
        <span class="keyword">if</span> <span class="identifier">ii</span> <span class="relational-operator">&lt;</span> <span class="identifier">batch_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">ii</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">batch_size</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">batch_size</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">ii</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">batch_size</span><span class="grouping">)</span>
        <span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">theta</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">batch_size</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">theta</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">A</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">beta</span>
        <span class="identifier">A</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">this_code</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">this_code</span><span class="grouping">)</span>
        <span class="identifier">B</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">beta</span>
        <span class="identifier">B</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">this_X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">this_code</span><span class="grouping">)</span>

        <span class="comment"># Update dictionary in place</span>
        <span class="identifier">_update_dict</span><span class="grouping">(</span><span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">this_X</span><span class="punctuation">,</span> <span class="identifier">this_code</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span>
                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive_dict</span><span class="grouping">)</span>

        <span class="comment"># Maybe we need a stopping criteria based on the amount of</span>
        <span class="comment"># modification in the dictionary</span>
        <span class="keyword">if</span> <span class="identifier">callback</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">callback</span><span class="grouping">(</span><span class="identifier">locals</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ii</span> <span class="arithmetic-operator">-</span> <span class="identifier">iter_offset</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Learning code...', end=' '</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'|', end=' '</span><span class="grouping">)</span>
        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_encode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                             <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">check_input</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                             <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">positive_code</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">method_max_iter</span><span class="punctuation">,</span>
                             <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">dt</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'done (total time: % 3is, % 4.1fmn)'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dt</span><span class="punctuation">,</span> <span class="identifier">dt</span> <span class="arithmetic-operator">/</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">ii</span> <span class="arithmetic-operator">-</span> <span class="identifier">iter_offset</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">code</span><span class="punctuation">,</span> <span class="identifier">dictionary</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">ii</span> <span class="arithmetic-operator">-</span> <span class="identifier">iter_offset</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">dictionary</span>


<span class="keyword">class</span> <span class="identifier">_BaseSparseCoding</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Base class from SparseCoder and DictionaryLearning algorithms."""</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">transform_algorithm</span><span class="punctuation">,</span> <span class="identifier">transform_n_nonzero_coefs</span><span class="punctuation">,</span>
                 <span class="identifier">transform_alpha</span><span class="punctuation">,</span> <span class="identifier">split_sign</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="punctuation">,</span>
                 <span class="identifier">transform_max_iter</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_algorithm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform_algorithm</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_n_nonzero_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform_n_nonzero_coefs</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform_alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform_max_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">split_sign</span> <span class="arithmetic-assignment">=</span> <span class="identifier">split_sign</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_jobs</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">positive_code</span>

    <span class="keyword">def</span> <span class="identifier">_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Private method allowing to accomodate both DictionaryLearning and
        SparseCoder."""</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="comment"># transform_alpha has to be changed in _transform</span>
        <span class="comment"># this is done for consistency with the value of alpha</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">"alpha"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="logical-operator">and</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_alpha</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"By default transform_alpha will be equal to"</span>
                          <span class="string-literal">"alpha instead of 1.0 starting from version 1.2"</span><span class="punctuation">,</span>
                          <span class="identifier">FutureWarning</span><span class="grouping">)</span>
            <span class="identifier">transform_alpha</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>  <span class="comment"># TODO change to self.alpha in 1.2</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">transform_alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_alpha</span>

        <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_encode</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_algorithm</span><span class="punctuation">,</span>
            <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_n_nonzero_coefs</span><span class="punctuation">,</span>
            <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">transform_alpha</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_max_iter</span><span class="punctuation">,</span>
            <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_code</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">split_sign</span><span class="punctuation">:</span>
            <span class="comment"># feature vector is split into a positive and negative side</span>
            <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">code</span><span class="punctuation">.</span><span class="identifier">shape</span>
            <span class="identifier">split_code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">split_code</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_features</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">code</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">split_code</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">code</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">code</span> <span class="arithmetic-assignment">=</span> <span class="identifier">split_code</span>

        <span class="keyword">return</span> <span class="identifier">code</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Encode the data as a sparse combination of the dictionary atoms.

        Coding method is determined by the object parameter
        `transform_algorithm`.

        Parameters
        ----------
        X : ndarray of shape (n_samples, n_features)
            Test data to be transformed, must have the same number of
            features as the data used to train the model.

        Returns
        -------
        X_new : ndarray of shape (n_samples, n_components)
            Transformed data.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">SparseCoder</span><span class="grouping">(</span><span class="identifier">_BaseSparseCoding</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Sparse coding

    Finds a sparse representation of data against a fixed, precomputed
    dictionary.

    Each row of the result is the solution to a sparse coding problem.
    The goal is to find a sparse array `code` such that::

        X ~= code * dictionary

    Read more in the :ref:`User Guide &lt;SparseCoder&gt;`.

    Parameters
    ----------
    dictionary : ndarray of shape (n_components, n_features)
        The dictionary atoms used for sparse coding. Lines are assumed to be
        normalized to unit norm.

    transform_algorithm : {'lasso_lars', 'lasso_cd', 'lars', 'omp', \
            'threshold'}, default='omp'
        Algorithm used to transform the data:

        - `'lars'`: uses the least angle regression method
          (`linear_model.lars_path`);
        - `'lasso_lars'`: uses Lars to compute the Lasso solution;
        - `'lasso_cd'`: uses the coordinate descent method to compute the
          Lasso solution (linear_model.Lasso). `'lasso_lars'` will be faster if
          the estimated components are sparse;
        - `'omp'`: uses orthogonal matching pursuit to estimate the sparse
          solution;
        - `'threshold'`: squashes to zero all coefficients less than alpha from
          the projection ``dictionary * X'``.

    transform_n_nonzero_coefs : int, default=None
        Number of nonzero coefficients to target in each column of the
        solution. This is only used by `algorithm='lars'` and `algorithm='omp'`
        and is overridden by `alpha` in the `omp` case. If `None`, then
        `transform_n_nonzero_coefs=int(n_features / 10)`.

    transform_alpha : float, default=None
        If `algorithm='lasso_lars'` or `algorithm='lasso_cd'`, `alpha` is the
        penalty applied to the L1 norm.
        If `algorithm='threshold'`, `alpha` is the absolute value of the
        threshold below which coefficients will be squashed to zero.
        If `algorithm='omp'`, `alpha` is the tolerance parameter: the value of
        the reconstruction error targeted. In this case, it overrides
        `n_nonzero_coefs`.
        If `None`, default to 1.

    split_sign : bool, default=False
        Whether to split the sparse feature vector into the concatenation of
        its negative part and its positive part. This can improve the
        performance of downstream classifiers.

    n_jobs : int, default=None
        Number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    positive_code : bool, default=False
        Whether to enforce positivity when finding the code.

        .. versionadded:: 0.20

    transform_max_iter : int, default=1000
        Maximum number of iterations to perform if `algorithm='lasso_cd'` or
        `lasso_lars`.

        .. versionadded:: 0.22

    Attributes
    ----------
    components_ : ndarray of shape (n_components, n_features)
        The unchanged dictionary atoms.

        .. deprecated:: 0.24
           This attribute is deprecated in 0.24 and will be removed in
           1.1 (renaming of 0.26). Use `dictionary` instead.

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.decomposition import SparseCoder
    &gt;&gt;&gt; X = np.array([[-1, -1, -1], [0, 0, 3]])
    &gt;&gt;&gt; dictionary = np.array(
    ...     [[0, 1, 0],
    ...      [-1, -1, 2],
    ...      [1, 1, 1],
    ...      [0, 1, 1],
    ...      [0, 2, 1]],
    ...    dtype=np.float64
    ... )
    &gt;&gt;&gt; coder = SparseCoder(
    ...     dictionary=dictionary, transform_algorithm='lasso_lars',
    ...     transform_alpha=1e-10,
    ... )
    &gt;&gt;&gt; coder.transform(X)
    array([[ 0.,  0., -1.,  0.,  0.],
           [ 0.,  1.,  1.,  0.,  0.]])

    See Also
    --------
    DictionaryLearning
    MiniBatchDictionaryLearning
    SparsePCA
    MiniBatchSparsePCA
    sparse_encode
    """</span>
    <span class="identifier">_required_parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"dictionary"</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">dictionary</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">transform_algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'omp'</span><span class="punctuation">,</span>
                 <span class="identifier">transform_n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">transform_alpha</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">split_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">transform_max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span>
            <span class="identifier">transform_algorithm</span><span class="punctuation">,</span> <span class="identifier">transform_n_nonzero_coefs</span><span class="punctuation">,</span>
            <span class="identifier">transform_alpha</span><span class="punctuation">,</span> <span class="identifier">split_sign</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="punctuation">,</span>
            <span class="identifier">transform_max_iter</span>
        <span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dictionary</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dictionary</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Do nothing and return the estimator unchanged.

        This method is just there to implement the usual API and hence
        work in pipelines.

        Parameters
        ----------
        X : Ignored

        y : Ignored

        Returns
        -------
        self : object
        """</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="punctuation">@</span><span class="identifier">deprecated</span><span class="grouping">(</span><span class="string-literal">"The attribute 'components_' is deprecated "</span>  <span class="comment"># type: ignore</span>
                <span class="string-literal">"in 0.24 and will be removed in 1.1 (renaming of 0.26). Use "</span>
                <span class="string-literal">"the 'dictionary' instead."</span><span class="grouping">)</span>
    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">components_</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dictionary</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Encode the data as a sparse combination of the dictionary atoms.

        Coding method is determined by the object parameter
        `transform_algorithm`.

        Parameters
        ----------
        X : ndarray of shape (n_samples, n_features)
            Test data to be transformed, must have the same number of
            features as the data used to train the model.

        y : Ignored

        Returns
        -------
        X_new : ndarray of shape (n_samples, n_components)
            Transformed data.
        """</span>
        <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dictionary</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">"requires_fit"</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="grouping">}</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">n_components_</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">n_features_in_</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dictionary</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">DictionaryLearning</span><span class="grouping">(</span><span class="identifier">_BaseSparseCoding</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Dictionary learning

    Finds a dictionary (a set of atoms) that can best be used to represent data
    using a sparse code.

    Solves the optimization problem::

        (U^*,V^*) = argmin 0.5 || X - U V ||_Fro^2 + alpha * || U ||_1,1
                    (U,V)
                    with || V_k ||_2 = 1 for all  0 &lt;= k &lt; n_components

    ||.||_Fro stands for the Frobenius norm and ||.||_1,1 stands for
    the entry-wise matrix norm which is the sum of the absolute values
    of all the entries in the matrix.

    Read more in the :ref:`User Guide &lt;DictionaryLearning&gt;`.

    Parameters
    ----------
    n_components : int, default=n_features
        Number of dictionary elements to extract.

    alpha : float, default=1.0
        Sparsity controlling parameter.

    max_iter : int, default=1000
        Maximum number of iterations to perform.

    tol : float, default=1e-8
        Tolerance for numerical error.

    fit_algorithm : {'lars', 'cd'}, default='lars'
        * `'lars'`: uses the least angle regression method to solve the lasso
          problem (:func:`~sklearn.linear_model.lars_path`);
        * `'cd'`: uses the coordinate descent method to compute the
          Lasso solution (:class:`~sklearn.linear_model.Lasso`). Lars will be
          faster if the estimated components are sparse.

        .. versionadded:: 0.17
           *cd* coordinate descent method to improve speed.

    transform_algorithm : {'lasso_lars', 'lasso_cd', 'lars', 'omp', \
            'threshold'}, default='omp'
        Algorithm used to transform the data:

        - `'lars'`: uses the least angle regression method
          (:func:`~sklearn.linear_model.lars_path`);
        - `'lasso_lars'`: uses Lars to compute the Lasso solution.
        - `'lasso_cd'`: uses the coordinate descent method to compute the
          Lasso solution (:class:`~sklearn.linear_model.Lasso`). `'lasso_lars'`
          will be faster if the estimated components are sparse.
        - `'omp'`: uses orthogonal matching pursuit to estimate the sparse
          solution.
        - `'threshold'`: squashes to zero all coefficients less than alpha from
          the projection ``dictionary * X'``.

        .. versionadded:: 0.17
           *lasso_cd* coordinate descent method to improve speed.

    transform_n_nonzero_coefs : int, default=None
        Number of nonzero coefficients to target in each column of the
        solution. This is only used by `algorithm='lars'` and
        `algorithm='omp'`. If `None`, then
        `transform_n_nonzero_coefs=int(n_features / 10)`.

    transform_alpha : float, default=None
        If `algorithm='lasso_lars'` or `algorithm='lasso_cd'`, `alpha` is the
        penalty applied to the L1 norm.
        If `algorithm='threshold'`, `alpha` is the absolute value of the
        threshold below which coefficients will be squashed to zero.
        If `None`, defaults to `alpha`.

    n_jobs : int or None, default=None
        Number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    code_init : ndarray of shape (n_samples, n_components), default=None
        Initial value for the code, for warm restart. Only used if `code_init`
        and `dict_init` are not None.

    dict_init : ndarray of shape (n_components, n_features), default=None
        Initial values for the dictionary, for warm restart. Only used if
        `code_init` and `dict_init` are not None.

    verbose : bool, default=False
        To control the verbosity of the procedure.

    split_sign : bool, default=False
        Whether to split the sparse feature vector into the concatenation of
        its negative part and its positive part. This can improve the
        performance of downstream classifiers.

    random_state : int, RandomState instance or None, default=None
        Used for initializing the dictionary when ``dict_init`` is not
        specified, randomly shuffling the data when ``shuffle`` is set to
        ``True``, and updating the dictionary. Pass an int for reproducible
        results across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    positive_code : bool, default=False
        Whether to enforce positivity when finding the code.

        .. versionadded:: 0.20

    positive_dict : bool, default=False
        Whether to enforce positivity when finding the dictionary

        .. versionadded:: 0.20

    transform_max_iter : int, default=1000
        Maximum number of iterations to perform if `algorithm='lasso_cd'` or
        `'lasso_lars'`.

        .. versionadded:: 0.22

    Attributes
    ----------
    components_ : ndarray of shape (n_components, n_features)
        dictionary atoms extracted from the data

    error_ : array
        vector of errors at each iteration

    n_iter_ : int
        Number of iterations run.

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.datasets import make_sparse_coded_signal
    &gt;&gt;&gt; from sklearn.decomposition import DictionaryLearning
    &gt;&gt;&gt; X, dictionary, code = make_sparse_coded_signal(
    ...     n_samples=100, n_components=15, n_features=20, n_nonzero_coefs=10,
    ...     random_state=42,
    ... )
    &gt;&gt;&gt; dict_learner = DictionaryLearning(
    ...     n_components=15, transform_algorithm='lasso_lars', random_state=42,
    ... )
    &gt;&gt;&gt; X_transformed = dict_learner.fit_transform(X)

    We can check the level of sparsity of `X_transformed`:

    &gt;&gt;&gt; np.mean(X_transformed == 0)
    0.87...

    We can compare the average squared euclidean norm of the reconstruction
    error of the sparse coded signal relative to the squared euclidean norm of
    the original signal:

    &gt;&gt;&gt; X_hat = X_transformed @ dict_learner.components_
    &gt;&gt;&gt; np.mean(np.sum((X_hat - X) ** 2, axis=1) / np.sum(X ** 2, axis=1))
    0.08...

    Notes
    -----
    **References:**

    J. Mairal, F. Bach, J. Ponce, G. Sapiro, 2009: Online dictionary learning
    for sparse coding (https://www.di.ens.fr/sierra/pdfs/icml09.pdf)

    See Also
    --------
    SparseCoder
    MiniBatchDictionaryLearning
    SparsePCA
    MiniBatchSparsePCA
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-8</span><span class="punctuation">,</span>
                 <span class="identifier">fit_algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lars', transform_algorithm='omp'</span><span class="punctuation">,</span>
                 <span class="identifier">transform_n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">transform_alpha</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">code_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">split_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">transform_max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span>
            <span class="identifier">transform_algorithm</span><span class="punctuation">,</span> <span class="identifier">transform_n_nonzero_coefs</span><span class="punctuation">,</span>
            <span class="identifier">transform_alpha</span><span class="punctuation">,</span> <span class="identifier">split_sign</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="punctuation">,</span>
            <span class="identifier">transform_max_iter</span>
        <span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_algorithm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_algorithm</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">code_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">code_init</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dict_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_init</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">verbose</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">positive_dict</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit the model from data in X.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Training vector, where `n_samples` in the number of samples
            and `n_features` is the number of features.

        y : Ignored

        Returns
        -------
        self : object
            Returns the object itself.
        """</span>
        <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span>

        <span class="identifier">V</span><span class="punctuation">,</span> <span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">E</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_learning</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
            <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_algorithm</span><span class="punctuation">,</span>
            <span class="identifier">method_max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_max_iter</span><span class="punctuation">,</span>
            <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span>
            <span class="identifier">code_init</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">code_init</span><span class="punctuation">,</span>
            <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dict_init</span><span class="punctuation">,</span>
            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span>
            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_dict</span><span class="punctuation">,</span>
            <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_code</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">error_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">E</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">class</span> <span class="identifier">MiniBatchDictionaryLearning</span><span class="grouping">(</span><span class="identifier">_BaseSparseCoding</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Mini-batch dictionary learning

    Finds a dictionary (a set of atoms) that can best be used to represent data
    using a sparse code.

    Solves the optimization problem::

       (U^*,V^*) = argmin 0.5 || X - U V ||_Fro^2 + alpha * || U ||_1,1
                    (U,V)
                    with || V_k ||_2 = 1 for all  0 &lt;= k &lt; n_components

    ||.||_Fro stands for the Frobenius norm and ||.||_1,1 stands for
    the entry-wise matrix norm which is the sum of the absolute values
    of all the entries in the matrix.

    Read more in the :ref:`User Guide &lt;DictionaryLearning&gt;`.

    Parameters
    ----------
    n_components : int, default=None
        Number of dictionary elements to extract.

    alpha : float, default=1
        Sparsity controlling parameter.

    n_iter : int, default=1000
        Total number of iterations to perform.

    fit_algorithm : {'lars', 'cd'}, default='lars'
        The algorithm used:

        - `'lars'`: uses the least angle regression method to solve the lasso
          problem (`linear_model.lars_path`)
        - `'cd'`: uses the coordinate descent method to compute the
          Lasso solution (`linear_model.Lasso`). Lars will be faster if
          the estimated components are sparse.

    n_jobs : int, default=None
        Number of parallel jobs to run.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    batch_size : int, default=3
        Number of samples in each mini-batch.

    shuffle : bool, default=True
        Whether to shuffle the samples before forming batches.

    dict_init : ndarray of shape (n_components, n_features), default=None
        initial value of the dictionary for warm restart scenarios

    transform_algorithm : {'lasso_lars', 'lasso_cd', 'lars', 'omp', \
            'threshold'}, default='omp'
        Algorithm used to transform the data:

        - `'lars'`: uses the least angle regression method
          (`linear_model.lars_path`);
        - `'lasso_lars'`: uses Lars to compute the Lasso solution.
        - `'lasso_cd'`: uses the coordinate descent method to compute the
          Lasso solution (`linear_model.Lasso`). `'lasso_lars'` will be faster
          if the estimated components are sparse.
        - `'omp'`: uses orthogonal matching pursuit to estimate the sparse
          solution.
        - `'threshold'`: squashes to zero all coefficients less than alpha from
          the projection ``dictionary * X'``.

    transform_n_nonzero_coefs : int, default=None
        Number of nonzero coefficients to target in each column of the
        solution. This is only used by `algorithm='lars'` and
        `algorithm='omp'`. If `None`, then
        `transform_n_nonzero_coefs=int(n_features / 10)`.

    transform_alpha : float, default=None
        If `algorithm='lasso_lars'` or `algorithm='lasso_cd'`, `alpha` is the
        penalty applied to the L1 norm.
        If `algorithm='threshold'`, `alpha` is the absolute value of the
        threshold below which coefficients will be squashed to zero.
        If `None`, defaults to `alpha`.

    verbose : bool, default=False
        To control the verbosity of the procedure.

    split_sign : bool, default=False
        Whether to split the sparse feature vector into the concatenation of
        its negative part and its positive part. This can improve the
        performance of downstream classifiers.

    random_state : int, RandomState instance or None, default=None
        Used for initializing the dictionary when ``dict_init`` is not
        specified, randomly shuffling the data when ``shuffle`` is set to
        ``True``, and updating the dictionary. Pass an int for reproducible
        results across multiple function calls.
        See :term:`Glossary &lt;random_state&gt;`.

    positive_code : bool, default=False
        Whether to enforce positivity when finding the code.

        .. versionadded:: 0.20

    positive_dict : bool, default=False
        Whether to enforce positivity when finding the dictionary.

        .. versionadded:: 0.20

    transform_max_iter : int, default=1000
        Maximum number of iterations to perform if `algorithm='lasso_cd'` or
        `'lasso_lars'`.

        .. versionadded:: 0.22

    Attributes
    ----------
    components_ : ndarray of shape (n_components, n_features)
        Components extracted from the data.

    inner_stats_ : tuple of (A, B) ndarrays
        Internal sufficient statistics that are kept by the algorithm.
        Keeping them is useful in online settings, to avoid losing the
        history of the evolution, but they shouldn't have any use for the
        end user.
        `A` `(n_components, n_components)` is the dictionary covariance matrix.
        `B` `(n_features, n_components)` is the data approximation matrix.

    n_iter_ : int
        Number of iterations run.

    iter_offset_ : int
        The number of iteration on data batches that has been
        performed before.

    random_state_ : RandomState instance
        RandomState instance that is generated either from a seed, the random
        number generattor or by `np.random`.

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.datasets import make_sparse_coded_signal
    &gt;&gt;&gt; from sklearn.decomposition import MiniBatchDictionaryLearning
    &gt;&gt;&gt; X, dictionary, code = make_sparse_coded_signal(
    ...     n_samples=100, n_components=15, n_features=20, n_nonzero_coefs=10,
    ...     random_state=42)
    &gt;&gt;&gt; dict_learner = MiniBatchDictionaryLearning(
    ...     n_components=15, transform_algorithm='lasso_lars', random_state=42,
    ... )
    &gt;&gt;&gt; X_transformed = dict_learner.fit_transform(X)

    We can check the level of sparsity of `X_transformed`:

    &gt;&gt;&gt; np.mean(X_transformed == 0)
    0.86...

    We can compare the average squared euclidean norm of the reconstruction
    error of the sparse coded signal relative to the squared euclidean norm of
    the original signal:

    &gt;&gt;&gt; X_hat = X_transformed @ dict_learner.components_
    &gt;&gt;&gt; np.mean(np.sum((X_hat - X) ** 2, axis=1) / np.sum(X ** 2, axis=1))
    0.07...

    Notes
    -----
    **References:**

    J. Mairal, F. Bach, J. Ponce, G. Sapiro, 2009: Online dictionary learning
    for sparse coding (https://www.di.ens.fr/sierra/pdfs/icml09.pdf)

    See Also
    --------
    SparseCoder
    DictionaryLearning
    SparsePCA
    MiniBatchSparsePCA

    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                 <span class="identifier">fit_algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lars'</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">transform_algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'omp'</span><span class="punctuation">,</span>
                 <span class="identifier">transform_n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">transform_alpha</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">split_sign</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">transform_max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span>
            <span class="identifier">transform_algorithm</span><span class="punctuation">,</span> <span class="identifier">transform_n_nonzero_coefs</span><span class="punctuation">,</span> <span class="identifier">transform_alpha</span><span class="punctuation">,</span>
            <span class="identifier">split_sign</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">positive_code</span><span class="punctuation">,</span> <span class="identifier">transform_max_iter</span>
        <span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_algorithm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_algorithm</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dict_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_init</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">verbose</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shuffle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">split_sign</span> <span class="arithmetic-assignment">=</span> <span class="identifier">split_sign</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">positive_dict</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit the model from data in X.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Training vector, where n_samples in the number of samples
            and n_features is the number of features.

        y : Ignored

        Returns
        -------
        self : object
            Returns the instance itself.
        """</span>
        <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">U</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_learning_online</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_algorithm</span><span class="punctuation">,</span>
            <span class="identifier">method_max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_max_iter</span><span class="punctuation">,</span>
            <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dict_init</span><span class="punctuation">,</span>
            <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="punctuation">,</span>
            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_dict</span><span class="punctuation">,</span>
            <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_code</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span>
        <span class="comment"># Keep track of the state of the algorithm to be able to do</span>
        <span class="comment"># some online fitting (partial_fit)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">inner_stats_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">iter_offset_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">iter_offset</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Updates the model using the data in X as a mini-batch.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Training vector, where n_samples in the number of samples
            and n_features is the number of features.

        y : Ignored

        iter_offset : int, default=None
            The number of iteration on data batches that has been
            performed before this call to partial_fit. This is optional:
            if no number is passed, the memory of the object is
            used.

        Returns
        -------
        self : object
            Returns the instance itself.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'random_state_'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'components_'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">dict_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">dict_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dict_init</span>
        <span class="identifier">inner_stats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'inner_stats_'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">iter_offset</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">iter_offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'iter_offset_'</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">iter_offset</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">U</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict_learning_online</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_algorithm</span><span class="punctuation">,</span>
            <span class="identifier">method_max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform_max_iter</span><span class="punctuation">,</span>
            <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">dict_init</span><span class="arithmetic-assignment">=</span><span class="identifier">dict_init</span><span class="punctuation">,</span>
            <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="identifier">iter_offset</span><span class="arithmetic-assignment">=</span><span class="identifier">iter_offset</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state_</span><span class="punctuation">,</span>
            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">inner_stats</span><span class="arithmetic-assignment">=</span><span class="identifier">inner_stats</span><span class="punctuation">,</span>
            <span class="identifier">positive_dict</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_dict</span><span class="punctuation">,</span>
            <span class="identifier">positive_code</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">positive_code</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">U</span>

        <span class="comment"># Keep track of the state of the algorithm to be able to do</span>
        <span class="comment"># some online fitting (partial_fit)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">inner_stats_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">B</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">iter_offset_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iter_offset</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    </pre>
  </body>
</html>