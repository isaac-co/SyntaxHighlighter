<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Tool to preview swaps and tweak configuration prior to running a convert """</span>

<span class="keyword">import</span> <span class="identifier">gettext</span>
<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">random</span>
<span class="keyword">import</span> <span class="identifier">tkinter</span> <span class="keyword">as</span> <span class="identifier">tk</span>
<span class="keyword">from</span> <span class="identifier">tkinter</span> <span class="keyword">import</span> <span class="identifier">ttk</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">sys</span>

<span class="keyword">from</span> <span class="identifier">configparser</span> <span class="keyword">import</span> <span class="identifier">ConfigParser</span>
<span class="keyword">from</span> <span class="identifier">threading</span> <span class="keyword">import</span> <span class="identifier">Event</span><span class="punctuation">,</span> <span class="identifier">Lock</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">PIL</span> <span class="keyword">import</span> <span class="identifier">Image</span><span class="punctuation">,</span> <span class="identifier">ImageTk</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span> <span class="keyword">import</span> <span class="identifier">DetectedFace</span><span class="punctuation">,</span> <span class="identifier">transform_image</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">cli</span><span class="punctuation">.</span><span class="identifier">args</span> <span class="keyword">import</span> <span class="identifier">ConvertArgs</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_images</span><span class="punctuation">,</span> <span class="identifier">get_config</span><span class="punctuation">,</span> <span class="identifier">initialize_config</span><span class="punctuation">,</span> <span class="identifier">initialize_images</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">custom_widgets</span> <span class="keyword">import</span> <span class="identifier">Tooltip</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">control_helper</span> <span class="keyword">import</span> <span class="identifier">ControlPanel</span><span class="punctuation">,</span> <span class="identifier">ControlPanelOption</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">convert</span> <span class="keyword">import</span> <span class="identifier">Converter</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">multithreading</span> <span class="keyword">import</span> <span class="identifier">MultiThread</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">FaceswapError</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">queue_manager</span> <span class="keyword">import</span> <span class="identifier">queue_manager</span>
<span class="keyword">from</span> <span class="identifier">scripts</span><span class="punctuation">.</span><span class="identifier">fsmedia</span> <span class="keyword">import</span> <span class="identifier">Alignments</span><span class="punctuation">,</span> <span class="identifier">Images</span>
<span class="keyword">from</span> <span class="identifier">scripts</span><span class="punctuation">.</span><span class="identifier">convert</span> <span class="keyword">import</span> <span class="identifier">Predict</span>

<span class="keyword">from</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">plugin_loader</span> <span class="keyword">import</span> <span class="identifier">PluginLoader</span>
<span class="keyword">from</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">convert</span><span class="punctuation">.</span><span class="identifier">_config</span> <span class="keyword">import</span> <span class="identifier">Config</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>

<span class="comment"># LOCALES</span>
<span class="identifier">_LANG</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gettext</span><span class="punctuation">.</span><span class="identifier">translation</span><span class="grouping">(</span><span class="string-literal">"tools.preview", localedir="locales"</span><span class="punctuation">,</span> <span class="identifier">fallback</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_LANG</span><span class="punctuation">.</span><span class="identifier">gettext</span>


<span class="keyword">class</span> <span class="identifier">Preview</span><span class="grouping">(</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Tk</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" This tool is part of the Faceswap Tools suite and should be called from
    ``python tools.py preview`` command.

    Loads up 5 semi-random face swaps and displays them, cropped, in place in the final frame.
    Allows user to live tweak settings, before saving the final config to
    :file:`./config/convert.ini`

    Parameters
    ----------
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfigTools</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Lock</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">refresh</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BooleanVar</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">busy</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BooleanVar</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">val</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FacesDisplay</span><span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="int-literal">64</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">)</span>

        <span class="identifier">trigger_patch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Event</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Samples</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span><span class="punctuation">,</span> <span class="identifier">trigger_patch</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Patch</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_available_masks</span><span class="punctuation">,</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">,</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">,</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span><span class="punctuation">,</span>
                            <span class="identifier">trigger_patch</span><span class="punctuation">,</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">,</span>
                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_initialize_tkinter</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_image_canvas</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_opts_book</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cli_frame</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>  <span class="comment"># cli frame holds cli options</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_available_masks</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" list: The mask names that are available for every face in the alignments file """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">key</span>
                  <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">alignments</span><span class="punctuation">.</span><span class="identifier">mask_summary</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span>
                  <span class="keyword">if</span> <span class="identifier">val</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">alignments</span><span class="punctuation">.</span><span class="identifier">faces_count</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_initialize_tkinter</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize a standalone tkinter instance. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing tkinter"</span><span class="grouping">)</span>
        <span class="identifier">initialize_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">initialize_images</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_geometry</span><span class="grouping">(</span><span class="int-literal">940</span><span class="punctuation">,</span> <span class="int-literal">600</span><span class="punctuation">,</span> <span class="identifier">fullscreen</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Faceswap.py - Convert Settings"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">call</span><span class="grouping">(</span>
            <span class="string-literal">"wm"</span><span class="punctuation">,</span>
            <span class="string-literal">"iconphoto"</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_w</span><span class="punctuation">,</span> <span class="identifier">get_images</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">icons</span><span class="grouping">[</span><span class="string-literal">"favicon"</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=protected-access</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized tkinter"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The entry point for the Preview tool from :file:`lib.tools.cli`.

        Launch the tkinter preview Window and run main loop.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_build_ui</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mainloop</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_refresh</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Load new faces to display in preview.

        Parameters
        ----------
        *args: tuple
            Unused, but required for tkinter callback.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Refreshing swapped faces. args: %s"</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"busy"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">.</span><span class="identifier">update_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch</span><span class="punctuation">.</span><span class="identifier">converter_arguments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cli_frame</span><span class="punctuation">.</span><span class="identifier">convert_args</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch</span><span class="punctuation">.</span><span class="identifier">current_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">.</span><span class="identifier">config</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch</span><span class="punctuation">.</span><span class="identifier">trigger</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Refreshed swapped faces"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_build_ui</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the elements for displaying preview images and options panels. """</span>
        <span class="identifier">container</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">PanedWindow</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span>
                                    <span class="identifier">orient</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">VERTICAL</span><span class="grouping">)</span>
        <span class="identifier">container</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">container</span><span class="punctuation">.</span><span class="identifier">preview_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_image_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ImagesCanvas</span><span class="grouping">(</span><span class="identifier">container</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">)</span>
        <span class="identifier">container</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_image_canvas</span><span class="punctuation">,</span> <span class="identifier">weight</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

        <span class="identifier">options_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">container</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cli_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ActionFrame</span><span class="grouping">(</span>
            <span class="identifier">options_frame</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_available_masks</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">has_predicted_mask</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch</span><span class="punctuation">.</span><span class="identifier">converter</span><span class="punctuation">.</span><span class="identifier">cli_arguments</span><span class="punctuation">.</span><span class="identifier">color_adjustment</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"-", "_"</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch</span><span class="punctuation">.</span><span class="identifier">converter</span><span class="punctuation">.</span><span class="identifier">cli_arguments</span><span class="punctuation">.</span><span class="identifier">mask_type</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"-", "_"</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_refresh</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">generate</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_opts_book</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OptionsBook</span><span class="grouping">(</span><span class="identifier">options_frame</span><span class="punctuation">,</span>
                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">,</span>
                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_refresh</span><span class="grouping">)</span>
        <span class="identifier">container</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">options_frame</span><span class="punctuation">,</span> <span class="identifier">weight</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_idletasks</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">container</span><span class="punctuation">.</span><span class="identifier">sashpos</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="int-literal">400</span> <span class="arithmetic-operator">*</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">scaling_factor</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Samples</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The display samples.

    Obtains and holds :attr:`sample_size` semi random test faces for displaying in the
    preview GUI.

    The file list is split into evenly sized groups of :attr:`sample_size`. When a display set is
    generated, a random image from each of the groups is selected to provide an array of images
    across the length of the video.

    Parameters
    ----------
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    sample_size: int
        The number of samples to take from the input video/images
    display: :class:`FacesDisplay`
        The display section of the Preview GUI.
    lock: :class:`threading.Lock`
        A threading lock to prevent multiple GUI updates at the same time.
    trigger_patch:  :class:`threading.Event`
        An event to indicate that a converter patch should be run
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">sample_size</span><span class="punctuation">,</span> <span class="identifier">display</span><span class="punctuation">,</span> <span class="identifier">lock</span><span class="punctuation">,</span> <span class="identifier">trigger_patch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: '%s', sample_size: %s, display: %s, lock: %s, "</span>
                     <span class="string-literal">"trigger_patch: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">sample_size</span><span class="punctuation">,</span>
                     <span class="identifier">display</span><span class="punctuation">,</span> <span class="identifier">lock</span><span class="punctuation">,</span> <span class="identifier">trigger_patch</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">display</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lock</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_trigger_patch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trigger_patch</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predicted_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Images</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Alignments</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span>
                                      <span class="identifier">is_extract</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                      <span class="identifier">input_is_video</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">is_video</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">version</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"The alignments file format has been updated since the given alignments "</span>
                         <span class="string-literal">"file was generated. You need to update the file to proceed."</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"To do this run the 'Alignments Tool' &gt; 'Extract' Job."</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">have_alignments_file</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"Alignments file not found at: '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">file</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_filelist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_filelist</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_indices</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predictor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Predict</span><span class="grouping">(</span><span class="identifier">queue_manager</span><span class="punctuation">.</span><span class="identifier">get_queue</span><span class="grouping">(</span><span class="string-literal">"preview_predict_in"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">sample_size</span><span class="punctuation">,</span>
                                  <span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_centering</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predictor</span><span class="punctuation">.</span><span class="identifier">centering</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generate</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">sample_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The number of samples to take from the input video/images """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">predicted_images</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" list: The predicted faces output from the Faceswap model """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predicted_images</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">alignments</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`~lib.align.Alignments`: The alignments for the preview faces """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">predictor</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`~scripts.convert.Predict`: The Predictor for the Faceswap model """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predictor</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_random_choice</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" list: Random indices from the :attr:`_indices` group """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="identifier">indices</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">indices</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_indices</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_get_filelist</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get a list of files for the input, filtering out those frames which do
        not contain faces.

        Returns
        -------
        list
            A list of filenames of frames that contain faces.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Filtering file list to frames with faces"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">is_video</span><span class="punctuation">:</span>
            <span class="identifier">filelist</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"{}_{:06d}.png"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">input_images</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">frame_no</span><span class="grouping">)</span>
                        <span class="keyword">for</span> <span class="identifier">frame_no</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">images_found</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">filelist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">input_images</span>

        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">filename</span> <span class="keyword">for</span> <span class="identifier">filename</span> <span class="relational-operator">in</span> <span class="identifier">filelist</span>
                  <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">frame_has_faces</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Filtered out frames: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">images_found</span> <span class="arithmetic-operator">-</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">retval</span>
        <span class="keyword">except</span> <span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"No faces were found in any of the frames passed in. Make sure you are passing "</span>
                   <span class="string-literal">"in a frames source rather than extracted faces, and that you have provided "</span>
                   <span class="string-literal">"the correct alignments file."</span><span class="grouping">)</span>
            <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span> <span class="keyword">from</span> <span class="identifier">err</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_get_indices</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get indices for each sample group.

        Obtain :attr:`self.sample_size` evenly sized groups of indices
        pertaining to the filtered :attr:`self._file_list`

        Returns
        -------
        list
            list of indices relating to the filtered file list, split into groups
        """</span>
        <span class="comment"># Remove start and end values to get a list divisible by self.sample_size</span>
        <span class="identifier">no_files</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_filelist</span><span class="grouping">)</span>
        <span class="identifier">crop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">no_files</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span>
        <span class="identifier">top_tail</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">no_files</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span>
            <span class="identifier">crop</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="identifier">no_files</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">crop</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">crop</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="comment"># Partition the indices</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">top_tail</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">top_tail</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">start</span> <span class="arithmetic-operator">+</span> <span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span><span class="grouping">]</span>
                  <span class="keyword">for</span> <span class="identifier">start</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Indices pools: %s", ["{}: (start: {}, end: {}, size: {})"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">,</span>
                                                                                       <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">pool</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                                                       <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">pool</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                                                       <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">pool</span><span class="grouping">)</span><span class="grouping">)</span>
                                           <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">pool</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">generate</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Generate a sample set.

        Selects :attr:`sample_size` random faces. Runs them through prediction to obtain the
        swap, then trigger the patch event to run the faces through patching.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_load_frames</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_trigger_patch</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_load_frames</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Load a sample of random frames.

        * Picks a random face from each indices group.

        * Takes the first face from the image (if there are multiple faces). Adds the images to \
        :attr:`self._input_images`.

        * Sets :attr:`_display.source` to the input images and flags that the display should be \
        updated
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">selection</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_random_choice</span><span class="punctuation">:</span>
            <span class="identifier">filename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_filelist</span><span class="grouping">[</span><span class="identifier">selection</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_images</span><span class="punctuation">.</span><span class="identifier">load_one_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_filelist</span><span class="grouping">[</span><span class="identifier">selection</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="comment"># Get first face only</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_alignments</span><span class="punctuation">.</span><span class="identifier">get_faces_in_frame</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">detected_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFace</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">n</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_images</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"filename"</span><span class="punctuation">:</span> <span class="identifier">filename</span><span class="punctuation">,</span>
                                       <span class="string-literal">"image"</span><span class="punctuation">:</span> <span class="identifier">image</span><span class="punctuation">,</span>
                                       <span class="string-literal">"detected_faces"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="identifier">detected_face</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">source</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_images</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">update_source</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Selected frames: %s", [frame["filename"</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_images</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Predict from the loaded frames.

        With a threading lock (to prevent stacking), run the selected faces through the Faceswap
        model predict function and add the output to :attr:`predicted`
        """</span>
        <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predicted_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">frame</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_images</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predictor</span><span class="punctuation">.</span><span class="identifier">in_queue</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="identifier">frame</span><span class="grouping">)</span>
            <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="keyword">while</span> <span class="identifier">idx</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Predicting face %s of %s"</span><span class="punctuation">,</span> <span class="identifier">idx</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span><span class="grouping">)</span>
                <span class="identifier">items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predictor</span><span class="punctuation">.</span><span class="identifier">out_queue</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">items</span> <span class="relational-operator">==</span> <span class="string-literal">"EOF"</span><span class="punctuation">:</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Received EOF"</span><span class="grouping">)</span>
                    <span class="keyword">break</span>
                <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">items</span><span class="punctuation">:</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_predicted_images</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">item</span><span class="grouping">)</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Predicted face %s of %s"</span><span class="punctuation">,</span> <span class="identifier">idx</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_size</span><span class="grouping">)</span>
                    <span class="identifier">idx</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Predicted faces"</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Patch</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The Patch pipeline

    Runs in it's own thread. Takes the output from the Faceswap model predictor and runs the faces
    through the convert pipeline using the currently selected options.

    Parameters
    ----------
    arguments: :class:`argparse.Namespace`
        The :mod:`argparse` arguments as passed in from :mod:`tools.py`
    available_masks: list
        The masks that are available for convert
    samples: :class:`Samples`
        The Samples for display.
    display: :class:`FacesDisplay`
        The display section of the Preview GUI.
    lock: :class:`threading.Lock`
        A threading lock to prevent multiple GUI updates at the same time.
    trigger:  :class:`threading.Event`
        An event to indicate that a converter patch should be run
    config_tools: :class:`ConfigTools`
        Tools for loading and saving configuration files
    tk_vars: dict
        Global tkinter variables. `Refresh` and `Busy` :class:`tkinter.BooleanVar`

    Attributes
    ----------
    converter_arguments: dict
        The currently selected converter command line arguments for the patch queue
    current_config::class:`lib.config.FaceswapConfig`
        The currently set configuration for the patch queue
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="punctuation">,</span>
                 <span class="identifier">display</span><span class="punctuation">,</span> <span class="identifier">lock</span><span class="punctuation">,</span> <span class="identifier">trigger</span><span class="punctuation">,</span> <span class="identifier">config_tools</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (arguments: '%s', available_masks: %s, samples: %s, "</span>
                     <span class="string-literal">"display: %s, lock: %s, trigger: %s, config_tools: %s, tk_vars %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="punctuation">,</span> <span class="identifier">display</span><span class="punctuation">,</span> <span class="identifier">lock</span><span class="punctuation">,</span>
                     <span class="identifier">trigger</span><span class="punctuation">,</span> <span class="identifier">config_tools</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">samples</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_queue_patch_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">queue_manager</span><span class="punctuation">.</span><span class="identifier">get_queue</span><span class="grouping">(</span><span class="string-literal">"preview_patch_in"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">display</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lock</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_trigger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trigger</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">current_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">config</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">converter_arguments</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>  <span class="comment"># Updated converter arguments dict</span>

        <span class="identifier">configfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">configfile</span> <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"configfile"</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_converter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Converter</span><span class="grouping">(</span><span class="identifier">output_size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">output_size</span><span class="punctuation">,</span>
                                    <span class="identifier">coverage_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">coverage_ratio</span><span class="punctuation">,</span>
                                    <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">.</span><span class="identifier">predictor</span><span class="punctuation">.</span><span class="identifier">centering</span><span class="punctuation">,</span>
                                    <span class="identifier">draw_transparent</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                    <span class="identifier">pre_encode</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                    <span class="identifier">arguments</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_generate_converter_arguments</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span>
                                                                                 <span class="identifier">available_masks</span><span class="grouping">)</span><span class="punctuation">,</span>
                                    <span class="identifier">configfile</span><span class="arithmetic-assignment">=</span><span class="identifier">configfile</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_shutdown</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Event</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MultiThread</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_process</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_trigger</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_shutdown</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_queue_patch_in</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_samples</span><span class="punctuation">,</span>
                                   <span class="identifier">tk_vars</span><span class="punctuation">,</span>
                                   <span class="identifier">thread_count</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                   <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"patch_thread"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">trigger</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`threading.Event`: The trigger to indicate that a patching run should
        commence. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_trigger</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">converter</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`lib.convert.Converter`: The converter to use for patching the images. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_converter</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_generate_converter_arguments</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add the default converter arguments to the initial arguments. Ensure the mask selection
        is available.

        Parameters
        ----------
        arguments: :class:`argparse.Namespace`
            The :mod:`argparse` arguments as passed in from :mod:`tools.py`
        available_masks: list
            The masks that are available for convert
        Returns
        ----------
        arguments: :class:`argparse.Namespace`
            The :mod:`argparse` arguments as passed in with converter default
            arguments added
        """</span>
        <span class="identifier">valid_masks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">available_masks</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="string-literal">"none"</span><span class="grouping">]</span>
        <span class="identifier">converter_arguments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConvertArgs</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">"convert"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_optional_arguments</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">converter_arguments</span><span class="punctuation">:</span>
            <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">item</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"default"</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
            <span class="comment"># Skip options without a default value</span>
            <span class="keyword">if</span> <span class="identifier">value</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="identifier">option</span> <span class="arithmetic-assignment">=</span> <span class="identifier">item</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"dest", item["opts"][1].replace("--", ""</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">option</span> <span class="relational-operator">==</span> <span class="string-literal">"mask_type"</span> <span class="logical-operator">and</span> <span class="identifier">value</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">valid_masks</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Amending default mask from '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="punctuation">,</span> <span class="identifier">valid_masks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">valid_masks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="comment"># Skip options already in arguments</span>
            <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">option</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="comment"># Add option to arguments</span>
            <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="identifier">option</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">arguments</span>

    <span class="keyword">def</span> <span class="identifier">_process</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">trigger_event</span><span class="punctuation">,</span> <span class="identifier">shutdown_event</span><span class="punctuation">,</span> <span class="identifier">patch_queue_in</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The face patching process.

        Runs in a thread, and waits for an event to be set. Once triggered, runs a patching
        cycle and sets the :class:`Display` destination images.

        Parameters
        ----------
        trigger_event: :class:`threading.Event`
            Set by parent process when a patching run should be executed
        shutdown_event :class:`threading.Event`
            Set by parent process if a shutdown has been requested
        patch_queue_in: :class:`queue.Queue`
            The input queue for the patching process
        samples: :class:`Samples`
            The Samples for display.
        tk_vars: dict
            Global tkinter variables. `Refresh` and `Busy` :class:`tkinter.BooleanVar`
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Launching patch process thread: (trigger_event: %s, shutdown_event: %s, "</span>
                     <span class="string-literal">"patch_queue_in: %s, samples: %s, tk_vars: %s)"</span><span class="punctuation">,</span> <span class="identifier">trigger_event</span><span class="punctuation">,</span>
                     <span class="identifier">shutdown_event</span><span class="punctuation">,</span> <span class="identifier">patch_queue_in</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span>
        <span class="identifier">patch_queue_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">queue_manager</span><span class="punctuation">.</span><span class="identifier">get_queue</span><span class="grouping">(</span><span class="string-literal">"preview_patch_out"</span><span class="grouping">)</span>
        <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
            <span class="identifier">trigger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trigger_event</span><span class="punctuation">.</span><span class="identifier">wait</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">shutdown_event</span><span class="punctuation">.</span><span class="identifier">is_set</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Shutdown received"</span><span class="grouping">)</span>
                <span class="keyword">break</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">trigger</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="comment"># Clear trigger so calling process can set it during this run</span>
            <span class="identifier">trigger_event</span><span class="punctuation">.</span><span class="identifier">clear</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">queue_manager</span><span class="punctuation">.</span><span class="identifier">flush_queue</span><span class="grouping">(</span><span class="string-literal">"preview_patch_in"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_feed_swapped_faces</span><span class="grouping">(</span><span class="identifier">patch_queue_in</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_converter_arguments</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_converter</span><span class="punctuation">.</span><span class="identifier">reinitialize</span><span class="grouping">(</span><span class="identifier">config</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">current_config</span><span class="grouping">)</span>
            <span class="identifier">swapped</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_patch_faces</span><span class="grouping">(</span><span class="identifier">patch_queue_in</span><span class="punctuation">,</span> <span class="identifier">patch_queue_out</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="punctuation">.</span><span class="identifier">sample_size</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lock</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">destination</span> <span class="arithmetic-assignment">=</span> <span class="identifier">swapped</span>
            <span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"refresh"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"busy"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Closed patch process thread"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_converter_arguments</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the converter arguments to the currently selected values. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updating Converter cli arguments"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">converter_arguments</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"No arguments to update"</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">converter_arguments</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updating %s to %s"</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span><span class="grouping">)</span>
            <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_converter</span><span class="punctuation">.</span><span class="identifier">cli_arguments</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updated Converter cli arguments"</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_feed_swapped_faces</span><span class="grouping">(</span><span class="identifier">patch_queue_in</span><span class="punctuation">,</span> <span class="identifier">samples</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Feed swapped faces to the converter's in-queue.

        Parameters
        ----------
        patch_queue_in: :class:`queue.Queue`
            The input queue for the patching process
        samples: :class:`Samples`
            The Samples for display.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"feeding swapped faces to converter"</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">samples</span><span class="punctuation">.</span><span class="identifier">predicted_images</span><span class="punctuation">:</span>
            <span class="identifier">patch_queue_in</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="identifier">item</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"fed %s swapped faces to converter"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">samples</span><span class="punctuation">.</span><span class="identifier">predicted_images</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Putting EOF to converter"</span><span class="grouping">)</span>
        <span class="identifier">patch_queue_in</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="string-literal">"EOF"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_patch_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">queue_in</span><span class="punctuation">,</span> <span class="identifier">queue_out</span><span class="punctuation">,</span> <span class="identifier">sample_size</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Patch faces.

        Run the convert process on the swapped faces and return the patched faces.

        patch_queue_in: :class:`queue.Queue`
            The input queue for the patching process
        queue_out: :class:`queue.Queue`
            The output queue from the patching process
        sample_size: int
            The number of samples to be displayed

        Returns
        -------
        list
            The swapped faces patched with the selected convert settings
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Patching faces"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_converter</span><span class="punctuation">.</span><span class="identifier">process</span><span class="grouping">(</span><span class="identifier">queue_in</span><span class="punctuation">,</span> <span class="identifier">queue_out</span><span class="grouping">)</span>
        <span class="identifier">swapped</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">while</span> <span class="identifier">idx</span> <span class="relational-operator">&lt;</span> <span class="identifier">sample_size</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Patching image %s of %s"</span><span class="punctuation">,</span> <span class="identifier">idx</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">sample_size</span><span class="grouping">)</span>
            <span class="identifier">item</span> <span class="arithmetic-assignment">=</span> <span class="identifier">queue_out</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">swapped</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">item</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Patched image %s of %s"</span><span class="punctuation">,</span> <span class="identifier">idx</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">sample_size</span><span class="grouping">)</span>
            <span class="identifier">idx</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Patched faces"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">swapped</span>


<span class="keyword">class</span> <span class="identifier">FacesDisplay</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Compiles the 2 rows of sample faces (original and swapped) into a single image

    Parameters
    ----------
    size: int
        The size of each individual face sample in pixels
    padding: int
        The amount of extra padding to apply to the outside of the face
    tk_vars: dict
        Global tkinter variables. `Refresh` and `Busy` :class:`tkinter.BooleanVar`

    Attributes
    ----------
    update_source: bool
        Flag to indicate that the source images for the preview have been updated, so the preview
        should be recompiled.
    source: list
        The list of :class:`numpy.ndarray` source preview images for top row of display
    destination: list
        The list of :class:`numpy.ndarray` swapped and patched preview images for bottom row of
        display
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (size: %s, padding: %s, tk_vars: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_vars</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">padding</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_source</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dest</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_image</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

        <span class="comment"># Set from Samples</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_source</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">source</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># Source images, filenames + detected faces</span>
        <span class="comment"># Set from Patch</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">destination</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># Swapped + patched images</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">tk_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`PIL.ImageTk.PhotoImage`: The compiled preview display in tkinter display
        format """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_image</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_total_columns</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the total number of images that are being displayed """</span>
        <span class="keyword">return</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">source</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">set_centering</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The centering that the model uses is not known at initialization time.
        Set :attr:`_centering` when the model has been loaded.

        Parameters
        ----------
        centering: str
            The centering that the model was trained on
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">centering</span>

    <span class="keyword">def</span> <span class="identifier">set_display_dimensions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">dimensions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Adjust the size of the frame that will hold the preview samples.

        Parameters
        ----------
        dimensions: tuple
            The (`width`, `height`) of the frame that holds the preview
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dimensions</span>

    <span class="keyword">def</span> <span class="identifier">update_tk_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the full preview images and compile :attr:`tk_image` for display. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updating tk image"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_build_faces_image</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_source</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dest</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_scale_size</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">cvtColor</span><span class="grouping">(</span><span class="identifier">img</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">COLOR_BGR2RGB</span><span class="grouping">)</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Image</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">Image</span><span class="punctuation">.</span><span class="identifier">ANTIALIAS</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ImageTk</span><span class="punctuation">.</span><span class="identifier">PhotoImage</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="string-literal">"refresh"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updated tk image"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_scale_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the size that the full preview image should be resized to fit in the
        display window.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The full sized compiled preview image

        Returns
        -------
        tuple
            The (`width`, `height`) that the display image should be sized to fit in the display
            window
        """</span>
        <span class="identifier">frameratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">imgratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">frameratio</span> <span class="relational-operator">&lt;=</span> <span class="identifier">imgratio</span><span class="punctuation">:</span>
            <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_dims</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"scale: %s, size: %s"</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">size</span>

    <span class="keyword">def</span> <span class="identifier">_build_faces_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile the source and destination rows of the preview image. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Building Faces Image"</span><span class="grouping">)</span>
        <span class="identifier">update_all</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_source</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_from_frames</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">update_all</span><span class="punctuation">:</span>
            <span class="identifier">header</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_header_text</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">source</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_draw_rect</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"src"</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_source</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">header</span><span class="punctuation">,</span> <span class="identifier">source</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dest</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_draw_rect</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"dst"</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"source row shape: %s, swapped row shape: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_dest</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_source</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_faces_from_frames</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Extract the preview faces from the source frames and apply the requisite padding. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Extracting faces from frames: Number images: %s"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">source</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_source</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_crop_source_faces</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_crop_destination_faces</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Extracted faces from frames: %s"</span><span class="punctuation">,</span>
                     <span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_crop_source_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Extract the source faces from the source frames, along with their filenames and the
        transformation matrix used to extract the faces. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updating source faces"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">source</span><span class="punctuation">:</span>
            <span class="identifier">detected_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="grouping">[</span><span class="string-literal">"detected_faces"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">src_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span>
            <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">load_aligned</span><span class="grouping">(</span><span class="identifier">src_img</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_centering</span><span class="grouping">)</span>
            <span class="identifier">matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_face</span><span class="punctuation">.</span><span class="identifier">aligned</span><span class="punctuation">.</span><span class="identifier">matrix</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"filenames"</span><span class="punctuation">,</span>
                                   <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">[</span><span class="string-literal">"filename"</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"matrix"</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">matrix</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"src"</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">transform_image</span><span class="grouping">(</span><span class="identifier">src_img</span><span class="punctuation">,</span>
                                                                         <span class="identifier">matrix</span><span class="punctuation">,</span>
                                                                         <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span>
                                                                         <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_source</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updated source faces"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_crop_destination_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Extract the swapped faces from the swapped frames using the source face destination
        matrices. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updating destination faces"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"dst"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">destination</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">destination</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">destination</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">src</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span><span class="grouping">)</span>
                                                                 <span class="keyword">for</span> <span class="identifier">src</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">source</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">destination</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"dst"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">transform_image</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span>
                                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span><span class="punctuation">,</span>
                                                      <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_padding</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updated destination faces"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_header_text</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create the header text displaying the frame name for each preview column.

        Returns
        -------
        :class:`numpy.ndarray`
            The header row of the preview image containing the frame names for each column
        """</span>
        <span class="identifier">font_scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">/</span> <span class="int-literal">640</span>
        <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">8</span>
        <span class="identifier">font</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">FONT_HERSHEY_SIMPLEX</span>
        <span class="comment"># Get size of placed text for positioning</span>
        <span class="identifier">text_sizes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">getTextSize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"filenames"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                                      <span class="identifier">font</span><span class="punctuation">,</span>
                                      <span class="identifier">font_scale</span><span class="punctuation">,</span>
                                      <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
                      <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_total_columns</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="comment"># Get X and Y co-ordinates for each text item</span>
        <span class="identifier">text_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">height</span> <span class="arithmetic-operator">+</span> <span class="identifier">text_sizes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">text_x</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="identifier">text_sizes</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">*</span> <span class="identifier">idx</span>
                  <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_total_columns</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"filenames: %s, text_sizes: %s, text_x: %s, text_y: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"filenames"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">text_sizes</span><span class="punctuation">,</span> <span class="identifier">text_x</span><span class="punctuation">,</span> <span class="identifier">text_y</span><span class="grouping">)</span>
        <span class="identifier">header_box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_total_columns</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">255</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">text</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces</span><span class="grouping">[</span><span class="string-literal">"filenames"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">putText</span><span class="grouping">(</span><span class="identifier">header_box</span><span class="punctuation">,</span>
                        <span class="identifier">text</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="identifier">text_x</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">text_y</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">font</span><span class="punctuation">,</span>
                        <span class="identifier">font_scale</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="int-literal">1</span><span class="punctuation">,</span>
                        <span class="identifier">lineType</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">LINE_AA</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"header_box.shape: %s"</span><span class="punctuation">,</span> <span class="identifier">header_box</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">header_box</span>

    <span class="keyword">def</span> <span class="identifier">_draw_rect</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Place a white border around a given image.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The image to place a border on to
        Returns
        -------
        :class:`numpy.ndarray`
            The given image with a border drawn around the outside
        """</span>
        <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">rectangle</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">255.0</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"uint8"</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ConfigTools</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Tools for loading, saving, setting and retrieving configuration file values.

    Attributes
    ----------
    tk_vars: dict
        Global tkinter variables. `Refresh` and `Busy` :class:`tkinter.BooleanVar`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Config</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_dicts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_config_dicts</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># Holds currently saved config</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`plugins.convert._config.Config` The convert configuration """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">config_dicts</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The convert configuration options in dictionary form."""</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_dicts</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">sections</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" list: The sorted section names that exist within the convert Configuration options. """</span>
        <span class="keyword">return</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">plugin</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">"."</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">plugin</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">sections</span><span class="grouping">(</span><span class="grouping">)</span>
                          <span class="keyword">if</span> <span class="identifier">plugin</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">".")[0] != "writer"</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">plugins_dict</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: Dictionary of configuration option sections as key with a list of containing
        plugins as the value """</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="identifier">section</span><span class="punctuation">:</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">plugin</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">"."</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">plugin</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">sections</span><span class="grouping">(</span><span class="grouping">)</span>
                                 <span class="keyword">if</span> <span class="identifier">plugin</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">"."</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">section</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">section</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sections</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">update_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update :attr:`config` with the currently selected values from the GUI. """</span>
        <span class="keyword">for</span> <span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">items</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">value</span> <span class="relational-operator">in</span> <span class="identifier">items</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">try</span><span class="punctuation">:</span>
                    <span class="identifier">new_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">value</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">except</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TclError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
                    <span class="comment"># When manually filling in text fields, blank values will</span>
                    <span class="comment"># raise an error on numeric data types so return 0</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Error getting value. Defaulting to 0. Error: %s"</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="identifier">new_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
                <span class="identifier">old_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span>
                <span class="keyword">if</span> <span class="identifier">new_value</span> <span class="relational-operator">!=</span> <span class="identifier">old_value</span><span class="punctuation">:</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updating config: %s, %s from %s to %s"</span><span class="punctuation">,</span>
                                 <span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">old_value</span><span class="punctuation">,</span> <span class="identifier">new_value</span><span class="grouping">)</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_value</span>

    <span class="keyword">def</span> <span class="identifier">_get_config_dicts</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain a custom configuration dictionary for convert configuration items in use
        by the preview tool formatted for control helper.

        Returns
        -------
        dict
            Each configuration section as keys, with the values as a dict of option:
            :class:`lib.gui.control_helper.ControlOption` pairs. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Formatting Config for GUI"</span><span class="grouping">)</span>
        <span class="identifier">config_dicts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">section</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">sections</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">section</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"writer."</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">key</span> <span class="relational-operator">==</span> <span class="string-literal">"helptext"</span><span class="punctuation">:</span>
                    <span class="identifier">config_dicts</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">val</span>
                    <span class="keyword">continue</span>
                <span class="identifier">cp_option</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ControlPanelOption</span><span class="grouping">(</span><span class="identifier">title</span><span class="arithmetic-assignment">=</span><span class="identifier">key</span><span class="punctuation">,</span>
                                               <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"type"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"group"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"default"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">initial_value</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="grouping">)</span><span class="punctuation">,</span>
                                               <span class="identifier">choices</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"choices"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">is_radio</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"gui_radio"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">rounding</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"rounding"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">min_max</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"min_max"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">helptext</span><span class="arithmetic-assignment">=</span><span class="identifier">val</span><span class="grouping">[</span><span class="string-literal">"helptext"</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cp_option</span><span class="punctuation">.</span><span class="identifier">tk_var</span>
                <span class="identifier">config_dicts</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cp_option</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Formatted Config for GUI: %s"</span><span class="punctuation">,</span> <span class="identifier">config_dicts</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">config_dicts</span>

    <span class="keyword">def</span> <span class="identifier">reset_config_to_saved</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Reset the GUI parameters to their saved values within the configuration file.

        Parameters
        ----------
        section: str, optional
            The configuration section to reset the values for, If ``None`` provided then all
            sections are reset. Default: ``None``
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Resetting to saved config: %s"</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="grouping">)</span>
        <span class="identifier">sections</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">section</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">config_section</span> <span class="relational-operator">in</span> <span class="identifier">sections</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">options</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_dicts</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">item</span> <span class="relational-operator">==</span> <span class="string-literal">"helptext"</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="identifier">val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">options</span><span class="punctuation">.</span><span class="identifier">value</span>
                <span class="keyword">if</span> <span class="identifier">val</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">val</span><span class="grouping">)</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting %s - %s to saved value %s"</span><span class="punctuation">,</span> <span class="identifier">config_section</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">val</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Reset to saved config: %s"</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">reset_config_to_default</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Reset the GUI parameters to their default configuration values.

        Parameters
        ----------
        section: str, optional
            The configuration section to reset the values for, If ``None`` provided then all
            sections are reset. Default: ``None``
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Resetting to default: %s"</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="grouping">)</span>
        <span class="identifier">sections</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">section</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">config_section</span> <span class="relational-operator">in</span> <span class="identifier">sections</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">options</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_dicts</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">item</span> <span class="relational-operator">==</span> <span class="string-literal">"helptext"</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">options</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span>
                <span class="keyword">if</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="grouping">)</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting %s - %s to default value %s"</span><span class="punctuation">,</span>
                                 <span class="identifier">config_section</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Reset to default: %s"</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">save_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Save the configuration ``.ini`` file with the currently stored values.

        Parameters
        ----------
        section: str, optional
            The configuration section to save, If ``None`` provided then all sections are saved.
            Default: ``None``
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Saving %s config"</span><span class="punctuation">,</span> <span class="identifier">section</span><span class="grouping">)</span>
        <span class="identifier">new_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfigParser</span><span class="grouping">(</span><span class="identifier">allow_no_value</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">config_section</span><span class="punctuation">,</span> <span class="identifier">items</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_dicts</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding section: '%s')"</span><span class="punctuation">,</span> <span class="identifier">config_section</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">insert_config_section</span><span class="grouping">(</span><span class="identifier">config_section</span><span class="punctuation">,</span>
                                               <span class="identifier">items</span><span class="grouping">[</span><span class="string-literal">"helptext"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">config</span><span class="arithmetic-assignment">=</span><span class="identifier">new_config</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">options</span> <span class="relational-operator">in</span> <span class="identifier">items</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">item</span> <span class="relational-operator">==</span> <span class="string-literal">"helptext"</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="keyword">if</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">section</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">config_section</span> <span class="relational-operator">!=</span> <span class="identifier">section</span><span class="grouping">)</span>
                        <span class="logical-operator">or</span> <span class="identifier">config_section</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">new_opt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">options</span><span class="punctuation">.</span><span class="identifier">value</span>  <span class="comment"># Keep saved item for other sections</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Retaining option: (item: '%s', value: '%s')"</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">new_opt</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">new_opt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="identifier">config_section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting option: (item: '%s', value: '%s')"</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">new_opt</span><span class="grouping">)</span>
                    <span class="comment"># Set config_dicts value to new saved value</span>
                    <span class="identifier">options</span><span class="punctuation">.</span><span class="identifier">set_initial_value</span><span class="grouping">(</span><span class="identifier">new_opt</span><span class="grouping">)</span>
                <span class="identifier">helptext</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">h</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">p</span><span class="grouping">(</span><span class="identifier">options</span><span class="punctuation">.</span><span class="identifier">helptext</span><span class="punctuation">,</span> <span class="identifier">is_section</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
                <span class="identifier">new_config</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">config_section</span><span class="punctuation">,</span> <span class="identifier">helptext</span><span class="grouping">)</span>
                <span class="identifier">new_config</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">config_section</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">new_opt</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_config</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">save_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Saved config: '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">configfile</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ImagesCanvas</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-many-ancestors</span>
    <span class="comment">""" tkinter Canvas that holds the preview images.

    Parameters
    ----------
    parent: tkinter object
        The parent tkinter object that holds the canvas
    tk_vars: dict
        Global tkinter variables. `Refresh` and `Busy` :class:`tkinter.BooleanVar`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (parent: %s,  tk_vars: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_refresh_display_trigger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"refresh"</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_refresh_display_trigger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_refresh_display_callback</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">preview_display</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Canvas</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bd</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">highlightthickness</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_displaycanvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_image</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                                                        <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">tk_image</span><span class="punctuation">,</span>
                                                        <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">NW</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Configure&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_resize</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_refresh_display_callback</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add a trace to refresh display on callback """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_refresh_display_trigger</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Refresh display trigger received: %s"</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reload</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_resize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Resize the image to fit the frame, maintaining aspect ratio """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Resizing preview image"</span><span class="grouping">)</span>
        <span class="identifier">framesize</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">height</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">set_display_dimensions</span><span class="grouping">(</span><span class="identifier">framesize</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_reload</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_reload</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Reload the preview image """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Reloading preview image"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">update_tk_image</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_displaycanvas</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display</span><span class="punctuation">.</span><span class="identifier">tk_image</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ActionFrame</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=too-many-ancestors</span>
    <span class="comment">""" Frame that holds the left hand side options panel containing the command line options.

    Parameters
    ----------
    parent: tkinter object
        The parent tkinter object that holds the Action Frame
    available_masks: list
        The available masks that exist within the alignments file
    has_predicted_mask: bool
        Whether the model was trained with a mask
    selected_color: str
        The selected color adjustment type
    selected_mask_type: str
        The selected mask type
    config_tools: :class:`ConfigTools`
        Tools for loading and saving configuration files
    patch_callback: python function
        The function to execute when a patch callback is received
    refresh_callback: python function
        The function to execute when a refresh callback is received
    tk_vars: dict
        Global tkinter variables. `Refresh` and `Busy` :class:`tkinter.BooleanVar`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="punctuation">,</span> <span class="identifier">selected_color</span><span class="punctuation">,</span>
                 <span class="identifier">selected_mask_type</span><span class="punctuation">,</span> <span class="identifier">config_tools</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="punctuation">,</span> <span class="identifier">refresh_callback</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (available_masks: %s, has_predicted_mask: %s, "</span>
                     <span class="string-literal">"selected_color: %s, selected_mask_type: %s, patch_callback: %s, "</span>
                     <span class="string-literal">"refresh_callback: %s, tk_vars: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="punctuation">,</span> <span class="identifier">selected_color</span><span class="punctuation">,</span>
                     <span class="identifier">selected_mask_type</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="punctuation">,</span> <span class="identifier">refresh_callback</span><span class="punctuation">,</span> <span class="identifier">tk_vars</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span> <span class="arithmetic-assignment">=</span> <span class="identifier">config_tools</span>

        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_options</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"color", "mask_type"</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_tkvar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"busy"</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">d_locals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">locals</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">opt</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_format_to_display</span><span class="grouping">(</span><span class="identifier">d_locals</span><span class="grouping">[</span><span class="string-literal">"selected_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">opt</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="keyword">for</span> <span class="identifier">opt</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_options</span><span class="grouping">}</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_build_frame</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span>
                                                 <span class="identifier">refresh_callback</span><span class="punctuation">,</span>
                                                 <span class="identifier">patch_callback</span><span class="punctuation">,</span>
                                                 <span class="identifier">available_masks</span><span class="punctuation">,</span>
                                                 <span class="identifier">has_predicted_mask</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">convert_args</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: Currently selected Command line arguments from the :class:`ActionFrame`. """</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="identifier">opt</span> <span class="keyword">if</span> <span class="identifier">opt</span> <span class="relational-operator">!=</span> <span class="string-literal">"color" else "color_adjustment"</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_format_from_display</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="identifier">opt</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">opt</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_options</span><span class="grouping">}</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_format_from_display</span><span class="grouping">(</span><span class="identifier">var</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Format a variable from the display version to the command line action version.

        Parameters
        ----------
        var: str
            The variable name to format

        Returns
        -------
        str
            The formatted variable name
        """</span>
        <span class="keyword">return</span> <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">" ", "_"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_format_to_display</span><span class="grouping">(</span><span class="identifier">var</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Format a variable from the command line action version to the display version.
        Parameters
        ----------
        var: str
            The variable name to format

        Returns
        -------
        str
            The formatted variable name
        """</span>
        <span class="keyword">return</span> <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"_", " ").replace("-", " "</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_build_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">refresh_callback</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="punctuation">,</span>
                     <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the :class:`ActionFrame`.

        Parameters
        ----------
        defaults: dict
            The default command line options
        patch_callback: python function
            The function to execute when a patch callback is received
        refresh_callback: python function
            The function to execute when a refresh callback is received
        available_masks: list
            The available masks that exist within the alignments file
        has_predicted_mask: bool
            Whether the model was trained with a mask

        Returns
        -------
        ttk.Progressbar
            A Progress bar to indicate that the Preview tool is busy
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Building Action frame"</span><span class="grouping">)</span>

        <span class="identifier">bottom_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">bottom_frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTTOM</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">S</span><span class="grouping">)</span>
        <span class="identifier">top_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">top_frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_cli_choices</span><span class="grouping">(</span><span class="identifier">top_frame</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span>

        <span class="identifier">busy_indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_busy_indicator</span><span class="grouping">(</span><span class="identifier">bottom_frame</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_refresh_button</span><span class="grouping">(</span><span class="identifier">bottom_frame</span><span class="punctuation">,</span> <span class="identifier">refresh_callback</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_patch_callback</span><span class="grouping">(</span><span class="identifier">patch_callback</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_actions</span><span class="grouping">(</span><span class="identifier">bottom_frame</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Built Action frame"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">busy_indicator</span>

    <span class="keyword">def</span> <span class="identifier">_add_cli_choices</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create :class:`lib.gui.control_helper.ControlPanel` object for the command
        line options.

        parent: :class:`ttk.Frame`
            The frame to hold the command line choices
        defaults: dict
            The default command line options
        available_masks: list
            The available masks that exist within the alignments file
        has_predicted_mask: bool
            Whether the model was trained with a mask
        """</span>
        <span class="identifier">cp_options</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_control_panel_options</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span>
        <span class="identifier">panel_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">blank_nones</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">label_width</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">style</span><span class="arithmetic-assignment">=</span><span class="string-literal">"CPanel"</span><span class="grouping">)</span>
        <span class="identifier">ControlPanel</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">cp_options</span><span class="punctuation">,</span> <span class="identifier">header_text</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">panel_kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_control_panel_options</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Create :class:`lib.gui.control_helper.ControlPanelOption` objects for the command
        line options.

        defaults: dict
            The default command line options
        available_masks: list
            The available masks that exist within the alignments file
        has_predicted_mask: bool
            Whether the model was trained with a mask

        Returns
        -------
        list
            The list of `lib.gui.control_helper.ControlPanelOption` objects for the Action Frame
        """</span>
        <span class="identifier">cp_options</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">opt</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_options</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">opt</span> <span class="relational-operator">==</span> <span class="string-literal">"mask_type"</span><span class="punctuation">:</span>
                <span class="identifier">choices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_create_mask_choices</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">choices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PluginLoader</span><span class="punctuation">.</span><span class="identifier">get_available_convert_plugins</span><span class="grouping">(</span><span class="identifier">opt</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">cp_option</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ControlPanelOption</span><span class="grouping">(</span><span class="identifier">title</span><span class="arithmetic-assignment">=</span><span class="identifier">opt</span><span class="punctuation">,</span>
                                           <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="punctuation">,</span>
                                           <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="identifier">opt</span><span class="grouping">]</span><span class="punctuation">,</span>
                                           <span class="identifier">initial_value</span><span class="arithmetic-assignment">=</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="identifier">opt</span><span class="grouping">]</span><span class="punctuation">,</span>
                                           <span class="identifier">choices</span><span class="arithmetic-assignment">=</span><span class="identifier">choices</span><span class="punctuation">,</span>
                                           <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Command Line Choices"</span><span class="punctuation">,</span>
                                           <span class="identifier">is_radio</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="identifier">opt</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cp_option</span><span class="punctuation">.</span><span class="identifier">tk_var</span>
            <span class="identifier">cp_options</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">cp_option</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">cp_options</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_create_mask_choices</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="punctuation">,</span> <span class="identifier">has_predicted_mask</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the mask choices and default mask based on available masks.

        Parameters
        ----------
        defaults: dict
            The default command line options
        available_masks: list
            The available masks that exist within the alignments file
        has_predicted_mask: bool
            Whether the model was trained with a mask

        Returns
        -------
        list
            The masks that are available to use from the alignments file
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initial mask choices: %s"</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">has_predicted_mask</span><span class="punctuation">:</span>
            <span class="identifier">available_masks</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">[</span><span class="string-literal">"predicted"</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="string-literal">"none"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">available_masks</span><span class="punctuation">:</span>
            <span class="identifier">available_masks</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">[</span><span class="string-literal">"none"</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="string-literal">"mask_type"</span><span class="grouping">]</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">available_masks</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting default mask to first available: %s"</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="string-literal">"mask_type"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">available_masks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Final mask choices: %s"</span><span class="punctuation">,</span> <span class="identifier">available_masks</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">available_masks</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_add_refresh_button</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">refresh_callback</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add a button to refresh the images.

        Parameters
        ----------
        refresh_callback: python function
            The function to execute when the refresh button is pressed
        """</span>
        <span class="identifier">btn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Button</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Update Samples"</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="identifier">refresh_callback</span><span class="grouping">)</span>
        <span class="identifier">btn</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">N</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_patch_callback</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add callback to re-patch images on action option change.

        Parameters
        ----------
        patch_callback: python function
            The function to execute when the images require patching
        """</span>
        <span class="keyword">for</span> <span class="identifier">tk_var</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">tk_var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_busy_indicator</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Place progress bar into bottom bar to indicate when processing.

        Parameters
        ----------
        parent: tkinter object
            The tkinter object that holds the busy indicator

        Returns
        -------
        ttk.Progressbar
            A Progress bar to indicate that the Preview tool is busy
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Placing busy indicator"</span><span class="grouping">)</span>
        <span class="identifier">pbar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Progressbar</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">"indeterminate"</span><span class="grouping">)</span>
        <span class="identifier">pbar</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="grouping">)</span>
        <span class="identifier">pbar</span><span class="punctuation">.</span><span class="identifier">pack_forget</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_tkvar</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_indicator_trace</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">pbar</span>

    <span class="keyword">def</span> <span class="identifier">_busy_indicator_trace</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Show or hide busy indicator based on whether the preview is updating.

        Parameters
        ----------
        args: unused
            Required for tkinter event, but unused
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Busy indicator trace: %s"</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_tkvar</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_start_busy_indicator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_stop_busy_indicator</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_stop_busy_indicator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Stop and hide progress bar """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Stopping busy indicator"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_indicator</span><span class="punctuation">.</span><span class="identifier">stop</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_indicator</span><span class="punctuation">.</span><span class="identifier">pack_forget</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_start_busy_indicator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Start and display progress bar """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Starting busy indicator"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_indicator</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="punctuation">,</span> <span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_busy_indicator</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_actions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add Action Buttons to the :class:`ActionFrame`

        Parameters
        ----------
        parent: tkinter object
            The tkinter object that holds the action buttons
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding util buttons"</span><span class="grouping">)</span>
        <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">E</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">utl</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"save", "clear", "reload"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding button: '%s'"</span><span class="punctuation">,</span> <span class="identifier">utl</span><span class="grouping">)</span>
            <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_images</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">icons</span><span class="grouping">[</span><span class="identifier">utl</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">utl</span> <span class="relational-operator">==</span> <span class="string-literal">"save"</span><span class="punctuation">:</span>
                <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Save full config"</span><span class="grouping">)</span>
                <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">.</span><span class="identifier">save_config</span>
            <span class="keyword">elif</span> <span class="identifier">utl</span> <span class="relational-operator">==</span> <span class="string-literal">"clear"</span><span class="punctuation">:</span>
                <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Reset full config to default values"</span><span class="grouping">)</span>
                <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">.</span><span class="identifier">reset_config_to_default</span>
            <span class="keyword">elif</span> <span class="identifier">utl</span> <span class="relational-operator">==</span> <span class="string-literal">"reload"</span><span class="punctuation">:</span>
                <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Reset full config to saved values"</span><span class="grouping">)</span>
                <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config_tools</span><span class="punctuation">.</span><span class="identifier">reset_config_to_saved</span>

            <span class="identifier">btnutl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Button</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span>
                                <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">img</span><span class="punctuation">,</span>
                                <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="identifier">action</span><span class="grouping">)</span>
            <span class="identifier">btnutl</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="grouping">)</span>
            <span class="identifier">Tooltip</span><span class="grouping">(</span><span class="identifier">btnutl</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">text</span><span class="punctuation">,</span> <span class="identifier">wrap_length</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Added util buttons"</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">OptionsBook</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Notebook</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-many-ancestors</span>
    <span class="comment">""" The notebook that holds the Convert configuration options.

    Parameters
    ----------
    parent: tkinter object
        The parent tkinter object that holds the Options book
    config_tools: :class:`ConfigTools`
        Tools for loading and saving configuration files
    patch_callback: python function
        The function to execute when a patch callback is received

    Attributes
    ----------
    config_tools: :class:`ConfigTools`
        Tools for loading and saving configuration files
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_tools</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (parent: %s, config: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_tools</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">N</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config_tools</span> <span class="arithmetic-assignment">=</span> <span class="identifier">config_tools</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tabs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_build_tabs</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_build_sub_tabs</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_patch_callback</span><span class="grouping">(</span><span class="identifier">patch_callback</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_build_tabs</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the notebook tabs for the each configuration section. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Build Tabs"</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">section</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">sections</span><span class="punctuation">:</span>
            <span class="identifier">tab</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Notebook</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tabs</span><span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"tab"</span><span class="punctuation">:</span> <span class="identifier">tab</span><span class="grouping">}</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">tab</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">section</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">"_", " "</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_build_sub_tabs</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the notebook sub tabs for each convert section's plugin. """</span>
        <span class="keyword">for</span> <span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">plugins</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">plugins_dict</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">plugin</span> <span class="relational-operator">in</span> <span class="identifier">plugins</span><span class="punctuation">:</span>
                <span class="identifier">config_key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"."</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">section</span><span class="punctuation">,</span> <span class="identifier">plugin</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">config_dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">config_dicts</span><span class="grouping">[</span><span class="identifier">config_key</span><span class="grouping">]</span>
                <span class="identifier">tab</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfigFrame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">config_key</span><span class="punctuation">,</span> <span class="identifier">config_dict</span><span class="grouping">)</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tabs</span><span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">plugin</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tab</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tabs</span><span class="grouping">[</span><span class="identifier">section</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"tab"].add(tab, text=plugin.replace("_", " "</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_patch_callback</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add callback to re-patch images on configuration option change.

        Parameters
        ----------
        patch_callback: python function
            The function to execute when the images require patching
        """</span>
        <span class="keyword">for</span> <span class="identifier">plugins</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">tk_var</span> <span class="relational-operator">in</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">tk_var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="identifier">patch_callback</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">ConfigFrame</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=too-many-ancestors</span>
    <span class="comment">""" Holds the configuration options for a convert plugin inside the :class:`OptionsBook`.

    Parameters
    ----------
    parent: tkinter object
        The tkinter object that will hold this configuration frame
    config_key: str
        The section/plugin key for these configuration options
    options: dict
        The options for this section/plugin
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_key</span><span class="punctuation">,</span> <span class="identifier">options</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_options</span> <span class="arithmetic-assignment">=</span> <span class="identifier">options</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_action_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_action_frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTTOM</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">E</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_frame_separator</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_build_frame</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_key</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_build_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_key</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the options frame for this command

        Parameters
        ----------
        parent: tkinter object
            The tkinter object that will hold this configuration frame
        config_key: str
            The section/plugin key for these configuration options
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Add Config Frame"</span><span class="grouping">)</span>
        <span class="identifier">panel_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">option_columns</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">blank_nones</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">style</span><span class="arithmetic-assignment">=</span><span class="string-literal">"CPanel"</span><span class="grouping">)</span>
        <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">cp_options</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">opt</span> <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">opt</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_options</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">key</span> <span class="relational-operator">!=</span> <span class="string-literal">"helptext"</span><span class="grouping">]</span>
        <span class="identifier">ControlPanel</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span> <span class="identifier">cp_options</span><span class="punctuation">,</span> <span class="identifier">header_text</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">panel_kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_actions</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_key</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Added Config Frame"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_frame_separator</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add a separator between top and bottom frames. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Add frame seperator"</span><span class="grouping">)</span>
        <span class="identifier">sep</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_action_frame</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">relief</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIDGE</span><span class="grouping">)</span>
        <span class="identifier">sep</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Added frame seperator"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_actions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">config_key</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add Action Buttons.

        Parameters
        ----------
        parent: tkinter object
            The tkinter object that will hold this configuration frame
        config_key: str
            The section/plugin key for these configuration options
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding util buttons"</span><span class="grouping">)</span>

        <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="identifier">config_key</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">".")[1].replace("_", " "</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">btn_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_action_frame</span><span class="grouping">)</span>
        <span class="identifier">btn_frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTTOM</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">utl</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"save", "clear", "reload"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding button: '%s'"</span><span class="punctuation">,</span> <span class="identifier">utl</span><span class="grouping">)</span>
            <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_images</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">icons</span><span class="grouping">[</span><span class="identifier">utl</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">utl</span> <span class="relational-operator">==</span> <span class="string-literal">"save"</span><span class="punctuation">:</span>
                <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Save {} config"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>
                <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">save_config</span>
            <span class="keyword">elif</span> <span class="identifier">utl</span> <span class="relational-operator">==</span> <span class="string-literal">"clear"</span><span class="punctuation">:</span>
                <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Reset {} config to default values"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>
                <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">reset_config_to_default</span>
            <span class="keyword">elif</span> <span class="identifier">utl</span> <span class="relational-operator">==</span> <span class="string-literal">"reload"</span><span class="punctuation">:</span>
                <span class="identifier">text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Reset {} config to saved values"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>
                <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">config_tools</span><span class="punctuation">.</span><span class="identifier">reset_config_to_saved</span>

            <span class="identifier">btnutl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Button</span><span class="grouping">(</span><span class="identifier">btn_frame</span><span class="punctuation">,</span>
                                <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">img</span><span class="punctuation">,</span>
                                <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">cmd</span><span class="arithmetic-assignment">=</span><span class="identifier">action</span><span class="punctuation">:</span> <span class="identifier">cmd</span><span class="grouping">(</span><span class="identifier">config_key</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">btnutl</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="grouping">)</span>
            <span class="identifier">Tooltip</span><span class="grouping">(</span><span class="identifier">btnutl</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">text</span><span class="punctuation">,</span> <span class="identifier">wrap_length</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Added util buttons"</span><span class="grouping">)</span>

    </pre>
  </body>
</html>