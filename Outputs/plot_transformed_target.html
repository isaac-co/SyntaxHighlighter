<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python</span>
<span class="comment"># -*- coding: utf-8 -*-</span>

<span class="comment">"""
======================================================
Effect of transforming the targets in regression model
======================================================

In this example, we give an overview of
:class:`~sklearn.compose.TransformedTargetRegressor`. We use two examples
to illustrate the benefit of transforming the targets before learning a linear
regression model. The first example uses synthetic data while the second
example is based on the Ames housing data set.
"""</span>

<span class="comment"># Author: Guillaume Lemaitre &lt;guillaume.lemaitre@inria.fr&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">RidgeCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">TransformedTargetRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">median_absolute_error</span><span class="punctuation">,</span> <span class="identifier">r2_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">parse_version</span>

<span class="comment"># %%</span>
<span class="comment"># Synthetic example</span>
<span class="comment">##############################################################################</span>

<span class="comment"># `normed` is being deprecated in favor of `density` in histograms</span>
<span class="keyword">if</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'2.1'</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">density_param</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'density'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="identifier">density_param</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'normed'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>

<span class="comment"># %%</span>
<span class="comment"># A synthetic random regression dataset is generated. The targets ``y`` are</span>
<span class="comment"># modified by:</span>
<span class="comment">#</span>
<span class="comment">#   1. translating all targets such that all entries are</span>
<span class="comment">#      non-negative (by adding the absolute value of the lowest ``y``) and</span>
<span class="comment">#   2. applying an exponential function to obtain non-linear</span>
<span class="comment">#      targets which cannot be fitted using a simple linear model.</span>
<span class="comment">#</span>
<span class="comment"># Therefore, a logarithmic (`np.log1p`) and an exponential function</span>
<span class="comment"># (`np.expm1`) will be used to transform the targets before training a linear</span>
<span class="comment"># regression model and using it for prediction.</span>

<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">10000</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">expm1</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">200</span><span class="grouping">)</span>
<span class="identifier">y_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log1p</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Below we plot the probability density functions of the target</span>
<span class="comment"># before and after applying the logarithmic functions.</span>

<span class="identifier">f</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">ax0</span><span class="punctuation">,</span> <span class="identifier">ax1</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">density_param</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Probability'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Target distribution'</span><span class="grouping">)</span>

<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">y_trans</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">density_param</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Probability'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Target'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Transformed target distribution'</span><span class="grouping">)</span>

<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="string-literal">"Synthetic data"</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.06</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.53</span><span class="grouping">)</span>
<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="identifier">rect</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># At first, a linear model will be applied on the original targets. Due to the</span>
<span class="comment"># non-linearity, the model trained will not be precise during</span>
<span class="comment"># prediction. Subsequently, a logarithmic function is used to linearize the</span>
<span class="comment"># targets, allowing better prediction even with a similar linear model as</span>
<span class="comment"># reported by the median absolute error (MAE).</span>

<span class="identifier">f</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">ax0</span><span class="punctuation">,</span> <span class="identifier">ax1</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">sharey</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="comment"># Use linear model</span>
<span class="identifier">regr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">regr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
<span class="comment"># Plot results</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'--k'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Target predicted'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'True Target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Ridge regression \n without target transformation'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1750</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'$R^2$=%.2f, MAE=%.2f'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
    <span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">median_absolute_error</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="comment"># Transform targets and use same linear model</span>
<span class="identifier">regr_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TransformedTargetRegressor</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="arithmetic-assignment">=</span><span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                        <span class="identifier">func</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log1p</span><span class="punctuation">,</span>
                                        <span class="identifier">inverse_func</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">expm1</span><span class="grouping">)</span>
<span class="identifier">regr_trans</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regr_trans</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'--k'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Target predicted'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'True Target'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Ridge regression \n with target transformation'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1750</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'$R^2$=%.2f, MAE=%.2f'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
    <span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">median_absolute_error</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="string-literal">"Synthetic data"</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.035</span><span class="grouping">)</span>
<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="identifier">rect</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Real-world data set</span>
<span class="comment">###############################################################################</span>
<span class="comment">#</span>
<span class="comment"># In a similar manner, the Ames housing data set is used to show the impact</span>
<span class="comment"># of transforming the targets before learning a model. In this example, the</span>
<span class="comment"># target to be predicted is the selling price of each house.</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_openml</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">QuantileTransformer</span><span class="punctuation">,</span> <span class="identifier">quantile_transform</span>

<span class="identifier">ames</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"house_prices"</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="comment"># Keep only numeric columns</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ames</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">select_dtypes</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">number</span><span class="grouping">)</span>
<span class="comment"># Remove columns with NaN or Inf values</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">drop</span><span class="grouping">(</span><span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'LotFrontage', 'GarageYrBlt', 'MasVnrArea'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ames</span><span class="punctuation">.</span><span class="identifier">target</span>
<span class="identifier">y_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">quantile_transform</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">to_frame</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">n_quantiles</span><span class="arithmetic-assignment">=</span><span class="int-literal">900</span><span class="punctuation">,</span>
                             <span class="identifier">output_distribution</span><span class="arithmetic-assignment">=</span><span class="string-literal">'normal'</span><span class="punctuation">,</span>
                             <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="comment"># %%</span>
<span class="comment"># A :class:`~sklearn.preprocessing.QuantileTransformer` is used to normalize</span>
<span class="comment"># the target distribution before applying a</span>
<span class="comment"># :class:`~sklearn.linear_model.RidgeCV` model.</span>

<span class="identifier">f</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">ax0</span><span class="punctuation">,</span> <span class="identifier">ax1</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">density_param</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Probability'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Target distribution'</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.2e5</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">9.8e-6</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="punctuation">.</span><span class="identifier">ticklabel_format</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="string-literal">"both", style="sci"</span><span class="punctuation">,</span> <span class="identifier">scilimits</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">y_trans</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">density_param</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Probability'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Target'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Transformed target distribution'</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="float-literal">-6.8</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.479</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="grouping">)</span>

<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="string-literal">"Ames housing data: selling price"</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.04</span><span class="grouping">)</span>
<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="identifier">rect</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># The effect of the transformer is weaker than on the synthetic data. However,</span>
<span class="comment"># the transformation results in an increase in :math:`R^2` and large decrease</span>
<span class="comment"># of the MAE. The residual plot (predicted target - true target vs predicted</span>
<span class="comment"># target) without target transformation takes on a curved, 'reverse smile'</span>
<span class="comment"># shape due to residual values that vary depending on the value of predicted</span>
<span class="comment"># target. With target transformation, the shape is more linear indicating</span>
<span class="comment"># better model fit.</span>

<span class="identifier">f</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">ax0</span><span class="punctuation">,</span> <span class="identifier">ax1</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">sharey</span><span class="arithmetic-assignment">=</span><span class="string-literal">'row'</span><span class="punctuation">,</span> <span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">6.5</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">regr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">regr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regr</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'--k'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'True target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Predicted target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Ridge regression \n without target transformation'</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="float-literal">5e4</span><span class="punctuation">,</span>
            <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">8e5</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="identifier">multialignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="float-literal">3e4</span><span class="punctuation">,</span> <span class="float-literal">64e4</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'$R^2$=%.2f, MAE=%.2f'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
    <span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">median_absolute_error</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ticklabel_format</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="string-literal">"both", style="sci"</span><span class="punctuation">,</span> <span class="identifier">scilimits</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Residual'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Predicted target'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ticklabel_format</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="string-literal">"both", style="sci"</span><span class="punctuation">,</span> <span class="identifier">scilimits</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">regr_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TransformedTargetRegressor</span><span class="grouping">(</span>
    <span class="identifier">regressor</span><span class="arithmetic-assignment">=</span><span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">transformer</span><span class="arithmetic-assignment">=</span><span class="identifier">QuantileTransformer</span><span class="grouping">(</span><span class="identifier">n_quantiles</span><span class="arithmetic-assignment">=</span><span class="int-literal">900</span><span class="punctuation">,</span>
                                    <span class="identifier">output_distribution</span><span class="arithmetic-assignment">=</span><span class="string-literal">'normal'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">regr_trans</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regr_trans</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">'--k'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'True target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Predicted target'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Ridge regression \n with target transformation'</span><span class="punctuation">,</span> <span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="float-literal">5e4</span><span class="punctuation">,</span>
            <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">8e5</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="identifier">multialignment</span><span class="arithmetic-assignment">=</span><span class="string-literal">'center'</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="float-literal">3e4</span><span class="punctuation">,</span> <span class="float-literal">64e4</span><span class="punctuation">,</span> <span class="identifier">r</span><span class="string-literal">'$R^2$=%.2f, MAE=%.2f'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
    <span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">median_absolute_error</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">7e5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax0</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ticklabel_format</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="string-literal">"both", style="sci"</span><span class="punctuation">,</span> <span class="identifier">scilimits</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Residual'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Predicted target'</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ticklabel_format</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="string-literal">"both", style="sci"</span><span class="punctuation">,</span> <span class="identifier">scilimits</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="string-literal">"Ames housing data: selling price"</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.035</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>