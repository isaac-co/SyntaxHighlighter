<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Alexander Fabisch  -- &lt;afabisch@informatik.uni-bremen.de&gt;</span>
<span class="comment"># Author: Christopher Moody &lt;chrisemoody@gmail.com&gt;</span>
<span class="comment"># Author: Nick Travers &lt;nickt@squareup.com&gt;</span>
<span class="comment"># License: BSD 3 clause (C) 2014</span>

<span class="comment"># This is the exact and Barnes-Hut t-SNE implementation. There are other</span>
<span class="comment"># modifications of the algorithm:</span>
<span class="comment"># * Fast Optimization for t-SNE:</span>
<span class="comment">#   https://cseweb.ucsd.edu/~lvdmaaten/workshops/nips2010/papers/vandermaaten.pdf</span>

<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">spatial</span><span class="punctuation">.</span><span class="identifier">distance</span> <span class="keyword">import</span> <span class="identifier">pdist</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">spatial</span><span class="punctuation">.</span><span class="identifier">distance</span> <span class="keyword">import</span> <span class="identifier">squareform</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">issparse</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">NearestNeighbors</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_openmp_helpers</span> <span class="keyword">import</span> <span class="identifier">_openmp_effective_n_threads</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_non_negative</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">PCA</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances</span>
<span class="comment"># mypy error: Module 'sklearn.manifold' has no attribute '_utils'</span>
<span class="keyword">from</span> <span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">_utils</span>  <span class="comment"># type: ignore</span>
<span class="comment"># mypy error: Module 'sklearn.manifold' has no attribute '_barnes_hut_tsne'</span>
<span class="keyword">from</span> <span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">_barnes_hut_tsne</span>  <span class="comment"># type: ignore</span>


<span class="identifier">MACHINE_EPSILON</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">double</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>


<span class="keyword">def</span> <span class="identifier">_joint_probabilities</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">desired_perplexity</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute joint probabilities p_ij from distances.

    Parameters
    ----------
    distances : ndarray of shape (n_samples * (n_samples-1) / 2,)
        Distances of samples are stored as condensed matrices, i.e.
        we omit the diagonal and duplicate entries and store everything
        in a one-dimensional array.

    desired_perplexity : float
        Desired perplexity of the joint probability distributions.

    verbose : int
        Verbosity level.

    Returns
    -------
    P : ndarray of shape (n_samples * (n_samples-1) / 2,)
        Condensed joint probability matrix.
    """</span>
    <span class="comment"># Compute conditional probabilities such that they approximately match</span>
    <span class="comment"># the desired perplexity</span>
    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">distances</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">conditional_P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_utils</span><span class="punctuation">.</span><span class="identifier">_binary_search_perplexity</span><span class="grouping">(</span>
        <span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">desired_perplexity</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="grouping">)</span>
    <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">conditional_P</span> <span class="arithmetic-operator">+</span> <span class="identifier">conditional_P</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">sum_P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">P</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">MACHINE_EPSILON</span><span class="grouping">)</span>
    <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">squareform</span><span class="grouping">(</span><span class="identifier">P</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">sum_P</span><span class="punctuation">,</span> <span class="identifier">MACHINE_EPSILON</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">P</span>


<span class="keyword">def</span> <span class="identifier">_joint_probabilities_nn</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">desired_perplexity</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute joint probabilities p_ij from distances using just nearest
    neighbors.

    This method is approximately equal to _joint_probabilities. The latter
    is O(N), but limiting the joint probability to nearest neighbors improves
    this substantially to O(uN).

    Parameters
    ----------
    distances : sparse matrix of shape (n_samples, n_samples)
        Distances of samples to its n_neighbors nearest neighbors. All other
        distances are left to zero (and are not materialized in memory).
        Matrix should be of CSR format.

    desired_perplexity : float
        Desired perplexity of the joint probability distributions.

    verbose : int
        Verbosity level.

    Returns
    -------
    P : sparse matrix of shape (n_samples, n_samples)
        Condensed joint probability matrix with only nearest neighbors. Matrix
        will be of CSR format.
    """</span>
    <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># Compute conditional probabilities such that they approximately match</span>
    <span class="comment"># the desired perplexity</span>
    <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">sort_indices</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">distances_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">distances_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">distances_data</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">conditional_P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_utils</span><span class="punctuation">.</span><span class="identifier">_binary_search_perplexity</span><span class="grouping">(</span>
        <span class="identifier">distances_data</span><span class="punctuation">,</span> <span class="identifier">desired_perplexity</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">conditional_P</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">\</span>
        <span class="string-literal">"All probabilities should be finite"</span>

    <span class="comment"># Symmetrize the joint probability distribution using sparse operations</span>
    <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">conditional_P</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span>
                    <span class="identifier">distances</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">P</span> <span class="arithmetic-operator">+</span> <span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># Normalize the joint probability distribution</span>
    <span class="identifier">sum_P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">MACHINE_EPSILON</span><span class="grouping">)</span>
    <span class="identifier">P</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">sum_P</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Computed conditional probabilities in {:.3f}s"</span>
              <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">duration</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">P</span>


<span class="keyword">def</span> <span class="identifier">_kl_divergence</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span>
                   <span class="identifier">skip_num_points</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">compute_error</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""t-SNE objective function: gradient of the KL divergence
    of p_ijs and q_ijs and the absolute error.

    Parameters
    ----------
    params : ndarray of shape (n_params,)
        Unraveled embedding.

    P : ndarray of shape (n_samples * (n_samples-1) / 2,)
        Condensed joint probability matrix.

    degrees_of_freedom : int
        Degrees of freedom of the Student's-t distribution.

    n_samples : int
        Number of samples.

    n_components : int
        Dimension of the embedded space.

    skip_num_points : int, default=0
        This does not compute the gradient for points with indices below
        `skip_num_points`. This is useful when computing transforms of new
        data where you'd like to keep the old data fixed.

    compute_error: bool, default=True
        If False, the kl_divergence is not computed and returns NaN.

    Returns
    -------
    kl_divergence : float
        Kullback-Leibler divergence of p_ij and q_ij.

    grad : ndarray of shape (n_params,)
        Unraveled gradient of the Kullback-Leibler divergence with respect to
        the embedding.
    """</span>
    <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>

    <span class="comment"># Q is a heavy-tailed distribution: Student's t-distribution</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pdist</span><span class="grouping">(</span><span class="identifier">X_embedded</span><span class="punctuation">,</span> <span class="string-literal">"sqeuclidean"</span><span class="grouping">)</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">degrees_of_freedom</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="identifier">dist</span> <span class="arithmetic-assignment">**=</span> <span class="grouping">(</span><span class="identifier">degrees_of_freedom</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">-2.0</span>
    <span class="identifier">Q</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">dist</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">dist</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">MACHINE_EPSILON</span><span class="grouping">)</span>

    <span class="comment"># Optimization trick below: np.dot(x, y) is faster than</span>
    <span class="comment"># np.sum(x * y) because it calls BLAS</span>

    <span class="comment"># Objective: C (Kullback-Leibler divergence of P and Q)</span>
    <span class="keyword">if</span> <span class="identifier">compute_error</span><span class="punctuation">:</span>
        <span class="identifier">kl_divergence</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span>
            <span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">MACHINE_EPSILON</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">Q</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">kl_divergence</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

    <span class="comment"># Gradient: dC/dY</span>
    <span class="comment"># pdist always returns double precision distances. Thus we need to take</span>
    <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">PQd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squareform</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">P</span> <span class="arithmetic-operator">-</span> <span class="identifier">Q</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">dist</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">skip_num_points</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">grad</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">PQd</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'K'</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="identifier">X_embedded</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X_embedded</span><span class="grouping">)</span>
    <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grad</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">degrees_of_freedom</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">degrees_of_freedom</span>
    <span class="identifier">grad</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">c</span>

    <span class="keyword">return</span> <span class="identifier">kl_divergence</span><span class="punctuation">,</span> <span class="identifier">grad</span>


<span class="keyword">def</span> <span class="identifier">_kl_divergence_bh</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span>
                      <span class="identifier">angle</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">skip_num_points</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                      <span class="identifier">compute_error</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">num_threads</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""t-SNE objective function: KL divergence of p_ijs and q_ijs.

    Uses Barnes-Hut tree methods to calculate the gradient that
    runs in O(NlogN) instead of O(N^2).

    Parameters
    ----------
    params : ndarray of shape (n_params,)
        Unraveled embedding.

    P : sparse matrix of shape (n_samples, n_sample)
        Sparse approximate joint probability matrix, computed only for the
        k nearest-neighbors and symmetrized. Matrix should be of CSR format.

    degrees_of_freedom : int
        Degrees of freedom of the Student's-t distribution.

    n_samples : int
        Number of samples.

    n_components : int
        Dimension of the embedded space.

    angle : float, default=0.5
        This is the trade-off between speed and accuracy for Barnes-Hut T-SNE.
        'angle' is the angular size (referred to as theta in [3]) of a distant
        node as measured from a point. If this size is below 'angle' then it is
        used as a summary node of all points contained within it.
        This method is not very sensitive to changes in this parameter
        in the range of 0.2 - 0.8. Angle less than 0.2 has quickly increasing
        computation time and angle greater 0.8 has quickly increasing error.

    skip_num_points : int, default=0
        This does not compute the gradient for points with indices below
        `skip_num_points`. This is useful when computing transforms of new
        data where you'd like to keep the old data fixed.

    verbose : int, default=False
        Verbosity level.

    compute_error: bool, default=True
        If False, the kl_divergence is not computed and returns NaN.

    num_threads : int, default=1
        Number of threads used to compute the gradient. This is set here to
        avoid calling _openmp_effective_n_threads for each gradient step.

    Returns
    -------
    kl_divergence : float
        Kullback-Leibler divergence of p_ij and q_ij.

    grad : ndarray of shape (n_params,)
        Unraveled gradient of the Kullback-Leibler divergence with respect to
        the embedding.
    """</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>

    <span class="identifier">val_P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">P</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X_embedded</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_barnes_hut_tsne</span><span class="punctuation">.</span><span class="identifier">gradient</span><span class="grouping">(</span><span class="identifier">val_P</span><span class="punctuation">,</span> <span class="identifier">X_embedded</span><span class="punctuation">,</span> <span class="identifier">neighbors</span><span class="punctuation">,</span> <span class="identifier">indptr</span><span class="punctuation">,</span>
                                      <span class="identifier">grad</span><span class="punctuation">,</span> <span class="identifier">angle</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="punctuation">,</span>
                                      <span class="identifier">dof</span><span class="arithmetic-assignment">=</span><span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span>
                                      <span class="identifier">compute_error</span><span class="arithmetic-assignment">=</span><span class="identifier">compute_error</span><span class="punctuation">,</span>
                                      <span class="identifier">num_threads</span><span class="arithmetic-assignment">=</span><span class="identifier">num_threads</span><span class="grouping">)</span>
    <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">degrees_of_freedom</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">degrees_of_freedom</span>
    <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grad</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">grad</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">c</span>

    <span class="keyword">return</span> <span class="identifier">error</span><span class="punctuation">,</span> <span class="identifier">grad</span>


<span class="keyword">def</span> <span class="identifier">_gradient_descent</span><span class="grouping">(</span><span class="identifier">objective</span><span class="punctuation">,</span> <span class="identifier">p0</span><span class="punctuation">,</span> <span class="identifier">it</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="punctuation">,</span>
                      <span class="identifier">n_iter_check</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_iter_without_progress</span><span class="arithmetic-assignment">=</span><span class="int-literal">300</span><span class="punctuation">,</span>
                      <span class="identifier">momentum</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="float-literal">200.0</span><span class="punctuation">,</span> <span class="identifier">min_gain</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                      <span class="identifier">min_grad_norm</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Batch gradient descent with momentum and individual gains.

    Parameters
    ----------
    objective : callable
        Should return a tuple of cost and gradient for a given parameter
        vector. When expensive to compute, the cost can optionally
        be None and can be computed every n_iter_check steps using
        the objective_error function.

    p0 : array-like of shape (n_params,)
        Initial parameter vector.

    it : int
        Current number of iterations (this function will be called more than
        once during the optimization).

    n_iter : int
        Maximum number of gradient descent iterations.

    n_iter_check : int, default=1
        Number of iterations before evaluating the global error. If the error
        is sufficiently low, we abort the optimization.

    n_iter_without_progress : int, default=300
        Maximum number of iterations without progress before we abort the
        optimization.

    momentum : float within (0.0, 1.0), default=0.8
        The momentum generates a weight for previous gradients that decays
        exponentially.

    learning_rate : float, default=200.0
        The learning rate for t-SNE is usually in the range [10.0, 1000.0]. If
        the learning rate is too high, the data may look like a 'ball' with any
        point approximately equidistant from its nearest neighbours. If the
        learning rate is too low, most points may look compressed in a dense
        cloud with few outliers.

    min_gain : float, default=0.01
        Minimum individual gain for each parameter.

    min_grad_norm : float, default=1e-7
        If the gradient norm is below this threshold, the optimization will
        be aborted.

    verbose : int, default=0
        Verbosity level.

    args : sequence, default=None
        Arguments to pass to objective function.

    kwargs : dict, default=None
        Keyword arguments to pass to objective function.

    Returns
    -------
    p : ndarray of shape (n_params,)
        Optimum parameters.

    error : float
        Optimum.

    i : int
        Last iteration.
    """</span>
    <span class="keyword">if</span> <span class="identifier">args</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">kwargs</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>

    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">p0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">update</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span>
    <span class="identifier">gains</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span>
    <span class="identifier">error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span>
    <span class="identifier">best_error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span>
    <span class="identifier">best_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">it</span>

    <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">it</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_convergence</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">n_iter_check</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
        <span class="comment"># only compute the error when needed</span>
        <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">'compute_error'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_convergence</span> <span class="logical-operator">or</span> <span class="identifier">i</span> <span class="relational-operator">==</span> <span class="identifier">n_iter</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

        <span class="identifier">error</span><span class="punctuation">,</span> <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">objective</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">grad_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">grad</span><span class="grouping">)</span>

        <span class="identifier">inc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">update</span> <span class="arithmetic-operator">*</span> <span class="identifier">grad</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.0</span>
        <span class="identifier">dec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">invert</span><span class="grouping">(</span><span class="identifier">inc</span><span class="grouping">)</span>
        <span class="identifier">gains</span><span class="grouping">[</span><span class="identifier">inc</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="float-literal">0.2</span>
        <span class="identifier">gains</span><span class="grouping">[</span><span class="identifier">dec</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">0.8</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">gains</span><span class="punctuation">,</span> <span class="identifier">min_gain</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">gains</span><span class="grouping">)</span>
        <span class="identifier">grad</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">gains</span>
        <span class="identifier">update</span> <span class="arithmetic-assignment">=</span> <span class="identifier">momentum</span> <span class="arithmetic-operator">*</span> <span class="identifier">update</span> <span class="arithmetic-operator">-</span> <span class="identifier">learning_rate</span> <span class="arithmetic-operator">*</span> <span class="identifier">grad</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">update</span>

        <span class="keyword">if</span> <span class="identifier">check_convergence</span><span class="punctuation">:</span>
            <span class="identifier">toc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">toc</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
            <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">toc</span>

            <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Iteration %d: error = %.7f,"</span>
                      <span class="string-literal">" gradient norm = %.7f"</span>
                      <span class="string-literal">" (%s iterations in %0.3fs)"</span>
                      <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">error</span><span class="punctuation">,</span> <span class="identifier">grad_norm</span><span class="punctuation">,</span> <span class="identifier">n_iter_check</span><span class="punctuation">,</span> <span class="identifier">duration</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">error</span> <span class="relational-operator">&lt;</span> <span class="identifier">best_error</span><span class="punctuation">:</span>
                <span class="identifier">best_error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">error</span>
                <span class="identifier">best_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i</span>
            <span class="keyword">elif</span> <span class="identifier">i</span> <span class="arithmetic-operator">-</span> <span class="identifier">best_iter</span> <span class="relational-operator">&gt;</span> <span class="identifier">n_iter_without_progress</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Iteration %d: did not make any progress "</span>
                          <span class="string-literal">"during the last %d episodes. Finished."</span>
                          <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_iter_without_progress</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">break</span>
            <span class="keyword">if</span> <span class="identifier">grad_norm</span> <span class="relational-operator">&lt;=</span> <span class="identifier">min_grad_norm</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Iteration %d: gradient norm %f. Finished."</span>
                          <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">grad_norm</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">break</span>

    <span class="keyword">return</span> <span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">error</span><span class="punctuation">,</span> <span class="identifier">i</span>


<span class="keyword">def</span> <span class="identifier">trustworthiness</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X_embedded</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">'euclidean'</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">r</span><span class="comment">"""Expresses to what extent the local structure is retained.

    The trustworthiness is within [0, 1]. It is defined as

    .. math::

        T(k) = 1 - \frac{2}{nk (2n - 3k - 1)} \sum^n_{i=1}
            \sum_{j \in \mathcal{N}_{i}^{k}} \max(0, (r(i, j) - k))

    where for each sample i, :math:`\mathcal{N}_{i}^{k}` are its k nearest
    neighbors in the output space, and every sample j is its :math:`r(i, j)`-th
    nearest neighbor in the input space. In other words, any unexpected nearest
    neighbors in the output space are penalised in proportion to their rank in
    the input space.

    * "Neighborhood Preservation in Nonlinear Projection Methods: An
      Experimental Study"
      J. Venna, S. Kaski
    * "Learning a Parametric Embedding by Preserving Local Structure"
      L.J.P. van der Maaten

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features) or (n_samples, n_samples)
        If the metric is 'precomputed' X must be a square distance
        matrix. Otherwise it contains a sample per row.

    X_embedded : ndarray of shape (n_samples, n_components)
        Embedding of the training data in low-dimensional space.

    n_neighbors : int, default=5
        Number of neighbors k that will be considered.

    metric : str or callable, default='euclidean'
        Which metric to use for computing pairwise distances between samples
        from the original input space. If metric is 'precomputed', X must be a
        matrix of pairwise distances or squared distances. Otherwise, see the
        documentation of argument metric in sklearn.pairwise.pairwise_distances
        for a list of available metrics.

        .. versionadded:: 0.20

    Returns
    -------
    trustworthiness : float
        Trustworthiness of the low-dimensional embedding.
    """</span>
    <span class="identifier">dist_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">'precomputed'</span><span class="punctuation">:</span>
        <span class="identifier">dist_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dist_X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># we set the diagonal to np.inf to exclude the points themselves from</span>
    <span class="comment"># their own neighborhood</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fill_diagonal</span><span class="grouping">(</span><span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
    <span class="identifier">ind_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">dist_X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># `ind_X[i]` is the index of sorted distances between i and other samples</span>
    <span class="identifier">ind_X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
            <span class="identifier">X_embedded</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">kneighbors</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># We build an inverted index of neighbors in the input space: For sample i,</span>
    <span class="comment"># we define `inverted_index[i]` as the inverted index of sorted distances:</span>
    <span class="comment"># inverted_index[i][ind_X[i]] = np.arange(1, n_sample + 1)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">inverted_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">ordered_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">inverted_index</span><span class="grouping">[</span><span class="identifier">ordered_indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="punctuation">,</span>
                   <span class="identifier">ind_X</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ordered_indices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">ranks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inverted_index</span><span class="grouping">[</span><span class="identifier">ordered_indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="identifier">ind_X_embedded</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_neighbors</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">ranks</span><span class="grouping">[</span><span class="identifier">ranks</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">-</span> <span class="identifier">t</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="float-literal">2.0</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_neighbors</span> <span class="arithmetic-operator">*</span>
                          <span class="grouping">(</span><span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="float-literal">3.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_neighbors</span> <span class="arithmetic-operator">-</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">t</span>


<span class="keyword">class</span> <span class="identifier">TSNE</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""t-distributed Stochastic Neighbor Embedding.

    t-SNE [1] is a tool to visualize high-dimensional data. It converts
    similarities between data points to joint probabilities and tries
    to minimize the Kullback-Leibler divergence between the joint
    probabilities of the low-dimensional embedding and the
    high-dimensional data. t-SNE has a cost function that is not convex,
    i.e. with different initializations we can get different results.

    It is highly recommended to use another dimensionality reduction
    method (e.g. PCA for dense data or TruncatedSVD for sparse data)
    to reduce the number of dimensions to a reasonable amount (e.g. 50)
    if the number of features is very high. This will suppress some
    noise and speed up the computation of pairwise distances between
    samples. For more tips see Laurens van der Maaten's FAQ [2].

    Read more in the :ref:`User Guide &lt;t_sne&gt;`.

    Parameters
    ----------
    n_components : int, default=2
        Dimension of the embedded space.

    perplexity : float, default=30.0
        The perplexity is related to the number of nearest neighbors that
        is used in other manifold learning algorithms. Larger datasets
        usually require a larger perplexity. Consider selecting a value
        between 5 and 50. Different values can result in significantly
        different results.

    early_exaggeration : float, default=12.0
        Controls how tight natural clusters in the original space are in
        the embedded space and how much space will be between them. For
        larger values, the space between natural clusters will be larger
        in the embedded space. Again, the choice of this parameter is not
        very critical. If the cost function increases during initial
        optimization, the early exaggeration factor or the learning rate
        might be too high.

    learning_rate : float or 'auto', default=200.0
        The learning rate for t-SNE is usually in the range [10.0, 1000.0]. If
        the learning rate is too high, the data may look like a 'ball' with any
        point approximately equidistant from its nearest neighbours. If the
        learning rate is too low, most points may look compressed in a dense
        cloud with few outliers. If the cost function gets stuck in a bad local
        minimum increasing the learning rate may help.
        Note that many other t-SNE implementations (bhtsne, FIt-SNE, openTSNE,
        etc.) use a definition of learning_rate that is 4 times smaller than
        ours. So our learning_rate=200 corresponds to learning_rate=800 in
        those other implementations. The 'auto' option sets the learning_rate
        to `max(N / early_exaggeration / 4, 50)` where N is the sample size,
        following [4] and [5]. This will become default in 1.2.

    n_iter : int, default=1000
        Maximum number of iterations for the optimization. Should be at
        least 250.

    n_iter_without_progress : int, default=300
        Maximum number of iterations without progress before we abort the
        optimization, used after 250 initial iterations with early
        exaggeration. Note that progress is only checked every 50 iterations so
        this value is rounded to the next multiple of 50.

        .. versionadded:: 0.17
           parameter *n_iter_without_progress* to control stopping criteria.

    min_grad_norm : float, default=1e-7
        If the gradient norm is below this threshold, the optimization will
        be stopped.

    metric : str or callable, default='euclidean'
        The metric to use when calculating distance between instances in a
        feature array. If metric is a string, it must be one of the options
        allowed by scipy.spatial.distance.pdist for its metric parameter, or
        a metric listed in pairwise.PAIRWISE_DISTANCE_FUNCTIONS.
        If metric is "precomputed", X is assumed to be a distance matrix.
        Alternatively, if metric is a callable function, it is called on each
        pair of instances (rows) and the resulting value recorded. The callable
        should take two arrays from X as input and return a value indicating
        the distance between them. The default is "euclidean" which is
        interpreted as squared euclidean distance.

    init : {'random', 'pca'} or ndarray of shape (n_samples, n_components), \
            default='random'
        Initialization of embedding. Possible options are 'random', 'pca',
        and a numpy array of shape (n_samples, n_components).
        PCA initialization cannot be used with precomputed distances and is
        usually more globally stable than random initialization. `init='pca'`
        will become default in 1.2.

    verbose : int, default=0
        Verbosity level.

    random_state : int, RandomState instance or None, default=None
        Determines the random number generator. Pass an int for reproducible
        results across multiple function calls. Note that different
        initializations might result in different local minima of the cost
        function. See :term: `Glossary &lt;random_state&gt;`.

    method : str, default='barnes_hut'
        By default the gradient calculation algorithm uses Barnes-Hut
        approximation running in O(NlogN) time. method='exact'
        will run on the slower, but exact, algorithm in O(N^2) time. The
        exact algorithm should be used when nearest-neighbor errors need
        to be better than 3%. However, the exact method cannot scale to
        millions of examples.

        .. versionadded:: 0.17
           Approximate optimization *method* via the Barnes-Hut.

    angle : float, default=0.5
        Only used if method='barnes_hut'
        This is the trade-off between speed and accuracy for Barnes-Hut T-SNE.
        'angle' is the angular size (referred to as theta in [3]) of a distant
        node as measured from a point. If this size is below 'angle' then it is
        used as a summary node of all points contained within it.
        This method is not very sensitive to changes in this parameter
        in the range of 0.2 - 0.8. Angle less than 0.2 has quickly increasing
        computation time and angle greater 0.8 has quickly increasing error.

    n_jobs : int, default=None
        The number of parallel jobs to run for neighbors search. This parameter
        has no impact when ``metric="precomputed"`` or
        (``metric="euclidean"`` and ``method="exact"``).
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

        .. versionadded:: 0.22

    square_distances : True or 'legacy', default='legacy'
        Whether TSNE should square the distance values. ``'legacy'`` means
        that distance values are squared only when ``metric="euclidean"``.
        ``True`` means that distance values are squared for all metrics.

        .. versionadded:: 0.24
           Added to provide backward compatibility during deprecation of
           legacy squaring behavior.
        .. deprecated:: 0.24
           Legacy squaring behavior was deprecated in 0.24. The ``'legacy'``
           value will be removed in 1.1 (renaming of 0.26), at which point the
           default value will change to ``True``.

    Attributes
    ----------
    embedding_ : array-like of shape (n_samples, n_components)
        Stores the embedding vectors.

    kl_divergence_ : float
        Kullback-Leibler divergence after optimization.

    n_iter_ : int
        Number of iterations run.

    Examples
    --------

    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.manifold import TSNE
    &gt;&gt;&gt; X = np.array([[0, 0, 0], [0, 1, 1], [1, 0, 1], [1, 1, 1]])
    &gt;&gt;&gt; X_embedded = TSNE(n_components=2, learning_rate='auto',
    ...                   init='random').fit_transform(X)
    &gt;&gt;&gt; X_embedded.shape
    (4, 2)

    References
    ----------

    [1] van der Maaten, L.J.P.; Hinton, G.E. Visualizing High-Dimensional Data
        Using t-SNE. Journal of Machine Learning Research 9:2579-2605, 2008.

    [2] van der Maaten, L.J.P. t-Distributed Stochastic Neighbor Embedding
        https://lvdmaaten.github.io/tsne/

    [3] L.J.P. van der Maaten. Accelerating t-SNE using Tree-Based Algorithms.
        Journal of Machine Learning Research 15(Oct):3221-3245, 2014.
        https://lvdmaaten.github.io/publications/papers/JMLR_2014.pdf

    [4] Belkina, A. C., Ciccolella, C. O., Anno, R., Halpert, R., Spidlen, J.,
        & Snyder-Cappione, J. E. (2019). Automated optimized parameters for
        T-distributed stochastic neighbor embedding improve visualization
        and analysis of large datasets. Nature Communications, 10(1), 1-12.

    [5] Kobak, D., & Berens, P. (2019). The art of using t-SNE for single-cell
        transcriptomics. Nature Communications, 10(1), 1-14.
    """</span>
    <span class="comment"># Control the number of exploration iterations with early_exaggeration on</span>
    <span class="identifier">_EXPLORATION_N_ITER</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">250</span>

    <span class="comment"># Control the number of iterations between progress checks</span>
    <span class="identifier">_N_ITER_CHECK</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">perplexity</span><span class="arithmetic-assignment">=</span><span class="float-literal">30.0</span><span class="punctuation">,</span>
                 <span class="identifier">early_exaggeration</span><span class="arithmetic-assignment">=</span><span class="float-literal">12.0</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"warn"</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                 <span class="identifier">n_iter_without_progress</span><span class="arithmetic-assignment">=</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="identifier">min_grad_norm</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-7</span><span class="punctuation">,</span>
                 <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="string-literal">"euclidean", init="warn"</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'barnes_hut'</span><span class="punctuation">,</span> <span class="identifier">angle</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">square_distances</span><span class="arithmetic-assignment">=</span><span class="string-literal">'legacy'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">perplexity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">perplexity</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">early_exaggeration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">early_exaggeration</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">learning_rate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">learning_rate</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_without_progress</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_iter_without_progress</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_grad_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min_grad_norm</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metric</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">init</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">verbose</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">method</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">angle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">angle</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_jobs</span>
        <span class="comment"># TODO Revisit deprecation of square_distances for 1.1-1.3 (#12401)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">square_distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">square_distances</span>

    <span class="keyword">def</span> <span class="identifier">_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">skip_num_points</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Private function to fit the model using X as training data."""</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'warn'</span><span class="punctuation">:</span>
            <span class="comment"># See issue #18018</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"The default initialization in TSNE will change "</span>
                          <span class="string-literal">"from 'random' to 'pca' in 1.2."</span><span class="punctuation">,</span> <span class="identifier">FutureWarning</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'random'</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">learning_rate</span> <span class="relational-operator">==</span> <span class="string-literal">'warn'</span><span class="punctuation">:</span>
            <span class="comment"># See issue #18018</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"The default learning rate in TSNE will change "</span>
                          <span class="string-literal">"from 200.0 to 'auto' in 1.2."</span><span class="punctuation">,</span> <span class="identifier">FutureWarning</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">200.0</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">learning_rate</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span> <span class="relational-operator">==</span> <span class="string-literal">'pca'</span> <span class="logical-operator">and</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">"PCA initialization is currently not suported "</span>
                            <span class="string-literal">"with the sparse input matrix. Use "</span>
                            <span class="string-literal">"init=\"random\" instead."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'barnes_hut', 'exact'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"'method' must be 'barnes_hut' or 'exact'"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">angle</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.0</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">angle</span> <span class="relational-operator">&gt;</span> <span class="float-literal">1.0</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"'angle' must be between 0.0 - 1.0"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">square_distances</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="string-literal">'legacy'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"'square_distances' must be True or 'legacy'."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span> <span class="relational-operator">==</span> <span class="string-literal">'auto'</span><span class="punctuation">:</span>
            <span class="comment"># See issue #18018</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">early_exaggeration</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"'learning_rate' must be a positive number "</span>
                                 <span class="string-literal">"or 'auto'."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="relational-operator">!=</span> <span class="string-literal">"euclidean"</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">square_distances</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span>
                <span class="string-literal">"'square_distances' has been introduced in 0.24 to help phase "</span>
                <span class="string-literal">"out legacy squaring behavior. The 'legacy' setting will be "</span>
                <span class="string-literal">"removed in 1.1 (renaming of 0.26), and the default setting "</span>
                <span class="string-literal">"will be changed to True. In 1.3, 'square_distances' will be "</span>
                <span class="string-literal">"removed altogether, and distances will be squared by "</span>
                <span class="string-literal">"default. Set 'square_distances'=True to silence this "</span>
                <span class="string-literal">"warning."</span><span class="punctuation">,</span>
                <span class="identifier">FutureWarning</span>
            <span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'barnes_hut'</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'csr'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">ensure_min_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                    <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'csr', 'csc', 'coo'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"precomputed"</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span> <span class="relational-operator">==</span> <span class="string-literal">'pca'</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"The parameter init=\"pca\" cannot be "</span>
                                 <span class="string-literal">"used with metric=\"precomputed\"."</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"X should be a square distance matrix"</span><span class="grouping">)</span>

            <span class="identifier">check_non_negative</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="string-literal">"TSNE.fit(). With metric='precomputed', X "</span>
                                  <span class="string-literal">"should contain positive distances."</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">"exact"</span> <span class="logical-operator">and</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span>
                    <span class="string-literal">'TSNE with method="exact" does not accept sparse '</span>
                    <span class="string-literal">'precomputed distance matrix. Use method="barnes_hut" '</span>
                    <span class="string-literal">'or provide the dense distance matrix.'</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'barnes_hut'</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">&gt;</span> <span class="int-literal">3</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"'n_components' should be inferior to 4 for the "</span>
                             <span class="string-literal">"barnes_hut algorithm as it relies on "</span>
                             <span class="string-literal">"quad-tree or oct-tree."</span><span class="grouping">)</span>
        <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">early_exaggeration</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1.0</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"early_exaggeration must be at least 1, but is {}"</span>
                             <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">early_exaggeration</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span> <span class="relational-operator">&lt;</span> <span class="int-literal">250</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"n_iter should be at least 250"</span><span class="grouping">)</span>

        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

        <span class="identifier">neighbors_nn</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">"exact"</span><span class="punctuation">:</span>
            <span class="comment"># Retrieve the distance matrix, either using the precomputed one or</span>
            <span class="comment"># computing it.</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"precomputed"</span><span class="punctuation">:</span>
                <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Computing pairwise distances..."</span><span class="grouping">)</span>

                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"euclidean"</span><span class="punctuation">:</span>
                    <span class="comment"># Euclidean is squared here, rather than using **= 2,</span>
                    <span class="comment"># because euclidean_distances already calculates</span>
                    <span class="comment"># squared distances, and returns np.sqrt(dist) for</span>
                    <span class="comment"># squared=False.</span>
                    <span class="comment"># Also, Euclidean is slower for n_jobs&gt;1, so don't set here</span>
                    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span><span class="punctuation">,</span>
                                                   <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">distances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span><span class="punctuation">,</span>
                                                   <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">distances</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"All distances should be positive, the "</span>
                                 <span class="string-literal">"metric given is not correct"</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="relational-operator">!=</span> <span class="string-literal">"euclidean"</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">square_distances</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
                <span class="identifier">distances</span> <span class="arithmetic-assignment">**=</span> <span class="int-literal">2</span>

            <span class="comment"># compute the joint probability distribution for the input space</span>
            <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_joint_probabilities</span><span class="grouping">(</span><span class="identifier">distances</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">P</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"All probabilities should be finite"</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">P</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"All probabilities should be non-negative"</span>
            <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">P</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"All probabilities should be less "</span>
                                    <span class="string-literal">"or then equal to one"</span><span class="grouping">)</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># Compute the number of nearest neighbors to find.</span>
            <span class="comment"># LvdM uses 3 * perplexity as the number of neighbors.</span>
            <span class="comment"># In the event that we have very small # of points</span>
            <span class="comment"># set the neighbors to n - 1.</span>
            <span class="identifier">n_neighbors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">perplexity</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Computing {} nearest neighbors..."</span>
                      <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">n_neighbors</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># Find the nearest neighbors for every point</span>
            <span class="identifier">knn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NearestNeighbors</span><span class="grouping">(</span><span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span>
                                   <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span>
                                   <span class="identifier">n_neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">n_neighbors</span><span class="punctuation">,</span>
                                   <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span><span class="grouping">)</span>
            <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Indexed {} samples in {:.3f}s..."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">duration</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">distances_nn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">knn</span><span class="punctuation">.</span><span class="identifier">kneighbors_graph</span><span class="grouping">(</span><span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
            <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] Computed neighbors for {} samples "</span>
                      <span class="string-literal">"in {:.3f}s..."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">duration</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># Free the memory used by the ball_tree</span>
            <span class="keyword">del</span> <span class="identifier">knn</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">square_distances</span> <span class="relational-operator">is</span> <span class="bool-literal">True</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">metric</span> <span class="relational-operator">==</span> <span class="string-literal">"euclidean"</span><span class="punctuation">:</span>
                <span class="comment"># knn return the euclidean distance but we need it squared</span>
                <span class="comment"># to be consistent with the 'exact' method. Note that the</span>
                <span class="comment"># the method was derived using the euclidean method as in the</span>
                <span class="comment"># input space. Not sure of the implication of using a different</span>
                <span class="comment"># metric.</span>
                <span class="identifier">distances_nn</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">**=</span> <span class="int-literal">2</span>

            <span class="comment"># compute the joint probability distribution for the input space</span>
            <span class="identifier">P</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_joint_probabilities_nn</span><span class="grouping">(</span><span class="identifier">distances_nn</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">perplexity</span><span class="punctuation">,</span>
                                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span> <span class="relational-operator">==</span> <span class="string-literal">'pca'</span><span class="punctuation">:</span>
            <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'randomized'</span><span class="punctuation">,</span>
                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
            <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="comment"># TODO: Update in 1.2</span>
            <span class="comment"># PCA is rescaled so that PC1 has standard deviation 1e-4 which is</span>
            <span class="comment"># the default value for random initialization. See issue #18018.</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"The PCA initialization in TSNE will change to "</span>
                          <span class="string-literal">"have the standard deviation of PC1 equal to 1e-4 "</span>
                          <span class="string-literal">"in 1.2. This will ensure better convergence."</span><span class="punctuation">,</span>
                          <span class="identifier">FutureWarning</span><span class="grouping">)</span>
            <span class="comment"># X_embedded = X_embedded / np.std(X_embedded[:, 0]) * 1e-4</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_init</span> <span class="relational-operator">==</span> <span class="string-literal">'random'</span><span class="punctuation">:</span>
            <span class="comment"># The embedding is initialized with iid samples from Gaussians with</span>
            <span class="comment"># standard deviation 1e-4.</span>
            <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-4</span> <span class="arithmetic-operator">*</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span>
                <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"'init' must be 'pca', 'random', or "</span>
                             <span class="string-literal">"a numpy array"</span><span class="grouping">)</span>

        <span class="comment"># Degrees of freedom of the Student's t-distribution. The suggestion</span>
        <span class="comment"># degrees_of_freedom = n_components - 1 comes from</span>
        <span class="comment"># "Learning a Parametric Embedding by Preserving Local Structure"</span>
        <span class="comment"># Laurens van der Maaten, 2009.</span>
        <span class="identifier">degrees_of_freedom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tsne</span><span class="grouping">(</span><span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span>
                          <span class="identifier">X_embedded</span><span class="arithmetic-assignment">=</span><span class="identifier">X_embedded</span><span class="punctuation">,</span>
                          <span class="identifier">neighbors</span><span class="arithmetic-assignment">=</span><span class="identifier">neighbors_nn</span><span class="punctuation">,</span>
                          <span class="identifier">skip_num_points</span><span class="arithmetic-assignment">=</span><span class="identifier">skip_num_points</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_tsne</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">X_embedded</span><span class="punctuation">,</span>
              <span class="identifier">neighbors</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">skip_num_points</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Runs t-SNE."""</span>
        <span class="comment"># t-SNE minimizes the Kullback-Leiber divergence of the Gaussians P</span>
        <span class="comment"># and the Student's t-distributions Q. The optimization algorithm that</span>
        <span class="comment"># we use is batch gradient descent with two stages:</span>
        <span class="comment"># * initial optimization with early exaggeration and momentum at 0.5</span>
        <span class="comment"># * final optimization with momentum at 0.8</span>
        <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_embedded</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">opt_args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">"it"</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="punctuation">,</span>
            <span class="string-literal">"n_iter_check"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_N_ITER_CHECK</span><span class="punctuation">,</span>
            <span class="string-literal">"min_grad_norm"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">min_grad_norm</span><span class="punctuation">,</span>
            <span class="string-literal">"learning_rate"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_learning_rate</span><span class="punctuation">,</span>
            <span class="string-literal">"verbose"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span>
            <span class="string-literal">"kwargs"</span><span class="punctuation">:</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">skip_num_points</span><span class="arithmetic-assignment">=</span><span class="identifier">skip_num_points</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"args"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="identifier">P</span><span class="punctuation">,</span> <span class="identifier">degrees_of_freedom</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="string-literal">"n_iter_without_progress"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_EXPLORATION_N_ITER</span><span class="punctuation">,</span>
            <span class="string-literal">"n_iter"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_EXPLORATION_N_ITER</span><span class="punctuation">,</span>
            <span class="string-literal">"momentum"</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span>
        <span class="grouping">}</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'barnes_hut'</span><span class="punctuation">:</span>
            <span class="identifier">obj_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_kl_divergence_bh</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'kwargs']['angle'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">angle</span>
            <span class="comment"># Repeat verbose argument for _kl_divergence_bh</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'kwargs']['verbose'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span>
            <span class="comment"># Get the number of threads for gradient computation here to</span>
            <span class="comment"># avoid recomputing it at each iteration.</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'kwargs']['num_threads'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_openmp_effective_n_threads</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">obj_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_kl_divergence</span>

        <span class="comment"># Learning schedule (part 1): do 250 iteration with lower momentum but</span>
        <span class="comment"># higher learning rate controlled via the early exaggeration parameter</span>
        <span class="identifier">P</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">early_exaggeration</span>
        <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">kl_divergence</span><span class="punctuation">,</span> <span class="identifier">it</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_gradient_descent</span><span class="grouping">(</span><span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span>
                                                      <span class="arithmetic-operator">**</span><span class="identifier">opt_args</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] KL divergence after %d iterations with early "</span>
                  <span class="string-literal">"exaggeration: %f"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">it</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">kl_divergence</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Learning schedule (part 2): disable early exaggeration and finish</span>
        <span class="comment"># optimization with a higher momentum at 0.8</span>
        <span class="identifier">P</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">early_exaggeration</span>
        <span class="identifier">remaining</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_EXPLORATION_N_ITER</span>
        <span class="keyword">if</span> <span class="identifier">it</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_EXPLORATION_N_ITER</span> <span class="logical-operator">or</span> <span class="identifier">remaining</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'n_iter'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'it'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">it</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'momentum'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.8</span>
            <span class="identifier">opt_args</span><span class="grouping">[</span><span class="string-literal">'n_iter_without_progress'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_without_progress</span>
            <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">kl_divergence</span><span class="punctuation">,</span> <span class="identifier">it</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_gradient_descent</span><span class="grouping">(</span><span class="identifier">obj_func</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span>
                                                          <span class="arithmetic-operator">**</span><span class="identifier">opt_args</span><span class="grouping">)</span>

        <span class="comment"># Save the final number of iterations</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">it</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[t-SNE] KL divergence after %d iterations: %f"</span>
                  <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">it</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">kl_divergence</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kl_divergence_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kl_divergence</span>

        <span class="keyword">return</span> <span class="identifier">X_embedded</span>

    <span class="keyword">def</span> <span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit X into an embedded space and return that transformed
        output.

        Parameters
        ----------
        X : ndarray of shape (n_samples, n_features) or (n_samples, n_samples)
            If the metric is 'precomputed' X must be a square distance
            matrix. Otherwise it contains a sample per row. If the method
            is 'exact', X may be a sparse matrix of type 'csr', 'csc'
            or 'coo'. If the method is 'barnes_hut' and the metric is
            'precomputed', X may be a precomputed sparse graph.

        y : Ignored

        Returns
        -------
        X_new : ndarray of shape (n_samples, n_components)
            Embedding of the training data in low-dimensional space.
        """</span>
        <span class="identifier">embedding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">embedding_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">embedding</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">embedding_</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit X into an embedded space.

        Parameters
        ----------
        X : ndarray of shape (n_samples, n_features) or (n_samples, n_samples)
            If the metric is 'precomputed' X must be a square distance
            matrix. Otherwise it contains a sample per row. If the method
            is 'exact', X may be a sparse matrix of type 'csr', 'csc'
            or 'coo'. If the method is 'barnes_hut' and the metric is
            'precomputed', X may be a precomputed sparse graph.

        y : Ignored
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    </pre>
  </body>
</html>