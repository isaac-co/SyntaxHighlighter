<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">_IS_32BIT</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">datasets</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_squared_error</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">make_scorer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">get_scorer</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">ridge_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Ridge</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">_ridge</span> <span class="keyword">import</span> <span class="identifier">_RidgeGCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">RidgeCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">RidgeClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">RidgeClassifierCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">_ridge</span> <span class="keyword">import</span> <span class="identifier">_solve_cholesky</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">_ridge</span> <span class="keyword">import</span> <span class="identifier">_solve_cholesky_kernel</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">_ridge</span> <span class="keyword">import</span> <span class="identifier">_check_gcv_mode</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">_ridge</span> <span class="keyword">import</span> <span class="identifier">_X_CenterStackOp</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">KFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GroupKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">cross_val_predict</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">LeaveOneOut</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">minmax_scale</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_multilabel_classification</span>

<span class="identifier">diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span>
<span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">ind</span><span class="grouping">)</span>
<span class="identifier">ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ind</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">200</span><span class="grouping">]</span>
<span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_diabetes</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">[</span><span class="identifier">ind</span><span class="grouping">]</span>

<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">X_iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
<span class="identifier">y_iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>


<span class="keyword">def</span> <span class="identifier">DENSE_FILTER</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">def</span> <span class="identifier">SPARSE_FILTER</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_accuracy_callable</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_test</span> <span class="relational-operator">==</span> <span class="identifier">y_pred</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_mean_squared_error_callable</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_test</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">"svd", "sparse_cg", "cholesky", "lsqr", "sag"</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ridge regression convergence test using score</span>
    <span class="comment"># TODO: for this test to be robust, we should use a dataset instead</span>
    <span class="comment"># of np.random.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="comment"># With more samples than features</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.47</span>

    <span class="keyword">if</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"cholesky", "sag"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Currently the only solvers to support sample_weight.</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.47</span>

    <span class="comment"># With more features than samples</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.9</span>

    <span class="keyword">if</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"cholesky", "sag"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Currently the only solvers to support sample_weight.</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.9</span>


<span class="keyword">def</span> <span class="identifier">test_primal_dual_relationship</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_diabetes</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_solve_cholesky</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1e-2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">dual_coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_solve_cholesky_kernel</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">1e-2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">coef2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">dual_coef</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">coef2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_singular</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test on a singular matrix</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.9</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_regression_sample_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"cholesky"</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">alpha</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1e-2</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
                <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
                <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>

                <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                         <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                                         <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="punctuation">,</span>
                                         <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>

                <span class="comment"># Sample weight can be implemented via a simple rescaling</span>
                <span class="comment"># for the square loss.</span>
                <span class="identifier">coefs2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_regression</span><span class="grouping">(</span>
                    <span class="identifier">X</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">y</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">coefs2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_regression_convergence_fail</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">warning_message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">r</span><span class="string-literal">"sparse_cg did not converge after"</span>
        <span class="identifier">r</span><span class="string-literal">" [0-9]+ iterations."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                         <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sparse_cg"</span><span class="punctuation">,</span>
                         <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_sample_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># TODO: loop over sparse data as well</span>
    <span class="comment"># Note: parametrizing this test with pytest results in failed</span>
    <span class="comment">#       assertions, meaning that is is not extremely robust</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1e-2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="string-literal">'svd', 'cholesky', 'lsqr', 'sparse_cg'</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">param_grid</span><span class="punctuation">:</span>

            <span class="comment"># Ridge with explicit sample_weight</span>
            <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">intercept</span><span class="punctuation">,</span>
                        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="grouping">)</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
            <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">coef_</span>
            <span class="identifier">inter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">intercept_</span>

            <span class="comment"># Closed form of the weighted regularized least square</span>
            <span class="comment"># theta = (X^T W X + alpha I)^(-1) * X^T W y</span>
            <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">intercept</span> <span class="relational-operator">is</span> <span class="bool-literal">False</span><span class="punctuation">:</span>
                <span class="identifier">X_aug</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span>
                <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">dummy_column</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">X_aug</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">dummy_column</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
                <span class="identifier">D</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
                <span class="identifier">D</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

            <span class="identifier">cf_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">solve</span><span class="grouping">(</span><span class="identifier">X_aug</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_aug</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="identifier">D</span><span class="punctuation">,</span>
                                    <span class="identifier">X_aug</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">intercept</span> <span class="relational-operator">is</span> <span class="bool-literal">False</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">cf_coefs</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">cf_coefs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">inter</span><span class="punctuation">,</span> <span class="identifier">cf_coefs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_shapes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test shape of coef_ and intercept_</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">Y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">y</span><span class="grouping">]</span>

    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_intercept</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test intercept with multiple targets GH issue #708</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="identifier">y</span><span class="grouping">]</span>

    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">intercept</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_toy_ridge_object</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test BayesianRegression ridge classifier</span>
    <span class="comment"># TODO: test also n_samples &gt; n_features</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_vs_lstsq</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># On alpha=0., Ridge and OLS yield the same solution.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># we need more samples than features</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">ols</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">ols</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">ols</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">ols</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_individual_penalties</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests the ridge object using individual penalties</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="grouping">)</span>

    <span class="identifier">penalties</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_targets</span><span class="grouping">)</span>

    <span class="identifier">coef_cholesky</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"cholesky"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span>
        <span class="keyword">for</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">target</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">penalties</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">coefs_indiv_pen</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">penalties</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-8</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span>
        <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'svd', 'sparse_cg', 'lsqr', 'cholesky', 'sag', 'saga'</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">coef_indiv_pen</span> <span class="relational-operator">in</span> <span class="identifier">coefs_indiv_pen</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">coef_cholesky</span><span class="punctuation">,</span> <span class="identifier">coef_indiv_pen</span><span class="grouping">)</span>

    <span class="comment"># Test error is raised when number of targets and penalties do not match.</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">penalties</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_col'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_X_CenterStackOp</span><span class="grouping">(</span><span class="identifier">n_col</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span>
    <span class="identifier">X_m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">8</span><span class="grouping">)</span>
    <span class="identifier">sqrt_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">n_col</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">n_col</span><span class="grouping">)</span>
    <span class="identifier">operator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_X_CenterStackOp</span><span class="grouping">(</span><span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">sqrt_sw</span><span class="grouping">)</span>
    <span class="identifier">reference_operator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">sqrt_sw</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_m</span><span class="punctuation">,</span> <span class="identifier">sqrt_sw</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">reference_operator</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">operator</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">reference_operator</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">operator</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'shape'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'uniform_weights'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_compute_gram</span><span class="grouping">(</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">uniform_weights</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">uniform_weights</span><span class="punctuation">:</span>
        <span class="identifier">sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">chisquare</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">sqrt_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">sw</span><span class="grouping">)</span>
    <span class="identifier">X_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">sw</span><span class="grouping">)</span>
    <span class="identifier">X_centered</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">X_mean</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">sqrt_sw</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">true_gram</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_centered</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_centered</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">*</span> <span class="identifier">sqrt_sw</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gcv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_RidgeGCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">computed_gram</span><span class="punctuation">,</span> <span class="identifier">computed_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gcv</span><span class="punctuation">.</span><span class="identifier">_compute_gram</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">sqrt_sw</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_mean</span><span class="punctuation">,</span> <span class="identifier">computed_mean</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">true_gram</span><span class="punctuation">,</span> <span class="identifier">computed_gram</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'shape'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'uniform_weights'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_compute_covariance</span><span class="grouping">(</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">uniform_weights</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">uniform_weights</span><span class="punctuation">:</span>
        <span class="identifier">sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">chisquare</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">sqrt_sw</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">sw</span><span class="grouping">)</span>
    <span class="identifier">X_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">sw</span><span class="grouping">)</span>
    <span class="identifier">X_centered</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">X_mean</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">sqrt_sw</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">true_covariance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_centered</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_centered</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">*</span> <span class="identifier">sqrt_sw</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">gcv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_RidgeGCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">computed_cov</span><span class="punctuation">,</span> <span class="identifier">computed_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gcv</span><span class="punctuation">.</span><span class="identifier">_compute_covariance</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">sqrt_sw</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_mean</span><span class="punctuation">,</span> <span class="identifier">computed_mean</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">true_covariance</span><span class="punctuation">,</span> <span class="identifier">computed_cov</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">proportion_nonzero</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="punctuation">,</span>
        <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">13</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">X_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">.</span><span class="punctuation">,</span>
        <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
        <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">n_informative</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="identifier">bias</span><span class="punctuation">,</span>
        <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="identifier">noise</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="identifier">shuffle</span><span class="punctuation">,</span>
        <span class="identifier">coef</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_features</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">c</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X_offset</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span>
        <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">proportion_nonzero</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
    <span class="identifier">removed_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">removed_X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">removed_X</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">c</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_features</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="identifier">c</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">coef</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">c</span>
    <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span>


<span class="comment"># FIXME: 'normalize' to be removed in 1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:'normalize' was deprecated"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'solver, sparse_X'</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">sparse_X</span><span class="grouping">)</span> <span class="keyword">for</span>
     <span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">sparse_X</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span>
         <span class="grouping">[</span><span class="string-literal">'cholesky', 'sag', 'sparse_cg', 'lsqr', 'saga', 'ridgecv'</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>
     <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">sparse_X</span> <span class="logical-operator">and</span> <span class="identifier">solver</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'sparse_cg', 'ridgecv'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'n_samples,dtype,proportion_nonzero'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="string-literal">'float32', .1), (40, 'float32', 1.), (20, 'float64'</span><span class="punctuation">,</span> <span class="float-literal">.2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'normalize'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_solver_consistency</span><span class="grouping">(</span>
        <span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">proportion_nonzero</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">sparse_X</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="punctuation">,</span>
        <span class="identifier">normalize</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="identifier">noise</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span><span class="punctuation">.</span> <span class="keyword">if</span> <span class="identifier">proportion_nonzero</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.9</span> <span class="keyword">else</span> <span class="int-literal">500</span><span class="punctuation">.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span>
        <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">proportion_nonzero</span><span class="arithmetic-assignment">=</span><span class="identifier">proportion_nonzero</span><span class="punctuation">,</span>
        <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="identifier">noise</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">normalize</span><span class="punctuation">:</span>
        <span class="comment"># Manually scale the data to avoid pathological cases. We use</span>
        <span class="comment"># minmax_scale to deal with the sparse case without breaking</span>
        <span class="comment"># the sparsity pattern.</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">minmax_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">svd_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span>
        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'svd'</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">normalize</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">sparse_X</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">solver</span> <span class="relational-operator">==</span> <span class="string-literal">'ridgecv'</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">alpha</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">normalize</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-10</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">normalize</span><span class="punctuation">,</span>
                      <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">svd_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">svd_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="comment"># FIXME: 'normalize' to be removed in 1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:'normalize' was deprecated"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gcv_mode', ['svd', 'eigen'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'X_constructor'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'X_shape'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'fit_intercept'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'y_shape, normalize, noise'</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">150</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_gcv_vs_ridge_loo_cv</span><span class="grouping">(</span>
        <span class="identifier">gcv_mode</span><span class="punctuation">,</span> <span class="identifier">X_constructor</span><span class="punctuation">,</span> <span class="identifier">X_shape</span><span class="punctuation">,</span> <span class="identifier">y_shape</span><span class="punctuation">,</span>
        <span class="identifier">fit_intercept</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_shape</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y_shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="keyword">else</span> <span class="int-literal">1</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="identifier">n_targets</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="identifier">noise</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span>
    <span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">y_shape</span><span class="grouping">)</span>

    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">]</span>
    <span class="identifier">loo_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span>
                        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span>
                        <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">normalize</span><span class="grouping">)</span>
    <span class="identifier">gcv_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">gcv_mode</span><span class="arithmetic-assignment">=</span><span class="identifier">gcv_mode</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span>
                        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">normalize</span><span class="grouping">)</span>

    <span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">X_gcv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_constructor</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_gcv</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_loo_cv_asym_scoring</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># checking on asymmetric scoring</span>
    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'explained_variance'</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="identifier">n_targets</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span>
    <span class="grouping">)</span>

    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">]</span>
    <span class="identifier">loo_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>

    <span class="identifier">gcv_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>

    <span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">loo_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gcv_mode', ['svd', 'eigen'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'X_constructor'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_features'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'y_shape, fit_intercept, noise'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="int-literal">150</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_gcv_sample_weights</span><span class="grouping">(</span>
        <span class="identifier">gcv_mode</span><span class="punctuation">,</span> <span class="identifier">X_constructor</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">y_shape</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1e3</span><span class="grouping">]</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y_shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="keyword">else</span> <span class="int-literal">1</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="arithmetic-assignment">=</span><span class="identifier">n_targets</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="identifier">noise</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">y_shape</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">sample_weight</span> <span class="arithmetic-operator">-</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span>
    <span class="identifier">X_tiled</span><span class="punctuation">,</span> <span class="identifier">y_tiled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span>

    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GroupKFold</span><span class="grouping">(</span><span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">splits</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X_tiled</span><span class="punctuation">,</span> <span class="identifier">y_tiled</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="identifier">indices</span><span class="grouping">)</span>
    <span class="identifier">kfold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span>
        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">splits</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span>
        <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span>
    <span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_tiled</span><span class="punctuation">,</span> <span class="identifier">y_tiled</span><span class="grouping">)</span>

    <span class="identifier">ridge_reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span>
    <span class="identifier">splits</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X_tiled</span><span class="punctuation">,</span> <span class="identifier">y_tiled</span><span class="punctuation">,</span> <span class="identifier">groups</span><span class="arithmetic-assignment">=</span><span class="identifier">indices</span><span class="grouping">)</span>
    <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cross_val_predict</span><span class="grouping">(</span><span class="identifier">ridge_reg</span><span class="punctuation">,</span> <span class="identifier">X_tiled</span><span class="punctuation">,</span> <span class="identifier">y_tiled</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">splits</span><span class="grouping">)</span>
    <span class="identifier">kfold_errors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y_tiled</span> <span class="arithmetic-operator">-</span> <span class="identifier">predictions</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span>
    <span class="identifier">kfold_errors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">kfold_errors</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">==</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">for</span>
        <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">kfold_errors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">kfold_errors</span><span class="grouping">)</span>

    <span class="identifier">X_gcv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_constructor</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">gcv_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span>
        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">gcv_mode</span><span class="arithmetic-assignment">=</span><span class="identifier">gcv_mode</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span>
    <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_gcv</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y_shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="identifier">gcv_errors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">gcv_errors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_errors</span><span class="punctuation">,</span> <span class="identifier">kfold_errors</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">gcv_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">kfold</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'mode', [True, 1, 5, 'bad', 'gcv'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_check_gcv_mode_error</span><span class="grouping">(</span><span class="identifier">mode</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">gcv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">gcv_mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Unknown value for 'gcv_mode'"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">gcv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Unknown value for 'gcv_mode'"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_check_gcv_mode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"sparse"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'mode, mode_n_greater_than_p, mode_p_greater_than_n'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'svd', 'eigen'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">'auto', 'svd', 'eigen'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">'eigen', 'eigen', 'eigen'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">'svd', 'svd', 'svd'</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_check_gcv_mode_choice</span><span class="grouping">(</span><span class="identifier">sparse</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="punctuation">,</span> <span class="identifier">mode_n_greater_than_p</span><span class="punctuation">,</span>
                               <span class="identifier">mode_p_greater_than_n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">_check_gcv_mode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">mode_n_greater_than_p</span>
    <span class="keyword">assert</span> <span class="identifier">_check_gcv_mode</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">mode_p_greater_than_n</span>


<span class="keyword">def</span> <span class="identifier">_test_ridge_loo</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that can work with both dense or sparse matrices</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">ret</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="identifier">fit_intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">filter_</span> <span class="relational-operator">==</span> <span class="identifier">DENSE_FILTER</span>
    <span class="identifier">ridge_gcv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_RidgeGCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span>

    <span class="comment"># check best alpha</span>
    <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">alpha_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">alpha_</span>
    <span class="identifier">ret</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span>

    <span class="comment"># check that we get same best alpha with custom loss_func</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ignore_warnings</span>
    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">mean_squared_error</span><span class="punctuation">,</span> <span class="identifier">greater_is_better</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ridge_gcv2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">ridge_gcv2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_gcv2</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span>

    <span class="comment"># check that we get same best alpha with custom score_func</span>
    <span class="keyword">def</span> <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="arithmetic-operator">-</span><span class="identifier">mean_squared_error</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">func</span><span class="grouping">)</span>
    <span class="identifier">ridge_gcv3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">ridge_gcv3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_gcv3</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span>

    <span class="comment"># check that we get same best alpha with a scorer</span>
    <span class="identifier">scorer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_scorer</span><span class="grouping">(</span><span class="string-literal">'neg_mean_squared_error'</span><span class="grouping">)</span>
    <span class="identifier">ridge_gcv4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scorer</span><span class="grouping">)</span>
    <span class="identifier">ridge_gcv4</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_gcv4</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span>

    <span class="comment"># check that we get same best alpha with sample weights</span>
    <span class="keyword">if</span> <span class="identifier">filter_</span> <span class="relational-operator">==</span> <span class="identifier">DENSE_FILTER</span><span class="punctuation">:</span>
        <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="punctuation">,</span>
                      <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span>

    <span class="comment"># simulate several responses</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">Y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_gcv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span>
                    <span class="identifier">Y_pred</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">ret</span>


<span class="comment"># FIXME: 'normalize' to be removed in 1.2</span>
<span class="keyword">def</span> <span class="identifier">_test_ridge_cv_normalize</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>

    <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'sparse_cg'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                      <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alphas</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="relational-operator">==</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span>


<span class="keyword">def</span> <span class="identifier">_test_ridge_cv</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
    <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"ridge, make_dataset"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">make_regression</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">make_classification</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_gcv_cv_values_not_stored</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">,</span> <span class="identifier">make_dataset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that `cv_values_` is not stored when store_cv_values is False</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_dataset</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">,</span> <span class="string-literal">"cv_values_"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"ridge, make_dataset"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">make_regression</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">make_classification</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"cv"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_best_score</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">,</span> <span class="identifier">make_dataset</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that the best_score_ is store</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_dataset</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">,</span> <span class="string-literal">"best_score_"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="punctuation">,</span> <span class="identifier">float</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_cv_individual_penalties</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests the ridge_cv object optimizing individual penalties for each target</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="comment"># Create random dataset with multiple targets. Each target should have</span>
    <span class="comment"># a different optimal alpha.</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
         <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="float-literal">0.05</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
         <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="float-literal">0.001</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
         <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span>

    <span class="comment"># Find optimal alpha for each target</span>
    <span class="identifier">optimal_alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">alpha_</span>
                      <span class="keyword">for</span> <span class="identifier">target</span> <span class="relational-operator">in</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">]</span>

    <span class="comment"># Find optimal alphas for all targets simultaneously</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">optimal_alphas</span><span class="punctuation">,</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>

    <span class="comment"># The resulting regression weights should incorporate the different</span>
    <span class="comment"># alpha values.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                              <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="comment"># Test shape of alpha_ and cv_values_</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                       <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="grouping">)</span>

    <span class="comment"># Test edge case of there being only one alpha value</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                       <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Test edge case of there being only one target</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                       <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isscalar</span><span class="grouping">(</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isscalar</span><span class="grouping">(</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">best_score_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Try with a custom scoring function</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                       <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'r2'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">optimal_alphas</span><span class="punctuation">,</span> <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                              <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="comment"># Using a custom CV object should throw an error in combination with</span>
    <span class="comment"># alpha_per_target=True</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">LeaveOneOut</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"cv!=None and alpha_per_target=True are incompatible"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">ridge_cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">alpha_per_target</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge_cv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_test_ridge_diabetes</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_test_multi_ridge_diabetes</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># simulate several responses</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">Y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span>
                              <span class="identifier">Y_pred</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_test_ridge_classifiers</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y_iris</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_iris</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">reg</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_iris</span> <span class="relational-operator">==</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">.79</span>

    <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_iris</span> <span class="relational-operator">==</span> <span class="identifier">y_pred</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">0.8</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"scoring", [None, "accuracy"</span><span class="punctuation">,</span> <span class="identifier">_accuracy_callable</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"cv"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"filter_"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">DENSE_FILTER</span><span class="punctuation">,</span> <span class="identifier">SPARSE_FILTER</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_classifier_with_scoring</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># non-regression test for #14672</span>
    <span class="comment"># check that RidgeClassifierCV works with all sort of scoring and</span>
    <span class="comment"># cross-validation</span>
    <span class="identifier">scoring_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">scoring</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring_</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
    <span class="comment"># Smoke test to check that fit/predict does not raise error</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"cv"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"filter_"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">DENSE_FILTER</span><span class="punctuation">,</span> <span class="identifier">SPARSE_FILTER</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_regression_custom_scoring</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that custom scoring is working as expected</span>
    <span class="comment"># check the tie breaking strategy (keep the first alpha tried)</span>

    <span class="keyword">def</span> <span class="identifier">_dummy_score</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="float-literal">0.42</span>

    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span>
        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">_dummy_score</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span>
    <span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_iris</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_iris</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="float-literal">0.42</span><span class="grouping">)</span>
    <span class="comment"># In case of tie score, the first alphas will be kept</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_test_tolerance</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>

    <span class="identifier">ridge2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">ridge2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">filter_</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;=</span> <span class="identifier">score2</span>


<span class="keyword">def</span> <span class="identifier">check_dense_sparse</span><span class="grouping">(</span><span class="identifier">test_func</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test dense matrix</span>
    <span class="identifier">ret_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">test_func</span><span class="grouping">(</span><span class="identifier">DENSE_FILTER</span><span class="grouping">)</span>
    <span class="comment"># test sparse matrix</span>
    <span class="identifier">ret_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">test_func</span><span class="grouping">(</span><span class="identifier">SPARSE_FILTER</span><span class="grouping">)</span>
    <span class="comment"># test that the outputs are the same</span>
    <span class="keyword">if</span> <span class="identifier">ret_dense</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">ret_sparse</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ret_dense</span><span class="punctuation">,</span> <span class="identifier">ret_sparse</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>


<span class="comment"># FIXME: 'normalize' to be removed in 1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:'normalize' was deprecated"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'test_func'</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="identifier">_test_ridge_loo</span><span class="punctuation">,</span> <span class="identifier">_test_ridge_cv</span><span class="punctuation">,</span> <span class="identifier">_test_ridge_cv_normalize</span><span class="punctuation">,</span>
         <span class="identifier">_test_ridge_diabetes</span><span class="punctuation">,</span> <span class="identifier">_test_multi_ridge_diabetes</span><span class="punctuation">,</span>
         <span class="identifier">_test_ridge_classifiers</span><span class="punctuation">,</span> <span class="identifier">_test_tolerance</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_dense_sparse</span><span class="grouping">(</span><span class="identifier">test_func</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_dense_sparse</span><span class="grouping">(</span><span class="identifier">test_func</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_sparse_svd</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'svd'</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_class_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test class weights.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># we give a small weights to class 1</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.001</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># now the hyperplane should rotate clock-wise and</span>
    <span class="comment"># the prediction on this point should shift</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check if class_weight = 'balanced' can handle negative labels.</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># class_weight = 'balanced', and class_weight = None should return</span>
    <span class="comment"># same values when y has equal number of all labels</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">rega</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="grouping">)</span>
    <span class="identifier">rega</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">rega</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rega</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">rega</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'reg'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">RidgeClassifier</span><span class="punctuation">,</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weight_vs_sample_weight</span><span class="grouping">(</span><span class="identifier">reg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check class_weights resemble sample_weights behavior."""</span>

    <span class="comment"># Iris is balanced, so no effect expected for using 'balanced' weights</span>
    <span class="identifier">reg1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">reg1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">reg2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="grouping">)</span>
    <span class="identifier">reg2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">reg2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="comment"># Inflate importance of class 1, check against user-defined weights</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">100</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">100</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span>
    <span class="identifier">reg1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">reg1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">reg2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="grouping">)</span>
    <span class="identifier">reg2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">reg2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="comment"># Check that sample_weight and class_weight are multiplicative</span>
    <span class="identifier">reg1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">reg1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">reg2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="grouping">)</span>
    <span class="identifier">reg2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">reg2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_class_weights_cv</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test class weights for cross validated ridge classifier.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">.01</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># we give a small weights to class 1</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.001</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">.01</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-.2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"scoring"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'neg_mean_squared_error'</span><span class="punctuation">,</span> <span class="identifier">_mean_squared_error_callable</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridgecv_store_cv_values</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e-1</span><span class="punctuation">,</span> <span class="float-literal">1e0</span><span class="punctuation">,</span> <span class="float-literal">1e1</span><span class="grouping">]</span>
    <span class="identifier">n_alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="grouping">)</span>

    <span class="identifier">scoring_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">scoring</span>

    <span class="identifier">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring_</span><span class="grouping">)</span>

    <span class="comment"># with len(y.shape) == 1</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_alphas</span><span class="grouping">)</span>

    <span class="comment"># with len(y.shape) == 2</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="grouping">)</span>
    <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="identifier">n_alphas</span><span class="grouping">)</span>

    <span class="identifier">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cv!=None and store_cv_values'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"scoring"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'accuracy'</span><span class="punctuation">,</span> <span class="identifier">_accuracy_callable</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_classifier_cv_store_cv_values</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e-1</span><span class="punctuation">,</span> <span class="float-literal">1e0</span><span class="punctuation">,</span> <span class="float-literal">1e1</span><span class="grouping">]</span>
    <span class="identifier">n_alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="grouping">)</span>

    <span class="identifier">scoring_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_scorer</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">scoring</span>

    <span class="identifier">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeClassifierCV</span><span class="grouping">(</span>
        <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">store_cv_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="identifier">scoring_</span>
    <span class="grouping">)</span>

    <span class="comment"># with len(y.shape) == 1</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="identifier">n_alphas</span><span class="grouping">)</span>

    <span class="comment"># with len(y.shape) == 2</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">cv_values_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="identifier">n_alphas</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridgecv_sample_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">10.0</span><span class="grouping">)</span>

    <span class="comment"># There are different algorithms for n_samples &gt; n_features</span>
    <span class="comment"># and the opposite, so test them both.</span>
    <span class="keyword">for</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>

        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KFold</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
        <span class="identifier">ridgecv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="identifier">ridgecv</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>

        <span class="comment"># Check using GridSearchCV directly</span>
        <span class="identifier">parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="identifier">alphas</span><span class="grouping">}</span>
        <span class="identifier">gs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">parameters</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="grouping">)</span>
        <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">ridgecv</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="relational-operator">==</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">alpha</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ridgecv</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">gs</span><span class="punctuation">.</span><span class="identifier">best_estimator_</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_raises_value_error_if_sample_weights_greater_than_1d</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sample weights must be either scalar or 1D</span>

    <span class="identifier">n_sampless</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">n_featuress</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">n_sampless</span><span class="punctuation">,</span> <span class="identifier">n_featuress</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="identifier">sample_weights_OK</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">sample_weights_OK_1</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
        <span class="identifier">sample_weights_OK_2</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="punctuation">.</span>
        <span class="identifier">sample_weights_not_OK</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weights_OK</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
        <span class="identifier">sample_weights_not_OK_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weights_OK</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>

        <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="comment"># make sure the "OK" sample weights actually work</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weights_OK</span><span class="grouping">)</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weights_OK_1</span><span class="grouping">)</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weights_OK_2</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">fit_ridge_not_ok</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weights_not_OK</span><span class="grouping">)</span>

        <span class="keyword">def</span> <span class="identifier">fit_ridge_not_ok_2</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weights_not_OK_2</span><span class="grouping">)</span>

        <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Sample weights must be 1D array or scalar"</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">fit_ridge_not_ok</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Sample weights must be 1D array or scalar"</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">fit_ridge_not_ok_2</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sparse_design_with_sample_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Sample weights must work with sparse matrices</span>

    <span class="identifier">n_sampless</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">n_featuress</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">sparse_matrix_converters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="punctuation">,</span>
                                <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span>
                                <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="punctuation">,</span>
                                <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="punctuation">,</span>
                                <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">dok_matrix</span>
                                <span class="grouping">]</span>

    <span class="identifier">sparse_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">dense_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">n_sampless</span><span class="punctuation">,</span> <span class="identifier">n_featuress</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
        <span class="identifier">sample_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">for</span> <span class="identifier">sparse_converter</span> <span class="relational-operator">in</span> <span class="identifier">sparse_matrix_converters</span><span class="punctuation">:</span>
            <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_converter</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weights</span><span class="grouping">)</span>
            <span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weights</span><span class="grouping">)</span>

            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                                      <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridgecv_int_alphas</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># Integers</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridgecv_negative_alphas</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># Negative integers</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"alphas must be strictly positive"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Negative floats</span>
    <span class="identifier">ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RidgeCV</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">-0.1</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-10.0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"alphas must be strictly positive"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_raises_value_error_if_solver_not_supported</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests whether a ValueError is raised if a non-identified solver</span>
    <span class="comment"># is passed to ridge_regression</span>

    <span class="identifier">wrong_solver</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This is not a solver (MagritteSolveCV QuantumBitcoin)"</span>

    <span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ValueError</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Known solvers are 'sparse_cg', 'cholesky', 'svd'"</span>
               <span class="string-literal">" 'lsqr', 'sag' or 'saga'. Got %s."</span> <span class="arithmetic-operator">%</span> <span class="identifier">wrong_solver</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">func</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">ridge_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">wrong_solver</span><span class="grouping">)</span>

        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">func</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sparse_cg_max_iter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sparse_cg"</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X_diabetes</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_n_iter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that self.n_iter_ is correct.</span>
    <span class="identifier">n_targets</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_diabetes</span><span class="punctuation">,</span> <span class="identifier">y_diabetes</span>
    <span class="identifier">y_n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_targets</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="keyword">for</span> <span class="identifier">max_iter</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'sag', 'saga', 'lsqr'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-12</span><span class="grouping">)</span>
            <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_n</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">n_iter_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">n_targets</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'sparse_cg', 'svd', 'cholesky'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="grouping">)</span>
        <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_n</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ['sparse_cg', 'auto'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_fit_intercept_sparse</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># for now only sparse_cg can correctly fit an intercept with sparse X with</span>
    <span class="comment"># default tol and max_iter.</span>
    <span class="comment"># sag is tested separately in test_ridge_fit_intercept_sparse_sag</span>
    <span class="comment"># because it requires more iterations and should raise a warning if default</span>
    <span class="comment"># max_iter is used.</span>
    <span class="comment"># other solvers raise an exception, as checked in</span>
    <span class="comment"># test_ridge_fit_intercept_sparse_error</span>
    <span class="comment">#</span>
    <span class="comment"># "auto" should switch to "sparse_cg" when X is sparse</span>
    <span class="comment"># so the reference we use for both ("auto" and "sparse_cg") is</span>
    <span class="comment"># Ridge(solver="sparse_cg"), fitted using the dense representation (note</span>
    <span class="comment"># that "sparse_cg" can fit sparse or dense data)</span>
    <span class="identifier">dense_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'sparse_cg'</span><span class="grouping">)</span>
    <span class="identifier">sparse_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">record</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ['saga', 'lsqr', 'svd', 'cholesky'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_fit_intercept_sparse_error</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">sparse_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"solver='{}' does not support"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_fit_intercept_sparse_sag</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_sparse_offset_regression</span><span class="grouping">(</span>
        <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">X_offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">.</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'sag'</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                  <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-10</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100000</span><span class="grouping">)</span>
    <span class="identifier">dense_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
    <span class="identifier">sparse_ridge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
    <span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">record</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span>
                       <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">dense_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">sparse_ridge</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">'"sag" solver requires.*'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'sag'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'return_intercept'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'sample_weight'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'arr_type'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ['auto', 'sparse_cg', 'cholesky', 'lsqr'</span><span class="punctuation">,</span>
                                    <span class="string-literal">'sag', 'saga'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_regression_check_arguments_validity</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="punctuation">,</span>
                                                   <span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">arr_type</span><span class="punctuation">,</span>
                                                   <span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""check if all combinations of arguments give valid estimations"""</span>

    <span class="comment"># test excludes 'svd' solver because it raises exception for sparse inputs</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">true_coefs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">true_coefs</span><span class="grouping">)</span>
    <span class="identifier">true_intercept</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="punctuation">:</span>
        <span class="identifier">true_intercept</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10000</span><span class="punctuation">.</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">true_intercept</span>
    <span class="identifier">X_testing</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr_type</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="float-literal">1e-6</span>
    <span class="identifier">atol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span> <span class="keyword">if</span> <span class="identifier">_IS_32BIT</span> <span class="keyword">else</span> <span class="float-literal">1e-4</span>

    <span class="keyword">if</span> <span class="identifier">solver</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'sag', 'auto'</span><span class="grouping">]</span> <span class="logical-operator">and</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"In Ridge, only 'sag' solver"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ridge_regression</span><span class="grouping">(</span><span class="identifier">X_testing</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                             <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                             <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                             <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="punctuation">,</span>
                             <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="punctuation">,</span>
                             <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="grouping">)</span>
        <span class="keyword">return</span>

    <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_regression</span><span class="grouping">(</span><span class="identifier">X_testing</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                           <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                           <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="punctuation">,</span>
                           <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="punctuation">,</span>
                           <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
                           <span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="punctuation">:</span>
        <span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">true_coefs</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="identifier">atol</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">intercept</span><span class="punctuation">,</span> <span class="identifier">true_intercept</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="identifier">atol</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="identifier">true_coefs</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="identifier">atol</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_classifier_no_support_multilabel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_multilabel_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">RidgeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"solver", ["svd", "sparse_cg", "cholesky", "lsqr", "sag", "saga"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_dtype_match</span><span class="grouping">(</span><span class="identifier">solver</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">X_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">X_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_64</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">y_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_64</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

    <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">resolution</span>
    <span class="comment"># Check type consistency 32bits</span>
    <span class="identifier">ridge_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="grouping">)</span>
    <span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_32</span><span class="punctuation">,</span> <span class="identifier">y_32</span><span class="grouping">)</span>
    <span class="identifier">coef_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="comment"># Check type consistency 64 bits</span>
    <span class="identifier">ridge_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="grouping">)</span>
    <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_64</span><span class="punctuation">,</span> <span class="identifier">y_64</span><span class="grouping">)</span>
    <span class="identifier">coef_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="comment"># Do the actual checks at once for easier debug</span>
    <span class="keyword">assert</span> <span class="identifier">coef_32</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_32</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">coef_64</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_64</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_32</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_64</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">5e-4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dtype_match_cholesky</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test different alphas in cholesky solver to ensure full coverage.</span>
    <span class="comment"># This test is separated from test_dtype_match for clarity.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_target</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_target</span><span class="grouping">)</span>
    <span class="identifier">X_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_64</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">y_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_64</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

    <span class="comment"># Check type consistency 32bits</span>
    <span class="identifier">ridge_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cholesky'</span><span class="grouping">)</span>
    <span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_32</span><span class="punctuation">,</span> <span class="identifier">y_32</span><span class="grouping">)</span>
    <span class="identifier">coef_32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="comment"># Check type consistency 64 bits</span>
    <span class="identifier">ridge_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cholesky'</span><span class="grouping">)</span>
    <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_64</span><span class="punctuation">,</span> <span class="identifier">y_64</span><span class="grouping">)</span>
    <span class="identifier">coef_64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="comment"># Do all the checks at once, like this is easier to debug</span>
    <span class="keyword">assert</span> <span class="identifier">coef_32</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_32</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">coef_64</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_64</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_32</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_32</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X_64</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ridge_32</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">ridge_64</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'solver', ['svd', 'cholesky', 'lsqr', 'sparse_cg', 'sag', 'saga'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ridge_regression_dtype_stability</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.01</span> <span class="arithmetic-operator">*</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># XXX: Sparse CG seems to be far less numerically stable than the</span>
    <span class="comment"># others, maybe we should not enable float32 for this one.</span>
    <span class="identifier">atol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-3</span> <span class="keyword">if</span> <span class="identifier">solver</span> <span class="relational-operator">==</span> <span class="string-literal">"sparse_cg"</span> <span class="keyword">else</span> <span class="float-literal">1e-5</span>
    <span class="keyword">for</span> <span class="identifier">current_dtype</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">current_dtype</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ridge_regression</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">current_dtype</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                  <span class="identifier">y</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">current_dtype</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                  <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                                                  <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                                                  <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                                  <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="punctuation">,</span>
                                                  <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-10</span><span class="punctuation">,</span>
                                                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>
    <span class="keyword">assert</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="identifier">atol</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ridge_sag_with_X_fortran</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that Fortran array are converted when using SAG solver</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="comment"># for the order of X and y to not be C-ordered arrays</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'sag'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    </pre>
  </body>
</html>