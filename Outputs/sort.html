<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">"""
A tool that allows for sorting and grouping images in different ways.
"""</span>
<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">operator</span>
<span class="keyword">from</span> <span class="identifier">concurrent</span> <span class="keyword">import</span> <span class="identifier">futures</span>
<span class="keyword">from</span> <span class="identifier">shutil</span> <span class="keyword">import</span> <span class="identifier">copyfile</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">from</span> <span class="identifier">tqdm</span> <span class="keyword">import</span> <span class="identifier">tqdm</span>

<span class="comment"># faceswap imports</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">serializer</span> <span class="keyword">import</span> <span class="identifier">get_serializer_from_filename</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">align</span> <span class="keyword">import</span> <span class="identifier">AlignedFace</span><span class="punctuation">,</span> <span class="identifier">DetectedFace</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">FacesLoader</span><span class="punctuation">,</span> <span class="identifier">read_image</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">FaceswapError</span>
<span class="keyword">from</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">extract</span><span class="punctuation">.</span><span class="identifier">recognition</span><span class="punctuation">.</span><span class="identifier">vgg_face2_keras</span> <span class="keyword">import</span> <span class="identifier">VGGFace2</span> <span class="keyword">as</span> <span class="identifier">VGGFace</span>
<span class="keyword">from</span> <span class="identifier">plugins</span><span class="punctuation">.</span><span class="identifier">extract</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Extractor</span><span class="punctuation">,</span> <span class="identifier">ExtractMedia</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">Sort</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Sorts folders of faces based on input criteria """</span>
    <span class="comment"># pylint: disable=no-member</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arguments</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">serializer</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_vgg_face</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FacesLoader</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">input_dir</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Main processing function of the sort tool """</span>

        <span class="comment"># Setting default argument values that cannot be set by argparse</span>

        <span class="comment"># Set output folder to the same value as input folder</span>
        <span class="comment"># if the user didn't specify it.</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">output_dir</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"No output directory provided. Using input folder as output folder."</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">output_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">input_dir</span>

        <span class="comment"># Assigning default threshold values based on grouping method</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">final_process</span> <span class="relational-operator">==</span> <span class="string-literal">"folders"</span>
                <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">min_threshold</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">group_method</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'face-cnn'</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">min_threshold</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">7.2</span>
            <span class="keyword">elif</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'hist'</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">min_threshold</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span>

        <span class="comment"># Load VGG Face if sorting by face</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">sort_method</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"face"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_vgg_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">VGGFace</span><span class="grouping">(</span><span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_vgg_face</span><span class="punctuation">.</span><span class="identifier">init_model</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># If logging is enabled, prepare container</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_changes</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="comment"># Assign default sort_log.json value if user didn't specify one</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_file_path</span> <span class="relational-operator">==</span> <span class="string-literal">'sort_log.json'</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_file_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">input_dir</span><span class="punctuation">,</span>
                                                        <span class="string-literal">'sort_log.json'</span><span class="grouping">)</span>

            <span class="comment"># Set serializer based on log file extension</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">serializer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_serializer_from_filename</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_file_path</span><span class="grouping">)</span>

        <span class="comment"># Prepare sort, group and final process method names</span>
        <span class="identifier">_sort</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"sort_"</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">sort_method</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">_group</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"group_"</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">group_method</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">_final</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"final_process_"</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">final_process</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">_sort</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">'sort_color-'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">color_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sort</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'sort_color-', ''</span><span class="grouping">)</span>
            <span class="identifier">_sort</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sort</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">10</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">sort_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sort</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'-', '_'</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">group_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_group</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'-', '_'</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">final_process</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_final</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'-', '_'</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">sort_process</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">launch_aligner</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Load the aligner plugin to retrieve landmarks """</span>
        <span class="identifier">extractor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Extractor</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">"fan"</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span>
                              <span class="identifier">normalize_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hist"</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">extractor</span><span class="punctuation">.</span><span class="identifier">set_batchsize</span><span class="grouping">(</span><span class="string-literal">"align"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">extractor</span><span class="punctuation">.</span><span class="identifier">launch</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">extractor</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">alignment_dict</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the image to an ExtractMedia object for alignment """</span>
        <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFace</span><span class="grouping">(</span><span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="arithmetic-assignment">=</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="arithmetic-assignment">=</span><span class="identifier">height</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">ExtractMedia</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">face</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Multi-threaded, parallel and sequentially ordered landmark loader """</span>
        <span class="identifier">extractor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">launch_aligner</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_images</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">feed_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">Sort</span><span class="punctuation">.</span><span class="identifier">alignment_dict</span><span class="punctuation">,</span> <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">feed_list</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">68</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Finding landmarks in images..."</span><span class="grouping">)</span>
        <span class="comment"># TODO thread the put to queue so we don't have to put and get at the same time</span>
        <span class="comment"># Or even better, set up a proper background loader from disk (i.e. use lib.image.ImageIO)</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">feed</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">feed_list</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Aligning"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">extractor</span><span class="punctuation">.</span><span class="identifier">input_queue</span><span class="punctuation">.</span><span class="identifier">put</span><span class="grouping">(</span><span class="identifier">feed</span><span class="grouping">)</span>
            <span class="identifier">landmarks</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">extractor</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">detected_faces</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">landmarks_xy</span>

        <span class="keyword">return</span> <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span><span class="punctuation">,</span> <span class="identifier">landmarks</span>

    <span class="keyword">def</span> <span class="identifier">_get_images</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Multi-threaded, parallel and sequentially ordered image loader """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Loading images..."</span><span class="grouping">)</span>
        <span class="identifier">filename_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">find_images</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">input_dir</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">futures</span><span class="punctuation">.</span><span class="identifier">ThreadPoolExecutor</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">executor</span><span class="punctuation">:</span>
            <span class="identifier">image_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">executor</span><span class="punctuation">.</span><span class="identifier">map</span><span class="grouping">(</span><span class="identifier">read_image</span><span class="punctuation">,</span> <span class="identifier">filename_list</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Loading Images"</span><span class="punctuation">,</span>
                                   <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">,</span>
                                   <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_process</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        This method dynamically assigns the functions that will be used to run
        the core process of sorting, optionally grouping, renaming/moving into
        folders. After the functions are assigned they are executed.
        """</span>
        <span class="identifier">sort_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">sort_method</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">group_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">group_method</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">final_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">final_process</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">sort_method</span><span class="grouping">)</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="string-literal">"folders"</span> <span class="relational-operator">in</span> <span class="identifier">final_method</span><span class="punctuation">:</span>
            <span class="comment"># Check if non-dissimilarity sort method and group method are not the same</span>
            <span class="keyword">if</span> <span class="identifier">group_method</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'group_', ''</span><span class="grouping">)</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">sort_method</span><span class="punctuation">:</span>
                <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reload_images</span><span class="grouping">(</span><span class="identifier">group_method</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span>
                <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">group_method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">group_method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>

        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">final_method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Done."</span><span class="grouping">)</span>

    <span class="comment"># Methods for sorting</span>
    <span class="keyword">def</span> <span class="identifier">sort_blur</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by blur amount """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by estimated image blur..."</span><span class="grouping">)</span>

        <span class="identifier">blurs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimate_blur</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span><span class="grouping">)</span><span class="grouping">)</span>
                 <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                       <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Estimating blur"</span><span class="punctuation">,</span>
                                                       <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                                       <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">blurs</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">sort_blur_fft</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by fft filtered blur amount with fft"""</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by estimated fft filtered image blur..."</span><span class="grouping">)</span>

        <span class="identifier">fft_blurs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimate_blur_fft</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span><span class="grouping">)</span><span class="grouping">)</span>
                     <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                           <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Estimating fft blur score"</span><span class="punctuation">,</span>
                                                           <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                                           <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">fft_blurs</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">sort_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by identity similarity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by identity similarity..."</span><span class="grouping">)</span>
        <span class="identifier">filenames</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">preds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                              <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Classifying Faces"</span><span class="punctuation">,</span>
                                              <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                              <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">metadata</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The images to be sorted do not contain alignment data. Images must have "</span>
                       <span class="string-literal">"been generated by Faceswap's Extract process.\nIf you are sorting an "</span>
                       <span class="string-literal">"older faceset, then you should re-extract the faces from your source "</span>
                       <span class="string-literal">"alignments file to generate this data."</span><span class="grouping">)</span>
                <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
            <span class="identifier">alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metadata</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">[</span><span class="string-literal">"landmarks_xy"], dtype="float32"</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="punctuation">,</span>
                               <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="punctuation">,</span>
                               <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_vgg_face</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="punctuation">,</span>
                               <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">face</span>
            <span class="identifier">filenames</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">preds</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_vgg_face</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">face</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by ward linkage..."</span><span class="grouping">)</span>

        <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_vgg_face</span><span class="punctuation">.</span><span class="identifier">sorted_similarity</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">preds</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ward"</span><span class="grouping">)</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">filenames</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">img_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_face_cnn</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by landmark similarity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by landmark similarity..."</span><span class="grouping">)</span>
        <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_landmarks</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Comparing landmarks and sorting..."</span><span class="grouping">)</span>
        <span class="identifier">img_list_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Comparing"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">"inf"</span><span class="grouping">)</span>
            <span class="identifier">j_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
            <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">fl1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">fl2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">absolute</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">fl2</span> <span class="arithmetic-operator">-</span> <span class="identifier">fl1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">score</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_score</span><span class="punctuation">:</span>
                    <span class="identifier">min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score</span>
                    <span class="identifier">j_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">j</span>
            <span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j_min_score</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j_min_score</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">img_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_face_cnn_dissim</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by landmark dissimilarity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by landmark dissimilarity..."</span><span class="grouping">)</span>
        <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_landmarks</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">items</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">items</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="punctuation">,</span> <span class="identifier">scores</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Comparing landmarks..."</span><span class="grouping">)</span>
        <span class="identifier">img_list_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Comparing"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">score_total</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">i</span> <span class="relational-operator">==</span> <span class="identifier">j</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="identifier">fl1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">fl2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">score_total</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">absolute</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">fl2</span> <span class="arithmetic-operator">-</span> <span class="identifier">fl1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_total</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="identifier">operator</span><span class="punctuation">.</span><span class="identifier">itemgetter</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">img_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_face_yaw</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by estimated face yaw angle """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by estimated face yaw angle.."</span><span class="grouping">)</span>
        <span class="identifier">filenames</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">yaws</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                              <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Classifying Faces"</span><span class="punctuation">,</span>
                                              <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                              <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">metadata</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The images to be sorted do not contain alignment data. Images must have "</span>
                       <span class="string-literal">"been generated by Faceswap's Extract process.\nIf you are sorting an "</span>
                       <span class="string-literal">"older faceset, then you should re-extract the faces from your source "</span>
                       <span class="string-literal">"alignments file to generate this data."</span><span class="grouping">)</span>
                <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
            <span class="identifier">alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metadata</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span>
            <span class="identifier">aligned_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">[</span><span class="string-literal">"landmarks_xy"], dtype="float32"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                       <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="punctuation">,</span>
                                       <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="punctuation">,</span>
                                       <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">filenames</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">yaws</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">aligned_face</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">yaw</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="identifier">matched_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filenames</span><span class="punctuation">,</span> <span class="identifier">yaws</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">matched_list</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="identifier">operator</span><span class="punctuation">.</span><span class="identifier">itemgetter</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">img_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_hist</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by image histogram similarity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by histogram similarity..."</span><span class="grouping">)</span>

        <span class="comment"># TODO We have metadata here, so we can mask the face for hist sorting</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">calcHist</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">image</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">256</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Calculating histograms"</span><span class="punctuation">,</span>
                                                   <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                                   <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Comparing histograms and sorting..."</span><span class="grouping">)</span>
        <span class="identifier">img_list_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Comparing histograms"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">"inf"</span><span class="grouping">)</span>
            <span class="identifier">j_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
            <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">compareHist</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">HISTCMP_BHATTACHARYYA</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">score</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_score</span><span class="punctuation">:</span>
                    <span class="identifier">min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score</span>
                    <span class="identifier">j_min_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">j</span>
            <span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j_min_score</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j_min_score</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">img_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_hist_dissim</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort by image histogram dissimilarity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by histogram dissimilarity..."</span><span class="grouping">)</span>

        <span class="comment"># TODO We have metadata here, so we can mask the face for hist sorting</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">calcHist</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">image</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">256</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span>
                    <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                   <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Calculating histograms"</span><span class="punctuation">,</span>
                                                   <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                                   <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">img_list_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Comparing histograms"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">score_total</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">i</span> <span class="relational-operator">==</span> <span class="identifier">j</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="identifier">score_total</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">compareHist</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                               <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">HISTCMP_BHATTACHARYYA</span><span class="grouping">)</span>
            <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">score_total</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">sort_color</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Score by channel average intensity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by channel average intensity..."</span><span class="grouping">)</span>
        <span class="identifier">desired_channel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'gray': 0, 'luma': 0, 'orange': 1, 'green'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span>
        <span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">color_method</span>
        <span class="identifier">channel_to_sort</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">v</span> <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">desired_channel</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">method</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_images</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Converting to appropriate colorspace..."</span><span class="grouping">)</span>
        <span class="identifier">same_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="relational-operator">==</span> <span class="identifier">image_list</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">image_list</span><span class="grouping">)</span>
        <span class="identifier">images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">image_list</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">same_size</span> <span class="keyword">else</span> <span class="identifier">image_list</span>
        <span class="identifier">converted_images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_convert_color</span><span class="grouping">(</span><span class="identifier">images</span><span class="punctuation">,</span> <span class="identifier">same_size</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Scoring each image..."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">same_size</span><span class="punctuation">:</span>
            <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span><span class="identifier">converted_images</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">progress_bar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">converted_images</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Scoring"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span>
            <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">progress_bar</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="identifier">matched_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">scores</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">channel_to_sort</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">sorted_file_img_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">matched_list</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="identifier">operator</span><span class="punctuation">.</span><span class="identifier">itemgetter</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sorted_file_img_list</span>

    <span class="keyword">def</span> <span class="identifier">sort_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sort the faces by largest face (in original frame) to smallest """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting by original face size..."</span><span class="grouping">)</span>
        <span class="identifier">img_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                              <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Calculating face sizes"</span><span class="punctuation">,</span>
                                              <span class="identifier">total</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loader</span><span class="punctuation">.</span><span class="identifier">count</span><span class="punctuation">,</span>
                                              <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">metadata</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The images to be sorted do not contain alignment data. Images must have "</span>
                       <span class="string-literal">"been generated by Faceswap's Extract process.\nIf you are sorting an "</span>
                       <span class="string-literal">"older faceset, then you should re-extract the faces from your source "</span>
                       <span class="string-literal">"alignments file to generate this data."</span><span class="grouping">)</span>
                <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
            <span class="identifier">alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metadata</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span>
            <span class="identifier">aligned_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">[</span><span class="string-literal">"landmarks_xy"], dtype="float32"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                       <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="punctuation">,</span>
                                       <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="punctuation">,</span>
                                       <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">aligned_face</span><span class="punctuation">.</span><span class="identifier">original_roi</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="float-literal">0.5</span>
            <span class="identifier">img_list</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Sorting..."</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># Methods for grouping</span>
    <span class="keyword">def</span> <span class="identifier">group_blur</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Group into bins by blur """</span>
        <span class="comment"># Starting the binning process</span>
        <span class="identifier">num_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">num_bins</span>

        <span class="comment"># The last bin will get all extra images if it's</span>
        <span class="comment"># not possible to distribute them evenly</span>
        <span class="identifier">num_per_bin</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">num_bins</span>
        <span class="identifier">remainder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">num_bins</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Grouping by blur..."</span><span class="grouping">)</span>
        <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_bins</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_per_bin</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">idx</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

        <span class="comment"># If remainder is 0, nothing gets added to the last bin.</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">remainder</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">bins</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">bins</span>

    <span class="keyword">def</span> <span class="identifier">group_blur_fft</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Group into bins by fft blur score"""</span>
        <span class="comment"># Starting the binning process</span>
        <span class="identifier">num_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">num_bins</span>

        <span class="comment"># The last bin will get all extra images if it's</span>
        <span class="comment"># not possible to distribute them evenly</span>
        <span class="identifier">num_per_bin</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">num_bins</span>
        <span class="identifier">remainder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">num_bins</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Grouping by fft blur score..."</span><span class="grouping">)</span>
        <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_bins</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_per_bin</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">idx</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

        <span class="comment"># If remainder is 0, nothing gets added to the last bin.</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">remainder</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">bins</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">bins</span>

    <span class="keyword">def</span> <span class="identifier">group_face_cnn</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Group into bins by CNN face similarity """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Grouping by face-cnn similarity..."</span><span class="grouping">)</span>

        <span class="comment"># Groups are of the form: group_num -&gt; reference faces</span>
        <span class="identifier">reference_groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># Bins array, where index is the group number and value is</span>
        <span class="comment"># an array containing the file paths to the images in that group.</span>
        <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

        <span class="comment"># Comparison threshold used to decide how similar</span>
        <span class="comment"># faces have to be to be grouped together.</span>
        <span class="comment"># It is multiplied by 1000 here to allow the cli option to use smaller</span>
        <span class="comment"># numbers.</span>
        <span class="identifier">min_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">min_threshold</span> <span class="arithmetic-operator">*</span> <span class="int-literal">1000</span>

        <span class="identifier">img_list_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Grouping"</span><span class="punctuation">,</span>
                      <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">fl1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

            <span class="identifier">current_best</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">"inf"</span><span class="grouping">)</span><span class="grouping">]</span>

            <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">references</span> <span class="relational-operator">in</span> <span class="identifier">reference_groups</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">try</span><span class="punctuation">:</span>
                    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_avg_score_faces_cnn</span><span class="grouping">(</span><span class="identifier">fl1</span><span class="punctuation">,</span> <span class="identifier">references</span><span class="grouping">)</span>
                <span class="keyword">except</span> <span class="identifier">TypeError</span><span class="punctuation">:</span>
                    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">"inf"</span><span class="grouping">)</span>
                <span class="keyword">except</span> <span class="identifier">ZeroDivisionError</span><span class="punctuation">:</span>
                    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">"inf"</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">score</span> <span class="relational-operator">&lt;</span> <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">score</span>

            <span class="keyword">if</span> <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_threshold</span><span class="punctuation">:</span>
                <span class="identifier">reference_groups</span><span class="grouping">[</span><span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">fl1</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">reference_groups</span><span class="grouping">[</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">reference_groups</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
                <span class="identifier">bins</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">bins</span>

    <span class="keyword">def</span> <span class="identifier">group_face_yaw</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Group into bins by yaw of face """</span>
        <span class="comment"># Starting the binning process</span>
        <span class="identifier">num_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">num_bins</span>

        <span class="comment"># The last bin will get all extra images if it's</span>
        <span class="comment"># not possible to distribute them evenly</span>
        <span class="identifier">num_per_bin</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">num_bins</span>
        <span class="identifier">remainder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">num_bins</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Grouping by face-yaw..."</span><span class="grouping">)</span>
        <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_bins</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">num_per_bin</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">idx</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

        <span class="comment"># If remainder is 0, nothing gets added to the last bin.</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">remainder</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">bins</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">bins</span>

    <span class="keyword">def</span> <span class="identifier">group_hist</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Group into bins by histogram """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Grouping by histogram..."</span><span class="grouping">)</span>

        <span class="comment"># Groups are of the form: group_num -&gt; reference histogram</span>
        <span class="identifier">reference_groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># Bins array, where index is the group number and value is</span>
        <span class="comment"># an array containing the file paths to the images in that group</span>
        <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

        <span class="identifier">min_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">min_threshold</span>

        <span class="identifier">img_list_len</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span>
        <span class="identifier">reference_groups</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">bins</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">img_list_len</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Grouping"</span><span class="punctuation">,</span>
                      <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">current_best</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">"inf"</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">value</span> <span class="relational-operator">in</span> <span class="identifier">reference_groups</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_avg_score_hist</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">score</span> <span class="relational-operator">&lt;</span> <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">score</span>

            <span class="keyword">if</span> <span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_threshold</span><span class="punctuation">:</span>
                <span class="identifier">reference_groups</span><span class="grouping">[</span><span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">current_best</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">reference_groups</span><span class="grouping">[</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">reference_groups</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
                <span class="identifier">bins</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">bins</span>

    <span class="comment"># Final process methods</span>
    <span class="keyword">def</span> <span class="identifier">final_process_rename</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Rename the files """</span>
        <span class="identifier">output_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">output_dir</span>

        <span class="identifier">process_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">set_process_file_method</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_changes</span><span class="punctuation">,</span>
                                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">keep_original</span><span class="grouping">)</span>

        <span class="comment"># Make sure output directory exists</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="grouping">)</span>

        <span class="identifier">description</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="string-literal">"Copying and Renaming"</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">keep_original</span>
            <span class="keyword">else</span> <span class="string-literal">"Moving and Renaming"</span>
        <span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">description</span><span class="punctuation">,</span>
                      <span class="identifier">leave</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                      <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">src_basename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">src</span><span class="grouping">)</span>

            <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="punctuation">,</span> <span class="string-literal">'{:05d}_{}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">src_basename</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">process_file</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">FileNotFoundError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">'fail to rename %s'</span><span class="punctuation">,</span> <span class="identifier">src</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">description</span><span class="punctuation">,</span>
                      <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">renaming</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">set_renaming_method</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_changes</span><span class="grouping">)</span>
            <span class="identifier">fname</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">img_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">renaming</span><span class="grouping">(</span><span class="identifier">fname</span><span class="punctuation">,</span> <span class="identifier">output_dir</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span><span class="grouping">)</span>

            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">FileNotFoundError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">'fail to rename %s'</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">src</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_changes</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">write_to_log</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">final_process_folders</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Move the files to folders """</span>
        <span class="identifier">output_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">output_dir</span>

        <span class="identifier">process_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">set_process_file_method</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_changes</span><span class="punctuation">,</span>
                                                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">keep_original</span><span class="grouping">)</span>

        <span class="comment"># First create new directories to avoid checking</span>
        <span class="comment"># for directory existence in the moving loop</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Creating group directories."</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bins</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">directory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">directory</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">directory</span><span class="grouping">)</span>

        <span class="identifier">description</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="string-literal">"Copying into Groups"</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">keep_original</span>
            <span class="keyword">else</span> <span class="string-literal">"Moving into Groups"</span>
        <span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Total groups found: %s"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bins</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bins</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="identifier">description</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">j</span><span class="grouping">]</span>
                <span class="identifier">src_basename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">src</span><span class="grouping">)</span>

                <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">src_basename</span><span class="grouping">)</span>
                <span class="keyword">try</span><span class="punctuation">:</span>
                    <span class="identifier">process_file</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span><span class="grouping">)</span>
                <span class="keyword">except</span> <span class="identifier">FileNotFoundError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"Failed to move '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_changes</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">write_to_log</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">changes</span><span class="grouping">)</span>

    <span class="comment"># Various helper methods</span>
    <span class="keyword">def</span> <span class="identifier">write_to_log</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Write the changes to log file """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Writing sort log to: '%s'"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_file_path</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">serializer</span><span class="punctuation">.</span><span class="identifier">save</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_args</span><span class="punctuation">.</span><span class="identifier">log_file_path</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">reload_images</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">group_method</span><span class="punctuation">,</span> <span class="identifier">img_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Reloads the image list by replacing the comparative values with those
        that the chosen grouping method expects.
        :param group_method: str name of the grouping method that will be used.
        :param img_list: image list that has been sorted by one of the sort
        methods.
        :return: img_list but with the comparative values that the chosen
        grouping method expects.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Preparing to group..."</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">group_method</span> <span class="relational-operator">==</span> <span class="string-literal">'group_blur'</span><span class="punctuation">:</span>
            <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_images</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">blurs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimate_blur</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">image_list</span><span class="grouping">]</span>
            <span class="identifier">temp_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">blurs</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">group_method</span> <span class="relational-operator">==</span> <span class="string-literal">'group_blur_fft'</span><span class="punctuation">:</span>
            <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_images</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">fft_blurs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">estimate_blur_fft</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">image_list</span><span class="grouping">]</span>
            <span class="identifier">temp_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">fft_blurs</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">group_method</span> <span class="relational-operator">==</span> <span class="string-literal">'group_face_cnn'</span><span class="punctuation">:</span>
            <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span><span class="punctuation">,</span> <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_landmarks</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">temp_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">landmarks</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">group_method</span> <span class="relational-operator">==</span> <span class="string-literal">'group_face_yaw'</span><span class="punctuation">:</span>
            <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span><span class="punctuation">,</span> <span class="identifier">landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_landmarks</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">yaws</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">calc_landmarks_face_yaw</span><span class="grouping">(</span><span class="identifier">mark</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">mark</span> <span class="relational-operator">in</span> <span class="identifier">landmarks</span><span class="grouping">]</span>
            <span class="identifier">temp_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">yaws</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">group_method</span> <span class="relational-operator">==</span> <span class="string-literal">'group_hist'</span><span class="punctuation">:</span>
            <span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">image_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_images</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">histograms</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">calcHist</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">img</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">256</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">image_list</span><span class="grouping">]</span>
            <span class="identifier">temp_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">filename_list</span><span class="punctuation">,</span> <span class="identifier">histograms</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{} group_method not found."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">group_method</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">splice_lists</span><span class="grouping">(</span><span class="identifier">img_list</span><span class="punctuation">,</span> <span class="identifier">temp_list</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_convert_color</span><span class="grouping">(</span><span class="identifier">imgs</span><span class="punctuation">,</span> <span class="identifier">same_size</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Helper function to convert color spaces """</span>

        <span class="keyword">if</span> <span class="identifier">method</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">'gray'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">conversion</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.0722</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.7152</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.2126</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">conversion</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.25</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.25</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.25</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-0.25</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">same_size</span><span class="punctuation">:</span>
            <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'greedy'</span>
            <span class="identifier">operation</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'bijk, kl -&gt; bijl' if method.endswith('gray') else 'bijl, kl -&gt; bijk'</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">operation</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'ijk, kl -&gt; ijl' if method.endswith('gray') else 'ijl, kl -&gt; ijk'</span>
            <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum_path</span><span class="grouping">(</span><span class="identifier">operation</span><span class="punctuation">,</span> <span class="identifier">imgs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">conversion</span><span class="punctuation">,</span> <span class="identifier">optimize</span><span class="arithmetic-assignment">=</span><span class="string-literal">'optimal'</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

        <span class="identifier">progress_bar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">imgs</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Converting"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span>
        <span class="identifier">images</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum</span><span class="grouping">(</span><span class="identifier">operation</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">conversion</span><span class="punctuation">,</span> <span class="identifier">optimize</span><span class="arithmetic-assignment">=</span><span class="identifier">path</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
                  <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">progress_bar</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">images</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">splice_lists</span><span class="grouping">(</span><span class="identifier">sorted_list</span><span class="punctuation">,</span> <span class="identifier">new_vals_list</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        This method replaces the value at index 1 in each sub-list in the
        sorted_list with the value that is calculated for the same img_path,
        but found in new_vals_list.

        Format of lists: [[img_path, value], [img_path2, value2], ...]

        :param sorted_list: list that has been sorted by one of the sort
        methods.
        :param new_vals_list: list that has been loaded by a different method
        than the sorted_list.
        :return: list that is sorted in the same way as the input sorted list
        but the values corresponding to each image are from new_vals_list.
        """</span>
        <span class="identifier">new_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="comment"># Make new list of just image paths to serve as an index</span>
        <span class="identifier">val_index_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">i</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">new_vals_list</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">sorted_list</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">desc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Splicing"</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">current_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">sorted_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">sorted_list</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">new_val_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">val_index_list</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">current_img</span><span class="grouping">)</span>
            <span class="identifier">new_list</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">current_img</span><span class="punctuation">,</span> <span class="identifier">new_vals_list</span><span class="grouping">[</span><span class="identifier">new_val_index</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">new_list</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">find_images</span><span class="grouping">(</span><span class="identifier">input_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return list of images at specified location """</span>
        <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">extensions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">".jpg", ".png", ".jpeg"</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">root</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">files</span> <span class="relational-operator">in</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">walk</span><span class="grouping">(</span><span class="identifier">input_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">file</span> <span class="relational-operator">in</span> <span class="identifier">files</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">file</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">extensions</span><span class="punctuation">:</span>
                    <span class="identifier">result</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">root</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">break</span>
        <span class="keyword">return</span> <span class="identifier">result</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">estimate_blur</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Estimate the amount of blur an image has with the variance of the Laplacian.
        Normalize by pixel number to offset the effect of image size on pixel gradients & variance.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            The face image to calculate blur for
        metadata: dict, optional
            The metadata for the face image or ``None`` if no metadata is available. If metadata is
            provided the face will be masked by the "components" mask prior to calculating blur.
            Default:``None``

        Returns
        -------
        float
            The estimated blur score for the face
        """</span>
        <span class="keyword">if</span> <span class="identifier">metadata</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metadata</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span>
            <span class="identifier">det_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFace</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">det_face</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">a</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">)</span>
            <span class="identifier">aln_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">[</span><span class="string-literal">"landmarks_xy"], dtype="float32"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="punctuation">,</span>
                                   <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="punctuation">,</span>
                                   <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">256</span><span class="punctuation">,</span>
                                   <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">det_face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="string-literal">"components"</span><span class="grouping">]</span>
            <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">set_sub_crop</span><span class="grouping">(</span><span class="identifier">aln_face</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_centering</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">aln_face</span><span class="punctuation">.</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="punctuation">:</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">cvtColor</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">COLOR_BGR2GRAY</span><span class="grouping">)</span>
        <span class="identifier">blur_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">Laplacian</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">CV_32F</span><span class="grouping">)</span>
        <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">blur_map</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">score</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">estimate_blur_fft</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">metadata</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Estimate the amount of blur a fft filtered image has.

        Parameters
        ----------
        image: :class:`numpy.ndarray`
            Use Fourier Transform to analyze the frequency characteristics of the masked
            face using 2D Discrete Fourier Transform (DFT) filter to find the frequency domain.
            A mean value is assigned to the magnitude spectrum and returns a blur score.
            Adapted from https://www.pyimagesearch.com/2020/06/15/
            opencv-fast-fourier-transform-fft-for-blur-detection-in-images-and-video-streams/
        metadata: dict, optional
            The metadata for the face image or ``None`` if no metadata is available. If metadata is
            provided the face will be masked by the "components" mask prior to calculating blur.
            Default:``None``

        Returns
        -------
        float
            The estimated fft blur score for the face
        """</span>
        <span class="keyword">if</span> <span class="identifier">metadata</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">alignments</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metadata</span><span class="grouping">[</span><span class="string-literal">"alignments"</span><span class="grouping">]</span>
            <span class="identifier">det_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DetectedFace</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">det_face</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">a</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">)</span>
            <span class="identifier">aln_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AlignedFace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">alignments</span><span class="grouping">[</span><span class="string-literal">"landmarks_xy"], dtype="float32"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">image</span><span class="punctuation">,</span>
                                   <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="punctuation">,</span>
                                   <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">256</span><span class="punctuation">,</span>
                                   <span class="identifier">is_aligned</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">det_face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">[</span><span class="string-literal">"components"</span><span class="grouping">]</span>
            <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">set_sub_crop</span><span class="grouping">(</span><span class="identifier">aln_face</span><span class="punctuation">.</span><span class="identifier">pose</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_centering</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">centering</span><span class="arithmetic-assignment">=</span><span class="string-literal">"legacy"</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">aln_face</span><span class="punctuation">.</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="punctuation">:</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">cvtColor</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">COLOR_BGR2GRAY</span><span class="grouping">)</span>
        <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">c_height</span><span class="punctuation">,</span> <span class="identifier">c_width</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">height</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">width</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">fft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">fft2</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">)</span>
        <span class="identifier">fft_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="identifier">fftshift</span><span class="grouping">(</span><span class="identifier">fft</span><span class="grouping">)</span>
        <span class="identifier">fft_shift</span><span class="grouping">[</span><span class="identifier">c_height</span> <span class="arithmetic-operator">-</span> <span class="int-literal">75</span><span class="punctuation">:</span><span class="identifier">c_height</span> <span class="arithmetic-operator">+</span> <span class="int-literal">75</span><span class="punctuation">,</span> <span class="identifier">c_width</span> <span class="arithmetic-operator">-</span> <span class="int-literal">75</span><span class="punctuation">:</span><span class="identifier">c_width</span> <span class="arithmetic-operator">+</span> <span class="int-literal">75</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="invalid">i</span><span class="invalid">f</span><span class="invalid">f</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">h</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">f</span><span class="invalid">t</span><span class="invalid">s</span><span class="invalid">h</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">fft_shift</span><span class="grouping">)</span>
        <span class="identifier">shift_back</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fft</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">f</span><span class="invalid">t</span><span class="int-literal">2</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">f</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">h</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">t</span><span class="grouping">)</span>
        <span class="identifier">magnitude</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">shift_back</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">magnitude</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">score</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">calc_landmarks_face_pitch</span><span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" UNUSED - Calculate the amount of pitch in a face """</span>
        <span class="identifier">var_t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span>
        <span class="identifier">var_b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">var_b</span> <span class="arithmetic-operator">-</span> <span class="identifier">var_t</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">calc_landmarks_face_yaw</span><span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Calculate the amount of yaw in a face """</span>
        <span class="identifier">var_l</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">27</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                 <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">28</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                 <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">29</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">3.0</span>
        <span class="identifier">var_r</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">16</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">27</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                 <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">15</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">28</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                 <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">14</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">flm</span><span class="grouping">[</span><span class="int-literal">29</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">3.0</span>
        <span class="keyword">return</span> <span class="identifier">var_r</span> <span class="arithmetic-operator">-</span> <span class="identifier">var_l</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">set_process_file_method</span><span class="grouping">(</span><span class="identifier">log_changes</span><span class="punctuation">,</span> <span class="identifier">keep_original</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Assigns the final file processing method based on whether changes are
        being logged and whether the original files are being kept in the
        input directory.
        Relevant cli arguments: -k, -l
        :return: function reference
        """</span>
        <span class="keyword">if</span> <span class="identifier">log_changes</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">keep_original</span><span class="punctuation">:</span>
                <span class="keyword">def</span> <span class="identifier">process_file</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="comment">""" Process file method if logging changes
                        and keeping original """</span>
                    <span class="identifier">copyfile</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
                    <span class="identifier">changes</span><span class="grouping">[</span><span class="identifier">src</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dst</span>

            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">def</span> <span class="identifier">process_file</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="comment">""" Process file method if logging changes
                        and not keeping original """</span>
                    <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
                    <span class="identifier">changes</span><span class="grouping">[</span><span class="identifier">src</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dst</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">keep_original</span><span class="punctuation">:</span>
                <span class="keyword">def</span> <span class="identifier">process_file</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=unused-argument</span>
                    <span class="comment">""" Process file method if not logging changes
                        and keeping original """</span>
                    <span class="identifier">copyfile</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>

            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">def</span> <span class="identifier">process_file</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=unused-argument</span>
                    <span class="comment">""" Process file method if not logging changes
                        and not keeping original """</span>
                    <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">process_file</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">set_renaming_method</span><span class="grouping">(</span><span class="identifier">log_changes</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the method for renaming files """</span>
        <span class="keyword">if</span> <span class="identifier">log_changes</span><span class="punctuation">:</span>
            <span class="keyword">def</span> <span class="identifier">renaming</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">output_dir</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment">""" Rename files  method if logging changes """</span>
                <span class="identifier">src_basename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">src</span><span class="grouping">)</span>

                <span class="identifier">__src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="punctuation">,</span>
                                     <span class="string-literal">'{:05d}_{}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">src_basename</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span>
                    <span class="identifier">output_dir</span><span class="punctuation">,</span>
                    <span class="string-literal">'{:05d}{}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">src_basename</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">changes</span><span class="grouping">[</span><span class="identifier">src</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dst</span>
                <span class="keyword">return</span> <span class="identifier">__src</span><span class="punctuation">,</span> <span class="identifier">dst</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">def</span> <span class="identifier">renaming</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">output_dir</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">changes</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=unused-argument</span>
                <span class="comment">""" Rename files method if not logging changes """</span>
                <span class="identifier">src_basename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">src</span><span class="grouping">)</span>

                <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">output_dir</span><span class="punctuation">,</span>
                                   <span class="string-literal">'{:05d}_{}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">src_basename</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span>
                    <span class="identifier">output_dir</span><span class="punctuation">,</span>
                    <span class="string-literal">'{:05d}{}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">src_basename</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">return</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span>
        <span class="keyword">return</span> <span class="identifier">renaming</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">get_avg_score_hist</span><span class="grouping">(</span><span class="identifier">img1</span><span class="punctuation">,</span> <span class="identifier">references</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the average histogram score between a face and
            reference image """</span>
        <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">img2</span> <span class="relational-operator">in</span> <span class="identifier">references</span><span class="punctuation">:</span>
            <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">compareHist</span><span class="grouping">(</span><span class="identifier">img1</span><span class="punctuation">,</span> <span class="identifier">img2</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">HISTCMP_BHATTACHARYYA</span><span class="grouping">)</span>
            <span class="identifier">scores</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">score</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">get_avg_score_faces_cnn</span><span class="grouping">(</span><span class="identifier">fl1</span><span class="punctuation">,</span> <span class="identifier">references</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the average CNN similarity score
            between a face and reference image """</span>
        <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">fl2</span> <span class="relational-operator">in</span> <span class="identifier">references</span><span class="punctuation">:</span>
            <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">absolute</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">fl2</span> <span class="arithmetic-operator">-</span> <span class="identifier">fl1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">scores</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">score</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span>

    </pre>
  </body>
</html>