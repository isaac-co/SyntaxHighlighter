<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Test the pipeline module.
"""</span>
<span class="keyword">from</span> <span class="identifier">tempfile</span> <span class="keyword">import</span> <span class="identifier">mkdtemp</span>
<span class="keyword">import</span> <span class="identifier">shutil</span>
<span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">import</span> <span class="identifier">joblib</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">parse_version</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
    <span class="identifier">MinimalClassifier</span><span class="punctuation">,</span>
    <span class="identifier">MinimalRegressor</span><span class="punctuation">,</span>
    <span class="identifier">MinimalTransformer</span><span class="punctuation">,</span>
<span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span><span class="punctuation">,</span> <span class="identifier">is_classifier</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span><span class="punctuation">,</span> <span class="identifier">FeatureUnion</span><span class="punctuation">,</span> <span class="identifier">make_pipeline</span><span class="punctuation">,</span> <span class="identifier">make_union</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">LocalOutlierFactor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span><span class="punctuation">,</span> <span class="identifier">Lasso</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">accuracy_score</span><span class="punctuation">,</span> <span class="identifier">r2_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_selection</span> <span class="keyword">import</span> <span class="identifier">SelectKBest</span><span class="punctuation">,</span> <span class="identifier">f_classif</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">PCA</span><span class="punctuation">,</span> <span class="identifier">TruncatedSVD</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_iris</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">CountVectorizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span> <span class="keyword">import</span> <span class="identifier">SimpleImputer</span>

<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">JUNK_FOOD_DOCS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="string-literal">"the pizza pizza beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the pizza burger beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the the pizza beer beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the burger beer beer copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the coke burger coke copyright"</span><span class="punctuation">,</span>
    <span class="string-literal">"the coke burger burger"</span><span class="punctuation">,</span>
<span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">NoFit</span><span class="punctuation">:</span>
    <span class="comment">"""Small class to test parameter dispatching.
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">a</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">b</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">a</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span>


<span class="keyword">class</span> <span class="identifier">NoTrans</span><span class="grouping">(</span><span class="identifier">NoFit</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'a': self.a, 'b'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">b</span><span class="grouping">}</span>

    <span class="keyword">def</span> <span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'a'</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">class</span> <span class="identifier">NoInvTransf</span><span class="grouping">(</span><span class="identifier">NoTrans</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">class</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="identifier">NoInvTransf</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span>

    <span class="keyword">def</span> <span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">class</span> <span class="identifier">TransfFitParams</span><span class="grouping">(</span><span class="identifier">Transf</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">fit_params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_params</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">class</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mult</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mult</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mult</span>

    <span class="keyword">def</span> <span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mult</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mult</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">predict_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict_log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">decision_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">predict</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Mock classifier
    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">successful</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">should_succeed</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">successful</span> <span class="arithmetic-assignment">=</span> <span class="identifier">should_succeed</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">successful</span>

    <span class="keyword">def</span> <span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">should_succeed</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">should_succeed</span><span class="arithmetic-assignment">=</span><span class="identifier">should_succeed</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">score</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">DummyTransf</span><span class="grouping">(</span><span class="identifier">Transf</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Transformer which store the column means"""</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">means_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># store timestamp to figure out whether the result of 'fit' has been</span>
        <span class="comment"># cached or not</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">timestamp_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">class</span> <span class="identifier">DummyEstimatorParams</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Mock classifier that takes params on predict"""</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">got_attribute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">got_attribute</span> <span class="arithmetic-assignment">=</span> <span class="identifier">got_attribute</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">got_attribute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">got_attribute</span> <span class="arithmetic-assignment">=</span> <span class="identifier">got_attribute</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">got_attribute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">got_attribute</span> <span class="arithmetic-assignment">=</span> <span class="identifier">got_attribute</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the various init parameters of the pipeline.</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Check that we can't instantiate pipelines with objects without fit</span>
    <span class="comment"># method</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'Last step of Pipeline should implement fit '</span>
           <span class="string-literal">'or be the string \'passthrough\''</span>
           <span class="string-literal">'.*NoFit.*'</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'clf'</span><span class="punctuation">,</span> <span class="identifier">NoFit</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Smoke test with only an estimator</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NoTrans</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span>
            <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">svc__a</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">svc__b</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">svc</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">,</span>
                 <span class="arithmetic-operator">**</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check that params are set</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">svc__a</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">a</span> <span class="relational-operator">==</span> <span class="float-literal">0.1</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">b</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="comment"># Smoke test the repr:</span>
    <span class="identifier">repr</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="grouping">)</span>

    <span class="comment"># Test with two objects</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">filter1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">f_classif</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'anova', filter1), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check that estimators are not cloned on pipeline construction</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'anova'</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">filter1</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'svc'</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">clf</span>

    <span class="comment"># Check that we can't instantiate with non-transformers on the way</span>
    <span class="comment"># Note that NoTrans implements fit, but not transform</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'All intermediate steps should be transformers.*\\bNoTrans\\b.*'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'t', NoTrans()), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check that params are set</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">svc__C</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">C</span> <span class="relational-operator">==</span> <span class="float-literal">0.1</span>
    <span class="comment"># Smoke test the repr:</span>
    <span class="identifier">repr</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="grouping">)</span>

    <span class="comment"># Check that params are not set when naming them wrong</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Invalid parameter C for estimator SelectKBest'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">anova__C</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>

    <span class="comment"># Test clone</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'svc'] is pipe2.named_steps['svc'</span><span class="grouping">]</span>

    <span class="comment"># Check that apart from estimators, the parameters are the same</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">params2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe2</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">pipe2</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">params2</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>

    <span class="comment"># Remove estimators that where copied</span>
    <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="string-literal">'svc'</span><span class="grouping">)</span>
    <span class="identifier">params</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="string-literal">'anova'</span><span class="grouping">)</span>
    <span class="identifier">params2</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="string-literal">'svc'</span><span class="grouping">)</span>
    <span class="identifier">params2</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="string-literal">'anova'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">params</span> <span class="relational-operator">==</span> <span class="identifier">params2</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_init_tuple</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Pipeline accepts steps as tuple</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">transf</span><span class="arithmetic-assignment">=</span><span class="string-literal">'passthrough'</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_methods_anova</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the various methods of the pipeline (anova).</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="comment"># Test with Anova + LogisticRegression</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">filter1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">f_classif</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'anova', filter1), ('logistic'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_fit_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the pipeline can take fit parameters</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">clf__should_succeed</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="comment"># classifier should return True</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="comment"># and transformer params should not be changed</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">a</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">b</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="comment"># invalid parameters should raise an error message</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span><span class="string-literal">"fit() got an unexpected keyword argument 'bad'"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">clf__bad</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_sample_weight_supported</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Pipeline should pass sample_weight</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">8</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_sample_weight_unsupported</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># When sample_weight is None it shouldn't be passed</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"score() got an unexpected keyword argument 'sample_weight'"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_raise_set_params_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test pipeline raises set params error message for nested models.</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'cls'</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># expected error message</span>
    <span class="identifier">error_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Invalid parameter fake for estimator {pipe}. "</span>
        <span class="string-literal">'Check the list of available parameters '</span>
        <span class="string-literal">'with `estimator.get_params().keys()`.'</span>
    <span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">fake</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nope'</span><span class="grouping">)</span>

    <span class="comment"># nested model check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">error_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">fake__estimator</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nope'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_methods_pca_svm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the various methods of the pipeline (pca + svm).</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="comment"># Test with PCA + SVC</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">probability</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full', n_components='mle'</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'pca', pca), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_score_samples_pca_lof</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="comment"># Test that the score_samples method is implemented on a pipeline.</span>
    <span class="comment"># Test that the score_samples method on pipeline yields same results as</span>
    <span class="comment"># applying transform and score_samples steps separately.</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full', n_components='mle'</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">lof</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LocalOutlierFactor</span><span class="grouping">(</span><span class="identifier">novelty</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'pca', pca), ('lof'</span><span class="punctuation">,</span> <span class="identifier">lof</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># Check the shapes</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="comment"># Check the values</span>
    <span class="identifier">lof</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">lof</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_score_samples_on_pipeline_without_score_samples</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># Test that a pipeline does not have score_samples method when the final</span>
    <span class="comment"># step of the pipeline does not have score_samples defined.</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span>
                       <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"'LogisticRegression' object has no attribute "</span>
                             <span class="string-literal">"'score_samples'"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_methods_preprocessing_svm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the various methods of the pipeline (preprocessing + svm).</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'randomized'</span><span class="punctuation">,</span> <span class="identifier">whiten</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">probability</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">decision_function_shape</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovr'</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">preprocessing</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">scaler</span><span class="punctuation">,</span> <span class="identifier">pca</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'preprocess', preprocessing), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># check shapes of various prediction functions</span>
        <span class="identifier">predict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">predict</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span><span class="grouping">)</span>

        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">proba</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>

        <span class="identifier">log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>

        <span class="identifier">decision_function</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">decision_function</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>

        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fit_predict_on_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that the fit_predict method is implemented on a pipeline</span>
    <span class="comment"># test that the fit_predict on pipeline yields same results as applying</span>
    <span class="comment"># transform and clustering steps separately</span>
    <span class="identifier">scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">km</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># As pipeline doesn't clone estimators on construction,</span>
    <span class="comment"># it must have its own estimators</span>
    <span class="identifier">scaler_for_pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">km_for_pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># first compute the transform and clustering step separately</span>
    <span class="identifier">scaled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scaler</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">separate_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">km</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>

    <span class="comment"># use a pipeline to do the transform and clustering in one step</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'scaler'</span><span class="punctuation">,</span> <span class="identifier">scaler_for_pipeline</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'Kmeans'</span><span class="punctuation">,</span> <span class="identifier">km_for_pipeline</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipeline_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipeline_pred</span><span class="punctuation">,</span> <span class="identifier">separate_pred</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fit_predict_on_pipeline_without_fit_predict</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># tests that a pipeline does not have fit_predict method when final</span>
    <span class="comment"># step of pipeline does not have fit_predict defined</span>
    <span class="identifier">scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'scaler', scaler), ('pca'</span><span class="punctuation">,</span> <span class="identifier">pca</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"'PCA' object has no attribute 'fit_predict'"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="string-literal">'fit_predict'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fit_predict_with_intermediate_fit_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># tests that Pipeline passes fit_params to intermediate steps</span>
    <span class="comment"># when fit_predict is invoked</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', TransfFitParams()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit_predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                     <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                     <span class="identifier">transf__should_get_this</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                     <span class="identifier">clf__should_succeed</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'].fit_params['should_get_this'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'clf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">successful</span>
    <span class="keyword">assert</span> <span class="string-literal">'should_succeed' not in pipe.named_steps['transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">fit_params</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"method_name"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="string-literal">"predict", "predict_proba", "predict_log_proba"</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_predict_methods_with_predict_params</span><span class="grouping">(</span><span class="identifier">method_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># tests that Pipeline passes predict_* to the final estimator</span>
    <span class="comment"># when predict_* is invoked</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">DummyEstimatorParams</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">method_name</span><span class="grouping">)</span>
    <span class="identifier">method</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">got_attribute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'clf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">got_attribute</span>


<span class="keyword">def</span> <span class="identifier">test_feature_union</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># basic sanity check for feature union</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">svd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">select</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"svd", svd), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>

    <span class="comment"># check if it does the expected thing</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">svd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">select</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># test if it also works for sparse input</span>
    <span class="comment"># We use a different svd object to control the random_state stream</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"svd", svd), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_sp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_sp_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_sp</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_sp_transformed</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Test clone</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fs2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">fs</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="identifier">fs2</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># test setting parameters</span>
    <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">select__k</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>

    <span class="comment"># test it works with transformers missing fit_transform</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"mock", Transf()), ("svd", svd), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span>

    <span class="comment"># test error if some elements do not support transform</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'All estimators should implement fit and transform.*\\bNoTrans\\b'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"transform", Transf()), ("no_transform"</span><span class="punctuation">,</span> <span class="identifier">NoTrans</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test that init accepts tuples</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">"svd", svd), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_make_union</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="identifier">mock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">fu</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_union</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">,</span> <span class="identifier">mock</span><span class="grouping">)</span>
    <span class="identifier">names</span><span class="punctuation">,</span> <span class="identifier">transformers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">fu</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">names</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">"pca", "transf"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">transformers</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">,</span> <span class="identifier">mock</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_make_union_kwargs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="identifier">mock</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">fu</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_union</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">,</span> <span class="identifier">mock</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">fu</span><span class="punctuation">.</span><span class="identifier">transformer_list</span> <span class="relational-operator">==</span> <span class="identifier">make_union</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">,</span> <span class="identifier">mock</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transformer_list</span>
    <span class="keyword">assert</span> <span class="int-literal">3</span> <span class="relational-operator">==</span> <span class="identifier">fu</span><span class="punctuation">.</span><span class="identifier">n_jobs</span>

    <span class="comment"># invalid keyword parameters should raise an error message</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"make_union() got an unexpected keyword argument 'transformer_weights'"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">make_union</span><span class="grouping">(</span><span class="identifier">pca</span><span class="punctuation">,</span> <span class="identifier">mock</span><span class="punctuation">,</span> <span class="identifier">transformer_weights</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'pca': 10, 'Transf'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test whether pipeline works with a transformer at the end.</span>
    <span class="comment"># Also test pipeline.transform and pipeline.inverse_transform</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'pca'</span><span class="punctuation">,</span> <span class="identifier">pca</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test transform and fit_transform:</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_trans2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_trans3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_trans2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_trans3</span><span class="grouping">)</span>

    <span class="identifier">X_back</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>
    <span class="identifier">X_back2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_back</span><span class="punctuation">,</span> <span class="identifier">X_back2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_fit_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test whether pipeline works with a transformer missing fit_transform</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">transf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">transf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># test fit_transform:</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_trans2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_trans2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"start, end"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
                                        <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pipeline_slice</span><span class="grouping">(</span><span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">end</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"transf1", Transf()), ("transf2", Transf()), ("clf"</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="string-literal">"123"</span><span class="punctuation">,</span>
        <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe_slice</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="grouping">]</span>
    <span class="comment"># Test class</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">pipe_slice</span><span class="punctuation">,</span> <span class="identifier">Pipeline</span><span class="grouping">)</span>
    <span class="comment"># Test steps</span>
    <span class="keyword">assert</span> <span class="identifier">pipe_slice</span><span class="punctuation">.</span><span class="identifier">steps</span> <span class="relational-operator">==</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="grouping">]</span>
    <span class="comment"># Test named_steps attribute</span>
    <span class="keyword">assert</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">pipe_slice</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">list</span><span class="grouping">(</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="grouping">]</span>
    <span class="comment"># Test the rest of the parameters</span>
    <span class="identifier">pipe_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">pipe_slice_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe_slice</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">del</span> <span class="identifier">pipe_params</span><span class="grouping">[</span><span class="string-literal">"steps"</span><span class="grouping">]</span>
    <span class="keyword">del</span> <span class="identifier">pipe_slice_params</span><span class="grouping">[</span><span class="string-literal">"steps"</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">pipe_params</span> <span class="relational-operator">==</span> <span class="identifier">pipe_slice_params</span>
    <span class="comment"># Test exception</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Pipeline slicing only supports a step of 1"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span><span class="identifier">end</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_index</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">transf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', transf), ('clf'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">transf</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">transf</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">clf</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="grouping">[</span><span class="string-literal">'clf'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">clf</span>

    <span class="comment"># should raise an error if slicing out of range</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">IndexError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span>

    <span class="comment"># should raise an error if indexing with wrong element name</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">KeyError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="grouping">[</span><span class="string-literal">'foobar'</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_set_pipeline_steps</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">transf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">transf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">transf1</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'mock'</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">transf1</span>

    <span class="comment"># Directly setting attr</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock2'</span><span class="punctuation">,</span> <span class="identifier">transf2</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="string-literal">'mock'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'mock2'</span><span class="grouping">]</span> <span class="relational-operator">is</span> <span class="identifier">transf2</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock2'</span><span class="punctuation">,</span> <span class="identifier">transf2</span><span class="grouping">)</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span>

    <span class="comment"># Using set_params</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">transf1</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">transf1</span><span class="grouping">)</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span>

    <span class="comment"># Using set_params to replace single step</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">mock</span><span class="arithmetic-assignment">=</span><span class="identifier">transf2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">transf2</span><span class="grouping">)</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span>

    <span class="comment"># With invalid data</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'junk'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Last step of Pipeline should implement fit or be the "</span>
        <span class="string-literal">"string 'passthrough'."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_named_steps</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">transf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">mult2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">transf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"mult"</span><span class="punctuation">,</span> <span class="identifier">mult2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Test access via named_steps bunch object</span>
    <span class="keyword">assert</span> <span class="string-literal">'mock'</span> <span class="relational-operator">in</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span>
    <span class="keyword">assert</span> <span class="string-literal">'mock2'</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="punctuation">.</span><span class="identifier">mock</span> <span class="relational-operator">is</span> <span class="identifier">transf</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="punctuation">.</span><span class="identifier">mult</span> <span class="relational-operator">is</span> <span class="identifier">mult2</span>

    <span class="comment"># Test bunch with conflict attribute of dict</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'values'</span><span class="punctuation">,</span> <span class="identifier">transf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="string-literal">"mult"</span><span class="punctuation">,</span> <span class="identifier">mult2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="punctuation">.</span><span class="identifier">values</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="identifier">transf</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="punctuation">.</span><span class="identifier">mult</span> <span class="relational-operator">is</span> <span class="identifier">mult2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'passthrough', [None, 'passthrough'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pipeline_correctly_adjusts_steps</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">mult2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">mult3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">mult5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'m2'</span><span class="punctuation">,</span> <span class="identifier">mult2</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'bad'</span><span class="punctuation">,</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'m3'</span><span class="punctuation">,</span> <span class="identifier">mult3</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'m5'</span><span class="punctuation">,</span> <span class="identifier">mult5</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">expected_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'m2', 'bad', 'm3', 'm5'</span><span class="grouping">]</span>
    <span class="identifier">actual_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">name</span> <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">expected_names</span> <span class="relational-operator">==</span> <span class="identifier">actual_names</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'passthrough', [None, 'passthrough'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_set_pipeline_step_passthrough</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">mult2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">mult3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">mult5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="identifier">mult</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">make</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'m2', mult2), ('m3', mult3), ('last'</span><span class="punctuation">,</span> <span class="identifier">mult5</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">exp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">m3</span><span class="arithmetic-assignment">=</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span>
    <span class="identifier">exp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="identifier">deep</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span>
            <span class="grouping">{</span><span class="string-literal">'steps'</span><span class="punctuation">:</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="punctuation">,</span>
             <span class="string-literal">'m2'</span><span class="punctuation">:</span> <span class="identifier">mult2</span><span class="punctuation">,</span>
             <span class="string-literal">'m3'</span><span class="punctuation">:</span> <span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="punctuation">,</span>
             <span class="string-literal">'last'</span><span class="punctuation">:</span> <span class="identifier">mult5</span><span class="punctuation">,</span>
             <span class="string-literal">'memory'</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="punctuation">,</span>
             <span class="string-literal">'m2__mult'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">,</span>
             <span class="string-literal">'last__mult'</span><span class="punctuation">:</span> <span class="int-literal">5</span><span class="punctuation">,</span>
             <span class="string-literal">'verbose'</span><span class="punctuation">:</span> <span class="bool-literal">False</span>
             <span class="grouping">}</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">m2</span><span class="arithmetic-assignment">=</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span>
    <span class="identifier">exp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># for other methods, ensure no AttributeErrors on None:</span>
    <span class="identifier">other_methods</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'predict_proba', 'predict_log_proba'</span><span class="punctuation">,</span>
                     <span class="string-literal">'decision_function', 'transform', 'score'</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">other_methods</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">m2</span><span class="arithmetic-assignment">=</span><span class="identifier">mult2</span><span class="grouping">)</span>
    <span class="identifier">exp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">last</span><span class="arithmetic-assignment">=</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span>
    <span class="comment"># mult2 and mult3 are active</span>
    <span class="identifier">exp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"'str' object has no attribute 'predict'"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span>

    <span class="comment"># Check 'passthrough' step at construction time</span>
    <span class="identifier">exp</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'m2', mult2), ('m3', passthrough), ('last'</span><span class="punctuation">,</span> <span class="identifier">mult5</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">exp</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_ducktyping</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">predict</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">transform</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">transform</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="string-literal">'passthrough'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">'passthrough', 'passthrough'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">transform</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">NoInvTransf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">transform</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'inverse_transform'</span><span class="grouping">)</span>

    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">NoInvTransf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'predict'</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">transform</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="punctuation">,</span> <span class="string-literal">'inverse_transform'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_make_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">t1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">t2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">t1</span><span class="punctuation">,</span> <span class="identifier">t2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">Pipeline</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"transf-1"</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"transf-2"</span>

    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">t1</span><span class="punctuation">,</span> <span class="identifier">t2</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="identifier">Pipeline</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"transf-1"</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"transf-2"</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"fitparamt"</span>


<span class="keyword">def</span> <span class="identifier">test_feature_union_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test feature union with transformer weights</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">svd_solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'randomized'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">select</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># test using fit followed by transform</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"pca", pca), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">transformer_weights</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">"pca"</span><span class="punctuation">:</span> <span class="int-literal">10</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># test using fit_transform</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"pca", pca), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">transformer_weights</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">"pca"</span><span class="punctuation">:</span> <span class="int-literal">10</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">X_fit_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># test it works with transformers missing fit_transform</span>
    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"mock", Transf()), ("pca", pca), ("select"</span><span class="punctuation">,</span> <span class="identifier">select</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">transformer_weights</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">"mock"</span><span class="punctuation">:</span> <span class="int-literal">10</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">X_fit_transformed_wo_method</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># check against expected result</span>

    <span class="comment"># We use a different pca object to control the random_state stream</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">select</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_fit_transformed</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_fit_transformed</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">select</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_fit_transformed_wo_method</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_feature_union_parallel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that n_jobs work for FeatureUnion</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">JUNK_FOOD_DOCS</span>

    <span class="identifier">fs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">"words"</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'word'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"chars"</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">fs_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">"words"</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'word'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"chars"</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="identifier">fs_parallel2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">"words"</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'word'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"chars"</span><span class="punctuation">,</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">'char'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">fs_parallel</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_transformed_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs_parallel</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">X_transformed_parallel</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">X_transformed_parallel</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="comment"># fit_transform should behave the same</span>
    <span class="identifier">X_transformed_parallel2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs_parallel2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">X_transformed_parallel2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">)</span>

    <span class="comment"># transformers should stay fit after fit_transform</span>
    <span class="identifier">X_transformed_parallel2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fs_parallel2</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">X_transformed_parallel2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_feature_union_feature_names</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">word_vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">"word"</span><span class="grouping">)</span>
    <span class="identifier">char_vect</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CountVectorizer</span><span class="grouping">(</span><span class="identifier">analyzer</span><span class="arithmetic-assignment">=</span><span class="string-literal">"char_wb"</span><span class="punctuation">,</span> <span class="identifier">ngram_range</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"chars", char_vect), ("words"</span><span class="punctuation">,</span> <span class="identifier">word_vect</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">JUNK_FOOD_DOCS</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">feat</span> <span class="relational-operator">in</span> <span class="identifier">feature_names</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="string-literal">"chars__" in feat or "words__"</span> <span class="relational-operator">in</span> <span class="identifier">feat</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">feature_names</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">35</span>

    <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"tr1"</span><span class="punctuation">,</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">'Transformer tr1 (type Transf) does not provide get_feature_names'</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_classes_property</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">,</span> <span class="string-literal">'classes_'</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'classes_'</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_set_feature_union_steps</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">mult2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">mult2</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="string-literal">'x2'</span><span class="grouping">]</span>
    <span class="identifier">mult3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">mult3</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="string-literal">'x3'</span><span class="grouping">]</span>
    <span class="identifier">mult5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="identifier">mult5</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="string-literal">'x5'</span><span class="grouping">]</span>

    <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'m2', mult2), ('m3'</span><span class="punctuation">,</span> <span class="identifier">mult3</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'m2__x2', 'm3__x3'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Directly setting attr</span>
    <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">transformer_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'m5'</span><span class="punctuation">,</span> <span class="identifier">mult5</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'m5__x5'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Using set_params</span>
    <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">transformer_list</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mock'</span><span class="punctuation">,</span> <span class="identifier">mult3</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'mock__x3'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Using set_params to replace single step</span>
    <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">mock</span><span class="arithmetic-assignment">=</span><span class="identifier">mult5</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'mock__x5'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_set_feature_union_step_drop</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">mult2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">mult2</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="string-literal">'x2'</span><span class="grouping">]</span>
    <span class="identifier">mult3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">mult3</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span> <span class="arithmetic-assignment">=</span> <span class="keyword">lambda</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="string-literal">'x3'</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'m2', mult2), ('m3'</span><span class="punctuation">,</span> <span class="identifier">mult3</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'m2__x2', 'm3__x3'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">m2</span><span class="arithmetic-assignment">=</span><span class="string-literal">'drop'</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'m3__x3'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">record</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">m3</span><span class="arithmetic-assignment">=</span><span class="string-literal">'drop'</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">record</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="comment"># check we can change back</span>
        <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">m3</span><span class="arithmetic-assignment">=</span><span class="identifier">mult3</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">record</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">record</span><span class="punctuation">:</span>
        <span class="comment"># Check 'drop' step at construction time</span>
        <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'m2', 'drop'), ('m3'</span><span class="punctuation">,</span> <span class="identifier">mult3</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">'m3__x3'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">ft</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">record</span>


<span class="keyword">def</span> <span class="identifier">test_step_name_validation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">error_message_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"Estimator names must not contain __: got \['a__q'\]"</span>
    <span class="identifier">error_message_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"Names provided are not unique: \['a', 'a'\]"</span>
    <span class="identifier">error_message_3</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">r</span><span class="string-literal">"Estimator names conflict with constructor arguments: \['%s'\]"</span>
    <span class="grouping">)</span>
    <span class="identifier">bad_steps1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'a__q', Mult(2)), ('b'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">bad_steps2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'a', Mult(2)), ('a'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">param</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">Pipeline</span><span class="punctuation">,</span> <span class="string-literal">'steps'</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="grouping">(</span><span class="identifier">FeatureUnion</span><span class="punctuation">,</span> <span class="string-literal">'transformer_list'</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># we validate in construction (despite scikit-learn convention)</span>
        <span class="identifier">bad_steps3</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'a'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">param</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">bad_steps</span><span class="punctuation">,</span> <span class="identifier">message</span> <span class="relational-operator">in</span> <span class="grouping">[</span>
            <span class="grouping">(</span><span class="identifier">bad_steps1</span><span class="punctuation">,</span> <span class="identifier">error_message_1</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">bad_steps2</span><span class="punctuation">,</span> <span class="identifier">error_message_2</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">bad_steps3</span><span class="punctuation">,</span> <span class="identifier">error_message_3</span> <span class="arithmetic-operator">%</span> <span class="identifier">param</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">]</span><span class="punctuation">:</span>
            <span class="comment"># three ways to make invalid:</span>
            <span class="comment"># - construction</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">cls</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">param</span><span class="punctuation">:</span> <span class="identifier">bad_steps</span><span class="grouping">}</span><span class="grouping">)</span>

            <span class="comment"># - setattr</span>
            <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">param</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'a'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
            <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">param</span><span class="punctuation">,</span> <span class="identifier">bad_steps</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="comment"># - set_params</span>
            <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">param</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'a'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">param</span><span class="punctuation">:</span> <span class="identifier">bad_steps</span><span class="grouping">}</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_set_params_nested_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'a'</span><span class="punctuation">,</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
            <span class="grouping">(</span><span class="string-literal">'b'</span><span class="punctuation">,</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">a__b__alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">a__b</span><span class="arithmetic-assignment">=</span><span class="identifier">Lasso</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">a__steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'b'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">a__b__C</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_wrong_memory</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that an error is raised when memory is not a string or a Memory</span>
    <span class="comment"># instance</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="comment"># Define memory as an integer</span>
    <span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">cached_pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf'</span><span class="punctuation">,</span> <span class="identifier">DummyTransf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="grouping">(</span><span class="string-literal">'svc'</span><span class="punctuation">,</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">memory</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"'memory' should be None, a string or have the same interface "</span>
        <span class="string-literal">"as joblib.Memory. Got memory='1' instead."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">DummyMemory</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">cache</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">func</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">func</span>


<span class="keyword">class</span> <span class="identifier">WrongDummyMemory</span><span class="punctuation">:</span>
    <span class="keyword">pass</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_with_cache_attribute</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">DummyMemory</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">dummy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">WrongDummyMemory</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">dummy</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"'memory' should be None, a string or have the same interface "</span>
        <span class="identifier">f</span><span class="string-literal">"as joblib.Memory. Got memory='{dummy}' instead."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_memory</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">cachedir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mkdtemp</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'0.12'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Deal with change of API in joblib</span>
            <span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="arithmetic-assignment">=</span><span class="identifier">cachedir</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">location</span><span class="arithmetic-assignment">=</span><span class="identifier">cachedir</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="comment"># Test with Transformer + SVC</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">probability</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">transf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyTransf</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', clone(transf)), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">cached_pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', transf), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">memory</span><span class="grouping">)</span>

        <span class="comment"># Memoize the transformer at the first fit</span>
        <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># Get the time stamp of the transformer in the cached pipeline</span>
        <span class="identifier">ts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">timestamp_</span>
        <span class="comment"># Check that cached_pipe and pipe yield identical results</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">transf</span><span class="punctuation">,</span> <span class="string-literal">'means_'</span><span class="grouping">)</span>
        <span class="comment"># Check that we are reading the cache while fitting</span>
        <span class="comment"># a second time</span>
        <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># Check that cached_pipe and pipe yield identical results</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ts</span> <span class="relational-operator">==</span> <span class="identifier">cached_pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">timestamp_</span>
        <span class="comment"># Create a new pipeline with cloned estimators</span>
        <span class="comment"># Check that even changing the name step does not affect the cache hit</span>
        <span class="identifier">clf_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">probability</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">transf_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyTransf</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">cached_pipe_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf_2', transf_2), ('svc'</span><span class="punctuation">,</span> <span class="identifier">clf_2</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                                 <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">memory</span><span class="grouping">)</span>
        <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># Check that cached_pipe and pipe yield identical results</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span>
                           <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf_2'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ts</span> <span class="relational-operator">==</span> <span class="identifier">cached_pipe_2</span><span class="punctuation">.</span><span class="identifier">named_steps</span><span class="grouping">[</span><span class="string-literal">'transf_2'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">timestamp_</span>
    <span class="keyword">finally</span><span class="punctuation">:</span>
        <span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">rmtree</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_make_pipeline_memory</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cachedir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mkdtemp</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'0.12'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Deal with change of API in joblib</span>
        <span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="arithmetic-assignment">=</span><span class="identifier">cachedir</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">memory</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">location</span><span class="arithmetic-assignment">=</span><span class="identifier">cachedir</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">DummyTransf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">memory</span><span class="arithmetic-assignment">=</span><span class="identifier">memory</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">memory</span> <span class="relational-operator">is</span> <span class="identifier">memory</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">DummyTransf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">memory</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">rmtree</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_param_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Pipeline.fit does not accept "</span>
                                         <span class="string-literal">"the sample_weight parameter"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="identifier">parameter_grid_test_verbose</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">pattern</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span> <span class="keyword">for</span>
                               <span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">pattern</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">product</span><span class="grouping">(</span>
    <span class="grouping">[</span>
     <span class="grouping">(</span><span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 2 of 2\) Processing clf.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('noop'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 1 of 3\) Processing transf.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 2 of 3\) Processing noop.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 3 of 3\) Processing clf.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('noop', 'passthrough'</span><span class="grouping">)</span><span class="punctuation">,</span>
               <span class="grouping">(</span><span class="string-literal">'clf'</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 1 of 3\) Processing transf.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 2 of 3\) Processing noop.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 3 of 3\) Processing clf.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', Transf()), ('clf'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 2 of 2\) Processing clf.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', None), ('mult'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 2 of 2\) Processing mult.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf', 'passthrough'), ('mult'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[Pipeline\].*\(step 2 of 2\) Processing mult.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mult1', Mult()), ('mult2'</span><span class="punctuation">,</span> <span class="identifier">Mult</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[FeatureUnion\].*\(step 1 of 2\) Processing mult1.* total=.*\n'</span>
      <span class="identifier">r</span><span class="string-literal">'\[FeatureUnion\].*\(step 2 of 2\) Processing mult2.* total=.*\n$'</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mult1', 'drop'), ('mult2', Mult()), ('mult3', 'drop'</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
      <span class="identifier">r</span><span class="string-literal">'\[FeatureUnion\].*\(step 1 of 1\) Processing mult2.* total=.*\n$'</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'fit', 'fit_transform', 'fit_predict'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="grouping">(</span>
        <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'fit_transform' and hasattr(est, 'steps'</span><span class="grouping">)</span> <span class="logical-operator">and</span>
        <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">FitParamT</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'est, pattern, method'</span><span class="punctuation">,</span> <span class="identifier">parameter_grid_test_verbose</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_verbose</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="punctuation">,</span> <span class="identifier">pattern</span><span class="punctuation">,</span> <span class="identifier">capsys</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">capsys</span><span class="punctuation">.</span><span class="identifier">readouterr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="string-literal">'Got output for verbose=False'</span>

    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">func</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">match</span><span class="grouping">(</span><span class="identifier">pattern</span><span class="punctuation">,</span> <span class="identifier">capsys</span><span class="punctuation">.</span><span class="identifier">readouterr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">out</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_n_features_in_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure pipelines delegate n_features_in to the first step</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">ss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">ss</span><span class="punctuation">,</span> <span class="identifier">gbdt</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">ss</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="comment"># if the first step has the n_features_in attribute then the pipeline also</span>
    <span class="comment"># has it, even though it isn't fitted.</span>
    <span class="identifier">ss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">gbdt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">HistGradientBoostingClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">ss</span><span class="punctuation">,</span> <span class="identifier">gbdt</span><span class="grouping">)</span>
    <span class="identifier">ss</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">ss</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">gbdt</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_n_features_in_feature_union</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure FeatureUnion delegates n_features_in to the first transformer</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">ss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">fu</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_union</span><span class="grouping">(</span><span class="identifier">ss</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">fu</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">fu</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">fu</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">ss</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="comment"># if the first step has the n_features_in attribute then the feature_union</span>
    <span class="comment"># also has it, even though it isn't fitted.</span>
    <span class="identifier">ss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">fu</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_union</span><span class="grouping">(</span><span class="identifier">ss</span><span class="grouping">)</span>
    <span class="identifier">ss</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">fu</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="identifier">ss</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>


<span class="keyword">def</span> <span class="identifier">test_feature_union_fit_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test for issue: #15117</span>
    <span class="keyword">class</span> <span class="identifier">Dummy</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">fit_params</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">fit_params</span> <span class="relational-operator">!=</span> <span class="grouping">{</span><span class="string-literal">'a'</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="grouping">}</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

        <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">X</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'dummy0', Dummy()), ('dummy1'</span><span class="punctuation">,</span> <span class="identifier">Dummy</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">a</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">a</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pipeline_missing_values_leniency</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check that pipeline let the missing values validation to</span>
    <span class="comment"># the underlying transformers and predictors.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">.9</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.4</span>


<span class="keyword">def</span> <span class="identifier">test_feature_union_warns_unknown_transformer_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Warn user when transformer_weights containers a key not present in</span>
    <span class="comment"># transformer_list</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">transformer_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'transf'</span><span class="punctuation">,</span> <span class="identifier">Transf</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="comment"># Transformer weights dictionary with incorrect name</span>
    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'transformer'</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span>
    <span class="identifier">expected_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'Attempting to weight transformer "transformer", '</span>
                    <span class="string-literal">'but it is not present in transformer_list.'</span><span class="grouping">)</span>
    <span class="identifier">union</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="identifier">transformer_list</span><span class="punctuation">,</span> <span class="identifier">transformer_weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">union</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'passthrough', [None, 'passthrough'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_pipeline_get_tags_none</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks that tags are set correctly when the first transformer is None or</span>
    <span class="comment"># 'passthrough'</span>
    <span class="comment"># Non-regression test for:</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/18815</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">g</span><span class="invalid">h</span><span class="punctuation">,</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">_get_tags</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="string-literal">'pairwise'</span><span class="grouping">]</span>


<span class="comment"># FIXME: Replace this test with a full `check_estimator` once we have API only</span>
<span class="comment"># checks.</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Predictor"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">MinimalRegressor</span><span class="punctuation">,</span> <span class="identifier">MinimalClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_search_cv_using_minimal_compatible_estimator</span><span class="grouping">(</span><span class="identifier">Predictor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that third-party library estimators can be part of a pipeline</span>
    <span class="comment"># and tuned by grid-search without inheriting from BaseEstimator.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">25</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">20</span><span class="grouping">)</span>

    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">"transformer", MinimalTransformer()), ("predictor"</span><span class="punctuation">,</span> <span class="identifier">Predictor</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">model</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">accuracy_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">r2_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>