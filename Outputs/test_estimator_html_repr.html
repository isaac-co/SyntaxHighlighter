<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">contextlib</span> <span class="keyword">import</span> <span class="identifier">closing</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">StringIO</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">config_context</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neural_network</span> <span class="keyword">import</span> <span class="identifier">MLPClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">impute</span> <span class="keyword">import</span> <span class="identifier">SimpleImputer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">PCA</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">TruncatedSVD</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">FeatureUnion</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">ColumnTransformer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">VotingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_selection</span> <span class="keyword">import</span> <span class="identifier">SelectPercentile</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">Birch</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">AgglomerativeClustering</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">OneHotEncoder</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">LinearSVR</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">multiclass</span> <span class="keyword">import</span> <span class="identifier">OneVsOneClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">StackingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">StackingRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span> <span class="keyword">import</span> <span class="identifier">GaussianProcessRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span><span class="punctuation">.</span><span class="identifier">kernels</span> <span class="keyword">import</span> <span class="identifier">RationalQuadratic</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_estimator_html_repr</span> <span class="keyword">import</span> <span class="identifier">_write_label_html</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_estimator_html_repr</span> <span class="keyword">import</span> <span class="identifier">_get_visual_block</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_estimator_html_repr</span> <span class="keyword">import</span> <span class="identifier">estimator_html_repr</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"checked"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_write_label_html</span><span class="grouping">(</span><span class="identifier">checked</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test checking logic and labeling</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"LogisticRegression"</span>
    <span class="identifier">tool_tip</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"hello-world"</span>

    <span class="keyword">with</span> <span class="identifier">closing</span><span class="grouping">(</span><span class="identifier">StringIO</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">out</span><span class="punctuation">:</span>
        <span class="identifier">_write_label_html</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">tool_tip</span><span class="punctuation">,</span> <span class="identifier">checked</span><span class="arithmetic-assignment">=</span><span class="identifier">checked</span><span class="grouping">)</span>
        <span class="identifier">html_label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span><span class="punctuation">.</span><span class="identifier">getvalue</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="string-literal">'LogisticRegression&lt;/label&gt;'</span> <span class="relational-operator">in</span> <span class="identifier">html_label</span>
        <span class="keyword">assert</span> <span class="identifier">html_label</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">'&lt;div class="sk-label-container"&gt;'</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="string-literal">'&lt;pre&gt;hello-world&lt;/pre&gt;'</span> <span class="relational-operator">in</span> <span class="identifier">html_label</span>
        <span class="keyword">if</span> <span class="identifier">checked</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="string-literal">'checked&gt;'</span> <span class="relational-operator">in</span> <span class="identifier">html_label</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'est', ['passthrough', 'drop'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_get_visual_block_single_str_none</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test estimators that are represnted by strings</span>
    <span class="identifier">est_html_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_visual_block</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'single'</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">estimators</span> <span class="relational-operator">==</span> <span class="identifier">est</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">names</span> <span class="relational-operator">==</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">name_details</span> <span class="relational-operator">==</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_get_visual_block_single_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="float-literal">10.0</span><span class="grouping">)</span>
    <span class="identifier">est_html_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_visual_block</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'single'</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">estimators</span> <span class="relational-operator">==</span> <span class="identifier">est</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">names</span> <span class="relational-operator">==</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">name_details</span> <span class="relational-operator">==</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_get_visual_block_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'imputer'</span><span class="punctuation">,</span> <span class="identifier">SimpleImputer</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'do_nothing', 'passthrough'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'do_nothing_more'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'classifier'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est_html_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_visual_block</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'serial'</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">estimators</span> <span class="relational-operator">==</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">step</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">step</span> <span class="relational-operator">in</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">names</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="string-literal">'imputer: SimpleImputer'</span><span class="punctuation">,</span>
                                   <span class="string-literal">'do_nothing: passthrough'</span><span class="punctuation">,</span>
                                   <span class="string-literal">'do_nothing_more: passthrough'</span><span class="punctuation">,</span>
                                   <span class="string-literal">'classifier: LogisticRegression'</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">name_details</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_get_visual_block_feature_union</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">f_union</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'pca', PCA()), ('svd'</span><span class="punctuation">,</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est_html_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_visual_block</span><span class="grouping">(</span><span class="identifier">f_union</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'parallel'</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">names</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">'pca', 'svd'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">estimators</span> <span class="relational-operator">==</span> <span class="identifier">tuple</span><span class="grouping">(</span>
        <span class="identifier">trans</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">trans</span> <span class="relational-operator">in</span> <span class="identifier">f_union</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">name_details</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_get_visual_block_voting</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">VotingClassifier</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'log_reg'</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'mlp'</span><span class="punctuation">,</span> <span class="identifier">MLPClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est_html_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_visual_block</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'parallel'</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">estimators</span> <span class="relational-operator">==</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">trans</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
                                             <span class="keyword">for</span> <span class="identifier">trans</span> <span class="relational-operator">in</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">names</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">'log_reg', 'mlp'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">name_details</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_get_visual_block_column_transformer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">ct</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ColumnTransformer</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'pca', PCA(), ['num1', 'num2'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'svd'</span><span class="punctuation">,</span> <span class="identifier">TruncatedSVD</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est_html_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_visual_block</span><span class="grouping">(</span><span class="identifier">ct</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'parallel'</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">estimators</span> <span class="relational-operator">==</span> <span class="identifier">tuple</span><span class="grouping">(</span>
        <span class="identifier">trans</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">trans</span> <span class="relational-operator">in</span> <span class="identifier">ct</span><span class="punctuation">.</span><span class="identifier">transformers</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">names</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="string-literal">'pca', 'svd'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est_html_info</span><span class="punctuation">.</span><span class="identifier">name_details</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'num1', 'num2'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_estimator_html_repr_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">num_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'pass', 'passthrough'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'imputer', SimpleImputer(strategy='median'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">cat_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'imputer', SimpleImputer(strategy='constant'</span><span class="punctuation">,</span>
                                  <span class="identifier">missing_values</span><span class="arithmetic-assignment">=</span><span class="string-literal">'empty'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'one-hot', OneHotEncoder(drop='first'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">preprocess</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ColumnTransformer</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'num', num_trans, ['a', 'b', 'c', 'd', 'e'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'cat'</span><span class="punctuation">,</span> <span class="identifier">cat_trans</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">feat_u</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FeatureUnion</span><span class="grouping">(</span><span class="grouping">[</span>
            <span class="grouping">(</span><span class="string-literal">'pca'</span><span class="punctuation">,</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="string-literal">'tsvd', Pipeline([('first'</span><span class="punctuation">,</span> <span class="identifier">TruncatedSVD</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="grouping">(</span><span class="string-literal">'select'</span><span class="punctuation">,</span> <span class="identifier">SelectPercentile</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">VotingClassifier</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'lr', LogisticRegression(solver='lbfgs'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">'mlp'</span><span class="punctuation">,</span> <span class="identifier">MLPClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">(</span><span class="string-literal">'preprocessor', preprocess), ('feat_u', feat_u), ('classifier'</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="grouping">)</span>

    <span class="comment"># top level estimators show estimator with changes</span>
    <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"&lt;div class=\"sk-toggleable__content\"&gt;"</span>
                <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(est)}"</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

    <span class="comment"># low level estimators do not show changes</span>
    <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">print_changed_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">num_trans</span><span class="grouping">[</span><span class="string-literal">'pass'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
        <span class="keyword">assert</span> <span class="string-literal">'passthrough&lt;/label&gt;'</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
        <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">num_trans</span><span class="grouping">[</span><span class="string-literal">'imputer'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="relational-operator">in</span> <span class="identifier">preprocess</span><span class="punctuation">.</span><span class="identifier">transformers</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{cols}&lt;/pre&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

        <span class="comment"># feature union</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">feat_u</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;label&gt;{name}&lt;/label&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

        <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">feat_u</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(pca)}&lt;/pre&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

        <span class="identifier">tsvd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">feat_u</span><span class="punctuation">.</span><span class="identifier">transformer_list</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">first</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="grouping">[</span><span class="string-literal">'first'</span><span class="grouping">]</span>
        <span class="identifier">select</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tsvd</span><span class="grouping">[</span><span class="string-literal">'select'</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(first)}&lt;/pre&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(select)}&lt;/pre&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

        <span class="comment"># voting classifer</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">est</span> <span class="relational-operator">in</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;label&gt;{name}&lt;/label&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
            <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(est)}&lt;/pre&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"final_estimator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_classsifer</span><span class="grouping">(</span><span class="identifier">final_estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'mlp'</span><span class="punctuation">,</span> <span class="identifier">MLPClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="grouping">(</span><span class="string-literal">'tree'</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingClassifier</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">final_estimator</span><span class="grouping">)</span>

    <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="comment"># If final_estimator's default changes from LogisticRegression</span>
    <span class="comment"># this should be updated</span>
    <span class="keyword">if</span> <span class="identifier">final_estimator</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="string-literal">"LogisticRegression("</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">final_estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"final_estimator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_stacking_regressor</span><span class="grouping">(</span><span class="identifier">final_estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StackingRegressor</span><span class="grouping">(</span>
        <span class="identifier">estimators</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">'svr'</span><span class="punctuation">,</span> <span class="identifier">LinearSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">final_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">final_estimator</span><span class="grouping">)</span>
    <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">reg</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">estimators</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="keyword">assert</span> <span class="string-literal">"LinearSVR&lt;/label&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="keyword">if</span> <span class="identifier">final_estimator</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="string-literal">"RidgeCV&lt;/label&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">final_estimator</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>


<span class="keyword">def</span> <span class="identifier">test_birch_duck_typing_meta</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test duck typing meta estimators with Birch</span>
    <span class="identifier">birch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Birch</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">AgglomerativeClustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">birch</span><span class="grouping">)</span>

    <span class="comment"># inner estimators do not show changes</span>
    <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">print_changed_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(birch.n_clusters)}"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
        <span class="keyword">assert</span> <span class="string-literal">"AgglomerativeClustering&lt;/label&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

    <span class="comment"># outer estimator contains all changes</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(birch)}"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>


<span class="keyword">def</span> <span class="identifier">test_ovo_classifier_duck_typing_meta</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test duck typing metaestimators with OVO</span>
    <span class="identifier">ovo</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OneVsOneClassifier</span><span class="grouping">(</span><span class="identifier">LinearSVC</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">ovo</span><span class="grouping">)</span>

    <span class="comment"># inner estimators do not show changes</span>
    <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">print_changed_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(ovo.estimator)}"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
        <span class="keyword">assert</span> <span class="string-literal">"LinearSVC&lt;/label&gt;"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

    <span class="comment"># outter estimator</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(ovo)}"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>


<span class="keyword">def</span> <span class="identifier">test_duck_typing_nested_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test duck typing metaestimators with GP</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RationalQuadratic</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">gp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GaussianProcessRegressor</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span>
    <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">gp</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(kernel)}"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="string-literal">"&lt;pre&gt;{str(gp)}"</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'print_changed_only'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_one_estimator_print_change_only</span><span class="grouping">(</span><span class="identifier">print_changed_only</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">config_context</span><span class="grouping">(</span><span class="identifier">print_changed_only</span><span class="arithmetic-assignment">=</span><span class="identifier">print_changed_only</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pca_repr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">pca</span><span class="grouping">)</span>
        <span class="identifier">html_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_html_repr</span><span class="grouping">(</span><span class="identifier">pca</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">pca_repr</span> <span class="relational-operator">in</span> <span class="identifier">html_output</span>

    </pre>
  </body>
</html>