<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin python3</span>
<span class="comment">""" Process wrapper for underlying faceswap commands for the GUI """</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">import</span> <span class="identifier">signal</span>
<span class="keyword">from</span> <span class="identifier">subprocess</span> <span class="keyword">import</span> <span class="identifier">PIPE</span><span class="punctuation">,</span> <span class="identifier">Popen</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">from</span> <span class="identifier">threading</span> <span class="keyword">import</span> <span class="identifier">Thread</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>

<span class="keyword">import</span> <span class="identifier">psutil</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">analysis</span> <span class="keyword">import</span> <span class="identifier">Session</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_config</span><span class="punctuation">,</span> <span class="identifier">get_images</span><span class="punctuation">,</span> <span class="identifier">LongRunningTask</span><span class="punctuation">,</span> <span class="identifier">preview_trigger</span>

<span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">"nt"</span><span class="punctuation">:</span>
    <span class="keyword">import</span> <span class="identifier">win32console</span>  <span class="comment"># pylint: disable=import-error</span>


<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">ProcessWrapper</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Builds command, launches and terminates the underlying
        faceswap process. Updates GUI display depending on state """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tk_vars</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">set_callbacks</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pathscript</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">realpath</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">statusbar</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_session_location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">task</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FaceswapControl</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">set_callbacks</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the tkinter variable callbacks """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting tk variable traces"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"action"].trace("w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">action_command</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"generate"].trace("w"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generate_command</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">action_command</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The action to perform when the action button is pressed """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"action"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">category</span><span class="punctuation">,</span> <span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"action"].get().split(","</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"runningtask"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">task</span><span class="punctuation">.</span><span class="identifier">terminate</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="identifier">command</span>
            <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">prepare</span><span class="grouping">(</span><span class="identifier">category</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">task</span><span class="punctuation">.</span><span class="identifier">execute_script</span><span class="grouping">(</span><span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"action"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">generate_command</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Generate the command line arguments and output """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"generate"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">category</span><span class="punctuation">,</span> <span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"generate"].get().split(","</span><span class="grouping">)</span>
        <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">build_args</span><span class="grouping">(</span><span class="identifier">category</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">generate</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"console_clear"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">" "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">args</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">" "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">args</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"generate"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">prepare</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">category</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Prepare the environment for execution """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Preparing for execution"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"runningtask"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"console_clear"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"istraining"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Loading..."</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">message</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="string-literal">"Executing - {}.py"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">mode</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"indeterminate" if self.command in ("effmpeg", "train") else "determinate"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="identifier">mode</span><span class="grouping">)</span>

        <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">build_args</span><span class="grouping">(</span><span class="identifier">category</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"display"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Prepared for execution"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">args</span>

    <span class="keyword">def</span> <span class="identifier">build_args</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">category</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">generate</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Build the faceswap command and arguments list.

        If training, pass the model folder and name to the training
        :class:`lib.gui.analysis.Session` for the GUI.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Build cli arguments: (category: %s, command: %s, generate: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">category</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">generate</span><span class="grouping">)</span>
        <span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">command</span> <span class="keyword">else</span> <span class="identifier">command</span>
        <span class="identifier">script</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}.{}".format(category, "py"</span><span class="grouping">)</span>
        <span class="identifier">pathexecscript</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pathscript</span><span class="punctuation">,</span> <span class="identifier">script</span><span class="grouping">)</span>

        <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">executable</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">generate</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">executable</span><span class="punctuation">,</span> <span class="string-literal">"-u"</span><span class="grouping">]</span>
        <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">pathexecscript</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">cli_opts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">cli_opts</span>
        <span class="keyword">for</span> <span class="identifier">cliopt</span> <span class="relational-operator">in</span> <span class="identifier">cli_opts</span><span class="punctuation">.</span><span class="identifier">gen_cli_arguments</span><span class="grouping">(</span><span class="identifier">command</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">cliopt</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train"</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">generate</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_training_session_info</span><span class="grouping">(</span><span class="identifier">cliopt</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">generate</span><span class="punctuation">:</span>
            <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">"-gui"</span><span class="grouping">)</span>  <span class="comment"># Indicate to Faceswap that we are running the GUI</span>
        <span class="keyword">if</span> <span class="identifier">generate</span><span class="punctuation">:</span>
            <span class="comment"># Delimit args with spaces</span>
            <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'"{}"'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">arg</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="string-literal">" " in arg and not arg.startswith(("[", "("</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">arg</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">"]", ")"</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">arg</span>
                    <span class="keyword">for</span> <span class="identifier">arg</span> <span class="relational-operator">in</span> <span class="identifier">args</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Built cli arguments: (%s)"</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">args</span>

    <span class="keyword">def</span> <span class="identifier">_get_training_session_info</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">cli_option</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the model folder and model name to :`attr:_training_session_location` so the global
        session picks them up for logging to the graph and analysis tab.

        Parameters
        ----------
        cli_option: list
            The command line option to be checked for model folder or name
        """</span>
        <span class="keyword">if</span> <span class="identifier">cli_option</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"-t"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_session_location</span><span class="grouping">[</span><span class="string-literal">"model_name"] = cli_option[1].lower().replace("-", "_"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"model_name: '%s'", self._training_session_location["model_name"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">cli_option</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">"-m"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_session_location</span><span class="grouping">[</span><span class="string-literal">"model_folder"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cli_option</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"model_folder: '%s'", self._training_session_location["model_folder"</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">terminate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Finalize wrapper when process has exited """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminating Faceswap processes"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"runningtask"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">task</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"istraining"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">Session</span><span class="punctuation">.</span><span class="identifier">stop_training</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">stop</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">message</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">message</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"display"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">get_images</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">v</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">w</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">preview_trigger</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">clear</span><span class="grouping">(</span><span class="identifier">trigger_type</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminated Faceswap processes"</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Process exited."</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FaceswapControl</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Control the underlying Faceswap tasks """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">wrapper</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">wrapper</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_session_info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">_training_session_location</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">statusbar</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>  <span class="comment"># Thread for LongRunningTask termination</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"iterations": 0, "timestamp"</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">consoleregex</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">"loss": re.compile(r"[\W]+(\d+)?[\W]+([a-zA-Z\s]*)[\W]+?(\d+\.\d+)"</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"tqdm": re.compile(r"(?P&lt;dsc&gt;.*?)(?P&lt;pct&gt;\d+%).*?(?P&lt;itm&gt;\S+/\S+)\W\["</span>
                               <span class="identifier">r</span><span class="string-literal">"(?P&lt;tme&gt;[\d+:]+&lt;.*),\W(?P&lt;rte&gt;.*)[a-zA-Z/]*\]"</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"ffmpeg": re.compile(r"([a-zA-Z]+)=\s*(-?[\d|N/A]\S+)"</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">execute_script</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Execute the requested Faceswap Script """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Executing Faceswap: (command: '%s', args: %s)"</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="arithmetic-assignment">=</span> <span class="identifier">command</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"stdout"</span><span class="punctuation">:</span> <span class="identifier">PIPE</span><span class="punctuation">,</span>
                  <span class="string-literal">"stderr"</span><span class="punctuation">:</span> <span class="identifier">PIPE</span><span class="punctuation">,</span>
                  <span class="string-literal">"bufsize"</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                  <span class="string-literal">"universal_newlines"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Popen</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="punctuation">,</span> <span class="identifier">stdin</span><span class="arithmetic-assignment">=</span><span class="identifier">PIPE</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread_stdout</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread_stderr</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Executed Faceswap"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">read_stdout</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Read stdout from the subprocess. If training, pass the loss
        values to Queue """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Opening stdout reader"</span><span class="grouping">)</span>
        <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">ValueError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"i/o operation on closed file"</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">break</span>
                <span class="keyword">raise</span>
            <span class="keyword">if</span> <span class="identifier">output</span> <span class="relational-operator">==</span> <span class="string-literal">""</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">poll</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="keyword">break</span>
            <span class="keyword">if</span> <span class="identifier">output</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train"</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">capture_loss</span><span class="grouping">(</span><span class="identifier">output</span><span class="grouping">)</span><span class="grouping">)</span> <span class="logical-operator">or</span>
                        <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"effmpeg"</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">capture_ffmpeg</span><span class="grouping">(</span><span class="identifier">output</span><span class="grouping">)</span><span class="grouping">)</span> <span class="logical-operator">or</span>
                        <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"train", "effmpeg"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">capture_tqdm</span><span class="grouping">(</span><span class="identifier">output</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train" and self.wrapper.tk_vars["istraining"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">if</span> <span class="string-literal">"[saved models]"</span> <span class="relational-operator">in</span> <span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">strip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Trigger GUI Training update"</span><span class="grouping">)</span>
                        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"tk_vars: %s"</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="identifier">itm</span><span class="punctuation">:</span> <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
                                                     <span class="keyword">for</span> <span class="identifier">itm</span><span class="punctuation">,</span> <span class="identifier">var</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>
                        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">Session</span><span class="punctuation">.</span><span class="identifier">is_training</span><span class="punctuation">:</span>
                            <span class="comment"># Don't initialize session until after the first save as state</span>
                            <span class="comment"># file must exist first</span>
                            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing curret training session"</span><span class="grouping">)</span>
                            <span class="identifier">Session</span><span class="punctuation">.</span><span class="identifier">initialize_session</span><span class="grouping">(</span>
                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_session_info</span><span class="grouping">[</span><span class="string-literal">"model_folder"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_session_info</span><span class="grouping">[</span><span class="string-literal">"model_name"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">is_training</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"updatepreview"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"refreshgraph"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
                    <span class="keyword">if</span> <span class="string-literal">"[preview updated]"</span> <span class="relational-operator">in</span> <span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">strip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"updatepreview"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
                        <span class="keyword">continue</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">rstrip</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">poll</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">set_final_status</span><span class="grouping">(</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">terminate</span><span class="grouping">(</span><span class="identifier">message</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminated stdout reader. returncode: %s"</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">read_stderr</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Read stdout from the subprocess. If training, pass the loss
        values to Queue """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Opening stderr reader"</span><span class="grouping">)</span>
        <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">stderr</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">ValueError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"i/o operation on closed file"</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">break</span>
                <span class="keyword">raise</span>
            <span class="keyword">if</span> <span class="identifier">output</span> <span class="relational-operator">==</span> <span class="string-literal">""</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">poll</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="keyword">break</span>
            <span class="keyword">if</span> <span class="identifier">output</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">!=</span> <span class="string-literal">"train"</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">capture_tqdm</span><span class="grouping">(</span><span class="identifier">output</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">continue</span>
                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train" and output.startswith("Reading training images"</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">strip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="grouping">)</span>
                    <span class="keyword">continue</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">strip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">file</span><span class="arithmetic-assignment">=</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stderr</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminated stderr reader"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">thread_stdout</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Put the subprocess stdout so that it can be read without
        blocking """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Threading stdout"</span><span class="grouping">)</span>
        <span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Thread</span><span class="grouping">(</span><span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">read_stdout</span><span class="grouping">)</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">daemon</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Threaded stdout"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">thread_stderr</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Put the subprocess stderr so that it can be read without
        blocking """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Threading stderr"</span><span class="grouping">)</span>
        <span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Thread</span><span class="grouping">(</span><span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">read_stderr</span><span class="grouping">)</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">daemon</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Threaded stderr"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">capture_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">string</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Capture loss values from stdout """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Capturing loss"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">str</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">string</span><span class="punctuation">,</span> <span class="string-literal">"["</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Not loss message. Returning False"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>

        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">consoleregex</span><span class="grouping">[</span><span class="string-literal">"loss"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">findall</span><span class="grouping">(</span><span class="identifier">string</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">loss</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span> <span class="logical-operator">or</span> <span class="logical-operator">not</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">itm</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span> <span class="keyword">for</span> <span class="identifier">itm</span> <span class="relational-operator">in</span> <span class="identifier">loss</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Not loss message. Returning False"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>

        <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Total Iterations: {} | "</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">loss</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">message</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">"  ".join(["{}: {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">itm</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">itm</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">itm</span> <span class="relational-operator">in</span> <span class="identifier">loss</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">message</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Error creating loss message. Returning False"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>

        <span class="identifier">iterations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span><span class="grouping">[</span><span class="string-literal">"iterations"</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">iterations</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="comment"># Set initial timestamp</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span><span class="grouping">[</span><span class="string-literal">"timestamp"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">iterations</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span><span class="grouping">[</span><span class="string-literal">"iterations"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iterations</span>

        <span class="identifier">elapsed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">calc_elapsed</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Elapsed: {} | Session Iterations: {}  {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
            <span class="identifier">elapsed</span><span class="punctuation">,</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span><span class="grouping">[</span><span class="string-literal">"iterations"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">progress_update</span><span class="grouping">(</span><span class="identifier">message</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Succesfully captured loss: %s"</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">calc_elapsed</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Calculate and format time since training started """</span>
        <span class="identifier">now</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">elapsed_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">now</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span><span class="grouping">[</span><span class="string-literal">"timestamp"</span><span class="grouping">]</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">hrs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">elapsed_time</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3600</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">hrs</span> <span class="relational-operator">&lt;</span> <span class="int-literal">10</span><span class="punctuation">:</span>
                <span class="identifier">hrs</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{0:02d}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">hrs</span><span class="grouping">)</span>
            <span class="identifier">mins</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{0:02d}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">elapsed_time</span> <span class="arithmetic-operator">%</span> <span class="int-literal">3600</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">secs</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{0:02d}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">elapsed_time</span> <span class="arithmetic-operator">%</span> <span class="int-literal">3600</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">ZeroDivisionError</span><span class="punctuation">:</span>
            <span class="identifier">hrs</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"00"</span>
            <span class="identifier">mins</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"00"</span>
            <span class="identifier">secs</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"00"</span>
        <span class="keyword">return</span> <span class="string-literal">"{}:{}:{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">hrs</span><span class="punctuation">,</span> <span class="identifier">mins</span><span class="punctuation">,</span> <span class="identifier">secs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">capture_tqdm</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">string</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Capture tqdm output for progress bar """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Capturing tqdm"</span><span class="grouping">)</span>
        <span class="identifier">tqdm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">consoleregex</span><span class="grouping">[</span><span class="string-literal">"tqdm"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">match</span><span class="grouping">(</span><span class="identifier">string</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">tqdm</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>
        <span class="identifier">tqdm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tqdm</span><span class="punctuation">.</span><span class="identifier">groupdict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">any</span><span class="grouping">(</span><span class="string-literal">"?"</span> <span class="relational-operator">in</span> <span class="identifier">val</span> <span class="keyword">for</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">tqdm</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"tqdm initializing. Skipping"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">True</span>
        <span class="identifier">description</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tqdm</span><span class="grouping">[</span><span class="string-literal">"dsc"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">strip</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">description</span> <span class="arithmetic-assignment">=</span> <span class="identifier">description</span> <span class="keyword">if</span> <span class="identifier">description</span> <span class="relational-operator">==</span> <span class="string-literal">"" else "{}  |  "</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">description</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">processtime</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Elapsed: {}  Remaining: {}".format(tqdm["tme"].split("&lt;"</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                          <span class="identifier">tqdm</span><span class="grouping">[</span><span class="string-literal">"tme"].split("&lt;"</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}{}  |  {}  |  {}  |  {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">description</span><span class="punctuation">,</span>
                                                     <span class="identifier">processtime</span><span class="punctuation">,</span>
                                                     <span class="identifier">tqdm</span><span class="grouping">[</span><span class="string-literal">"rte"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                     <span class="identifier">tqdm</span><span class="grouping">[</span><span class="string-literal">"itm"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                     <span class="identifier">tqdm</span><span class="grouping">[</span><span class="string-literal">"pct"</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tqdm</span><span class="grouping">[</span><span class="string-literal">"pct"].replace("%", ""</span><span class="grouping">)</span>
        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">position</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">position</span><span class="punctuation">.</span><span class="identifier">isdigit</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="int-literal">0</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">progress_update</span><span class="grouping">(</span><span class="identifier">message</span><span class="punctuation">,</span> <span class="identifier">position</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Succesfully captured tqdm message: %s"</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">capture_ffmpeg</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">string</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Capture tqdm output for progress bar """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Capturing ffmpeg"</span><span class="grouping">)</span>
        <span class="identifier">ffmpeg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">consoleregex</span><span class="grouping">[</span><span class="string-literal">"ffmpeg"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">findall</span><span class="grouping">(</span><span class="identifier">string</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">ffmpeg</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="int-literal">7</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Not ffmpeg message. Returning False"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>

        <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">""</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">ffmpeg</span><span class="punctuation">:</span>
            <span class="identifier">message</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">"{}: {}  "</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">item</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">item</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">message</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Error creating ffmpeg message. Returning False"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">statusbar</span><span class="punctuation">.</span><span class="identifier">progress_update</span><span class="grouping">(</span><span class="identifier">message</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Succesfully captured ffmpeg message: %s"</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">terminate</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Terminate the running process in a LongRunningTask so we can still
            output to console """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminating wrapper in LongRunningTask"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LongRunningTask</span><span class="grouping">(</span><span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">terminate_in_thread</span><span class="punctuation">,</span>
                                          <span class="identifier">args</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">process</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train"</span><span class="punctuation">:</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">wrapper</span><span class="punctuation">.</span><span class="identifier">tk_vars</span><span class="grouping">[</span><span class="string-literal">"istraining"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">after</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">terminate</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">complete</span><span class="punctuation">.</span><span class="identifier">is_set</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Not finished terminating"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">root</span><span class="punctuation">.</span><span class="identifier">after</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">terminate</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Termination Complete. Cleaning up"</span><span class="grouping">)</span>
            <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">get_result</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># Terminate the LongRunningTask object</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

    <span class="keyword">def</span> <span class="identifier">terminate_in_thread</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="punctuation">,</span> <span class="identifier">process</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Terminate the subprocess """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminating wrapper"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">command</span> <span class="relational-operator">==</span> <span class="string-literal">"train"</span><span class="punctuation">:</span>
            <span class="identifier">timeout</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">user_config_dict</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"timeout"</span><span class="punctuation">,</span> <span class="int-literal">120</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Sending Exit Signal"</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Sending Exit Signal"</span><span class="punctuation">,</span> <span class="identifier">flush</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">now</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">"nt"</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Sending carriage return to process"</span><span class="grouping">)</span>
                <span class="identifier">con_in</span> <span class="arithmetic-assignment">=</span> <span class="identifier">win32console</span><span class="punctuation">.</span><span class="identifier">GetStdHandle</span><span class="grouping">(</span>  <span class="comment"># pylint:disable=c-extension-no-member</span>
                    <span class="identifier">win32console</span><span class="punctuation">.</span><span class="identifier">STD_INPUT_HANDLE</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=c-extension-no-member</span>
                <span class="identifier">keypress</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generate_windows_keypress</span><span class="grouping">(</span><span class="string-literal">"\n"</span><span class="grouping">)</span>
                <span class="identifier">con_in</span><span class="punctuation">.</span><span class="identifier">WriteConsoleInput</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">keypress</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Sending SIGINT to process"</span><span class="grouping">)</span>
                <span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">send_signal</span><span class="grouping">(</span><span class="identifier">signal</span><span class="punctuation">.</span><span class="identifier">SIGINT</span><span class="grouping">)</span>
            <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
                <span class="identifier">timeelapsed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">now</span>
                <span class="keyword">if</span> <span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">poll</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                    <span class="keyword">break</span>
                <span class="keyword">if</span> <span class="identifier">timeelapsed</span> <span class="relational-operator">&gt;</span> <span class="identifier">timeout</span><span class="punctuation">:</span>
                    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"Timeout reached sending Exit Signal"</span><span class="grouping">)</span>
                    <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">terminate_all_children</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">terminate_all_children</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">generate_windows_keypress</span><span class="grouping">(</span><span class="identifier">character</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Generate an 'Enter' key press to terminate Windows training """</span>
        <span class="identifier">buf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">win32console</span><span class="punctuation">.</span><span class="identifier">PyINPUT_RECORDType</span><span class="grouping">(</span>  <span class="comment"># pylint:disable=c-extension-no-member</span>
            <span class="identifier">win32console</span><span class="punctuation">.</span><span class="identifier">KEY_EVENT</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=c-extension-no-member</span>
        <span class="identifier">buf</span><span class="punctuation">.</span><span class="identifier">KeyDown</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">buf</span><span class="punctuation">.</span><span class="identifier">RepeatCount</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">buf</span><span class="punctuation">.</span><span class="identifier">Char</span> <span class="arithmetic-assignment">=</span> <span class="identifier">character</span>
        <span class="keyword">return</span> <span class="identifier">buf</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">terminate_all_children</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Terminates all children """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminating Process..."</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Terminating Process..."</span><span class="punctuation">,</span> <span class="identifier">flush</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">children</span> <span class="arithmetic-assignment">=</span> <span class="identifier">psutil</span><span class="punctuation">.</span><span class="identifier">Process</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">(</span><span class="identifier">recursive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">child</span> <span class="relational-operator">in</span> <span class="identifier">children</span><span class="punctuation">:</span>
            <span class="identifier">child</span><span class="punctuation">.</span><span class="identifier">terminate</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">alive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">psutil</span><span class="punctuation">.</span><span class="identifier">wait_procs</span><span class="grouping">(</span><span class="identifier">children</span><span class="punctuation">,</span> <span class="identifier">timeout</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">alive</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Terminated"</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Terminated"</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Termination timed out. Killing Process..."</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Termination timed out. Killing Process..."</span><span class="punctuation">,</span> <span class="identifier">flush</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">child</span> <span class="relational-operator">in</span> <span class="identifier">alive</span><span class="punctuation">:</span>
            <span class="identifier">child</span><span class="punctuation">.</span><span class="identifier">kill</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">alive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">psutil</span><span class="punctuation">.</span><span class="identifier">wait_procs</span><span class="grouping">(</span><span class="identifier">alive</span><span class="punctuation">,</span> <span class="identifier">timeout</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">alive</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Killed"</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Killed"</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">child</span> <span class="relational-operator">in</span> <span class="identifier">alive</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Process {} survived SIGKILL. Giving up"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">child</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">set_final_status</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the status bar output based on subprocess return code
            and reset training stats """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting final status. returncode: %s"</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">train_stats</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"iterations": 0, "timestamp"</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3221225786</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">status</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Ready"</span>
        <span class="keyword">elif</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">15</span><span class="punctuation">:</span>
            <span class="identifier">status</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Terminated - {}.py"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">9</span><span class="punctuation">:</span>
            <span class="identifier">status</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Killed - {}.py"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">:</span>
            <span class="identifier">status</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Aborted - {}.py"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">status</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Failed - {}.py. Return Code: {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">command</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Set final status: %s"</span><span class="punctuation">,</span> <span class="identifier">status</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">status</span>

    </pre>
  </body>
</html>