<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Normalization methods for faceswap.py common to both Plaid and Tensorflow Backends """</span>

<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">inspect</span>

<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span> <span class="keyword">import</span> <span class="identifier">Layer</span><span class="punctuation">,</span> <span class="identifier">InputSpec</span>
<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">initializers</span><span class="punctuation">,</span> <span class="identifier">regularizers</span><span class="punctuation">,</span> <span class="identifier">constraints</span>
<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">backend</span> <span class="keyword">as</span> <span class="identifier">K</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_custom_objects</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_backend</span>


<span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">backend</span> <span class="keyword">import</span> <span class="identifier">normalize_data_format</span>  <span class="comment"># pylint:disable=ungrouped-imports</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">tensorflow</span><span class="punctuation">.</span><span class="identifier">python</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">conv_utils</span> <span class="keyword">import</span> <span class="identifier">normalize_data_format</span>


<span class="keyword">class</span> <span class="identifier">InstanceNormalization</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Instance normalization layer (Lei Ba et al, 2016, Ulyanov et al., 2016).

    Normalize the activations of the previous layer at each step, i.e. applies a transformation
    that maintains the mean activation close to 0 and the activation standard deviation close to 1.

    Parameters
    ----------
    axis: int, optional
        The axis that should be normalized (typically the features axis). For instance, after a
        `Conv2D` layer with `data_format="channels_first"`, set `axis=1` in
        :class:`InstanceNormalization`. Setting `axis=None` will normalize all values in each
        instance of the batch. Axis 0 is the batch dimension. `axis` cannot be set to 0 to avoid
        errors. Default: ``None``
    epsilon: float, optional
        Small float added to variance to avoid dividing by zero. Default: `1e-3`
    center: bool, optional
        If ``True``, add offset of `beta` to normalized tensor. If ``False``, `beta` is ignored.
        Default: ``True``
    scale: bool, optional
        If ``True``, multiply by `gamma`. If ``False``, `gamma` is not used. When the next layer
        is linear (also e.g. `relu`), this can be disabled since the scaling will be done by
        the next layer. Default: ``True``
    beta_initializer: str, optional
        Initializer for the beta weight. Default: `"zeros"`
    gamma_initializer: str, optional
        Initializer for the gamma weight. Default: `"ones"`
    beta_regularizer: str, optional
        Optional regularizer for the beta weight. Default: ``None``
    gamma_regularizer: str, optional
        Optional regularizer for the gamma weight. Default: ``None``
    beta_constraint: float, optional
        Optional constraint for the beta weight. Default: ``None``
    gamma_constraint: float, optional
        Optional constraint for the gamma weight. Default: ``None``

    References
    ----------
        - Layer Normalization - https://arxiv.org/abs/1607.06450

        - Instance Normalization: The Missing Ingredient for Fast Stylization - \
        https://arxiv.org/abs/1607.08022
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span>
                 <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span>
                 <span class="identifier">center</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">beta_initializer</span><span class="arithmetic-assignment">=</span><span class="string-literal">"zeros"</span><span class="punctuation">,</span>
                 <span class="identifier">gamma_initializer</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ones"</span><span class="punctuation">,</span>
                 <span class="identifier">beta_regularizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">gamma_regularizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">beta_constraint</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">gamma_constraint</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">supports_masking</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">axis</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="identifier">epsilon</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">center</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_initializer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">beta_initializer</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_initializer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">gamma_initializer</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_regularizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">beta_regularizer</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">gamma_regularizer</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_constraint</span> <span class="arithmetic-assignment">=</span> <span class="identifier">constraints</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">beta_constraint</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_constraint</span> <span class="arithmetic-assignment">=</span> <span class="identifier">constraints</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">gamma_constraint</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">build</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Creates the layer weights.

        Parameters
        ----------
        input_shape: tensor
            Keras tensor (future input to layer) or ``list``/``tuple`` of Keras tensors to
            reference for weight shape computations.
        """</span>
        <span class="identifier">ndim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Axis cannot be zero"</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="grouping">(</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Cannot specify axis for rank 1 tensor"</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">InputSpec</span><span class="grouping">(</span><span class="identifier">ndim</span><span class="arithmetic-assignment">=</span><span class="identifier">ndim</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=attribute-defined-outside-init</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">]</span><span class="punctuation">,</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">add_weight</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape</span><span class="punctuation">,</span>
                                         <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gamma"</span><span class="punctuation">,</span>
                                         <span class="identifier">initializer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_initializer</span><span class="punctuation">,</span>
                                         <span class="identifier">regularizer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span><span class="punctuation">,</span>
                                         <span class="identifier">constraint</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_constraint</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">center</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">add_weight</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape</span><span class="punctuation">,</span>
                                        <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"beta"</span><span class="punctuation">,</span>
                                        <span class="identifier">initializer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_initializer</span><span class="punctuation">,</span>
                                        <span class="identifier">regularizer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_regularizer</span><span class="punctuation">,</span>
                                        <span class="identifier">constraint</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_constraint</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">built</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>  <span class="comment"># pylint:disable=attribute-defined-outside-init</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">training</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=arguments-differ,unused-argument</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span>
        <span class="identifier">reduction_axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">del</span> <span class="identifier">reduction_axes</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">]</span>

        <span class="keyword">del</span> <span class="identifier">reduction_axes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

        <span class="identifier">mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">reduction_axes</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">stddev</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">reduction_axes</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span>
        <span class="identifier">normed</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">inputs</span> <span class="arithmetic-operator">-</span> <span class="identifier">mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">stddev</span>

        <span class="identifier">broadcast_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">broadcast_shape</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">:</span>
            <span class="identifier">broadcast_gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">broadcast_shape</span><span class="grouping">)</span>
            <span class="identifier">normed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normed</span> <span class="arithmetic-operator">*</span> <span class="identifier">broadcast_gamma</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">center</span><span class="punctuation">:</span>
            <span class="identifier">broadcast_beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span><span class="punctuation">,</span> <span class="identifier">broadcast_shape</span><span class="grouping">)</span>
            <span class="identifier">normed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normed</span> <span class="arithmetic-operator">+</span> <span class="identifier">broadcast_beta</span>
        <span class="keyword">return</span> <span class="identifier">normed</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        A layer config is a Python dictionary (serializable) containing the configuration of a
        layer. The same layer can be reinstated later (without its trained weights) from this
        configuration.

        The configuration of a layer does not include connectivity information, nor the layer
        class name. These are handled by `Network` (one layer of abstraction above).

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">"axis"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="punctuation">,</span>
            <span class="string-literal">"epsilon"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span><span class="punctuation">,</span>
            <span class="string-literal">"center"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">center</span><span class="punctuation">,</span>
            <span class="string-literal">"scale"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span><span class="punctuation">,</span>
            <span class="string-literal">"beta_initializer"</span><span class="punctuation">:</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_initializer</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"gamma_initializer"</span><span class="punctuation">:</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_initializer</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"beta_regularizer"</span><span class="punctuation">:</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_regularizer</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"gamma_regularizer"</span><span class="punctuation">:</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"beta_constraint"</span><span class="punctuation">:</span> <span class="identifier">constraints</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_constraint</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="string-literal">"gamma_constraint"</span><span class="punctuation">:</span> <span class="identifier">constraints</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_constraint</span><span class="grouping">)</span>
        <span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">AdaInstanceNormalization</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Adaptive Instance Normalization Layer for Keras.

    Parameters
    ----------
    axis: int, optional
        The axis that should be normalized (typically the features axis). For instance, after a
        `Conv2D` layer with `data_format="channels_first"`, set `axis=1` in
        :class:`InstanceNormalization`. Setting `axis=None` will normalize all values in each
        instance of the batch. Axis 0 is the batch dimension. `axis` cannot be set to 0 to avoid
        errors. Default: ``None``
    momentum: float, optional
        Momentum for the moving mean and the moving variance. Default: `0.99`
    epsilon: float, optional
        Small float added to variance to avoid dividing by zero. Default: `1e-3`
    center: bool, optional
        If ``True``, add offset of `beta` to normalized tensor. If ``False``, `beta` is ignored.
        Default: ``True``
    scale: bool, optional
        If ``True``, multiply by `gamma`. If ``False``, `gamma` is not used. When the next layer
        is linear (also e.g. `relu`), this can be disabled since the scaling will be done by
        the next layer. Default: ``True``

    References
    ----------
        Arbitrary Style Transfer in Real-time with Adaptive Instance Normalization - \
        https://arxiv.org/abs/1703.06868
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">momentum</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.99</span><span class="punctuation">,</span> <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">center</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">axis</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">momentum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">momentum</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="identifier">epsilon</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">center</span> <span class="arithmetic-assignment">=</span> <span class="identifier">center</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span>

    <span class="keyword">def</span> <span class="identifier">build</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Creates the layer weights.

        Parameters
        ----------
        input_shape: tensor
            Keras tensor (future input to layer) or ``list``/``tuple`` of Keras tensors to
            reference for weight shape computations.
        """</span>
        <span class="identifier">dim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">dim</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Axis ' + str(self.axis) + ' of '</span>
                             <span class="string-literal">'input tensor should have a defined dimension '</span>
                             <span class="string-literal">'but the layer received an input with shape '</span> <span class="arithmetic-operator">+</span>
                             <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="string-literal">'.'</span><span class="grouping">)</span>

        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">build</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">training</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument,arguments-differ</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">reduction_axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inputs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inputs</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">del</span> <span class="identifier">reduction_axes</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="grouping">]</span>

        <span class="keyword">del</span> <span class="identifier">reduction_axes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">reduction_axes</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">stddev</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">reduction_axes</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span>
        <span class="identifier">normed</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">stddev</span>

        <span class="keyword">return</span> <span class="identifier">normed</span> <span class="arithmetic-operator">*</span> <span class="identifier">gamma</span> <span class="arithmetic-operator">+</span> <span class="identifier">beta</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        The Keras configuration for the layer.

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
            <span class="string-literal">'axis'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="punctuation">,</span>
            <span class="string-literal">'momentum'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">momentum</span><span class="punctuation">,</span>
            <span class="string-literal">'epsilon'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span><span class="punctuation">,</span>
            <span class="string-literal">'center'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">center</span><span class="punctuation">,</span>
            <span class="string-literal">'scale'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">scale</span>
        <span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=no-self-use</span>
        <span class="comment">""" Calculate the output shape from this layer.

        Parameters
        ----------
        input_shape: tuple
            The input shape to the layer

        Returns
        -------
        int
            The output shape to the layer
        """</span>
        <span class="keyword">return</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">GroupNormalization</span><span class="grouping">(</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Group Normalization

    Parameters
    ----------
    axis: int, optional
        The axis that should be normalized (typically the features axis). For instance, after a
        `Conv2D` layer with `data_format="channels_first"`, set `axis=1` in
        :class:`InstanceNormalization`. Setting `axis=None` will normalize all values in each
        instance of the batch. Axis 0 is the batch dimension. `axis` cannot be set to 0 to avoid
        errors. Default: ``None``
    gamma_init: str, optional
        Initializer for the gamma weight. Default: `"one"`
    beta_init: str, optional
        Initializer for the beta weight. Default `"zero"`
    gamma_regularizer: varies, optional
        Optional regularizer for the gamma weight. Default: ``None``
    beta_regularizer:  varies, optional
        Optional regularizer for the beta weight. Default ``None``
    epsilon: float, optional
        Small float added to variance to avoid dividing by zero. Default: `1e-3`
    group: int, optional
        The group size. Default: `32`
    data_format: ["channels_first", "channels_last"], optional
        The required data format. Optional. Default: ``None``
    kwargs: dict
        Any additional standard Keras Layer key word arguments

    References
    ----------
    Shaoanlu GAN: https://github.com/shaoanlu/faceswap-GAN
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">gamma_init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'one', beta_init='zero'</span><span class="punctuation">,</span> <span class="identifier">gamma_regularizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">beta_regularizer</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="identifier">data_format</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span> <span class="arithmetic-assignment">=</span> <span class="identifier">axis</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">axis</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">list</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="identifier">axis</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">gamma_init</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">beta_init</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">gamma_regularizer</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_regularizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">beta_regularizer</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span> <span class="arithmetic-assignment">=</span> <span class="identifier">epsilon</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span> <span class="arithmetic-assignment">=</span> <span class="identifier">group</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalize_data_format</span><span class="grouping">(</span><span class="identifier">data_format</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">supports_masking</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>

    <span class="keyword">def</span> <span class="identifier">build</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Creates the layer weights.

        Parameters
        ----------
        input_shape: tensor
            Keras tensor (future input to layer) or ``list``/``tuple`` of Keras tensors to
            reference for weight shape computations.
        """</span>
        <span class="identifier">input_spec</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">InputSpec</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_spec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_spec</span>  <span class="comment"># pylint:disable=attribute-defined-outside-init</span>
        <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">input_shape</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
            <span class="identifier">channel_axis</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
            <span class="identifier">shape</span><span class="grouping">[</span><span class="identifier">channel_axis</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">channel_axis</span><span class="grouping">]</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_first'</span><span class="punctuation">:</span>
            <span class="identifier">channel_axis</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
            <span class="identifier">shape</span><span class="grouping">[</span><span class="identifier">channel_axis</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">channel_axis</span><span class="grouping">]</span>
        <span class="comment"># for i in self.axis:</span>
        <span class="comment">#    shape[i] = input_shape[i]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">add_weight</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape</span><span class="punctuation">,</span>
                                     <span class="identifier">initializer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_init</span><span class="punctuation">,</span>
                                     <span class="identifier">regularizer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span><span class="punctuation">,</span>
                                     <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'gamma'</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">add_weight</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape</span><span class="punctuation">,</span>
                                    <span class="identifier">initializer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_init</span><span class="punctuation">,</span>
                                    <span class="identifier">regularizer</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_regularizer</span><span class="punctuation">,</span>
                                    <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'beta'</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">built</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>  <span class="comment"># pylint:disable=attribute-defined-outside-init</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument,arguments-differ</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: tensor
            Input tensor, or list/tuple of input tensors

        Returns
        -------
        tensor
            A tensor or list/tuple of tensors
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span> <span class="logical-operator">and</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Inputs should have rank '</span> <span class="arithmetic-operator">+</span>
                             <span class="identifier">str</span><span class="grouping">(</span><span class="int-literal">4</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="string-literal">" or "</span> <span class="arithmetic-operator">+</span> <span class="identifier">str</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                             <span class="string-literal">'; Received input shape:'</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_last'</span><span class="punctuation">:</span>
                <span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
                <span class="keyword">if</span> <span class="identifier">batch_size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                    <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

                <span class="keyword">if</span> <span class="identifier">channels</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="punctuation">:</span>
                    <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Input channels should be larger than group size'</span> <span class="arithmetic-operator">+</span>
                                     <span class="string-literal">'; Received input channels: '</span> <span class="arithmetic-operator">+</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">channels</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                                     <span class="string-literal">'; Group size: '</span> <span class="arithmetic-operator">+</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="grouping">)</span><span class="grouping">)</span>

                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span>
                                           <span class="identifier">height</span><span class="punctuation">,</span>
                                           <span class="identifier">width</span><span class="punctuation">,</span>
                                           <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="punctuation">,</span>
                                           <span class="identifier">channels</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                <span class="identifier">std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span><span class="grouping">)</span>
                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">var_x</span> <span class="arithmetic-operator">-</span> <span class="identifier">mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">std</span>

                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">channels</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">var_x</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span>
            <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_first'</span><span class="punctuation">:</span>
                <span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">channels</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
                <span class="keyword">if</span> <span class="identifier">batch_size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                    <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

                <span class="keyword">if</span> <span class="identifier">channels</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="punctuation">:</span>
                    <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Input channels should be larger than group size'</span> <span class="arithmetic-operator">+</span>
                                     <span class="string-literal">'; Received input channels: '</span> <span class="arithmetic-operator">+</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">channels</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                                     <span class="string-literal">'; Group size: '</span> <span class="arithmetic-operator">+</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="grouping">)</span><span class="grouping">)</span>

                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span>
                                           <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="punctuation">,</span>
                                           <span class="identifier">channels</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="punctuation">,</span>
                                           <span class="identifier">height</span><span class="punctuation">,</span>
                                           <span class="identifier">width</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                <span class="identifier">std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span><span class="grouping">)</span>
                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">var_x</span> <span class="arithmetic-operator">-</span> <span class="identifier">mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">std</span>

                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">channels</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">var_x</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span>

        <span class="keyword">elif</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="identifier">reduction_axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">del</span> <span class="identifier">reduction_axes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">batch_size</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span>
            <span class="keyword">if</span> <span class="identifier">batch_size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

            <span class="identifier">mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
            <span class="identifier">std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span><span class="grouping">)</span>
            <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">inputs</span> <span class="arithmetic-operator">-</span> <span class="identifier">mean</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">std</span>

            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">var_x</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns the config of the layer.

        The Keras configuration for the layer.

        Returns
        --------
        dict
            A python dictionary containing the layer configuration
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'epsilon'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">epsilon</span><span class="punctuation">,</span>
                  <span class="string-literal">'axis'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">axis</span><span class="punctuation">,</span>
                  <span class="string-literal">'gamma_init'</span><span class="punctuation">:</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_init</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="string-literal">'beta_init'</span><span class="punctuation">:</span> <span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta_init</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="string-literal">'gamma_regularizer'</span><span class="punctuation">:</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="string-literal">'beta_regularizer'</span><span class="punctuation">:</span> <span class="identifier">regularizers</span><span class="punctuation">.</span><span class="identifier">serialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">gamma_regularizer</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="string-literal">'group'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">group</span><span class="grouping">}</span>
        <span class="identifier">base_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">base_config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment"># Update normalization into Keras custom objects</span>
<span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">obj</span> <span class="relational-operator">in</span> <span class="identifier">inspect</span><span class="punctuation">.</span><span class="identifier">getmembers</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">modules</span><span class="grouping">[</span><span class="identifier">__name__</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">inspect</span><span class="punctuation">.</span><span class="identifier">isclass</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">obj</span><span class="punctuation">.</span><span class="identifier">__module__</span> <span class="relational-operator">==</span> <span class="identifier">__name__</span><span class="punctuation">:</span>
        <span class="identifier">get_custom_objects</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">{</span><span class="identifier">name</span><span class="punctuation">:</span> <span class="identifier">obj</span><span class="grouping">}</span><span class="grouping">)</span>

    </pre>
  </body>
</html>