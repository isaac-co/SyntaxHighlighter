<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
The :mod:`sklearn.feature_extraction.image` submodule gathers utilities to
extract features from images.
"""</span>

<span class="comment"># Authors: Emmanuelle Gouillart &lt;emmanuelle.gouillart@normalesup.org&gt;</span>
<span class="comment">#          Gael Varoquaux &lt;gael.varoquaux@normalesup.org&gt;</span>
<span class="comment">#          Olivier Grisel</span>
<span class="comment">#          Vlad Niculae</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>
<span class="keyword">import</span> <span class="identifier">numbers</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">stride_tricks</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">d</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_array</span><span class="punctuation">,</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span>

<span class="identifier">__all__</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'PatchExtractor'</span><span class="punctuation">,</span>
           <span class="string-literal">'extract_patches_2d'</span><span class="punctuation">,</span>
           <span class="string-literal">'grid_to_graph'</span><span class="punctuation">,</span>
           <span class="string-literal">'img_to_graph'</span><span class="punctuation">,</span>
           <span class="string-literal">'reconstruct_from_patches_2d'</span><span class="grouping">]</span>

<span class="comment">###############################################################################</span>
<span class="comment"># From an image to a graph</span>


<span class="keyword">def</span> <span class="identifier">_make_edges_3d</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Returns a list of edges for a 3D image.

    Parameters
    ----------
    n_x : int
        The size of the grid in the x direction.
    n_y : int
        The size of the grid in the y direction.
    n_z : integer, default=1
        The size of the grid in the z direction, defaults to 1
    """</span>
    <span class="identifier">vertices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_x</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">edges_deep</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">vertices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">vertices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">edges_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">vertices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">vertices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">edges_down</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">vertices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">vertices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">edges_deep</span><span class="punctuation">,</span> <span class="identifier">edges_right</span><span class="punctuation">,</span> <span class="identifier">edges_down</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">edges</span>


<span class="keyword">def</span> <span class="identifier">_compute_gradient_3d</span><span class="grouping">(</span><span class="identifier">edges</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">[</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">n_z</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">n_z</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span>
                      <span class="identifier">img</span><span class="grouping">[</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">n_z</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">n_z</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">gradient</span>


<span class="comment"># XXX: Why mask the image after computing the weights?</span>

<span class="keyword">def</span> <span class="identifier">_mask_edges_weights</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">edges</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Apply a mask to edges (weighted or not)"""</span>
    <span class="identifier">inds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
    <span class="identifier">inds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inds</span><span class="grouping">[</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">ind_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_and</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">in1d</span><span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">inds</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">in1d</span><span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">inds</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">edges</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">ind_mask</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">weights</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weights</span><span class="grouping">[</span><span class="identifier">ind_mask</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">edges</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">maxval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">edges</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">maxval</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">order</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">edges</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">maxval</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">order</span><span class="grouping">[</span><span class="identifier">edges</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">weights</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">edges</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">edges</span><span class="punctuation">,</span> <span class="identifier">weights</span>


<span class="keyword">def</span> <span class="identifier">_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
              <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Auxiliary function for img_to_graph and grid_to_graph
    """</span>
    <span class="identifier">edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_edges_3d</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dtype</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">img</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">dtype</span>

    <span class="keyword">if</span> <span class="identifier">img</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_3d</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_gradient_3d</span><span class="grouping">(</span><span class="identifier">edges</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">mask</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">edges</span><span class="punctuation">,</span> <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_mask_edges_weights</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">edges</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span>
            <span class="identifier">diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">n_voxels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diag</span><span class="punctuation">.</span><span class="identifier">size</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">mask</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
            <span class="identifier">edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_mask_edges_weights</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">edges</span><span class="grouping">)</span>
            <span class="identifier">n_voxels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">n_voxels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_x</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_y</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_z</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">edges</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_voxels</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">diag_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_voxels</span><span class="grouping">)</span>
    <span class="identifier">i_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">j_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">edges</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">diag</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i_idx</span><span class="punctuation">,</span> <span class="identifier">diag_idx</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">j_idx</span><span class="punctuation">,</span> <span class="identifier">diag_idx</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="grouping">(</span><span class="identifier">n_voxels</span><span class="punctuation">,</span> <span class="identifier">n_voxels</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span> <span class="relational-operator">is</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">graph</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">img_to_graph</span><span class="grouping">(</span><span class="identifier">img</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Graph of the pixel-to-pixel gradient connections

    Edges are weighted with the gradient values.

    Read more in the :ref:`User Guide &lt;image_feature_extraction&gt;`.

    Parameters
    ----------
    img : ndarray of shape (height, width) or (height, width, channel)
        2D or 3D image.
    mask : ndarray of shape (height, width) or \
            (height, width, channel), dtype=bool, default=None
        An optional mask of the image, to consider only part of the
        pixels.
    return_as : np.ndarray or a sparse matrix class, \
            default=sparse.coo_matrix
        The class to use to build the returned adjacency matrix.
    dtype : dtype, default=None
        The data of the returned sparse matrix. By default it is the
        dtype of img

    Notes
    -----
    For scikit-learn versions 0.14.1 and prior, return_as=np.ndarray was
    handled by returning a dense np.matrix instance.  Going forward, np.ndarray
    returns an np.ndarray, as expected.

    For compatibility, user code relying on this method should wrap its
    calls in ``np.asarray`` to avoid type issues.
    """</span>
    <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">atleast_3d</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">)</span>
    <span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">return</span> <span class="identifier">_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="punctuation">,</span>
                  <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Graph of the pixel-to-pixel connections

    Edges exist if 2 voxels are connected.

    Parameters
    ----------
    n_x : int
        Dimension in x axis
    n_y : int
        Dimension in y axis
    n_z : int, default=1
        Dimension in z axis
    mask : ndarray of shape (n_x, n_y, n_z), dtype=bool, default=None
        An optional mask of the image, to consider only part of the
        pixels.
    return_as : np.ndarray or a sparse matrix class, \
            default=sparse.coo_matrix
        The class to use to build the returned adjacency matrix.
    dtype : dtype, default=int
        The data of the returned sparse matrix. By default it is int

    Notes
    -----
    For scikit-learn versions 0.14.1 and prior, return_as=np.ndarray was
    handled by returning a dense np.matrix instance.  Going forward, np.ndarray
    returns an np.ndarray, as expected.

    For compatibility, user code relying on this method should wrap its
    calls in ``np.asarray`` to avoid type issues.
    """</span>
    <span class="keyword">return</span> <span class="identifier">_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="punctuation">,</span>
                     <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>


<span class="comment">###############################################################################</span>
<span class="comment"># From an image to a set of small image patches</span>

<span class="keyword">def</span> <span class="identifier">_compute_n_patches</span><span class="grouping">(</span><span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute the number of patches that will be extracted in an image.

    Read more in the :ref:`User Guide &lt;image_feature_extraction&gt;`.

    Parameters
    ----------
    i_h : int
        The image height
    i_w : int
        The image with
    p_h : int
        The height of a patch
    p_w : int
        The width of a patch
    max_patches : int or float, default=None
        The maximum number of patches to extract. If max_patches is a float
        between 0 and 1, it is taken to be a proportion of the total number
        of patches.
    """</span>
    <span class="identifier">n_h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">n_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">all_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_h</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_w</span>

    <span class="keyword">if</span> <span class="identifier">max_patches</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">max_patches</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="logical-operator">and</span> <span class="identifier">max_patches</span> <span class="relational-operator">&lt;</span> <span class="identifier">all_patches</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">max_patches</span>
        <span class="keyword">elif</span> <span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">max_patches</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span><span class="grouping">)</span>
              <span class="logical-operator">and</span> <span class="identifier">max_patches</span> <span class="relational-operator">&gt;=</span> <span class="identifier">all_patches</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">all_patches</span>
        <span class="keyword">elif</span> <span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">max_patches</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Real</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="logical-operator">and</span> <span class="int-literal">0</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_patches</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max_patches</span> <span class="arithmetic-operator">*</span> <span class="identifier">all_patches</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Invalid value for max_patches: %r"</span> <span class="arithmetic-operator">%</span> <span class="identifier">max_patches</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">all_patches</span>


<span class="keyword">def</span> <span class="identifier">_extract_patches</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="identifier">patch_shape</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="identifier">extraction_step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Extracts patches of any n-dimensional array in place using strides.

    Given an n-dimensional array it will return a 2n-dimensional array with
    the first n dimensions indexing patch position and the last n indexing
    the patch content. This operation is immediate (O(1)). A reshape
    performed on the first n dimensions will cause numpy to copy data, leading
    to a list of extracted patches.

    Read more in the :ref:`User Guide &lt;image_feature_extraction&gt;`.

    Parameters
    ----------
    arr : ndarray
        n-dimensional array of which patches are to be extracted

    patch_shape : int or tuple of length arr.ndim.default=8
        Indicates the shape of the patches to be extracted. If an
        integer is given, the shape will be a hypercube of
        sidelength given by its value.

    extraction_step : int or tuple of length arr.ndim, default=1
        Indicates step size at which extraction shall be performed.
        If integer is given, then the step is uniform in all dimensions.


    Returns
    -------
    patches : strided ndarray
        2n-dimensional array indexing patches on first n dimensions and
        containing patches on the last n dimensions. These dimensions
        are fake, but this way no data is copied. A simple reshape invokes
        a copying operation to obtain a list of patches:
        result.reshape([-1] + list(patch_shape))
    """</span>

    <span class="identifier">arr_ndim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr</span><span class="punctuation">.</span><span class="identifier">ndim</span>

    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">patch_shape</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Number</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">patch_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">patch_shape</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">arr_ndim</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">extraction_step</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Number</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">extraction_step</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">extraction_step</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">arr_ndim</span><span class="grouping">)</span>

    <span class="identifier">patch_strides</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr</span><span class="punctuation">.</span><span class="identifier">strides</span>

    <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">st</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">st</span> <span class="relational-operator">in</span> <span class="identifier">extraction_step</span><span class="grouping">)</span>
    <span class="identifier">indexing_strides</span> <span class="arithmetic-assignment">=</span> <span class="identifier">arr</span><span class="grouping">[</span><span class="identifier">slices</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">strides</span>

    <span class="identifier">patch_indices_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">patch_shape</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span>
                           <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">extraction_step</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">patch_indices_shape</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">patch_shape</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">strides</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">indexing_strides</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">patch_strides</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">i</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">arr</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="identifier">strides</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">patches</span>


<span class="keyword">def</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                       <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Reshape a 2D image into a collection of patches

    The resulting patches are allocated in a dedicated array.

    Read more in the :ref:`User Guide &lt;image_feature_extraction&gt;`.

    Parameters
    ----------
    image : ndarray of shape (image_height, image_width) or \
        (image_height, image_width, n_channels)
        The original image data. For color images, the last dimension specifies
        the channel: a RGB image would have `n_channels=3`.

    patch_size : tuple of int (patch_height, patch_width)
        The dimensions of one patch.

    max_patches : int or float, default=None
        The maximum number of patches to extract. If `max_patches` is a float
        between 0 and 1, it is taken to be a proportion of the total number
        of patches.

    random_state : int, RandomState instance, default=None
        Determines the random number generator used for random sampling when
        `max_patches` is not None. Use an int to make the randomness
        deterministic.
        See :term:`Glossary &lt;random_state&gt;`.

    Returns
    -------
    patches : array of shape (n_patches, patch_height, patch_width) or \
        (n_patches, patch_height, patch_width, n_channels)
        The collection of patches extracted from the image, where `n_patches`
        is either `max_patches` or the total number of patches that can be
        extracted.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_sample_image
    &gt;&gt;&gt; from sklearn.feature_extraction import image
    &gt;&gt;&gt; # Use the array data from the first image in this dataset:
    &gt;&gt;&gt; one_image = load_sample_image("china.jpg")
    &gt;&gt;&gt; print('Image shape: {}'.format(one_image.shape))
    Image shape: (427, 640, 3)
    &gt;&gt;&gt; patches = image.extract_patches_2d(one_image, (2, 2))
    &gt;&gt;&gt; print('Patches shape: {}'.format(patches.shape))
    Patches shape: (272214, 2, 2, 3)
    &gt;&gt;&gt; # Here are just two of these patches:
    &gt;&gt;&gt; print(patches[1])
    [[[174 201 231]
      [174 201 231]]
     [[173 200 230]
      [173 200 230]]]
    &gt;&gt;&gt; print(patches[800])
    [[[187 214 243]
      [188 215 244]]
     [[187 214 243]
      [188 215 244]]]
    """</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patch_size</span>

    <span class="keyword">if</span> <span class="identifier">p_h</span> <span class="relational-operator">&gt;</span> <span class="identifier">i_h</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Height of the patch should be less than the height"</span>
                         <span class="string-literal">" of the image."</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">p_w</span> <span class="relational-operator">&gt;</span> <span class="identifier">i_w</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Width of the patch should be less than the width"</span>
                         <span class="string-literal">" of the image."</span><span class="grouping">)</span>

    <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">allow_nd</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">n_colors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">extracted_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_extract_patches</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span>
                                         <span class="identifier">patch_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="identifier">n_colors</span><span class="grouping">)</span><span class="punctuation">,</span>
                                         <span class="identifier">extraction_step</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_n_patches</span><span class="grouping">(</span><span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">max_patches</span><span class="punctuation">:</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">i_s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_patches</span><span class="grouping">)</span>
        <span class="identifier">j_s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_patches</span><span class="grouping">)</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extracted_patches</span><span class="grouping">[</span><span class="identifier">i_s</span><span class="punctuation">,</span> <span class="identifier">j_s</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extracted_patches</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="identifier">n_colors</span><span class="grouping">)</span>
    <span class="comment"># remove the color dimension if useless</span>
    <span class="keyword">if</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">patches</span>


<span class="keyword">def</span> <span class="identifier">reconstruct_from_patches_2d</span><span class="grouping">(</span><span class="identifier">patches</span><span class="punctuation">,</span> <span class="identifier">image_size</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Reconstruct the image from all of its patches.

    Patches are assumed to overlap and the image is constructed by filling in
    the patches from left to right, top to bottom, averaging the overlapping
    regions.

    Read more in the :ref:`User Guide &lt;image_feature_extraction&gt;`.

    Parameters
    ----------
    patches : ndarray of shape (n_patches, patch_height, patch_width) or \
        (n_patches, patch_height, patch_width, n_channels)
        The complete set of patches. If the patches contain colour information,
        channels are indexed along the last dimension: RGB patches would
        have `n_channels=3`.

    image_size : tuple of int (image_height, image_width) or \
        (image_height, image_width, n_channels)
        The size of the image that will be reconstructed.

    Returns
    -------
    image : ndarray of shape image_size
        The reconstructed image.
    """</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image_size</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">image_size</span><span class="grouping">)</span>
    <span class="comment"># compute the dimensions of the patches array</span>
    <span class="identifier">n_h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">n_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="keyword">for</span> <span class="identifier">p</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">patches</span><span class="punctuation">,</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_h</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_w</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">img</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">:</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="punctuation">:</span><span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="identifier">p_w</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">p</span>

    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">i_h</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">i_w</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># divide by the amount of overlap</span>
            <span class="comment"># XXX: is this the most efficient way? memory-wise yes, cpu wise?</span>
            <span class="identifier">img</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">i</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span>
                               <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">j</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">j</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">img</span>


<span class="keyword">class</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Extracts patches from a collection of images

    Read more in the :ref:`User Guide &lt;image_feature_extraction&gt;`.

    .. versionadded:: 0.9

    Parameters
    ----------
    patch_size : tuple of int (patch_height, patch_width), default=None
        The dimensions of one patch.

    max_patches : int or float, default=None
        The maximum number of patches per image to extract. If max_patches is a
        float in (0, 1), it is taken to mean a proportion of the total number
        of patches.

    random_state : int, RandomState instance, default=None
        Determines the random number generator used for random sampling when
        `max_patches` is not None. Use an int to make the randomness
        deterministic.
        See :term:`Glossary &lt;random_state&gt;`.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.datasets import load_sample_images
    &gt;&gt;&gt; from sklearn.feature_extraction import image
    &gt;&gt;&gt; # Use the array data from the second image in this dataset:
    &gt;&gt;&gt; X = load_sample_images().images[1]
    &gt;&gt;&gt; print('Image shape: {}'.format(X.shape))
    Image shape: (427, 640, 3)
    &gt;&gt;&gt; pe = image.PatchExtractor(patch_size=(2, 2))
    &gt;&gt;&gt; pe_fit = pe.fit(X)
    &gt;&gt;&gt; pe_trans = pe.transform(X)
    &gt;&gt;&gt; print('Patches shape: {}'.format(pe_trans.shape))
    Patches shape: (545706, 2, 2)
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">patch_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patch_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_patches</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Do nothing and return the estimator unchanged.

        This method is just there to implement the usual API and hence
        work in pipelines.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Training data.
        """</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Transforms the image samples in X into a matrix of patch data.

        Parameters
        ----------
        X : ndarray of shape (n_samples, image_height, image_width) or \
            (n_samples, image_height, image_width, n_channels)
            Array of images from which to extract patches. For color images,
            the last dimension specifies the channel: a RGB image would have
            `n_channels=3`.

        Returns
        -------
        patches : array of shape (n_patches, patch_height, patch_width) or \
             (n_patches, patch_height, patch_width, n_channels)
             The collection of patches extracted from the images, where
             `n_patches` is either `n_samples * max_patches` or the total
             number of patches that can be extracted.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">n_images</span><span class="punctuation">,</span> <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_images</span><span class="punctuation">,</span> <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">n_channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">patch_size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">patch_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">i_h</span> <span class="arithmetic-operator">//</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-operator">//</span> <span class="int-literal">10</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">patch_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">patch_size</span>

        <span class="comment"># compute the dimensions of the patches array</span>
        <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patch_size</span>
        <span class="identifier">n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_compute_n_patches</span><span class="grouping">(</span><span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_patches</span><span class="grouping">)</span>
        <span class="identifier">patches_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_images</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_patches</span><span class="punctuation">,</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">patch_size</span>
        <span class="keyword">if</span> <span class="identifier">n_channels</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">patches_shape</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">n_channels</span><span class="punctuation">,</span><span class="grouping">)</span>

        <span class="comment"># extract the patches</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">patches_shape</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">patches</span><span class="grouping">[</span><span class="identifier">ii</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_patches</span><span class="punctuation">:</span><span class="grouping">(</span><span class="identifier">ii</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_patches</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span>
                <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_patches</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">patches</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'X_types': ['3darray'</span><span class="grouping">]</span><span class="grouping">}</span>

    </pre>
  </body>
</html>