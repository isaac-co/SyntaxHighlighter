<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
==================
Prediction Latency
==================

This is an example showing the prediction latency of various scikit-learn
estimators.

The goal is to measure the latency one can expect when doing predictions
either in bulk or atomic (i.e. one by one) mode.

The plots represent the distribution of the prediction latency as a boxplot.

"""</span>

<span class="comment"># Authors: Eustache Diemert &lt;eustache@diemert.fr&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">collections</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span>

<span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">gc</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Ridge</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">SGDRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVR</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">shuffle</span>


<span class="keyword">def</span> <span class="identifier">_not_in_sphinx</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Hack to detect whether we are running by the sphinx builder</span>
    <span class="keyword">return</span> <span class="string-literal">'__file__'</span> <span class="relational-operator">in</span> <span class="invalid">g</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">b</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">s</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">atomic_benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Measure runtime prediction of each instance."""</span>
    <span class="identifier">n_instances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">runtimes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_instances</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_instances</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">instance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_test</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">instance</span><span class="grouping">)</span>
        <span class="identifier">runtimes</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span>
    <span class="keyword">if</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"atomic_benchmark runtimes:"</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span>
            <span class="identifier">runtimes</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">runtimes</span>


<span class="keyword">def</span> <span class="identifier">bulk_benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">n_bulk_repeats</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Measure runtime prediction of the whole input."""</span>
    <span class="identifier">n_instances</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">runtimes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_bulk_repeats</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_bulk_repeats</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="identifier">runtimes</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span>
    <span class="identifier">runtimes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">map</span><span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="identifier">x</span> <span class="arithmetic-operator">/</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">n_instances</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">runtimes</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"bulk_benchmark runtimes:"</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span>
            <span class="identifier">runtimes</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">runtimes</span>


<span class="keyword">def</span> <span class="identifier">benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">n_bulk_repeats</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Measure runtimes of prediction in both atomic and bulk mode.

    Parameters
    ----------
    estimator : already trained estimator supporting `predict()`
    X_test : test input
    n_bulk_repeats : how many times to repeat when evaluating bulk mode

    Returns
    -------
    atomic_runtimes, bulk_runtimes : a pair of `np.array` which contain the
    runtimes in seconds.

    """</span>
    <span class="identifier">atomic_runtimes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">atomic_benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="grouping">)</span>
    <span class="identifier">bulk_runtimes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bulk_benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">n_bulk_repeats</span><span class="punctuation">,</span>
                                             <span class="identifier">verbose</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">atomic_runtimes</span><span class="punctuation">,</span> <span class="identifier">bulk_runtimes</span>


<span class="keyword">def</span> <span class="identifier">generate_dataset</span><span class="grouping">(</span><span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Generate a regression dataset with the given parameters."""</span>
    <span class="keyword">if</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"generating dataset..."</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_train</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_test</span><span class="punctuation">,</span>
                                 <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="identifier">noise</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">random_seed</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">13</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">train_size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_seed</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_seed</span><span class="grouping">)</span>

    <span class="identifier">X_scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_scaler</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_scaler</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">y_scaler</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_scaler</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_scaler</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">gc</span><span class="punctuation">.</span><span class="identifier">collect</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"ok"</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span>


<span class="keyword">def</span> <span class="identifier">boxplot_runtimes</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="punctuation">,</span> <span class="identifier">pred_type</span><span class="punctuation">,</span> <span class="identifier">configuration</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Plot a new `Figure` with boxplots of prediction runtimes.

    Parameters
    ----------
    runtimes : list of `np.array` of latencies in micro-seconds
    cls_names : list of estimator class names that generated the runtimes
    pred_type : 'bulk' or 'atomic'

    """</span>

    <span class="identifier">fig</span><span class="punctuation">,</span> <span class="identifier">ax1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">bp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">boxplot</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="punctuation">,</span> <span class="grouping">)</span>

    <span class="identifier">cls_infos</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'%s\n(%d %s)' % (estimator_conf['name'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'complexity_computer'</span><span class="grouping">]</span><span class="grouping">(</span>
                                      <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'complexity_label'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span>
                 <span class="identifier">estimator_conf</span> <span class="relational-operator">in</span> <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">setp</span><span class="grouping">(</span><span class="identifier">ax1</span><span class="punctuation">,</span> <span class="identifier">xticklabels</span><span class="arithmetic-assignment">=</span><span class="identifier">cls_infos</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">setp</span><span class="grouping">(</span><span class="identifier">bp</span><span class="grouping">[</span><span class="string-literal">'boxes'], color='black'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">setp</span><span class="grouping">(</span><span class="identifier">bp</span><span class="grouping">[</span><span class="string-literal">'whiskers'], color='black'</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">setp</span><span class="grouping">(</span><span class="identifier">bp</span><span class="grouping">[</span><span class="string-literal">'fliers'], color='red', marker='+'</span><span class="grouping">)</span>

    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">yaxis</span><span class="punctuation">.</span><span class="identifier">grid</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">linestyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">'-', which='major', color='lightgrey'</span><span class="punctuation">,</span>
                   <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>

    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_axisbelow</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Prediction Time per Instance - %s, %d feats.'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
        <span class="identifier">pred_type</span><span class="punctuation">.</span><span class="identifier">capitalize</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_features'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Prediction Time (us)'</span><span class="grouping">)</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">benchmark</span><span class="grouping">(</span><span class="identifier">configuration</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Run the whole benchmark."""</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generate_dataset</span><span class="grouping">(</span>
        <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_train'], configuration['n_test'</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_features'</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">stats</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
    <span class="keyword">for</span> <span class="identifier">estimator_conf</span> <span class="relational-operator">in</span> <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Benchmarking"</span><span class="punctuation">,</span> <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="identifier">gc</span><span class="punctuation">.</span><span class="identifier">collect</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">a</span><span class="punctuation">,</span> <span class="identifier">b</span> <span class="arithmetic-assignment">=</span> <span class="identifier">benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="identifier">stats</span><span class="grouping">[</span><span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'name']] = {'atomic': a, 'bulk'</span><span class="punctuation">:</span> <span class="identifier">b</span><span class="grouping">}</span>

    <span class="identifier">cls_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'name'</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">estimator_conf</span> <span class="relational-operator">in</span> <span class="identifier">configuration</span><span class="grouping">[</span>
        <span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">runtimes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e6</span> <span class="arithmetic-operator">*</span> <span class="identifier">stats</span><span class="grouping">[</span><span class="identifier">clf_name</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'atomic'</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">clf_name</span> <span class="relational-operator">in</span> <span class="identifier">cls_names</span><span class="grouping">]</span>
    <span class="identifier">boxplot_runtimes</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="punctuation">,</span> <span class="string-literal">'atomic'</span><span class="punctuation">,</span> <span class="identifier">configuration</span><span class="grouping">)</span>
    <span class="identifier">runtimes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1e6</span> <span class="arithmetic-operator">*</span> <span class="identifier">stats</span><span class="grouping">[</span><span class="identifier">clf_name</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">'bulk'</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">clf_name</span> <span class="relational-operator">in</span> <span class="identifier">cls_names</span><span class="grouping">]</span>
    <span class="identifier">boxplot_runtimes</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="punctuation">,</span> <span class="string-literal">'bulk (%d)' % configuration['n_test'</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">configuration</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">n_feature_influence</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">percentile</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Estimate influence of the number of features on prediction time.

    Parameters
    ----------

    estimators : dict of (name (str), estimator) to benchmark
    n_train : nber of training instances (int)
    n_test : nber of testing instances (int)
    n_features : list of feature-space dimensionality to test (int)
    percentile : percentile at which to measure the speed (int [0-100])

    Returns:
    --------

    percentiles : dict(estimator_name,
                       dict(n_features, percentile_perf_in_us))

    """</span>
    <span class="identifier">percentiles</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">n</span> <span class="relational-operator">in</span> <span class="identifier">n_features</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"benchmarking with %d features"</span> <span class="arithmetic-operator">%</span> <span class="identifier">n</span><span class="grouping">)</span>
        <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generate_dataset</span><span class="grouping">(</span><span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">cls_name</span><span class="punctuation">,</span> <span class="identifier">estimator</span> <span class="relational-operator">in</span> <span class="identifier">estimators</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
            <span class="identifier">gc</span><span class="punctuation">.</span><span class="identifier">collect</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">runtimes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bulk_benchmark_estimator</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">percentiles</span><span class="grouping">[</span><span class="identifier">cls_name</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">n</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e6</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">runtimes</span><span class="punctuation">,</span>
                                                           <span class="identifier">percentile</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">percentiles</span>


<span class="keyword">def</span> <span class="identifier">plot_n_features_influence</span><span class="grouping">(</span><span class="identifier">percentiles</span><span class="punctuation">,</span> <span class="identifier">percentile</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">fig</span><span class="punctuation">,</span> <span class="identifier">ax1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">colors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'r', 'g', 'b'</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">cls_name</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">percentiles</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">n</span> <span class="keyword">for</span> <span class="identifier">n</span> <span class="relational-operator">in</span> <span class="identifier">percentiles</span><span class="grouping">[</span><span class="identifier">cls_name</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">percentiles</span><span class="grouping">[</span><span class="identifier">cls_name</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">n</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">n</span> <span class="relational-operator">in</span> <span class="identifier">x</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">yaxis</span><span class="punctuation">.</span><span class="identifier">grid</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">linestyle</span><span class="arithmetic-assignment">=</span><span class="string-literal">'-', which='major', color='lightgrey'</span><span class="punctuation">,</span>
                   <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_axisbelow</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Evolution of Prediction Time with #Features'</span><span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'#Features'</span><span class="grouping">)</span>
    <span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Prediction Time at %d%%-ile (us)'</span> <span class="arithmetic-operator">%</span> <span class="identifier">percentile</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">benchmark_throughputs</span><span class="grouping">(</span><span class="identifier">configuration</span><span class="punctuation">,</span> <span class="identifier">duration_secs</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""benchmark throughput for different estimators."""</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generate_dataset</span><span class="grouping">(</span>
        <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_train'], configuration['n_test'</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_features'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">throughputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">estimator_config</span> <span class="relational-operator">in</span> <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">estimator_config</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
        <span class="identifier">start_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">n_predictions</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="keyword">while</span> <span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">start_time</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">duration_secs</span><span class="punctuation">:</span>
            <span class="identifier">estimator_config</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">n_predictions</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="identifier">throughputs</span><span class="grouping">[</span><span class="identifier">estimator_config</span><span class="grouping">[</span><span class="string-literal">'name'</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_predictions</span> <span class="arithmetic-operator">/</span> <span class="identifier">duration_secs</span>
    <span class="keyword">return</span> <span class="identifier">throughputs</span>


<span class="keyword">def</span> <span class="identifier">plot_benchmark_throughput</span><span class="grouping">(</span><span class="identifier">throughputs</span><span class="punctuation">,</span> <span class="identifier">configuration</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">fig</span><span class="punctuation">,</span> <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">colors</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'r', 'g', 'b'</span><span class="grouping">]</span>
    <span class="identifier">cls_infos</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'%s\n(%d %s)' % (estimator_conf['name'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'complexity_computer'</span><span class="grouping">]</span><span class="grouping">(</span>
                                      <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'instance'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'complexity_label'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="keyword">for</span>
                 <span class="identifier">estimator_conf</span> <span class="relational-operator">in</span> <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">cls_values</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">throughputs</span><span class="grouping">[</span><span class="identifier">estimator_conf</span><span class="grouping">[</span><span class="string-literal">'name'</span><span class="grouping">]</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">estimator_conf</span> <span class="relational-operator">in</span>
                  <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'estimators'</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">bar</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">throughputs</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">cls_values</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">)</span>
    <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_xticks</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="float-literal">0.25</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">throughputs</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.75</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">throughputs</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_xticklabels</span><span class="grouping">(</span><span class="identifier">cls_infos</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">ymax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">cls_values</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.2</span>
    <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">ymax</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'Throughput (predictions/sec)'</span><span class="grouping">)</span>
    <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Prediction Throughput for different estimators (%d '</span>
                 <span class="string-literal">'features)' % configuration['n_features'</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="comment"># #############################################################################</span>
<span class="comment"># Main code</span>

<span class="identifier">start_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Benchmark bulk/atomic prediction speed for various regressors</span>
<span class="identifier">configuration</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">'n_train'</span><span class="punctuation">:</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e3</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="string-literal">'n_test'</span><span class="punctuation">:</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e2</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="string-literal">'n_features'</span><span class="punctuation">:</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e2</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="string-literal">'estimators'</span><span class="punctuation">:</span> <span class="grouping">[</span>
        <span class="grouping">{</span><span class="string-literal">'name': 'Linear Model'</span><span class="punctuation">,</span>
         <span class="string-literal">'instance': SGDRegressor(penalty='elasticnet'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                                  <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.25</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="string-literal">'complexity_label': 'non-zero coefficients'</span><span class="punctuation">,</span>
         <span class="string-literal">'complexity_computer'</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">clf</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">count_nonzero</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">'name': 'RandomForest'</span><span class="punctuation">,</span>
         <span class="string-literal">'instance'</span><span class="punctuation">:</span> <span class="identifier">RandomForestRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="string-literal">'complexity_label': 'estimators'</span><span class="punctuation">,</span>
         <span class="string-literal">'complexity_computer'</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">clf</span><span class="punctuation">:</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_estimators</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">'name': 'SVR'</span><span class="punctuation">,</span>
         <span class="string-literal">'instance': SVR(kernel='rbf'</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="string-literal">'complexity_label': 'support vectors'</span><span class="punctuation">,</span>
         <span class="string-literal">'complexity_computer'</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="identifier">clf</span><span class="punctuation">:</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">support_vectors_</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
<span class="grouping">}</span>
<span class="identifier">benchmark</span><span class="grouping">(</span><span class="identifier">configuration</span><span class="grouping">)</span>

<span class="comment"># benchmark n_features influence on prediction speed</span>
<span class="identifier">percentile</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">90</span>
<span class="identifier">percentiles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_feature_influence</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'ridge'</span><span class="punctuation">:</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
                                  <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_train'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">configuration</span><span class="grouping">[</span><span class="string-literal">'n_test'</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">250</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">percentile</span><span class="grouping">)</span>
<span class="identifier">plot_n_features_influence</span><span class="grouping">(</span><span class="identifier">percentiles</span><span class="punctuation">,</span> <span class="identifier">percentile</span><span class="grouping">)</span>

<span class="comment"># benchmark throughput</span>
<span class="identifier">throughputs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">benchmark_throughputs</span><span class="grouping">(</span><span class="identifier">configuration</span><span class="grouping">)</span>
<span class="identifier">plot_benchmark_throughput</span><span class="grouping">(</span><span class="identifier">throughputs</span><span class="punctuation">,</span> <span class="identifier">configuration</span><span class="grouping">)</span>

<span class="identifier">stop_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"example run in %.2fs"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">stop_time</span> <span class="arithmetic-operator">-</span> <span class="identifier">start_time</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>