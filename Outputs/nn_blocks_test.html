<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Tests for Faceswap Custom Layers.

Adapted from Keras tests.
"""</span>

<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">Input</span><span class="punctuation">,</span> <span class="identifier">Model</span><span class="punctuation">,</span> <span class="identifier">backend</span> <span class="keyword">as</span> <span class="identifier">K</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">model</span> <span class="keyword">import</span> <span class="identifier">nn_blocks</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_backend</span>


<span class="keyword">def</span> <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">layer_func</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test routine for faceswap neural network blocks.

    Tests are simple and are to ensure that the blocks compile on both tensorflow
    and plaidml backends
    """</span>
    <span class="comment"># generate input data</span>
    <span class="keyword">assert</span> <span class="identifier">input_shape</span>
    <span class="identifier">input_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">floatx</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">input_data_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">var_e</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">input_data_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">var_e</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">input_data_shape</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">input_data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">random</span><span class="grouping">(</span><span class="identifier">input_data_shape</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">input_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_data</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">input_dtype</span><span class="grouping">)</span>
    <span class="identifier">expected_output_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_dtype</span>

    <span class="comment"># test in functional API</span>
    <span class="identifier">inp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Input</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">input_shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">input_dtype</span><span class="grouping">)</span>
    <span class="identifier">outp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">layer_func</span><span class="grouping">(</span><span class="identifier">inp</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">(</span><span class="identifier">outp</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">expected_output_dtype</span>

    <span class="comment"># check with the functional API</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Model</span><span class="grouping">(</span><span class="identifier">inp</span><span class="punctuation">,</span> <span class="identifier">outp</span><span class="grouping">)</span>

    <span class="identifier">actual_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">input_data</span><span class="grouping">)</span>

    <span class="comment"># test serialization, weight setting at model level</span>
    <span class="identifier">model_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">recovered_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">g</span><span class="grouping">(</span><span class="identifier">model_config</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">weights</span><span class="punctuation">:</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">get_weights</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">recovered_model</span><span class="punctuation">.</span><span class="identifier">set_weights</span><span class="grouping">(</span><span class="identifier">weights</span><span class="grouping">)</span>
        <span class="identifier">_output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">recovered_model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">input_data</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">_output</span><span class="punctuation">,</span> <span class="identifier">actual_output</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>

    <span class="comment"># for further checks in the caller function</span>
    <span class="keyword">return</span> <span class="identifier">actual_output</span>


<span class="identifier">_PARAMS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"use_icnr_init", "use_convaware_init", "use_reflect_padding"</span><span class="grouping">]</span>
<span class="identifier">_VALUES</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">product</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">repeat</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">_PARAMS</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">_IDS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"{}[{}]".format("|"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">_PARAMS</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">b</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">b</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">upper</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">_VALUES</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="identifier">_PARAMS</span><span class="punctuation">,</span> <span class="identifier">_VALUES</span><span class="punctuation">,</span> <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="identifier">_IDS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_blocks</span><span class="grouping">(</span><span class="identifier">use_icnr_init</span><span class="punctuation">,</span> <span class="identifier">use_convaware_init</span><span class="punctuation">,</span> <span class="identifier">use_reflect_padding</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Test for all blocks contained within the NNBlocks Class """</span>
    <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">icnr_init</span><span class="arithmetic-assignment">=</span><span class="identifier">use_icnr_init</span><span class="punctuation">,</span>
                  <span class="identifier">conv_aware_init</span><span class="arithmetic-assignment">=</span><span class="identifier">use_convaware_init</span><span class="punctuation">,</span>
                  <span class="identifier">reflect_padding</span><span class="arithmetic-assignment">=</span><span class="identifier">use_reflect_padding</span><span class="grouping">)</span>
    <span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">set_config</span><span class="grouping">(</span><span class="identifier">config</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">Conv2DOutput</span><span class="grouping">(</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">Conv2DBlock</span><span class="grouping">(</span><span class="int-literal">64</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">SeparableConv2DBlock</span><span class="grouping">(</span><span class="int-literal">64</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">UpscaleBlock</span><span class="grouping">(</span><span class="int-literal">64</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">Upscale2xBlock</span><span class="grouping">(</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="identifier">fast</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">Upscale2xBlock</span><span class="grouping">(</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="identifier">fast</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">block_test</span><span class="grouping">(</span><span class="identifier">nn_blocks</span><span class="punctuation">.</span><span class="identifier">ResidualBlock</span><span class="grouping">(</span><span class="int-literal">64</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">64</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>