<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
==========================================
IsolationForest benchmark
==========================================
A test of IsolationForest on classical anomaly detection datasets.

The benchmark is run as follows:
1. The dataset is randomly split into a training set and a test set, both
assumed to contain outliers.
2. Isolation Forest is trained on the training set.
3. The ROC curve is computed on the test set using the knowledge of the labels.

Note that the smtp dataset contains a very small proportion of outliers.
Therefore, depending on the seed of the random number generator, randomly
splitting the data set might lead to a test set containing no outliers. In this
case a warning is raised when computing the ROC curve.
"""</span>

<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">IsolationForest</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">roc_curve</span><span class="punctuation">,</span> <span class="identifier">auc</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_kddcup99</span><span class="punctuation">,</span> <span class="identifier">fetch_covtype</span><span class="punctuation">,</span> <span class="identifier">fetch_openml</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">LabelBinarizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">shuffle</span> <span class="keyword">as</span> <span class="identifier">sh</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">print_outlier_ratio</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Helper function to show the distinct value count of element in the target.
    Useful indicator for the datasets used in bench_isolation_forest.py.
    """</span>
    <span class="identifier">uniq</span><span class="punctuation">,</span> <span class="identifier">cnt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"----- Target count values: "</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">u</span><span class="punctuation">,</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">uniq</span><span class="punctuation">,</span> <span class="identifier">cnt</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"------ %s -&gt; %d occurrences"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">u</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">c</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"----- Outlier ratio: %.5f"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">cnt</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
<span class="identifier">fig_roc</span><span class="punctuation">,</span> <span class="identifier">ax_roc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># Set this to true for plotting score histograms for each dataset:</span>
<span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">h</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

<span class="comment"># datasets available = ['http', 'smtp', 'SA', 'SF', 'shuttle', 'forestcover']</span>
<span class="identifier">datasets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'http', 'smtp', 'SA', 'SF', 'shuttle', 'forestcover'</span><span class="grouping">]</span>

<span class="comment"># Loop over all datasets for fitting and scoring the estimator:</span>
<span class="keyword">for</span> <span class="identifier">dat</span> <span class="relational-operator">in</span> <span class="identifier">datasets</span><span class="punctuation">:</span>

    <span class="comment"># Loading and vectorizing the data:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'====== %s ======'</span> <span class="arithmetic-operator">%</span> <span class="identifier">dat</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'--- Fetching data...'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">dat</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'http', 'smtp', 'SF', 'SA'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_kddcup99</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="identifier">dat</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                 <span class="identifier">percent10</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="keyword">if</span> <span class="identifier">dat</span> <span class="relational-operator">==</span> <span class="string-literal">'shuttle'</span><span class="punctuation">:</span>
        <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_openml</span><span class="grouping">(</span><span class="string-literal">'shuttle'</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sh</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="comment"># we remove data with label 4</span>
        <span class="comment"># normal data are then those of class 1</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">s</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">s</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'----- '</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dat</span> <span class="relational-operator">==</span> <span class="string-literal">'forestcover'</span><span class="punctuation">:</span>
        <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_covtype</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="comment"># normal data are those with attribute 2</span>
        <span class="comment"># abnormal those with attribute 4</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">4</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">s</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">s</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">print_outlier_ratio</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'--- Vectorizing data...'</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dat</span> <span class="relational-operator">==</span> <span class="string-literal">'SF'</span><span class="punctuation">:</span>
        <span class="identifier">lb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LabelBinarizer</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="identifier">b</span><span class="string-literal">'normal.'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">print_outlier_ratio</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dat</span> <span class="relational-operator">==</span> <span class="string-literal">'SA'</span><span class="punctuation">:</span>
        <span class="identifier">lb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LabelBinarizer</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lb</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">x2</span><span class="punctuation">,</span> <span class="identifier">x3</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="identifier">b</span><span class="string-literal">'normal.'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">print_outlier_ratio</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">dat</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'http', 'smtp'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">!=</span> <span class="identifier">b</span><span class="string-literal">'normal.'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">)</span>
        <span class="identifier">print_outlier_ratio</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">n_samples_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">float</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples_train</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">n_samples_train</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples_train</span><span class="grouping">]</span>
    <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">n_samples_train</span><span class="punctuation">:</span><span class="grouping">]</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'--- Fitting the IsolationForest estimator...'</span><span class="grouping">)</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">IsolationForest</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">tstart</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">fit_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tstart</span>
    <span class="identifier">tstart</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">scoring</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>  <span class="comment"># the lower, the more abnormal</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"--- Preparing the plot elements..."</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">h</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">g</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="identifier">fig</span><span class="punctuation">,</span> <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">sharex</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">sharey</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">200</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Decision function for %s dataset'</span> <span class="arithmetic-operator">%</span> <span class="identifier">dat</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">[</span><span class="identifier">y_test</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'b', label='normal data'</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lower right"</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">scoring</span><span class="grouping">[</span><span class="identifier">y_test</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'r', label='outliers'</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lower right"</span><span class="grouping">)</span>

    <span class="comment"># Show ROC Curves</span>
    <span class="identifier">predict_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tstart</span>
    <span class="identifier">fpr</span><span class="punctuation">,</span> <span class="identifier">tpr</span><span class="punctuation">,</span> <span class="identifier">thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roc_curve</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">scoring</span><span class="grouping">)</span>
    <span class="identifier">auc_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">auc</span><span class="grouping">(</span><span class="identifier">fpr</span><span class="punctuation">,</span> <span class="identifier">tpr</span><span class="grouping">)</span>
    <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'%s (AUC: %0.3f, train_time= %0.2fs, '</span>
             <span class="string-literal">'test_time= %0.2fs)'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">dat</span><span class="punctuation">,</span> <span class="identifier">auc_score</span><span class="punctuation">,</span> <span class="identifier">fit_time</span><span class="punctuation">,</span> <span class="identifier">predict_time</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># Print AUC score and train/test time:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">label</span><span class="grouping">)</span>
    <span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">fpr</span><span class="punctuation">,</span> <span class="identifier">tpr</span><span class="punctuation">,</span> <span class="identifier">lw</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>


<span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">set_xlim</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.05</span><span class="punctuation">,</span> <span class="float-literal">1.05</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'False Positive Rate'</span><span class="grouping">)</span>
<span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'True Positive Rate'</span><span class="grouping">)</span>
<span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'Receiver operating characteristic (ROC) curves'</span><span class="grouping">)</span>
<span class="identifier">ax_roc</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lower right"</span><span class="grouping">)</span>
<span class="identifier">fig_roc</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>