<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">binning</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">_BinMapper</span><span class="punctuation">,</span>
    <span class="identifier">_find_binning_thresholds</span><span class="punctuation">,</span>
    <span class="identifier">_map_to_bins</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">X_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">X_BINNED_DTYPE</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">common</span> <span class="keyword">import</span> <span class="identifier">ALMOST_INF</span>


<span class="identifier">DATA</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span>
    <span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e6</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_find_binning_thresholds_regular_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">1001</span><span class="grouping">)</span>
    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_find_binning_thresholds_small_regular_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span>

    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">11</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">.5</span><span class="grouping">)</span>

    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">255</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">.5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_find_binning_thresholds_random_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">255</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">254</span><span class="punctuation">,</span><span class="grouping">)</span>  <span class="comment"># 255 - 1</span>
        <span class="keyword">assert</span> <span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">dtype</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">192</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.7</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-1</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">192</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">9.99</span><span class="punctuation">,</span> <span class="float-literal">10.00</span><span class="punctuation">,</span> <span class="float-literal">10.01</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_find_binning_thresholds_low_n_bins</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">128</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">127</span><span class="punctuation">,</span><span class="grouping">)</span>  <span class="comment"># 128 - 1</span>
        <span class="keyword">assert</span> <span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">dtype</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_bins'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">257</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_invalid_n_bins</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">'n_bins={} should be no smaller than 3 and no larger than 256'</span>
        <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bin_mapper_n_features_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">)</span>
    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'This estimator was fitted with 2 features but 4 got passed'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'max_bins'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_map_to_bins</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">_find_binning_thresholds</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">max_bins</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_BINNED_DTYPE</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'F'</span><span class="grouping">)</span>
    <span class="identifier">last_bin_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_bins</span>
    <span class="identifier">_map_to_bins</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="punctuation">,</span> <span class="identifier">bin_thresholds</span><span class="punctuation">,</span> <span class="identifier">last_bin_idx</span><span class="punctuation">,</span> <span class="identifier">binned</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span>
    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">flags</span><span class="punctuation">.</span><span class="identifier">f_contiguous</span>

    <span class="identifier">min_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">max_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">feature_idx</span><span class="punctuation">,</span> <span class="identifier">min_idx</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">min_indices</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">binned</span><span class="grouping">[</span><span class="identifier">min_idx</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">for</span> <span class="identifier">feature_idx</span><span class="punctuation">,</span> <span class="identifier">max_idx</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">max_indices</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">binned</span><span class="grouping">[</span><span class="identifier">max_idx</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">max_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"max_bins"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bin_mapper_random_data</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">shape</span>

    <span class="identifier">expected_count_per_bin</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">//</span> <span class="identifier">max_bins</span>
    <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.05</span> <span class="arithmetic-operator">*</span> <span class="identifier">expected_count_per_bin</span><span class="grouping">)</span>

    <span class="comment"># max_bins is the number of bins for non-missing values</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_bins</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">)</span>
    <span class="identifier">binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">max_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_features</span>
    <span class="keyword">for</span> <span class="identifier">bin_thresholds_feature</span> <span class="relational-operator">in</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">bin_thresholds_feature</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">max_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">bin_thresholds_feature</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span> <span class="relational-operator">==</span> <span class="identifier">max_bins</span><span class="grouping">)</span>

    <span class="comment"># Check that the binned data is approximately balanced across bins.</span>
    <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">bin_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">count</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">binned</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">bin_idx</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">count</span> <span class="arithmetic-operator">-</span> <span class="identifier">expected_count_per_bin</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_samples, max_bins"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bin_mapper_small_random_data</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">max_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>

    <span class="comment"># max_bins is the number of bins for non-missing values</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_bins</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">assert</span> <span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"max_bins, n_distinct, multiplier"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bin_mapper_identity_repeated_values</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="punctuation">,</span> <span class="identifier">n_distinct</span><span class="punctuation">,</span> <span class="identifier">multiplier</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_distinct</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">multiplier</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="comment"># max_bins is the number of bins for non-missing values</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_bins</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">binned</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_distinct'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bin_mapper_repeated_values_invariance</span><span class="grouping">(</span><span class="identifier">n_distinct</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">distinct_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_distinct</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">distinct_values</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_distinct</span>

    <span class="identifier">repeated_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="identifier">n_distinct</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">distinct_values</span><span class="grouping">[</span><span class="identifier">repeated_indices</span><span class="grouping">]</span>
    <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">distinct_values</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">mapper_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_distinct</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">binned_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper_1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">binned_1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_distinct</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Adding more bins to the mapper yields the same results (same thresholds)</span>
    <span class="identifier">mapper_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">min</span><span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="identifier">n_distinct</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">binned_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper_2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">mapper_1</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">mapper_2</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned_1</span><span class="punctuation">,</span> <span class="identifier">binned_2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"max_bins, scale, offset"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bin_mapper_identity_small</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">offset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span> <span class="arithmetic-operator">+</span> <span class="identifier">offset</span>
    <span class="comment"># max_bins is the number of bins for non-missing values</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_bins</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">binned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">max_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'max_bins_small, max_bins_large'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">17</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bin_mapper_idempotence</span><span class="grouping">(</span><span class="identifier">max_bins_small</span><span class="punctuation">,</span> <span class="identifier">max_bins_large</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">max_bins_large</span> <span class="relational-operator">&gt;=</span> <span class="identifier">max_bins_small</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">30000</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">mapper_small</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">max_bins_small</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">mapper_large</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">max_bins_small</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">binned_small</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper_small</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">binned_large</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper_large</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">binned_small</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">binned_small</span><span class="punctuation">,</span> <span class="identifier">binned_large</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_bins'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'diff'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_bins_non_missing</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that n_bins_non_missing is n_unique_values when</span>
    <span class="comment"># there are not a lot of unique values, else n_bins - 1.</span>

    <span class="identifier">n_unique_values</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">+</span> <span class="identifier">diff</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_unique_values</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span> <span class="relational-operator">==</span> <span class="identifier">min</span><span class="grouping">(</span>
        <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_unique_values</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_subsample</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure bin thresholds are different when applying subsampling</span>
    <span class="identifier">mapper_no_subsample</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">subsample</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">)</span>
    <span class="identifier">mapper_subsample</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">subsample</span><span class="arithmetic-assignment">=</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">feature</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">DATA</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">mapper_no_subsample</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="identifier">feature</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">mapper_subsample</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="identifier">feature</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'n_bins, n_bins_non_missing, X_trans_expected'</span><span class="punctuation">,</span> <span class="grouping">[</span>
        <span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span>   <span class="int-literal">0</span><span class="punctuation">,</span>   <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 255 &lt;=&gt; missing value</span>
                          <span class="grouping">[</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span>   <span class="int-literal">0</span><span class="punctuation">,</span>   <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">255</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span>   <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span>   <span class="int-literal">1</span><span class="punctuation">,</span>   <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span>   <span class="int-literal">0</span><span class="punctuation">,</span>   <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># 2 &lt;=&gt; missing value</span>
                        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_missing_values_support</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="punctuation">,</span> <span class="identifier">X_trans_expected</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check for missing values: make sure nans are mapped to the last bin</span>
    <span class="comment"># and that the _BinMapper attributes are correct</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span>      <span class="int-literal">1</span><span class="punctuation">,</span>      <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">NaN</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">NaN</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span>      <span class="int-literal">1</span><span class="punctuation">,</span>      <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">NaN</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span>      <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span>      <span class="int-literal">2</span><span class="punctuation">,</span>      <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span>      <span class="int-literal">1</span><span class="punctuation">,</span>      <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">)</span>
    <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span><span class="punctuation">,</span> <span class="identifier">n_bins_non_missing</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">feature_idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="invalid">\</span>
            <span class="identifier">n_bins_non_missing</span><span class="grouping">[</span><span class="identifier">feature_idx</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="keyword">assert</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">missing_values_bin_idx_</span> <span class="relational-operator">==</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_trans_expected</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_infinite_values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure infinite values are properly handled.</span>
    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span>  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="punctuation">,</span> <span class="identifier">ALMOST_INF</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span>

    <span class="identifier">expected_binned_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_binned_X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_bins"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_categorical_feature</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Basic test for categorical features</span>
    <span class="comment"># we make sure that categories are mapped into [0, n_categories - 1] and</span>
    <span class="comment"># that nans are mapped to the last bin</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">500</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">[</span><span class="int-literal">13</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span> <span class="arithmetic-operator">+</span>
                  <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">known_categories</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span>
                            <span class="identifier">is_categorical</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">known_categories</span><span class="arithmetic-assignment">=</span><span class="identifier">known_categories</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">13</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">13</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">expected_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_trans</span><span class="grouping">)</span>

    <span class="comment"># For unknown categories, the mapping is incorrect / undefined. This never</span>
    <span class="comment"># happens in practice. This check is only for illustration purpose.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">expected_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_trans</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_bins"</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_categorical_with_numerical_features</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># basic check for binmapper with mixed data</span>
    <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># numerical</span>
    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>  <span class="comment"># categorical</span>
    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="grouping">]</span>
    <span class="identifier">known_categories</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span>
                            <span class="identifier">is_categorical</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">known_categories</span><span class="arithmetic-assignment">=</span><span class="identifier">known_categories</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">n_bins_non_missing_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">bin_thresholds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">bin_thresholds_</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_thresholds</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_X_trans</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_X_trans</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_make_known_categories_bitsets</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check the output of make_known_categories_bitsets</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">14</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">70</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">180</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">240</span><span class="punctuation">,</span> <span class="int-literal">180</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">256</span><span class="punctuation">,</span>
                            <span class="identifier">is_categorical</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">known_categories</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">known_cat_bitsets</span><span class="punctuation">,</span> <span class="identifier">f_idx_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">make_known_categories_bitsets</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Note that for non-categorical features, values are left to 0</span>
    <span class="identifier">expected_f_idx_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">expected_f_idx_map</span><span class="punctuation">,</span> <span class="identifier">f_idx_map</span><span class="grouping">)</span>

    <span class="identifier">expected_cat_bitset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint32</span><span class="grouping">)</span>

    <span class="comment"># first categorical feature: [2, 4, 10, 240]</span>
    <span class="identifier">f_idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">mapped_f_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f_idx_map</span><span class="grouping">[</span><span class="identifier">f_idx</span><span class="grouping">]</span>
    <span class="identifier">expected_cat_bitset</span><span class="grouping">[</span><span class="identifier">mapped_f_idx</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">4</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">10</span>
    <span class="comment"># 240 = 32**7 + 16, therefore the 16th bit of the 7th array is 1.</span>
    <span class="identifier">expected_cat_bitset</span><span class="grouping">[</span><span class="identifier">mapped_f_idx</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">16</span>

    <span class="comment"># second categorical feature [30, 70, 180]</span>
    <span class="identifier">f_idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">mapped_f_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f_idx_map</span><span class="grouping">[</span><span class="identifier">f_idx</span><span class="grouping">]</span>
    <span class="identifier">expected_cat_bitset</span><span class="grouping">[</span><span class="identifier">mapped_f_idx</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">30</span>
    <span class="identifier">expected_cat_bitset</span><span class="grouping">[</span><span class="identifier">mapped_f_idx</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">6</span>
    <span class="identifier">expected_cat_bitset</span><span class="grouping">[</span><span class="identifier">mapped_f_idx</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">**</span><span class="int-literal">20</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">expected_cat_bitset</span><span class="punctuation">,</span> <span class="identifier">known_cat_bitsets</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'is_categorical, known_categories, match'</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span>
     <span class="string-literal">'Known categories for feature 0 must be provided'</span><span class="grouping">)</span><span class="punctuation">,</span>

    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="string-literal">"isn't marked as a categorical feature, but categories were passed"</span><span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_categorical_parameters</span><span class="grouping">(</span><span class="identifier">is_categorical</span><span class="punctuation">,</span> <span class="identifier">known_categories</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test the validation of the is_categorical and known_categories parameters</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X_DTYPE</span><span class="grouping">)</span>

    <span class="identifier">bin_mapper</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_BinMapper</span><span class="grouping">(</span><span class="identifier">is_categorical</span><span class="arithmetic-assignment">=</span><span class="identifier">is_categorical</span><span class="punctuation">,</span>
                            <span class="identifier">known_categories</span><span class="arithmetic-assignment">=</span><span class="identifier">known_categories</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">match</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bin_mapper</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    </pre>
  </body>
</html>