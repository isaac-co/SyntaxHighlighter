<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Orthogonal matching pursuit algorithms
"""</span>

<span class="comment"># Author: Vlad Niculae</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">from</span> <span class="identifier">math</span> <span class="keyword">import</span> <span class="identifier">sqrt</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">lapack</span> <span class="keyword">import</span> <span class="identifier">get_lapack_funcs</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Parallel</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">LinearModel</span><span class="punctuation">,</span> <span class="identifier">_pre_fit</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">MultiOutputMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="punctuation">,</span> <span class="identifier">check_array</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">e</span><span class="invalid">d</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">check_cv</span>

<span class="identifier">premature</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="string-literal">"Orthogonal matching pursuit ended prematurely due to linear"</span>
    <span class="string-literal">" dependence in the dictionary. The requested precision might"</span>
    <span class="string-literal">" not have been met."</span>
<span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_cholesky_omp</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">copy_X</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Orthogonal Matching Pursuit step using the Cholesky decomposition.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Input dictionary. Columns are assumed to have unit norm.

    y : ndarray of shape (n_samples,)
        Input targets.

    n_nonzero_coefs : int
        Targeted number of non-zero elements.

    tol : float, default=None
        Targeted squared error, if not None overrides n_nonzero_coefs.

    copy_X : bool, default=True
        Whether the design matrix X must be copied by the algorithm. A false
        value is only helpful if X is already Fortran-ordered, otherwise a
        copy is made anyway.

    return_path : bool, default=False
        Whether to return every value of the nonzero coefficients along the
        forward path. Useful for cross-validation.

    Returns
    -------
    gamma : ndarray of shape (n_nonzero_coefs,)
        Non-zero elements of the solution.

    idx : ndarray of shape (n_nonzero_coefs,)
        Indices of the positions of the elements in gamma within the solution
        vector.

    coef : ndarray of shape (n_features, n_nonzero_coefs)
        The first k values of column k correspond to the coefficient value
        for the active features at that step. The lower left triangle contains
        garbage. Only returned if ``return_path=True``.

    n_active : int
        Number of active features at convergence.
    """</span>
    <span class="keyword">if</span> <span class="identifier">copy_X</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="string-literal">'F'</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># even if we are allowed to overwrite, still copy it if bad order</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">min_float</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
    <span class="identifier">nrm2</span><span class="punctuation">,</span> <span class="identifier">swap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">get_blas_funcs</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'nrm2', 'swap'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">potrs</span><span class="punctuation">,</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_lapack_funcs</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'potrs'</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">residual</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_active</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># keeping track of swapping</span>

    <span class="identifier">max_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">n_nonzero_coefs</span>

    <span class="identifier">L</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty_like</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">)</span>

    <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
        <span class="identifier">lam</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">residual</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">lam</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_active</span> <span class="logical-operator">or</span> <span class="identifier">alpha</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_float</span><span class="punctuation">:</span>
            <span class="comment"># atom already selected or inner product too small</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">premature</span><span class="punctuation">,</span> <span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">stacklevel</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
            <span class="keyword">break</span>

        <span class="keyword">if</span> <span class="identifier">n_active</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="comment"># Updates the Cholesky decomposition of X' X</span>
            <span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">solve_triangular</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">trans</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">lower</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="identifier">overwrite_b</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                    <span class="identifier">check_finite</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nrm2</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
            <span class="identifier">Lkk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="identifier">v</span>
            <span class="keyword">if</span> <span class="identifier">Lkk</span> <span class="relational-operator">&lt;=</span> <span class="identifier">min_float</span><span class="punctuation">:</span>  <span class="comment"># selected atoms are dependent</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">premature</span><span class="punctuation">,</span> <span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">stacklevel</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
                <span class="keyword">break</span>
            <span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="identifier">n_active</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">Lkk</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">L</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">swap</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">alpha</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span>
        <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span>
        <span class="identifier">n_active</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

        <span class="comment"># solves LL'x = X'y as a composition of two triangular systems</span>
        <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">potrs</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">lower</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                         <span class="identifier">overwrite_b</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
            <span class="identifier">coefs</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="identifier">n_active</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gamma</span>
        <span class="identifier">residual</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">nrm2</span><span class="grouping">(</span><span class="identifier">residual</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="relational-operator">&lt;=</span> <span class="identifier">tol</span><span class="punctuation">:</span>
            <span class="keyword">break</span>
        <span class="keyword">elif</span> <span class="identifier">n_active</span> <span class="relational-operator">==</span> <span class="identifier">max_features</span><span class="punctuation">:</span>
            <span class="keyword">break</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">coefs</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_active</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_active</span>


<span class="keyword">def</span> <span class="identifier">_gram_omp</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="punctuation">,</span> <span class="identifier">tol_0</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
              <span class="identifier">copy_Gram</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">copy_Xy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Orthogonal Matching Pursuit step on a precomputed Gram matrix.

    This function uses the Cholesky decomposition method.

    Parameters
    ----------
    Gram : ndarray of shape (n_features, n_features)
        Gram matrix of the input data matrix.

    Xy : ndarray of shape (n_features,)
        Input targets.

    n_nonzero_coefs : int
        Targeted number of non-zero elements.

    tol_0 : float, default=None
        Squared norm of y, required if tol is not None.

    tol : float, default=None
        Targeted squared error, if not None overrides n_nonzero_coefs.

    copy_Gram : bool, default=True
        Whether the gram matrix must be copied by the algorithm. A false
        value is only helpful if it is already Fortran-ordered, otherwise a
        copy is made anyway.

    copy_Xy : bool, default=True
        Whether the covariance vector Xy must be copied by the algorithm.
        If False, it may be overwritten.

    return_path : bool, default=False
        Whether to return every value of the nonzero coefficients along the
        forward path. Useful for cross-validation.

    Returns
    -------
    gamma : ndarray of shape (n_nonzero_coefs,)
        Non-zero elements of the solution.

    idx : ndarray of shape (n_nonzero_coefs,)
        Indices of the positions of the elements in gamma within the solution
        vector.

    coefs : ndarray of shape (n_features, n_nonzero_coefs)
        The first k values of column k correspond to the coefficient value
        for the active features at that step. The lower left triangle contains
        garbage. Only returned if ``return_path=True``.

    n_active : int
        Number of active features at convergence.
    """</span>
    <span class="identifier">Gram</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="string-literal">'F'</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">copy_Gram</span> <span class="keyword">else</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">copy_Xy</span> <span class="logical-operator">or</span> <span class="logical-operator">not</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">flags</span><span class="punctuation">.</span><span class="identifier">writeable</span><span class="punctuation">:</span>
        <span class="identifier">Xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">min_float</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
    <span class="identifier">nrm2</span><span class="punctuation">,</span> <span class="identifier">swap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">get_blas_funcs</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'nrm2', 'swap'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">potrs</span><span class="punctuation">,</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_lapack_funcs</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'potrs'</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span><span class="grouping">)</span>  <span class="comment"># keeping track of swapping</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xy</span>
    <span class="identifier">tol_curr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol_0</span>
    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_active</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">max_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">n_nonzero_coefs</span>

    <span class="identifier">L</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="identifier">L</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty_like</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">)</span>

    <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
        <span class="identifier">lam</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">lam</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_active</span> <span class="logical-operator">or</span> <span class="identifier">alpha</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_float</span><span class="punctuation">:</span>
            <span class="comment"># selected same atom twice, or inner product too small</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">premature</span><span class="punctuation">,</span> <span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">stacklevel</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
            <span class="keyword">break</span>
        <span class="keyword">if</span> <span class="identifier">n_active</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">lam</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span>
            <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">solve_triangular</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span>
                                    <span class="identifier">trans</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">lower</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                    <span class="identifier">overwrite_b</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                    <span class="identifier">check_finite</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nrm2</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
            <span class="identifier">Lkk</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">lam</span><span class="punctuation">,</span> <span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">v</span>
            <span class="keyword">if</span> <span class="identifier">Lkk</span> <span class="relational-operator">&lt;=</span> <span class="identifier">min_float</span><span class="punctuation">:</span>  <span class="comment"># selected atoms are dependent</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="identifier">premature</span><span class="punctuation">,</span> <span class="identifier">RuntimeWarning</span><span class="punctuation">,</span> <span class="identifier">stacklevel</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
                <span class="keyword">break</span>
            <span class="identifier">L</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="identifier">n_active</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">Lkk</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">L</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">lam</span><span class="punctuation">,</span> <span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">swap</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Gram</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">swap</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Gram</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span>
        <span class="identifier">Xy</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xy</span><span class="grouping">[</span><span class="identifier">lam</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="grouping">[</span><span class="identifier">n_active</span><span class="grouping">]</span>
        <span class="identifier">n_active</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
        <span class="comment"># solves LL'x = X'y as a composition of two triangular systems</span>
        <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">potrs</span><span class="grouping">(</span><span class="identifier">L</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">lower</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                         <span class="identifier">overwrite_b</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
            <span class="identifier">coefs</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="punctuation">,</span> <span class="identifier">n_active</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gamma</span>
        <span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="grouping">)</span>
        <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xy</span> <span class="arithmetic-operator">-</span> <span class="identifier">beta</span>
        <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">tol_curr</span> <span class="arithmetic-assignment">+=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span>
            <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inner</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">tol_curr</span> <span class="arithmetic-assignment">-=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span>
            <span class="keyword">if</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">tol_curr</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="identifier">tol</span><span class="punctuation">:</span>
                <span class="keyword">break</span>
        <span class="keyword">elif</span> <span class="identifier">n_active</span> <span class="relational-operator">==</span> <span class="identifier">max_features</span><span class="punctuation">:</span>
            <span class="keyword">break</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">coefs</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_active</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_active</span>


<span class="keyword">def</span> <span class="identifier">orthogonal_mp</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                  <span class="identifier">copy_X</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">r</span><span class="comment">"""Orthogonal Matching Pursuit (OMP).

    Solves n_targets Orthogonal Matching Pursuit problems.
    An instance of the problem has the form:

    When parametrized by the number of non-zero coefficients using
    `n_nonzero_coefs`:
    argmin ||y - X\gamma||^2 subject to ||\gamma||_0 &lt;= n_{nonzero coefs}

    When parametrized by error using the parameter `tol`:
    argmin ||\gamma||_0 subject to ||y - X\gamma||^2 &lt;= tol

    Read more in the :ref:`User Guide &lt;omp&gt;`.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Input data. Columns are assumed to have unit norm.

    y : ndarray of shape (n_samples,) or (n_samples, n_targets)
        Input targets.

    n_nonzero_coefs : int, default=None
        Desired number of non-zero entries in the solution. If None (by
        default) this value is set to 10% of n_features.

    tol : float, default=None
        Maximum norm of the residual. If not None, overrides n_nonzero_coefs.

    precompute : 'auto' or bool, default=False
        Whether to perform precomputations. Improves performance when n_targets
        or n_samples is very large.

    copy_X : bool, default=True
        Whether the design matrix X must be copied by the algorithm. A false
        value is only helpful if X is already Fortran-ordered, otherwise a
        copy is made anyway.

    return_path : bool, default=False
        Whether to return every value of the nonzero coefficients along the
        forward path. Useful for cross-validation.

    return_n_iter : bool, default=False
        Whether or not to return the number of iterations.

    Returns
    -------
    coef : ndarray of shape (n_features,) or (n_features, n_targets)
        Coefficients of the OMP solution. If `return_path=True`, this contains
        the whole coefficient path. In this case its shape is
        (n_features, n_features) or (n_features, n_targets, n_features) and
        iterating over the last axis yields coefficients in increasing order
        of active features.

    n_iters : array-like or int
        Number of active features across every target. Returned only if
        `return_n_iter` is set to True.

    See Also
    --------
    OrthogonalMatchingPursuit
    orthogonal_mp_gram
    lars_path
    sklearn.decomposition.sparse_encode

    Notes
    -----
    Orthogonal matching pursuit was introduced in S. Mallat, Z. Zhang,
    Matching pursuits with time-frequency dictionaries, IEEE Transactions on
    Signal Processing, Vol. 41, No. 12. (December 1993), pp. 3397-3415.
    (http://blanche.polytechnique.fr/~mallat/papiers/MallatPursuit93.pdf)

    This implementation is based on Rubinstein, R., Zibulevsky, M. and Elad,
    M., Efficient Implementation of the K-SVD Algorithm using Batch Orthogonal
    Matching Pursuit Technical Report - CS Technion, April 2008.
    https://www.cs.technion.ac.il/~ronrubin/Publications/KSVD-OMP-v2.pdf

    """</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'F'</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_X</span><span class="grouping">)</span>
    <span class="identifier">copy_X</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
    <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>  <span class="comment"># subsequent targets will be affected</span>
        <span class="identifier">copy_X</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="keyword">if</span> <span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="comment"># default for n_nonzero_coefs is 0.1 * n_features</span>
        <span class="comment"># but at least one.</span>
        <span class="identifier">n_nonzero_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">tol</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Epsilon cannot be negative"</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"The number of atoms must be positive"</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">&gt;</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"The number of atoms cannot be more than the number "</span>
                         <span class="string-literal">"of features"</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">precompute</span> <span class="relational-operator">==</span> <span class="string-literal">'auto'</span><span class="punctuation">:</span>
        <span class="identifier">precompute</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">precompute</span><span class="punctuation">:</span>
        <span class="identifier">G</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">G</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">G</span><span class="grouping">)</span>
        <span class="identifier">Xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">norms_squared</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">norms_squared</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">return</span> <span class="identifier">orthogonal_mp_gram</span><span class="grouping">(</span><span class="identifier">G</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">n_nonzero_coefs</span><span class="punctuation">,</span>
                                  <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">norms_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">norms_squared</span><span class="punctuation">,</span>
                                  <span class="identifier">copy_Gram</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_X</span><span class="punctuation">,</span> <span class="identifier">copy_Xy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                  <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">n_iters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_cholesky_omp</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span>
            <span class="identifier">copy_X</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
            <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span>
            <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coef</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">n_active</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">coefs</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">coef</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">n_active</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span>
            <span class="identifier">coef</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span>
        <span class="identifier">n_iters</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">n_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_iters</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="identifier">coef</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_iters</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="identifier">coef</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">orthogonal_mp_gram</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                       <span class="identifier">norms_squared</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">copy_Gram</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                       <span class="identifier">copy_Xy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                       <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Gram Orthogonal Matching Pursuit (OMP).

    Solves n_targets Orthogonal Matching Pursuit problems using only
    the Gram matrix X.T * X and the product X.T * y.

    Read more in the :ref:`User Guide &lt;omp&gt;`.

    Parameters
    ----------
    Gram : ndarray of shape (n_features, n_features)
        Gram matrix of the input data: X.T * X.

    Xy : ndarray of shape (n_features,) or (n_features, n_targets)
        Input targets multiplied by X: X.T * y.

    n_nonzero_coefs : int, default=None
        Desired number of non-zero entries in the solution. If None (by
        default) this value is set to 10% of n_features.

    tol : float, default=None
        Maximum norm of the residual. If not None, overrides n_nonzero_coefs.

    norms_squared : array-like of shape (n_targets,), default=None
        Squared L2 norms of the lines of y. Required if tol is not None.

    copy_Gram : bool, default=True
        Whether the gram matrix must be copied by the algorithm. A false
        value is only helpful if it is already Fortran-ordered, otherwise a
        copy is made anyway.

    copy_Xy : bool, default=True
        Whether the covariance vector Xy must be copied by the algorithm.
        If False, it may be overwritten.

    return_path : bool, default=False
        Whether to return every value of the nonzero coefficients along the
        forward path. Useful for cross-validation.

    return_n_iter : bool, default=False
        Whether or not to return the number of iterations.

    Returns
    -------
    coef : ndarray of shape (n_features,) or (n_features, n_targets)
        Coefficients of the OMP solution. If `return_path=True`, this contains
        the whole coefficient path. In this case its shape is
        (n_features, n_features) or (n_features, n_targets, n_features) and
        iterating over the last axis yields coefficients in increasing order
        of active features.

    n_iters : array-like or int
        Number of active features across every target. Returned only if
        `return_n_iter` is set to True.

    See Also
    --------
    OrthogonalMatchingPursuit
    orthogonal_mp
    lars_path
    sklearn.decomposition.sparse_encode

    Notes
    -----
    Orthogonal matching pursuit was introduced in G. Mallat, Z. Zhang,
    Matching pursuits with time-frequency dictionaries, IEEE Transactions on
    Signal Processing, Vol. 41, No. 12. (December 1993), pp. 3397-3415.
    (http://blanche.polytechnique.fr/~mallat/papiers/MallatPursuit93.pdf)

    This implementation is based on Rubinstein, R., Zibulevsky, M. and Elad,
    M., Efficient Implementation of the K-SVD Algorithm using Batch Orthogonal
    Matching Pursuit Technical Report - CS Technion, April 2008.
    https://www.cs.technion.ac.il/~ronrubin/Publications/KSVD-OMP-v2.pdf

    """</span>
    <span class="identifier">Gram</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'F'</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_Gram</span><span class="grouping">)</span>
    <span class="identifier">Xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">Xy</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span> <span class="logical-operator">and</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="comment"># or subsequent target will be affected</span>
        <span class="identifier">copy_Gram</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="keyword">if</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">Xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xy</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">norms_squared</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">norms_squared</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">copy_Xy</span> <span class="logical-operator">or</span> <span class="logical-operator">not</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">flags</span><span class="punctuation">.</span><span class="identifier">writeable</span><span class="punctuation">:</span>
        <span class="comment"># Make the copy once instead of many times in _gram_omp itself.</span>
        <span class="identifier">Xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">n_nonzero_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">norms_squared</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Gram OMP needs the precomputed norms in order '</span>
                         <span class="string-literal">'to evaluate the error sum of squares.'</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">tol</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Epsilon cannot be negative"</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"The number of atoms must be positive"</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">&gt;</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"The number of atoms cannot be more than the number "</span>
                         <span class="string-literal">"of features"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">Gram</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">n_iters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_gram_omp</span><span class="grouping">(</span>
            <span class="identifier">Gram</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="punctuation">,</span>
            <span class="identifier">norms_squared</span><span class="grouping">[</span><span class="identifier">k</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span>
            <span class="identifier">copy_Gram</span><span class="arithmetic-assignment">=</span><span class="identifier">copy_Gram</span><span class="punctuation">,</span> <span class="identifier">copy_Xy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="punctuation">:</span>
            <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span>
            <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coef</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">n_active</span><span class="punctuation">,</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">coefs</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">coef</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">n_active</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_active</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">out</span>
            <span class="identifier">coef</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span>
        <span class="identifier">n_iters</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">Xy</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">n_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_iters</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="identifier">coef</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">n_iters</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="identifier">coef</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">OrthogonalMatchingPursuit</span><span class="grouping">(</span><span class="identifier">MultiOutputMixin</span><span class="punctuation">,</span> <span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">LinearModel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Orthogonal Matching Pursuit model (OMP).

    Read more in the :ref:`User Guide &lt;omp&gt;`.

    Parameters
    ----------
    n_nonzero_coefs : int, default=None
        Desired number of non-zero entries in the solution. If None (by
        default) this value is set to 10% of n_features.

    tol : float, default=None
        Maximum norm of the residual. If not None, overrides n_nonzero_coefs.

    fit_intercept : bool, default=True
        whether to calculate the intercept for this model. If set
        to false, no intercept will be used in calculations
        (i.e. data is expected to be centered).

    normalize : bool, default=True
        This parameter is ignored when ``fit_intercept`` is set to False.
        If True, the regressors X will be normalized before regression by
        subtracting the mean and dividing by the l2-norm.
        If you wish to standardize, please use
        :class:`~sklearn.preprocessing.StandardScaler` before calling ``fit``
        on an estimator with ``normalize=False``.

    precompute : 'auto' or bool, default='auto'
        Whether to use a precomputed Gram and Xy matrix to speed up
        calculations. Improves performance when :term:`n_targets` or
        :term:`n_samples` is very large. Note that if you already have such
        matrices, you can pass them directly to the fit method.

    Attributes
    ----------
    coef_ : ndarray of shape (n_features,) or (n_targets, n_features)
        Parameter vector (w in the formula).

    intercept_ : float or ndarray of shape (n_targets,)
        Independent term in decision function.

    n_iter_ : int or array-like
        Number of active features across every target.

    n_nonzero_coefs_ : int
        The number of non-zero coefficients in the solution. If
        `n_nonzero_coefs` is None and `tol` is None this value is either set
        to 10% of `n_features` or 1, whichever is greater.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.linear_model import OrthogonalMatchingPursuit
    &gt;&gt;&gt; from sklearn.datasets import make_regression
    &gt;&gt;&gt; X, y = make_regression(noise=4, random_state=0)
    &gt;&gt;&gt; reg = OrthogonalMatchingPursuit().fit(X, y)
    &gt;&gt;&gt; reg.score(X, y)
    0.9991...
    &gt;&gt;&gt; reg.predict(X[:1,])
    array([-78.3854...])

    Notes
    -----
    Orthogonal matching pursuit was introduced in G. Mallat, Z. Zhang,
    Matching pursuits with time-frequency dictionaries, IEEE Transactions on
    Signal Processing, Vol. 41, No. 12. (December 1993), pp. 3397-3415.
    (http://blanche.polytechnique.fr/~mallat/papiers/MallatPursuit93.pdf)

    This implementation is based on Rubinstein, R., Zibulevsky, M. and Elad,
    M., Efficient Implementation of the K-SVD Algorithm using Batch Orthogonal
    Matching Pursuit Technical Report - CS Technion, April 2008.
    https://www.cs.technion.ac.il/~ronrubin/Publications/KSVD-OMP-v2.pdf

    See Also
    --------
    orthogonal_mp
    orthogonal_mp_gram
    lars_path
    Lars
    LassoLars
    sklearn.decomposition.sparse_encode
    OrthogonalMatchingPursuitCV
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_nonzero_coefs</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_intercept</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalize</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">precompute</span> <span class="arithmetic-assignment">=</span> <span class="identifier">precompute</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit the model using X, y as training data.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Training data.

        y : array-like of shape (n_samples,) or (n_samples, n_targets)
            Target values. Will be cast to X's dtype if necessary


        Returns
        -------
        self : object
            returns an instance of self.
        """</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">multi_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">y_numeric</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X_offset</span><span class="punctuation">,</span> <span class="identifier">y_offset</span><span class="punctuation">,</span> <span class="identifier">X_scale</span><span class="punctuation">,</span> <span class="identifier">Gram</span><span class="punctuation">,</span> <span class="identifier">Xy</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
            <span class="identifier">_pre_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">precompute</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="comment"># default for n_nonzero_coefs is 0.1 * n_features</span>
            <span class="comment"># but at least one.</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs</span>

        <span class="keyword">if</span> <span class="identifier">Gram</span> <span class="relational-operator">is</span> <span class="bool-literal">False</span><span class="punctuation">:</span>
            <span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orthogonal_mp</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs_</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
                <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">copy_X</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">norms_sq</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="none-literal">None</span>

            <span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orthogonal_mp_gram</span><span class="grouping">(</span>
                <span class="identifier">Gram</span><span class="punctuation">,</span> <span class="identifier">Xy</span><span class="arithmetic-assignment">=</span><span class="identifier">Xy</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs_</span><span class="punctuation">,</span>
                <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">norms_squared</span><span class="arithmetic-assignment">=</span><span class="identifier">norms_sq</span><span class="punctuation">,</span>
                <span class="identifier">copy_Gram</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">copy_Xy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_intercept</span><span class="grouping">(</span><span class="identifier">X_offset</span><span class="punctuation">,</span> <span class="identifier">y_offset</span><span class="punctuation">,</span> <span class="identifier">X_scale</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="keyword">def</span> <span class="identifier">_omp_path_residues</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                       <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute the residues on left-out data for a full LARS path.

    Parameters
    ----------
    X_train : ndarray of shape (n_samples, n_features)
        The data to fit the LARS on.

    y_train : ndarray of shape (n_samples)
        The target variable to fit LARS on.

    X_test : ndarray of shape (n_samples, n_features)
        The data to compute the residues on.

    y_test : ndarray of shape (n_samples)
        The target variable to compute the residues on.

    copy : bool, default=True
        Whether X_train, X_test, y_train and y_test should be copied.  If
        False, they may be overwritten.

    fit_intercept : bool, default=True
        Whether to calculate the intercept for this model. If set
        to false, no intercept will be used in calculations
        (i.e. data is expected to be centered).

    normalize : bool, default=True
        This parameter is ignored when ``fit_intercept`` is set to False.
        If True, the regressors X will be normalized before regression by
        subtracting the mean and dividing by the l2-norm.
        If you wish to standardize, please use
        :class:`~sklearn.preprocessing.StandardScaler` before calling ``fit``
        on an estimator with ``normalize=False``.

    max_iter : int, default=100
        Maximum numbers of iterations to perform, therefore maximum features
        to include. 100 by default.

    Returns
    -------
    residues : ndarray of shape (n_samples, max_features)
        Residues of the prediction on the test data.
    """</span>

    <span class="keyword">if</span> <span class="identifier">copy</span><span class="punctuation">:</span>
        <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_test</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">fit_intercept</span><span class="punctuation">:</span>
        <span class="identifier">X_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X_train</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X_mean</span>
        <span class="identifier">X_test</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">X_mean</span>
        <span class="identifier">y_mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_train</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">y_mean</span>
        <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">y_test</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">y_test</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">y_mean</span>

    <span class="keyword">if</span> <span class="identifier">normalize</span><span class="punctuation">:</span>
        <span class="identifier">norms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X_train</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">nonzeros</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span><span class="identifier">norms</span><span class="grouping">)</span>
        <span class="identifier">X_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">nonzeros</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">norms</span><span class="grouping">[</span><span class="identifier">nonzeros</span><span class="grouping">]</span>

    <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orthogonal_mp</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                          <span class="identifier">precompute</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">copy_X</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                          <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">coefs</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coefs</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">normalize</span><span class="punctuation">:</span>
        <span class="identifier">coefs</span><span class="grouping">[</span><span class="identifier">nonzeros</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">norms</span><span class="grouping">[</span><span class="identifier">nonzeros</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">coefs</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_test</span>


<span class="keyword">class</span> <span class="identifier">OrthogonalMatchingPursuitCV</span><span class="grouping">(</span><span class="identifier">RegressorMixin</span><span class="punctuation">,</span> <span class="identifier">LinearModel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Cross-validated Orthogonal Matching Pursuit model (OMP).

    See glossary entry for :term:`cross-validation estimator`.

    Read more in the :ref:`User Guide &lt;omp&gt;`.

    Parameters
    ----------
    copy : bool, default=True
        Whether the design matrix X must be copied by the algorithm. A false
        value is only helpful if X is already Fortran-ordered, otherwise a
        copy is made anyway.

    fit_intercept : bool, default=True
        whether to calculate the intercept for this model. If set
        to false, no intercept will be used in calculations
        (i.e. data is expected to be centered).

    normalize : bool, default=True
        This parameter is ignored when ``fit_intercept`` is set to False.
        If True, the regressors X will be normalized before regression by
        subtracting the mean and dividing by the l2-norm.
        If you wish to standardize, please use
        :class:`~sklearn.preprocessing.StandardScaler` before calling ``fit``
        on an estimator with ``normalize=False``.

    max_iter : int, default=None
        Maximum numbers of iterations to perform, therefore maximum features
        to include. 10% of ``n_features`` but at least 5 if available.

    cv : int, cross-validation generator or iterable, default=None
        Determines the cross-validation splitting strategy.
        Possible inputs for cv are:

        - None, to use the default 5-fold cross-validation,
        - integer, to specify the number of folds.
        - :term:`CV splitter`,
        - An iterable yielding (train, test) splits as arrays of indices.

        For integer/None inputs, :class:`KFold` is used.

        Refer :ref:`User Guide &lt;cross_validation&gt;` for the various
        cross-validation strategies that can be used here.

        .. versionchanged:: 0.22
            ``cv`` default value if None changed from 3-fold to 5-fold.

    n_jobs : int, default=None
        Number of CPUs to use during the cross validation.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

    verbose : bool or int, default=False
        Sets the verbosity amount.

    Attributes
    ----------
    intercept_ : float or ndarray of shape (n_targets,)
        Independent term in decision function.

    coef_ : ndarray of shape (n_features,) or (n_targets, n_features)
        Parameter vector (w in the problem formulation).

    n_nonzero_coefs_ : int
        Estimated number of non-zero coefficients giving the best mean squared
        error over the cross-validation folds.

    n_iter_ : int or array-like
        Number of active features across every target for the model refit with
        the best hyperparameters got by cross-validating across all folds.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.linear_model import OrthogonalMatchingPursuitCV
    &gt;&gt;&gt; from sklearn.datasets import make_regression
    &gt;&gt;&gt; X, y = make_regression(n_features=100, n_informative=10,
    ...                        noise=4, random_state=0)
    &gt;&gt;&gt; reg = OrthogonalMatchingPursuitCV(cv=5).fit(X, y)
    &gt;&gt;&gt; reg.score(X, y)
    0.9991...
    &gt;&gt;&gt; reg.n_nonzero_coefs_
    10
    &gt;&gt;&gt; reg.predict(X[:1,])
    array([-78.3854...])

    See Also
    --------
    orthogonal_mp
    orthogonal_mp_gram
    lars_path
    Lars
    LassoLars
    OrthogonalMatchingPursuit
    LarsCV
    LassoLarsCV
    sklearn.decomposition.sparse_encode

    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">copy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copy</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fit_intercept</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">normalize</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_jobs</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">verbose</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit the model using X, y as training data.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Training data.

        y : array-like of shape (n_samples,)
            Target values. Will be cast to X's dtype if necessary.

        Returns
        -------
        self : object
            returns an instance of self.
        """</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_numeric</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">ensure_min_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                   <span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_cv</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span>
                    <span class="keyword">else</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="grouping">)</span>
        <span class="identifier">cv_paths</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Parallel</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">)</span><span class="grouping">(</span>
            <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">_omp_path_residues</span><span class="grouping">)</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span> <span class="relational-operator">in</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">min_early_stop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">fold</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">fold</span> <span class="relational-operator">in</span> <span class="identifier">cv_paths</span><span class="grouping">)</span>
        <span class="identifier">mse_folds</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">fold</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">min_early_stop</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
                              <span class="keyword">for</span> <span class="identifier">fold</span> <span class="relational-operator">in</span> <span class="identifier">cv_paths</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">best_n_nonzero_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="identifier">mse_folds</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_nonzero_coefs_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">best_n_nonzero_coefs</span>
        <span class="identifier">omp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OrthogonalMatchingPursuit</span><span class="grouping">(</span><span class="identifier">n_nonzero_coefs</span><span class="arithmetic-assignment">=</span><span class="identifier">best_n_nonzero_coefs</span><span class="punctuation">,</span>
                                        <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span>
                                        <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">normalize</span><span class="grouping">)</span>
        <span class="identifier">omp</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">coef_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">omp</span><span class="punctuation">.</span><span class="identifier">coef_</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">intercept_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">omp</span><span class="punctuation">.</span><span class="identifier">intercept_</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">omp</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    </pre>
  </body>
</html>