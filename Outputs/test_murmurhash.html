<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Olivier Grisel &lt;olivier.grisel@ensta.org&gt;</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">murmurhash</span> <span class="keyword">import</span> <span class="identifier">murmurhash3_32</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>


<span class="keyword">def</span> <span class="identifier">test_mmhash3_int</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">847579505</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">847579505</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1823081949</span>

    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">847579505</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">847579505</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1823081949</span>

    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">847579505</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">847579505</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2471885347</span>


<span class="keyword">def</span> <span class="identifier">test_mmhash3_int_array</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">5342534</span><span class="punctuation">,</span> <span class="int-literal">345345</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span>
    <span class="identifier">keys</span> <span class="arithmetic-assignment">=</span> <span class="identifier">keys</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">seed</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="grouping">)</span>
                             <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">keys</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">seed</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                             <span class="keyword">for</span> <span class="identifier">k</span> <span class="relational-operator">in</span> <span class="identifier">keys</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">keys</span><span class="punctuation">,</span> <span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">expected</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mmhash3_bytes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">b</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">156908512</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">b</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1322301282</span>

    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">b</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4138058784</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">b</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2972666014</span>


<span class="keyword">def</span> <span class="identifier">test_mmhash3_unicode</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">156908512</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1322301282</span>

    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4138058784</span>
    <span class="keyword">assert</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="string-literal">'foo'</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2972666014</span>


<span class="keyword">def</span> <span class="identifier">test_no_collision_on_byte_range</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">previous_hashes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="string-literal">' '</span> <span class="arithmetic-operator">*</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">h</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">previous_hashes</span><span class="punctuation">,</span> <span class="invalid">\</span>
            <span class="string-literal">"Found collision on growing empty string"</span>


<span class="keyword">def</span> <span class="identifier">test_uniform_distribution</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100000</span>
    <span class="identifier">bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bins</span><span class="grouping">[</span><span class="identifier">murmurhash3_32</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">positive</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span> <span class="arithmetic-operator">%</span> <span class="identifier">n_bins</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

    <span class="identifier">means</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bins</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_bins</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">means</span> <span class="arithmetic-operator">/</span> <span class="identifier">expected</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_bins</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    </pre>
  </body>
</html>