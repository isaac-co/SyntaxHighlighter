<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">import</span> <span class="identifier">joblib</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">parse_version</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">linear_model</span><span class="punctuation">,</span> <span class="identifier">datasets</span><span class="punctuation">,</span> <span class="identifier">metrics</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span><span class="punctuation">,</span> <span class="identifier">is_classifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">OneClassSVM</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">LabelEncoder</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">MinMaxScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">kernel_approximation</span> <span class="keyword">import</span> <span class="identifier">Nystroem</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">StratifiedShuffleSplit</span><span class="punctuation">,</span> <span class="identifier">ShuffleSplit</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">_sgd_fast</span> <span class="keyword">as</span> <span class="identifier">sgd_fast</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">RandomizedSearchCV</span>


<span class="keyword">def</span> <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="string-literal">"random_state"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">kwargs</span><span class="punctuation">:</span>
        <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"random_state"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">42</span>

    <span class="keyword">if</span> <span class="string-literal">"tol"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">kwargs</span><span class="punctuation">:</span>
        <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"tol"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">if</span> <span class="string-literal">"max_iter"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">kwargs</span><span class="punctuation">:</span>
        <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"max_iter"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>


<span class="keyword">class</span> <span class="identifier">_SparseSGDClassifier</span><span class="grouping">(</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDClassifier</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">_SparseSGDRegressor</span><span class="grouping">(</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDRegressor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDRegressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDRegressor</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># XXX untested as of v0.22</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDRegressor</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span>
                                                           <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">_SparseSGDOneClassSVM</span><span class="grouping">(</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDOneClassSVM</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">args</span><span class="punctuation">,</span>
                                                             <span class="arithmetic-operator">**</span><span class="identifier">kw</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">SGDRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">SGDOneClassSVM</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDOneClassSVM</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">_SparseSGDClassifier</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">_SparseSGDRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_update_kwargs</span><span class="grouping">(</span><span class="identifier">kwargs</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">_SparseSGDOneClassSVM</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>


<span class="comment"># Test Data</span>

<span class="comment"># test sample 1</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
<span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">true_result</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>

<span class="comment"># test sample 2; string class labels</span>
<span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.75</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.5</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.75</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">Y2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"one"] * 3 + ["two"] * 3 + ["three"</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span>
<span class="identifier">T2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.5</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">true_result2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"one", "two", "three"</span><span class="grouping">]</span>

<span class="comment"># test sample 3</span>
<span class="identifier">X3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">Y3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="comment"># test sample 4 - two more or less redundant feature groups</span>
<span class="identifier">X4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">.84</span><span class="punctuation">,</span> <span class="float-literal">.98</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">.96</span><span class="punctuation">,</span> <span class="float-literal">.88</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">.91</span><span class="punctuation">,</span> <span class="float-literal">.99</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">.89</span><span class="punctuation">,</span> <span class="float-literal">.91</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">.79</span><span class="punctuation">,</span> <span class="float-literal">.84</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">.91</span><span class="punctuation">,</span> <span class="float-literal">.95</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">.93</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">Y4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># test sample 5 - test sample 1 as binary classification problem</span>
<span class="identifier">X5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">Y5</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
<span class="identifier">true_result5</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>


<span class="comment">###############################################################################</span>
<span class="comment"># Common Test Case to classification and regression</span>

<span class="comment"># a simple implementation of ASGD to use for testing</span>
<span class="comment"># uses squared loss to find the gradient</span>
<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">weight_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">weight_init</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weight_init</span>

    <span class="identifier">average_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">intercept_init</span>
    <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
    <span class="identifier">decay</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="comment"># sparse data has a fixed decay of .01</span>
    <span class="keyword">if</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">decay</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>

    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">entry</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">entry</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="grouping">)</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">intercept</span>
        <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">p</span> <span class="arithmetic-operator">-</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">eta</span> <span class="arithmetic-operator">*</span> <span class="identifier">alpha</span><span class="grouping">)</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">+=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">eta</span> <span class="arithmetic-operator">*</span> <span class="identifier">gradient</span> <span class="arithmetic-operator">*</span> <span class="identifier">entry</span><span class="grouping">)</span>
        <span class="identifier">intercept</span> <span class="arithmetic-assignment">+=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">eta</span> <span class="arithmetic-operator">*</span> <span class="identifier">gradient</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">decay</span>

        <span class="identifier">average_weights</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">i</span>
        <span class="identifier">average_weights</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">weights</span>
        <span class="identifier">average_weights</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span>

        <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">i</span>
        <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">intercept</span>
        <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span>

    <span class="keyword">return</span> <span class="identifier">average_weights</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_alpha</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad alpha</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">-.1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_penalty</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad penalty</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'foobar'</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.85</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_loss</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad loss</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"foobar"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_test_warm_start</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that explicit warm restart...</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span>
             <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># ... and implicit warm restart are equivalent.</span>
    <span class="identifier">clf3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="grouping">)</span>
    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="grouping">)</span>
    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">t_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"constant", "optimal", "invscaling", "adaptive"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_test_warm_start</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_input_format</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Input format tests.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">Y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>

    <span class="identifier">Y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="identifier">Y_</span><span class="punctuation">,</span> <span class="identifier">Y_</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_clone</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test whether clone works ok.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_plain_has_no_average_attr</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">.01</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_average_coef'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_average_intercept'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_standard_intercept'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_standard_coef'</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_average_coef'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_average_intercept'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_standard_intercept'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'_standard_coef'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_late_onset_averaging_not_reached</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="int-literal">600</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
            <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SGDRegressor</span><span class="punctuation">,</span>
                 <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_late_onset_averaging_reached</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">eta0</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.0001</span>
    <span class="identifier">Y_encode</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">Y_encode</span><span class="grouping">[</span><span class="identifier">Y_encode</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">-1.0</span>
    <span class="identifier">Y_encode</span><span class="grouping">[</span><span class="identifier">Y_encode</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                 <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta0</span><span class="punctuation">,</span>
                 <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                 <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta0</span><span class="punctuation">,</span>
                 <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y_encode</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y_encode</span><span class="grouping">)</span>

    <span class="identifier">average_weights</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y_encode</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span>
             <span class="identifier">weight_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">average_weights</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_alpha_for_optimal_learning_rate</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad alpha, i.e. 0</span>
    <span class="comment"># since alpha is used to compute the optimal learning rate</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"optimal"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_early_stopping</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">early_stopping</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="identifier">early_stopping</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span>
                    <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_iter</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_adaptive_longer_than_constant</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"adaptive"</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span>
                 <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span>
                 <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_validation_set_not_used_for_training</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">validation_fraction</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.4</span>
    <span class="identifier">seed</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">42</span>
    <span class="identifier">shuffle</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="identifier">validation_fraction</span><span class="punctuation">,</span>
                 <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                 <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="identifier">shuffle</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span>

    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                 <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="identifier">shuffle</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">is_classifier</span><span class="grouping">(</span><span class="identifier">clf2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StratifiedShuffleSplit</span><span class="grouping">(</span><span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="identifier">validation_fraction</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ShuffleSplit</span><span class="grouping">(</span><span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="identifier">validation_fraction</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">idx_train</span><span class="punctuation">,</span> <span class="identifier">idx_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">next</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">idx_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="identifier">idx_train</span><span class="grouping">)</span>  <span class="comment"># remove shuffling</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">idx_train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">idx_train</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_iter_no_change</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="comment"># test that n_iter_ increases monotonically with n_iter_no_change</span>
    <span class="keyword">for</span> <span class="identifier">early_stopping</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">n_iter_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="identifier">early_stopping</span><span class="punctuation">,</span>
                             <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter_no_change</span><span class="punctuation">,</span>
                             <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span>
                             <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>
                       <span class="keyword">for</span> <span class="identifier">n_iter_no_change</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">n_iter_list</span><span class="punctuation">,</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">n_iter_list</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_not_enough_sample_for_early_stopping</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test an error is raised if the training or validation set is empty</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.99</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="punctuation">,</span> <span class="identifier">Y3</span><span class="grouping">)</span>


<span class="comment">###############################################################################</span>
<span class="comment"># Classification Test Case</span>

<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_clf</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that SGD gives any results :-)</span>

    <span class="keyword">for</span> <span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"hinge", "squared_hinge", "log", "modified_huber"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                    <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="comment"># assert_almost_equal(clf.coef_[0], clf.coef_[1], decimal=7)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_l1_ratio</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad l1_ratio</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_learning_rate_schedule</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad learning_rate</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"&lt;unknown&gt;"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_bad_eta0</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check whether expected ValueError on bad eta0</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_max_iter_param</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test parameter validity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">10000</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_shuffle_param</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test parameter validity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="string-literal">"false"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_early_stopping_param</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test parameter validity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="string-literal">"false"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_validation_fraction</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test parameter validity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">validation_fraction</span><span class="arithmetic-assignment">=</span><span class="float-literal">-.1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_n_iter_no_change</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test parameter validity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_argument_coef</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks coef_init not allowed as model argument (only fit)</span>
    <span class="comment"># Provided coef_ does not match dataset</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_provide_coef</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks coef_init shape for the warm starts</span>
    <span class="comment"># Provided coef_ does not match dataset.</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_set_intercept</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks intercept_ shape for the warm starts</span>
    <span class="comment"># Provided intercept_ does not match dataset.</span>
    <span class="keyword">if</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">offset_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_early_stopping_with_partial_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test parameter validity check</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_set_intercept_binary</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks intercept_ shape for the warm starts in binary case</span>
    <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X5</span><span class="punctuation">,</span> <span class="identifier">Y5</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_average_binary_computed_correctly</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks the SGDClassifier correctly computes the average weights</span>
    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.1</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="punctuation">.</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># simple linear function without noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">average_weights</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>
    <span class="identifier">average_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">average_weights</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                              <span class="identifier">average_weights</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">14</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">14</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_set_intercept_to_intercept</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks intercept_ shape consistency for the warm starts</span>
    <span class="comment"># Inconsistent intercept_ shape.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X5</span><span class="punctuation">,</span> <span class="identifier">Y5</span><span class="grouping">)</span>
    <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X5</span><span class="punctuation">,</span> <span class="identifier">Y5</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_at_least_two_labels</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Target must have at least two labels</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">9</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_weight_class_balanced</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># partial_fit with class_weight='balanced' not supported"""</span>
    <span class="identifier">regex</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"class_weight 'balanced' is not supported for "</span>
             <span class="identifier">r</span><span class="string-literal">"partial_fit\. In order to use 'balanced' weights, "</span>
             <span class="identifier">r</span><span class="string-literal">"use compute_class_weight\('balanced', classes=classes, y=y\). "</span>
             <span class="identifier">r</span><span class="string-literal">"In place of y you can us a large enough sample "</span>
             <span class="identifier">r</span><span class="string-literal">"of the full training set target to properly "</span>
             <span class="identifier">r</span><span class="string-literal">"estimate the class frequency distributions\. "</span>
             <span class="identifier">r</span><span class="string-literal">"Pass the resulting weights as the class_weight "</span>
             <span class="identifier">r</span><span class="string-literal">"parameter\."</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">regex</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_multiclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Multi-class test case</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">true_result2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_multiclass_average</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>
    <span class="comment"># Multi-class average test case</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">np_Y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">Y2</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">np_Y2</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">np_Y2</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">cl</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y_i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">np_Y2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y_i</span><span class="grouping">[</span><span class="identifier">np_Y2</span> <span class="relational-operator">!=</span> <span class="identifier">cl</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y_i</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">average_intercept</span><span class="punctuation">,</span>
                            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_multiclass_with_init_coef</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Multi-class test case</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">true_result2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_multiclass_njobs</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Multi-class test case with multi-core support</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">true_result2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_set_coef_multiclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks coef_init and intercept_init shape for multi-class</span>
    <span class="comment"># problems</span>
    <span class="comment"># Provided coef_ does not match dataset</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Provided coef_ does match dataset</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Provided intercept_ does not match dataset</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Provided intercept_ does match dataset.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="identifier">intercept_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove filterwarnings in v1.2.</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:.*squared_loss.*:FutureWarning"</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_predict_proba_method_access</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks that SGDClassifier predict_proba and predict_log_proba methods</span>
    <span class="comment"># can either be accessed or raise an appropriate error message</span>
    <span class="comment"># otherwise. See</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/10938 for more</span>
    <span class="comment"># details.</span>
    <span class="keyword">for</span> <span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDClassifier</span><span class="punctuation">.</span><span class="identifier">loss_functions</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">loss</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'log', 'modified_huber'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'predict_proba'</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'predict_log_proba'</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"probability estimates are not "</span>
                       <span class="string-literal">"available for loss={!r}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">loss</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'predict_proba'</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'predict_log_proba'</span><span class="grouping">)</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span>
                               <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span>
                               <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_proba</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check SGD.predict_proba</span>

    <span class="comment"># Hinge loss does not allow for conditional prob estimate.</span>
    <span class="comment"># We cannot use the factory here, because it defines predict_proba</span>
    <span class="comment"># anyway.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hinge"</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                        <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"predict_log_proba"</span><span class="grouping">)</span>

    <span class="comment"># log and modified_huber losses can output probability estimates</span>
    <span class="comment"># binary case</span>
    <span class="keyword">for</span> <span class="identifier">loss</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"log", "modified_huber"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.5</span>

        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>

    <span class="comment"># log loss multiclass probability estimates</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"log"</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span>

    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">-.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.3</span><span class="punctuation">,</span> <span class="float-literal">.2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.1</span><span class="punctuation">,</span> <span class="float-literal">-.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.3</span><span class="punctuation">,</span> <span class="float-literal">.2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">d</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">lp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">lp</span><span class="grouping">)</span>

    <span class="identifier">lp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">lp</span><span class="grouping">)</span>

    <span class="comment"># Modified Huber multiclass probability estimates; requires a separate</span>
    <span class="comment"># test because the hard zero/one probabilities may destroy the</span>
    <span class="comment"># ordering present in decision_function output.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"modified_huber"</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">klass</span> <span class="relational-operator">!=</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>   <span class="comment"># XXX the sparse test gets a different X2 (?)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># the following sample produces decision_function values &lt; -1,</span>
    <span class="comment"># which would cause naive normalization to fail (see comment</span>
    <span class="comment"># in SGDClassifier.predict_proba)</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">d</span> <span class="relational-operator">&lt;</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># XXX not true in sparse test case (why?)</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_l1</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test L1 regularization</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X4</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">13</span><span class="grouping">)</span>
    <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n</span><span class="grouping">)</span>
    <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X4</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y4</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2000</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="comment"># test sparsify with dense inputs</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">sparsify</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="comment"># pickle and unpickle with sparse coef_</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weights</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test class weights.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># we give a small weights to class 1</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.001</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># now the hyperplane should rotate clock-wise and</span>
    <span class="comment"># the prediction on this point should shift</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_equal_class_weight</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if equal class weights approx. equals no class weights.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">clf_weighted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                         <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="identifier">clf_weighted</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># should be similar up to some epsilon due to learning rate schedule</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_weighted</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_wrong_class_weight_label</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># ValueError due to not existing class label.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_wrong_class_weight_format</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># ValueError due to wrong class_weight argument type.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_weights_multiplied</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests that class_weight and sample_weight are multiplicative</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">.6</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="float-literal">.3</span><span class="grouping">}</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">sample_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="identifier">Y4</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">multiplied_together</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">sample_weights</span><span class="grouping">)</span>
    <span class="identifier">multiplied_together</span><span class="grouping">[</span><span class="identifier">Y4</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">multiplied_together</span><span class="grouping">[</span><span class="identifier">Y4</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>

    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>

    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X4</span><span class="punctuation">,</span> <span class="identifier">Y4</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weights</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X4</span><span class="punctuation">,</span> <span class="identifier">Y4</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">multiplied_together</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_balanced_weight</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test class weights for imbalanced data"""</span>
    <span class="comment"># compute reference metrics on iris dataset that is quite balanced by</span>
    <span class="comment"># default</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">6</span><span class="grouping">)</span>
    <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0001</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">f1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">f1</span><span class="punctuation">,</span> <span class="float-literal">0.96</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># make the same prediction using balanced class_weight</span>
    <span class="identifier">clf_balanced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0001</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                         <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">"balanced"</span><span class="punctuation">,</span>
                         <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">f1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">clf_balanced</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">f1</span><span class="punctuation">,</span> <span class="float-literal">0.96</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># Make sure that in the balanced case it does not change anything</span>
    <span class="comment"># to use "balanced"</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_balanced</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span>

    <span class="comment"># build an very very imbalanced dataset out of iris data</span>
    <span class="identifier">X_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">y_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">X_imbalanced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">X_0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">y_imbalanced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="identifier">y_0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">10</span><span class="grouping">)</span>

    <span class="comment"># fit a model on the imbalanced data without class weight info</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_imbalanced</span><span class="punctuation">,</span> <span class="identifier">y_imbalanced</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.96</span>

    <span class="comment"># fit a model with balanced class_weight enabled</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">"balanced"</span><span class="punctuation">,</span>
                <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_imbalanced</span><span class="punctuation">,</span> <span class="identifier">y_imbalanced</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">f1_score</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="string-literal">'weighted'</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.96</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sample_weights</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test weights on individual samples</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-.8</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># we give a small weights to class 1</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.001</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># now the hyperplane should rotate clock-wise and</span>
    <span class="comment"># the prediction on this point should shift</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="punctuation">,</span>
                                   <span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_wrong_sample_weights</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if ValueError is raised if sample_weight has wrong shape</span>
    <span class="keyword">if</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">klass</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="comment"># provided sample_weight too long</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">7</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_exception</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
    <span class="comment"># classes was not specified</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="punctuation">,</span> <span class="identifier">Y3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_binary</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">third</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">id1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">id2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="comment"># check that coef_ haven't been re-allocated</span>
    <span class="keyword">assert</span> <span class="identifier">id1</span><span class="punctuation">,</span> <span class="identifier">id2</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_multiclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">third</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y2</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">id1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">id2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="comment"># check that coef_ haven't been re-allocated</span>
    <span class="keyword">assert</span> <span class="identifier">id1</span><span class="punctuation">,</span> <span class="identifier">id2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_multiclass_average</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">third</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y2</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_fit_then_partial_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Partial_fit should work after initial fit in the multiclass case.</span>
    <span class="comment"># Non-regression test for #2496; fit would previously produce a</span>
    <span class="comment"># Fortran-ordered coef_ that subsequent partial_fit couldn't handle.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span>     <span class="comment"># no exception here</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"constant", "optimal", "invscaling", "adaptive"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_equal_fit_classif</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">Y_</span><span class="punctuation">,</span> <span class="identifier">T_</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="identifier">T2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                    <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">Y_</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">T_</span><span class="grouping">)</span>
        <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span>

        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">Y_</span><span class="grouping">)</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span>
                    <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X_</span><span class="punctuation">,</span> <span class="identifier">Y_</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">)</span>
        <span class="identifier">y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">T_</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">t</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred2</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_regression_losses</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"epsilon_insensitive"</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="float-literal">1.0</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_epsilon_insensitive"</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="float-literal">1.0</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"huber"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="float-literal">1.0</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_error"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="float-literal">1.0</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start_multiclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_test_warm_start</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="punctuation">,</span> <span class="string-literal">"optimal"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">SparseSGDClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_multiple_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test multiple calls of fit w/ different shaped inputs.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"coef_"</span><span class="grouping">)</span>

    <span class="comment"># Non-regression test: try fitting with a different label set.</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="string-literal">"ham", "spam"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">LabelEncoder</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="comment">###############################################################################</span>
<span class="comment"># Regression Test Case</span>

<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_reg</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that SGD gives any results.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_averaged_computed_correctly</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests the average regressor matches the naive implementation</span>

    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># simple linear function without noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">average_weights</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                              <span class="identifier">average_weights</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_averaged_partial_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests whether the partial fit yields the same average as the fit</span>
    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># simple linear function without noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">average_weights</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                              <span class="identifier">average_weights</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_average_sparse</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks the average weights on data with 0s</span>

    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y3</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y3</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y3</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">average_weights</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X3</span><span class="punctuation">,</span> <span class="identifier">Y3</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span>
                              <span class="identifier">average_weights</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">average_intercept</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_least_squares_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">xmax</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">xmax</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># simple linear function without noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.99</span>

    <span class="comment"># simple linear function with noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_error'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_epsilon_insensitive</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">xmax</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">xmax</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># simple linear function without noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'epsilon_insensitive'</span><span class="punctuation">,</span> <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.99</span>

    <span class="comment"># simple linear function with noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'epsilon_insensitive'</span><span class="punctuation">,</span> <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_huber_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">xmax</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">xmin</span><span class="punctuation">,</span> <span class="identifier">xmax</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># simple linear function without noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"huber"</span><span class="punctuation">,</span> <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.99</span>

    <span class="comment"># simple linear function with noise</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"huber"</span><span class="punctuation">,</span> <span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_elasticnet_convergence</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that the SGD output is consistent with coordinate descent</span>

    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">5</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="comment"># ground_truth linear model that generate y from X and to which the</span>
    <span class="comment"># models should converge if the regularizer would be set to 0.0</span>
    <span class="identifier">ground_truth_coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ground_truth_coef</span><span class="grouping">)</span>

    <span class="comment"># XXX: alpha = 0.1 seems to cause convergence problems</span>
    <span class="keyword">for</span> <span class="identifier">alpha</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.001</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">l1_ratio</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.8</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">cd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">ElasticNet</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span>
                                         <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">cd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">sgd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'elasticnet'</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span>
                        <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span>
                        <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">sgd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"cd and sgd did not converge to comparable "</span>
                       <span class="string-literal">"results for alpha=%f and l1_ratio=%f"</span>
                       <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">cd</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">sgd</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">third</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">id1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">id2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="comment"># check that coef_ haven't been re-allocated</span>
    <span class="keyword">assert</span> <span class="identifier">id1</span><span class="punctuation">,</span> <span class="identifier">id2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"constant", "optimal", "invscaling", "adaptive"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_equal_fit</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">y_pred2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">t</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">y_pred2</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDRegressor</span><span class="punctuation">,</span> <span class="identifier">SparseSGDRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_loss_function_epsilon</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.9</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">epsilon</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">loss_functions</span><span class="grouping">[</span><span class="string-literal">'huber'</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="float-literal">0.1</span>


<span class="comment">###############################################################################</span>
<span class="comment"># SGD One Class SVM Test Case</span>

<span class="comment"># a simple implementation of ASGD to use for testing SGDOneClassSVM</span>
<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="punctuation">,</span> <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">offset_init</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">coef_init</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coef_init</span>

    <span class="identifier">average_coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">offset_init</span>
    <span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">offset</span>
    <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
    <span class="identifier">decay</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="comment"># sparse data has a fixed decay of .01</span>
    <span class="keyword">if</span> <span class="identifier">klass</span> <span class="relational-operator">==</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="punctuation">:</span>
        <span class="identifier">decay</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>

    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">entry</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">entry</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="grouping">)</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">intercept</span>
        <span class="keyword">if</span> <span class="identifier">p</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">1.0</span><span class="punctuation">:</span>
            <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">eta</span> <span class="arithmetic-operator">*</span> <span class="identifier">nu</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">coef</span> <span class="arithmetic-assignment">+=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">eta</span> <span class="arithmetic-operator">*</span> <span class="identifier">gradient</span> <span class="arithmetic-operator">*</span> <span class="identifier">entry</span><span class="grouping">)</span>
        <span class="identifier">intercept</span> <span class="arithmetic-assignment">+=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">eta</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">nu</span> <span class="arithmetic-operator">+</span> <span class="identifier">gradient</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">decay</span>

        <span class="identifier">average_coef</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">i</span>
        <span class="identifier">average_coef</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">coef</span>
        <span class="identifier">average_coef</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span>

        <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">i</span>
        <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">intercept</span>
        <span class="identifier">average_intercept</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span>

    <span class="keyword">return</span> <span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">average_intercept</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'nu'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_bad_nu_values</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"nu must be in \(0, 1]"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">_test_warm_start_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that explicit warm restart...</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">offset_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># ... and implicit warm restart are equivalent.</span>
    <span class="identifier">clf3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="grouping">)</span>
    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">t_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"constant", "optimal", "invscaling", "adaptive"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_warm_start_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">_test_warm_start_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_clone_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test whether clone works ok.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">third</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">third</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span>
    <span class="identifier">previous_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">third</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="comment"># check that coef_ haven't been re-allocated</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span> <span class="relational-operator">is</span> <span class="identifier">previous_coefs</span>

    <span class="comment"># raises ValueError if number of features does not match previous data</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'lr'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"constant", "optimal", "invscaling", "adaptive"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_partial_fit_equal_fit_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">lr</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span>
    <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span>
    <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y_scores2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">t_</span> <span class="relational-operator">==</span> <span class="identifier">t</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">y_scores</span><span class="punctuation">,</span> <span class="identifier">y_scores2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">,</span> <span class="identifier">offset</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_late_onset_averaging_reached_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test average</span>
    <span class="identifier">eta0</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">nu</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.05</span>

    <span class="comment"># 2 passes over the training set but average only at second pass</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta0</span><span class="punctuation">,</span>
                 <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="comment"># 1 pass over the training set with no averaging</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta0</span><span class="punctuation">,</span>
                 <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Start from clf2 solution, compute averaging using asgd function and</span>
    <span class="comment"># compare with clf1 solution</span>
    <span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="identifier">average_offset</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="punctuation">,</span>
                      <span class="identifier">coef_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">offset_init</span><span class="arithmetic-assignment">=</span><span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">average_coef</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">,</span> <span class="identifier">average_offset</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_averaged_computed_correctly_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests the average SGD One-Class SVM matches the naive implementation</span>
    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">nu</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.05</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="identifier">average_offset</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">average_coef</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">,</span> <span class="identifier">average_offset</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sgd_averaged_partial_fit_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Tests whether the partial fit yields the same average as the fit</span>
    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">nu</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.05</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="identifier">average_offset</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">average_coef</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">,</span> <span class="identifier">average_offset</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'klass'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">SGDOneClassSVM</span><span class="punctuation">,</span> <span class="identifier">SparseSGDOneClassSVM</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_average_sparse_oneclass</span><span class="grouping">(</span><span class="identifier">klass</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks the average coef on data with 0s</span>
    <span class="identifier">eta</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.001</span>
    <span class="identifier">nu</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.01</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">klass</span><span class="grouping">(</span><span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span>
                <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">average</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X3</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">partial_fit</span><span class="grouping">(</span><span class="identifier">X3</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">average_coef</span><span class="punctuation">,</span> <span class="identifier">average_offset</span> <span class="arithmetic-assignment">=</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">g</span><span class="invalid">d</span><span class="invalid">_</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">klass</span><span class="punctuation">,</span> <span class="identifier">X3</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">average_coef</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="punctuation">,</span> <span class="identifier">average_offset</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sgd_oneclass</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test fit, decision_function, predict and score_samples on a toy</span>
    <span class="comment"># dataset</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDOneClassSVM</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span>
                         <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.125</span><span class="punctuation">,</span> <span class="float-literal">0.4375</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="float-literal">-0.5</span>

    <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.9375</span><span class="punctuation">,</span> <span class="float-literal">0.625</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">dec</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">offset_</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dec</span><span class="grouping">)</span>

    <span class="identifier">pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">pred</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_ocsvm_vs_sgdocsvm</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks SGDOneClass SVM gives a good approximation of kernelized</span>
    <span class="comment"># One-Class SVM</span>
    <span class="identifier">nu</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.05</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="punctuation">.</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">42</span>

    <span class="comment"># Generate train and test data</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">]</span>

    <span class="comment"># One-Class SVM</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OneClassSVM</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'rbf'</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred_ocsvm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">dec_ocsvm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="comment"># SGDOneClassSVM using kernel approximation</span>
    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">15</span>
    <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">clf_sgd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDOneClassSVM</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                             <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                             <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
    <span class="identifier">pipe_sgd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">transform</span><span class="punctuation">,</span> <span class="identifier">clf_sgd</span><span class="grouping">)</span>
    <span class="identifier">pipe_sgd</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">y_pred_sgdocsvm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe_sgd</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">dec_sgdocsvm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe_sgd</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">y_pred_sgdocsvm</span> <span class="relational-operator">==</span> <span class="identifier">y_pred_ocsvm</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">0.99</span>
    <span class="identifier">corrcoef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">corrcoef</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">dec_ocsvm</span><span class="punctuation">,</span> <span class="identifier">dec_sgdocsvm</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">corrcoef</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">0.9</span>


<span class="keyword">def</span> <span class="identifier">test_l1_ratio</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if l1 ratio extremes match L1 and L2 penalty settings.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                                        <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1234</span><span class="grouping">)</span>

    <span class="comment"># test if elasticnet with l1_ratio near 1 gives same result as pure l1</span>
    <span class="identifier">est_en</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'elasticnet'</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                           <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.9999999999</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">est_l1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l1'</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est_en</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">est_l1</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>

    <span class="comment"># test if elasticnet with l1_ratio near 0 gives same result as pure l2</span>
    <span class="identifier">est_en</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'elasticnet'</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                           <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0000000001</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">est_l2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2'</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est_en</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">est_l2</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_underflow_or_overlow</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">all</span><span class="arithmetic-assignment">=</span><span class="string-literal">'raise'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Generate some weird data with hugely unscaled features</span>
        <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
        <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>

        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">1e300</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># Use MinMaxScaler to scale the data without introducing a numerical</span>
        <span class="comment"># instability (computing the standard deviation naively is not possible</span>
        <span class="comment"># on this data)</span>
        <span class="identifier">X_scaled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MinMaxScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">X_scaled</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># Define a ground truth on the scaled data</span>
        <span class="identifier">ground_truth</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_scaled</span><span class="punctuation">,</span> <span class="identifier">ground_truth</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_hinge'</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">500</span><span class="grouping">)</span>

        <span class="comment"># smoke test: model is stable on scaled data</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_scaled</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># model is numerically unstable on unscaled data</span>
        <span class="identifier">msg_regxp</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"Floating-point under-/overflow occurred at epoch #.*"</span>
                     <span class="string-literal">" Scaling input data with StandardScaler or MinMaxScaler"</span>
                     <span class="string-literal">" might help."</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg_regxp</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_numerical_stability_large_gradient</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non regression test case for numerical stability on scaled problems</span>
    <span class="comment"># where the gradient can still explode with some losses</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">'squared_hinge'</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                          <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'elasticnet'</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span>
                          <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">all</span><span class="arithmetic-assignment">=</span><span class="string-literal">'raise'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'penalty', ['l2', 'l1', 'elasticnet'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_large_regularization</span><span class="grouping">(</span><span class="identifier">penalty</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non regression tests for numerical stability issues caused by large</span>
    <span class="comment"># regularization parameters</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e5</span><span class="punctuation">,</span> <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="string-literal">'constant'</span><span class="punctuation">,</span> <span class="identifier">eta0</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span>
                          <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="identifier">penalty</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                          <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">all</span><span class="arithmetic-assignment">=</span><span class="string-literal">'raise'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros_like</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_tol_parameter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the tol parameter behaves as expected</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="comment"># With tol is None, the number of iteration should be equal to max_iter</span>
    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">42</span>
    <span class="identifier">model_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="grouping">)</span>
    <span class="identifier">model_0</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">max_iter</span> <span class="relational-operator">==</span> <span class="identifier">model_0</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>

    <span class="comment"># If tol is not None, the number of iteration should be less than max_iter</span>
    <span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2000</span>
    <span class="identifier">model_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="grouping">)</span>
    <span class="identifier">model_1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">max_iter</span> <span class="relational-operator">&gt;</span> <span class="identifier">model_1</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>
    <span class="keyword">assert</span> <span class="identifier">model_1</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;</span> <span class="int-literal">5</span>

    <span class="comment"># A larger tol should yield a smaller number of iteration</span>
    <span class="identifier">model_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="grouping">)</span>
    <span class="identifier">model_2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">model_1</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;</span> <span class="identifier">model_2</span><span class="punctuation">.</span><span class="identifier">n_iter_</span>
    <span class="keyword">assert</span> <span class="identifier">model_2</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;</span> <span class="int-literal">3</span>

    <span class="comment"># Strict tolerance and small max_iter should trigger a warning</span>
    <span class="identifier">model_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">warning_message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Maximum number of iteration reached before "</span>
        <span class="string-literal">"convergence. Consider increasing max_iter to "</span>
        <span class="string-literal">"improve the fit."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warning_message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model_3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">model_3</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>


<span class="keyword">def</span> <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss_function</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the different loss functions</span>
    <span class="comment"># cases is a list of (p, y, expected)</span>
    <span class="keyword">for</span> <span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">expected_loss</span><span class="punctuation">,</span> <span class="identifier">expected_dloss</span> <span class="relational-operator">in</span> <span class="identifier">cases</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">loss_function</span><span class="punctuation">.</span><span class="identifier">py_loss</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_loss</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">loss_function</span><span class="punctuation">.</span><span class="identifier">py_dloss</span><span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">expected_dloss</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_hinge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Hinge (hinge / perceptron)</span>
    <span class="comment"># hinge</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">Hinge</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">1.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>

    <span class="comment"># perceptron</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">Hinge</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-0.1</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gradient_squared_hinge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test SquaredHinge</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">SquaredHinge</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="punctuation">,</span> <span class="float-literal">-4.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.25</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">2.25</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_log</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Log (logistic loss)</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">Log</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-1.0</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">17.9</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">17.9</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-17.9</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">17.9</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">py_dloss</span><span class="grouping">(</span><span class="float-literal">18.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-18.1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">py_loss</span><span class="grouping">(</span><span class="float-literal">18.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-18.1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">py_dloss</span><span class="grouping">(</span><span class="float-literal">-18.1</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="float-literal">-18.1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">.</span><span class="identifier">py_loss</span><span class="grouping">(</span><span class="float-literal">-18.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">18.1</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_squared_loss</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test SquaredLoss</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">SquaredLoss</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">1.125</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.5</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">10.125</span><span class="punctuation">,</span> <span class="float-literal">-4.5</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_huber</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Huber</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">Huber</span><span class="grouping">(</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.005</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.005</span><span class="punctuation">,</span> <span class="float-literal">-0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">3.95</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="punctuation">,</span> <span class="float-literal">0.00125</span><span class="punctuation">,</span> <span class="float-literal">-0.05</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">0.295</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">5.0</span><span class="punctuation">,</span> <span class="float-literal">0.595</span><span class="punctuation">,</span> <span class="float-literal">-0.1</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_modified_huber</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">ModifiedHuber</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">-2.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="punctuation">,</span> <span class="float-literal">-4.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">2.25</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="float-literal">-4.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-3.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="float-literal">-4.0</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_epsilon_insensitive</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test EpsilonInsensitive</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">EpsilonInsensitive</span><span class="grouping">(</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.05</span><span class="punctuation">,</span> <span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">3.05</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">2.2</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">2.9</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.2</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">2.9</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_loss_squared_epsilon_insensitive</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test SquaredEpsilonInsensitive</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sgd_fast</span><span class="punctuation">.</span><span class="identifier">SquaredEpsilonInsensitive</span><span class="grouping">(</span><span class="float-literal">0.1</span><span class="grouping">)</span>
    <span class="identifier">cases</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="comment"># (p, y, expected_loss, expected_dloss)</span>
        <span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.05</span><span class="punctuation">,</span> <span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">3.05</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">2.2</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">8.41</span><span class="punctuation">,</span> <span class="float-literal">5.8</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">2.2</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">-0.2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="float-literal">-2.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">8.41</span><span class="punctuation">,</span> <span class="float-literal">-5.8</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="identifier">_test_loss_common</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">cases</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_multi_thread_multi_class_and_early_stopping</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This is a non-regression test for a bad interaction between</span>
    <span class="comment"># early stopping internal attribute and thread-based parallelism.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                        <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">n_iter_no_change</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&gt;</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_iter_no_change</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">&lt;</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_iter_no_change</span> <span class="arithmetic-operator">+</span> <span class="int-literal">20</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.8</span>


<span class="keyword">def</span> <span class="identifier">test_multi_core_gridsearch_and_early_stopping</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This is a non-regression test for a bad interaction between</span>
    <span class="comment"># early stopping internal attribute and process-based multi-core</span>
    <span class="comment"># parallelism.</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'alpha'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="string-literal">'n_iter_no_change'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">}</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomizedSearchCV</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">best_score_</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.8</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"backend"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"loky", "multiprocessing", "threading"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_SGDClassifier_fit_for_all_backends</span><span class="grouping">(</span><span class="identifier">backend</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This is a non-regression smoke test. In the multi-class case,</span>
    <span class="comment"># SGDClassifier.fit fits each class in a one-versus-all fashion using</span>
    <span class="comment"># joblib.Parallel.  However, each OvA step updates the coef_ attribute of</span>
    <span class="comment"># the estimator in-place. Internally, SGDClassifier calls Parallel using</span>
    <span class="comment"># require='sharedmem'. This test makes sure SGDClassifier.fit works</span>
    <span class="comment"># consistently even when the user asks for a backend that does not provide</span>
    <span class="comment"># sharedmem semantics.</span>

    <span class="comment"># We further test a case where memmapping would have been used if</span>
    <span class="comment"># SGDClassifier.fit was called from a loky or multiprocessing backend. In</span>
    <span class="comment"># this specific case, in-place modification of clf.coef_ would have caused</span>
    <span class="comment"># a segmentation fault when trying to write in a readonly memory mapped</span>
    <span class="comment"># buffer.</span>

    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'0.12'</span><span class="grouping">)</span>
            <span class="logical-operator">and</span> <span class="identifier">backend</span> <span class="relational-operator">==</span> <span class="string-literal">'loky'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">skip</span><span class="grouping">(</span><span class="string-literal">'loky backend does not exist in joblib &lt;0.12'</span><span class="grouping">)</span>

    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="comment"># Create a classification problem with 50000 features and 20 classes. Using</span>
    <span class="comment"># loky or multiprocessing this make the clf.coef_ exceed the threshold</span>
    <span class="comment"># above which memmaping is used in joblib and loky (1MB as of 2018/11/1).</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">random</span><span class="grouping">(</span><span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">2000</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.02</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'csr'</span><span class="punctuation">,</span>
                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">choice</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="grouping">)</span>

    <span class="comment"># Begin by fitting a SGD classifier sequentially</span>
    <span class="identifier">clf_sequential</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">clf_sequential</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Fit a SGDClassifier using the specified backend, and make sure the</span>
    <span class="comment"># coefficients are equal to those obtained using a sequential fit</span>
    <span class="identifier">clf_parallel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">parallel_backend</span><span class="grouping">(</span><span class="identifier">backend</span><span class="arithmetic-assignment">=</span><span class="identifier">backend</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf_parallel</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf_sequential</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">clf_parallel</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove in v1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'Estimator'</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDClassifier</span><span class="punctuation">,</span> <span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">SGDRegressor</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_loss_squared_loss_deprecated</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="comment"># Note: class BaseSGD calls self._validate_params() in __init__, therefore</span>
    <span class="comment"># even instatiation of class raises FutureWarning for squared_loss.</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"The loss 'squared_loss' was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_loss"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_error"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">est1</span><span class="punctuation">,</span> <span class="string-literal">"predict_proba"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>