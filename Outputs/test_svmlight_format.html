<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">bz2</span> <span class="keyword">import</span> <span class="identifier">BZ2File</span>
<span class="keyword">import</span> <span class="identifier">gzip</span>
<span class="keyword">from</span> <span class="identifier">io</span> <span class="keyword">import</span> <span class="identifier">BytesIO</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">shutil</span>
<span class="keyword">from</span> <span class="identifier">tempfile</span> <span class="keyword">import</span> <span class="identifier">NamedTemporaryFile</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">fails_if_pypy</span>

<span class="keyword">import</span> <span class="identifier">sklearn</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">load_svmlight_file</span><span class="punctuation">,</span> <span class="identifier">load_svmlight_files</span><span class="punctuation">,</span>
                              <span class="identifier">dump_svmlight_file</span><span class="grouping">)</span>

<span class="identifier">currdir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">abspath</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">datafile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">"data", "svmlight_classification.txt"</span><span class="grouping">)</span>
<span class="identifier">multifile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">"data", "svmlight_multilabel.txt"</span><span class="grouping">)</span>
<span class="identifier">invalidfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">"data", "svmlight_invalid.txt"</span><span class="grouping">)</span>
<span class="identifier">invalidfile2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">currdir</span><span class="punctuation">,</span> <span class="string-literal">"data", "svmlight_invalid_order.txt"</span><span class="grouping">)</span>

<span class="identifier">pytestmark</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fails_if_pypy</span>


<span class="keyword">def</span> <span class="identifier">test_load_svmlight_file</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>

    <span class="comment"># test X's shape</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">7</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">21</span>
    <span class="keyword">assert</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>

    <span class="comment"># test X's non-zero values</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="float-literal">-5.2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">27</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">val</span>

    <span class="comment"># tests X's zero values</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">18</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>

    <span class="comment"># test can change X's values</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>

    <span class="comment"># test y</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_svmlight_file_fd</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test loading from file descriptor</span>
    <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>

    <span class="identifier">fd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">O_RDONLY</span><span class="grouping">)</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">fd</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>
    <span class="keyword">finally</span><span class="punctuation">:</span>
        <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">close</span><span class="grouping">(</span><span class="identifier">fd</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_svmlight_file_multilabel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">multifile</span><span class="punctuation">,</span> <span class="identifier">multilabel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_load_svmlight_files</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_files</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">datafile</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                                                           <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>
    <span class="keyword">assert</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span>

    <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="identifier">X3</span><span class="punctuation">,</span> <span class="identifier">y3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_files</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">datafile</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">3</span><span class="punctuation">,</span>
                                                 <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">X3</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="keyword">assert</span> <span class="identifier">X3</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>


<span class="keyword">def</span> <span class="identifier">test_load_svmlight_file_n_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">22</span><span class="grouping">)</span>

    <span class="comment"># test X'shape</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">7</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">6</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">22</span>

    <span class="comment"># test X's non-zero values</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="float-literal">-5.2</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="keyword">assert</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">val</span>

    <span class="comment"># 21 features in file</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_compressed</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">NamedTemporaryFile</span><span class="grouping">(</span><span class="identifier">prefix</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sklearn-test", suffix=".gz"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">tmp</span><span class="punctuation">:</span>
        <span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">close</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># necessary under windows</span>
        <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="string-literal">"rb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">gzip</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"wb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">fh_out</span><span class="punctuation">:</span>
                <span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">copyfileobj</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">fh_out</span><span class="grouping">)</span>
        <span class="identifier">Xgz</span><span class="punctuation">,</span> <span class="identifier">ygz</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="comment"># because we "close" it manually and write to it,</span>
        <span class="comment"># we need to remove it manually.</span>
        <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Xgz</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">ygz</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">NamedTemporaryFile</span><span class="grouping">(</span><span class="identifier">prefix</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sklearn-test", suffix=".bz2"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">tmp</span><span class="punctuation">:</span>
        <span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">close</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># necessary under windows</span>
        <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="string-literal">"rb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">f</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">BZ2File</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"wb"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">fh_out</span><span class="punctuation">:</span>
                <span class="identifier">shutil</span><span class="punctuation">.</span><span class="identifier">copyfileobj</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">fh_out</span><span class="grouping">)</span>
        <span class="identifier">Xbz</span><span class="punctuation">,</span> <span class="identifier">ybz</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="comment"># because we "close" it manually and write to it,</span>
        <span class="comment"># we need to remove it manually.</span>
        <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">tmp</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Xbz</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">ybz</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_invalid_file</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">invalidfile</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_invalid_order_file</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">invalidfile2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_zero_based</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">b</span><span class="string-literal">"-1 4:1.\n1 0:1\n"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_zero_based_auto</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span><span class="string-literal">"-1 1:1 2:2 3:3\n"</span>
    <span class="identifier">data2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span><span class="string-literal">"-1 0:0 1:1\n"</span>

    <span class="identifier">f1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data1</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f1</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="string-literal">"auto"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>

    <span class="identifier">f1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data1</span><span class="grouping">)</span>
    <span class="identifier">f2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data2</span><span class="grouping">)</span>
    <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_files</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">f1</span><span class="punctuation">,</span> <span class="identifier">f2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="string-literal">"auto"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_with_qid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># load svmfile with qid attribute</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span><span class="comment">"""
    3 qid:1 1:0.53 2:0.12
    2 qid:1 1:0.13 2:0.1
    7 qid:2 1:0.87 2:0.12"""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.53</span><span class="punctuation">,</span> <span class="float-literal">.12</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.13</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.87</span><span class="punctuation">,</span> <span class="float-literal">.12</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">res1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_files</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">res2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">qid</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">res1</span><span class="punctuation">,</span> <span class="identifier">res2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">qid</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">.53</span><span class="punctuation">,</span> <span class="float-literal">.12</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.13</span><span class="punctuation">,</span> <span class="float-literal">.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">.87</span><span class="punctuation">,</span> <span class="float-literal">.12</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skip</span><span class="grouping">(</span><span class="string-literal">"testing the overflow of 32 bit sparse indexing requires a"</span>
                  <span class="string-literal">" large amount of memory"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_load_large_qid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    load large libsvm / svmlight file with qid attribute. Tests 64-bit query ID
    """</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span><span class="string-literal">"\n".join(("3 qid:{0} 1:0.53 2:0.12\n2 qid:{0} 1:0.13 2:0.1"</span>
                      <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">encode</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="arithmetic-operator">*</span><span class="int-literal">1000</span><span class="arithmetic-operator">*</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">qid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">qid</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="arithmetic-operator">*</span><span class="int-literal">1000</span><span class="arithmetic-operator">*</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_invalid_file2</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_files</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="identifier">invalidfile</span><span class="punctuation">,</span> <span class="identifier">datafile</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_not_a_filename</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># in python 3 integers are valid file opening arguments (taken as unix</span>
    <span class="comment"># file descriptors)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="float-literal">.42</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_invalid_filename</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">IOError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="string-literal">"trou pic nic douille"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dump</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>
    <span class="identifier">X_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">y_dense</span><span class="grouping">)</span>

    <span class="comment"># slicing a csr_matrix can unsort its .indices, so test that we sort</span>
    <span class="comment"># those correctly</span>
    <span class="identifier">X_sliced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y_sliced</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_sparse</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">y_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">X_dense</span><span class="punctuation">,</span> <span class="identifier">X_sliced</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">y_sparse</span><span class="punctuation">,</span> <span class="identifier">y_dense</span><span class="punctuation">,</span> <span class="identifier">y_sliced</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">zero_based</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">for</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="comment"># we need to pass a comment to get the version info in;</span>
                    <span class="comment"># LibSVM doesn't grok comments so they're not put in by</span>
                    <span class="comment"># default anymore.</span>

                    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="comment"># make sure y's shape is: (n_samples, n_labels)</span>
                        <span class="comment"># when it is sparse</span>
                        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">T</span>

                    <span class="comment"># Note: with dtype=np.int32 we are performing unsafe casts,</span>
                    <span class="comment"># where X.astype(dtype) overflows. The result is</span>
                    <span class="comment"># then platform dependent and X_dense.astype(dtype) may be</span>
                    <span class="comment"># different from X_sparse.astype(dtype).asarray().</span>
                    <span class="identifier">X_input</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span>

                    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X_input</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">comment</span><span class="arithmetic-assignment">=</span><span class="string-literal">"test"</span><span class="punctuation">,</span>
                                       <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="identifier">zero_based</span><span class="grouping">)</span>
                    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

                    <span class="identifier">comment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="identifier">comment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">comment</span><span class="punctuation">,</span> <span class="string-literal">"utf-8"</span><span class="grouping">)</span>

                    <span class="keyword">assert</span> <span class="string-literal">"scikit-learn %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">__version__</span> <span class="relational-operator">in</span> <span class="identifier">comment</span>

                    <span class="identifier">comment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="identifier">comment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">comment</span><span class="punctuation">,</span> <span class="string-literal">"utf-8"</span><span class="grouping">)</span>

                    <span class="keyword">assert</span> <span class="grouping">[</span><span class="string-literal">"one", "zero"][zero_based] + "-based"</span> <span class="relational-operator">in</span> <span class="identifier">comment</span>

                    <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="punctuation">,</span>
                                                <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="identifier">zero_based</span><span class="grouping">)</span>
                    <span class="keyword">assert</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype</span>
                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">sorted_indices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">)</span>

                    <span class="identifier">X2_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="keyword">if</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X_input</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">X_input_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_input</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="keyword">else</span><span class="punctuation">:</span>
                        <span class="identifier">X_input_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_input</span>

                    <span class="keyword">if</span> <span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">:</span>
                        <span class="comment"># allow a rounding error at the last decimal place</span>
                        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                            <span class="identifier">X_input_dense</span><span class="punctuation">,</span> <span class="identifier">X2_dense</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
                        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                            <span class="identifier">y_dense</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
                    <span class="keyword">else</span><span class="punctuation">:</span>
                        <span class="comment"># allow a rounding error at the last decimal place</span>
                        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                            <span class="identifier">X_input_dense</span><span class="punctuation">,</span> <span class="identifier">X2_dense</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span>
                        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
                            <span class="identifier">y_dense</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dump_multilabel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_dense</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">y_dense</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">y_dense</span><span class="punctuation">,</span> <span class="identifier">y_sparse</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">multilabel</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># make sure it dumps multilabel correctly</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"1 0:1 2:3 4:5\n"</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"0,2 \n"</span>
        <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"0,1 1:5 3:1\n"</span>


<span class="keyword">def</span> <span class="identifier">test_dump_concise</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">one</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">two</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.1</span>
    <span class="identifier">three</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">3.01</span>
    <span class="identifier">exact</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.000000000000001</span>
    <span class="comment"># loses the last decimal place</span>
    <span class="identifier">almost</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0000000000000001</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="identifier">one</span><span class="punctuation">,</span> <span class="identifier">two</span><span class="punctuation">,</span> <span class="identifier">three</span><span class="punctuation">,</span> <span class="identifier">exact</span><span class="punctuation">,</span> <span class="identifier">almost</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">1e9</span><span class="punctuation">,</span> <span class="float-literal">2e18</span><span class="punctuation">,</span> <span class="float-literal">3e27</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">one</span><span class="punctuation">,</span> <span class="identifier">two</span><span class="punctuation">,</span> <span class="identifier">three</span><span class="punctuation">,</span> <span class="identifier">exact</span><span class="punctuation">,</span> <span class="identifier">almost</span><span class="grouping">]</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># make sure it's using the most concise format possible</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                 <span class="identifier">b</span><span class="string-literal">"1 0:1 1:2.1 2:3.01 3:1.000000000000001 4:1\n"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"2.1 0:1000000000 1:2e+18 2:3e+27\n"</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"3.01 \n"</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"1.000000000000001 \n"</span>
    <span class="keyword">assert</span> <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">readline</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">b</span><span class="string-literal">"1 \n"</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># make sure it's correct too :)</span>
    <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dump_comment</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">i</span><span class="invalid">i</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"This is a comment\nspanning multiple lines."</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">comment</span><span class="arithmetic-assignment">=</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">i</span><span class="invalid">i</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>

    <span class="comment"># XXX we have to update this to support Python 3.x</span>
    <span class="identifier">utf8_comment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span><span class="string-literal">"It is true that\n\xc2\xbd\xc2\xb2 = \xc2\xbc"</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">UnicodeDecodeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">comment</span><span class="arithmetic-assignment">=</span><span class="identifier">utf8_comment</span><span class="grouping">)</span>

    <span class="identifier">unicode_comment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">utf8_comment</span><span class="punctuation">.</span><span class="identifier">decode</span><span class="grouping">(</span><span class="string-literal">"utf-8"</span><span class="grouping">)</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">comment</span><span class="arithmetic-assignment">=</span><span class="identifier">unicode_comment</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">comment</span><span class="arithmetic-assignment">=</span><span class="string-literal">"I've got a \0."</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dump_invalid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y2d</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">y</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y2d</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_dump_query_id</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test dumping a file with query_id</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">query_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="identifier">query_id</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">query_id1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X1</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">query_id</span><span class="punctuation">,</span> <span class="identifier">query_id1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_with_long_qid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># load svmfile with longint qid attribute</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">b</span><span class="comment">"""
    1 qid:0 0:1 1:2 2:3
    0 qid:72048431380967004 0:1440446648 1:72048431380967004 2:236784985
    0 qid:-9223372036854775807 0:1440446648 1:72048431380967004 2:236784985
    3 qid:9223372036854775807  0:1440446648 1:72048431380967004 2:236784985"""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">qid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">BytesIO</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="identifier">true_X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span>          <span class="int-literal">2</span><span class="punctuation">,</span>                 <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="grouping">[</span><span class="int-literal">1440446648</span><span class="punctuation">,</span> <span class="int-literal">72048431380967004</span><span class="punctuation">,</span> <span class="int-literal">236784985</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="grouping">[</span><span class="int-literal">1440446648</span><span class="punctuation">,</span> <span class="int-literal">72048431380967004</span><span class="punctuation">,</span> <span class="int-literal">236784985</span><span class="grouping">]</span><span class="punctuation">,</span>
              <span class="grouping">[</span><span class="int-literal">1440446648</span><span class="punctuation">,</span> <span class="int-literal">72048431380967004</span><span class="punctuation">,</span> <span class="int-literal">236784985</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">true_y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">trueQID</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">72048431380967004</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">9223372036854775807</span><span class="punctuation">,</span> <span class="int-literal">9223372036854775807</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">true_y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">qid</span><span class="punctuation">,</span> <span class="identifier">trueQID</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="identifier">qid</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">qid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">true_y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">qid</span><span class="punctuation">,</span> <span class="identifier">trueQID</span><span class="grouping">)</span>

    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">true_y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_zeros</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">true_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">true_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">true_X</span><span class="punctuation">,</span> <span class="identifier">true_y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">zero_based</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">zero_based</span><span class="arithmetic-assignment">=</span><span class="identifier">zero_based</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">true_y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'sparsity'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">.5</span><span class="punctuation">,</span> <span class="float-literal">0.99</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_samples'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">101</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_features'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">41</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_load_with_offsets</span><span class="grouping">(</span><span class="identifier">sparsity</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">sparsity</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">&lt;</span> <span class="identifier">sparsity</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">getvalue</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># put some marks that are likely to happen anywhere in a row</span>
    <span class="identifier">mark_0</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">mark_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span>
    <span class="identifier">length_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mark_1</span> <span class="arithmetic-operator">-</span> <span class="identifier">mark_0</span>
    <span class="identifier">mark_2</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span> <span class="arithmetic-operator">*</span> <span class="identifier">size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">5</span>
    <span class="identifier">length_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mark_2</span> <span class="arithmetic-operator">-</span> <span class="identifier">mark_1</span>

    <span class="comment"># load the original sparse matrix into 3 independent CSR matrices</span>
    <span class="identifier">X_0</span><span class="punctuation">,</span> <span class="identifier">y_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                  <span class="identifier">offset</span><span class="arithmetic-assignment">=</span><span class="identifier">mark_0</span><span class="punctuation">,</span> <span class="identifier">length</span><span class="arithmetic-assignment">=</span><span class="identifier">length_0</span><span class="grouping">)</span>
    <span class="identifier">X_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                  <span class="identifier">offset</span><span class="arithmetic-assignment">=</span><span class="identifier">mark_1</span><span class="punctuation">,</span> <span class="identifier">length</span><span class="arithmetic-assignment">=</span><span class="identifier">length_1</span><span class="grouping">)</span>
    <span class="identifier">X_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                  <span class="identifier">offset</span><span class="arithmetic-assignment">=</span><span class="identifier">mark_2</span><span class="grouping">)</span>

    <span class="identifier">y_concat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y_0</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_concat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X_0</span><span class="punctuation">,</span> <span class="identifier">X_1</span><span class="punctuation">,</span> <span class="identifier">X_2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_concat</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_concat</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_offset_exhaustive_splits</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="identifier">query_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>

    <span class="identifier">f</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BytesIO</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">dump_svmlight_file</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="identifier">query_id</span><span class="grouping">)</span>
    <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">getvalue</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># load the same data in 2 parts with all the possible byte offsets to</span>
    <span class="comment"># locate the split so has to test for particular boundary cases</span>
    <span class="keyword">for</span> <span class="identifier">mark</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">f</span><span class="punctuation">.</span><span class="identifier">seek</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">X_0</span><span class="punctuation">,</span> <span class="identifier">y_0</span><span class="punctuation">,</span> <span class="identifier">q_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                           <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                           <span class="identifier">length</span><span class="arithmetic-assignment">=</span><span class="identifier">mark</span><span class="grouping">)</span>
        <span class="identifier">X_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">q_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">f</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                           <span class="identifier">query_id</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">offset</span><span class="arithmetic-assignment">=</span><span class="identifier">mark</span><span class="punctuation">,</span>
                                           <span class="identifier">length</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">q_concat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">q_0</span><span class="punctuation">,</span> <span class="identifier">q_1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">y_concat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y_0</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">X_concat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X_0</span><span class="punctuation">,</span> <span class="identifier">X_1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_concat</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">query_id</span><span class="punctuation">,</span> <span class="identifier">q_concat</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X_concat</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_load_with_offsets_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"n_features is required"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">load_svmlight_file</span><span class="grouping">(</span><span class="identifier">datafile</span><span class="punctuation">,</span> <span class="identifier">offset</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">length</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    </pre>
  </body>
</html>