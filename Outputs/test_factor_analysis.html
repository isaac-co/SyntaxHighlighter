<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Christian Osendorfer &lt;osendorf@gmail.com&gt;</span>
<span class="comment">#         Alexandre Gramfort &lt;alexandre.gramfort@inria.fr&gt;</span>
<span class="comment"># License: BSD3</span>

<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">combinations</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">FactorAnalysis</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">_factor_analysis</span> <span class="keyword">import</span> <span class="identifier">_ortho_rotation</span>


<span class="comment"># Ignore warnings from switching to more power iterations in randomized_svd</span>
<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">test_factor_analysis</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test FactorAnalysis ability to recover the data covariance structure</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span>

    <span class="comment"># Some random settings for the generative model</span>
    <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="comment"># latent variable of dim 3, 20 of it</span>
    <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="comment"># using gamma to model different noise variance</span>
    <span class="comment"># per component</span>
    <span class="identifier">noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">gamma</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="comment"># generate observations</span>
    <span class="comment"># wlog, mean is 0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">h</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">noise</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">FactorAnalysis</span><span class="grouping">(</span><span class="identifier">svd_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'foo'</span><span class="grouping">)</span>
    <span class="identifier">fa_fail</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FactorAnalysis</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">fa_fail</span><span class="punctuation">.</span><span class="identifier">svd_method</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'foo'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fa_fail</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">fas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'randomized', 'lapack'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">fa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FactorAnalysis</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">svd_method</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>
        <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">fas</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">fa</span><span class="grouping">)</span>

        <span class="identifier">X_t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">X_t</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">loglike_</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">score_samples</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">loglike_</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">diff</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="string-literal">'Log likelihood dif not increase'</span>

        <span class="comment"># Sample Covariance</span>
        <span class="identifier">scov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">cov</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">rowvar</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">bias</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>

        <span class="comment"># Model Covariance</span>
        <span class="identifier">mcov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">get_covariance</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">scov</span> <span class="arithmetic-operator">-</span> <span class="identifier">mcov</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">size</span>
        <span class="keyword">assert</span> <span class="identifier">diff</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="string-literal">"Mean absolute difference is %f"</span> <span class="arithmetic-operator">%</span> <span class="identifier">diff</span>
        <span class="identifier">fa</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FactorAnalysis</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                            <span class="identifier">noise_variance_init</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>  <span class="comment"># sign will not be equal</span>
    <span class="identifier">fa1</span><span class="punctuation">,</span> <span class="identifier">fa2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fas</span>
    <span class="keyword">for</span> <span class="identifier">attr</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'loglike_', 'components_', 'noise_variance_'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">f</span><span class="grouping">(</span><span class="identifier">fa1</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">fa2</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">fa1</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">fa1</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fa1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Test get_covariance and get_precision with n_components == n_features</span>
    <span class="comment"># with n_components &lt; n_features and with n_components == 0</span>
    <span class="keyword">for</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">get_covariance</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">precision</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fa</span><span class="punctuation">.</span><span class="identifier">get_precision</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">precision</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">)</span>

    <span class="comment"># test rotation</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="identifier">results</span><span class="punctuation">,</span> <span class="identifier">projections</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="grouping">}</span>
    <span class="keyword">for</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">"varimax"</span><span class="punctuation">,</span> <span class="string-literal">'quartimax'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">fa_var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FactorAnalysis</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                <span class="identifier">rotation</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>
        <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fa_var</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">projections</span><span class="grouping">[</span><span class="identifier">method</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fa_var</span><span class="punctuation">.</span><span class="identifier">get_covariance</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">rot1</span><span class="punctuation">,</span> <span class="identifier">rot2</span> <span class="relational-operator">in</span> <span class="identifier">combinations</span><span class="grouping">(</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'varimax', 'quartimax'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">results</span><span class="grouping">[</span><span class="identifier">rot1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">results</span><span class="grouping">[</span><span class="identifier">rot2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">projections</span><span class="grouping">[</span><span class="identifier">rot1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">projections</span><span class="grouping">[</span><span class="identifier">rot2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">FactorAnalysis</span><span class="grouping">(</span><span class="identifier">rotation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"not_implemented"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test against R's psych::principal with rotate="varimax"</span>
    <span class="comment"># (i.e., the values below stem from rotating the components in R)</span>
    <span class="comment"># R's factor analysis returns quite different values; therefore, we only</span>
    <span class="comment"># test the rotation itself</span>
    <span class="identifier">factors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.89421016</span><span class="punctuation">,</span> <span class="float-literal">-0.35854928</span><span class="punctuation">,</span> <span class="float-literal">-0.27770122</span><span class="punctuation">,</span> <span class="float-literal">0.03773647</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">-0.45081822</span><span class="punctuation">,</span> <span class="float-literal">-0.89132754</span><span class="punctuation">,</span> <span class="float-literal">0.0932195</span><span class="punctuation">,</span> <span class="float-literal">-0.01787973</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.99500666</span><span class="punctuation">,</span> <span class="float-literal">-0.02031465</span><span class="punctuation">,</span> <span class="float-literal">0.05426497</span><span class="punctuation">,</span> <span class="float-literal">-0.11539407</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="float-literal">0.96822861</span><span class="punctuation">,</span> <span class="float-literal">-0.06299656</span><span class="punctuation">,</span> <span class="float-literal">0.24411001</span><span class="punctuation">,</span> <span class="float-literal">0.07540887</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">r_solution</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.962</span><span class="punctuation">,</span> <span class="float-literal">0.052</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">-0.141</span><span class="punctuation">,</span> <span class="float-literal">0.989</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="float-literal">0.949</span><span class="punctuation">,</span> <span class="float-literal">-0.300</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.937</span><span class="punctuation">,</span> <span class="float-literal">-0.251</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">rotated</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_ortho_rotation</span><span class="grouping">(</span><span class="identifier">factors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'varimax'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rotated</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">r_solution</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>

    </pre>
  </body>
</html>