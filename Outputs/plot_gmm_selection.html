<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
================================
Gaussian Mixture Model Selection
================================

This example shows that model selection can be performed with
Gaussian Mixture Models using information-theoretic criteria (BIC).
Model selection concerns both the covariance type
and the number of components in the model.
In that case, AIC also provides the right result (not shown to save time),
but BIC is better suited if the problem is to identify the right model.
Unlike Bayesian procedures, such inferences are prior-free.

In that case, the model with 2 components and full covariance
(which corresponds to the true generative model) is selected.
"""</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">itertools</span>

<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span> <span class="keyword">as</span> <span class="identifier">mpl</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">mixture</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="comment"># Number of samples per component</span>
<span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span>

<span class="comment"># Generate random sample, two components</span>
<span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">-0.1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.7</span><span class="punctuation">,</span> <span class="float-literal">.4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="grouping">)</span><span class="punctuation">,</span>
          <span class="float-literal">.7</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

<span class="identifier">lowest_bic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">infty</span>
<span class="identifier">bic</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">n_components_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>
<span class="identifier">cv_types</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'spherical', 'tied', 'diag', 'full'</span><span class="grouping">]</span>
<span class="keyword">for</span> <span class="identifier">cv_type</span> <span class="relational-operator">in</span> <span class="identifier">cv_types</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="identifier">n_components</span> <span class="relational-operator">in</span> <span class="identifier">n_components_range</span><span class="punctuation">:</span>
        <span class="comment"># Fit a Gaussian mixture with EM</span>
        <span class="identifier">gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mixture</span><span class="punctuation">.</span><span class="identifier">GaussianMixture</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                      <span class="identifier">covariance_type</span><span class="arithmetic-assignment">=</span><span class="identifier">cv_type</span><span class="grouping">)</span>
        <span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">gmm</span><span class="punctuation">.</span><span class="identifier">bic</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">bic</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">lowest_bic</span><span class="punctuation">:</span>
            <span class="identifier">lowest_bic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bic</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">best_gmm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gmm</span>

<span class="identifier">bic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">bic</span><span class="grouping">)</span>
<span class="identifier">color_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">itertools</span><span class="punctuation">.</span><span class="identifier">cycle</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'navy', 'turquoise', 'cornflowerblue'</span><span class="punctuation">,</span>
                              <span class="string-literal">'darkorange'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">best_gmm</span>
<span class="identifier">bars</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

<span class="comment"># Plot the BIC scores</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">spl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">cv_type</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">cv_types</span><span class="punctuation">,</span> <span class="identifier">color_iter</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">xpos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">n_components_range</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">.2</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">bars</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">bar</span><span class="grouping">(</span><span class="identifier">xpos</span><span class="punctuation">,</span> <span class="identifier">bic</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">n_components_range</span><span class="grouping">)</span><span class="punctuation">:</span>
                                  <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">n_components_range</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="identifier">n_components_range</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.01</span> <span class="arithmetic-operator">-</span> <span class="float-literal">.01</span> <span class="arithmetic-operator">*</span> <span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">'BIC score per model'</span><span class="grouping">)</span>
<span class="identifier">xpos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mod</span><span class="grouping">(</span><span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">n_components_range</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">.65</span> <span class="arithmetic-operator">+</span><span class="invalid">\</span>
    <span class="float-literal">.2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">floor</span><span class="grouping">(</span><span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">argmin</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">n_components_range</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">text</span><span class="grouping">(</span><span class="identifier">xpos</span><span class="punctuation">,</span> <span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.97</span> <span class="arithmetic-operator">+</span> <span class="float-literal">.03</span> <span class="arithmetic-operator">*</span> <span class="identifier">bic</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'*'</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">14</span><span class="grouping">)</span>
<span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'Number of components'</span><span class="grouping">)</span>
<span class="identifier">spl</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">b</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">b</span> <span class="relational-operator">in</span> <span class="identifier">bars</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">cv_types</span><span class="grouping">)</span>

<span class="comment"># Plot the winner</span>
<span class="identifier">splot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
<span class="identifier">Y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">mean</span><span class="punctuation">,</span> <span class="identifier">cov</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">means_</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">covariances_</span><span class="punctuation">,</span>
                                           <span class="identifier">color_iter</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">eigh</span><span class="grouping">(</span><span class="identifier">cov</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">Y_</span> <span class="relational-operator">==</span> <span class="identifier">i</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">continue</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">Y_</span> <span class="relational-operator">==</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">Y_</span> <span class="relational-operator">==</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="float-literal">.8</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="grouping">)</span>

    <span class="comment"># Plot an ellipse to show the Gaussian component</span>
    <span class="identifier">angle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arctan2</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">angle</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">180</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">angle</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span>  <span class="comment"># convert to degrees</span>
    <span class="identifier">v</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span>
    <span class="identifier">ell</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mpl</span><span class="punctuation">.</span><span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">Ellipse</span><span class="grouping">(</span><span class="identifier">mean</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">180</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="identifier">angle</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="grouping">)</span>
    <span class="identifier">ell</span><span class="punctuation">.</span><span class="identifier">set_clip_box</span><span class="grouping">(</span><span class="identifier">splot</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">)</span>
    <span class="identifier">ell</span><span class="punctuation">.</span><span class="identifier">set_alpha</span><span class="grouping">(</span><span class="float-literal">.5</span><span class="grouping">)</span>
    <span class="identifier">splot</span><span class="punctuation">.</span><span class="identifier">add_artist</span><span class="grouping">(</span><span class="identifier">ell</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">yticks</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">'Selected GMM: {best_gmm.covariance_type} model, '</span>
          <span class="identifier">f</span><span class="string-literal">'{best_gmm.n_components} components'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots_adjust</span><span class="grouping">(</span><span class="identifier">hspace</span><span class="arithmetic-assignment">=</span><span class="float-literal">.35</span><span class="punctuation">,</span> <span class="identifier">bottom</span><span class="arithmetic-assignment">=</span><span class="float-literal">.02</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>