<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>

<span class="comment">""" Functions for backing up, restoring and creating model snapshots. """</span>

<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">from</span> <span class="identifier">datetime</span> <span class="keyword">import</span> <span class="identifier">datetime</span>
<span class="keyword">from</span> <span class="identifier">shutil</span> <span class="keyword">import</span> <span class="identifier">copyfile</span><span class="punctuation">,</span> <span class="identifier">copytree</span><span class="punctuation">,</span> <span class="identifier">rmtree</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">serializer</span> <span class="keyword">import</span> <span class="identifier">get_serializer</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_folder</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">Backup</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Performs the back up of models at each save iteration, and the restoring of models from
    their back up location.

    Parameters
    ----------
    model_dir: str
        The folder that contains the model to be backed up
    model_name: str
        The name of the model that is to be backed up
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">model_name</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (model_dir: '%s', model_name: '%s')"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">model_name</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">model_dir</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_name</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_check_valid</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check if the passed in filename is valid for a backup or restore operation.

        Parameters
        ----------
        filename: str
            The filename that is to be checked for backup or restore
        for_restore: bool, optional
            ``True`` if the checks are to be performed for restoring a model, ``False`` if the
            checks are to be performed for backing up a model. Default: ``False``

        Returns
        -------
        bool
            ``True`` if the given file is valid for a backup/restore operation otherwise ``False``
        """</span>
        <span class="identifier">fullpath</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">filename</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_name</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Any filename that does not start with the model name are invalid</span>
            <span class="comment"># for all operations</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="keyword">elif</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span> <span class="logical-operator">and</span> <span class="identifier">filename</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">".bk"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Only filenames ending in .bk are valid for restoring</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span> <span class="logical-operator">and</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isfile</span><span class="grouping">(</span><span class="identifier">fullpath</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">filename</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">".bk"</span><span class="grouping">)</span><span class="grouping">)</span> <span class="logical-operator">or</span>
                                  <span class="grouping">(</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">fullpath</span><span class="grouping">)</span> <span class="logical-operator">and</span>
                                   <span class="identifier">filename</span> <span class="relational-operator">==</span> <span class="string-literal">"{}_logs"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_name</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Only filenames that do not end with .bk or folders that are the logs folder</span>
            <span class="comment"># are valid for backup</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"'%s' valid for backup operation: %s"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">backup_model</span><span class="grouping">(</span><span class="identifier">full_path</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Backup a model file.

        The backed up file is saved with the original filename in the original location with `.bk`
        appended to the end of the name.

        Parameters
        ----------
        full_path: str
            The full path to a `.h5` model file or a `.json` state file
        """</span>
        <span class="identifier">backupfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">full_path</span> <span class="arithmetic-operator">+</span> <span class="string-literal">".bk"</span>
        <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">backupfile</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">backupfile</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">full_path</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Backing up: '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">full_path</span><span class="punctuation">,</span> <span class="identifier">backupfile</span><span class="grouping">)</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">full_path</span><span class="punctuation">,</span> <span class="identifier">backupfile</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">snapshot_models</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">iterations</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Take a snapshot of the model at the current state and back it up.

        The snapshot is a copy of the model folder located in the same root location
        as the original model file, with the number of iterations appended to the end
        of the folder name.

        Parameters
        ----------
        iterations: int
            The number of iterations that the model has trained when performing the snapshot.
        """</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">""</span><span class="grouping">)</span>  <span class="comment"># New line so log message doesn't append to last loss output</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Saving snapshot"</span><span class="grouping">)</span>
        <span class="identifier">snapshot_dir</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}_snapshot_{}_iters"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">iterations</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">snapshot_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Removing previously existing snapshot folder: '%s'"</span><span class="punctuation">,</span> <span class="identifier">snapshot_dir</span><span class="grouping">)</span>
            <span class="identifier">rmtree</span><span class="grouping">(</span><span class="identifier">snapshot_dir</span><span class="grouping">)</span>

        <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">get_folder</span><span class="grouping">(</span><span class="identifier">snapshot_dir</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">filename</span> <span class="relational-operator">in</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_valid</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Not snapshotting file: '%s'"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">srcfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">dstfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">copyfunc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copytree</span> <span class="keyword">if</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">srcfile</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">copyfile</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Saving snapshot: '%s' &gt; '%s'"</span><span class="punctuation">,</span> <span class="identifier">srcfile</span><span class="punctuation">,</span> <span class="identifier">dstfile</span><span class="grouping">)</span>
            <span class="identifier">copyfunc</span><span class="grouping">(</span><span class="identifier">srcfile</span><span class="punctuation">,</span> <span class="identifier">dstfile</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Saved snapshot (%s iterations)"</span><span class="punctuation">,</span> <span class="identifier">iterations</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">restore</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Restores a model from backup.

        The original model files are migrated into a folder within the original model folder
        named `&lt;model_name&gt;_archived_&lt;timestamp&gt;`. The `.bk` backup files are then moved to
        the location of the previously existing model files. Logs that were generated after the
        the last backup was taken are removed. """</span>
        <span class="identifier">archive_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_move_archived</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_restore_files</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_restore_logs</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_move_archived</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Move archived files to the archived folder.

        Returns
        -------
        str
            The name of the generated archive folder
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Archiving existing model files..."</span><span class="grouping">)</span>
        <span class="identifier">now</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">strftime</span><span class="grouping">(</span><span class="string-literal">"%Y%m%d_%H%M%S"</span><span class="grouping">)</span>
        <span class="identifier">archive_dir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="string-literal">"{}_archived_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_name</span><span class="punctuation">,</span> <span class="identifier">now</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">mkdir</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">filename</span> <span class="relational-operator">in</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_valid</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Not moving file to archived: '%s'"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Moving '%s' to archived model folder: '%s'"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">archive_dir</span><span class="grouping">)</span>
            <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">rename</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Archived existing model files"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">archive_dir</span>

    <span class="keyword">def</span> <span class="identifier">_restore_files</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Restore files from .bk """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Restoring models from backup..."</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">filename</span> <span class="relational-operator">in</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_valid</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">_</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Not restoring file: '%s'"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">dstfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">splitext</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Restoring '%s' to '%s'"</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="punctuation">,</span> <span class="identifier">dstfile</span><span class="grouping">)</span>
            <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">filename</span><span class="grouping">)</span>
            <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">dstfile</span><span class="grouping">)</span>
            <span class="identifier">copyfile</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Restored models from backup"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_restore_logs</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">archive_dir</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Restores the log files up to and including the last backup.

        Parameters
        ----------
        archive_dir: str
            The full path to the model's archive folder
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Restoring Logs..."</span><span class="grouping">)</span>
        <span class="identifier">session_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_session_names</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">log_dirs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_log_dirs</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="punctuation">,</span> <span class="identifier">session_names</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">log_dir</span> <span class="relational-operator">in</span> <span class="identifier">log_dirs</span><span class="punctuation">:</span>
            <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="punctuation">,</span> <span class="identifier">log_dir</span><span class="grouping">)</span>
            <span class="identifier">dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span> <span class="identifier">log_dir</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Restoring logfile: %s"</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
            <span class="identifier">copytree</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="grouping">(</span><span class="string-literal">"Restored Logs"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_session_names</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the existing session names from a state file. """</span>
        <span class="identifier">serializer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_serializer</span><span class="grouping">(</span><span class="string-literal">"json"</span><span class="grouping">)</span>
        <span class="identifier">state_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_dir</span><span class="punctuation">,</span>
                                  <span class="string-literal">"{}_state.{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_name</span><span class="punctuation">,</span> <span class="identifier">serializer</span><span class="punctuation">.</span><span class="identifier">file_extension</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">serializer</span><span class="punctuation">.</span><span class="identifier">load</span><span class="grouping">(</span><span class="identifier">state_file</span><span class="grouping">)</span>
        <span class="identifier">session_names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"session_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">key</span><span class="grouping">)</span>
                         <span class="keyword">for</span> <span class="identifier">key</span> <span class="relational-operator">in</span> <span class="identifier">state</span><span class="grouping">[</span><span class="string-literal">"sessions"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Session to restore: %s"</span><span class="punctuation">,</span> <span class="identifier">session_names</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">session_names</span>

    <span class="keyword">def</span> <span class="identifier">_get_log_dirs</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">archive_dir</span><span class="punctuation">,</span> <span class="identifier">session_names</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the session log directory paths in the archive folder.

        Parameters
        ----------
        archive_dir: str
            The full path to the model's archive folder
        session_names: list
            The name of the training sessions that exist for the model

        Returns
        -------
        list
            The full paths to the log folders
        """</span>
        <span class="identifier">archive_logs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="punctuation">,</span> <span class="string-literal">"{}_logs"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_name</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">paths</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">dirpath</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="identifier">archive_dir</span><span class="punctuation">,</span> <span class="string-literal">""</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">folder</span><span class="grouping">)</span>
                 <span class="keyword">for</span> <span class="identifier">dirpath</span><span class="punctuation">,</span> <span class="identifier">dirnames</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">walk</span><span class="grouping">(</span><span class="identifier">archive_logs</span><span class="grouping">)</span>
                 <span class="keyword">for</span> <span class="identifier">folder</span> <span class="relational-operator">in</span> <span class="identifier">dirnames</span>
                 <span class="keyword">if</span> <span class="identifier">folder</span> <span class="relational-operator">in</span> <span class="identifier">session_names</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"log folders to restore: %s"</span><span class="punctuation">,</span> <span class="identifier">paths</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">paths</span>

    </pre>
  </body>
</html>