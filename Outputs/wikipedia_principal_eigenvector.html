<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
===============================
Wikipedia principal eigenvector
===============================

A classical way to assert the relative importance of vertices in a
graph is to compute the principal eigenvector of the adjacency matrix
so as to assign to each vertex the values of the components of the first
eigenvector as a centrality score:

    https://en.wikipedia.org/wiki/Eigenvector_centrality

On the graph of webpages and links those values are called the PageRank
scores by Google.

The goal of this example is to analyze the graph of links inside
wikipedia articles to rank articles by relative importance according to
this eigenvector centrality.

The traditional way to compute the principal eigenvector is to use the
power iteration method:

    https://en.wikipedia.org/wiki/Power_iteration

Here the computation is achieved thanks to Martinsson's Randomized SVD
algorithm implemented in scikit-learn.

The graph data is fetched from the DBpedia dumps. DBpedia is an extraction
of the latent structured data of the Wikipedia content.
"""</span>

<span class="comment"># Author: Olivier Grisel &lt;olivier.grisel@ensta.org&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">bz2</span> <span class="keyword">import</span> <span class="identifier">BZ2File</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">from</span> <span class="identifier">datetime</span> <span class="keyword">import</span> <span class="identifier">datetime</span>
<span class="keyword">from</span> <span class="identifier">pprint</span> <span class="keyword">import</span> <span class="identifier">pprint</span>
<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">randomized_svd</span>
<span class="keyword">from</span> <span class="identifier">urllib</span><span class="punctuation">.</span><span class="identifier">request</span> <span class="keyword">import</span> <span class="identifier">urlopen</span>


<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Where to download the data, if not already on disk</span>
<span class="identifier">redirects_url</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"http://downloads.dbpedia.org/3.5.1/en/redirects_en.nt.bz2"</span>
<span class="identifier">redirects_filename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">redirects_url</span><span class="punctuation">.</span><span class="identifier">rsplit</span><span class="grouping">(</span><span class="string-literal">"/"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

<span class="identifier">page_links_url</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"http://downloads.dbpedia.org/3.5.1/en/page_links_en.nt.bz2"</span>
<span class="identifier">page_links_filename</span> <span class="arithmetic-assignment">=</span> <span class="identifier">page_links_url</span><span class="punctuation">.</span><span class="identifier">rsplit</span><span class="grouping">(</span><span class="string-literal">"/"</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

<span class="identifier">resources</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">redirects_url</span><span class="punctuation">,</span> <span class="identifier">redirects_filename</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">page_links_url</span><span class="punctuation">,</span> <span class="identifier">page_links_filename</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span>

<span class="keyword">for</span> <span class="identifier">url</span><span class="punctuation">,</span> <span class="identifier">filename</span> <span class="relational-operator">in</span> <span class="identifier">resources</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">filename</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Downloading data from '%s', please wait..."</span> <span class="arithmetic-operator">%</span> <span class="identifier">url</span><span class="grouping">)</span>
        <span class="identifier">opener</span> <span class="arithmetic-assignment">=</span> <span class="identifier">urlopen</span><span class="grouping">(</span><span class="identifier">url</span><span class="grouping">)</span>
        <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">filename</span><span class="punctuation">,</span> <span class="string-literal">'wb'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="identifier">opener</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="comment"># #############################################################################</span>
<span class="comment"># Loading the redirect files</span>


<span class="keyword">def</span> <span class="identifier">index</span><span class="grouping">(</span><span class="identifier">redirects</span><span class="punctuation">,</span> <span class="identifier">index_map</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Find the index of an article name after redirect resolution"""</span>
    <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="identifier">redirects</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">k</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">index_map</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">index_map</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="identifier">DBPEDIA_RESOURCE_PREFIX_LEN</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="string-literal">"http://dbpedia.org/resource/"</span><span class="grouping">)</span>
<span class="identifier">SHORTNAME_SLICE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">DBPEDIA_RESOURCE_PREFIX_LEN</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">short_name</span><span class="grouping">(</span><span class="identifier">nt_uri</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Remove the &lt; and &gt; URI markers and the common URI prefix"""</span>
    <span class="keyword">return</span> <span class="identifier">nt_uri</span><span class="grouping">[</span><span class="identifier">SHORTNAME_SLICE</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">get_redirects</span><span class="grouping">(</span><span class="identifier">redirects_filename</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Parse the redirections and build a transitively closed map out of it"""</span>
    <span class="identifier">redirects</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Parsing the NT redirect file"</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">BZ2File</span><span class="grouping">(</span><span class="identifier">redirects_filename</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">split</span> <span class="arithmetic-assignment">=</span> <span class="identifier">line</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">split</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"ignoring malformed line: "</span> <span class="arithmetic-operator">+</span> <span class="identifier">line</span><span class="grouping">)</span>
            <span class="keyword">continue</span>
        <span class="identifier">redirects</span><span class="grouping">[</span><span class="identifier">short_name</span><span class="grouping">(</span><span class="identifier">split</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">short_name</span><span class="grouping">(</span><span class="identifier">split</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">l</span> <span class="arithmetic-operator">%</span> <span class="int-literal">1000000</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[%s] line: %08d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">isoformat</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">l</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># compute the transitive closure</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Computing the transitive closure of the redirect relation"</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">source</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">redirects</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transitive_target</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">redirects</span><span class="grouping">[</span><span class="identifier">source</span><span class="grouping">]</span>
        <span class="identifier">seen</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">source</span><span class="grouping">}</span>
        <span class="keyword">while</span> <span class="bool-literal">True</span><span class="punctuation">:</span>
            <span class="identifier">transitive_target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">target</span>
            <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">redirects</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">target</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">target</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">or</span> <span class="identifier">target</span> <span class="relational-operator">in</span> <span class="identifier">seen</span><span class="punctuation">:</span>
                <span class="keyword">break</span>
            <span class="identifier">seen</span><span class="punctuation">.</span><span class="identifier">add</span><span class="grouping">(</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="identifier">redirects</span><span class="grouping">[</span><span class="identifier">source</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transitive_target</span>
        <span class="keyword">if</span> <span class="identifier">l</span> <span class="arithmetic-operator">%</span> <span class="int-literal">1000000</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[%s] line: %08d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">isoformat</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">l</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">redirects</span>


<span class="keyword">def</span> <span class="identifier">get_adjacency_matrix</span><span class="grouping">(</span><span class="identifier">redirects_filename</span><span class="punctuation">,</span> <span class="identifier">page_links_filename</span><span class="punctuation">,</span> <span class="identifier">limit</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Extract the adjacency graph as a scipy sparse matrix

    Redirects are resolved first.

    Returns X, the scipy sparse adjacency matrix, redirects as python
    dict from article names to article names and index_map a python dict
    from article names to python int (article indexes).
    """</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Computing the redirect map"</span><span class="grouping">)</span>
    <span class="identifier">redirects</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_redirects</span><span class="grouping">(</span><span class="identifier">redirects_filename</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Computing the integer index map"</span><span class="grouping">)</span>
    <span class="identifier">index_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">links</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">l</span><span class="punctuation">,</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">BZ2File</span><span class="grouping">(</span><span class="identifier">page_links_filename</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">split</span> <span class="arithmetic-assignment">=</span> <span class="identifier">line</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">split</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"ignoring malformed line: "</span> <span class="arithmetic-operator">+</span> <span class="identifier">line</span><span class="grouping">)</span>
            <span class="keyword">continue</span>
        <span class="identifier">i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">index</span><span class="grouping">(</span><span class="identifier">redirects</span><span class="punctuation">,</span> <span class="identifier">index_map</span><span class="punctuation">,</span> <span class="identifier">short_name</span><span class="grouping">(</span><span class="identifier">split</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">j</span> <span class="arithmetic-assignment">=</span> <span class="identifier">index</span><span class="grouping">(</span><span class="identifier">redirects</span><span class="punctuation">,</span> <span class="identifier">index_map</span><span class="punctuation">,</span> <span class="identifier">short_name</span><span class="grouping">(</span><span class="identifier">split</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">links</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">l</span> <span class="arithmetic-operator">%</span> <span class="int-literal">1000000</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"[%s] line: %08d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">datetime</span><span class="punctuation">.</span><span class="identifier">now</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">isoformat</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">l</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">limit</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">l</span> <span class="relational-operator">&gt;=</span> <span class="identifier">limit</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">break</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Computing the adjacency matrix"</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">lil_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">index_map</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">index_map</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">links</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
    <span class="keyword">del</span> <span class="identifier">links</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Converting to CSR representation"</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"CSR conversion done"</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">redirects</span><span class="punctuation">,</span> <span class="identifier">index_map</span>


<span class="comment"># stop after 5M links to make it possible to work in RAM</span>
<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">redirects</span><span class="punctuation">,</span> <span class="identifier">index_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_adjacency_matrix</span><span class="grouping">(</span>
    <span class="identifier">redirects_filename</span><span class="punctuation">,</span> <span class="identifier">page_links_filename</span><span class="punctuation">,</span> <span class="identifier">limit</span><span class="arithmetic-assignment">=</span><span class="int-literal">5000000</span><span class="grouping">)</span>
<span class="identifier">names</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">i</span><span class="punctuation">:</span> <span class="identifier">name</span> <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">index_map</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Computing the principal singular vectors using randomized_svd"</span><span class="grouping">)</span>
<span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">U</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">V</span> <span class="arithmetic-assignment">=</span> <span class="identifier">randomized_svd</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"done in %0.3fs"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># print the names of the wikipedia related strongest components of the</span>
<span class="comment"># principal singular vector which should be similar to the highest eigenvector</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Top wikipedia pages according to principal singular vectors"</span><span class="grouping">)</span>
<span class="identifier">pprint</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">U</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">pprint</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">V</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">centrality_scores</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.85</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-10</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Power iteration computation of the principal eigenvector

    This method is also known as Google PageRank and the implementation
    is based on the one from the NetworkX project (BSD licensed too)
    with copyrights by:

      Aric Hagberg &lt;hagberg@lanl.gov&gt;
      Dan Schult &lt;dschult@colgate.edu&gt;
      Pieter Swart &lt;swart@lanl.gov&gt;
    """</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">incoming_counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Normalizing the graph"</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">incoming_counts</span><span class="punctuation">.</span><span class="identifier">nonzero</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">:</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">incoming_counts</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span>
    <span class="identifier">dangle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isclose</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>  <span class="comment"># initial guess</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"power iteration #%d"</span> <span class="arithmetic-operator">%</span> <span class="identifier">i</span><span class="grouping">)</span>
        <span class="identifier">prev_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scores</span>
        <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">scores</span> <span class="arithmetic-operator">*</span> <span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">dangle</span><span class="punctuation">,</span> <span class="identifier">prev_scores</span><span class="grouping">)</span><span class="grouping">)</span>
                  <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">prev_scores</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n</span><span class="grouping">)</span>
        <span class="comment"># check convergence: normalized l_inf norm</span>
        <span class="identifier">scores_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">scores_max</span> <span class="relational-operator">==</span> <span class="float-literal">0.0</span><span class="punctuation">:</span>
            <span class="identifier">scores_max</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
        <span class="identifier">err</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">scores</span> <span class="arithmetic-operator">-</span> <span class="identifier">prev_scores</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">scores_max</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"error: %0.6f"</span> <span class="arithmetic-operator">%</span> <span class="identifier">err</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">err</span> <span class="relational-operator">&lt;</span> <span class="identifier">n</span> <span class="arithmetic-operator">*</span> <span class="identifier">tol</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">scores</span>

    <span class="keyword">return</span> <span class="identifier">scores</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Computing principal eigenvector score using a power iteration method"</span><span class="grouping">)</span>
<span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">centrality_scores</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"done in %0.3fs"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">pprint</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">names</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    </pre>
  </body>
</html>