<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Test the 20news downloader, if the data is available,
or if specifically requested via environment variable
(e.g. for travis cron job)."""</span>
<span class="keyword">from</span> <span class="identifier">functools</span> <span class="keyword">import</span> <span class="identifier">partial</span>
<span class="keyword">from</span> <span class="identifier">unittest</span><span class="punctuation">.</span><span class="identifier">mock</span> <span class="keyword">import</span> <span class="identifier">patch</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_common</span> <span class="keyword">import</span> <span class="identifier">check_as_frame</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_common</span> <span class="keyword">import</span> <span class="identifier">check_pandas_dependency_message</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">tests</span><span class="punctuation">.</span><span class="identifier">test_common</span> <span class="keyword">import</span> <span class="identifier">check_return_X_y</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">normalize</span>


<span class="keyword">def</span> <span class="identifier">test_20news</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_fxt</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'all'</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="comment"># Extract a reduced dataset</span>
    <span class="identifier">data2cats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_fxt</span><span class="grouping">(</span>
        <span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'all'</span><span class="punctuation">,</span> <span class="identifier">categories</span><span class="arithmetic-assignment">=</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target_names</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="comment"># Check that the ordering of the target_names is the same</span>
    <span class="comment"># as the ordering in the full dataset</span>
    <span class="keyword">assert</span> <span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">target_names</span> <span class="relational-operator">==</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target_names</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="comment"># Assert that we have only 0 and 1 as labels</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>

    <span class="comment"># Check that the number of filenames is consistent with data/target</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">filenames</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">filenames</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>

    <span class="comment"># Check that the first entry of the reduced dataset corresponds to</span>
    <span class="comment"># the first entry of the corresponding category in the full dataset</span>
    <span class="identifier">entry1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">category</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">target_names</span><span class="grouping">[</span><span class="identifier">data2cats</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target_names</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">category</span><span class="grouping">)</span>
    <span class="identifier">entry2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">==</span> <span class="identifier">label</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">entry1</span> <span class="relational-operator">==</span> <span class="identifier">entry2</span>

    <span class="comment"># check that return_X_y option</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_fxt</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'all'</span><span class="punctuation">,</span> <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span>


<span class="keyword">def</span> <span class="identifier">test_20news_length_consistency</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Checks the length consistencies within the bunch

    This is a non-regression test for a bug present in 0.16.1.
    """</span>
    <span class="comment"># Extract the full dataset</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_fxt</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'all'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">[</span><span class="string-literal">'data'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">[</span><span class="string-literal">'target'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">[</span><span class="string-literal">'filenames'</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">filenames</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_20news_vectorized</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test subset = train</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">"train"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">isspmatrix_csr</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">11314</span><span class="punctuation">,</span> <span class="int-literal">130107</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">11314</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="comment"># test subset = test</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">"test"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">isspmatrix_csr</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">7532</span><span class="punctuation">,</span> <span class="int-literal">130107</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">7532</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>

    <span class="comment"># test return_X_y option</span>
    <span class="identifier">fetch_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">partial</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="punctuation">,</span> <span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'test'</span><span class="grouping">)</span>
    <span class="identifier">check_return_X_y</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">,</span> <span class="identifier">fetch_func</span><span class="grouping">)</span>

    <span class="comment"># test subset = all</span>
    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'all'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">isspmatrix_csr</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">11314</span> <span class="arithmetic-operator">+</span> <span class="int-literal">7532</span><span class="punctuation">,</span> <span class="int-literal">130107</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">11314</span> <span class="arithmetic-operator">+</span> <span class="int-literal">7532</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>


<span class="keyword">def</span> <span class="identifier">test_20news_normalization</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X_norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_</span><span class="grouping">[</span><span class="string-literal">'data'</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="string-literal">'data'</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">X_norm</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">allclose</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">X_norm</span><span class="punctuation">.</span><span class="identifier">todense</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_20news_as_frame</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">pd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">s</span><span class="invalid">k</span><span class="invalid">i</span><span class="invalid">p</span><span class="grouping">(</span><span class="string-literal">'pandas'</span><span class="grouping">)</span>

    <span class="identifier">bunch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">check_as_frame</span><span class="grouping">(</span><span class="identifier">bunch</span><span class="punctuation">,</span> <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">)</span>

    <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">frame</span>
    <span class="keyword">assert</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">11314</span><span class="punctuation">,</span> <span class="int-literal">130108</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">col</span><span class="punctuation">,</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">SparseDtype</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">col</span> <span class="relational-operator">in</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">dtypes</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check a small subset of features</span>
    <span class="keyword">for</span> <span class="identifier">expected_feature</span> <span class="relational-operator">in</span> <span class="grouping">[</span>
        <span class="string-literal">"beginner"</span><span class="punctuation">,</span>
        <span class="string-literal">"beginners"</span><span class="punctuation">,</span>
        <span class="string-literal">"beginning"</span><span class="punctuation">,</span>
        <span class="string-literal">"beginnings"</span><span class="punctuation">,</span>
        <span class="string-literal">"begins"</span><span class="punctuation">,</span>
        <span class="string-literal">"begley"</span><span class="punctuation">,</span>
        <span class="string-literal">"begone"</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">expected_feature</span> <span class="relational-operator">in</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="string-literal">"category_class"</span> <span class="relational-operator">in</span> <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bunch</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">"category_class"</span>


<span class="keyword">def</span> <span class="identifier">test_as_frame_no_pandas</span><span class="grouping">(</span>
    <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="punctuation">,</span> <span class="identifier">hide_available_pandas</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_pandas_dependency_message</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_outdated_pickle</span><span class="grouping">(</span><span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">patch</span><span class="grouping">(</span><span class="string-literal">"os.path.exists"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">mock_is_exist</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">patch</span><span class="grouping">(</span><span class="string-literal">"joblib.load"</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">mock_load</span><span class="punctuation">:</span>
            <span class="comment"># mock that the dataset was cached</span>
            <span class="identifier">mock_is_exist</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
            <span class="comment"># mock that we have an outdated pickle with only X and y returned</span>
            <span class="identifier">mock_load</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">v</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">u</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"X", "y"</span><span class="grouping">)</span>
            <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"The cached dataset located in"</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">fetch_20newsgroups_vectorized_fxt</span><span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">e</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    </pre>
  </body>
</html>