<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Benchmarks of Non-Negative Matrix Factorization
"""</span>
<span class="comment"># Authors: Tom Dupre la Tour (benchmark)</span>
<span class="comment">#          Chih-Jen Linn (original projected gradient NMF implementation)</span>
<span class="comment">#          Anthony Di Franco (projected gradient, Python and NumPy port)</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">import</span> <span class="identifier">numbers</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Memory</span>
<span class="keyword">import</span> <span class="identifier">pandas</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">text</span> <span class="keyword">import</span> <span class="identifier">TfidfVectorizer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">NMF</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">_nmf</span> <span class="keyword">import</span> <span class="identifier">_initialize_nmf</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">_nmf</span> <span class="keyword">import</span> <span class="identifier">_beta_divergence</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span><span class="punctuation">.</span><span class="identifier">_nmf</span> <span class="keyword">import</span> <span class="identifier">_check_init</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">safe_sparse_dot</span><span class="punctuation">,</span> <span class="identifier">squared_norm</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_array</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span><span class="punctuation">,</span> <span class="identifier">check_non_negative</span>


<span class="identifier">mem</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="arithmetic-assignment">=</span><span class="string-literal">'.'</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="comment">###################</span>
<span class="comment"># Start of _PGNMF #</span>
<span class="comment">###################</span>
<span class="comment"># This class implements a projected gradient solver for the NMF.</span>
<span class="comment"># The projected gradient solver was removed from scikit-learn in version 0.19,</span>
<span class="comment"># and a simplified copy is used here for comparison purpose only.</span>
<span class="comment"># It is not tested, and it may change or disappear without notice.</span>


<span class="keyword">def</span> <span class="identifier">_norm</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Dot product-based Euclidean norm implementation
    See: http://fseoane.net/blog/2011/computing-the-vector-norm/
    """</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">squared_norm</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_nls_subproblem</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span>
                    <span class="identifier">sigma</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Non-negative least square solver
    Solves a non-negative least squares subproblem using the projected
    gradient descent algorithm.
    Parameters
    ----------
    X : array-like, shape (n_samples, n_features)
        Constant matrix.
    W : array-like, shape (n_samples, n_components)
        Constant matrix.
    H : array-like, shape (n_components, n_features)
        Initial guess for the solution.
    tol : float
        Tolerance of the stopping condition.
    max_iter : int
        Maximum number of iterations before timing out.
    alpha : double, default: 0.
        Constant that multiplies the regularization terms. Set it to zero to
        have no regularization.
    l1_ratio : double, default: 0.
        The regularization mixing parameter, with 0 &lt;= l1_ratio &lt;= 1.
        For l1_ratio = 0 the penalty is an L2 penalty.
        For l1_ratio = 1 it is an L1 penalty.
        For 0 &lt; l1_ratio &lt; 1, the penalty is a combination of L1 and L2.
    sigma : float
        Constant used in the sufficient decrease condition checked by the line
        search.  Smaller values lead to a looser sufficient decrease condition,
        thus reducing the time taken by the line search, but potentially
        increasing the number of iterations of the projected gradient
        procedure. 0.01 is a commonly used value in the optimization
        literature.
    beta : float
        Factor by which the step size is decreased (resp. increased) until
        (resp. as long as) the sufficient decrease condition is satisfied.
        Larger values allow to find a better step size but lead to longer line
        search. 0.1 is a commonly used value in the optimization literature.
    Returns
    -------
    H : array-like, shape (n_components, n_features)
        Solution to the non-negative least squares problem.
    grad : array-like, shape (n_components, n_features)
        The gradient.
    n_iter : int
        The number of iterations done by the algorithm.
    References
    ----------
    C.-J. Lin. Projected gradient methods for non-negative matrix
    factorization. Neural Computation, 19(2007), 2756-2779.
    https://www.csie.ntu.edu.tw/~cjlin/nmf/
    """</span>
    <span class="identifier">WtX</span> <span class="arithmetic-assignment">=</span> <span class="identifier">safe_sparse_dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">WtW</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="grouping">)</span>

    <span class="comment"># values justified in the paper (alpha is renamed gamma)</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">for</span> <span class="identifier">n_iter</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">WtW</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">WtX</span>
        <span class="keyword">if</span> <span class="identifier">alpha</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span> <span class="logical-operator">and</span> <span class="identifier">l1_ratio</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">:</span>
            <span class="identifier">grad</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">alpha</span>
        <span class="keyword">elif</span> <span class="identifier">alpha</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">grad</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">l1_ratio</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">l1_ratio</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">H</span><span class="grouping">)</span>

        <span class="comment"># The following multiplication with a boolean array is more than twice</span>
        <span class="comment"># as fast as indexing into grad.</span>
        <span class="keyword">if</span> <span class="identifier">_norm</span><span class="grouping">(</span><span class="identifier">grad</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span><span class="identifier">grad</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol</span><span class="punctuation">:</span>
            <span class="keyword">break</span>

        <span class="identifier">Hp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">H</span>

        <span class="keyword">for</span> <span class="identifier">inner_iter</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Gradient step.</span>
            <span class="identifier">Hn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">H</span> <span class="arithmetic-operator">-</span> <span class="identifier">gamma</span> <span class="arithmetic-operator">*</span> <span class="identifier">grad</span>
            <span class="comment"># Projection step.</span>
            <span class="identifier">Hn</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">Hn</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
            <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Hn</span> <span class="arithmetic-operator">-</span> <span class="identifier">H</span>
            <span class="identifier">gradd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">grad</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">dQd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">WtW</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">suff_decr</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">sigma</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">gradd</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">dQd</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span>
            <span class="keyword">if</span> <span class="identifier">inner_iter</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">decr_gamma</span> <span class="arithmetic-assignment">=</span> <span class="logical-operator">not</span> <span class="identifier">suff_decr</span>

            <span class="keyword">if</span> <span class="identifier">decr_gamma</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">suff_decr</span><span class="punctuation">:</span>
                    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Hn</span>
                    <span class="keyword">break</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">gamma</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">beta</span>
            <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">suff_decr</span> <span class="logical-operator">or</span> <span class="grouping">(</span><span class="identifier">Hp</span> <span class="relational-operator">==</span> <span class="identifier">Hn</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Hp</span>
                <span class="keyword">break</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">gamma</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">beta</span>
                <span class="identifier">Hp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Hn</span>

    <span class="keyword">if</span> <span class="identifier">n_iter</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span><span class="punctuation">:</span>
        <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Iteration limit reached in nls subproblem."</span><span class="punctuation">,</span>
                      <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">grad</span><span class="punctuation">,</span> <span class="identifier">n_iter</span>


<span class="keyword">def</span> <span class="identifier">_fit_projected_gradient</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">nls_max_iter</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span>
                            <span class="identifier">l1_ratio</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">gradW</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
             <span class="identifier">safe_sparse_dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">dense_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">gradH</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
             <span class="identifier">safe_sparse_dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dense_output</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">init_grad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squared_norm</span><span class="grouping">(</span><span class="identifier">gradW</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">squared_norm</span><span class="grouping">(</span><span class="identifier">gradH</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="comment"># max(0.001, tol) to force alternating minimizations of W and H</span>
    <span class="identifier">tolW</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="float-literal">0.001</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">init_grad</span><span class="grouping">)</span>
    <span class="identifier">tolH</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tolW</span>

    <span class="keyword">for</span> <span class="identifier">n_iter</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_iter</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># stopping condition as discussed in paper</span>
        <span class="identifier">proj_grad_W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squared_norm</span><span class="grouping">(</span><span class="identifier">gradW</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span><span class="identifier">gradW</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">W</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">proj_grad_H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">squared_norm</span><span class="grouping">(</span><span class="identifier">gradH</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_or</span><span class="grouping">(</span><span class="identifier">gradH</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">proj_grad_W</span> <span class="arithmetic-operator">+</span> <span class="identifier">proj_grad_H</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">init_grad</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">:</span>
            <span class="keyword">break</span>

        <span class="comment"># update W</span>
        <span class="identifier">Wt</span><span class="punctuation">,</span> <span class="identifier">gradWt</span><span class="punctuation">,</span> <span class="identifier">iterW</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_nls_subproblem</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">tolW</span><span class="punctuation">,</span> <span class="identifier">nls_max_iter</span><span class="punctuation">,</span>
                                            <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="grouping">)</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">gradW</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Wt</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">gradWt</span><span class="punctuation">.</span><span class="identifier">T</span>

        <span class="keyword">if</span> <span class="identifier">iterW</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">tolW</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">tolW</span>

        <span class="comment"># update H</span>
        <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">gradH</span><span class="punctuation">,</span> <span class="identifier">iterH</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_nls_subproblem</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">tolH</span><span class="punctuation">,</span> <span class="identifier">nls_max_iter</span><span class="punctuation">,</span>
                                          <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">iterH</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">tolH</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span> <span class="arithmetic-operator">*</span> <span class="identifier">tolH</span>

    <span class="identifier">H</span><span class="grouping">[</span><span class="identifier">H</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>   <span class="comment"># fix up negative zeros</span>

    <span class="keyword">if</span> <span class="identifier">n_iter</span> <span class="relational-operator">==</span> <span class="identifier">max_iter</span><span class="punctuation">:</span>
        <span class="identifier">Wt</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_nls_subproblem</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">tolW</span><span class="punctuation">,</span> <span class="identifier">nls_max_iter</span><span class="punctuation">,</span>
                                   <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="grouping">)</span>
        <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Wt</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="keyword">return</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">n_iter</span>


<span class="keyword">class</span> <span class="identifier">_PGNMF</span><span class="grouping">(</span><span class="identifier">NMF</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Non-Negative Matrix Factorization (NMF) with projected gradient solver.

    This class is private and for comparison purpose only.
    It may change or disappear without notice.

    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'pg'</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">nls_max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span>
            <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nls_max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nls_max_iter</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">W</span>

    <span class="keyword">def</span> <span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="arithmetic-assignment">=</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">H</span>
        <span class="keyword">return</span> <span class="identifier">W</span>

    <span class="keyword">def</span> <span class="identifier">_fit_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">accept_sparse</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'csr', 'csc'</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">check_non_negative</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="string-literal">"NMF (input X)"</span><span class="grouping">)</span>

        <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span>
        <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span>

        <span class="keyword">if</span> <span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span> <span class="logical-operator">or</span>
                <span class="identifier">n_components</span> <span class="relational-operator">&lt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Number of components must be a positive integer;"</span>
                             <span class="string-literal">" got (n_components=%r)"</span> <span class="arithmetic-operator">%</span> <span class="identifier">n_components</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="grouping">(</span><span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span> <span class="logical-operator">or</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Maximum number of iterations must be a positive "</span>
                             <span class="string-literal">"integer; got (max_iter=%r)"</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Number</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Tolerance for stopping criteria must be "</span>
                             <span class="string-literal">"positive; got (tol=%r)"</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="grouping">)</span>

        <span class="comment"># check W and H, or initialize them</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'custom'</span> <span class="logical-operator">and</span> <span class="identifier">update_H</span><span class="punctuation">:</span>
            <span class="identifier">_check_init</span><span class="grouping">(</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"NMF (input H)"</span><span class="grouping">)</span>
            <span class="identifier">_check_init</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"NMF (input W)"</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">update_H</span><span class="punctuation">:</span>
            <span class="identifier">_check_init</span><span class="grouping">(</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">"NMF (input H)"</span><span class="grouping">)</span>
            <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">update_H</span><span class="punctuation">:</span>  <span class="comment"># fit_transform</span>
            <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_fit_projected_gradient</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nls_max_iter</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">l1_ratio</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># transform</span>
            <span class="identifier">Wt</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_nls_subproblem</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
                                            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">nls_max_iter</span><span class="punctuation">,</span>
                                            <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                                            <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">l1_ratio</span><span class="grouping">)</span>
            <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Wt</span><span class="punctuation">.</span><span class="identifier">T</span>

        <span class="keyword">if</span> <span class="identifier">n_iter</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Maximum number of iteration %d reached. Increase it"</span>
                          <span class="string-literal">" to improve convergence."</span> <span class="arithmetic-operator">%</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
                          <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">n_iter</span>

<span class="comment">#################</span>
<span class="comment"># End of _PGNMF #</span>
<span class="comment">#################</span>


<span class="keyword">def</span> <span class="identifier">plot_results</span><span class="grouping">(</span><span class="identifier">results_df</span><span class="punctuation">,</span> <span class="identifier">plot_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">results_df</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="none-literal">None</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">colors</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'bgr'</span>
    <span class="identifier">markers</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'ovs'</span>
    <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">init</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">results_df</span><span class="grouping">[</span><span class="string-literal">'init'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplot</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">sharex</span><span class="arithmetic-assignment">=</span><span class="identifier">ax</span><span class="punctuation">,</span> <span class="identifier">sharey</span><span class="arithmetic-assignment">=</span><span class="identifier">ax</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">j</span><span class="punctuation">,</span> <span class="identifier">method</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">results_df</span><span class="grouping">[</span><span class="string-literal">'method'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_and</span><span class="grouping">(</span><span class="identifier">results_df</span><span class="grouping">[</span><span class="string-literal">'init'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">init</span><span class="punctuation">,</span>
                                  <span class="identifier">results_df</span><span class="grouping">[</span><span class="string-literal">'method'</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">method</span><span class="grouping">)</span>
            <span class="identifier">selected_items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">results_df</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span>

            <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">selected_items</span><span class="grouping">[</span><span class="string-literal">'time'], selected_items['loss'</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">colors</span><span class="grouping">[</span><span class="identifier">j</span> <span class="arithmetic-operator">%</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">colors</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ls</span><span class="arithmetic-assignment">=</span><span class="string-literal">'-'</span><span class="punctuation">,</span>
                     <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="identifier">markers</span><span class="grouping">[</span><span class="identifier">j</span> <span class="arithmetic-operator">%</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">markers</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">method</span><span class="grouping">)</span>

        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="string-literal">'x-small'</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Time (s)"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"loss"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"%s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">init</span><span class="grouping">)</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="identifier">plot_name</span><span class="punctuation">,</span> <span class="identifier">fontsize</span><span class="arithmetic-assignment">=</span><span class="int-literal">16</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="comment"># use joblib to cache the results.</span>
<span class="comment"># X_shape is specified in arguments for avoiding hashing X</span>
<span class="punctuation">@</span><span class="identifier">mem</span><span class="punctuation">.</span><span class="identifier">cache</span><span class="grouping">(</span><span class="identifier">ignore</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'X', 'W0', 'H0'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">bench_one</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W0</span><span class="punctuation">,</span> <span class="identifier">H0</span><span class="punctuation">,</span> <span class="identifier">X_shape</span><span class="punctuation">,</span> <span class="identifier">clf_type</span><span class="punctuation">,</span> <span class="identifier">clf_params</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="punctuation">,</span>
              <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">H0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_type</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">clf_params</span><span class="grouping">)</span>
    <span class="identifier">st</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="arithmetic-assignment">=</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H</span><span class="grouping">)</span>
    <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">components_</span>

    <span class="identifier">this_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_beta_divergence</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">end</span> <span class="arithmetic-operator">-</span> <span class="identifier">st</span>
    <span class="keyword">return</span> <span class="identifier">this_loss</span><span class="punctuation">,</span> <span class="identifier">duration</span>


<span class="keyword">def</span> <span class="identifier">run_bench</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">clfs</span><span class="punctuation">,</span> <span class="identifier">plot_name</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">results</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">clf_type</span><span class="punctuation">,</span> <span class="identifier">iter_range</span><span class="punctuation">,</span> <span class="identifier">clf_params</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Training %s:"</span> <span class="arithmetic-operator">%</span> <span class="identifier">name</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">rs</span><span class="punctuation">,</span> <span class="identifier">init</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="grouping">(</span><span class="string-literal">'nndsvd', 'nndsvdar', 'random'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"    %s %s: " % (init, " " * (8 - len(init))), end=""</span><span class="grouping">)</span>
            <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="punctuation">,</span> <span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="identifier">rs</span><span class="grouping">)</span>

            <span class="keyword">for</span> <span class="identifier">max_iter</span> <span class="relational-operator">in</span> <span class="identifier">iter_range</span><span class="punctuation">:</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'alpha'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'l1_ratio'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">l1_ratio</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'max_iter'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_iter</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'tol'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'random_state'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rs</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'init'] = 'custom'</span>
                <span class="identifier">clf_params</span><span class="grouping">[</span><span class="string-literal">'n_components'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>

                <span class="identifier">this_loss</span><span class="punctuation">,</span> <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bench_one</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span>
                                                <span class="identifier">clf_type</span><span class="punctuation">,</span> <span class="identifier">clf_params</span><span class="punctuation">,</span>
                                                <span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">rs</span><span class="grouping">)</span>

                <span class="identifier">init_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"init='%s'"</span> <span class="arithmetic-operator">%</span> <span class="identifier">init</span>
                <span class="identifier">results</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">this_loss</span><span class="punctuation">,</span> <span class="identifier">duration</span><span class="punctuation">,</span> <span class="identifier">init_name</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="comment"># print("loss: %.6f, time: %.3f sec" % (this_loss, duration))</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">".", end=""</span><span class="grouping">)</span>
                <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">flush</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">" "</span><span class="grouping">)</span>

    <span class="comment"># Use a panda dataframe to organize the results</span>
    <span class="identifier">results_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pandas</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">results</span><span class="punctuation">,</span>
                                  <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="string-literal">"method loss time init"</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Total time = %0.3f sec\n"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># plot the results</span>
    <span class="identifier">plot_results</span><span class="grouping">(</span><span class="identifier">results_df</span><span class="punctuation">,</span> <span class="identifier">plot_name</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">results_df</span>


<span class="keyword">def</span> <span class="identifier">load_20news</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Loading 20 newsgroups dataset"</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"-----------------------------"</span><span class="grouping">)</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_20newsgroups</span>
    <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_20newsgroups</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                 <span class="identifier">remove</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'headers', 'footers', 'quotes'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">vectorizer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TfidfVectorizer</span><span class="grouping">(</span><span class="identifier">max_df</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.95</span><span class="punctuation">,</span> <span class="identifier">min_df</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">stop_words</span><span class="arithmetic-assignment">=</span><span class="string-literal">'english'</span><span class="grouping">)</span>
    <span class="identifier">tfidf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vectorizer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">dataset</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">tfidf</span>


<span class="keyword">def</span> <span class="identifier">load_faces</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Loading Olivetti face dataset"</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"-----------------------------"</span><span class="grouping">)</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_olivetti_faces</span>
    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_olivetti_faces</span><span class="grouping">(</span><span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">faces</span><span class="punctuation">.</span><span class="identifier">data</span>


<span class="keyword">def</span> <span class="identifier">build_clfs</span><span class="grouping">(</span><span class="identifier">cd_iters</span><span class="punctuation">,</span> <span class="identifier">pg_iters</span><span class="punctuation">,</span> <span class="identifier">mu_iters</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clfs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"Coordinate Descent"</span><span class="punctuation">,</span> <span class="identifier">NMF</span><span class="punctuation">,</span> <span class="identifier">cd_iters</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'solver': 'cd'</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="string-literal">"Projected Gradient"</span><span class="punctuation">,</span> <span class="identifier">_PGNMF</span><span class="punctuation">,</span> <span class="identifier">pg_iters</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'solver': 'pg'</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="string-literal">"Multiplicative Update"</span><span class="punctuation">,</span> <span class="identifier">NMF</span><span class="punctuation">,</span> <span class="identifier">mu_iters</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="string-literal">'solver': 'mu'</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">]</span>
    <span class="keyword">return</span> <span class="identifier">clfs</span>


<span class="keyword">if</span> <span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">'__main__'</span><span class="punctuation">:</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="identifier">l1_ratio</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-15</span>

    <span class="comment"># first benchmark on 20 newsgroup dataset: sparse, shape(11314, 39116)</span>
    <span class="identifier">plot_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"20 Newsgroups sparse dataset"</span>
    <span class="identifier">cd_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">pg_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span>
    <span class="identifier">mu_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">clfs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">build_clfs</span><span class="grouping">(</span><span class="identifier">cd_iters</span><span class="punctuation">,</span> <span class="identifier">pg_iters</span><span class="punctuation">,</span> <span class="identifier">mu_iters</span><span class="grouping">)</span>
    <span class="identifier">X_20news</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_20news</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">run_bench</span><span class="grouping">(</span><span class="identifier">X_20news</span><span class="punctuation">,</span> <span class="identifier">clfs</span><span class="punctuation">,</span> <span class="identifier">plot_name</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="grouping">)</span>

    <span class="comment"># second benchmark on Olivetti faces dataset: dense, shape(400, 4096)</span>
    <span class="identifier">plot_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Olivetti Faces dense dataset"</span>
    <span class="identifier">cd_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">pg_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">)</span>
    <span class="identifier">mu_iters</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
    <span class="identifier">clfs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">build_clfs</span><span class="grouping">(</span><span class="identifier">cd_iters</span><span class="punctuation">,</span> <span class="identifier">pg_iters</span><span class="punctuation">,</span> <span class="identifier">mu_iters</span><span class="grouping">)</span>
    <span class="identifier">X_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_faces</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">run_bench</span><span class="grouping">(</span><span class="identifier">X_faces</span><span class="punctuation">,</span> <span class="identifier">clfs</span><span class="punctuation">,</span> <span class="identifier">plot_name</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="punctuation">,</span><span class="grouping">)</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>