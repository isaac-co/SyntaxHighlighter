<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
==================================================
Statistical comparison of models using grid search
==================================================

This example illustrates how to statistically compare the performance of models
trained and evaluated using :class:`~sklearn.model_selection.GridSearchCV`.
"""</span>

<span class="comment"># %%</span>
<span class="comment"># We will start by simulating moon shaped data (where the ideal separation</span>
<span class="comment"># between classes is non-linear), adding to it a moderate degree of noise.</span>
<span class="comment"># Datapoints will belong to one of two possible classes to be predicted by two</span>
<span class="comment"># features. We will simulate 50 samples for each class:</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">import</span> <span class="identifier">seaborn</span> <span class="keyword">as</span> <span class="identifier">sns</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_moons</span>

<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_moons</span><span class="grouping">(</span><span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.352</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>

<span class="identifier">sns</span><span class="punctuation">.</span><span class="identifier">scatterplot</span><span class="grouping">(</span>
    <span class="identifier">x</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">hue</span><span class="arithmetic-assignment">=</span><span class="identifier">y</span><span class="punctuation">,</span>
    <span class="identifier">marker</span><span class="arithmetic-assignment">=</span><span class="string-literal">'o', s=25, edgecolor='k'</span><span class="punctuation">,</span> <span class="identifier">legend</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span>
<span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">"Data"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We will compare the performance of :class:`~sklearn.svm.SVC` estimators that</span>
<span class="comment"># vary on their `kernel` parameter, to decide which choice of this</span>
<span class="comment"># hyper-parameter predicts our simulated data best.</span>
<span class="comment"># We will evaluate the performance of the models using</span>
<span class="comment"># :class:`~sklearn.model_selection.RepeatedStratifiedKFold`, repeating 10 times</span>
<span class="comment"># a 10-fold stratified cross validation using a different randomization of the</span>
<span class="comment"># data in each repetition. The performance will be evaluated using</span>
<span class="comment"># :class:`~sklearn.metrics.roc_auc_score`.</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="identifier">RepeatedStratifiedKFold</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span>

<span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
    <span class="grouping">{</span><span class="string-literal">'kernel': ['linear'</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="grouping">{</span><span class="string-literal">'kernel': ['poly'], 'degree'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="grouping">{</span><span class="string-literal">'kernel': ['rbf'</span><span class="grouping">]</span><span class="grouping">}</span>
<span class="grouping">]</span>

<span class="identifier">svc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RepeatedStratifiedKFold</span><span class="grouping">(</span>
    <span class="identifier">n_splits</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">n_repeats</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
<span class="grouping">)</span>

<span class="identifier">search</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GridSearchCV</span><span class="grouping">(</span>
    <span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">svc</span><span class="punctuation">,</span> <span class="identifier">param_grid</span><span class="arithmetic-assignment">=</span><span class="identifier">param_grid</span><span class="punctuation">,</span>
    <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">'roc_auc'</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span>
<span class="grouping">)</span>
<span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We can now inspect the results of our search, sorted by their</span>
<span class="comment"># `mean_test_score`:</span>

<span class="keyword">import</span> <span class="identifier">pandas</span> <span class="keyword">as</span> <span class="identifier">pd</span>

<span class="identifier">results_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span><span class="identifier">search</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">)</span>
<span class="identifier">results_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">results_df</span><span class="punctuation">.</span><span class="identifier">sort_values</span><span class="grouping">(</span><span class="identifier">by</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'rank_test_score'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">results_df</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="identifier">results_df</span>
    <span class="punctuation">.</span><span class="identifier">set_index</span><span class="grouping">(</span><span class="identifier">results_df</span><span class="grouping">[</span><span class="string-literal">"params"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span>
        <span class="keyword">lambda</span> <span class="identifier">x</span><span class="punctuation">:</span> <span class="string-literal">"_"</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">val</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="punctuation">.</span><span class="identifier">rename_axis</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="identifier">results_df</span><span class="grouping">[</span>
    <span class="grouping">[</span><span class="string-literal">'params', 'rank_test_score', 'mean_test_score', 'std_test_score'</span><span class="grouping">]</span>
<span class="grouping">]</span>

<span class="comment"># %%</span>
<span class="comment"># We can see that the estimator using the `'rbf'` kernel performed best,</span>
<span class="comment"># closely followed by `'linear'`. Both estimators with a `'poly'` kernel</span>
<span class="comment"># performed worse, with the one using a two-degree polynomial achieving a much</span>
<span class="comment"># lower perfomance than all other models.</span>
<span class="comment">#</span>
<span class="comment"># Usually, the analysis just ends here, but half the story is missing. The</span>
<span class="comment"># output of :class:`~sklearn.model_selection.GridSearchCV` does not provide</span>
<span class="comment"># information on the certainty of the differences between the models.</span>
<span class="comment"># We don't know if these are **statistically** significant.</span>
<span class="comment"># To evaluate this, we need to conduct a statistical test.</span>
<span class="comment"># Specifically, to contrast the performance of two models we should</span>
<span class="comment"># statistically compare their AUC scores. There are 100 samples (AUC</span>
<span class="comment"># scores) for each model as we repreated 10 times a 10-fold cross-validation.</span>
<span class="comment">#</span>
<span class="comment"># However, the scores of the models are not independent: all models are</span>
<span class="comment"># evaluated on the **same** 100 partitions, increasing the correlation</span>
<span class="comment"># between the performance of the models.</span>
<span class="comment"># Since some partitions of the data can make the distinction of the classes</span>
<span class="comment"># particularly easy or hard to find for all models, the models scores will</span>
<span class="comment"># co-vary.</span>
<span class="comment">#</span>
<span class="comment"># Let's inspect this partition effect by plotting the performance of all models</span>
<span class="comment"># in each fold, and calculating the correlation between models across folds:</span>

<span class="comment"># create df of model scores ordered by perfomance</span>
<span class="identifier">model_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">results_df</span><span class="punctuation">.</span><span class="identifier">filter</span><span class="grouping">(</span><span class="identifier">regex</span><span class="arithmetic-assignment">=</span><span class="identifier">r</span><span class="string-literal">'split\d*_test_score'</span><span class="grouping">)</span>

<span class="comment"># plot 30 examples of dependency between cv fold and AUC scores</span>
<span class="identifier">fig</span><span class="punctuation">,</span> <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">sns</span><span class="punctuation">.</span><span class="identifier">lineplot</span><span class="grouping">(</span>
    <span class="identifier">data</span><span class="arithmetic-assignment">=</span><span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">30</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">dashes</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">palette</span><span class="arithmetic-assignment">=</span><span class="string-literal">'Set1', marker='o'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.5</span><span class="punctuation">,</span> <span class="identifier">ax</span><span class="arithmetic-assignment">=</span><span class="identifier">ax</span>
<span class="grouping">)</span>
<span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">"CV test fold"</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="identifier">labelpad</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
<span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">"Model AUC"</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="grouping">)</span>
<span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">tick_params</span><span class="grouping">(</span><span class="identifier">bottom</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">labelbottom</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># print correlation of AUC scores across folds</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Correlation of models:\n {model_scores.transpose().corr()}"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We can observe that the performance of the models highly depends on the fold.</span>
<span class="comment">#</span>
<span class="comment"># As a consequence, if we assume independence between samples we will be</span>
<span class="comment"># underestimating the variance computed in our statistical tests, increasing</span>
<span class="comment"># the number of false positive errors (i.e. detecting a significant difference</span>
<span class="comment"># between models when such does not exist) [1]_.</span>
<span class="comment">#</span>
<span class="comment"># Several variance-corrected statistical tests have been developed for these</span>
<span class="comment"># cases. In this example we will show how to implement one of them (the so</span>
<span class="comment"># called Nadeau and Bengio's corrected t-test) under two different statistical</span>
<span class="comment"># frameworks: frequentist and Bayesian.</span>

<span class="comment"># %%</span>
<span class="comment"># Comparing two models: frequentist approach</span>
<span class="comment"># ------------------------------------------</span>
<span class="comment">#</span>
<span class="comment"># We can start by asking: "Is the first model significantly better than the</span>
<span class="comment"># second model (when ranked by `mean_test_score`)?"</span>
<span class="comment">#</span>
<span class="comment"># To answer this question using a frequentist approach we could</span>
<span class="comment"># run a paired t-test and compute the p-value. This is also known as</span>
<span class="comment"># Diebold-Mariano test in the forecast literature [5]_.</span>
<span class="comment"># Many variants of such a t-test have been developed to account for the</span>
<span class="comment"># 'non-independence of samples problem'</span>
<span class="comment"># described in the previous section. We will use the one proven to obtain the</span>
<span class="comment"># highest replicability scores (which rate how similar the performance of a</span>
<span class="comment"># model is when evaluating it on different random partitions of the same</span>
<span class="comment"># dataset) while mantaining a low rate of false postitives and false negatives:</span>
<span class="comment"># the Nadeau and Bengio's corrected t-test [2]_ that uses a 10 times repeated</span>
<span class="comment"># 10-fold cross validation [3]_.</span>
<span class="comment">#</span>
<span class="comment"># This corrected paired t-test is computed as:</span>
<span class="comment">#</span>
<span class="comment"># .. math::</span>
<span class="comment">#    t=\frac{\frac{1}{k \cdot r}\sum_{i=1}^{k}\sum_{j=1}^{r}x_{ij}}</span>
<span class="comment">#    {\sqrt{(\frac{1}{k \cdot r}+\frac{n_{test}}{n_{train}})\hat{\sigma}^2}}</span>
<span class="comment">#</span>
<span class="comment"># where :math:`k` is the number of folds,</span>
<span class="comment"># :math:`r` the number of repetitions in the cross-validation,</span>
<span class="comment"># :math:`x` is the difference in performance of the models,</span>
<span class="comment"># :math:`n_{test}` is the number of samples used for testing,</span>
<span class="comment"># :math:`n_{train}` is the number of samples used for training,</span>
<span class="comment"># and :math:`\hat{\sigma}^2` represents the variance of the observed</span>
<span class="comment"># differences.</span>
<span class="comment">#</span>
<span class="comment"># Let's implement a corrected right-tailed paired t-test to evaluate if the</span>
<span class="comment"># performance of the first model is significantly better than that of the</span>
<span class="comment"># second model. Our null hypothesis is that the second model performs at least</span>
<span class="comment"># as good as the first model.</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">t</span>


<span class="keyword">def</span> <span class="identifier">corrected_std</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Corrects standard deviation using Nadeau and Bengio's approach.

    Parameters
    ----------
    differences : ndarray of shape (n_samples, 1)
        Vector containing the differences in the score metrics of two models.
    n_train : int
        Number of samples in the training set.
    n_test : int
        Number of samples in the testing set.

    Returns
    -------
    corrected_std : int
        Variance-corrected standard deviation of the set of differences.
    """</span>
    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_train</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_test</span>
    <span class="identifier">corrected_var</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">ddof</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="identifier">n</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">n_test</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_train</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">corrected_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">corrected_var</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">corrected_std</span>


<span class="keyword">def</span> <span class="identifier">compute_corrected_ttest</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Computes right-tailed paired t-test with corrected variance.

    Parameters
    ----------
    differences : array-like of shape (n_samples, 1)
        Vector containing the differences in the score metrics of two models.
    df : int
        Degrees of freedom.
    n_train : int
        Number of samples in the training set.
    n_test : int
        Number of samples in the testing set.

    Returns
    -------
    t_stat : float
        Variance-corrected t-statistic.
    p_val : float
        Variance-corrected p-value.
    """</span>
    <span class="identifier">mean</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">differences</span><span class="grouping">)</span>
    <span class="identifier">std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">corrected_std</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="grouping">)</span>
    <span class="identifier">t_stat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean</span> <span class="arithmetic-operator">/</span> <span class="identifier">std</span>
    <span class="identifier">p_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">sf</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">t_stat</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="grouping">)</span>  <span class="comment"># right-tailed t-test</span>
    <span class="keyword">return</span> <span class="identifier">t_stat</span><span class="punctuation">,</span> <span class="identifier">p_val</span>


<span class="comment"># %%</span>
<span class="identifier">model_1_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">values</span>  <span class="comment"># scores of the best model</span>
<span class="identifier">model_2_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">values</span>  <span class="comment"># scores of the second-best model</span>

<span class="identifier">differences</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_1_scores</span> <span class="arithmetic-operator">-</span> <span class="identifier">model_2_scores</span>

<span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">differences</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>  <span class="comment"># number of test sets</span>
<span class="identifier">df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
<span class="identifier">n_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">n_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">t_stat</span><span class="punctuation">,</span> <span class="identifier">p_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_corrected_ttest</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Corrected t-value: {t_stat:.3f}\n"</span>
      <span class="identifier">f</span><span class="string-literal">"Corrected p-value: {p_val:.3f}"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We can compare the corrected t- and p-values with the uncorrected ones:</span>

<span class="identifier">t_stat_uncorrected</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">differences</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">ddof</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="identifier">p_val_uncorrected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">sf</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">t_stat_uncorrected</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="grouping">)</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Uncorrected t-value: {t_stat_uncorrected:.3f}\n"</span>
      <span class="identifier">f</span><span class="string-literal">"Uncorrected p-value: {p_val_uncorrected:.3f}"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Using the conventional significance alpha level at `p=0.05`, we observe that</span>
<span class="comment"># the uncorrected t-test concludes that the first model is significantly better</span>
<span class="comment"># than the second.</span>
<span class="comment">#</span>
<span class="comment"># With the corrected approach, in contrast, we fail to detect this difference.</span>
<span class="comment">#</span>
<span class="comment"># In the latter case, however, the frequentist approach does not let us</span>
<span class="comment"># conclude that the first and second model have an equivalent performance. If</span>
<span class="comment"># we wanted to make this assertion we need to use a Bayesian approach.</span>

<span class="comment"># %%</span>
<span class="comment"># Comparing two models: Bayesian approach</span>
<span class="comment"># ---------------------------------------</span>
<span class="comment"># We can use Bayesian estimation to calculate the probability that the first</span>
<span class="comment"># model is better than the second. Bayesian estimation will output a</span>
<span class="comment"># distribution followed by the mean :math:`\mu` of the differences in the</span>
<span class="comment"># performance of two models.</span>
<span class="comment">#</span>
<span class="comment"># To obtain the posterior distribution we need to define a prior that models</span>
<span class="comment"># our beliefs of how the mean is distributed before looking at the data,</span>
<span class="comment"># and multiply it by a likelihood function that computes how likely our</span>
<span class="comment"># observed differences are, given the values that the mean of differences</span>
<span class="comment"># could take.</span>
<span class="comment">#</span>
<span class="comment"># Bayesian estimation can be carried out in many forms to answer our question,</span>
<span class="comment"># but in this example we will implement the approach suggested by Benavoli and</span>
<span class="comment"># collegues [4]_.</span>
<span class="comment">#</span>
<span class="comment"># One way of defining our posterior using a closed-form expression is to select</span>
<span class="comment"># a prior conjugate to the likelihood function. Benavoli and collegues [4]_</span>
<span class="comment"># show that when comparing the performance of two classifiers we can model the</span>
<span class="comment"># prior as a Normal-Gamma distribution (with both mean and variance unknown)</span>
<span class="comment"># conjugate to a normal likelihood, to thus express the posterior as a normal</span>
<span class="comment"># distribution.</span>
<span class="comment"># Marginalizing out the variance from this normal posterior, we can define the</span>
<span class="comment"># posterior of the mean parameter as a Student's t-distribution. Specifically:</span>
<span class="comment">#</span>
<span class="comment"># .. math::</span>
<span class="comment">#    St(\mu;n-1,\overline{x},(\frac{1}{n}+\frac{n_{test}}{n_{train}})</span>
<span class="comment">#    \hat{\sigma}^2)</span>
<span class="comment">#</span>
<span class="comment"># where :math:`n` is the total number of samples,</span>
<span class="comment"># :math:`\overline{x}` represents the mean difference in the scores,</span>
<span class="comment"># :math:`n_{test}` is the number of samples used for testing,</span>
<span class="comment"># :math:`n_{train}` is the number of samples used for training,</span>
<span class="comment"># and :math:`\hat{\sigma}^2` represents the variance of the observed</span>
<span class="comment"># differences.</span>
<span class="comment">#</span>
<span class="comment"># Notice that we are using Nadeau and Bengio's corrected variance in our</span>
<span class="comment"># Bayesian approach as well.</span>
<span class="comment">#</span>
<span class="comment"># Let's compute and plot the posterior:</span>

<span class="comment"># intitialize random variable</span>
<span class="identifier">t_post</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t</span><span class="grouping">(</span>
    <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">differences</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="identifier">corrected_std</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="grouping">)</span>
<span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Let's plot the posterior distribution:</span>

<span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">ppf</span><span class="grouping">(</span><span class="float-literal">0.001</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">ppf</span><span class="grouping">(</span><span class="float-literal">0.999</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">pdf</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="float-literal">-0.04</span><span class="punctuation">,</span> <span class="float-literal">0.06</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">fill_between</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">pdf</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blue'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Probability density"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"Mean difference ($\mu$)"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Posterior distribution"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We can calculate the probability that the first model is better than the</span>
<span class="comment"># second by computing the area under the curve of the posterior distirbution</span>
<span class="comment"># from zero to infinity. And also the reverse: we can calculate the probability</span>
<span class="comment"># that the second model is better than the first by computing the area under</span>
<span class="comment"># the curve from minus infinity to zero.</span>

<span class="identifier">better_prob</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Probability of {model_scores.index[0]} being more accurate than "</span>
      <span class="identifier">f</span><span class="string-literal">"{model_scores.index[1]}: {better_prob:.3f}"</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Probability of {model_scores.index[1]} being more accurate than "</span>
      <span class="identifier">f</span><span class="string-literal">"{model_scores.index[0]}: {1 - better_prob:.3f}"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># In contrast with the frequentist approach, we can compute the probability</span>
<span class="comment"># that one model is better than the other.</span>
<span class="comment">#</span>
<span class="comment"># Note that we obtained similar results as those in the frequentist approach.</span>
<span class="comment"># Given our choice of priors, we are essentially performing the same</span>
<span class="comment"># computations, but we are allowed to make different assertions.</span>

<span class="comment"># %%</span>
<span class="comment"># Region of Practical Equivalence</span>
<span class="comment"># ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="comment"># Sometimes we are interested in determining the probabilities that our models</span>
<span class="comment"># have an equivalent performance, where "equivalent" is defined in a practical</span>
<span class="comment"># way. A naive approach [4]_ would be to define estimators as practically</span>
<span class="comment"># equivalent when they differ by less than 1% in their accuracy. But we could</span>
<span class="comment"># also define this practical equivalence taking into account the problem we are</span>
<span class="comment"># trying to solve. For example, a difference of 5% in accuracy would mean an</span>
<span class="comment"># increase of $1000 in sales, and we consider any quantity above that as</span>
<span class="comment"># relevant for our business.</span>
<span class="comment">#</span>
<span class="comment"># In this example we are going to define the</span>
<span class="comment"># Region of Practical Equivalence (ROPE) to be :math:`[-0.01, 0.01]`. That is,</span>
<span class="comment"># we will consider two models as practically equivalent if they differ by less</span>
<span class="comment"># than 1% in their performance.</span>
<span class="comment">#</span>
<span class="comment"># To compute the probabilities of the classifiers being practically equivalent,</span>
<span class="comment"># we calculate the area under the curve of the posterior over the ROPE</span>
<span class="comment"># interval:</span>

<span class="identifier">rope_interval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">-0.01</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">]</span>
<span class="identifier">rope_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"Probability of {model_scores.index[0]} and {model_scores.index[1]} "</span>
      <span class="identifier">f</span><span class="string-literal">"being practically equivalent: {rope_prob:.3f}"</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># We can plot how the posterior is distributed over the ROPE interval:</span>

<span class="identifier">x_rope</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">pdf</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xticks</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="float-literal">-0.04</span><span class="punctuation">,</span> <span class="float-literal">0.06</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">vlines</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">-0.01</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ymin</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">ymax</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">pdf</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">fill_between</span><span class="grouping">(</span><span class="identifier">x_rope</span><span class="punctuation">,</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">pdf</span><span class="grouping">(</span><span class="identifier">x_rope</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">facecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'blue'</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.2</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Probability density"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"Mean difference ($\mu$)"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Posterior distribution under the ROPE"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># As suggested in [4]_, we can further interpret these probabilities using the</span>
<span class="comment"># same criteria as the frequentist approach: is the probability of falling</span>
<span class="comment"># inside the ROPE bigger than 95% (alpha value of 5%)?  In that case we can</span>
<span class="comment"># conclude that both models are practically equivalent.</span>

<span class="comment"># %%</span>
<span class="comment"># The Bayesian estimation approach also allows us to compute how uncertain we</span>
<span class="comment"># are about our estimation of the difference. This can be calculated using</span>
<span class="comment"># credible intervals. For a given probability, they show the range of values</span>
<span class="comment"># that the estimated quantity, in our case the mean difference in</span>
<span class="comment"># performance, can take.</span>
<span class="comment"># For example, a 50% credible interval [x, y] tells us that there is a 50%</span>
<span class="comment"># probability that the true (mean) difference of performance between models is</span>
<span class="comment"># between x and y.</span>
<span class="comment">#</span>
<span class="comment"># Let's determine the credible intervals of our data using 50%, 75% and 95%:</span>

<span class="identifier">cred_intervals</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">intervals</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.75</span><span class="punctuation">,</span> <span class="float-literal">0.95</span><span class="grouping">]</span>

<span class="keyword">for</span> <span class="identifier">interval</span> <span class="relational-operator">in</span> <span class="identifier">intervals</span><span class="punctuation">:</span>
    <span class="identifier">cred_interval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">interval</span><span class="grouping">(</span><span class="identifier">interval</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">cred_intervals</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">interval</span><span class="punctuation">,</span> <span class="identifier">cred_interval</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">cred_interval</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">cred_int_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span>
    <span class="identifier">cred_intervals</span><span class="punctuation">,</span>
    <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'interval', 'lower value', 'upper value'</span><span class="grouping">]</span>
<span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_index</span><span class="grouping">(</span><span class="string-literal">'interval'</span><span class="grouping">)</span>
<span class="identifier">cred_int_df</span>

<span class="comment"># %%</span>
<span class="comment"># As shown in the table, there is a 50% probability that the true mean</span>
<span class="comment"># difference between models will be between 0.000977 and 0.019023, 70%</span>
<span class="comment"># probability that it will be between -0.005422 and 0.025422, and 95%</span>
<span class="comment"># probability that it will be between -0.016445	and 0.036445.</span>

<span class="comment"># %%</span>
<span class="comment"># Pairwise comparison of all models: frequentist approach</span>
<span class="comment"># -------------------------------------------------------</span>
<span class="comment">#</span>
<span class="comment"># We could also be interested in comparing the performance of all our models</span>
<span class="comment"># evaluated with :class:`~sklearn.model_selection.GridSearchCV`. In this case</span>
<span class="comment"># we would be running our statistical test multiple times, which leads us to</span>
<span class="comment"># the `multiple comparisons problem</span>
<span class="comment"># &lt;https://en.wikipedia.org/wiki/Multiple_comparisons_problem&gt;`_.</span>
<span class="comment">#</span>
<span class="comment"># There are many possible ways to tackle this problem, but a standard approach</span>
<span class="comment"># is to apply a `Bonferroni correction</span>
<span class="comment"># &lt;https://en.wikipedia.org/wiki/Bonferroni_correction&gt;`_. Bonferroni can be</span>
<span class="comment"># computed by multiplying the p-value by the number of comparisons we are</span>
<span class="comment"># testing.</span>
<span class="comment">#</span>
<span class="comment"># Let's compare the performance of the models using the corrected t-test:</span>

<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">combinations</span>
<span class="keyword">from</span> <span class="identifier">math</span> <span class="keyword">import</span> <span class="identifier">factorial</span>

<span class="identifier">n_comparisons</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="identifier">factorial</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">model_scores</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">factorial</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">factorial</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">model_scores</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="identifier">pairwise_t_test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

<span class="keyword">for</span> <span class="identifier">model_i</span><span class="punctuation">,</span> <span class="identifier">model_k</span> <span class="relational-operator">in</span> <span class="identifier">combinations</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">model_scores</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">model_i_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">model_i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">values</span>
    <span class="identifier">model_k_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">model_k</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">values</span>
    <span class="identifier">differences</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_i_scores</span> <span class="arithmetic-operator">-</span> <span class="identifier">model_k_scores</span>
    <span class="identifier">t_stat</span><span class="punctuation">,</span> <span class="identifier">p_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_corrected_ttest</span><span class="grouping">(</span>
        <span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span>
    <span class="grouping">)</span>
    <span class="identifier">p_val</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">n_comparisons</span>  <span class="comment"># implement Bonferroni correction</span>
    <span class="comment"># Bonferroni can output p-values higher than 1</span>
    <span class="identifier">p_val</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">p_val</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span> <span class="keyword">else</span> <span class="identifier">p_val</span>
    <span class="identifier">pairwise_t_test</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">[</span><span class="identifier">model_i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">[</span><span class="identifier">model_k</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="identifier">t_stat</span><span class="punctuation">,</span> <span class="identifier">p_val</span><span class="grouping">]</span>
    <span class="grouping">)</span>

<span class="identifier">pairwise_comp_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span>
    <span class="identifier">pairwise_t_test</span><span class="punctuation">,</span>
    <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'model_1', 'model_2', 't_stat', 'p_val'</span><span class="grouping">]</span>
<span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span>
<span class="identifier">pairwise_comp_df</span>

<span class="comment"># %%</span>
<span class="comment"># We observe that after correcting for multiple comparisons, the only model</span>
<span class="comment"># that significantly differs from the others is `'2_poly'`.</span>
<span class="comment"># `'rbf'`, the model ranked first by</span>
<span class="comment"># :class:`~sklearn.model_selection.GridSearchCV`, does not significantly</span>
<span class="comment"># differ from `'linear'` or `'3_poly'`.</span>

<span class="comment"># %%</span>
<span class="comment"># Pairwise comparison of all models: Bayesian approach</span>
<span class="comment"># ----------------------------------------------------</span>
<span class="comment">#</span>
<span class="comment"># When using Bayesian estimation to compare multiple models, we don't need to</span>
<span class="comment"># correct for multiple comparisons (for reasons why see [4]_).</span>
<span class="comment">#</span>
<span class="comment"># We can carry out our pairwise comparisons the same way as in the first</span>
<span class="comment"># section:</span>

<span class="identifier">pairwise_bayesian</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

<span class="keyword">for</span> <span class="identifier">model_i</span><span class="punctuation">,</span> <span class="identifier">model_k</span> <span class="relational-operator">in</span> <span class="identifier">combinations</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">model_scores</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">model_i_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">model_i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">values</span>
    <span class="identifier">model_k_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_scores</span><span class="punctuation">.</span><span class="identifier">iloc</span><span class="grouping">[</span><span class="identifier">model_k</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">values</span>
    <span class="identifier">differences</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_i_scores</span> <span class="arithmetic-operator">-</span> <span class="identifier">model_k_scores</span>
    <span class="identifier">t_post</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t</span><span class="grouping">(</span>
        <span class="identifier">df</span><span class="punctuation">,</span> <span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">differences</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="identifier">corrected_std</span><span class="grouping">(</span><span class="identifier">differences</span><span class="punctuation">,</span> <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="grouping">)</span>
    <span class="grouping">)</span>
    <span class="identifier">worse_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">better_prob</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">rope_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t_post</span><span class="punctuation">.</span><span class="identifier">cdf</span><span class="grouping">(</span><span class="identifier">rope_interval</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">pairwise_bayesian</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">worse_prob</span><span class="punctuation">,</span> <span class="identifier">better_prob</span><span class="punctuation">,</span> <span class="identifier">rope_prob</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">pairwise_bayesian_df</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">pd</span><span class="punctuation">.</span><span class="identifier">DataFrame</span><span class="grouping">(</span>
    <span class="identifier">pairwise_bayesian</span><span class="punctuation">,</span>
    <span class="identifier">columns</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'worse_prob', 'better_prob', 'rope_prob'</span><span class="grouping">]</span>
<span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">round</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">pairwise_comp_df</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_comp_df</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">pairwise_bayesian_df</span><span class="grouping">)</span>
<span class="identifier">pairwise_comp_df</span>

<span class="comment"># %%</span>
<span class="comment"># Using the Bayesian approach we can compute the probability that a model</span>
<span class="comment"># performs better, worse or practically equivalent to another.</span>
<span class="comment">#</span>
<span class="comment"># Results show that the model ranked first by</span>
<span class="comment"># :class:`~sklearn.model_selection.GridSearchCV` `'rbf'`, has approximately a</span>
<span class="comment"># 6.8% chance of being worse than `'linear'`, and a 1.8% chance of being worse</span>
<span class="comment"># than `'3_poly'`.</span>
<span class="comment"># `'rbf'` and `'linear'` have a 43% probability of being practically</span>
<span class="comment"># equivalent, while `'rbf'` and `'3_poly'` have a 10% chance of being so.</span>
<span class="comment">#</span>
<span class="comment"># Similarly to the conclusions obtained using the frequentist approach, all</span>
<span class="comment"># models have a 100% probability of being better than `'2_poly'`, and none have</span>
<span class="comment"># a practically equivalent performance with the latter.</span>

<span class="comment"># %%</span>
<span class="comment"># Take-home messages</span>
<span class="comment"># ------------------</span>
<span class="comment"># - Small differences in performance measures might easily turn out to be</span>
<span class="comment">#   merely by chance, but not because one model predicts systematically better</span>
<span class="comment">#   than the other. As shown in this example, statistics can tell you how</span>
<span class="comment">#   likely that is.</span>
<span class="comment"># - When statistically comparing the performance of two models evaluated in</span>
<span class="comment">#   GridSearchCV, it is necessary to correct the calculated variance which</span>
<span class="comment">#   could be underestimated since the scores of the models are not independent</span>
<span class="comment">#   from each other.</span>
<span class="comment"># - A frequentist approach that uses a (variance-corrected) paired t-test can</span>
<span class="comment">#   tell us if the performance of one model is better than another with a</span>
<span class="comment">#   degree of certainty above chance.</span>
<span class="comment"># - A Bayesian approach can provide the probabilities of one model being</span>
<span class="comment">#   better, worse or practically equivalent than another. It can also tell us</span>
<span class="comment">#   how confident we are of knowing that the true differences of our models</span>
<span class="comment">#   fall under a certain range of values.</span>
<span class="comment"># - If multiple models are statistically compared, a multiple comparisons</span>
<span class="comment">#   correction is needed when using the frequentist approach.</span>

<span class="comment"># %%</span>
<span class="comment"># .. topic:: References</span>
<span class="comment">#</span>
<span class="comment">#    .. [1] Dietterich, T. G. (1998). `Approximate statistical tests for</span>
<span class="comment">#           comparing supervised classification learning algorithms</span>
<span class="comment">#           &lt;http://web.cs.iastate.edu/~jtian/cs573/Papers/Dietterich-98.pdf&gt;`_.</span>
<span class="comment">#           Neural computation, 10(7).</span>
<span class="comment">#    .. [2] Nadeau, C., & Bengio, Y. (2000). `Inference for the generalization</span>
<span class="comment">#           error</span>
<span class="comment">#           &lt;https://papers.nips.cc/paper/1661-inference-for-the-generalization-error.pdf&gt;`_.</span>
<span class="comment">#           In Advances in neural information processing systems.</span>
<span class="comment">#    .. [3] Bouckaert, R. R., & Frank, E. (2004). `Evaluating the replicability</span>
<span class="comment">#           of significance tests for comparing learning algorithms</span>
<span class="comment">#           &lt;https://www.cms.waikato.ac.nz/~ml/publications/2004/bouckaert-frank.pdf&gt;`_.</span>
<span class="comment">#           In Pacific-Asia Conference on Knowledge Discovery and Data Mining.</span>
<span class="comment">#    .. [4] Benavoli, A., Corani, G., Demar, J., & Zaffalon, M. (2017). `Time</span>
<span class="comment">#           for a change: a tutorial for comparing multiple classifiers through</span>
<span class="comment">#           Bayesian analysis</span>
<span class="comment">#           &lt;http://www.jmlr.org/papers/volume18/16-305/16-305.pdf&gt;`_.</span>
<span class="comment">#           The Journal of Machine Learning Research, 18(1). See the Python</span>
<span class="comment">#           library that accompanies this paper `here</span>
<span class="comment">#           &lt;https://github.com/janezd/baycomp&gt;`_.</span>
<span class="comment">#    .. [5] Diebold, F.X. & Mariano R.S. (1995). `Comparing predictive accuracy</span>
<span class="comment">#           &lt;http://www.est.uc3m.es/esp/nueva_docencia/comp_col_get/lade/tecnicas_prediccion/Practicas0708/Comparing%20Predictive%20Accuracy%20(Dielbold).pdf&gt;`_</span>
<span class="comment">#           Journal of Business & economic statistics, 20(1), 134-144.</span>

    </pre>
  </body>
</html>