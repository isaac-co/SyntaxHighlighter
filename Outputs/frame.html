<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" The Faces Viewer Frame and Canvas for Faceswap's Manual Tool. """</span>
<span class="keyword">import</span> <span class="identifier">colorsys</span>
<span class="keyword">import</span> <span class="identifier">gettext</span>
<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">platform</span>
<span class="keyword">import</span> <span class="identifier">tkinter</span> <span class="keyword">as</span> <span class="identifier">tk</span>
<span class="keyword">from</span> <span class="identifier">tkinter</span> <span class="keyword">import</span> <span class="identifier">ttk</span>
<span class="keyword">from</span> <span class="identifier">math</span> <span class="keyword">import</span> <span class="identifier">floor</span><span class="punctuation">,</span> <span class="identifier">ceil</span>
<span class="keyword">from</span> <span class="identifier">threading</span> <span class="keyword">import</span> <span class="identifier">Thread</span><span class="punctuation">,</span> <span class="identifier">Event</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">custom_widgets</span> <span class="keyword">import</span> <span class="identifier">RightClickMenu</span><span class="punctuation">,</span> <span class="identifier">Tooltip</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gui</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">get_config</span><span class="punctuation">,</span> <span class="identifier">get_images</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">hex_to_rgb</span><span class="punctuation">,</span> <span class="identifier">rgb_to_hex</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">viewport</span> <span class="keyword">import</span> <span class="identifier">Viewport</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>

<span class="comment"># LOCALES</span>
<span class="identifier">_LANG</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gettext</span><span class="punctuation">.</span><span class="identifier">translation</span><span class="grouping">(</span><span class="string-literal">"tools.manual", localedir="locales"</span><span class="punctuation">,</span> <span class="identifier">fallback</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_LANG</span><span class="punctuation">.</span><span class="identifier">gettext</span>


<span class="keyword">class</span> <span class="identifier">FacesFrame</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-many-ancestors</span>
    <span class="comment">""" The faces display frame (bottom section of GUI). This frame holds the faces viewport and
    the tkinter objects.

    Parameters
    ----------
    parent: :class:`ttk.PanedWindow`
        The paned window that the faces frame resides in
    tk_globals: :class:`~tools.manual.manual.TkGlobals`
        The tkinter variables that apply to the whole of the GUI
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The :class:`~lib.align.DetectedFace` objects for this video
    display_frame: :class:`~tools.manual.frameviewer.frame.DisplayFrame`
        The section of the Manual Tool that holds the frames viewer
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span> <span class="identifier">display_frame</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (parent: %s, tk_globals: %s, detected_faces: %s, "</span>
                     <span class="string-literal">"display_frame: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span>
                     <span class="identifier">detected_faces</span><span class="punctuation">,</span> <span class="identifier">display_frame</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FacesActionsFrame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">pack_propagate</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Event</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FacesViewer</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">,</span>
                                   <span class="identifier">tk_globals</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions_frame</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="punctuation">,</span>
                                   <span class="identifier">detected_faces</span><span class="punctuation">,</span>
                                   <span class="identifier">display_frame</span><span class="punctuation">,</span>
                                   <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_scrollbar</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_scrollbar</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add a scrollbar to the faces frame """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Add Faces Viewer Scrollbar"</span><span class="grouping">)</span>
        <span class="identifier">scrollbar</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Scrollbar</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_faces_frame</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_on_scroll</span><span class="grouping">)</span>
        <span class="identifier">scrollbar</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">RIGHT</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">yscrollcommand</span><span class="arithmetic-assignment">=</span><span class="identifier">scrollbar</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Configure&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_viewport</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Added Faces Viewer Scrollbar"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update_idletasks</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># Update so scrollbar width is correct</span>
        <span class="keyword">return</span> <span class="identifier">scrollbar</span><span class="punctuation">.</span><span class="identifier">winfo_width</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_on_scroll</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Callback on scrollbar scroll. Updates the canvas location and displays/hides
        thumbnail images.

        Parameters
        ----------
        event :class:`tkinter.Event`
            The scrollbar callback event
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">event</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_viewport</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=unused-argument</span>
        <span class="comment">""" Update the faces viewport and scrollbar.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            Unused but required
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">configure</span><span class="grouping">(</span><span class="identifier">scrollregion</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">(</span><span class="string-literal">"backdrop"</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">canvas_scroll</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">direction</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Scroll the canvas on an up/down or page-up/page-down key press.

        Notes
        -----
        To protect against a held down key press stacking tasks and locking up the GUI
        a background thread is launched and discards subsequent key presses whilst the
        previous update occurs.

        Parameters
        ----------
        direction: ["up", "down", "page-up", "page-down"]
            The request page scroll direction and amount.
        """</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="punctuation">.</span><span class="identifier">is_set</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Update already running. Aborting repeated keypress"</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Running update on received key press: %s"</span><span class="punctuation">,</span> <span class="identifier">direction</span><span class="grouping">)</span>

        <span class="identifier">amount</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">direction</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">"down"</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="identifier">units</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"pages" if direction.startswith("page") else "units"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Thread</span><span class="grouping">(</span><span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">canvas_scroll</span><span class="punctuation">,</span>
                        <span class="identifier">args</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">amount</span><span class="punctuation">,</span> <span class="identifier">units</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">set_annotation_display</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the optional annotation overlay based on keyboard shortcut.

        Parameters
        ----------
        key: str
            The pressed key
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions_frame</span><span class="punctuation">.</span><span class="identifier">on_click</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions_frame</span><span class="punctuation">.</span><span class="identifier">key_bindings</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FacesActionsFrame</span><span class="grouping">(</span><span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-many-ancestors</span>
    <span class="comment">""" The left hand action frame holding the optional annotation buttons.

    Parameters
    ----------
    parent: :class:`FacesFrame`
        The Faces frame that this actions frame reside in
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (parent: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">padx</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">pady</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_configure_styles</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_buttons</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_buttons</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">key_bindings</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The mapping of key presses to optional annotations to display. Keyboard shortcuts
        utilize the function keys. """</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">"F{}".format(idx + 9): display for idx, display in enumerate(("mesh", "mask"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_helptext</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: `button key`: `button helptext`. The help text to display for each button. """</span>
        <span class="identifier">inverse_keybindings</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="identifier">val</span><span class="punctuation">:</span> <span class="identifier">key</span> <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">key_bindings</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">mesh</span><span class="arithmetic-assignment">=</span><span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Display the landmarks mesh"</span><span class="grouping">)</span><span class="punctuation">,</span>
                      <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Display the mask"</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">item</span> <span class="relational-operator">in</span> <span class="identifier">retval</span><span class="punctuation">:</span>
            <span class="identifier">retval</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">" ({})"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">inverse_keybindings</span><span class="grouping">[</span><span class="identifier">item</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_configure_styles</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Configure the background color for button frame and the button styles. """</span>
        <span class="identifier">style</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Style</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">style</span><span class="punctuation">.</span><span class="identifier">configure</span><span class="grouping">(</span><span class="string-literal">"display.TFrame"</span><span class="punctuation">,</span> <span class="identifier">background</span><span class="arithmetic-assignment">=</span><span class="string-literal">'#d3d3d3'</span><span class="grouping">)</span>
        <span class="identifier">style</span><span class="punctuation">.</span><span class="identifier">configure</span><span class="grouping">(</span><span class="string-literal">"display_selected.TButton", relief="flat", background="#bedaf1"</span><span class="grouping">)</span>
        <span class="identifier">style</span><span class="punctuation">.</span><span class="identifier">configure</span><span class="grouping">(</span><span class="string-literal">"display_deselected.TButton", relief="flat"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">style</span><span class="arithmetic-assignment">=</span><span class="string-literal">"display.TFrame"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_buttons</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add the display buttons to the Faces window.

        Returns
        -------
        dict
            The display name and its associated button.
        """</span>
        <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">frame</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">TOP</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Y</span><span class="grouping">)</span>
        <span class="identifier">buttons</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">display</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">key_bindings</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BooleanVar</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="identifier">display</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var</span>

            <span class="identifier">lookup</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"landmarks" if display == "mesh"</span> <span class="keyword">else</span> <span class="identifier">display</span>
            <span class="identifier">button</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ttk</span><span class="punctuation">.</span><span class="identifier">Button</span><span class="grouping">(</span><span class="identifier">frame</span><span class="punctuation">,</span>
                                <span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">get_images</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">icons</span><span class="grouping">[</span><span class="identifier">lookup</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">command</span><span class="arithmetic-assignment">=</span><span class="keyword">lambda</span> <span class="identifier">t</span><span class="arithmetic-assignment">=</span><span class="identifier">display</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">on_click</span><span class="grouping">(</span><span class="identifier">t</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">style</span><span class="arithmetic-assignment">=</span><span class="string-literal">"display_deselected.TButton"</span><span class="grouping">)</span>
            <span class="identifier">button</span><span class="punctuation">.</span><span class="identifier">state</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"!pressed", "!focus"</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">button</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">Tooltip</span><span class="grouping">(</span><span class="identifier">button</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_helptext</span><span class="grouping">[</span><span class="identifier">display</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">buttons</span><span class="grouping">[</span><span class="identifier">display</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">button</span>
        <span class="keyword">return</span> <span class="identifier">buttons</span>

    <span class="keyword">def</span> <span class="identifier">on_click</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">display</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Click event for the optional annotation buttons. Loads and unloads the annotations from
        the faces viewer.

        Parameters
        ----------
        display: str
            The display name for the button that has called this event as exists in
            :attr:`_buttons`
        """</span>
        <span class="identifier">is_pressed</span> <span class="arithmetic-assignment">=</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="identifier">display</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">style</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"display_selected.TButton" if is_pressed else "display_deselected.TButton"</span>
        <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"pressed", "focus"] if is_pressed else ["!pressed", "!focus"</span><span class="grouping">]</span>
        <span class="identifier">btn</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_buttons</span><span class="grouping">[</span><span class="identifier">display</span><span class="grouping">]</span>
        <span class="identifier">btn</span><span class="punctuation">.</span><span class="identifier">configure</span><span class="grouping">(</span><span class="identifier">style</span><span class="arithmetic-assignment">=</span><span class="identifier">style</span><span class="grouping">)</span>
        <span class="identifier">btn</span><span class="punctuation">.</span><span class="identifier">state</span><span class="grouping">(</span><span class="identifier">state</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_vars</span><span class="grouping">[</span><span class="identifier">display</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">is_pressed</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">FacesViewer</span><span class="grouping">(</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">Canvas</span><span class="grouping">)</span><span class="punctuation">:</span>   <span class="comment"># pylint:disable=too-many-ancestors</span>
    <span class="comment">""" The :class:`tkinter.Canvas` that holds the faces viewer section of the Manual Tool.

    Parameters
    ----------
    parent: :class:`tkinter.ttk.Frame`
        The parent frame for the canvas
    tk_globals: :class:`~tools.manual.manual.TkGlobals`
        The tkinter variables that apply to the whole of the GUI
    tk_action_vars: dict
        The :class:`tkinter.BooleanVar` objects for selectable optional annotations
        as set by the buttons in the :class:`FacesActionsFrame`
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The :class:`~lib.align.DetectedFace` objects for this video
    display_frame: :class:`~tools.manual.frameviewer.frame.DisplayFrame`
        The section of the Manual Tool that holds the frames viewer
    event: :class:`threading.Event`
        The threading event object for repeated key press protection
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">tk_action_vars</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span> <span class="identifier">display_frame</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (parent: %s, tk_globals: %s, tk_action_vars: %s, "</span>
                     <span class="string-literal">"detected_faces: %s, display_frame: %s, event: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span>
                     <span class="identifier">parent</span><span class="punctuation">,</span> <span class="identifier">tk_globals</span><span class="punctuation">,</span> <span class="identifier">tk_action_vars</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span> <span class="identifier">display_frame</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">parent</span><span class="punctuation">,</span>
                         <span class="identifier">bd</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                         <span class="identifier">highlightthickness</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                         <span class="identifier">bg</span><span class="arithmetic-assignment">=</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">user_theme</span><span class="grouping">[</span><span class="string-literal">"group_panel"]["panel_background"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pack</span><span class="grouping">(</span><span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">LEFT</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">BOTH</span><span class="punctuation">,</span> <span class="identifier">expand</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">E</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sizes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">tiny</span><span class="arithmetic-assignment">=</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="identifier">small</span><span class="arithmetic-assignment">=</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="identifier">medium</span><span class="arithmetic-assignment">=</span><span class="int-literal">96</span><span class="punctuation">,</span> <span class="identifier">large</span><span class="arithmetic-assignment">=</span><span class="int-literal">128</span><span class="punctuation">,</span> <span class="identifier">extralarge</span><span class="arithmetic-assignment">=</span><span class="int-literal">192</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_globals</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_optional_annotations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tk_action_vars</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">display_frame</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Grid</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Viewport</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">.</span><span class="identifier">tk_edited</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_colors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">mesh</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_muted_color</span><span class="grouping">(</span><span class="string-literal">"Mesh"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                       <span class="identifier">box</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">control_colors</span><span class="grouping">[</span><span class="string-literal">"ExtractBox"</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">ContextMenu</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_bind_mouse_wheel_scrolling</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_tk_callbacks</span><span class="grouping">(</span><span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">face_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The currently selected thumbnail size in pixels """</span>
        <span class="identifier">scaling</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">scaling_factor</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sizes</span><span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_faces_size</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">" ", ""</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">*</span> <span class="identifier">scaling</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">viewport</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`~tools.manual.faceviewer.viewport.Viewport`: The viewport area of the
        faces viewer. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">grid</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :class:`Grid`: The grid for the current :class:`FacesViewer`. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">optional_annotations</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" dict: The values currently set for the selectable optional annotations. """</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="identifier">opt</span><span class="punctuation">:</span> <span class="identifier">val</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">opt</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_optional_annotations</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">selected_mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" str: The currently selected mask from the display frame control panel. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_selected_mask</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">control_colors</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" :dict: The frame Editor name as key with the current user selected hex code as
        value. """</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="grouping">{</span><span class="identifier">key</span><span class="punctuation">:</span> <span class="identifier">val</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_control_colors</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; CALLBACK FUNCTIONS &gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">_set_tk_callbacks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the tkinter variable call backs.

        Redraw the grid on a face size change, a filter change or on add/remove faces.
        Updates the annotation colors when user amends a color drop down.
        Updates the mask type when the user changes the selected mask types
        Toggles the face viewer annotations on an optional annotation button press.
        """</span>
        <span class="keyword">for</span> <span class="identifier">var</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_faces_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_filter_mode</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="arithmetic-assignment">=</span><span class="identifier">var</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">refresh_grid</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_faces</span><span class="punctuation">.</span><span class="identifier">tk_face_count_changed</span>
        <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="arithmetic-assignment">=</span><span class="identifier">var</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">refresh_grid</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">retain_position</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_control_colors</span><span class="grouping">[</span><span class="string-literal">"Mesh"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span>
            <span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_mesh_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_control_colors</span><span class="grouping">[</span><span class="string-literal">"ExtractBox"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span>
            <span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_box_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_frame</span><span class="punctuation">.</span><span class="identifier">tk_selected_mask</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_mask_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">opt</span><span class="punctuation">,</span> <span class="identifier">var</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_optional_annotations</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">o</span><span class="arithmetic-assignment">=</span><span class="identifier">opt</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_toggle_annotations</span><span class="grouping">(</span><span class="identifier">o</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Configure&gt;"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">refresh_grid</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">trigger_var</span><span class="punctuation">,</span> <span class="identifier">retain_position</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Recalculate the full grid and redraw. Used when the active filter pull down is used, a
        face has been added or removed, or the face thumbnail size has changed.

        Parameters
        ----------
        trigger_var: :class:`tkinter.BooleanVar`
            The tkinter variable that has triggered the grid update. Will either be the variable
            indicating that the face size have been changed, or the variable indicating that the
            selected filter mode has been changed.
        retain_position: bool, optional
            ``True`` if the grid should be set back to the position it was at after the update has
            been processed, otherwise ``False``. Default: ``False``.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">trigger_var</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">size_change</span> <span class="arithmetic-assignment">=</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">trigger_var</span><span class="punctuation">,</span> <span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">StringVar</span><span class="grouping">)</span>
        <span class="identifier">move_to</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">yview</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">retain_position</span> <span class="keyword">else</span> <span class="float-literal">0.0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">move_to</span> <span class="relational-operator">!=</span> <span class="float-literal">0.0</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">yview_moveto</span><span class="grouping">(</span><span class="identifier">move_to</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">size_change</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">reset</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="identifier">refresh_annotations</span><span class="arithmetic-assignment">=</span><span class="identifier">retain_position</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">size_change</span><span class="punctuation">:</span>
            <span class="identifier">trigger_var</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_mask_type</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the displayed mask in the :class:`FacesViewer` canvas when the user changes
        the mask type. """</span>
        <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"normal" if self.optional_annotations["mask"] else "hidden"</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Updating mask type: (mask_type: %s. state: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">selected_mask</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">toggle_mask</span><span class="grouping">(</span><span class="identifier">state</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">selected_mask</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; MOUSE HANDLING &gt;&gt;</span>
    <span class="keyword">def</span> <span class="identifier">_bind_mouse_wheel_scrolling</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Bind mouse wheel to scroll the :class:`FacesViewer` canvas. """</span>
        <span class="keyword">if</span> <span class="identifier">platform</span><span class="punctuation">.</span><span class="identifier">system</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"Linux"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Button-4&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scroll</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Button-5&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scroll</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;MouseWheel&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scroll</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_scroll</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Handle mouse wheel scrolling over the :class:`FacesViewer` canvas.

        Update is run in a thread to avoid repeated scroll actions stacking and locking up the GUI.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The event fired by the mouse scrolling
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="punctuation">.</span><span class="identifier">is_set</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Update already running. Aborting repeated mousewheel"</span><span class="grouping">)</span>
            <span class="keyword">return</span>
        <span class="keyword">if</span> <span class="identifier">platform</span><span class="punctuation">.</span><span class="identifier">system</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"Darwin"</span><span class="punctuation">:</span>
            <span class="identifier">adjust</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span>
        <span class="keyword">elif</span> <span class="identifier">platform</span><span class="punctuation">.</span><span class="identifier">system</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"Windows"</span><span class="punctuation">:</span>
            <span class="identifier">adjust</span> <span class="arithmetic-assignment">=</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="arithmetic-operator">/</span> <span class="int-literal">120</span>
        <span class="keyword">elif</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">num</span> <span class="relational-operator">==</span> <span class="int-literal">5</span><span class="punctuation">:</span>
            <span class="identifier">adjust</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">adjust</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Thread</span><span class="grouping">(</span><span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">canvas_scroll</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">adjust</span><span class="punctuation">,</span> <span class="string-literal">"units"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_event</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">thread</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">canvas_scroll</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">amount</span><span class="punctuation">,</span> <span class="identifier">units</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Scroll the canvas on an up/down or page-up/page-down key press.

        Parameters
        ----------
        amount: int
            The number of units to scroll the canvas
        units: ["page", "units"]
            The unit type to scroll by
        event: :class:`threading.Event`
            event to indicate to the calling process whether the scroll is still updating
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">yview_scroll</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">amount</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">units</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">hover_box</span><span class="punctuation">.</span><span class="identifier">on_hover</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">clear</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; OPTIONAL ANNOTATION METHODS &gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">_update_mesh_color</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the mesh color when user updates the control panel. """</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_muted_color</span><span class="grouping">(</span><span class="string-literal">"Mesh"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_colors</span><span class="grouping">[</span><span class="string-literal">"mesh"</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">color</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">highlight_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">control_colors</span><span class="grouping">[</span><span class="string-literal">"Mesh"</span><span class="grouping">]</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"viewport_polygon"</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"viewport_line"</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"active_mesh_polygon"</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">highlight_color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"active_mesh_line"</span><span class="punctuation">,</span> <span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">highlight_color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_colors</span><span class="grouping">[</span><span class="string-literal">"mesh"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">color</span>

    <span class="keyword">def</span> <span class="identifier">_update_box_color</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the active box color when user updates the control panel. """</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">control_colors</span><span class="grouping">[</span><span class="string-literal">"ExtractBox"</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_colors</span><span class="grouping">[</span><span class="string-literal">"box"</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">color</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"active_highlighter"</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_colors</span><span class="grouping">[</span><span class="string-literal">"box"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">color</span>

    <span class="keyword">def</span> <span class="identifier">get_muted_color</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">color_key</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Creates a muted version of the given annotation color for non-active faces.

        Parameters
        ----------
        color_key: str
            The annotation key to obtain the color for from :attr:`control_colors`
        """</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.65</span>
        <span class="identifier">hls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">colorsys</span><span class="punctuation">.</span><span class="identifier">rgb_to_hls</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">hex_to_rgb</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">control_colors</span><span class="grouping">[</span><span class="identifier">color_key</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">scale</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">hls</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">120</span> <span class="keyword">else</span> <span class="identifier">scale</span>
        <span class="identifier">hls</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">scale</span> <span class="arithmetic-operator">*</span> <span class="identifier">hls</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">rgb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">colorsys</span><span class="punctuation">.</span><span class="identifier">hls_to_rgb</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">hls</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"uint8"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rgb_to_hex</span><span class="grouping">(</span><span class="identifier">rgb</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">_toggle_annotations</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">annotation</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Toggle optional annotations on or off after the user depresses an optional button.

        Parameters
        ----------
        annotation: ["mesh", "mask"]
            The optional annotation to toggle on or off
        """</span>
        <span class="identifier">state</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"normal" if self.optional_annotations[annotation] else "hidden"</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Toggle annotation: (annotation: %s, state: %s)"</span><span class="punctuation">,</span> <span class="identifier">annotation</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">annotation</span> <span class="relational-operator">==</span> <span class="string-literal">"mesh"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">toggle_mesh</span><span class="grouping">(</span><span class="identifier">state</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">annotation</span> <span class="relational-operator">==</span> <span class="string-literal">"mask"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_view</span><span class="punctuation">.</span><span class="identifier">toggle_mask</span><span class="grouping">(</span><span class="identifier">state</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">selected_mask</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">Grid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Holds information on the current filtered grid layout.

    The grid keeps information on frame indices, face indices, x and y positions and detected face
    objects laid out in a numpy array to reflect the current full layout of faces within the face
    viewer based on the currently selected filter and face thumbnail size.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The :class:`~tools.manual.faceviewer.frame.FacesViewer` canvas
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The :class:`~lib.align.DetectedFace` objects for this video
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (detected_faces: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">canvas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_faces</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_faces</span><span class="punctuation">.</span><span class="identifier">filter</span><span class="punctuation">.</span><span class="identifier">raw_indices</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_faces</span><span class="punctuation">.</span><span class="identifier">filter</span><span class="punctuation">.</span><span class="identifier">frames_list</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_faces</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">update_idletasks</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_rectangle</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tags</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"backdrop"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">face_size</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The pixel size of each thumbnail within the face viewer. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">is_valid</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" bool: ``True`` if the current filter means that the grid holds faces. ``False`` if
        there are no faces displayed in the grid. """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">columns_rows</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" tuple: the (`columns`, `rows`) required to hold all display images. """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">reversed</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span> <span class="keyword">else</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">dimensions</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" tuple: The (`width`, `height`) required to hold all display images. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">dim</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span> <span class="keyword">for</span> <span class="identifier">dim</span> <span class="relational-operator">in</span> <span class="identifier">reversed</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_visible_row_indices</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""tuple: A 1 dimensional array of the (`top_row_index`, `bottom_row_index`) of the grid
        currently in the viewable area.
        """</span>
        <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dimensions</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">visible</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">floor</span><span class="grouping">(</span><span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"visible: %s"</span><span class="punctuation">,</span> <span class="identifier">visible</span><span class="grouping">)</span>
        <span class="identifier">y_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">top</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">y_points</span><span class="punctuation">,</span> <span class="identifier">visible</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="string-literal">"left"</span><span class="grouping">)</span>
        <span class="identifier">bottom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">y_points</span><span class="punctuation">,</span> <span class="identifier">visible</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">side</span><span class="arithmetic-assignment">=</span><span class="string-literal">"right"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">top</span><span class="punctuation">,</span> <span class="identifier">bottom</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">visible_area</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""":class:`numpy.ndarray`:  A numpy array of shape (`4`, `rows`, `columns`) corresponding
        to the viewable area of the display grid. 1st dimension contains frame indices, 2nd
        dimension face indices. The 3rd and 4th dimension contain the x and y position of the top
        left corner of the face respectively.

        Any locations that are not populated by a face will have a frame and face index of -1
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span><span class="punctuation">:</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">top</span><span class="punctuation">,</span> <span class="identifier">bottom</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_visible_row_indices</span>
            <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">top</span><span class="punctuation">:</span><span class="identifier">bottom</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_faces</span><span class="grouping">[</span><span class="identifier">top</span><span class="punctuation">:</span><span class="identifier">bottom</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">r</span> <span class="keyword">if</span> <span class="identifier">r</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">r</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">for</span> <span class="identifier">r</span> <span class="relational-operator">in</span> <span class="identifier">retval</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">y_coord_from_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the y coordinate for the first face that appears in the given frame.

        Parameters
        ----------
        frame_index: int
            The frame index to locate in the grid

        Returns
        -------
        int
            The y coordinate of the first face for the given frame
        """</span>
        <span class="keyword">return</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">frame_index</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">frame_has_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether the given frame index contains any faces.

        Parameters
        ----------
        frame_index: int
            The frame index to locate in the grid

        Returns
        -------
        bool
            ``True`` if there are faces in the given frame otherwise ``False``
        """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span> <span class="logical-operator">and</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">frame_index</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the underlying grid.

        Called on initialization, on a filter change or on add/remove faces. Recalculates the
        underlying grid for the current filter view and updates the attributes :attr:`_grid`,
        :attr:`_display_faces`, :attr:`_raw_indices`, :attr:`_frames_list` and :attr:`is_valid`
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">face_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">filter</span><span class="punctuation">.</span><span class="identifier">raw_indices</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames_list</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">filter</span><span class="punctuation">.</span><span class="identifier">frames_list</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_grid</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_display_faces</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="string-literal">"backdrop"</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dimensions</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">configure</span><span class="grouping">(</span><span class="identifier">scrollregion</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bbox</span><span class="grouping">(</span><span class="string-literal">"backdrop"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">yview_moveto</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_grid</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the grid information for faces currently displayed in the :class:`FacesViewer`.

        Returns
        :class:`numpy.ndarray`
            A numpy array of shape (`4`, `rows`, `columns`) corresponding to the display grid.
            1st dimension contains frame indices, 2nd dimension face indices. The 3rd and 4th
            dimension contain the x and y position of the top left corner of the face respectively.

            Any locations that are not populated by a face will have a frame and face index of -1
        """</span>
        <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_labels</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting grid to None for no faces."</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">return</span>
        <span class="identifier">x_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">labels</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span><span class="punctuation">,</span>
                               <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="identifier">labels</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">endpoint</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"int"</span><span class="grouping">)</span>
        <span class="identifier">y_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span>
                               <span class="identifier">labels</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span><span class="punctuation">,</span>
                               <span class="identifier">num</span><span class="arithmetic-assignment">=</span><span class="identifier">labels</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">endpoint</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                               <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"int"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">labels</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">meshgrid</span><span class="grouping">(</span><span class="identifier">x_coords</span><span class="punctuation">,</span> <span class="identifier">y_coords</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"int"</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_grid</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_labels</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the frame and face index for each grid position for the current filter.

        Returns
        -------
        :class:`numpy.ndarray`
            Array of dimensions (2, rows, columns) corresponding to the display grid, with frame
            index as the first dimension and face index within the frame as the 2nd dimension.

            Any remaining placeholders at the end of the grid which are not populated with a face
            are given the index -1
        """</span>
        <span class="identifier">face_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span><span class="grouping">[</span><span class="string-literal">"frame"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_count</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="none-literal">None</span>
        <span class="identifier">columns</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">winfo_width</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_size</span>
        <span class="identifier">rows</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ceil</span><span class="grouping">(</span><span class="identifier">face_count</span> <span class="arithmetic-operator">/</span> <span class="identifier">columns</span><span class="grouping">)</span>
        <span class="identifier">remainder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_count</span> <span class="arithmetic-operator">%</span> <span class="identifier">columns</span>
        <span class="identifier">padding</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">remainder</span> <span class="relational-operator">==</span> <span class="int-literal">0</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">columns</span> <span class="arithmetic-operator">-</span> <span class="identifier">remainder</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span><span class="grouping">[</span><span class="string-literal">"frame"</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding</span><span class="punctuation">,</span>
                           <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span><span class="grouping">[</span><span class="string-literal">"face"</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"int"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">columns</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"face-count: %s, columns: %s, rows: %s, remainder: %s, padding: %s, labels "</span>
                     <span class="string-literal">"shape: %s"</span><span class="punctuation">,</span> <span class="identifier">face_count</span><span class="punctuation">,</span> <span class="identifier">columns</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">remainder</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="punctuation">,</span> <span class="identifier">labels</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">labels</span>

    <span class="keyword">def</span> <span class="identifier">_get_display_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the detected faces for the current filter and arrange to grid.

        Returns
        -------
        :class:`numpy.ndarray`
            Array of dimensions (rows, columns) corresponding to the display grid, containing the
            corresponding :class:`lib.align.DetectFace` object

            Any remaining placeholders at the end of the grid which are not populated with a face
            are replaced with ``None``
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_is_valid</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting display_faces to None for no faces."</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_faces</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">return</span>
        <span class="identifier">current_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">current_faces</span>
        <span class="identifier">columns</span><span class="punctuation">,</span> <span class="identifier">rows</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">columns_rows</span>
        <span class="identifier">face_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span><span class="grouping">[</span><span class="string-literal">"frame"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">padding</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="none-literal">None</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">face_count</span><span class="punctuation">,</span> <span class="identifier">columns</span> <span class="arithmetic-operator">*</span> <span class="identifier">rows</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="none-literal">None</span> <span class="keyword">if</span> <span class="identifier">idx</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">current_faces</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_idx</span><span class="grouping">]</span>
                                        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span>
                                        <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span><span class="grouping">[</span><span class="string-literal">"frame"</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding</span><span class="punctuation">,</span>
                                               <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_raw_indices</span><span class="grouping">[</span><span class="string-literal">"face"</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">padding</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                                       <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"object"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">columns</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"faces: (shape: %s, dtype: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_faces</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_display_faces</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">transport_index_from_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the main frame's transport index for the given frame index based on the current
        filter criteria.

        Parameters
        ----------
        frame_index: int
            The absolute index for the frame within the full frames list

        Returns
        -------
        int
            The index of the requested frame within the filtered frames view.
        """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames_list</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="identifier">frame_index</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">frame_index</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frames_list</span> <span class="keyword">else</span> <span class="none-literal">None</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"frame_index: %s, transport_index: %s"</span><span class="punctuation">,</span> <span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>


<span class="keyword">class</span> <span class="identifier">ContextMenu</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">"""  Enables a right click context menu for the
    :class:`~tools.manual.faceviewer.frame.FacesViewer`.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The :class:`FacesViewer` canvas
    detected_faces: :class:`~tools.manual.detected_faces`
        The manual tool's detected faces class
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s (canvas: %s, detected_faces: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">canvas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detected_faces</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_menu</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RightClickMenu</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"Delete Face"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_delete_face</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Button-2&gt;" if platform.system() == "Darwin" else "&lt;Button-3&gt;"</span><span class="punctuation">,</span>
                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pop_menu</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_pop_menu</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Pop up the context menu on a right click mouse event.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The mouse event that has triggered the pop up menu
        """</span>
        <span class="identifier">frame_idx</span><span class="punctuation">,</span> <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">viewport</span><span class="punctuation">.</span><span class="identifier">face_from_point</span><span class="grouping">(</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">canvasx</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">canvasy</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">frame_idx</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"No valid item under mouse"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">frame_idx</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_idx</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Popping right click menu"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_menu</span><span class="punctuation">.</span><span class="identifier">popup</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_delete_face</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Delete the selected face on a right click mouse delete action. """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Right click delete received. frame_id: %s, face_id: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_detected_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_frame_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_index</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

    </pre>
  </body>
</html>