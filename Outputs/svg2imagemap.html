<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/local/bin/python</span>

<span class="comment">"""
This script converts a subset of SVG into an HTML imagemap

Note *subset*.  It only handles &lt;path&gt; elements, for which it only pays
attention to the M and L commands.  Further, it only notices the "translate"
transform.

It was written to generate the examples in the documentation for maphilight,
and thus is very squarely aimed at handling several SVG maps from wikipedia.
It *assumes* that all the &lt;path&gt;s it will need are inside a &lt;g&gt;.  Any &lt;path&gt;
outside of a &lt;g&gt; will be ignored.

It takes several possible arguments, in the form:
$ svn2imagemap.py FILENAME [x y [group1 group2 ... groupN]]

FILENAME must be the name of an SVG file.  All other arguments are optional.

x and y, if present, are the dimensions of the image you'll be creating from
the SVG.  If not present, it assumes the values of the width and height
attributes in the SVG file.

group1 through groupN are group ids.  If only want particular groups used,
enter their ids here and all others will be ignored.
"""</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">re</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">xml</span><span class="punctuation">.</span><span class="identifier">dom</span><span class="punctuation">.</span><span class="identifier">minidom</span>

<span class="keyword">import</span> <span class="identifier">parse_path</span>

<span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
    <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="string-literal">"svn2imagemap.py FILENAME [x y [group1 group2 ... groupN]]"</span><span class="grouping">)</span>
<span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="string-literal">"Input file does not exist"</span><span class="grouping">)</span>
<span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">groups</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span>
<span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">3</span><span class="punctuation">:</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">3</span><span class="punctuation">:</span>
        <span class="identifier">groups</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span>

<span class="identifier">svg_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">xml</span><span class="punctuation">.</span><span class="identifier">dom</span><span class="punctuation">.</span><span class="identifier">minidom</span><span class="punctuation">.</span><span class="identifier">parse</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">svg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svg_file</span><span class="punctuation">.</span><span class="identifier">getElementsByTagName</span><span class="grouping">(</span><span class="string-literal">'svg'</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

<span class="identifier">raw_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">svg</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'width'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">raw_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">svg</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'height'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">width_ratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x</span> <span class="logical-operator">and</span> <span class="grouping">(</span><span class="identifier">x</span> <span class="arithmetic-operator">/</span> <span class="identifier">raw_width</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="int-literal">1</span>
<span class="identifier">height_ratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="logical-operator">and</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">/</span> <span class="identifier">raw_height</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="int-literal">1</span>

<span class="keyword">if</span> <span class="identifier">groups</span><span class="punctuation">:</span>
    <span class="identifier">elements</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">g</span> <span class="keyword">for</span> <span class="identifier">g</span> <span class="relational-operator">in</span> <span class="identifier">svg</span><span class="punctuation">.</span><span class="identifier">getElementsByTagName</span><span class="grouping">(</span><span class="string-literal">'g') if (g.hasAttribute('id') and g.getAttribute('id'</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">groups</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">elements</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">p</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">svg</span><span class="punctuation">.</span><span class="identifier">getElementsByTagName</span><span class="grouping">(</span><span class="string-literal">'path') if (p.hasAttribute('id') and p.getAttribute('id'</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">groups</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="identifier">elements</span> <span class="arithmetic-assignment">=</span> <span class="identifier">svg</span><span class="punctuation">.</span><span class="identifier">getElementsByTagName</span><span class="grouping">(</span><span class="string-literal">'g'</span><span class="grouping">)</span>

<span class="identifier">parsed_groups</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="grouping">}</span>
<span class="keyword">for</span> <span class="identifier">e</span> <span class="relational-operator">in</span> <span class="identifier">elements</span><span class="punctuation">:</span>
    <span class="identifier">paths</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">nodeName</span> <span class="relational-operator">==</span> <span class="string-literal">'g'</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">path</span> <span class="relational-operator">in</span> <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">getElementsByTagName</span><span class="grouping">(</span><span class="string-literal">'path'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parse_path</span><span class="punctuation">.</span><span class="identifier">get_points</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'d'</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">pointset</span> <span class="relational-operator">in</span> <span class="identifier">points</span><span class="punctuation">:</span>
                <span class="identifier">paths</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'id'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">pointset</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parse_path</span><span class="punctuation">.</span><span class="identifier">get_points</span><span class="grouping">(</span><span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'d'</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">pointset</span> <span class="relational-operator">in</span> <span class="identifier">points</span><span class="punctuation">:</span>
            <span class="identifier">paths</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'id'</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">pointset</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">hasAttribute</span><span class="grouping">(</span><span class="string-literal">'transform'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'id'), e.getAttribute('transform'</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">transform</span> <span class="relational-operator">in</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">findall</span><span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">'(\w+)\((-?\d+.?\d*),(-?\d+.?\d*)\)', e.getAttribute('transform'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">transform</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="string-literal">'translate'</span><span class="punctuation">:</span>
                <span class="identifier">x_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">transform</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">y_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">transform</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="keyword">for</span> <span class="identifier">path</span> <span class="relational-operator">in</span> <span class="identifier">paths</span><span class="punctuation">:</span>
                    <span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">x_shift</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_shift</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">parsed_groups</span><span class="grouping">[</span><span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">getAttribute</span><span class="grouping">(</span><span class="string-literal">'id'</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">paths</span>

<span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="keyword">for</span> <span class="identifier">g</span> <span class="relational-operator">in</span> <span class="identifier">parsed_groups</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="identifier">path</span> <span class="relational-operator">in</span> <span class="identifier">parsed_groups</span><span class="grouping">[</span><span class="identifier">g</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">out</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="string-literal">'&lt;area href="#" title="%s" shape="poly" coords="%s"&gt;&lt;/area&gt;'</span> <span class="arithmetic-operator">%</span>
            <span class="grouping">(</span><span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="string-literal">', '</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"%d,%d"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="arithmetic-operator">*</span><span class="identifier">width_ratio</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="arithmetic-operator">*</span><span class="identifier">height_ratio</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">outfile</span> <span class="arithmetic-assignment">=</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'.svg', '.html'), 'w'</span><span class="grouping">)</span>
<span class="identifier">outfile</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">'\n'</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>