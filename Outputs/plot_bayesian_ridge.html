<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
=========================
Bayesian Ridge Regression
=========================

Computes a Bayesian Ridge Regression on a synthetic dataset.

See :ref:`bayesian_ridge_regression` for more information on the regressor.

Compared to the OLS (ordinary least squares) estimator, the coefficient
weights are slightly shifted toward zeros, which stabilises them.

As the prior on the weights is a Gaussian prior, the histogram of the
estimated weights is Gaussian.

The estimation of the model is done by iteratively maximizing the
marginal log-likelihood of the observations.

We also plot predictions and uncertainties for Bayesian Ridge Regression
for one dimensional regression using polynomial feature expansion.
Note the uncertainty starts going up on the right side of the plot.
This is because these test samples are outside of the range of the training
samples.
"""</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">stats</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">BayesianRidge</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Generating simulated data with Gaussian weights</span>
<span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">seed</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>  <span class="comment"># Create Gaussian data</span>
<span class="comment"># Create weights with a precision lambda_ of 4.</span>
<span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span><span class="punctuation">.</span>
<span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
<span class="comment"># Only keep 10 weights of interest</span>
<span class="identifier">relevant_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">relevant_features</span><span class="punctuation">:</span>
    <span class="identifier">w</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stats</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="punctuation">.</span><span class="identifier">rvs</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="comment"># Create noise with a precision alpha of 50.</span>
<span class="identifier">alpha_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span><span class="punctuation">.</span>
<span class="identifier">noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stats</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="punctuation">.</span><span class="identifier">rvs</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span>
<span class="comment"># Create the target</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">noise</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Fit the Bayesian Ridge Regression and an OLS for comparison</span>
<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

<span class="identifier">ols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">ols</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

<span class="comment"># #############################################################################</span>
<span class="comment"># Plot true weights, estimated weights, histogram of the weights, and</span>
<span class="comment"># predictions with standard deviations</span>
<span class="identifier">lw</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Weights of the model"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lightgreen'</span><span class="punctuation">,</span> <span class="identifier">linewidth</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="punctuation">,</span>
         <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Bayesian Ridge estimate"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'gold'</span><span class="punctuation">,</span> <span class="identifier">linewidth</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Ground truth"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">ols</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'navy', linestyle='--'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"OLS estimate"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Features"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Values of the weights"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"best"</span><span class="punctuation">,</span> <span class="identifier">prop</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="int-literal">12</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Histogram of the weights"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">hist</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'gold'</span><span class="punctuation">,</span> <span class="identifier">log</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
         <span class="identifier">edgecolor</span><span class="arithmetic-assignment">=</span><span class="string-literal">'black'</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">scatter</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">[</span><span class="identifier">relevant_features</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">relevant_features</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'navy'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Relevant features"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Features"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Values of the weights"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"upper left"</span><span class="grouping">)</span>

<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="string-literal">"Marginal log-likelihood"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'navy'</span><span class="punctuation">,</span> <span class="identifier">linewidth</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Score"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Iterations"</span><span class="grouping">)</span>


<span class="comment"># Plotting some predictions for polynomial regression</span>
<span class="keyword">def</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">noise_amount</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
    <span class="identifier">noise</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">noise_amount</span> <span class="arithmetic-operator">*</span> <span class="identifier">noise</span>


<span class="identifier">degree</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">noise_amount</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
<span class="identifier">clf_poly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">clf_poly</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vander</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

<span class="identifier">X_plot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">25</span><span class="grouping">)</span>
<span class="identifier">y_plot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X_plot</span><span class="punctuation">,</span> <span class="identifier">noise_amount</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_poly</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vander</span><span class="grouping">(</span><span class="identifier">X_plot</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">errorbar</span><span class="grouping">(</span><span class="identifier">X_plot</span><span class="punctuation">,</span> <span class="identifier">y_mean</span><span class="punctuation">,</span> <span class="identifier">y_std</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'navy'</span><span class="punctuation">,</span>
             <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Polynomial Bayesian Ridge Regression"</span><span class="punctuation">,</span> <span class="identifier">linewidth</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">X_plot</span><span class="punctuation">,</span> <span class="identifier">y_plot</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="string-literal">'gold'</span><span class="punctuation">,</span> <span class="identifier">linewidth</span><span class="arithmetic-assignment">=</span><span class="identifier">lw</span><span class="punctuation">,</span>
         <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Ground Truth"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"Output y"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"Feature X"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lower left"</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>