<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Testing for the bagging ensemble module (sklearn.ensemble.bagging).
"""</span>

<span class="comment"># Author: Gilles Louppe</span>
<span class="comment"># License: BSD 3 clause</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">joblib</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyClassifier</span><span class="punctuation">,</span> <span class="identifier">DummyRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">GridSearchCV</span><span class="punctuation">,</span> <span class="identifier">ParameterGrid</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">BaggingClassifier</span><span class="punctuation">,</span> <span class="identifier">BaggingRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Perceptron</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">neighbors</span> <span class="keyword">import</span> <span class="identifier">KNeighborsClassifier</span><span class="punctuation">,</span> <span class="identifier">KNeighborsRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeClassifier</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span><span class="punctuation">,</span> <span class="identifier">SVR</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">random_projection</span> <span class="keyword">import</span> <span class="identifier">SparseRandomProjection</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_selection</span> <span class="keyword">import</span> <span class="identifier">SelectKBest</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_diabetes</span><span class="punctuation">,</span> <span class="identifier">load_iris</span><span class="punctuation">,</span> <span class="identifier">make_hastie_10_2</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">FunctionTransformer</span><span class="punctuation">,</span> <span class="identifier">scale</span>

<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span>

<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

<span class="comment"># also load the iris dataset</span>
<span class="comment"># and randomly permute it</span>
<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="comment"># also load the diabetes dataset</span>
<span class="comment"># and randomly permute it</span>
<span class="identifier">diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_classification</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check classification for various parameter settings.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">base_estimator</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span>
                           <span class="identifier">DummyClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">Perceptron</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">params</span> <span class="relational-operator">in</span> <span class="identifier">grid</span><span class="punctuation">:</span>
            <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">base_estimator</span><span class="punctuation">,</span>
                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                              <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">'sparse_format, params, method'</span><span class="punctuation">,</span>
    <span class="identifier">product</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="grouping">{</span>
            <span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span>
            <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">True</span>
        <span class="grouping">}</span><span class="punctuation">,</span> <span class="grouping">{</span>
            <span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="float-literal">1.0</span><span class="punctuation">,</span>
            <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="int-literal">4</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">True</span>
        <span class="grouping">}</span><span class="punctuation">,</span> <span class="grouping">{</span>
            <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">True</span>
        <span class="grouping">}</span><span class="punctuation">,</span> <span class="grouping">{</span>
            <span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">False</span>
        <span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="string-literal">'predict', 'predict_proba'</span><span class="punctuation">,</span>
         <span class="string-literal">'predict_log_proba', 'decision_function'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sparse_classification</span><span class="grouping">(</span><span class="identifier">sparse_format</span><span class="punctuation">,</span> <span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check classification for various parameter settings on sparse input.</span>

    <span class="keyword">class</span> <span class="identifier">CustomSVC</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""SVC variant that records the nature of the training set"""</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_type_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">scale</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                        <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">X_train_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_format</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="identifier">X_test_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_format</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="comment"># Trained on sparse format</span>
    <span class="identifier">sparse_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span>
        <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">CustomSVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="punctuation">,</span>
                                 <span class="identifier">decision_function_shape</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovr'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
        <span class="arithmetic-operator">**</span><span class="identifier">params</span>
    <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train_sparse</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">sparse_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">sparse_classifier</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X_test_sparse</span><span class="grouping">)</span>

    <span class="comment"># Trained on dense format</span>
    <span class="identifier">dense_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span>
        <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">CustomSVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="punctuation">,</span>
                                 <span class="identifier">decision_function_shape</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovr'</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
        <span class="arithmetic-operator">**</span><span class="identifier">params</span>
    <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">dense_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">dense_classifier</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse_results</span><span class="punctuation">,</span> <span class="identifier">dense_results</span><span class="grouping">)</span>

    <span class="identifier">sparse_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X_train_sparse</span><span class="grouping">)</span>
    <span class="identifier">types</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">.</span><span class="identifier">data_type_</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">sparse_classifier</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">]</span>

    <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">t</span> <span class="relational-operator">==</span> <span class="identifier">sparse_type</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">types</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_regression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check regression for various parameter settings.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">grid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">base_estimator</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span>
                           <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">SVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">params</span> <span class="relational-operator">in</span> <span class="identifier">grid</span><span class="punctuation">:</span>
            <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">base_estimator</span><span class="punctuation">,</span>
                             <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                             <span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sparse_regression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check regression for various parameter settings on sparse input.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">CustomSVR</span><span class="grouping">(</span><span class="identifier">SVR</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""SVC variant that records the nature of the training set"""</span>

        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">data_type_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="identifier">parameter_sets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="grouping">{</span><span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span>
         <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="float-literal">1.0</span><span class="punctuation">,</span>
         <span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="int-literal">4</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">"max_features"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span><span class="punctuation">,</span>
        <span class="grouping">{</span><span class="string-literal">"max_samples"</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
         <span class="string-literal">"bootstrap_features"</span><span class="punctuation">:</span> <span class="bool-literal">False</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">sparse_format</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">X_train_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_format</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
        <span class="identifier">X_test_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_format</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">params</span> <span class="relational-operator">in</span> <span class="identifier">parameter_sets</span><span class="punctuation">:</span>

            <span class="comment"># Trained on sparse format</span>
            <span class="identifier">sparse_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span>
                <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">CustomSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                <span class="arithmetic-operator">**</span><span class="identifier">params</span>
            <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train_sparse</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
            <span class="identifier">sparse_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_classifier</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test_sparse</span><span class="grouping">)</span>

            <span class="comment"># Trained on dense format</span>
            <span class="identifier">dense_results</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span>
                <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">CustomSVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                <span class="arithmetic-operator">**</span><span class="identifier">params</span>
            <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

            <span class="identifier">sparse_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X_train_sparse</span><span class="grouping">)</span>
            <span class="identifier">types</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">.</span><span class="identifier">data_type_</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">sparse_classifier</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">]</span>

            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse_results</span><span class="punctuation">,</span> <span class="identifier">dense_results</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">all</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">t</span> <span class="relational-operator">==</span> <span class="identifier">sparse_type</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">types</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">sparse_results</span><span class="punctuation">,</span> <span class="identifier">dense_results</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">DummySizeEstimator</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">training_size_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">training_hash_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">hash</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bootstrap_samples</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that bootstrapping samples generate non-perfect base estimators.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">base_estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="comment"># without bootstrap, all trees are perfect on the training set</span>
    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                 <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># with bootstrap, trees are no longer perfect on the training set</span>
    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">base_estimator</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span>
                   <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># check that each sampling correspond to a complete bootstrap resample.</span>
    <span class="comment"># the size of each bootstrap should be the same as the input data but</span>
    <span class="comment"># the data should be different (checked using the hash of the data).</span>
    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DummySizeEstimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">training_hash</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">estimator</span> <span class="relational-operator">in</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">training_size_</span> <span class="relational-operator">==</span> <span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">training_hash</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">training_hash_</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">training_hash</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">training_hash</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bootstrap_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that bootstrapping features may generate duplicate features.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap_features</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">features</span> <span class="relational-operator">in</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">estimators_features_</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">features</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap_features</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">features</span> <span class="relational-operator">in</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">estimators_features_</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">features</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_probability</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Predict probabilities.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">divide</span><span class="arithmetic-assignment">=</span><span class="string-literal">"ignore", invalid="ignore"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Normal case</span>
        <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span>
                                         <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Degenerate case, where some classes are missing</span>
        <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
                                     <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span>
                                         <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_oob_score_classification</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that oob prediction is a good estimation of the generalization</span>
    <span class="comment"># error.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">base_estimator</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">base_estimator</span><span class="punctuation">,</span>
                                <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

        <span class="identifier">test_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">test_score</span> <span class="arithmetic-operator">-</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">oob_score_</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.1</span>

        <span class="comment"># Test with few estimators</span>
        <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="string-literal">"Some inputs do not have OOB scores. This probably means too few "</span>
            <span class="string-literal">"estimators were used to compute any reliable oob estimates."</span>
        <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span>
                <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">base_estimator</span><span class="punctuation">,</span>
                <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">,</span>
            <span class="grouping">)</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_oob_score_regression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that oob prediction is a good estimation of the generalization</span>
    <span class="comment"># error.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span>
                           <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                           <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">test_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">test_score</span> <span class="arithmetic-operator">-</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">oob_score_</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.1</span>

    <span class="comment"># Test with few estimators</span>
    <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Some inputs do not have OOB scores. This probably means too few "</span>
        <span class="string-literal">"estimators were used to compute any reliable oob estimates."</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">regr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span>
            <span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
            <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
        <span class="identifier">regr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_single_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check singleton ensembles.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                            <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                            <span class="identifier">bootstrap_features</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KNeighborsRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that it gives proper exception on deficient input.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">base</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Test max_samples</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="string-literal">"foobar"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Test max_features</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="string-literal">"foobar"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Test support of decision_function</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="string-literal">'decision_function'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_parallel_classification</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check parallel classification.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Classification</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="comment"># predict_proba</span>
    <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">y3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y3</span><span class="grouping">)</span>

    <span class="comment"># decision_function</span>
    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">decision_function_shape</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovr'</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">decisions1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">decisions2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">decisions1</span><span class="punctuation">,</span> <span class="identifier">decisions2</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">decision_function_shape</span><span class="arithmetic-assignment">=</span><span class="string-literal">'ovr'</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">decisions3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">decision_function</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">decisions1</span><span class="punctuation">,</span> <span class="identifier">decisions3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_parallel_regression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check parallel regression.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">y3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_gridsearch</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that bagging ensembles can be grid-searched.</span>
    <span class="comment"># Transform iris into a binary classification task</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="comment"># Grid search with scoring based on decision_function</span>
    <span class="identifier">parameters</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'n_estimators'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="string-literal">'base_estimator__C'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">}</span>

    <span class="identifier">GridSearchCV</span><span class="grouping">(</span><span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">parameters</span><span class="punctuation">,</span>
                 <span class="identifier">scoring</span><span class="arithmetic-assignment">=</span><span class="string-literal">"roc_auc"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_base_estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check base_estimator and its default values.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Classification</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">base_estimator_</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">base_estimator_</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">Perceptron</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">base_estimator_</span><span class="punctuation">,</span> <span class="identifier">Perceptron</span><span class="grouping">)</span>

    <span class="comment"># Regression</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span>
                                                        <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">base_estimator_</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">base_estimator_</span><span class="punctuation">,</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">)</span>

    <span class="identifier">ensemble</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">SVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">base_estimator_</span><span class="punctuation">,</span> <span class="identifier">SVR</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bagging_with_pipeline</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">SelectKBest</span><span class="grouping">(</span><span class="identifier">k</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span>


<span class="keyword">class</span> <span class="identifier">DummyZeroEstimator</span><span class="grouping">(</span><span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">test_bagging_sample_weight_unsupported_but_passed</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">DummyZeroEstimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span>
                      <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warm_start</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if fitting incrementally with warm start gives a forest of the</span>
    <span class="comment"># right size and the same results as a normal fit.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">clf_ws</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">for</span> <span class="identifier">n_estimators</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">clf_ws</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">clf_ws</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">n_estimators</span><span class="punctuation">,</span>
                                       <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                                       <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">clf_ws</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="identifier">n_estimators</span><span class="grouping">)</span>
        <span class="identifier">clf_ws</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf_ws</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_estimators</span>

    <span class="identifier">clf_no_ws</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                                  <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">clf_no_ws</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">clf_ws</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                 <span class="identifier">set</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="keyword">for</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">clf_no_ws</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warm_start_smaller_n_estimators</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if warm start'ed second fit with smaller n_estimators raises error.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warm_start_equal_n_estimators</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that nothing happens when fitting without increasing n_estimators</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">43</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">83</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>
    <span class="comment"># modify X to nonsense values, this should not change anything</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span><span class="punctuation">.</span>

    <span class="identifier">warn_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Warm-start fitting without increasing n_estimators does not"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">UserWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">warn_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warm_start_equivalence</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># warm started classifier with 5+5 estimators should be equivalent to</span>
    <span class="comment"># one classifier with 10 estimators</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">43</span><span class="grouping">)</span>

    <span class="identifier">clf_ws</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                               <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">3141</span><span class="grouping">)</span>
    <span class="identifier">clf_ws</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">clf_ws</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">clf_ws</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_ws</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">3141</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y1</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_warm_start_with_oob_score_fails</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check using oob_score and warm_start simultaneously fails</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_oob_score_removed_on_warm_start</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2000</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">"oob_score_"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_oob_score_consistency</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure OOB scores are identical when random_state, estimator, and</span>
    <span class="comment"># training data are fixed and fitting is done twice</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">bagging</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">oob_score_</span> <span class="relational-operator">==</span> <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">oob_score_</span>


<span class="keyword">def</span> <span class="identifier">test_estimators_samples</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that format of estimators_samples_ is correct and that results</span>
    <span class="comment"># generated at fit time can be identically reproduced at a later time</span>
    <span class="comment"># using data saved in object attributes.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">bagging</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                <span class="identifier">bootstrap</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Get relevant attributes</span>
    <span class="identifier">estimators_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">estimators_samples_</span>
    <span class="identifier">estimators_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">estimators_features_</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">estimators_</span>

    <span class="comment"># Test for correct formatting</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">estimators_samples</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">estimators_samples</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span>
    <span class="keyword">assert</span> <span class="identifier">estimators_samples</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">kind</span> <span class="relational-operator">==</span> <span class="string-literal">'i'</span>

    <span class="comment"># Re-fit single estimator to test for consistent sampling</span>
    <span class="identifier">estimator_index</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">estimator_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimators_samples</span><span class="grouping">[</span><span class="identifier">estimator_index</span><span class="grouping">]</span>
    <span class="identifier">estimator_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimators_features</span><span class="grouping">[</span><span class="identifier">estimator_index</span><span class="grouping">]</span>
    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimators</span><span class="grouping">[</span><span class="identifier">estimator_index</span><span class="grouping">]</span>

    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">estimator_samples</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">estimator_features</span><span class="grouping">]</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">estimator_samples</span><span class="grouping">]</span>

    <span class="identifier">orig_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">coef_</span>
    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">new_coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">coef_</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">orig_coefs</span><span class="punctuation">,</span> <span class="identifier">new_coefs</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_estimators_samples_deterministic</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This test is a regression test to check that with a random step</span>
    <span class="comment"># (e.g. SparseRandomProjection) and a given random state, the results</span>
    <span class="comment"># generated at fit time can be identically reproduced at a later time using</span>
    <span class="comment"># data saved in object attributes. Check issue #9524 for full discussion.</span>

    <span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">base_pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">SparseRandomProjection</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">base_pipeline</span><span class="punctuation">,</span>
                            <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">pipeline_estimator_coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">estimator_sample</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_samples_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">estimator_feature</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_features_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">estimator_sample</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">estimator_feature</span><span class="grouping">]</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">estimator_sample</span><span class="grouping">]</span>

    <span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">estimator</span><span class="punctuation">.</span><span class="identifier">steps</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">pipeline_estimator_coef</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_max_samples_consistency</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure validated max_samples and original max_samples are identical</span>
    <span class="comment"># when valid integer max_samples supplied by user</span>
    <span class="identifier">max_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="arithmetic-operator">*</span><span class="identifier">max_samples</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">bagging</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">KNeighborsClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">max_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">max_samples</span><span class="punctuation">,</span>
                                <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">_max_samples</span> <span class="relational-operator">==</span> <span class="identifier">max_samples</span>


<span class="keyword">def</span> <span class="identifier">test_set_oob_score_label_encoding</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure the oob_score doesn't change when the labels change</span>
    <span class="comment"># See: https://github.com/scikit-learn/scikit-learn/issues/8933</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="identifier">Y1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'A', 'B', 'C'</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="identifier">Y2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="identifier">Y3</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">5</span>
    <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">oob_score_</span>
    <span class="identifier">x2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">oob_score_</span>
    <span class="identifier">x3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">oob_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                           <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y3</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">oob_score_</span>
    <span class="keyword">assert</span> <span class="grouping">[</span><span class="identifier">x1</span><span class="punctuation">,</span> <span class="identifier">x2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="identifier">x3</span><span class="punctuation">,</span> <span class="identifier">x3</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">replace</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'float'</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="bitwise-operator">~</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="keyword">return</span> <span class="identifier">X</span>


<span class="keyword">def</span> <span class="identifier">test_bagging_regressor_with_missing_inputs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that BaggingRegressor can accept X with missing/infinite data</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">NINF</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y_values</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
            <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">]</span><span class="grouping">)</span>
    <span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">y</span> <span class="relational-operator">in</span> <span class="identifier">y_values</span><span class="punctuation">:</span>
        <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span>
            <span class="identifier">FunctionTransformer</span><span class="grouping">(</span><span class="identifier">replace</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">regressor</span>
        <span class="grouping">)</span>
        <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">bagging_regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="grouping">)</span>
        <span class="identifier">y_hat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bagging_regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_hat</span><span class="punctuation">.</span><span class="identifier">shape</span>

        <span class="comment"># Verify that exceptions can be raised by wrapper regressor</span>
        <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">bagging_regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">bagging_regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bagging_classifier_with_missing_inputs</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that BaggingClassifier can accept X with missing/infinite data</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">NINF</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span>
        <span class="identifier">FunctionTransformer</span><span class="grouping">(</span><span class="identifier">replace</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span>
    <span class="grouping">)</span>
    <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">bagging_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="grouping">)</span>
    <span class="identifier">bagging_classifier</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_hat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bagging_classifier</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="identifier">y_hat</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">bagging_classifier</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">bagging_classifier</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Verify that exceptions can be raised by wrapper classifier</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pipeline</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">pipeline</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">bagging_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">pipeline</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">bagging_classifier</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bagging_small_max_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that Bagging estimator can accept low fractional max_features</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">bagging</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingClassifier</span><span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">bagging</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bagging_get_estimators_indices</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that Bagging estimator can generate sample indices properly</span>
    <span class="comment"># Non-regression test for:</span>
    <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/16436</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">13</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">13</span><span class="grouping">)</span>

    <span class="keyword">class</span> <span class="identifier">MyEstimator</span><span class="grouping">(</span><span class="identifier">DecisionTreeRegressor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""An estimator which stores y indices information at fit."""</span>
        <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_sample_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BaggingRegressor</span><span class="grouping">(</span><span class="identifier">base_estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">MyEstimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">_sample_indices</span><span class="punctuation">,</span>
                       <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">estimators_samples_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="comment"># FIXME: remove in 1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Estimator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">BaggingClassifier</span><span class="punctuation">,</span> <span class="identifier">BaggingRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_features_deprecation</span><span class="grouping">(</span><span class="identifier">Estimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that we raise the proper deprecation warning if accessing</span>
    <span class="comment"># `n_features_`.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"n_features_ was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">n_features_</span>

    </pre>
  </body>
</html>