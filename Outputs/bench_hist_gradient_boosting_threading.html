<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">time</span> <span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">argparse</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">from</span> <span class="identifier">pprint</span> <span class="keyword">import</span> <span class="identifier">pprint</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">threadpoolctl</span> <span class="keyword">import</span> <span class="identifier">threadpool_limits</span>
<span class="keyword">import</span> <span class="identifier">sklearn</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">HistGradientBoostingClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_regression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span><span class="punctuation">.</span><span class="identifier">_hist_gradient_boosting</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">get_equivalent_estimator</span><span class="grouping">)</span>


<span class="identifier">parser</span> <span class="arithmetic-assignment">=</span> <span class="identifier">argparse</span><span class="punctuation">.</span><span class="identifier">ArgumentParser</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-leaf-nodes'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">31</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-trees'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--lightgbm'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">'also benchmark lightgbm'</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--xgboost'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">'also benchmark xgboost'</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--catboost'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">'also benchmark catboost'</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--learning-rate'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--problem', type=str, default='classification'</span><span class="punctuation">,</span>
                    <span class="identifier">choices</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">'classification', 'regression'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--loss', type=str, default='default'</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--missing-fraction'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">float</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-classes'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-samples'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1e6</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--n-features'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--max-bins'</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">255</span><span class="grouping">)</span>

<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--print-params'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--random-sample-weights'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span>
                    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">"generate and use random sample weights"</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--plot'</span><span class="punctuation">,</span> <span class="identifier">action</span><span class="arithmetic-assignment">=</span><span class="string-literal">"store_true"</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">'show a plot results'</span><span class="grouping">)</span>
<span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">add_argument</span><span class="grouping">(</span><span class="string-literal">'--plot-filename'</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                    <span class="identifier">help</span><span class="arithmetic-assignment">=</span><span class="string-literal">'filename to save the figure to disk'</span><span class="grouping">)</span>
<span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parser</span><span class="punctuation">.</span><span class="identifier">parse_args</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_samples</span>
<span class="identifier">n_leaf_nodes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_leaf_nodes</span>
<span class="identifier">n_trees</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_trees</span>
<span class="identifier">lr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">learning_rate</span>
<span class="identifier">max_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">max_bins</span>


<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Data size: %d samples train, %d samples test."</span>
      <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"n_features: {args.n_features}"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">get_estimator_and_data</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'classification'</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                                   <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_features</span><span class="punctuation">,</span>
                                   <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_classes</span><span class="punctuation">,</span>
                                   <span class="identifier">n_clusters_per_class</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                   <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_features</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">HistGradientBoostingClassifier</span>
    <span class="keyword">elif</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'regression'</span><span class="punctuation">:</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_regression</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_samples_max</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                               <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">HistGradientBoostingRegressor</span>


<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">Estimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_estimator_and_data</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">missing_fraction</span><span class="punctuation">:</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">missing_fraction</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span>
        <span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>

<span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">random_sample_weights</span><span class="punctuation">:</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">10</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

<span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
    <span class="grouping">(</span><span class="identifier">X_train_</span><span class="punctuation">,</span> <span class="identifier">X_test_</span><span class="punctuation">,</span> <span class="identifier">y_train_</span><span class="punctuation">,</span> <span class="identifier">y_test_</span><span class="punctuation">,</span>
     <span class="identifier">sample_weight_train_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="identifier">X_train_</span><span class="punctuation">,</span> <span class="identifier">X_test_</span><span class="punctuation">,</span> <span class="identifier">y_train_</span><span class="punctuation">,</span> <span class="identifier">y_test_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">sample_weight_train_</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>


<span class="identifier">sklearn_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Estimator</span><span class="grouping">(</span>
    <span class="identifier">learning_rate</span><span class="arithmetic-assignment">=</span><span class="identifier">lr</span><span class="punctuation">,</span>
    <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_trees</span><span class="punctuation">,</span>
    <span class="identifier">max_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">max_bins</span><span class="punctuation">,</span>
    <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_leaf_nodes</span><span class="punctuation">,</span>
    <span class="identifier">early_stopping</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
    <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">loss</span>
<span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'classification'</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">loss</span> <span class="relational-operator">==</span> <span class="string-literal">'default'</span><span class="punctuation">:</span>
        <span class="comment"># loss='auto' does not work with get_equivalent_estimator()</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'binary_crossentropy'</span> <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_classes</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="keyword">else</span> <span class="invalid">\</span>
            <span class="string-literal">'categorical_crossentropy'</span>
<span class="keyword">else</span><span class="punctuation">:</span>
    <span class="comment"># regression</span>
    <span class="keyword">if</span> <span class="identifier">loss</span> <span class="relational-operator">==</span> <span class="string-literal">'default'</span><span class="punctuation">:</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'squared_error'</span>
<span class="identifier">sklearn_est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="identifier">loss</span><span class="grouping">)</span>


<span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">print_params</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"scikit-learn"</span><span class="grouping">)</span>
    <span class="identifier">pprint</span><span class="grouping">(</span><span class="identifier">sklearn_est</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">libname</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"lightgbm", "xgboost", "catboost"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">,</span> <span class="identifier">libname</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">libname</span><span class="grouping">)</span>
            <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_equivalent_estimator</span><span class="grouping">(</span><span class="identifier">sklearn_est</span><span class="punctuation">,</span> <span class="identifier">lib</span><span class="arithmetic-assignment">=</span><span class="identifier">libname</span><span class="grouping">)</span>
            <span class="identifier">pprint</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">one_run</span><span class="grouping">(</span><span class="identifier">n_threads</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_test_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_train_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_test_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">sample_weight_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sample_weight_train_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">sample_weight_train</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">assert</span> <span class="identifier">X_train</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>
    <span class="keyword">assert</span> <span class="identifier">X_test</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Fitting a sklearn model..."</span><span class="grouping">)</span>
    <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span><span class="punctuation">.</span><span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">sklearn_est</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">threadpool_limits</span><span class="grouping">(</span><span class="identifier">n_threads</span><span class="punctuation">,</span> <span class="identifier">user_api</span><span class="arithmetic-assignment">=</span><span class="string-literal">"openmp"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight_train</span><span class="grouping">)</span>
        <span class="identifier">sklearn_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">sklearn_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
        <span class="identifier">sklearn_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score: {:.4f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">sklearn_score</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"fit duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">sklearn_fit_duration</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">sklearn_score_duration</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">lightgbm_score</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">lightgbm_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">lightgbm_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">lightgbm</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Fitting a LightGBM model..."</span><span class="grouping">)</span>
        <span class="identifier">lightgbm_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_equivalent_estimator</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">lib</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lightgbm'</span><span class="grouping">)</span>
        <span class="identifier">lightgbm_est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">num_threads</span><span class="arithmetic-assignment">=</span><span class="identifier">n_threads</span><span class="grouping">)</span>

        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">lightgbm_est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight_train</span><span class="grouping">)</span>
        <span class="identifier">lightgbm_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">lightgbm_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lightgbm_est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
        <span class="identifier">lightgbm_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score: {:.4f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">lightgbm_score</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"fit duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">lightgbm_fit_duration</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">lightgbm_score_duration</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">xgb_score</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">xgb_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">xgb_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">xgboost</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Fitting an XGBoost model..."</span><span class="grouping">)</span>
        <span class="identifier">xgb_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_equivalent_estimator</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">lib</span><span class="arithmetic-assignment">=</span><span class="string-literal">'xgboost'</span><span class="grouping">)</span>
        <span class="identifier">xgb_est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">nthread</span><span class="arithmetic-assignment">=</span><span class="identifier">n_threads</span><span class="grouping">)</span>

        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">xgb_est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight_train</span><span class="grouping">)</span>
        <span class="identifier">xgb_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">xgb_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">xgb_est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
        <span class="identifier">xgb_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score: {:.4f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">xgb_score</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"fit duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">xgb_fit_duration</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">xgb_score_duration</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">cat_score</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">cat_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="identifier">cat_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">catboost</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Fitting a CatBoost model..."</span><span class="grouping">)</span>
        <span class="identifier">cat_est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_equivalent_estimator</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">lib</span><span class="arithmetic-assignment">=</span><span class="string-literal">'catboost'</span><span class="grouping">)</span>
        <span class="identifier">cat_est</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">thread_count</span><span class="arithmetic-assignment">=</span><span class="identifier">n_threads</span><span class="grouping">)</span>

        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">cat_est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight_train</span><span class="grouping">)</span>
        <span class="identifier">cat_fit_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">tic</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">cat_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cat_est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
        <span class="identifier">cat_score_duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">tic</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score: {:.4f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">cat_score</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"fit duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">cat_fit_duration</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"score duration: {:.3f}s,"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">cat_score_duration</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">sklearn_score</span><span class="punctuation">,</span> <span class="identifier">sklearn_fit_duration</span><span class="punctuation">,</span> <span class="identifier">sklearn_score_duration</span><span class="punctuation">,</span>
            <span class="identifier">lightgbm_score</span><span class="punctuation">,</span> <span class="identifier">lightgbm_fit_duration</span><span class="punctuation">,</span> <span class="identifier">lightgbm_score_duration</span><span class="punctuation">,</span>
            <span class="identifier">xgb_score</span><span class="punctuation">,</span> <span class="identifier">xgb_fit_duration</span><span class="punctuation">,</span> <span class="identifier">xgb_score_duration</span><span class="punctuation">,</span>
            <span class="identifier">cat_score</span><span class="punctuation">,</span> <span class="identifier">cat_fit_duration</span><span class="punctuation">,</span> <span class="identifier">cat_score_duration</span><span class="grouping">)</span>


<span class="identifier">max_threads</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">cpu_count</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">n_threads_list</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="identifier">i</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">8</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="identifier">i</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_threads</span><span class="grouping">]</span>
<span class="identifier">n_threads_list</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">max_threads</span><span class="grouping">)</span>

<span class="identifier">sklearn_scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">sklearn_fit_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">sklearn_score_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">lightgbm_scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">lightgbm_fit_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">lightgbm_score_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">xgb_scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">xgb_fit_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">xgb_score_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">cat_scores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">cat_fit_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
<span class="identifier">cat_score_durations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

<span class="keyword">for</span> <span class="identifier">n_threads</span> <span class="relational-operator">in</span> <span class="identifier">n_threads_list</span><span class="punctuation">:</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">f</span><span class="string-literal">"n_threads: {n_threads}"</span><span class="grouping">)</span>
    <span class="grouping">(</span>
        <span class="identifier">sklearn_score</span><span class="punctuation">,</span>
        <span class="identifier">sklearn_fit_duration</span><span class="punctuation">,</span>
        <span class="identifier">sklearn_score_duration</span><span class="punctuation">,</span>
        <span class="identifier">lightgbm_score</span><span class="punctuation">,</span>
        <span class="identifier">lightgbm_fit_duration</span><span class="punctuation">,</span>
        <span class="identifier">lightgbm_score_duration</span><span class="punctuation">,</span>
        <span class="identifier">xgb_score</span><span class="punctuation">,</span>
        <span class="identifier">xgb_fit_duration</span><span class="punctuation">,</span>
        <span class="identifier">xgb_score_duration</span><span class="punctuation">,</span>
        <span class="identifier">cat_score</span><span class="punctuation">,</span>
        <span class="identifier">cat_fit_duration</span><span class="punctuation">,</span>
        <span class="identifier">cat_score_duration</span>
    <span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">one_run</span><span class="grouping">(</span><span class="identifier">n_threads</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">score</span> <span class="relational-operator">in</span> <span class="grouping">(</span>
            <span class="grouping">(</span><span class="identifier">sklearn_scores</span><span class="punctuation">,</span> <span class="identifier">sklearn_score</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">sklearn_fit_durations</span><span class="punctuation">,</span> <span class="identifier">sklearn_fit_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">sklearn_score_durations</span><span class="punctuation">,</span> <span class="identifier">sklearn_score_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">lightgbm_scores</span><span class="punctuation">,</span> <span class="identifier">lightgbm_score</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">lightgbm_fit_durations</span><span class="punctuation">,</span> <span class="identifier">lightgbm_fit_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">lightgbm_score_durations</span><span class="punctuation">,</span> <span class="identifier">lightgbm_score_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">xgb_scores</span><span class="punctuation">,</span> <span class="identifier">xgb_score</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">xgb_fit_durations</span><span class="punctuation">,</span> <span class="identifier">xgb_fit_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">xgb_score_durations</span><span class="punctuation">,</span> <span class="identifier">xgb_score_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">cat_scores</span><span class="punctuation">,</span> <span class="identifier">cat_score</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">cat_fit_durations</span><span class="punctuation">,</span> <span class="identifier">cat_fit_duration</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="identifier">cat_score_durations</span><span class="punctuation">,</span> <span class="identifier">cat_score_duration</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scores</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">score</span><span class="grouping">)</span>


<span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">plot</span> <span class="logical-operator">or</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">plot_filename</span><span class="punctuation">:</span>
    <span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
    <span class="keyword">import</span> <span class="identifier">matplotlib</span>

    <span class="identifier">fig</span><span class="punctuation">,</span> <span class="identifier">axs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="string-literal">"sklearn {sklearn.__version__}"</span>
    <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">sklearn_fit_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>
    <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">sklearn_score_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">lightgbm</span><span class="punctuation">:</span>
        <span class="keyword">import</span> <span class="identifier">lightgbm</span>
        <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="string-literal">'LightGBM {lightgbm.__version__}'</span>
        <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">lightgbm_fit_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>
        <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">lightgbm_score_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">xgboost</span><span class="punctuation">:</span>
        <span class="keyword">import</span> <span class="identifier">xgboost</span>
        <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="string-literal">'XGBoost {xgboost.__version__}'</span>
        <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">xgb_fit_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>
        <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">xgb_score_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">catboost</span><span class="punctuation">:</span>
        <span class="keyword">import</span> <span class="identifier">catboost</span>
        <span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f</span><span class="string-literal">'CatBoost {catboost.__version__}'</span>
        <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">cat_fit_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>
        <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="punctuation">,</span> <span class="identifier">cat_score_durations</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">label</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">ax</span> <span class="relational-operator">in</span> <span class="identifier">axs</span><span class="punctuation">:</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_xscale</span><span class="grouping">(</span><span class="string-literal">'log'</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_xlabel</span><span class="grouping">(</span><span class="string-literal">'n_threads'</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_ylabel</span><span class="grouping">(</span><span class="string-literal">'duration (s)'</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">set_xticks</span><span class="grouping">(</span><span class="identifier">n_threads_list</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">get_xaxis</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">set_major_formatter</span><span class="grouping">(</span><span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">ticker</span><span class="punctuation">.</span><span class="identifier">ScalarFormatter</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">ax</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="string-literal">'best'</span><span class="grouping">)</span>

    <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'fit duration (s)'</span><span class="grouping">)</span>
    <span class="identifier">axs</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">set_title</span><span class="grouping">(</span><span class="string-literal">'score duration (s)'</span><span class="grouping">)</span>

    <span class="identifier">title</span> <span class="arithmetic-assignment">=</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">problem</span>
    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">problem</span> <span class="relational-operator">==</span> <span class="string-literal">'classification'</span><span class="punctuation">:</span>
        <span class="identifier">title</span> <span class="arithmetic-assignment">+=</span> <span class="string-literal">' n_classes = {}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">n_classes</span><span class="grouping">)</span>
    <span class="identifier">fig</span><span class="punctuation">.</span><span class="identifier">suptitle</span><span class="grouping">(</span><span class="identifier">title</span><span class="grouping">)</span>

    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">plot_filename</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">savefig</span><span class="grouping">(</span><span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">plot_filename</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">args</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>