<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Mask Editor for the manual adjustments tool """</span>
<span class="keyword">import</span> <span class="identifier">gettext</span>
<span class="keyword">import</span> <span class="identifier">tkinter</span> <span class="keyword">as</span> <span class="identifier">tk</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">from</span> <span class="identifier">PIL</span> <span class="keyword">import</span> <span class="identifier">Image</span><span class="punctuation">,</span> <span class="identifier">ImageTk</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">ControlPanelOption</span><span class="punctuation">,</span> <span class="identifier">Editor</span><span class="punctuation">,</span> <span class="identifier">logger</span>

<span class="comment"># LOCALES</span>
<span class="identifier">_LANG</span> <span class="arithmetic-assignment">=</span> <span class="identifier">gettext</span><span class="punctuation">.</span><span class="identifier">translation</span><span class="grouping">(</span><span class="string-literal">"tools.manual", localedir="locales"</span><span class="punctuation">,</span> <span class="identifier">fallback</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
<span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_LANG</span><span class="punctuation">.</span><span class="identifier">gettext</span>


<span class="keyword">class</span> <span class="identifier">Mask</span><span class="grouping">(</span><span class="identifier">Editor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" The mask Editor.

    Edit a mask in the alignments file.

    Parameters
    ----------
    canvas: :class:`tkinter.Canvas`
        The canvas that holds the image and annotations
    detected_faces: :class:`~tools.manual.detected_faces.DetectedFaces`
        The _detected_faces data for this manual session
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_internal_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">512</span>
        <span class="identifier">control_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Mask Editor\nEdit the mask."</span>
                         <span class="string-literal">"\n - NB: For Landmark based masks (e.g. components/extended) it is "</span>
                         <span class="string-literal">"better to make sure the landmarks are correct rather than editing the "</span>
                         <span class="string-literal">"mask directly. Any change to the landmarks after editing the mask will "</span>
                         <span class="string-literal">"override your manual edits."</span><span class="grouping">)</span>
        <span class="identifier">key_bindings</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"["</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_adjust_brush_radius</span><span class="grouping">(</span><span class="identifier">increase</span><span class="arithmetic-assignment">=</span><span class="identifier">i</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="string-literal">"]"</span><span class="punctuation">:</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_adjust_brush_radius</span><span class="grouping">(</span><span class="identifier">increase</span><span class="arithmetic-assignment">=</span><span class="identifier">i</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">canvas</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="punctuation">,</span>
                         <span class="identifier">control_text</span><span class="arithmetic-assignment">=</span><span class="identifier">control_text</span><span class="punctuation">,</span> <span class="identifier">key_bindings</span><span class="arithmetic-assignment">=</span><span class="identifier">key_bindings</span><span class="grouping">)</span>
        <span class="comment"># Bind control click for reverse painting</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">bind</span><span class="grouping">(</span><span class="string-literal">"&lt;Control-ButtonPress-1&gt;"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_click</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_tk_mask_change_callback</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">create_oval</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="string-literal">"black", state="hidden"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_opacity</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" float: The mask opacity setting from the control panel from 0.0 - 1.0. """</span>
        <span class="identifier">annotation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_formats</span><span class="grouping">[</span><span class="identifier">annotation</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"mask_opacity"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">100.0</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_brush_radius</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" int: The radius of the brush to use as set in control panel options """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"brush"]["BrushSize"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_edit_mode</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" str: The currently selected edit mode based on optional action button.
        One of "draw" or "erase" """</span>
        <span class="identifier">action</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">name</span> <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">option</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span>
                  <span class="keyword">if</span> <span class="identifier">option</span><span class="grouping">[</span><span class="string-literal">"group"] == "paint" and option["tk_var"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="string-literal">"draw"</span> <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">action</span> <span class="keyword">else</span> <span class="identifier">action</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">_cursor_color</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" str: The hex code for the selected cursor color """</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"brush"]["CursorColor"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_actions</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add the optional action buttons to the viewer. Current actions are Draw, Erase
        and Zoom. """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_action</span><span class="grouping">(</span><span class="string-literal">"magnify", "zoom", _("Magnify/Demagnify the View"</span><span class="grouping">)</span><span class="punctuation">,</span>
                         <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">hotkey</span><span class="arithmetic-assignment">=</span><span class="string-literal">"M"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_action</span><span class="grouping">(</span><span class="string-literal">"draw", "draw", _("Draw Tool"), group="paint", hotkey="D"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_action</span><span class="grouping">(</span><span class="string-literal">"erase", "erase", _("Erase Tool"), group="paint", hotkey="E"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_actions</span><span class="grouping">[</span><span class="string-literal">"magnify"]["tk_var"].trace("w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_add_controls</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add the mask specific control panel controls.

        Current controls are:
          - the mask type to edit
          - the size of brush to use
          - the cursor display color
        """</span>
        <span class="identifier">masks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">msk</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">msk</span> <span class="relational-operator">in</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">available_masks</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">[</span><span class="string-literal">"None"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">masks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">masks</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="identifier">mask</span> <span class="keyword">for</span> <span class="identifier">mask</span> <span class="relational-operator">in</span> <span class="identifier">masks</span> <span class="keyword">if</span> <span class="identifier">mask</span> <span class="relational-operator">!=</span> <span class="string-literal">"None"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_control</span><span class="grouping">(</span><span class="identifier">ControlPanelOption</span><span class="grouping">(</span><span class="string-literal">"Mask type"</span><span class="punctuation">,</span>
                                             <span class="identifier">str</span><span class="punctuation">,</span>
                                             <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Display"</span><span class="punctuation">,</span>
                                             <span class="identifier">choices</span><span class="arithmetic-assignment">=</span><span class="identifier">masks</span><span class="punctuation">,</span>
                                             <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="punctuation">,</span>
                                             <span class="identifier">is_radio</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                             <span class="identifier">helptext</span><span class="arithmetic-assignment">=</span><span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Select which mask to edit"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_control</span><span class="grouping">(</span><span class="identifier">ControlPanelOption</span><span class="grouping">(</span><span class="string-literal">"Brush Size"</span><span class="punctuation">,</span>
                                             <span class="identifier">int</span><span class="punctuation">,</span>
                                             <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Brush"</span><span class="punctuation">,</span>
                                             <span class="identifier">min_max</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">,</span>
                                             <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                             <span class="identifier">rounding</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                                             <span class="identifier">helptext</span><span class="arithmetic-assignment">=</span><span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Set the brush size. ([ - decrease, "</span>
                                                        <span class="string-literal">"] - increase)"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_add_control</span><span class="grouping">(</span><span class="identifier">ControlPanelOption</span><span class="grouping">(</span><span class="string-literal">"Cursor Color"</span><span class="punctuation">,</span>
                                             <span class="identifier">str</span><span class="punctuation">,</span>
                                             <span class="identifier">group</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Brush"</span><span class="punctuation">,</span>
                                             <span class="identifier">choices</span><span class="arithmetic-assignment">=</span><span class="string-literal">"colorchooser"</span><span class="punctuation">,</span>
                                             <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">"#ffffff"</span><span class="punctuation">,</span>
                                             <span class="identifier">helptext</span><span class="arithmetic-assignment">=</span><span class="identifier">_</span><span class="grouping">(</span><span class="string-literal">"Select the brush cursor color."</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_tk_mask_change_callback</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add a trace to change the displayed mask on a mask type change. """</span>
        <span class="identifier">var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"display"]["MaskType"</span><span class="grouping">]</span>
        <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"w"</span><span class="punctuation">,</span> <span class="keyword">lambda</span> <span class="arithmetic-operator">*</span><span class="identifier">e</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_on_mask_type_change</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">var</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_on_mask_type_change</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the displayed mask on a mask type change """</span>
        <span class="identifier">mask_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"display"]["MaskType"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">mask_type</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_type</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">position</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask_type</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">tk_update</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">hide_annotation</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tag</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Clear the mask :attr:`_meta` dict when hiding the annotation. """</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">hide_annotation</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">update_annotation</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the mask annotation with the latest mask. """</span>
        <span class="identifier">position</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span>
        <span class="keyword">if</span> <span class="identifier">position</span> <span class="relational-operator">!=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"position"</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Reset meta information when moving to a new frame</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">position</span><span class="arithmetic-assignment">=</span><span class="identifier">position</span><span class="grouping">)</span>
        <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
        <span class="identifier">mask_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"display"]["MaskType"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_color</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">rgb_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">color</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">:</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">roi_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_annotation_formats</span><span class="grouping">[</span><span class="string-literal">"ExtractBox"]["color"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">opacity</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_opacity</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_face_iterator</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">face_index</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span> <span class="keyword">else</span> <span class="identifier">idx</span>
            <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="identifier">mask_type</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">mask</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_face_meta_data</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_mask_image</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">rgb_color</span><span class="punctuation">,</span> <span class="identifier">opacity</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_roi_box</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">roi_color</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">tag_raise</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>  <span class="comment"># Always keep brush cursor on top</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updated mask annotation"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_set_face_meta_data</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the metadata for the current face if it has changed or is new.

        Parameters
        ----------
        mask: :class:`numpy.ndarray`
            The one channel mask cropped to the ROI
        face_index: int
            The index pertaining to the current face
        """</span>
        <span class="identifier">masks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"mask"</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">masks</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">masks</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span> <span class="relational-operator">==</span> <span class="identifier">face_index</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Meta information already defined for face: %s"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span>
            <span class="keyword">return</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Defining meta information for face: %s"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_internal_size</span> <span class="arithmetic-operator">/</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_set_full_frame_meta</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
        <span class="identifier">dims</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_internal_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_internal_size</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"mask"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_mask</span><span class="punctuation">,</span>
                                                            <span class="identifier">dims</span><span class="punctuation">,</span>
                                                            <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">zoomed_centering</span> <span class="relational-operator">!=</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_centering</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">zoomed_centering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">stored_centering</span>

    <span class="keyword">def</span> <span class="identifier">_set_full_frame_meta</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">mask_scale</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Sets the meta information for displaying the mask in full frame mode.

        Parameters
        ----------
        mask: :class:`lib.align.Mask`
            The mask object
        mask_scale: float
            The scaling factor from the stored mask size to the internal mask size

        Sets the following parameters to :attr:`_meta`:
            - roi_mask: the rectangular ROI box from the full frame that contains the original ROI
            for the full frame mask
            - top_left: The location that the roi_mask should be placed in the display frame
            - affine_matrix: The matrix for transposing the mask to a full frame
            - interpolator: The cv2 interpolation method to use for transposing mask to a
            full frame
            - slices: The (`x`, `y`) slice objects required to extract the mask ROI
            from the full frame
        """</span>
        <span class="identifier">frame_dims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"display_dims"</span><span class="grouping">]</span>
        <span class="identifier">scaled_mask_roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">original_roi</span> <span class="arithmetic-operator">*</span>
                                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"scale"]).astype("int32"</span><span class="grouping">)</span>

        <span class="comment"># Scale and clip the ROI to fit within display frame boundaries</span>
        <span class="identifier">clipped_roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scaled_mask_roi</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">min</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="arithmetic-assignment">=</span><span class="identifier">frame_dims</span><span class="grouping">)</span>

        <span class="comment"># Obtain min and max points to get ROI as a rectangle</span>
        <span class="identifier">min_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">min</span><span class="arithmetic-assignment">=</span><span class="identifier">clipped_roi</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max</span><span class="arithmetic-assignment">=</span><span class="identifier">clipped_roi</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Create a bounding box rectangle ROI</span>
        <span class="identifier">roi_dims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">min_max</span><span class="grouping">[</span><span class="string-literal">"max"][1] - min_max["min"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">min_max</span><span class="grouping">[</span><span class="string-literal">"max"][0] - min_max["min"][0])).astype("uint16"</span><span class="grouping">)</span>
        <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">roi_dims</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"uint8"</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span>
                   <span class="identifier">corners</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">expand_dims</span><span class="grouping">(</span><span class="identifier">scaled_mask_roi</span> <span class="arithmetic-operator">-</span> <span class="identifier">min_max</span><span class="grouping">[</span><span class="string-literal">"min"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># Block out areas outside of the actual mask ROI polygon</span>
        <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">fillPoly</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="string-literal">"mask"], roi["corners"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">255</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Setting Full Frame mask ROI. shape: %s", roi["mask"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

        <span class="comment"># obtain the slices for cropping mask from full frame</span>
        <span class="identifier">xy_slices</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">min_max</span><span class="grouping">[</span><span class="string-literal">"min"][1])), int(round(min_max["max"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">min_max</span><span class="grouping">[</span><span class="string-literal">"min"][0])), int(round(min_max["max"</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># Adjust affine matrix for internal mask size and display dimensions</span>
        <span class="identifier">adjustments</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">mask_scale</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">mask_scale</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"scale"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                                 <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"scale"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                                 <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">in_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">adjustments</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">affine_matrix</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">affine_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">in_matrix</span><span class="punctuation">,</span> <span class="identifier">adjustments</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Get the size of the mask roi box in the frame</span>
        <span class="identifier">side_sizes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">scaled_mask_roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">scaled_mask_roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">scaled_mask_roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">scaled_mask_roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">mask_roi_size</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">side_sizes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">side_sizes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="float-literal">0.5</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"roi_mask", []).append(roi["mask"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"affine_matrix"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">affine_matrix</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"interpolator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">interpolator</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"slices"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">xy_slices</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"top_left", []).append(min_max["min"</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="punctuation">.</span><span class="identifier">setdefault</span><span class="grouping">(</span><span class="string-literal">"mask_roi_size"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">mask_roi_size</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_mask_image</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">rgb_color</span><span class="punctuation">,</span> <span class="identifier">opacity</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain a mask, overlay over image and add to canvas or update.

        Parameters
        ----------
        key: str
            The base annotation name for creating tags
        face_index: int
            The index of the face within the current frame
        rgb_color: tuple
            The color that the mask should be displayed as
        opacity: float
            The opacity to apply to the mask
        """</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"mask"][face_index] * opacity).astype("uint8"</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="identifier">display_image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_mask_image_zoomed</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">rgb_color</span><span class="grouping">)</span>
            <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_roi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="comment"># Hide all masks and only display selected</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"Mask", state="hidden"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="string-literal">"Mask_face_{}".format(face_index), state="normal"</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">display_image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_mask_image_full_frame</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">rgb_color</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span>
            <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"top_left"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span>

        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">face_index</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Adding new Photo Image for face index: %s"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">ImageTk</span><span class="punctuation">.</span><span class="identifier">PhotoImage</span><span class="grouping">(</span><span class="identifier">display_image</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">width</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">display_image</span><span class="punctuation">.</span><span class="identifier">width</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Replacing existing Photo Image on width change for face index: %s"</span><span class="punctuation">,</span>
                         <span class="identifier">face_index</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ImageTk</span><span class="punctuation">.</span><span class="identifier">PhotoImage</span><span class="grouping">(</span><span class="identifier">display_image</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Updating existing image"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">paste</span><span class="grouping">(</span><span class="identifier">display_image</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="identifier">key</span><span class="punctuation">,</span>
                             <span class="string-literal">"image"</span><span class="punctuation">,</span>
                             <span class="identifier">face_index</span><span class="punctuation">,</span>
                             <span class="identifier">top_left</span><span class="punctuation">,</span>
                             <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">image</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_tk_faces</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">anchor</span><span class="arithmetic-assignment">=</span><span class="identifier">tk</span><span class="punctuation">.</span><span class="identifier">NW</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_mask_image_zoomed</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">rgb_color</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the mask image when zoomed in.

        Parameters
        ----------
        mask: :class:`numpy.ndarray`
            The raw mask
        rgb_color: tuple
            The rgb color selected for the mask

        Returns
        -------
        :class: `PIL.Image`
            The zoomed mask image formatted for display
        """</span>
        <span class="identifier">rgb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">rgb_color</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_dims</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"uint8"</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span>
                          <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">reversed</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_dims</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
        <span class="identifier">rgba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">rgb</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">Image</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">rgba</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_mask_image_full_frame</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">rgb_color</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the mask image when in full frame view.

        Parameters
        ----------
        mask: :class:`numpy.ndarray`
            The raw mask
        rgb_color: tuple
            The rgb color selected for the mask
        face_index: int
            The index of the face being displayed

        Returns
        -------
        :class: `PIL.Image`
            The full frame mask image formatted for display
        """</span>
        <span class="identifier">frame_dims</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">current_frame</span><span class="grouping">[</span><span class="string-literal">"display_dims"</span><span class="grouping">]</span>
        <span class="identifier">frame</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">frame_dims</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"uint8"</span><span class="grouping">)</span>
        <span class="identifier">interpolator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"interpolator"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"slices"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">warpAffine</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"affine_matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">frame_dims</span><span class="punctuation">,</span>
                              <span class="identifier">frame</span><span class="punctuation">,</span>
                              <span class="identifier">flags</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">WARP_INVERSE_MAP</span> <span class="bitwise-operator">|</span> <span class="identifier">interpolator</span><span class="punctuation">,</span>
                              <span class="identifier">borderMode</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">BORDER_CONSTANT</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">slices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">slices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">2</span> <span class="keyword">else</span> <span class="identifier">mask</span>
        <span class="identifier">rgb</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">rgb_color</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"uint8"</span><span class="grouping">)</span>
        <span class="identifier">rgba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">rgb</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"roi_mask"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">Image</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">rgba</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_update_roi_box</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the region of interest box for the current mask.

        mask: :class:`~lib.align.Mask`
            The current mask object to create an ROI box for
        face_index: int
            The index of the face within the current frame
        color: str
            The hex color code that the mask should be displayed as
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_roi</span>
            <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale_to_display</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">original_roi</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">flatten</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">box</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">10</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">font</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">"Default", 20, "bold"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">text</span><span class="arithmetic-assignment">=</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">face_index</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="string-literal">"mask_text", "text"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">fill</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span> <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_object_tracker</span><span class="grouping">(</span><span class="string-literal">"mask_roi", "polygon"</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">box</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="comment"># Raise box above zoomed image</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">tag_raise</span><span class="grouping">(</span><span class="string-literal">"mask_roi_face_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">face_index</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt; MOUSE HANDLING &gt;&gt;</span>
    <span class="comment"># Mouse cursor display</span>
    <span class="keyword">def</span> <span class="identifier">_update_cursor</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Set the cursor action.

        Update :attr:`_mouse_location` with the current cursor position and display appropriate
        icon.

        Checks whether the mouse is over a mask ROI box and pops the paint icon.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The current tkinter mouse event
        """</span>
        <span class="identifier">roi_boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"mask_roi"</span><span class="grouping">)</span>
        <span class="identifier">item_ids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">find_withtag</span><span class="grouping">(</span><span class="string-literal">"current"</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">roi_boxes</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">item_ids</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"hidden"</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">return</span>
        <span class="identifier">item_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">item_ids</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="identifier">tags</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">gettags</span><span class="grouping">(</span><span class="identifier">item_id</span><span class="grouping">)</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">next</span><span class="grouping">(</span><span class="identifier">tag</span> <span class="keyword">for</span> <span class="identifier">tag</span> <span class="relational-operator">in</span> <span class="identifier">tags</span> <span class="keyword">if</span> <span class="identifier">tag</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"face_")).split("_"</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">radius</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_brush_radius</span>
        <span class="identifier">coords</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">-</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">radius</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="identifier">radius</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">(</span><span class="identifier">cursor</span><span class="arithmetic-assignment">=</span><span class="string-literal">"none"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">coords</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">itemconfig</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">state</span><span class="arithmetic-assignment">=</span><span class="string-literal">"normal"</span><span class="punctuation">,</span>
                                <span class="identifier">outline</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_cursor_color</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_idx</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">update_idletasks</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_control_click</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The action to perform when the user starts clicking and dragging the mouse whilst
        pressing the control button.

        For editing the mask this will activate the opposite action than what is currently selected
        (e.g. it will erase if draw is set and it will draw if erase is set)

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_start</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">,</span> <span class="identifier">control_click</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_drag_start</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">,</span> <span class="identifier">control_click</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=arguments-differ</span>
        <span class="comment">""" The action to perform when the user starts clicking and dragging the mouse.

        Paints on the mask with the appropriate draw or erase action.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        control_click: bool, optional
            Indicates whether the control button is depressed when drag has commenced. If ``True``
            then the opposite of the selected action is performed. Default: ``False``
        """</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">face_idx</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"starting_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"control_click"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">control_click</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"color"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_color</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">:</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">16</span><span class="grouping">)</span>
                                                      <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"opacity"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_opacity</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_paint</span>

    <span class="keyword">def</span> <span class="identifier">_paint</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Paint or erase from Mask and update cursor on click and drag.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event.
        """</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">line</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"starting_location"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">line</span><span class="punctuation">,</span> <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_transform_points</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">line</span><span class="grouping">)</span>
        <span class="identifier">brush_radius</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_brush_radius</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_edit_mode</span> <span class="relational-operator">==</span> <span class="string-literal">"erase"</span> <span class="keyword">else</span> <span class="int-literal">255</span>
        <span class="comment"># Reverse action on control click</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">color</span> <span class="arithmetic-operator">-</span> <span class="int-literal">255</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"control_click"</span><span class="grouping">]</span> <span class="keyword">else</span> <span class="identifier">color</span>
        <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">line</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"mask"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                 <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">line</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">line</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                 <span class="identifier">color</span><span class="punctuation">,</span>
                 <span class="identifier">brush_radius</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_mask_image</span><span class="grouping">(</span><span class="string-literal">"mask"</span><span class="punctuation">,</span>
                                <span class="identifier">face_idx</span><span class="punctuation">,</span>
                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"color"</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"opacity"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"starting_location"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_cursor</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_transform_points</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">points</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Transform the edit points from a full frame or zoomed view back to the mask.

        Parameters
        ----------
        face_index: int
            The index of the face within the current frame
        points: :class:`numpy.ndarray`
            The points that are to be translated from the viewer to the underlying
            Detected Face
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">is_zoomed</span><span class="punctuation">:</span>
            <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_roi</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_internal_size</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_zoomed_dims</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">t_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">points</span> <span class="arithmetic-operator">-</span> <span class="identifier">offset</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_internal_size</span> <span class="arithmetic-operator">/</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"mask_roi_size"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span>
            <span class="identifier">t_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">expand_dims</span><span class="grouping">(</span><span class="identifier">points</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">offset</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">t_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">t_points</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"affine_matrix"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_index</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">t_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">t_points</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"original points: %s, transformed points: %s, scale: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">t_points</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">t_points</span><span class="punctuation">,</span> <span class="identifier">scale</span>

    <span class="keyword">def</span> <span class="identifier">_drag_stop</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" The action to perform when the user stops clicking and dragging the mouse.

        If a line hasn't been drawn then draw a circle. Update alignments.

        Parameters
        ----------
        event: :class:`tkinter.Event`
            The tkinter mouse event. Unused but required
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">face_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">location</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">event</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_edit_mode</span> <span class="relational-operator">==</span> <span class="string-literal">"erase"</span> <span class="keyword">else</span> <span class="int-literal">255</span>
        <span class="comment"># Reverse action on control click</span>
        <span class="identifier">color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">color</span> <span class="arithmetic-operator">-</span> <span class="int-literal">255</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"control_click"</span><span class="grouping">]</span> <span class="keyword">else</span> <span class="identifier">color</span>
        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array_equal</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span><span class="grouping">[</span><span class="string-literal">"starting_location"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_transform_points</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="punctuation">,</span> <span class="identifier">location</span><span class="grouping">)</span>
            <span class="identifier">brush_radius</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">round</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_brush_radius</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">circle</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"mask"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">face_idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">points</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">brush_radius</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="punctuation">,</span>
                       <span class="identifier">thickness</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_to_alignments</span><span class="grouping">(</span><span class="identifier">face_idx</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_drag_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_update_cursor</span><span class="grouping">(</span><span class="identifier">event</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_mask_to_alignments</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Update the annotated mask to alignments.

        Parameters
        ----------
        face_index: int
            The index of the face in the current frame
        """</span>
        <span class="identifier">mask_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"display"]["MaskType"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_meta</span><span class="grouping">[</span><span class="string-literal">"mask"][face_index].astype("float32"</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">255.0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_det_faces</span><span class="punctuation">.</span><span class="identifier">update</span><span class="punctuation">.</span><span class="identifier">mask</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_globals</span><span class="punctuation">.</span><span class="identifier">frame_index</span><span class="punctuation">,</span> <span class="identifier">face_index</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">mask_type</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_adjust_brush_radius</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">increase</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">""" Adjust the brush radius up or down by 2px.

        Sets the control panel option for brush radius to 2 less or 2 more than its current value

        Parameters
        ----------
        increase: bool, optional
            ``True`` to increment brush radius, ``False`` to decrement. Default: ``True``
        """</span>
        <span class="identifier">radius_var</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_control_vars</span><span class="grouping">[</span><span class="string-literal">"brush"]["BrushSize"</span><span class="grouping">]</span>
        <span class="identifier">current_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">radius_var</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">new_val</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">current_val</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">increase</span> <span class="keyword">else</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">current_val</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Adjusting brush radius from %s to %s"</span><span class="punctuation">,</span> <span class="identifier">current_val</span><span class="punctuation">,</span> <span class="identifier">new_val</span><span class="grouping">)</span>
        <span class="identifier">radius_var</span><span class="punctuation">.</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">new_val</span><span class="grouping">)</span>

        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_val</span> <span class="arithmetic-operator">-</span> <span class="identifier">current_val</span>
        <span class="keyword">if</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">current_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">new_coords</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">coord</span> <span class="arithmetic-operator">-</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="keyword">if</span> <span class="identifier">idx</span> <span class="relational-operator">&lt;</span> <span class="int-literal">2</span> <span class="keyword">else</span> <span class="identifier">coord</span> <span class="arithmetic-operator">+</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span>
                           <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">coord</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">current_coords</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Adjusting brush coordinates from %s to %s"</span><span class="punctuation">,</span> <span class="identifier">current_coords</span><span class="punctuation">,</span> <span class="identifier">new_coords</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_canvas</span><span class="punctuation">.</span><span class="identifier">coords</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mouse_location</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">new_coords</span><span class="grouping">)</span>

    </pre>
  </body>
</html>