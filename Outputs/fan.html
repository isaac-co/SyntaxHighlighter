<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Facial landmarks extractor for faceswap.py
    Code adapted and modified from:
    https://github.com/1adrianb/face-alignment
"""</span>
<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">session</span> <span class="keyword">import</span> <span class="identifier">KSession</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">Aligner</span><span class="punctuation">,</span> <span class="identifier">logger</span>


<span class="keyword">class</span> <span class="identifier">Align</span><span class="grouping">(</span><span class="identifier">Aligner</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Perform transformation to align and get landmarks """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">git_model_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">13</span>
        <span class="identifier">model_filename</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"face-alignment-network_2d4_keras_v2.h5"</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">git_model_id</span><span class="arithmetic-assignment">=</span><span class="identifier">git_model_id</span><span class="punctuation">,</span> <span class="identifier">model_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">model_filename</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"FAN"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">color_format</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"RGB"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2240</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram_warnings</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">512</span>  <span class="comment"># Will run at this with warnings</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram_per_batch</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">64</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">batchsize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"batch-size"</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reference_scale</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">200</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="int-literal">195</span><span class="punctuation">.</span>

    <span class="keyword">def</span> <span class="identifier">init_model</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize FAN model """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KSession</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">,</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_path</span><span class="punctuation">,</span>
                              <span class="identifier">allow_growth</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"allow_growth"</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">load_model</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="comment"># Feed a placeholder so Aligner is primed for Manual tool</span>
        <span class="identifier">placeholder_shape</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">batchsize</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">placeholder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">placeholder_shape</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">placeholder</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process_input</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile the detected faces for prediction """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Aligning faces around center"</span><span class="grouping">)</span>
        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"center_scale"] = self.get_center_scale(batch["detected_faces"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">crop</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Aligned image around center"</span><span class="grouping">)</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_normalize_faces</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>
        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"feed"] = np.array(faces, dtype="float32"</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="float-literal">255.0</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">get_center_scale</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get the center and set scale of bounding box """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Calculating center and scale"</span><span class="grouping">)</span>
        <span class="identifier">center_scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">68</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">index</span><span class="punctuation">,</span> <span class="identifier">face</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">detected_faces</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">x_center</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">left</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span>
            <span class="identifier">y_center</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">top</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">bottom</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">-</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">h</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.12</span>
            <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">w</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">h</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">reference_scale</span>
            <span class="identifier">center_scale</span><span class="grouping">[</span><span class="identifier">index</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="identifier">x_center</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
            <span class="identifier">center_scale</span><span class="grouping">[</span><span class="identifier">index</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="identifier">y_center</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
            <span class="identifier">center_scale</span><span class="grouping">[</span><span class="identifier">index</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="int-literal">68</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Calculated center and scale: %s"</span><span class="punctuation">,</span> <span class="identifier">center_scale</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">center_scale</span>

    <span class="keyword">def</span> <span class="identifier">crop</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-many-locals</span>
        <span class="comment">""" Crop image around the center point """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Cropping images"</span><span class="grouping">)</span>
        <span class="identifier">sizes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="grouping">)</span>
        <span class="identifier">batch_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"center_scale"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">resolutions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">batch_shape</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">matrix_ones</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">batch_shape</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">matrix_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">batch_shape</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">matrix_size</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
        <span class="identifier">upper_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">matrix_ones</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"center_scale"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">resolutions</span><span class="grouping">)</span>
        <span class="identifier">bot_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">matrix_size</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"center_scale"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">resolutions</span><span class="grouping">)</span>

        <span class="comment"># TODO second pass .. convert to matrix</span>
        <span class="identifier">new_images</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">bottom_right</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"image"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">upper_left</span><span class="punctuation">,</span> <span class="identifier">bot_right</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="identifier">channels</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="keyword">if</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">&gt;</span> <span class="int-literal">2</span> <span class="keyword">else</span> <span class="int-literal">1</span>
            <span class="identifier">bottom_right_width</span><span class="punctuation">,</span> <span class="identifier">bottom_right_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bottom_right</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int32'</span><span class="grouping">)</span>
            <span class="identifier">top_left_width</span><span class="punctuation">,</span> <span class="identifier">top_left_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">top_left</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'int32'</span><span class="grouping">)</span>
            <span class="identifier">new_dim</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bottom_right_height</span> <span class="arithmetic-operator">-</span> <span class="identifier">top_left_height</span><span class="punctuation">,</span>
                       <span class="identifier">bottom_right_width</span> <span class="arithmetic-operator">-</span> <span class="identifier">top_left_width</span><span class="punctuation">,</span>
                       <span class="identifier">channels</span><span class="grouping">)</span>
            <span class="identifier">new_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="identifier">new_dim</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">uint8</span><span class="grouping">)</span>

            <span class="identifier">new_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">top_left_width</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">bottom_right_width</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">top_left_width</span><span class="grouping">)</span>
            <span class="identifier">new_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">top_left_height</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">bottom_right_height</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">top_left_height</span><span class="grouping">)</span>
            <span class="identifier">old_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">top_left_width</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">bottom_right_width</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">old_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">top_left_height</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">bottom_right_height</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">new_img</span><span class="grouping">[</span><span class="identifier">new_y</span><span class="punctuation">,</span> <span class="identifier">new_x</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="grouping">[</span><span class="identifier">old_y</span><span class="punctuation">,</span> <span class="identifier">old_x</span><span class="grouping">]</span>

            <span class="identifier">interp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_CUBIC</span> <span class="keyword">if</span> <span class="identifier">new_dim</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span> <span class="keyword">else</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span>
            <span class="identifier">new_images</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">new_img</span><span class="punctuation">,</span> <span class="identifier">dsize</span><span class="arithmetic-assignment">=</span><span class="identifier">sizes</span><span class="punctuation">,</span> <span class="identifier">interpolation</span><span class="arithmetic-assignment">=</span><span class="identifier">interp</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Cropped images"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">new_images</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">points</span><span class="punctuation">,</span> <span class="identifier">center_scales</span><span class="punctuation">,</span> <span class="identifier">resolutions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Transform Image """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Transforming Points"</span><span class="grouping">)</span>
        <span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">points</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">transform_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">transform_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">transform_matrix</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">transform_matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">transform_matrix</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">scales</span> <span class="arithmetic-assignment">=</span> <span class="identifier">center_scales</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">resolutions</span>
        <span class="identifier">translations</span> <span class="arithmetic-assignment">=</span> <span class="identifier">center_scales</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="float-literal">-0.5</span> <span class="arithmetic-operator">+</span> <span class="identifier">center_scales</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">transform_matrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scales</span>  <span class="comment"># x scale</span>
        <span class="identifier">transform_matrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scales</span>  <span class="comment"># y scale</span>
        <span class="identifier">transform_matrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">translations</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>  <span class="comment"># x translation</span>
        <span class="identifier">transform_matrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">translations</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>  <span class="comment"># y translation</span>
        <span class="identifier">new_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">einsum</span><span class="grouping">(</span><span class="string-literal">'abij, abj -&gt; abi', transform_matrix, points, optimize='greedy'</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_points</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Transformed Points: %s"</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Predict the 68 point landmarks """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Predicting Landmarks"</span><span class="grouping">)</span>
        <span class="comment"># TODO Remove lazy transpose and change points from predict to use the correct</span>
        <span class="comment"># order</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">process_output</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Process the output from the model """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">get_pts_from_predict</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">get_pts_from_predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Get points from predictor """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Obtain points from prediction"</span><span class="grouping">)</span>
        <span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"prediction"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span>
        <span class="identifier">image_slice</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">num_images</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">landmark_slice</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">num_landmarks</span><span class="grouping">)</span><span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">resolution</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">64</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'int32'</span><span class="grouping">)</span>
        <span class="identifier">subpixel_landmarks</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>

        <span class="identifier">flat_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"prediction"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">num_images</span><span class="punctuation">,</span> <span class="identifier">num_landmarks</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unravel_index</span><span class="grouping">(</span><span class="identifier">flat_indices</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">min_clipped</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">indices</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">height</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">max_clipped</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">indices</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">offsets</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">image_slice</span><span class="punctuation">,</span> <span class="identifier">landmark_slice</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">min_clipped</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="grouping">(</span><span class="identifier">image_slice</span><span class="punctuation">,</span> <span class="identifier">landmark_slice</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">max_clipped</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="grouping">(</span><span class="identifier">image_slice</span><span class="punctuation">,</span> <span class="identifier">landmark_slice</span><span class="punctuation">,</span> <span class="identifier">min_clipped</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="grouping">(</span><span class="identifier">image_slice</span><span class="punctuation">,</span> <span class="identifier">landmark_slice</span><span class="punctuation">,</span> <span class="identifier">max_clipped</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">x_subpixel_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"prediction"][offsets[0]] - batch["prediction"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">offsets</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">y_subpixel_shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"prediction"][offsets[2]] - batch["prediction"</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">offsets</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="comment"># TODO improve rudimentary sub-pixel logic to centroid of 3x3 window algorithm</span>
        <span class="identifier">subpixel_landmarks</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">x_subpixel_shift</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.25</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span>
        <span class="identifier">subpixel_landmarks</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sign</span><span class="grouping">(</span><span class="identifier">y_subpixel_shift</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.25</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span>

        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"landmarks"] = self.transform(subpixel_landmarks, batch["center_scale"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">resolution</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Obtained points from prediction: %s", batch["landmarks"</span><span class="grouping">]</span><span class="grouping">)</span>

    </pre>
  </body>
</html>