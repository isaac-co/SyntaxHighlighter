<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
=================================================================
Permutation Importance with Multicollinear or Correlated Features
=================================================================

In this example, we compute the permutation importance on the Wisconsin
breast cancer dataset using :func:`~sklearn.inspection.permutation_importance`.
The :class:`~sklearn.ensemble.RandomForestClassifier` can easily get about 97%
accuracy on a test dataset. Because this dataset contains multicollinear
features, the permutation importance will show that none of the features are
important. One approach to handling multicollinearity is by performing
hierarchical clustering on the features' Spearman rank-order correlations,
picking a threshold, and keeping a single feature from each cluster.

.. note::
    See also
    :ref:`sphx_glr_auto_examples_inspection_plot_permutation_importance.py`
"""</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="identifier">__doc__</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">collections</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span>

<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">stats</span> <span class="keyword">import</span> <span class="identifier">spearmanr</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">hierarchy</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">load_breast_cancer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">ensemble</span> <span class="keyword">import</span> <span class="identifier">RandomForestClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">inspection</span> <span class="keyword">import</span> <span class="identifier">permutation_importance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>

<span class="comment"># %%</span>
<span class="comment"># Random Forest Feature Importance on Breast Cancer Data</span>
<span class="comment"># ------------------------------------------------------</span>
<span class="comment"># First, we train a random forest on the breast cancer dataset and evaluate</span>
<span class="comment"># its accuracy on a test set:</span>
<span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_breast_cancer</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">target</span>
<span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

<span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
<span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Accuracy on test data: {:.2f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Next, we plot the tree based feature importance and the permutation</span>
<span class="comment"># importance. The permutation importance plot shows that permuting a feature</span>
<span class="comment"># drops the accuracy by at most `0.012`, which would suggest that none of the</span>
<span class="comment"># features are important. This is in contradiction with the high test accuracy</span>
<span class="comment"># computed above: some feature must be important. The permutation importance</span>
<span class="comment"># is calculated on the training set to show how much the model relies on each</span>
<span class="comment"># feature during training.</span>
<span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">permutation_importance</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">n_repeats</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
<span class="identifier">perm_sorted_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">result</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">n</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">tree_importance_sorted_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>
<span class="identifier">tree_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span>

<span class="identifier">fig</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">ax1</span><span class="punctuation">,</span> <span class="identifier">ax2</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">barh</span><span class="grouping">(</span><span class="identifier">tree_indices</span><span class="punctuation">,</span>
         <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">[</span><span class="identifier">tree_importance_sorted_idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.7</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_yticks</span><span class="grouping">(</span><span class="identifier">tree_indices</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_yticklabels</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">tree_importance_sorted_idx</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax1</span><span class="punctuation">.</span><span class="identifier">set_ylim</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">boxplot</span><span class="grouping">(</span><span class="identifier">result</span><span class="punctuation">.</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">[</span><span class="identifier">perm_sorted_idx</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">vert</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
            <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="grouping">[</span><span class="identifier">perm_sorted_idx</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">fig</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Handling Multicollinear Features</span>
<span class="comment"># --------------------------------</span>
<span class="comment"># When features are collinear, permutating one feature will have little</span>
<span class="comment"># effect on the models performance because it can get the same information</span>
<span class="comment"># from a correlated feature. One way to handle multicollinear features is by</span>
<span class="comment"># performing hierarchical clustering on the Spearman rank-order correlations,</span>
<span class="comment"># picking a threshold, and keeping a single feature from each cluster. First,</span>
<span class="comment"># we plot a heatmap of the correlated features:</span>
<span class="identifier">fig</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">ax1</span><span class="punctuation">,</span> <span class="identifier">ax2</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">subplots</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">figsize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">corr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spearmanr</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">correlation</span>
<span class="identifier">corr_linkage</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hierarchy</span><span class="punctuation">.</span><span class="identifier">ward</span><span class="grouping">(</span><span class="identifier">corr</span><span class="grouping">)</span>
<span class="identifier">dendro</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hierarchy</span><span class="punctuation">.</span><span class="identifier">dendrogram</span><span class="grouping">(</span>
    <span class="identifier">corr_linkage</span><span class="punctuation">,</span> <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">feature_names</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ax</span><span class="arithmetic-assignment">=</span><span class="identifier">ax1</span><span class="punctuation">,</span> <span class="identifier">leaf_rotation</span><span class="arithmetic-assignment">=</span><span class="int-literal">90</span>
<span class="grouping">)</span>
<span class="identifier">dendro_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">dendro</span><span class="grouping">[</span><span class="string-literal">'ivl'</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">imshow</span><span class="grouping">(</span><span class="identifier">corr</span><span class="grouping">[</span><span class="identifier">dendro</span><span class="grouping">[</span><span class="string-literal">'leaves'], :][:, dendro['leaves'</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_xticks</span><span class="grouping">(</span><span class="identifier">dendro_idx</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_yticks</span><span class="grouping">(</span><span class="identifier">dendro_idx</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_xticklabels</span><span class="grouping">(</span><span class="identifier">dendro</span><span class="grouping">[</span><span class="string-literal">'ivl'], rotation='vertical'</span><span class="grouping">)</span>
<span class="identifier">ax2</span><span class="punctuation">.</span><span class="identifier">set_yticklabels</span><span class="grouping">(</span><span class="identifier">dendro</span><span class="grouping">[</span><span class="string-literal">'ivl'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="identifier">fig</span><span class="punctuation">.</span><span class="identifier">tight_layout</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="comment"># %%</span>
<span class="comment"># Next, we manually pick a threshold by visual inspection of the dendrogram</span>
<span class="comment"># to group our features into clusters and choose a feature from each cluster to</span>
<span class="comment"># keep, select those features from our dataset, and train a new random forest.</span>
<span class="comment"># The test accuracy of the new random forest did not change much compared to</span>
<span class="comment"># the random forest trained on the complete dataset.</span>
<span class="identifier">cluster_ids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hierarchy</span><span class="punctuation">.</span><span class="identifier">fcluster</span><span class="grouping">(</span><span class="identifier">corr_linkage</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">'distance'</span><span class="grouping">)</span>
<span class="identifier">cluster_id_to_feature_ids</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">)</span>
<span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">cluster_id</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">cluster_ids</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cluster_id_to_feature_ids</span><span class="grouping">[</span><span class="identifier">cluster_id</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
<span class="identifier">selected_features</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">v</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cluster_id_to_feature_ids</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

<span class="identifier">X_train_sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_train</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">selected_features</span><span class="grouping">]</span>
<span class="identifier">X_test_sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_test</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">selected_features</span><span class="grouping">]</span>

<span class="identifier">clf_sel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RandomForestClassifier</span><span class="grouping">(</span><span class="identifier">n_estimators</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
<span class="identifier">clf_sel</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train_sel</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
<span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"Accuracy on test data with features removed: {:.2f}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
      <span class="identifier">clf_sel</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test_sel</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>