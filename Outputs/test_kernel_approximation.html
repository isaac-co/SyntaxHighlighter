<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">re</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csr_matrix</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">kernel_metrics</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">kernel_approximation</span> <span class="keyword">import</span> <span class="identifier">RBFSampler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">kernel_approximation</span> <span class="keyword">import</span> <span class="identifier">AdditiveChi2Sampler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">kernel_approximation</span> <span class="keyword">import</span> <span class="identifier">SkewedChi2Sampler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">kernel_approximation</span> <span class="keyword">import</span> <span class="identifier">Nystroem</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">kernel_approximation</span> <span class="keyword">import</span> <span class="identifier">PolynomialCountSketch</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="keyword">import</span> <span class="identifier">polynomial_kernel</span><span class="punctuation">,</span> <span class="identifier">rbf_kernel</span><span class="punctuation">,</span> <span class="identifier">chi2_kernel</span>

<span class="comment"># generate data</span>
<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">300</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
<span class="identifier">Y</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'degree'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_count_sketch_raises_if_degree_lower_than_one</span><span class="grouping">(</span><span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">'degree={degree} should be &gt;=1.'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ps_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialCountSketch</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="grouping">)</span>
        <span class="identifier">ps_transform</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'X'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'Y'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'gamma'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'degree'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'coef0'</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_count_sketch</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">coef0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that PolynomialCountSketch approximates polynomial</span>
    <span class="comment"># kernel on random data</span>

    <span class="comment"># compute exact kernel</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">polynomial_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">coef0</span><span class="arithmetic-assignment">=</span><span class="identifier">coef0</span><span class="grouping">)</span>

    <span class="comment"># approximate kernel mapping</span>
    <span class="identifier">ps_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialCountSketch</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">5000</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span>
                                         <span class="identifier">coef0</span><span class="arithmetic-assignment">=</span><span class="identifier">coef0</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
                                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ps_transform</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ps_transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">kernel_approx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">Y_trans</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span> <span class="arithmetic-operator">-</span> <span class="identifier">kernel_approx</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">error</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.05</span>  <span class="comment"># close to unbiased</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">error</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">error</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">error</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.1</span>  <span class="comment"># nothing too far off</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">error</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.05</span>  <span class="comment"># mean is fairly close</span>


<span class="keyword">def</span> <span class="identifier">_linear_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_additive_chi2_sampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that AdditiveChi2Sampler approximates kernel on random data</span>

    <span class="comment"># compute exact kernel</span>
    <span class="comment"># abbreviations for easier formula</span>
    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">Y_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>

    <span class="identifier">large_kernel</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_</span> <span class="arithmetic-operator">*</span> <span class="identifier">Y_</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">X_</span> <span class="arithmetic-operator">+</span> <span class="identifier">Y_</span><span class="grouping">)</span>

    <span class="comment"># reduce to n_samples_x x n_samples_y by summing over features</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">large_kernel</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># approximate kernel mapping</span>
    <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AdditiveChi2Sampler</span><span class="grouping">(</span><span class="identifier">sample_steps</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">kernel_approx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">Y_trans</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">kernel_approx</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">X_sp_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Y_sp_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">X_sp_trans</span><span class="punctuation">.</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Y_trans</span><span class="punctuation">,</span> <span class="identifier">Y_sp_trans</span><span class="punctuation">.</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="comment"># test error is raised on negative input</span>
    <span class="identifier">Y_neg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">Y_neg</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'Negative values in data passed to'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Y_neg</span><span class="grouping">)</span>

    <span class="comment"># test error on invalid sample_steps</span>
    <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AdditiveChi2Sampler</span><span class="grouping">(</span><span class="identifier">sample_steps</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"If sample_steps is not in [1, 2, 3],"</span>
        <span class="string-literal">" you need to provide sample_interval"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test that the sample interval is set correctly</span>
    <span class="identifier">sample_steps_available</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">sample_steps</span> <span class="relational-operator">in</span> <span class="identifier">sample_steps_available</span><span class="punctuation">:</span>

        <span class="comment"># test that the sample_interval is initialized correctly</span>
        <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AdditiveChi2Sampler</span><span class="grouping">(</span><span class="identifier">sample_steps</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_steps</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">sample_interval</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

        <span class="comment"># test that the sample_interval is changed in the fit method</span>
        <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">sample_interval_</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span>

    <span class="comment"># test that the sample_interval is set correctly</span>
    <span class="identifier">sample_interval</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.3</span>
    <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AdditiveChi2Sampler</span><span class="grouping">(</span><span class="identifier">sample_steps</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                                    <span class="identifier">sample_interval</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_interval</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">sample_interval</span> <span class="relational-operator">==</span> <span class="identifier">sample_interval</span>
    <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">sample_interval_</span> <span class="relational-operator">==</span> <span class="identifier">sample_interval</span>


<span class="keyword">def</span> <span class="identifier">test_skewed_chi2_sampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that RBFSampler approximates kernel on random data</span>

    <span class="comment"># compute exact kernel</span>
    <span class="identifier">c</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.03</span>
    <span class="comment"># set on negative component but greater than c to ensure that the kernel</span>
    <span class="comment"># approximation is valid on the group (-c; +\infty) endowed with the skewed</span>
    <span class="comment"># multiplication.</span>
    <span class="identifier">Y</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">c</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span>

    <span class="comment"># abbreviations for easier formula</span>
    <span class="identifier">X_c</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="identifier">c</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">Y_c</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">Y</span> <span class="arithmetic-operator">+</span> <span class="identifier">c</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>

    <span class="comment"># we do it in log-space in the hope that it's more stable</span>
    <span class="comment"># this array is n_samples_x x n_samples_y big x n_features</span>
    <span class="identifier">log_kernel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">X_c</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">Y_c</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span>
                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">X_c</span> <span class="arithmetic-operator">+</span> <span class="identifier">Y_c</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># reduce to n_samples_x x n_samples_y by summing over features in log-space</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">log_kernel</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># approximate kernel mapping</span>
    <span class="identifier">transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SkewedChi2Sampler</span><span class="grouping">(</span><span class="identifier">skewedness</span><span class="arithmetic-assignment">=</span><span class="identifier">c</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span>
                                  <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>

    <span class="identifier">kernel_approx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">Y_trans</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">kernel_approx</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">\</span>
        <span class="string-literal">'NaNs found in the Gram matrix'</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">kernel_approx</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="invalid">\</span>
        <span class="string-literal">'NaNs found in the approximate Gram matrix'</span>

    <span class="comment"># test error is raised on when inputs contains values smaller than -c</span>
    <span class="identifier">Y_neg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Y</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">Y_neg</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">c</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">.</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'X may not contain entries smaller than -skewedness'</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Y_neg</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_additive_chi2_sampler_exceptions</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Ensures correct error message"""</span>
    <span class="identifier">transformer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">AdditiveChi2Sampler</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_neg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_neg</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"X in AdditiveChi2Sampler.fit"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_neg</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"X in AdditiveChi2Sampler.transform"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_neg</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rbf_sampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that RBFSampler approximates kernel on random data</span>
    <span class="comment"># compute exact kernel</span>
    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">.</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="grouping">)</span>

    <span class="comment"># approximate kernel mapping</span>
    <span class="identifier">rbf_transform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBFSampler</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_transform</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Y_trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_transform</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">kernel_approx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_trans</span><span class="punctuation">,</span> <span class="identifier">Y_trans</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="identifier">error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span> <span class="arithmetic-operator">-</span> <span class="identifier">kernel_approx</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">error</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.01</span>  <span class="comment"># close to unbiased</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">error</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">error</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">error</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.1</span>  <span class="comment"># nothing too far off</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">error</span><span class="grouping">)</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.05</span>  <span class="comment"># mean is fairly close</span>


<span class="keyword">def</span> <span class="identifier">test_input_validation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test: kernel approx. transformers should work on lists</span>
    <span class="comment"># No assertions; the old versions would simply crash</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">AdditiveChi2Sampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">SkewedChi2Sampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">RBFSampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">RBFSampler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nystroem_approximation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># some basic tests</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># With n_components = n_samples this is exact</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K</span><span class="grouping">)</span>

    <span class="identifier">trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rnd</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trans</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># test callable kernel</span>
    <span class="identifier">trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">_linear_kernel</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rnd</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trans</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># test that available kernels fit and transform</span>
    <span class="identifier">kernels_available</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel_metrics</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">kern</span> <span class="relational-operator">in</span> <span class="identifier">kernels_available</span><span class="punctuation">:</span>
        <span class="identifier">trans</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">kern</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rnd</span><span class="grouping">)</span>
        <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">trans</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nystroem_default_parameters</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># rbf kernel should behave as gamma=None by default</span>
    <span class="comment"># aka gamma = 1 / n_features</span>
    <span class="identifier">nystroem</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nystroem</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="comment"># chi2 kernel should behave as gamma=1 by default</span>
    <span class="identifier">nystroem</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'chi2'</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nystroem</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">chi2_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nystroem_singular_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that nystroem works with singular kernel matrix</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span>  <span class="comment"># duplicate samples</span>

    <span class="identifier">gamma</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">N</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">N</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rbf_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="identifier">gamma</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">Y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nystroem_poly_kernel_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression: Nystroem should pass other parameters beside gamma.</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">37</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">polynomial_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="float-literal">3.1</span><span class="punctuation">,</span> <span class="identifier">coef0</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="grouping">)</span>
    <span class="identifier">nystroem</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">"polynomial"</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="float-literal">3.1</span><span class="punctuation">,</span> <span class="identifier">coef0</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nystroem</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nystroem_callable</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Nystroem on a callable.</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">logging_histogram_kernel</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">log</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Histogram kernel that writes to a log."""</span>
        <span class="identifier">log</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">kernel_log</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>     <span class="comment"># test input validation</span>
    <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">logging_histogram_kernel</span><span class="punctuation">,</span>
             <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
             <span class="identifier">kernel_params</span><span class="arithmetic-assignment">=</span><span class="grouping">{</span><span class="string-literal">'log'</span><span class="punctuation">:</span> <span class="identifier">kernel_log</span><span class="grouping">}</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">kernel_log</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>

    <span class="comment"># if degree, gamma or coef0 is passed, we raise a warning</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Don't pass gamma, coef0 or degree to Nystroem"</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'gamma': 1}, {'coef0': 1}, {'degree'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">param</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="identifier">ny</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="identifier">_linear_kernel</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">param</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ny</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nystroem_precomputed_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Non-regression: test Nystroem on precomputed kernel.</span>
    <span class="comment"># PR - 14706</span>
    <span class="identifier">rnd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">12</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rnd</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">polynomial_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">coef0</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="grouping">)</span>
    <span class="identifier">nystroem</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X_transformed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nystroem</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X_transformed</span><span class="punctuation">,</span> <span class="identifier">X_transformed</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">K</span><span class="grouping">)</span>

    <span class="comment"># if degree, gamma or coef0 is passed, we raise a ValueError</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Don't pass gamma, coef0 or degree to Nystroem"</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">'gamma': 1}, {'coef0': 1}, {'degree'</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">param</span> <span class="relational-operator">in</span> <span class="identifier">params</span><span class="punctuation">:</span>
        <span class="identifier">ny</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Nystroem</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'precomputed'</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="arithmetic-operator">**</span><span class="identifier">param</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ny</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span>

    </pre>
  </body>
</html>