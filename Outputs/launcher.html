<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Launches the correct script with the given Command Line Arguments """</span>
<span class="keyword">import</span> <span class="identifier">logging</span>
<span class="keyword">import</span> <span class="identifier">os</span>
<span class="keyword">import</span> <span class="identifier">platform</span>
<span class="keyword">import</span> <span class="identifier">sys</span>

<span class="keyword">from</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">b</span> <span class="keyword">import</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">e</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">gpu_stats</span> <span class="keyword">import</span> <span class="identifier">set_exclude_devices</span><span class="punctuation">,</span> <span class="identifier">GPUStats</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">logger</span> <span class="keyword">import</span> <span class="identifier">crash_log</span><span class="punctuation">,</span> <span class="identifier">log_setup</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">FaceswapError</span><span class="punctuation">,</span> <span class="identifier">get_backend</span><span class="punctuation">,</span> <span class="identifier">KerasFinder</span><span class="punctuation">,</span> <span class="identifier">safe_shutdown</span><span class="punctuation">,</span> <span class="identifier">set_backend</span><span class="punctuation">,</span>
                       <span class="identifier">set_system_verbosity</span><span class="grouping">)</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">ScriptExecutor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=too-few-public-methods</span>
    <span class="comment">""" Loads the relevant script modules and executes the script.

        This class is initialized in each of the argparsers for the relevant
        command, then execute script is called within their set_default
        function.

        Parameters
        ----------
        command: str
            The faceswap command that is being executed
        """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">command</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span> <span class="arithmetic-assignment">=</span> <span class="identifier">command</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_import_script</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Imports the relevant script as indicated by :attr:`_command` from the scripts folder.

        Returns
        -------
        class: Faceswap Script
            The uninitialized script from the faceswap scripts folder.
        """</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_test_for_tf_version</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_test_for_gui</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">cmd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">basename</span><span class="grouping">(</span><span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">argv</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">src</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"tools.{}".format(self._command.lower()) if cmd == "tools.py" else "scripts"</span>
        <span class="identifier">mod</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"."</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span><span class="punctuation">.</span><span class="identifier">lower</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">module</span> <span class="arithmetic-assignment">=</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">mod</span><span class="grouping">)</span>
        <span class="identifier">script</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">module</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span><span class="punctuation">.</span><span class="identifier">title</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">script</span>

    <span class="keyword">def</span> <span class="identifier">_test_for_tf_version</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check that the required Tensorflow version is installed.

        Raises
        ------
        FaceswapError
            If Tensorflow is not found, or is not between versions 2.2 and 2.4
        """</span>
        <span class="identifier">min_ver</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.2</span>
        <span class="identifier">max_ver</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.4</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="comment"># Ensure tensorflow doesn't pin all threads to one core when using Math Kernel Library</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">environ</span><span class="grouping">[</span><span class="string-literal">"TF_MIN_GPU_MULTIPROCESSOR_COUNT"] = "4"</span>
            <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">environ</span><span class="grouping">[</span><span class="string-literal">"KMP_AFFINITY"] = "disabled"</span>
            <span class="keyword">import</span> <span class="identifier">tensorflow</span> <span class="keyword">as</span> <span class="identifier">tf</span>  <span class="comment"># pylint:disable=import-outside-toplevel</span>
        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="string-literal">"DLL load failed while importing"</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                    <span class="string-literal">"A DLL library file failed to load. Make sure that you have Microsoft Visual "</span>
                    <span class="string-literal">"C++ Redistributable (2015, 2017, 2019) installed for your machine from: "</span>
                    <span class="string-literal">"https://support.microsoft.com/en-gb/help/2977003"</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                    <span class="string-literal">"There was an error importing Tensorflow. This is most likely because you do "</span>
                    <span class="string-literal">"not have TensorFlow installed, or you are trying to run tensorflow-gpu on a "</span>
                    <span class="string-literal">"system without an Nvidia graphics card. Original import "</span>
                    <span class="string-literal">"error: {}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_handle_import_error</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>

        <span class="identifier">tf_ver</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="string-literal">".".join(tf.__version__.split("."</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=no-member</span>
        <span class="keyword">if</span> <span class="identifier">tf_ver</span> <span class="relational-operator">&lt;</span> <span class="identifier">min_ver</span><span class="punctuation">:</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The minimum supported Tensorflow is version {} but you have version {} "</span>
                   <span class="string-literal">"installed. Please upgrade Tensorflow."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">min_ver</span><span class="punctuation">,</span> <span class="identifier">tf_ver</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_handle_import_error</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">tf_ver</span> <span class="relational-operator">&gt;</span> <span class="identifier">max_ver</span><span class="punctuation">:</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"The maximum supported Tensorflow is version {} but you have version {} "</span>
                   <span class="string-literal">"installed. Please downgrade Tensorflow."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">max_ver</span><span class="punctuation">,</span> <span class="identifier">tf_ver</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_handle_import_error</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Installed Tensorflow Version: %s"</span><span class="punctuation">,</span> <span class="identifier">tf_ver</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_handle_import_error</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Display the error message to the console and wait for user input to dismiss it, if
        running GUI under Windows, otherwise use standard error handling.

        Parameters
        ----------
        message: str
            The error message to display
        """</span>
        <span class="keyword">if</span> <span class="string-literal">"gui" in sys.argv and platform.system() == "Windows"</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="identifier">message</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Press \"ENTER\" to dismiss the message and close FaceSwap"</span><span class="grouping">)</span>
            <span class="identifier">input</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="identifier">message</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_test_for_gui</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" If running the gui, performs check to ensure necessary prerequisites are present. """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span> <span class="relational-operator">!=</span> <span class="string-literal">"gui"</span><span class="punctuation">:</span>
            <span class="keyword">return</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_test_tkinter</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_check_display</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_test_tkinter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" If the user is running the GUI, test whether the tkinter app is available on their
        machine. If not exit gracefully.

        This avoids having to import every tkinter function within the GUI in a wrapper and
        potentially spamming traceback errors to console.

        Raises
        ------
        FaceswapError
            If tkinter cannot be imported
        """</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="comment"># pylint: disable=unused-variable</span>
            <span class="keyword">import</span> <span class="identifier">tkinter</span>  <span class="comment"># noqa pylint: disable=unused-import,import-outside-toplevel</span>
        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"It looks like TkInter isn't installed for your OS, so the GUI has been "</span>
                         <span class="string-literal">"disabled. To enable the GUI please install the TkInter application. You "</span>
                         <span class="string-literal">"can try:"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Anaconda: conda install tk"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Windows/macOS: Install ActiveTcl Community Edition from "</span>
                        <span class="string-literal">"http://www.activestate.com"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Ubuntu/Mint/Debian: sudo apt install python3-tk"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Arch: sudo pacman -S tk"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"CentOS/Redhat: sudo yum install tkinter"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Fedora: sudo dnf install python3-tkinter"</span><span class="grouping">)</span>
            <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="string-literal">"TkInter not found"</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_check_display</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Check whether there is a display to output the GUI to.

        If running on Windows then it is assumed that we are not running in headless mode

        Raises
        ------
        FaceswapError
            If a DISPLAY environmental cannot be found
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">environ</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"DISPLAY", None) and os.name != "nt"</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">platform</span><span class="punctuation">.</span><span class="identifier">system</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"Darwin"</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"macOS users need to install XQuartz. "</span>
                            <span class="string-literal">"See https://support.apple.com/en-gb/HT201341"</span><span class="grouping">)</span>
            <span class="keyword">raise</span> <span class="identifier">FaceswapError</span><span class="grouping">(</span><span class="string-literal">"No display detected. GUI mode has been disabled."</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">execute_script</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Performs final set up and launches the requested :attr:`_command` with the given
        command line arguments.

        Monitors for errors and attempts to shut down the process cleanly on exit.

        Parameters
        ----------
        arguments: :class:`argparse.Namespace`
            The command line arguments to be passed to the executing script.
        """</span>
        <span class="identifier">set_system_verbosity</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">loglevel</span><span class="grouping">)</span>
        <span class="identifier">is_gui</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"redirect_gui"</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">redirect_gui</span>
        <span class="identifier">log_setup</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">loglevel</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">logfile</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span><span class="punctuation">,</span> <span class="identifier">is_gui</span><span class="grouping">)</span>
        <span class="identifier">success</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span> <span class="relational-operator">!=</span> <span class="string-literal">"gui"</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_configure_backend</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="grouping">)</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">script</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_import_script</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">process</span> <span class="arithmetic-assignment">=</span> <span class="identifier">script</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="grouping">)</span>
            <span class="identifier">process</span><span class="punctuation">.</span><span class="identifier">process</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">success</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="keyword">except</span> <span class="identifier">FaceswapError</span> <span class="keyword">as</span> <span class="identifier">err</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">line</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">splitlines</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="identifier">line</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">KeyboardInterrupt</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=try-except-raise</span>
            <span class="keyword">raise</span>
        <span class="keyword">except</span> <span class="identifier">SystemExit</span><span class="punctuation">:</span>
            <span class="keyword">pass</span>
        <span class="keyword">except</span> <span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="punctuation">:</span>  <span class="comment"># pylint: disable=broad-except</span>
            <span class="identifier">crash_file</span> <span class="arithmetic-assignment">=</span> <span class="identifier">crash_log</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">(</span><span class="string-literal">"Got Exception on main handler:"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">critical</span><span class="grouping">(</span><span class="string-literal">"An unexpected crash has occurred. Crash report written to '%s'. "</span>
                            <span class="string-literal">"You MUST provide this file if seeking assistance. Please verify you "</span>
                            <span class="string-literal">"are running the latest version of faceswap before reporting"</span><span class="punctuation">,</span>
                            <span class="identifier">crash_file</span><span class="grouping">)</span>

        <span class="keyword">finally</span><span class="punctuation">:</span>
            <span class="identifier">safe_shutdown</span><span class="grouping">(</span><span class="identifier">got_error</span><span class="arithmetic-assignment">=</span><span class="logical-operator">not</span> <span class="identifier">success</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_configure_backend</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Configure the backend.

        Exclude any GPUs for use by Faceswap when requested.

        Set Faceswap backend to CPU if all GPUs have been deselected.

        Add the Keras import interception code.

        Parameters
        ----------
        arguments: :class:`argparse.Namespace`
            The command line arguments passed to Faceswap.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"exclude_gpus"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Cpu backends will not have this attribute</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding missing exclude gpus argument to namespace"</span><span class="grouping">)</span>
            <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">,</span> <span class="string-literal">"exclude_gpus"</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">all</span><span class="grouping">(</span><span class="identifier">idx</span><span class="punctuation">.</span><span class="identifier">isdigit</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"GPUs passed to the ['-X', '--exclude-gpus'] argument must all be "</span>
                             <span class="string-literal">"integers."</span><span class="grouping">)</span>
                <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">]</span>
            <span class="identifier">set_exclude_devices</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">GPUStats</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">exclude_all_devices</span> <span class="logical-operator">and</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="string-literal">"cpu"</span><span class="punctuation">:</span>
            <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Switching backend to CPU"</span>
            <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
                <span class="identifier">msg</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="string-literal">". Using Tensorflow for CPU operations."</span><span class="grouping">)</span>
                <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">environ</span><span class="grouping">[</span><span class="string-literal">"KERAS_BACKEND"] = "tensorflow"</span>
            <span class="identifier">set_backend</span><span class="grouping">(</span><span class="string-literal">"cpu"</span><span class="grouping">)</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="identifier">msg</span><span class="grouping">)</span>

        <span class="comment"># Add Keras finder to the meta_path list as the first item</span>
        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">meta_path</span><span class="punctuation">.</span><span class="identifier">insert</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">KerasFinder</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Executing: %s. PID: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_command</span><span class="punctuation">,</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">getpid</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">get_backend</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"amd"</span><span class="punctuation">:</span>
            <span class="identifier">plaidml_found</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_setup_amd</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">plaidml_found</span><span class="punctuation">:</span>
                <span class="identifier">safe_shutdown</span><span class="grouping">(</span><span class="identifier">got_error</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
                <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">exit</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_setup_amd</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Test for plaidml and perform setup for AMD.

        Parameters
        ----------
        arguments: :class:`argparse.Namespace`
            The command line arguments passed to Faceswap.
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Setting up for AMD"</span><span class="grouping">)</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="keyword">import</span> <span class="identifier">plaidml</span>  <span class="comment"># noqa pylint:disable=unused-import,import-outside-toplevel</span>
        <span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">error</span><span class="grouping">(</span><span class="string-literal">"PlaidML not found. Run `pip install plaidml-keras` for AMD support"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="bool-literal">False</span>
        <span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">plaidml_tools</span> <span class="keyword">import</span> <span class="identifier">setup_plaidml</span>  <span class="comment"># pylint:disable=import-outside-toplevel</span>
        <span class="identifier">setup_plaidml</span><span class="grouping">(</span><span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">loglevel</span><span class="punctuation">,</span> <span class="identifier">arguments</span><span class="punctuation">.</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"setup up for PlaidML"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="bool-literal">True</span>

    </pre>
  </body>
</html>