<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">make_column_transformer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVR</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">ConfusionMatrixDisplay</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">confusion_matrix</span>


<span class="comment"># TODO: Remove when https://github.com/numpy/numpy/issues/14397 is resolved</span>
<span class="identifier">pytestmark</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore:In future, it will be an error for 'np.bool_':DeprecationWarning:"</span>
    <span class="string-literal">"matplotlib.*"</span>
<span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_display_validation</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that we raise the proper error when validating parameters."""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>

    <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred_regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">y_pred_classifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"ConfusionMatrixDisplay.from_estimator only supports classifiers"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">regressor</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Mix type of y not allowed, got types"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Force `y_true` to be seen as a regression problem</span>
        <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">y_pred_classifier</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred_regressor</span><span class="grouping">)</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Found input variables with inconsistent numbers of samples"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred_classifier</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"constructor_name", ["from_estimator", "from_predictions"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_display_invalid_option</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the error raise if an invalid parameter value is passed."""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># safe guard for the binary if/else construction</span>
    <span class="keyword">assert</span> <span class="identifier">constructor_name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"from_estimator", "from_predictions"</span><span class="grouping">)</span>
    <span class="identifier">extra_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"normalize": "invalid"</span><span class="grouping">}</span>

    <span class="identifier">err_msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"normalize must be one of \{'true', 'pred', 'all', None\}"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">constructor_name</span> <span class="relational-operator">==</span> <span class="string-literal">"from_estimator"</span><span class="punctuation">:</span>
            <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
                <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">extra_params</span>
            <span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span>
                <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">extra_params</span>
            <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"constructor_name", ["from_estimator", "from_predictions"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"with_labels"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"with_display_labels"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_display_custom_labels</span><span class="grouping">(</span>
    <span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="punctuation">,</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="punctuation">,</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the resulting plot when labels are given."""</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># safe guard for the binary if/else construction</span>
    <span class="keyword">assert</span> <span class="identifier">constructor_name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"from_estimator", "from_predictions"</span><span class="grouping">)</span>

    <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">gca</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span> <span class="keyword">else</span> <span class="none-literal">None</span>
    <span class="identifier">display_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"b", "d", "a", "e", "f"</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span> <span class="keyword">else</span> <span class="none-literal">None</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="identifier">labels</span><span class="grouping">)</span>
    <span class="identifier">common_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">"ax"</span><span class="punctuation">:</span> <span class="identifier">ax</span><span class="punctuation">,</span>
        <span class="string-literal">"display_labels"</span><span class="punctuation">:</span> <span class="identifier">display_labels</span><span class="punctuation">,</span>
        <span class="string-literal">"labels"</span><span class="punctuation">:</span> <span class="identifier">labels</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">constructor_name</span> <span class="relational-operator">==</span> <span class="string-literal">"from_estimator"</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">display_labels</span>
    <span class="keyword">elif</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">labels</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_display_labels_str</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>
                                   <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">expected_display_labels</span><span class="grouping">]</span>

    <span class="identifier">x_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_yticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">display_labels</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"constructor_name", ["from_estimator", "from_predictions"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"normalize", ["true", "pred", "all"</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"include_values"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_display_plotting</span><span class="grouping">(</span>
    <span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="punctuation">,</span> <span class="identifier">include_values</span><span class="punctuation">,</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the overall plotting rendering."""</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># safe guard for the binary if/else construction</span>
    <span class="keyword">assert</span> <span class="identifier">constructor_name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"from_estimator", "from_predictions"</span><span class="grouping">)</span>

    <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">gca</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cmap</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"plasma"</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="identifier">common_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">"normalize"</span><span class="punctuation">:</span> <span class="identifier">normalize</span><span class="punctuation">,</span>
        <span class="string-literal">"cmap"</span><span class="punctuation">:</span> <span class="identifier">cmap</span><span class="punctuation">,</span>
        <span class="string-literal">"ax"</span><span class="punctuation">:</span> <span class="identifier">ax</span><span class="punctuation">,</span>
        <span class="string-literal">"include_values"</span><span class="punctuation">:</span> <span class="identifier">include_values</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">constructor_name</span> <span class="relational-operator">==</span> <span class="string-literal">"from_estimator"</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span> <span class="relational-operator">==</span> <span class="identifier">ax</span>

    <span class="keyword">if</span> <span class="identifier">normalize</span> <span class="relational-operator">==</span> <span class="string-literal">"true"</span><span class="punctuation">:</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cm</span> <span class="arithmetic-operator">/</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">normalize</span> <span class="relational-operator">==</span> <span class="string-literal">"pred"</span><span class="punctuation">:</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cm</span> <span class="arithmetic-operator">/</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">normalize</span> <span class="relational-operator">==</span> <span class="string-literal">"all"</span><span class="punctuation">:</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cm</span> <span class="arithmetic-operator">/</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>
    <span class="keyword">import</span> <span class="identifier">matplotlib</span> <span class="keyword">as</span> <span class="identifier">mpl</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">,</span> <span class="identifier">mpl</span><span class="punctuation">.</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">AxesImage</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_cmap</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">cmap</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">,</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">Axes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">figure_</span><span class="punctuation">,</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">Figure</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_ylabel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"True label"</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xlabel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"Predicted label"</span>

    <span class="identifier">x_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_yticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_display_labels_str</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
        <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">expected_display_labels</span>
    <span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">display_labels</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>

    <span class="identifier">image_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_array</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">image_data</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">include_values</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>
        <span class="identifier">fmt</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">".2g"</span>
        <span class="identifier">expected_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">fmt</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">text_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
            <span class="grouping">[</span><span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_text</span><span class="punctuation">,</span> <span class="identifier">text_text</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"constructor_name", ["from_estimator", "from_predictions"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_display</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the behaviour of the default constructor without using the class
    methods."""</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># safe guard for the binary if/else construction</span>
    <span class="keyword">assert</span> <span class="identifier">constructor_name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"from_estimator", "from_predictions"</span><span class="grouping">)</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="identifier">common_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">"normalize"</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="punctuation">,</span>
        <span class="string-literal">"include_values"</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="string-literal">"cmap": "viridis"</span><span class="punctuation">,</span>
        <span class="string-literal">"xticks_rotation"</span><span class="punctuation">:</span> <span class="float-literal">45.0</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">constructor_name</span> <span class="relational-operator">==</span> <span class="string-literal">"from_estimator"</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>

    <span class="identifier">rotations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_rotation</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">rotations</span><span class="punctuation">,</span> <span class="float-literal">45.0</span><span class="grouping">)</span>

    <span class="identifier">image_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_array</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">image_data</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="string-literal">"plasma"</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_cmap</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">"plasma"</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">include_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">xticks_rotation</span><span class="arithmetic-assignment">=</span><span class="float-literal">90.0</span><span class="grouping">)</span>
    <span class="identifier">rotations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_rotation</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">rotations</span><span class="punctuation">,</span> <span class="float-literal">90.0</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">values_format</span><span class="arithmetic-assignment">=</span><span class="string-literal">"e"</span><span class="grouping">)</span>
    <span class="identifier">expected_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="string-literal">"e") for v in cm.ravel(order="C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">text_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_text</span><span class="punctuation">,</span> <span class="identifier">text_text</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_contrast</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that the text color is appropriate depending on background."""</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span><span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">gray</span><span class="grouping">)</span>
    <span class="comment"># diagonal text is black</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># off-diagonal text is white</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">gray_r</span><span class="grouping">)</span>
    <span class="comment"># diagonal text is white</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># off-diagonal text is black</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Regression test for #15920</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">19</span><span class="punctuation">,</span> <span class="int-literal">34</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">58</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span><span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">Blues</span><span class="grouping">)</span>
    <span class="identifier">min_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">Blues</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">max_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">Blues</span><span class="grouping">(</span><span class="int-literal">255</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_color</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_color</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_color</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min_color</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"clf"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="identifier">make_pipeline</span><span class="grouping">(</span>
            <span class="identifier">make_column_transformer</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="identifier">ids</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="string-literal">"clf", "pipeline-clf", "pipeline-column_transformer-clf"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_pipeline</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check the behaviour of the plotting with more complex pipeline."""</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"constructor_name", ["from_estimator", "from_predictions"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_with_unknown_labels</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">constructor_name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that when labels=None, the unique values in `y_pred` and `y_true`
    will be used.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/pull/18405
    """</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># create unseen labels in `y_true` not seen during fitting and not present</span>
    <span class="comment"># in 'classifier.classes_'</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="comment"># safe guard for the binary if/else construction</span>
    <span class="keyword">assert</span> <span class="identifier">constructor_name</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">"from_estimator", "from_predictions"</span><span class="grouping">)</span>

    <span class="identifier">common_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"labels"</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">constructor_name</span> <span class="relational-operator">==</span> <span class="string-literal">"from_estimator"</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">(</span>
            <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span>
            <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">common_kwargs</span>
        <span class="grouping">)</span>

    <span class="identifier">display_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">expected_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_labels</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="grouping">)</span>

    </pre>
  </body>
</html>