<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Authors: Manoj Kumar</span>
<span class="comment">#          Thomas Unterthiner</span>
<span class="comment">#          Giorgio Patrini</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">sparsefuncs_fast</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">csr_mean_variance_axis0</span> <span class="keyword">as</span> <span class="identifier">_csr_mean_var_axis0</span><span class="punctuation">,</span>
    <span class="identifier">csc_mean_variance_axis0</span> <span class="keyword">as</span> <span class="identifier">_csc_mean_var_axis0</span><span class="punctuation">,</span>
    <span class="identifier">incr_mean_variance_axis0</span> <span class="keyword">as</span> <span class="identifier">_incr_mean_var_axis0</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">_check_sample_weight</span>


<span class="keyword">def</span> <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Raises a TypeError if X is not a CSR or CSC matrix"""</span>
    <span class="identifier">input_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="keyword">if</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">err</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Expected a CSR or CSC sparse matrix, got %s."</span> <span class="arithmetic-operator">%</span> <span class="identifier">input_type</span>
    <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="identifier">err</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_raise_error_wrong_axis</span><span class="grouping">(</span><span class="identifier">axis</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
            <span class="string-literal">"Unknown axis value: %d. Use 0 for rows, or 1 for columns"</span> <span class="arithmetic-operator">%</span> <span class="identifier">axis</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_csr_column_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Inplace column scaling of a CSR matrix.

    Scale each feature of the data matrix by multiplying with specific scale
    provided by the caller assuming a (n_samples, n_features) shape.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix to normalize using the variance of the features.
        It should be of CSR format.

    scale : ndarray of shape (n_features,), dtype={np.float32, np.float64}
        Array of precomputed feature-wise values to use for scaling.
    """</span>
    <span class="keyword">assert</span> <span class="identifier">scale</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">scale</span><span class="punctuation">.</span><span class="identifier">take</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'clip'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_csr_row_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Inplace row scaling of a CSR matrix.

    Scale each sample of the data matrix by multiplying with specific scale
    provided by the caller assuming a (n_samples, n_features) shape.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix to be scaled. It should be of CSR format.

    scale : ndarray of float of shape (n_samples,)
        Array of precomputed sample-wise values to use for scaling.
    """</span>
    <span class="keyword">assert</span> <span class="identifier">scale</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">*=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">mean_variance_axis</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute mean and variance along an axis on a CSR or CSC matrix.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Input data. It can be of CSR or CSC format.

    axis : {0, 1}
        Axis along which the axis should be computed.

    weights : ndarray of shape (n_samples,) or (n_features,), default=None
        if axis is set to 0 shape is (n_samples,) or
        if axis is set to 1 shape is (n_features,).
        If it is set to None, then samples are equally weighted.

        .. versionadded:: 0.24

    return_sum_weights : bool, default=False
        If True, returns the sum of weights seen for each feature
        if `axis=0` or each sample if `axis=1`.

        .. versionadded:: 0.24

    Returns
    -------

    means : ndarray of shape (n_features,), dtype=floating
        Feature-wise means.

    variances : ndarray of shape (n_features,), dtype=floating
        Feature-wise variances.

    sum_weights : ndarray of shape (n_features,), dtype=floating
        Returned if `return_sum_weights` is `True`.
    """</span>
    <span class="identifier">_raise_error_wrong_axis</span><span class="grouping">(</span><span class="identifier">axis</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_csr_mean_var_axis0</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_csc_mean_var_axis0</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_csc_mean_var_axis0</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_csr_mean_var_axis0</span><span class="grouping">(</span>
                <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="invalid">s</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">incr_mean_variance_axis</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">last_mean</span><span class="punctuation">,</span> <span class="identifier">last_var</span><span class="punctuation">,</span> <span class="identifier">last_n</span><span class="punctuation">,</span>
                            <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute incremental mean and variance along an axis on a CSR or
    CSC matrix.

    last_mean, last_var are the statistics computed at the last step by this
    function. Both must be initialized to 0-arrays of the proper size, i.e.
    the number of features in X. last_n is the number of samples encountered
    until now.

    Parameters
    ----------
    X : CSR or CSC sparse matrix of shape (n_samples, n_features)
        Input data.

    axis : {0, 1}
        Axis along which the axis should be computed.

    last_mean : ndarray of shape (n_features,) or (n_samples,), dtype=floating
        Array of means to update with the new data X.
        Should be of shape (n_features,) if axis=0 or (n_samples,) if axis=1.

    last_var : ndarray of shape (n_features,) or (n_samples,), dtype=floating
        Array of variances to update with the new data X.
        Should be of shape (n_features,) if axis=0 or (n_samples,) if axis=1.

    last_n : float or ndarray of shape (n_features,) or (n_samples,), \
            dtype=floating
        Sum of the weights seen so far, excluding the current weights
        If not float, it should be of shape (n_samples,) if
        axis=0 or (n_features,) if axis=1. If float it corresponds to
        having same weights for all samples (or features).

    weights : ndarray of shape (n_samples,) or (n_features,), default=None
        If axis is set to 0 shape is (n_samples,) or
        if axis is set to 1 shape is (n_features,).
        If it is set to None, then samples are equally weighted.

        .. versionadded:: 0.24

    Returns
    -------
    means : ndarray of shape (n_features,) or (n_samples,), dtype=floating
        Updated feature-wise means if axis = 0 or
        sample-wise means if axis = 1.

    variances : ndarray of shape (n_features,) or (n_samples,), dtype=floating
        Updated feature-wise variances if axis = 0 or
        sample-wise variances if axis = 1.

    n : ndarray of shape (n_features,) or (n_samples,), dtype=integral
        Updated number of seen samples per feature if axis=0
        or number of seen features per sample if axis=1.

        If weights is not None, n is a sum of the weights of the seen
        samples or features instead of the actual number of seen
        samples or features.

    Notes
    -----
    NaNs are ignored in the algorithm.
    """</span>
    <span class="identifier">_raise_error_wrong_axis</span><span class="grouping">(</span><span class="identifier">axis</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">last_n</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">last_n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">last_mean</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">last_n</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">last_mean</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">last_mean</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">last_var</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">last_n</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
            <span class="string-literal">"last_mean, last_var, last_n do not have the same shapes."</span>
        <span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">last_mean</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"If axis=1, then last_mean, last_n, last_var should be of "</span>
                <span class="identifier">f</span><span class="string-literal">"size n_samples {X.shape[0]} (Got {np.size(last_mean)})."</span>
            <span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>  <span class="comment"># axis == 0</span>
        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">(</span><span class="identifier">last_mean</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"If axis=0, then last_mean, last_n, last_var should be of "</span>
                <span class="identifier">f</span><span class="string-literal">"size n_features {X.shape[1]} (Got {np.size(last_mean)})."</span>
            <span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span> <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">1</span> <span class="keyword">else</span> <span class="identifier">X</span>

    <span class="keyword">if</span> <span class="identifier">weights</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_sample_weight</span><span class="grouping">(</span><span class="identifier">weights</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">_incr_mean_var_axis0</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">last_mean</span><span class="arithmetic-assignment">=</span><span class="identifier">last_mean</span><span class="punctuation">,</span>
                                <span class="identifier">last_var</span><span class="arithmetic-assignment">=</span><span class="identifier">last_var</span><span class="punctuation">,</span> <span class="identifier">last_n</span><span class="arithmetic-assignment">=</span><span class="identifier">last_n</span><span class="punctuation">,</span>
                                <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_column_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Inplace column scaling of a CSC/CSR matrix.

    Scale each feature of the data matrix by multiplying with specific scale
    provided by the caller assuming a (n_samples, n_features) shape.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix to normalize using the variance of the features. It should be
        of CSC or CSR format.

    scale : ndarray of shape (n_features,), dtype={np.float32, np.float64}
        Array of precomputed feature-wise values to use for scaling.
    """</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_csr_row_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_csr_column_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_row_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Inplace row scaling of a CSR or CSC matrix.

    Scale each row of the data matrix by multiplying with specific scale
    provided by the caller assuming a (n_samples, n_features) shape.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix to be scaled. It should be of CSR or CSC format.

    scale : ndarray of shape (n_features,), dtype={np.float32, np.float64}
        Array of precomputed sample-wise values to use for scaling.
    """</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_csr_column_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_csr_row_scale</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_swap_row_csc</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Swaps two rows of a CSC matrix in-place.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix whose two rows are to be swapped. It should be of
        CSC format.

    m : int
        Index of the row of X to be swapped.

    n : int
        Index of the row of X to be swapped.
    """</span>
    <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">t</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">"m and n should be valid integers"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">m</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">n</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">n</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">m_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span> <span class="relational-operator">==</span> <span class="identifier">m</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span> <span class="relational-operator">==</span> <span class="identifier">n</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">m_mask</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n</span>


<span class="keyword">def</span> <span class="identifier">inplace_swap_row_csr</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Swaps two rows of a CSR matrix in-place.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix whose two rows are to be swapped. It should be of
        CSR format.

    m : int
        Index of the row of X to be swapped.

    n : int
        Index of the row of X to be swapped.
    """</span>
    <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">t</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">"m and n should be valid integers"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">m</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">n</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">n</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="comment"># The following swapping makes life easier since m is assumed to be the</span>
    <span class="comment"># smaller integer below.</span>
    <span class="keyword">if</span> <span class="identifier">m</span> <span class="relational-operator">&gt;</span> <span class="identifier">n</span><span class="punctuation">:</span>
        <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n</span><span class="punctuation">,</span> <span class="identifier">m</span>

    <span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span>
    <span class="identifier">m_start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">m</span><span class="grouping">]</span>
    <span class="identifier">m_stop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">m</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">n_start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">n</span><span class="grouping">]</span>
    <span class="identifier">n_stop</span> <span class="arithmetic-assignment">=</span> <span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">n</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">nz_m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m_stop</span> <span class="arithmetic-operator">-</span> <span class="identifier">m_start</span>
    <span class="identifier">nz_n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_stop</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_start</span>

    <span class="keyword">if</span> <span class="identifier">nz_m</span> <span class="relational-operator">!=</span> <span class="identifier">nz_n</span><span class="punctuation">:</span>
        <span class="comment"># Modify indptr first</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">m</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="identifier">n</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">nz_n</span> <span class="arithmetic-operator">-</span> <span class="identifier">nz_m</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">m</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m_start</span> <span class="arithmetic-operator">+</span> <span class="identifier">nz_n</span>
        <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">n</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_stop</span> <span class="arithmetic-operator">-</span> <span class="identifier">nz_m</span>

    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">m_start</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">n_start</span><span class="punctuation">:</span><span class="identifier">n_stop</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">m_stop</span><span class="punctuation">:</span><span class="identifier">n_start</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">m_start</span><span class="punctuation">:</span><span class="identifier">m_stop</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">[</span><span class="identifier">n_stop</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">m_start</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">n_start</span><span class="punctuation">:</span><span class="identifier">n_stop</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">m_stop</span><span class="punctuation">:</span><span class="identifier">n_start</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">m_start</span><span class="punctuation">:</span><span class="identifier">m_stop</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">n_stop</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_swap_row</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Swaps two rows of a CSC/CSR matrix in-place.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix whose two rows are to be swapped. It should be of CSR or
        CSC format.

    m : int
        Index of the row of X to be swapped.

    n : int
        Index of the row of X to be swapped.
    """</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_swap_row_csc</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_swap_row_csr</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">inplace_swap_column</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Swaps two columns of a CSC/CSR matrix in-place.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Matrix whose two columns are to be swapped. It should be of
        CSR or CSC format.

    m : int
        Index of the column of X to be swapped.

    n : int
        Index of the column of X to be swapped.
    """</span>
    <span class="keyword">if</span> <span class="identifier">m</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">n</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">n</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_swap_row_csr</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">inplace_swap_row_csc</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_minor_reduce</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ufunc</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">major_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">flatnonzero</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># reduceat tries casts X.indptr to intp, which errors</span>
    <span class="comment"># if it is int64 on a 32 bit system.</span>
    <span class="comment"># Reinitializing prevents this where possible, see #13737</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ufunc</span><span class="punctuation">.</span><span class="identifier">reduceat</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="identifier">major_index</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">major_index</span><span class="punctuation">,</span> <span class="identifier">value</span>


<span class="keyword">def</span> <span class="identifier">_min_or_max_axis</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">min_or_max</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">N</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="identifier">axis</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">N</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"zero-size array to reduction operation"</span><span class="grouping">)</span>
    <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">axis</span><span class="grouping">]</span>
    <span class="identifier">mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span> <span class="keyword">else</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">mat</span><span class="punctuation">.</span><span class="identifier">sum_duplicates</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">major_index</span><span class="punctuation">,</span> <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_minor_reduce</span><span class="grouping">(</span><span class="identifier">mat</span><span class="punctuation">,</span> <span class="identifier">min_or_max</span><span class="grouping">)</span>
    <span class="identifier">not_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">mat</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">major_index</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="identifier">N</span>
    <span class="identifier">value</span><span class="grouping">[</span><span class="identifier">not_full</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min_or_max</span><span class="grouping">(</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">not_full</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">value</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span>
    <span class="identifier">major_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">compress</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">major_index</span><span class="grouping">)</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">compress</span><span class="grouping">(</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">value</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">value</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">major_index</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">M</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">coo_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">value</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">major_index</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">value</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">M</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">res</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_sparse_min_or_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">min_or_max</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="int-literal">0</span> <span class="relational-operator">in</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"zero-size array to reduction operation"</span><span class="grouping">)</span>
        <span class="identifier">zero</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="punctuation">.</span><span class="identifier">type</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">nnz</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">zero</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min_or_max</span><span class="punctuation">.</span><span class="identifier">reduce</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">nnz</span> <span class="relational-operator">!=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">product</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">min_or_max</span><span class="grouping">(</span><span class="identifier">zero</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">m</span>
    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">axis</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">2</span>
    <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="grouping">(</span><span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">_min_or_max_axis</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">min_or_max</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"invalid axis, use 0 for rows, or 1 for columns"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_sparse_min_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">_sparse_min_or_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="identifier">_sparse_min_or_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_sparse_nan_min_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span><span class="grouping">(</span><span class="identifier">_sparse_min_or_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fmin</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">_sparse_min_or_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fmax</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">min_max_axis</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">ignore_nan</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute minimum and maximum along an axis on a CSR or CSC matrix and
    optionally ignore NaN values.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Input data. It should be of CSR or CSC format.

    axis : {0, 1}
        Axis along which the axis should be computed.

    ignore_nan : bool, default=False
        Ignore or passing through NaN values.

        .. versionadded:: 0.20

    Returns
    -------

    mins : ndarray of shape (n_features,), dtype={np.float32, np.float64}
        Feature-wise minima.

    maxs : ndarray of shape (n_features,), dtype={np.float32, np.float64}
        Feature-wise maxima.
    """</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">ignore_nan</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_sparse_nan_min_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="identifier">axis</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">_sparse_min_max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="identifier">axis</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">_raise_typeerror</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">count_nonzero</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""A variant of X.getnnz() with extension to weighting on axis 0

    Useful in efficiently calculating multilabel metrics.

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_labels)
        Input data. It should be of CSR format.

    axis : {0, 1}, default=None
        The axis on which the data is aggregated.

    sample_weight : array-like of shape (n_samples,), default=None
        Weight for each row of X.
    """</span>
    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">axis</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="keyword">elif</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="identifier">axis</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="keyword">elif</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span> <span class="relational-operator">!=</span> <span class="string-literal">'csr'</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">'Expected CSR sparse format, got {0}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># We rely here on the fact that np.diff(Y.indptr) for a CSR</span>
    <span class="comment"># will return the number of nonzero entries in each row.</span>
    <span class="comment"># A bincount over Y.indices will return the number of nonzeros</span>
    <span class="comment"># in each column. See ``csr_matrix.getnnz`` in scipy &gt;= 0.14.</span>
    <span class="keyword">if</span> <span class="identifier">axis</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">nnz</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="comment"># astype here is for consistency with axis=0 dtype</span>
            <span class="keyword">return</span> <span class="identifier">out</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'intp'</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">out</span> <span class="arithmetic-operator">*</span> <span class="identifier">sample_weight</span>
    <span class="keyword">elif</span> <span class="identifier">axis</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">sample_weight</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">minlength</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="identifier">sample_weight</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">minlength</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Unsupported axis: {0}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">axis</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_get_median</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_zeros</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute the median of data with n_zeros additional zeros.

    This function is used to support sparse matrices; it modifies data
    in-place.
    """</span>
    <span class="identifier">n_elems</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_zeros</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">n_elems</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
    <span class="identifier">n_negative</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">count_nonzero</span><span class="grouping">(</span><span class="identifier">data</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">middle</span><span class="punctuation">,</span> <span class="identifier">is_odd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">divmod</span><span class="grouping">(</span><span class="identifier">n_elems</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">is_odd</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">_get_elem_at_rank</span><span class="grouping">(</span><span class="identifier">middle</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_negative</span><span class="punctuation">,</span> <span class="identifier">n_zeros</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">_get_elem_at_rank</span><span class="grouping">(</span><span class="identifier">middle</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_negative</span><span class="punctuation">,</span> <span class="identifier">n_zeros</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
            <span class="identifier">_get_elem_at_rank</span><span class="grouping">(</span><span class="identifier">middle</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_negative</span><span class="punctuation">,</span> <span class="identifier">n_zeros</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span>


<span class="keyword">def</span> <span class="identifier">_get_elem_at_rank</span><span class="grouping">(</span><span class="identifier">rank</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_negative</span><span class="punctuation">,</span> <span class="identifier">n_zeros</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Find the value in data augmented with n_zeros for the given rank"""</span>
    <span class="keyword">if</span> <span class="identifier">rank</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_negative</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">data</span><span class="grouping">[</span><span class="identifier">rank</span><span class="grouping">]</span>
    <span class="keyword">if</span> <span class="identifier">rank</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_negative</span> <span class="relational-operator">&lt;</span> <span class="identifier">n_zeros</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="int-literal">0</span>
    <span class="keyword">return</span> <span class="identifier">data</span><span class="grouping">[</span><span class="identifier">rank</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_zeros</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">csc_median_axis_0</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Find the median across axis 0 of a CSC matrix.
    It is equivalent to doing np.median(X, axis=0).

    Parameters
    ----------
    X : sparse matrix of shape (n_samples, n_features)
        Input data. It should be of CSC format.

    Returns
    -------
    median : ndarray of shape (n_features,)
        Median.

    """</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">TypeError</span><span class="grouping">(</span><span class="string-literal">"Expected matrix of CSC format, got %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">)</span>

    <span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">indptr</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">median</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">f_ind</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">end</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">indptr</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>

        <span class="comment"># Prevent modifying X in place</span>
        <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">start</span><span class="punctuation">:</span> <span class="identifier">end</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">nz</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_samples</span> <span class="arithmetic-operator">-</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">size</span>
        <span class="identifier">median</span><span class="grouping">[</span><span class="identifier">f_ind</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_get_median</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">nz</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">median</span>

    </pre>
  </body>
</html>