<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Authors: William Mill (bill@billmill.org)</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>


<span class="keyword">class</span> <span class="identifier">DrawTree</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">parent</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">number</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">depth</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">DrawTree</span><span class="grouping">(</span><span class="identifier">c</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">depth</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
                         <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">c</span>
                         <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">parent</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mod</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">ancestor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">change</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">shift</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lmost_sibling</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="comment"># this is the number of the node in its group of siblings 1..n</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">number</span> <span class="arithmetic-assignment">=</span> <span class="identifier">number</span>

    <span class="keyword">def</span> <span class="identifier">left</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="logical-operator">or</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">right</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="logical-operator">or</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">lbrother</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parent</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">node</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">children</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">node</span> <span class="relational-operator">==</span> <span class="identifier">self</span><span class="punctuation">:</span>
                    <span class="keyword">return</span> <span class="identifier">n</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node</span>
        <span class="keyword">return</span> <span class="identifier">n</span>

    <span class="keyword">def</span> <span class="identifier">get_lmost_sibling</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lmost_sibling</span> <span class="logical-operator">and</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parent</span> <span class="logical-operator">and</span> <span class="identifier">self</span> <span class="relational-operator">!=</span> <span class="invalid">\</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lmost_sibling</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_lmost_sibling</span>
    <span class="identifier">lmost_sibling</span> <span class="arithmetic-assignment">=</span> <span class="identifier">property</span><span class="grouping">(</span><span class="identifier">get_lmost_sibling</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__str__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="string-literal">"%s: x=%s mod=%s"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mod</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">__repr__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__str__</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">max_extents</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">extents</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">c</span><span class="punctuation">.</span><span class="identifier">max_extents</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span> <span class="identifier">children</span><span class="grouping">]</span>
        <span class="identifier">extents</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">extents</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">buchheim</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">dt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">first_walk</span><span class="grouping">(</span><span class="identifier">DrawTree</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">second_walk</span><span class="grouping">(</span><span class="identifier">dt</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">min</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">third_walk</span><span class="grouping">(</span><span class="identifier">dt</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">min</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">dt</span>


<span class="keyword">def</span> <span class="identifier">third_walk</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">n</span>
    <span class="keyword">for</span> <span class="identifier">c</span> <span class="relational-operator">in</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">children</span><span class="punctuation">:</span>
        <span class="identifier">third_walk</span><span class="grouping">(</span><span class="identifier">c</span><span class="punctuation">,</span> <span class="identifier">n</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">first_walk</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">distance</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">lmost_sibling</span><span class="punctuation">:</span>
            <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">lbrother</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">distance</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">w</span> <span class="relational-operator">in</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="punctuation">:</span>
            <span class="identifier">first_walk</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">)</span>
            <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">apportion</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">distance</span><span class="grouping">)</span>
        <span class="comment"># print("finished v =", v.tree, "children")</span>
        <span class="identifier">execute_shifts</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span>

        <span class="identifier">midpoint</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>

        <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">lbrother</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">w</span><span class="punctuation">:</span>
            <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">distance</span>
            <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">mod</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">-</span> <span class="identifier">midpoint</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">midpoint</span>
    <span class="keyword">return</span> <span class="identifier">v</span>


<span class="keyword">def</span> <span class="identifier">apportion</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">distance</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">lbrother</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">w</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="comment"># in buchheim notation:</span>
        <span class="comment"># i == inner; o == outer; r == right; l == left; r = +; l = -</span>
        <span class="identifier">vir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span>
        <span class="identifier">vil</span> <span class="arithmetic-assignment">=</span> <span class="identifier">w</span>
        <span class="identifier">vol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">lmost_sibling</span>
        <span class="identifier">sir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">mod</span>
        <span class="identifier">sil</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">mod</span>
        <span class="identifier">sol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vol</span><span class="punctuation">.</span><span class="identifier">mod</span>
        <span class="keyword">while</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">vir</span><span class="punctuation">.</span><span class="identifier">left</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">vil</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">vir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vir</span><span class="punctuation">.</span><span class="identifier">left</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">vol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vol</span><span class="punctuation">.</span><span class="identifier">left</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">vor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vor</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">vor</span><span class="punctuation">.</span><span class="identifier">ancestor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span>
            <span class="identifier">shift</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">sil</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="grouping">(</span><span class="identifier">vir</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-operator">+</span> <span class="identifier">sir</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">distance</span>
            <span class="keyword">if</span> <span class="identifier">shift</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">move_subtree</span><span class="grouping">(</span><span class="identifier">ancestor</span><span class="grouping">(</span><span class="identifier">vil</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">shift</span><span class="grouping">)</span>
                <span class="identifier">sir</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sir</span> <span class="arithmetic-operator">+</span> <span class="identifier">shift</span>
                <span class="identifier">sor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sor</span> <span class="arithmetic-operator">+</span> <span class="identifier">shift</span>
            <span class="identifier">sil</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">mod</span>
            <span class="identifier">sir</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">vir</span><span class="punctuation">.</span><span class="identifier">mod</span>
            <span class="identifier">sol</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">vol</span><span class="punctuation">.</span><span class="identifier">mod</span>
            <span class="identifier">sor</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">vor</span><span class="punctuation">.</span><span class="identifier">mod</span>
        <span class="keyword">if</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">vor</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">vor</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">right</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">vor</span><span class="punctuation">.</span><span class="identifier">mod</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">sil</span> <span class="arithmetic-operator">-</span> <span class="identifier">sor</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">vir</span><span class="punctuation">.</span><span class="identifier">left</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">vol</span><span class="punctuation">.</span><span class="identifier">left</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">vol</span><span class="punctuation">.</span><span class="identifier">thread</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vir</span><span class="punctuation">.</span><span class="identifier">left</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">vol</span><span class="punctuation">.</span><span class="identifier">mod</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">sir</span> <span class="arithmetic-operator">-</span> <span class="identifier">sol</span>
            <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span>
    <span class="keyword">return</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span>


<span class="keyword">def</span> <span class="identifier">move_subtree</span><span class="grouping">(</span><span class="identifier">wl</span><span class="punctuation">,</span> <span class="identifier">wr</span><span class="punctuation">,</span> <span class="identifier">shift</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">subtrees</span> <span class="arithmetic-assignment">=</span> <span class="identifier">wr</span><span class="punctuation">.</span><span class="identifier">number</span> <span class="arithmetic-operator">-</span> <span class="identifier">wl</span><span class="punctuation">.</span><span class="identifier">number</span>
    <span class="comment"># print(wl.tree, "is conflicted with", wr.tree, 'moving', subtrees,</span>
    <span class="comment"># 'shift', shift)</span>
    <span class="comment"># print wl, wr, wr.number, wl.number, shift, subtrees, shift/subtrees</span>
    <span class="identifier">wr</span><span class="punctuation">.</span><span class="identifier">change</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">shift</span> <span class="arithmetic-operator">/</span> <span class="identifier">subtrees</span>
    <span class="identifier">wr</span><span class="punctuation">.</span><span class="identifier">shift</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">shift</span>
    <span class="identifier">wl</span><span class="punctuation">.</span><span class="identifier">change</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">shift</span> <span class="arithmetic-operator">/</span> <span class="identifier">subtrees</span>
    <span class="identifier">wr</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">shift</span>
    <span class="identifier">wr</span><span class="punctuation">.</span><span class="identifier">mod</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">shift</span>


<span class="keyword">def</span> <span class="identifier">execute_shifts</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">shift</span> <span class="arithmetic-assignment">=</span> <span class="identifier">change</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="keyword">for</span> <span class="identifier">w</span> <span class="relational-operator">in</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="comment"># print("shift:", w, shift, w.change)</span>
        <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">shift</span>
        <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">mod</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">shift</span>
        <span class="identifier">change</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">change</span>
        <span class="identifier">shift</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">shift</span> <span class="arithmetic-operator">+</span> <span class="identifier">change</span>


<span class="keyword">def</span> <span class="identifier">ancestor</span><span class="grouping">(</span><span class="identifier">vil</span><span class="punctuation">,</span> <span class="identifier">v</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># the relevant text is at the bottom of page 7 of</span>
    <span class="comment"># "Improving Walker's Algorithm to Run in Linear Time" by Buchheim et al,</span>
    <span class="comment"># (2002)</span>
    <span class="comment"># http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.16.8757&rep=rep1&type=pdf</span>
    <span class="keyword">if</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">ancestor</span> <span class="relational-operator">in</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">parent</span><span class="punctuation">.</span><span class="identifier">children</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">vil</span><span class="punctuation">.</span><span class="identifier">ancestor</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">o</span><span class="invalid">r</span>


<span class="keyword">def</span> <span class="identifier">second_walk</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">m</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">m</span>
    <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">depth</span>

    <span class="keyword">if</span> <span class="identifier">min</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="logical-operator">or</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span> <span class="relational-operator">&lt;</span> <span class="identifier">min</span><span class="punctuation">:</span>
        <span class="identifier">min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">x</span>

    <span class="keyword">for</span> <span class="identifier">w</span> <span class="relational-operator">in</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">children</span><span class="punctuation">:</span>
        <span class="identifier">min</span> <span class="arithmetic-assignment">=</span> <span class="identifier">second_walk</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">m</span> <span class="arithmetic-operator">+</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">mod</span><span class="punctuation">,</span> <span class="identifier">depth</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">min</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">min</span>


<span class="keyword">class</span> <span class="identifier">Tree</span><span class="punctuation">:</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="string-literal">""</span><span class="punctuation">,</span> <span class="identifier">node_id</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">children</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">label</span> <span class="arithmetic-assignment">=</span> <span class="identifier">label</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">node_id</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_id</span>
        <span class="keyword">if</span> <span class="identifier">children</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span> <span class="arithmetic-assignment">=</span> <span class="identifier">children</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">children</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>

    </pre>
  </body>
</html>