<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Labeled Faces in the Wild (LFW) dataset

This dataset is a collection of JPEG pictures of famous people collected
over the internet, all details are available on the official website:

    http://vis-www.cs.umass.edu/lfw/
"""</span>
<span class="comment"># Copyright (c) 2011 Olivier Grisel &lt;olivier.grisel@ensta.org&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">os</span> <span class="keyword">import</span> <span class="identifier">listdir</span><span class="punctuation">,</span> <span class="identifier">makedirs</span><span class="punctuation">,</span> <span class="identifier">remove</span>
<span class="keyword">from</span> <span class="identifier">os</span><span class="punctuation">.</span><span class="identifier">path</span> <span class="keyword">import</span> <span class="identifier">dirname</span><span class="punctuation">,</span> <span class="identifier">join</span><span class="punctuation">,</span> <span class="identifier">exists</span><span class="punctuation">,</span> <span class="identifier">isdir</span>

<span class="keyword">import</span> <span class="identifier">logging</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">joblib</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Memory</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">get_data_home</span><span class="punctuation">,</span> <span class="identifier">_fetch_remote</span><span class="punctuation">,</span> <span class="identifier">RemoteFileMetadata</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">Bunch</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">parse_version</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>

<span class="comment"># The original data can be found in:</span>
<span class="comment"># http://vis-www.cs.umass.edu/lfw/lfw.tgz</span>
<span class="identifier">ARCHIVE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RemoteFileMetadata</span><span class="grouping">(</span>
    <span class="identifier">filename</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lfw.tgz'</span><span class="punctuation">,</span>
    <span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="string-literal">'https://ndownloader.figshare.com/files/5976018'</span><span class="punctuation">,</span>
    <span class="identifier">checksum</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'055f7d9c632d7370e6fb4afc7468d40f'</span>
              <span class="string-literal">'970c34a80d4c6f50ffec63f5a8d536c0'</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># The original funneled data can be found in:</span>
<span class="comment"># http://vis-www.cs.umass.edu/lfw/lfw-funneled.tgz</span>
<span class="identifier">FUNNELED_ARCHIVE</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RemoteFileMetadata</span><span class="grouping">(</span>
    <span class="identifier">filename</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lfw-funneled.tgz'</span><span class="punctuation">,</span>
    <span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="string-literal">'https://ndownloader.figshare.com/files/5976015'</span><span class="punctuation">,</span>
    <span class="identifier">checksum</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'b47c8422c8cded889dc5a13418c4bc2a'</span>
              <span class="string-literal">'bbda121092b3533a83306f90d900100a'</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="comment"># The original target data can be found in:</span>
<span class="comment"># http://vis-www.cs.umass.edu/lfw/pairsDevTrain.txt',</span>
<span class="comment"># http://vis-www.cs.umass.edu/lfw/pairsDevTest.txt',</span>
<span class="comment"># http://vis-www.cs.umass.edu/lfw/pairs.txt',</span>
<span class="identifier">TARGETS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
    <span class="identifier">RemoteFileMetadata</span><span class="grouping">(</span>
        <span class="identifier">filename</span><span class="arithmetic-assignment">=</span><span class="string-literal">'pairsDevTrain.txt'</span><span class="punctuation">,</span>
        <span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="string-literal">'https://ndownloader.figshare.com/files/5976012'</span><span class="punctuation">,</span>
        <span class="identifier">checksum</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'1d454dada7dfeca0e7eab6f65dc4e97a'</span>
                  <span class="string-literal">'6312d44cf142207be28d688be92aabfa'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>

    <span class="identifier">RemoteFileMetadata</span><span class="grouping">(</span>
        <span class="identifier">filename</span><span class="arithmetic-assignment">=</span><span class="string-literal">'pairsDevTest.txt'</span><span class="punctuation">,</span>
        <span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="string-literal">'https://ndownloader.figshare.com/files/5976009'</span><span class="punctuation">,</span>
        <span class="identifier">checksum</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'7cb06600ea8b2814ac26e946201cdb30'</span>
                  <span class="string-literal">'4296262aad67d046a16a7ec85d0ff87c'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>

    <span class="identifier">RemoteFileMetadata</span><span class="grouping">(</span>
        <span class="identifier">filename</span><span class="arithmetic-assignment">=</span><span class="string-literal">'pairs.txt'</span><span class="punctuation">,</span>
        <span class="identifier">url</span><span class="arithmetic-assignment">=</span><span class="string-literal">'https://ndownloader.figshare.com/files/5976006'</span><span class="punctuation">,</span>
        <span class="identifier">checksum</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="string-literal">'ea42330c62c92989f9d7c03237ed5d59'</span>
                  <span class="string-literal">'1365e89b3e649747777b70e692dc1592'</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">)</span>


<span class="comment">#</span>
<span class="comment"># Common private utilities for data fetching from the original LFW website</span>
<span class="comment"># local disk caching, and image decoding.</span>
<span class="comment">#</span>


<span class="keyword">def</span> <span class="identifier">_check_fetch_lfw</span><span class="grouping">(</span><span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">funneled</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">download_if_missing</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Helper function to download any missing LFW data"""</span>

    <span class="identifier">data_home</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_data_home</span><span class="grouping">(</span><span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="identifier">data_home</span><span class="grouping">)</span>
    <span class="identifier">lfw_home</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">data_home</span><span class="punctuation">,</span> <span class="string-literal">"lfw_home"</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">makedirs</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">target</span> <span class="relational-operator">in</span> <span class="identifier">TARGETS</span><span class="punctuation">:</span>
        <span class="identifier">target_filepath</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">filename</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">target_filepath</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">download_if_missing</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Downloading LFW metadata: %s"</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">url</span><span class="grouping">)</span>
                <span class="identifier">_fetch_remote</span><span class="grouping">(</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">dirname</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">IOError</span><span class="grouping">(</span><span class="string-literal">"%s is missing"</span> <span class="arithmetic-operator">%</span> <span class="identifier">target_filepath</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">funneled</span><span class="punctuation">:</span>
        <span class="identifier">data_folder_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="string-literal">"lfw_funneled"</span><span class="grouping">)</span>
        <span class="identifier">archive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">FUNNELED_ARCHIVE</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">data_folder_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="string-literal">"lfw"</span><span class="grouping">)</span>
        <span class="identifier">archive</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARCHIVE</span>

    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">data_folder_path</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">archive_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">archive</span><span class="punctuation">.</span><span class="identifier">filename</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">exists</span><span class="grouping">(</span><span class="identifier">archive_path</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">download_if_missing</span><span class="punctuation">:</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">info</span><span class="grouping">(</span><span class="string-literal">"Downloading LFW data (~200MB): %s"</span><span class="punctuation">,</span>
                            <span class="identifier">archive</span><span class="punctuation">.</span><span class="identifier">url</span><span class="grouping">)</span>
                <span class="identifier">_fetch_remote</span><span class="grouping">(</span><span class="identifier">archive</span><span class="punctuation">,</span> <span class="identifier">dirname</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">IOError</span><span class="grouping">(</span><span class="string-literal">"%s is missing"</span> <span class="arithmetic-operator">%</span> <span class="identifier">archive_path</span><span class="grouping">)</span>

        <span class="keyword">import</span> <span class="identifier">tarfile</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Decompressing the data archive to %s"</span><span class="punctuation">,</span> <span class="identifier">data_folder_path</span><span class="grouping">)</span>
        <span class="identifier">tarfile</span><span class="punctuation">.</span><span class="identifier">open</span><span class="grouping">(</span><span class="identifier">archive_path</span><span class="punctuation">,</span> <span class="string-literal">"r:gz"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">extractall</span><span class="grouping">(</span><span class="identifier">path</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="grouping">)</span>
        <span class="identifier">remove</span><span class="grouping">(</span><span class="identifier">archive_path</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">data_folder_path</span>


<span class="keyword">def</span> <span class="identifier">_load_imgs</span><span class="grouping">(</span><span class="identifier">file_paths</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Internally used to load images"""</span>
    <span class="comment"># import PIL only when needed</span>
    <span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">externals</span><span class="punctuation">.</span><span class="identifier">_pilutil</span> <span class="keyword">import</span> <span class="identifier">imread</span><span class="punctuation">,</span> <span class="identifier">imresize</span>

    <span class="comment"># compute the portion of the images to load to respect the slice_ parameter</span>
    <span class="comment"># given by the caller</span>
    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">e</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">250</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">250</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">slice_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">slice_</span> <span class="arithmetic-assignment">=</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">e</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">slice_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">s</span> <span class="logical-operator">or</span> <span class="identifier">ds</span> <span class="keyword">for</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">ds</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">slice_</span><span class="punctuation">,</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">a</span><span class="invalid">u</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">l</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">e</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">h_slice</span><span class="punctuation">,</span> <span class="identifier">w_slice</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice_</span>
    <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">h_slice</span><span class="punctuation">.</span><span class="identifier">stop</span> <span class="arithmetic-operator">-</span> <span class="identifier">h_slice</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">h_slice</span><span class="punctuation">.</span><span class="identifier">step</span> <span class="logical-operator">or</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">w_slice</span><span class="punctuation">.</span><span class="identifier">stop</span> <span class="arithmetic-operator">-</span> <span class="identifier">w_slice</span><span class="punctuation">.</span><span class="identifier">start</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="grouping">(</span><span class="identifier">w_slice</span><span class="punctuation">.</span><span class="identifier">step</span> <span class="logical-operator">or</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">resize</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">resize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">resize</span><span class="grouping">)</span>
        <span class="identifier">h</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">resize</span> <span class="arithmetic-operator">*</span> <span class="identifier">h</span><span class="grouping">)</span>
        <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">resize</span> <span class="arithmetic-operator">*</span> <span class="identifier">w</span><span class="grouping">)</span>

    <span class="comment"># allocate some contiguous memory to host the decoded image slices</span>
    <span class="identifier">n_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">file_paths</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">color</span><span class="punctuation">:</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_faces</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_faces</span><span class="punctuation">,</span> <span class="identifier">h</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

    <span class="comment"># iterate over the collected file path to load the jpeg files as numpy</span>
    <span class="comment"># arrays</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">file_path</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">file_paths</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">i</span> <span class="arithmetic-operator">%</span> <span class="int-literal">1000</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Loading face #%05d / %05d"</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_faces</span><span class="grouping">)</span>

        <span class="comment"># Checks if jpeg reading worked. Refer to issue #3594 for more</span>
        <span class="comment"># details.</span>
        <span class="identifier">img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imread</span><span class="grouping">(</span><span class="identifier">file_path</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">RuntimeError</span><span class="grouping">(</span><span class="string-literal">"Failed to read the image file %s, "</span>
                               <span class="string-literal">"Please make sure that libjpeg is installed"</span>
                               <span class="arithmetic-operator">%</span> <span class="identifier">file_path</span><span class="grouping">)</span>

        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">img</span><span class="grouping">[</span><span class="identifier">slice_</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">/=</span> <span class="float-literal">255.0</span>  <span class="comment"># scale uint8 coded colors to the [0.0, 1.0] floats</span>
        <span class="keyword">if</span> <span class="identifier">resize</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">imresize</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">color</span><span class="punctuation">:</span>
            <span class="comment"># average the color channels to compute a gray levels</span>
            <span class="comment"># representation</span>
            <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

        <span class="identifier">faces</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span>

    <span class="keyword">return</span> <span class="identifier">faces</span>


<span class="comment">#</span>
<span class="comment"># Task #1:  Face Identification on picture with names</span>
<span class="comment">#</span>

<span class="keyword">def</span> <span class="identifier">_fetch_lfw_people</span><span class="grouping">(</span><span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                      <span class="identifier">min_faces_per_person</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Perform the actual data loading for the lfw people dataset

    This operation is meant to be cached by a joblib wrapper.
    """</span>
    <span class="comment"># scan the data folder content to retain people with more that</span>
    <span class="comment"># `min_faces_per_person` face pictures</span>
    <span class="identifier">person_names</span><span class="punctuation">,</span> <span class="identifier">file_paths</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">person_name</span> <span class="relational-operator">in</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">data_folder_path</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">folder_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">person_name</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isdir</span><span class="grouping">(</span><span class="identifier">folder_path</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">continue</span>
        <span class="identifier">paths</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">folder_path</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">f</span> <span class="relational-operator">in</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">folder_path</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">n_pictures</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">paths</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">n_pictures</span> <span class="relational-operator">&gt;=</span> <span class="identifier">min_faces_per_person</span><span class="punctuation">:</span>
            <span class="identifier">person_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">person_name</span><span class="punctuation">.</span><span class="identifier">replace</span><span class="grouping">(</span><span class="string-literal">'_', ' '</span><span class="grouping">)</span>
            <span class="identifier">person_names</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">person_name</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_pictures</span><span class="grouping">)</span>
            <span class="identifier">file_paths</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">paths</span><span class="grouping">)</span>

    <span class="identifier">n_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">file_paths</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">n_faces</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"min_faces_per_person=%d is too restrictive"</span> <span class="arithmetic-operator">%</span>
                         <span class="identifier">min_faces_per_person</span><span class="grouping">)</span>

    <span class="identifier">target_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">person_names</span><span class="grouping">)</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">searchsorted</span><span class="grouping">(</span><span class="identifier">target_names</span><span class="punctuation">,</span> <span class="identifier">person_names</span><span class="grouping">)</span>

    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_load_imgs</span><span class="grouping">(</span><span class="identifier">file_paths</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="grouping">)</span>

    <span class="comment"># shuffle the faces with a deterministic RNG scheme to avoid having</span>
    <span class="comment"># all faces of the same person in a row, as it would break some</span>
    <span class="comment"># cross validation and learning algorithms such as SGD and online</span>
    <span class="comment"># k-means that make an IID assumption</span>

    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_faces</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shuffle</span><span class="grouping">(</span><span class="identifier">indices</span><span class="grouping">)</span>
    <span class="identifier">faces</span><span class="punctuation">,</span> <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span>
    <span class="keyword">return</span> <span class="identifier">faces</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">target_names</span>


<span class="keyword">def</span> <span class="identifier">fetch_lfw_people</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">funneled</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                     <span class="identifier">min_faces_per_person</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                     <span class="identifier">slice_</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">70</span><span class="punctuation">,</span> <span class="int-literal">195</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">78</span><span class="punctuation">,</span> <span class="int-literal">172</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="identifier">download_if_missing</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Load the Labeled Faces in the Wild (LFW) people dataset \
(classification).

    Download it if necessary.

    =================   =======================
    Classes                                5749
    Samples total                         13233
    Dimensionality                         5828
    Features            real, between 0 and 255
    =================   =======================

    Read more in the :ref:`User Guide &lt;labeled_faces_in_the_wild_dataset&gt;`.

    Parameters
    ----------
    data_home : str, default=None
        Specify another download and cache folder for the datasets. By default
        all scikit-learn data is stored in '~/scikit_learn_data' subfolders.

    funneled : bool, default=True
        Download and use the funneled variant of the dataset.

    resize : float, default=0.5
        Ratio used to resize the each face picture.

    min_faces_per_person : int, default=None
        The extracted dataset will only retain pictures of people that have at
        least `min_faces_per_person` different pictures.

    color : bool, default=False
        Keep the 3 RGB channels instead of averaging them to a single
        gray level channel. If color is True the shape of the data has
        one more dimension than the shape with color = False.

    slice_ : tuple of slice, default=(slice(70, 195), slice(78, 172))
        Provide a custom 2D slice (height, width) to extract the
        'interesting' part of the jpeg files and avoid use statistical
        correlation from the background

    download_if_missing : bool, default=True
        If False, raise a IOError if the data is not locally available
        instead of trying to download the data from the source site.

    return_X_y : bool, default=False
        If True, returns ``(dataset.data, dataset.target)`` instead of a Bunch
        object. See below for more information about the `dataset.data` and
        `dataset.target` object.

        .. versionadded:: 0.20

    Returns
    -------
    dataset : :class:`~sklearn.utils.Bunch`
        Dictionary-like object, with the following attributes.

        data : numpy array of shape (13233, 2914)
            Each row corresponds to a ravelled face image
            of original size 62 x 47 pixels.
            Changing the ``slice_`` or resize parameters will change the
            shape of the output.
        images : numpy array of shape (13233, 62, 47)
            Each row is a face image corresponding to one of the 5749 people in
            the dataset. Changing the ``slice_``
            or resize parameters will change the shape of the output.
        target : numpy array of shape (13233,)
            Labels associated to each face image.
            Those labels range from 0-5748 and correspond to the person IDs.
        DESCR : string
            Description of the Labeled Faces in the Wild (LFW) dataset.

    (data, target) : tuple if ``return_X_y`` is True

        .. versionadded:: 0.20

    """</span>
    <span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">data_folder_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_fetch_lfw</span><span class="grouping">(</span>
        <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="identifier">data_home</span><span class="punctuation">,</span> <span class="identifier">funneled</span><span class="arithmetic-assignment">=</span><span class="identifier">funneled</span><span class="punctuation">,</span>
        <span class="identifier">download_if_missing</span><span class="arithmetic-assignment">=</span><span class="identifier">download_if_missing</span><span class="grouping">)</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">'Loading LFW people faces from %s'</span><span class="punctuation">,</span> <span class="identifier">lfw_home</span><span class="grouping">)</span>

    <span class="comment"># wrap the loader in a memoizing function that will return memmaped data</span>
    <span class="comment"># arrays for optimal memory usage</span>
    <span class="keyword">if</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'0.12'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Deal with change of API in joblib</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">compress</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">location</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">compress</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">load_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">cache</span><span class="grouping">(</span><span class="identifier">_fetch_lfw_people</span><span class="grouping">)</span>

    <span class="comment"># load and memoize the pairs as np arrays</span>
    <span class="identifier">faces</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">target_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_func</span><span class="grouping">(</span>
        <span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="arithmetic-assignment">=</span><span class="identifier">resize</span><span class="punctuation">,</span>
        <span class="identifier">min_faces_per_person</span><span class="arithmetic-assignment">=</span><span class="identifier">min_faces_per_person</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="arithmetic-assignment">=</span><span class="identifier">slice_</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">module_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">module_path</span><span class="punctuation">,</span> <span class="string-literal">'descr', 'lfw.rst'</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">rst_file</span><span class="punctuation">:</span>
        <span class="identifier">fdescr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rst_file</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">X</span><span class="invalid">_</span><span class="invalid">y</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">target</span>

    <span class="comment"># pack the results as a Bunch instance</span>
    <span class="keyword">return</span> <span class="identifier">Bunch</span><span class="grouping">(</span><span class="identifier">data</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">images</span><span class="arithmetic-assignment">=</span><span class="identifier">faces</span><span class="punctuation">,</span>
                 <span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">target_names</span><span class="arithmetic-assignment">=</span><span class="identifier">target_names</span><span class="punctuation">,</span>
                 <span class="identifier">DESCR</span><span class="arithmetic-assignment">=</span><span class="identifier">fdescr</span><span class="grouping">)</span>


<span class="comment">#</span>
<span class="comment"># Task #2:  Face Verification on pairs of face pictures</span>
<span class="comment">#</span>


<span class="keyword">def</span> <span class="identifier">_fetch_lfw_pairs</span><span class="grouping">(</span><span class="identifier">index_file_path</span><span class="punctuation">,</span> <span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                     <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Perform the actual data loading for the LFW pairs dataset

    This operation is meant to be cached by a joblib wrapper.
    """</span>
    <span class="comment"># parse the index file to find the number of pairs to be able to allocate</span>
    <span class="comment"># the right amount of memory before starting to decode the jpeg files</span>
    <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">index_file_path</span><span class="punctuation">,</span> <span class="string-literal">'rb'</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">index_file</span><span class="punctuation">:</span>
        <span class="identifier">split_lines</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">ln</span><span class="punctuation">.</span><span class="identifier">decode</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">strip</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="string-literal">'\t'</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">ln</span> <span class="relational-operator">in</span> <span class="identifier">index_file</span><span class="grouping">]</span>
    <span class="identifier">pair_specs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">sl</span> <span class="keyword">for</span> <span class="identifier">sl</span> <span class="relational-operator">in</span> <span class="identifier">split_lines</span> <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">sl</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">n_pairs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">pair_specs</span><span class="grouping">)</span>

    <span class="comment"># iterating over the metadata lines for each pair to find the filename to</span>
    <span class="comment"># decode and load in memory</span>
    <span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_pairs</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="identifier">file_paths</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">components</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">pair_specs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">components</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="punctuation">:</span>
            <span class="identifier">target</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
            <span class="identifier">pair</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                <span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">components</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="identifier">target</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="identifier">pair</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                <span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">components</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"invalid line %d: %r"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">components</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">j</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">pair</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">try</span><span class="punctuation">:</span>
                <span class="identifier">person_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="grouping">)</span>
            <span class="keyword">except</span> <span class="identifier">TypeError</span><span class="punctuation">:</span>
                <span class="identifier">person_folder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">'UTF-8'</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">filenames</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">listdir</span><span class="grouping">(</span><span class="identifier">person_folder</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">file_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">person_folder</span><span class="punctuation">,</span> <span class="identifier">filenames</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">file_paths</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">file_path</span><span class="grouping">)</span>

    <span class="identifier">pairs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_load_imgs</span><span class="grouping">(</span><span class="identifier">file_paths</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="grouping">)</span>
    <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">pairs</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">n_faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">shape</span><span class="punctuation">.</span><span class="identifier">insert</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">shape</span><span class="punctuation">.</span><span class="identifier">insert</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_faces</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">pairs</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">shape</span>

    <span class="keyword">return</span> <span class="identifier">pairs</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'Different persons', 'Same person'</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">fetch_lfw_pairs</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">subset</span><span class="arithmetic-assignment">=</span><span class="string-literal">'train'</span><span class="punctuation">,</span> <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">funneled</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                    <span class="identifier">resize</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                    <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">slice_</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">70</span><span class="punctuation">,</span> <span class="int-literal">195</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="int-literal">78</span><span class="punctuation">,</span> <span class="int-literal">172</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">download_if_missing</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Load the Labeled Faces in the Wild (LFW) pairs dataset (classification).

    Download it if necessary.

    =================   =======================
    Classes                                   2
    Samples total                         13233
    Dimensionality                         5828
    Features            real, between 0 and 255
    =================   =======================

    In the official `README.txt`_ this task is described as the
    "Restricted" task.  As I am not sure as to implement the
    "Unrestricted" variant correctly, I left it as unsupported for now.

      .. _`README.txt`: http://vis-www.cs.umass.edu/lfw/README.txt

    The original images are 250 x 250 pixels, but the default slice and resize
    arguments reduce them to 62 x 47.

    Read more in the :ref:`User Guide &lt;labeled_faces_in_the_wild_dataset&gt;`.

    Parameters
    ----------
    subset : {'train', 'test', '10_folds'}, default='train'
        Select the dataset to load: 'train' for the development training
        set, 'test' for the development test set, and '10_folds' for the
        official evaluation set that is meant to be used with a 10-folds
        cross validation.

    data_home : str, default=None
        Specify another download and cache folder for the datasets. By
        default all scikit-learn data is stored in '~/scikit_learn_data'
        subfolders.

    funneled : bool, default=True
        Download and use the funneled variant of the dataset.

    resize : float, default=0.5
        Ratio used to resize the each face picture.

    color : bool, default=False
        Keep the 3 RGB channels instead of averaging them to a single
        gray level channel. If color is True the shape of the data has
        one more dimension than the shape with color = False.

    slice_ : tuple of slice, default=(slice(70, 195), slice(78, 172))
        Provide a custom 2D slice (height, width) to extract the
        'interesting' part of the jpeg files and avoid use statistical
        correlation from the background

    download_if_missing : bool, default=True
        If False, raise a IOError if the data is not locally available
        instead of trying to download the data from the source site.

    Returns
    -------
    data : :class:`~sklearn.utils.Bunch`
        Dictionary-like object, with the following attributes.

        data : ndarray of shape (2200, 5828). Shape depends on ``subset``.
            Each row corresponds to 2 ravel'd face images
            of original size 62 x 47 pixels.
            Changing the ``slice_``, ``resize`` or ``subset`` parameters
            will change the shape of the output.
        pairs : ndarray of shape (2200, 2, 62, 47). Shape depends on ``subset``
            Each row has 2 face images corresponding
            to same or different person from the dataset
            containing 5749 people. Changing the ``slice_``,
            ``resize`` or ``subset`` parameters will change the shape of the
            output.
        target : numpy array of shape (2200,). Shape depends on ``subset``.
            Labels associated to each pair of images.
            The two label values being different persons or the same person.
        DESCR : string
            Description of the Labeled Faces in the Wild (LFW) dataset.

    """</span>
    <span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">data_folder_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_check_fetch_lfw</span><span class="grouping">(</span>
        <span class="identifier">data_home</span><span class="arithmetic-assignment">=</span><span class="identifier">data_home</span><span class="punctuation">,</span> <span class="identifier">funneled</span><span class="arithmetic-assignment">=</span><span class="identifier">funneled</span><span class="punctuation">,</span>
        <span class="identifier">download_if_missing</span><span class="arithmetic-assignment">=</span><span class="identifier">download_if_missing</span><span class="grouping">)</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">'Loading %s LFW pairs from %s'</span><span class="punctuation">,</span> <span class="identifier">subset</span><span class="punctuation">,</span> <span class="identifier">lfw_home</span><span class="grouping">)</span>

    <span class="comment"># wrap the loader in a memoizing function that will return memmaped data</span>
    <span class="comment"># arrays for optimal memory usage</span>
    <span class="keyword">if</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="identifier">joblib</span><span class="punctuation">.</span><span class="identifier">__version__</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">'0.12'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Deal with change of API in joblib</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">compress</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">location</span><span class="arithmetic-assignment">=</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">compress</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">load_func</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">cache</span><span class="grouping">(</span><span class="identifier">_fetch_lfw_pairs</span><span class="grouping">)</span>

    <span class="comment"># select the right metadata file according to the requested subset</span>
    <span class="identifier">label_filenames</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
        <span class="string-literal">'train': 'pairsDevTrain.txt'</span><span class="punctuation">,</span>
        <span class="string-literal">'test': 'pairsDevTest.txt'</span><span class="punctuation">,</span>
        <span class="string-literal">'10_folds': 'pairs.txt'</span><span class="punctuation">,</span>
    <span class="grouping">}</span>
    <span class="keyword">if</span> <span class="identifier">subset</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">label_filenames</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"subset='%s' is invalid: should be one of %r"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span>
            <span class="identifier">subset</span><span class="punctuation">,</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">label_filenames</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">index_file_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">join</span><span class="grouping">(</span><span class="identifier">lfw_home</span><span class="punctuation">,</span> <span class="identifier">label_filenames</span><span class="grouping">[</span><span class="identifier">subset</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># load and memoize the pairs as np arrays</span>
    <span class="identifier">pairs</span><span class="punctuation">,</span> <span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">target_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">load_func</span><span class="grouping">(</span>
        <span class="identifier">index_file_path</span><span class="punctuation">,</span> <span class="identifier">data_folder_path</span><span class="punctuation">,</span> <span class="identifier">resize</span><span class="arithmetic-assignment">=</span><span class="identifier">resize</span><span class="punctuation">,</span> <span class="identifier">color</span><span class="arithmetic-assignment">=</span><span class="identifier">color</span><span class="punctuation">,</span>
        <span class="identifier">slice_</span><span class="arithmetic-assignment">=</span><span class="identifier">slice_</span><span class="grouping">)</span>

    <span class="identifier">module_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dirname</span><span class="grouping">(</span><span class="identifier">__file__</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">open</span><span class="grouping">(</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">module_path</span><span class="punctuation">,</span> <span class="string-literal">'descr', 'lfw.rst'</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">as</span> <span class="identifier">rst_file</span><span class="punctuation">:</span>
        <span class="identifier">fdescr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rst_file</span><span class="punctuation">.</span><span class="identifier">read</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># pack the results as a Bunch instance</span>
    <span class="keyword">return</span> <span class="identifier">Bunch</span><span class="grouping">(</span><span class="identifier">data</span><span class="arithmetic-assignment">=</span><span class="identifier">pairs</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">pairs</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">pairs</span><span class="arithmetic-assignment">=</span><span class="identifier">pairs</span><span class="punctuation">,</span>
                 <span class="identifier">target</span><span class="arithmetic-assignment">=</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">target_names</span><span class="arithmetic-assignment">=</span><span class="identifier">target_names</span><span class="punctuation">,</span>
                 <span class="identifier">DESCR</span><span class="arithmetic-assignment">=</span><span class="identifier">fdescr</span><span class="grouping">)</span>

    </pre>
  </body>
</html>