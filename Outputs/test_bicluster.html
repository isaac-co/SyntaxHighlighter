<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Testing for Spectral Biclustering methods"""</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">issparse</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">ParameterGrid</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">BiclusterMixin</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">SpectralCoclustering</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">SpectralBiclustering</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span><span class="punctuation">.</span><span class="identifier">_bicluster</span> <span class="keyword">import</span> <span class="identifier">_scale_normalize</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span><span class="punctuation">.</span><span class="identifier">_bicluster</span> <span class="keyword">import</span> <span class="identifier">_bistochastic_normalize</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">cluster</span><span class="punctuation">.</span><span class="identifier">_bicluster</span> <span class="keyword">import</span> <span class="identifier">_log_normalize</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">consensus_score</span><span class="punctuation">,</span> <span class="identifier">v_measure_score</span><span class="grouping">)</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_biclusters</span><span class="punctuation">,</span> <span class="identifier">make_checkerboard</span>


<span class="keyword">class</span> <span class="identifier">MockBiclustering</span><span class="grouping">(</span><span class="identifier">BiclusterMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Mock object for testing get_submatrix.</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">pass</span>

    <span class="keyword">def</span> <span class="identifier">get_indices</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Overridden to reproduce old get_submatrix test.</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_get_submatrix</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MockBiclustering</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">submatrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">get_submatrix</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">submatrix</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">submatrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">submatrix</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">submatrix</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                                       <span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span>
                                       <span class="grouping">[</span><span class="int-literal">18</span><span class="punctuation">,</span> <span class="int-literal">19</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">submatrix</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_test_shape_indices</span><span class="grouping">(</span><span class="identifier">model</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test get_shape and get_indices on fitted model.</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">n_clusters</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">m</span><span class="punctuation">,</span> <span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">get_shape</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span>
        <span class="identifier">i_ind</span><span class="punctuation">,</span> <span class="identifier">j_ind</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">get_indices</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">i_ind</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">m</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">j_ind</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">n</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_coclustering</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Dhillon's Spectral CoClustering on a simple problem.</span>
    <span class="identifier">param_grid</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'svd_method': ['randomized', 'arpack'</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="string-literal">'n_svd_vecs'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="string-literal">'mini_batch'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="string-literal">'init': ['k-means++'</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="string-literal">'n_init'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">}</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_biclusters</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="grouping">)</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">S</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span>  <span class="comment"># needs to be nonnegative before making it sparse</span>
    <span class="identifier">S</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">S</span> <span class="relational-operator">&lt;</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">S</span><span class="grouping">)</span>  <span class="comment"># threshold some values</span>
    <span class="keyword">for</span> <span class="identifier">mat</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">kwargs</span> <span class="relational-operator">in</span> <span class="identifier">ParameterGrid</span><span class="grouping">(</span><span class="identifier">param_grid</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralCoclustering</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                         <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">random_state</span><span class="punctuation">,</span>
                                         <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
            <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span>

            <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">rows_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">rows_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">columns_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">consensus_score</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">biclusters_</span><span class="punctuation">,</span>
                                   <span class="grouping">(</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

            <span class="identifier">_test_shape_indices</span><span class="grouping">(</span><span class="identifier">model</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spectral_biclustering</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Kluger methods on a checkerboard dataset.</span>
    <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_checkerboard</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">non_default_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'method': ['scale', 'log'</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">'svd_method': ['arpack'</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">'n_svd_vecs'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="int-literal">20</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="string-literal">'mini_batch'</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">}</span>

    <span class="keyword">for</span> <span class="identifier">mat</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">param_name</span><span class="punctuation">,</span> <span class="identifier">param_values</span> <span class="relational-operator">in</span> <span class="identifier">non_default_params</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">param_value</span> <span class="relational-operator">in</span> <span class="identifier">param_values</span><span class="punctuation">:</span>

                <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralBiclustering</span><span class="grouping">(</span>
                    <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                    <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                    <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'k-means++'</span><span class="punctuation">,</span>
                    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                <span class="grouping">)</span>
                <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">param_name</span><span class="punctuation">,</span> <span class="identifier">param_value</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

                <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">'method') == 'log'</span><span class="punctuation">:</span>
                    <span class="comment"># cannot take log of sparse matrix</span>
                    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span>
                    <span class="keyword">continue</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span>

                <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">rows_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
                <span class="keyword">assert</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">columns_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">9</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">rows_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">columns_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                   <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">assert</span> <span class="identifier">consensus_score</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">biclusters_</span><span class="punctuation">,</span>
                                       <span class="grouping">(</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

                <span class="identifier">_test_shape_indices</span><span class="grouping">(</span><span class="identifier">model</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_do_scale_test</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that rows sum to one constant, and columns to another."""</span>
    <span class="identifier">row_sum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scaled</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">col_sum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scaled</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">row_sum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">row_sum</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">col_sum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">col_sum</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">row_sum</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">row_sum</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">col_sum</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">col_sum</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_do_bistochastic_test</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that rows and columns sum to the same constant."""</span>
    <span class="identifier">_do_scale_test</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">scaled</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_scale_normalize</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">mat</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scaled</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_scale_normalize</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span>
        <span class="identifier">_do_scale_test</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bistochastic_normalize</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">mat</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">scaled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_bistochastic_normalize</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span>
        <span class="identifier">_do_bistochastic_test</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">issparse</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_log_normalize</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># adding any constant to a log-scaled matrix should make it</span>
    <span class="comment"># bistochastic</span>
    <span class="identifier">generator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">mat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">generator</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">scaled</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_log_normalize</span><span class="grouping">(</span><span class="identifier">mat</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">_do_bistochastic_test</span><span class="grouping">(</span><span class="identifier">scaled</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_fit_best_piecewise</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralBiclustering</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">vectors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">_fit_best_piecewise</span><span class="grouping">(</span><span class="identifier">vectors</span><span class="punctuation">,</span> <span class="identifier">n_best</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">best</span><span class="punctuation">,</span> <span class="identifier">vectors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_project_and_cluster</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralBiclustering</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">vectors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">mat</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">_project_and_cluster</span><span class="grouping">(</span><span class="identifier">mat</span><span class="punctuation">,</span> <span class="identifier">vectors</span><span class="punctuation">,</span>
                                            <span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">v_measure_score</span><span class="grouping">(</span><span class="identifier">labels</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_perfect_checkerboard</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># XXX Previously failed on build bot (not reproducible)</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralBiclustering</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">svd_method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"arpack"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_checkerboard</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">consensus_score</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">biclusters_</span><span class="punctuation">,</span>
                           <span class="grouping">(</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_checkerboard</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">40</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">consensus_score</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">biclusters_</span><span class="punctuation">,</span>
                           <span class="grouping">(</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="identifier">S</span><span class="punctuation">,</span> <span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_checkerboard</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">40</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">noise</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">S</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">consensus_score</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">biclusters_</span><span class="punctuation">,</span>
                           <span class="grouping">(</span><span class="identifier">rows</span><span class="punctuation">,</span> <span class="identifier">cols</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"args"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">{</span><span class="string-literal">'n_clusters'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'n_clusters': 'abc'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'n_clusters': (3, 'abc'</span><span class="grouping">)</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'method': 'unknown'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'n_components'</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'n_best'</span><span class="punctuation">:</span> <span class="int-literal">0</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'svd_method': 'unknown'</span><span class="grouping">}</span><span class="punctuation">,</span>
     <span class="grouping">{</span><span class="string-literal">'n_components': 3, 'n_best'</span><span class="punctuation">:</span> <span class="int-literal">4</span><span class="grouping">}</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_errors</span><span class="grouping">(</span><span class="identifier">args</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">25</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralBiclustering</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">args</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_wrong_shape</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SpectralBiclustering</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">27</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'est'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="identifier">SpectralBiclustering</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">SpectralCoclustering</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_n_features_in_</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_biclusters</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="string-literal">'n_features_in_'</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">n_features_in_</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

    </pre>
  </body>
</html>