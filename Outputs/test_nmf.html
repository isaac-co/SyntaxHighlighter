<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">re</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">as</span> <span class="identifier">sp</span>

<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">NMF</span><span class="punctuation">,</span> <span class="identifier">non_negative_factorization</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">_nmf</span> <span class="keyword">as</span> <span class="identifier">nmf</span>  <span class="comment"># For testing internals</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csc_matrix</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">squared_norm</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ['cd', 'mu'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_convergence_warning</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">convergence_warning</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"Maximum number of iterations 1 reached. "</span>
                           <span class="string-literal">"Increase it to improve convergence."</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">ConvergenceWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">convergence_warning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_initialize_nn_output</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that initialization does not return negative values</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">init</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'random', 'nndsvd', 'nndsvda', 'nndsvdar'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">W</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">or</span> <span class="grouping">(</span><span class="identifier">H</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_parameter_checking</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'spam'</span>
    <span class="comment"># FIXME : should be removed in 1.1</span>
    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'nndsvda'</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid solver parameter: got 'spam' instead of one of"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid init parameter: got 'spam' instead of one of"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid regularization parameter: got 'spam' instead of one of"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid beta_loss parameter: got 'spam' instead of one"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mu'</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"Invalid beta_loss parameter: solver 'cd' does not handle "</span>
        <span class="string-literal">"beta_loss = 1.0"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cd'</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Negative values in data passed to"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="string-literal">'nndsvd'</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">init</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'nndsvd', 'nndsvda', 'nndsvdar'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
            <span class="string-literal">"init = '{}' can only be used when "</span>
            <span class="string-literal">"n_components &lt;= min(n_samples, n_features)"</span>
            <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">init</span><span class="grouping">)</span>
        <span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">NMF</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_initialize_close</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test NNDSVD error</span>
    <span class="comment"># Test that _initialize_nmf error is less than the standard deviation of</span>
    <span class="comment"># the entries in the matrix.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvd'</span><span class="grouping">)</span>
    <span class="identifier">error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">sdev</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">A</span> <span class="arithmetic-operator">-</span> <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">error</span> <span class="relational-operator">&lt;=</span> <span class="identifier">sdev</span>


<span class="keyword">def</span> <span class="identifier">test_initialize_variants</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test NNDSVD variants correctness</span>
    <span class="comment"># Test that the variants 'nndsvda' and 'nndsvdar' differ from basic</span>
    <span class="comment"># 'nndsvd' only where the basic version has zeros.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">W0</span><span class="punctuation">,</span> <span class="identifier">H0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvd'</span><span class="grouping">)</span>
    <span class="identifier">Wa</span><span class="punctuation">,</span> <span class="identifier">Ha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvda'</span><span class="grouping">)</span>
    <span class="identifier">War</span><span class="punctuation">,</span> <span class="identifier">Har</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvdar'</span><span class="punctuation">,</span>
                                   <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">ref</span><span class="punctuation">,</span> <span class="identifier">evl</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">W0</span><span class="punctuation">,</span> <span class="identifier">Wa</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">W0</span><span class="punctuation">,</span> <span class="identifier">War</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">H0</span><span class="punctuation">,</span> <span class="identifier">Ha</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">H0</span><span class="punctuation">,</span> <span class="identifier">Har</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">evl</span><span class="grouping">[</span><span class="identifier">ref</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ref</span><span class="grouping">[</span><span class="identifier">ref</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="comment"># ignore UserWarning raised when both solver='mu' and init='nndsvd'</span>
<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">UserWarning</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ('cd', 'mu'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'init'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'nndsvd', 'nndsvda', 'nndsvdar', 'random'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_fit_nn_output</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the decomposition does not contain negative values</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">c_</span><span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">.</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">,</span>
              <span class="int-literal">5</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span>
                <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">transf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">components_</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span> <span class="logical-operator">or</span>
               <span class="grouping">(</span><span class="identifier">transf</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ('cd', 'mu'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_fit_close</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="comment"># Test that the fit is not too far away</span>
    <span class="identifier">pnmf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvdar'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
               <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">600</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">pnmf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reconstruction_err_</span> <span class="relational-operator">&lt;</span> <span class="float-literal">0.1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ('cd', 'mu'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_transform</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that NMF.transform returns close values</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span>
            <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span>
    <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ft</span><span class="punctuation">,</span> <span class="identifier">t</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nmf_transform_custom_init</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Smoke test that checks if NMF.transform works with custom initialization</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">avg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_components</span><span class="grouping">)</span>
    <span class="identifier">H_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">avg</span> <span class="arithmetic-operator">*</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">W_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">avg</span> <span class="arithmetic-operator">*</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cd', n_components=n_components, init='custom'</span><span class="punctuation">,</span>
            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="arithmetic-assignment">=</span><span class="identifier">W_init</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H_init</span><span class="grouping">)</span>
    <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ('cd', 'mu'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_inverse_transform</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that NMF.inverse_transform returns close values</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
            <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
    <span class="identifier">ft</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">A_new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">ft</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A_new</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_n_components_greater_n_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Smoke test for the case of more components than features.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># FIXME : should be removed in 1.1</span>
    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'random'</span>
    <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ['cd', 'mu'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_sparse_input</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that sparse matrices are accepted as input</span>
    <span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csc_matrix</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">A</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">A_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="identifier">est1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span>
               <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
               <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>
    <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">est1</span><span class="grouping">)</span>

    <span class="identifier">W1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">W2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A_sparse</span><span class="grouping">)</span>
    <span class="identifier">H1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est1</span><span class="punctuation">.</span><span class="identifier">components_</span>
    <span class="identifier">H2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">components_</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">W1</span><span class="punctuation">,</span> <span class="identifier">W2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">H1</span><span class="punctuation">,</span> <span class="identifier">H2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nmf_sparse_transform</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that transform works on sparse data.  Issue #2124</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">A</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'cd', 'mu'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                    <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">400</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'nndsvd'</span><span class="grouping">)</span>
        <span class="identifier">A_fit_tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
        <span class="identifier">A_tr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">A_fit_tr</span><span class="punctuation">,</span> <span class="identifier">A_tr</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'init', ['random', 'nndsvd'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'solver', ('cd', 'mu'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'regularization'</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">'both', 'components', 'transformation'</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_non_negative_factorization_consistency</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that the function is called in the same way, either directly</span>
    <span class="comment"># or through the NMF class</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">A</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>

    <span class="identifier">W_nmf</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
        <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>
    <span class="identifier">W_nmf_2</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
        <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
        <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>

    <span class="identifier">model_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                      <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span>
                      <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-2</span><span class="grouping">)</span>
    <span class="identifier">W_cls</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_class</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="identifier">W_cls_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model_class</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">W_nmf</span><span class="punctuation">,</span> <span class="identifier">W_cls</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">W_nmf_2</span><span class="punctuation">,</span> <span class="identifier">W_cls_2</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_non_negative_factorization_checking</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># Test parameters checking is public function</span>
    <span class="identifier">nnmf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Number of components must be a positive integer; "</span>
        <span class="string-literal">"got (n_components=1.5)"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nnmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span>
        <span class="string-literal">"Number of components must be a positive integer; "</span>
        <span class="string-literal">"got (n_components='2')"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nnmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="string-literal">'2', init='random'</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span><span class="string-literal">"Negative values in data passed to NMF (input H)"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nnmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span><span class="string-literal">"Negative values in data passed to NMF (input W)"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nnmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">re</span><span class="punctuation">.</span><span class="identifier">escape</span><span class="grouping">(</span><span class="string-literal">"Array passed to NMF (input H) is full of zeros"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nnmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">0</span> <span class="arithmetic-operator">*</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"Invalid regularization parameter: got 'spam' instead of one of"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nnmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">0</span> <span class="arithmetic-operator">*</span> <span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom', regularization='spam'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_beta_divergence_dense</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Compute the beta-divergence of X and W.H for dense array only.

    Used as a reference for testing nmf._beta_divergence.
    """</span>
    <span class="identifier">WH</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">beta</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">squared_norm</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">-</span> <span class="identifier">WH</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>

    <span class="identifier">WH_Xnonzero</span> <span class="arithmetic-assignment">=</span> <span class="identifier">WH</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">X_nonzero</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">X</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">WH_Xnonzero</span><span class="punctuation">,</span> <span class="float-literal">1e-9</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">WH_Xnonzero</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">beta</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X_nonzero</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">X_nonzero</span> <span class="arithmetic-operator">/</span> <span class="identifier">WH_Xnonzero</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">WH</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">elif</span> <span class="identifier">beta</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="identifier">div</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_nonzero</span> <span class="arithmetic-operator">/</span> <span class="identifier">WH_Xnonzero</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">div</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">div</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_nonzero</span> <span class="arithmetic-operator">**</span> <span class="identifier">beta</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">beta</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">WH</span> <span class="arithmetic-operator">**</span> <span class="identifier">beta</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">beta</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">X_nonzero</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">WH_Xnonzero</span> <span class="arithmetic-operator">**</span> <span class="grouping">(</span><span class="identifier">beta</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">res</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">beta</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">beta</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="keyword">return</span> <span class="identifier">res</span>


<span class="keyword">def</span> <span class="identifier">test_beta_divergence</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Compare _beta_divergence with the reference _beta_divergence_dense</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">beta_losses</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">]</span>

    <span class="comment"># initialization</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">beta</span> <span class="relational-operator">in</span> <span class="identifier">beta_losses</span><span class="punctuation">:</span>
        <span class="identifier">ref</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_beta_divergence_dense</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_beta_divergence</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="grouping">)</span>
        <span class="identifier">loss_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_beta_divergence</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ref</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">ref</span><span class="punctuation">,</span> <span class="identifier">loss_csr</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_special_sparse_dot</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the function that computes np.dot(W, H), only where X is non zero.</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">WH_safe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_special_sparse_dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">X_csr</span><span class="grouping">)</span>
    <span class="identifier">WH</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_special_sparse_dot</span><span class="grouping">(</span><span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># test that both results have same values, in X_csr nonzero elements</span>
    <span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">jj</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">nonzero</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">WH_safe_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">WH_safe</span><span class="grouping">[</span><span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">WH_safe_data</span><span class="punctuation">,</span> <span class="identifier">WH</span><span class="grouping">[</span><span class="identifier">ii</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>

    <span class="comment"># test that WH_safe and X_csr have the same sparse structure</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">WH_safe</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">WH_safe</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="punctuation">,</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">WH_safe</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_multiplicative_update_sparse</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Compare sparse and dense input in multiplicative update NMF</span>
    <span class="comment"># Also test continuity of the results with respect to beta_loss parameter</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>
    <span class="identifier">l1_ratio</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span>
    <span class="identifier">n_iter</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>

    <span class="comment"># initialization</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1337</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">W0</span><span class="punctuation">,</span> <span class="identifier">H0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">beta_loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">-1.2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Reference with dense array X</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">H0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">W1</span><span class="punctuation">,</span> <span class="identifier">H1</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mu'</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="identifier">beta_loss</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="string-literal">'both'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

        <span class="comment"># Compare with sparse X</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">H0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">W2</span><span class="punctuation">,</span> <span class="identifier">H2</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
            <span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mu'</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="identifier">beta_loss</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="string-literal">'both'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">W1</span><span class="punctuation">,</span> <span class="identifier">W2</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">H1</span><span class="punctuation">,</span> <span class="identifier">H2</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">7</span><span class="grouping">)</span>

        <span class="comment"># Compare with almost same beta_loss, since some values have a specific</span>
        <span class="comment"># behavior, but the results should be continuous w.r.t beta_loss</span>
        <span class="identifier">beta_loss</span> <span class="arithmetic-assignment">-=</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="identifier">e</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">H0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">W3</span><span class="punctuation">,</span> <span class="identifier">H3</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
            <span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
            <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">'mu'</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="identifier">beta_loss</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
            <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="string-literal">'both'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">W1</span><span class="punctuation">,</span> <span class="identifier">W3</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">H1</span><span class="punctuation">,</span> <span class="identifier">H3</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nmf_negative_beta_loss</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that an error is raised if beta_loss &lt; 0 and X contains zeros.</span>
    <span class="comment"># Test that the output has not NaN values when the input contains zeros.</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_assert_nmf_no_nan</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random', n_components=n_components, solver='mu'</span><span class="punctuation">,</span>
            <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="identifier">beta_loss</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1000</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">W</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isnan</span><span class="grouping">(</span><span class="identifier">H</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"When beta_loss &lt;= 0 and X contains zeros, the solver may diverge."</span>
    <span class="keyword">for</span> <span class="identifier">beta_loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">-0.6</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">_assert_nmf_no_nan</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="grouping">)</span>
        <span class="identifier">_assert_nmf_no_nan</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1e-9</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">beta_loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_assert_nmf_no_nan</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="grouping">)</span>
        <span class="identifier">_assert_nmf_no_nan</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nmf_regularization</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test the effect of L1 and L2 regularizations</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">6</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># FIXME : should be removed in 1.1</span>
    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'nndsvda'</span>
    <span class="comment"># L1 regularization should increase the number of zeros</span>
    <span class="identifier">l1_ratio</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'cd', 'mu'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">regul</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                        <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                        <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>
        <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                        <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                        <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>

        <span class="identifier">W_regul</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regul</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">W_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">H_regul</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regul</span><span class="punctuation">.</span><span class="identifier">components_</span>
        <span class="identifier">H_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">components_</span>

        <span class="identifier">W_regul_n_zeros</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W_regul</span><span class="grouping">[</span><span class="identifier">W_regul</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span>
        <span class="identifier">W_model_n_zeros</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W_model</span><span class="grouping">[</span><span class="identifier">W_model</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span>
        <span class="identifier">H_regul_n_zeros</span> <span class="arithmetic-assignment">=</span> <span class="identifier">H_regul</span><span class="grouping">[</span><span class="identifier">H_regul</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span>
        <span class="identifier">H_model_n_zeros</span> <span class="arithmetic-assignment">=</span> <span class="identifier">H_model</span><span class="grouping">[</span><span class="identifier">H_model</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">size</span>

        <span class="keyword">assert</span> <span class="identifier">W_regul_n_zeros</span> <span class="relational-operator">&gt;</span> <span class="identifier">W_model_n_zeros</span>
        <span class="keyword">assert</span> <span class="identifier">H_regul_n_zeros</span> <span class="relational-operator">&gt;</span> <span class="identifier">H_model_n_zeros</span>

    <span class="comment"># L2 regularization should decrease the mean of the coefficients</span>
    <span class="identifier">l1_ratio</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
    <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'cd', 'mu'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">regul</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                        <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                        <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>
        <span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span>
                        <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="punctuation">,</span>
                        <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>

        <span class="identifier">W_regul</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regul</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">W_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">H_regul</span> <span class="arithmetic-assignment">=</span> <span class="identifier">regul</span><span class="punctuation">.</span><span class="identifier">components_</span>
        <span class="identifier">H_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">components_</span>

        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">W_model</span><span class="grouping">)</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">H_model</span><span class="grouping">)</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="relational-operator">&gt;</span> <span class="invalid">\</span>
               <span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">W_regul</span><span class="grouping">)</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">norm</span><span class="grouping">(</span><span class="identifier">H_regul</span><span class="grouping">)</span><span class="grouping">)</span><span class="arithmetic-operator">**</span><span class="int-literal">2</span><span class="punctuation">.</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_decreasing</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test that the objective function is decreasing at each iteration</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">20</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">15</span>
    <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>
    <span class="identifier">l1_ratio</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span>
    <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="comment"># initialization</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">W0</span><span class="punctuation">,</span> <span class="identifier">H0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'random'</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">beta_loss</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="float-literal">-1.2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">solver</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'cd', 'mu'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">solver</span> <span class="relational-operator">!=</span> <span class="string-literal">'mu'</span> <span class="logical-operator">and</span> <span class="identifier">beta_loss</span> <span class="relational-operator">!=</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                <span class="comment"># not implemented</span>
                <span class="keyword">continue</span>
            <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">W0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">H0</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">previous_loss</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
            <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># one more iteration starting from the previous results</span>
                <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">non_negative_factorization</span><span class="grouping">(</span>
                    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="arithmetic-assignment">=</span><span class="identifier">beta_loss</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="punctuation">,</span>
                    <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span>
                    <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">l1_ratio</span><span class="arithmetic-assignment">=</span><span class="identifier">l1_ratio</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                    <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="string-literal">'both'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

                <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_beta_divergence</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta_loss</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">previous_loss</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                    <span class="keyword">assert</span> <span class="identifier">previous_loss</span> <span class="relational-operator">&gt;</span> <span class="identifier">loss</span>
                <span class="identifier">previous_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span>


<span class="keyword">def</span> <span class="identifier">test_nmf_underflow</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Regression test for an underflow issue in _beta_divergence</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">10</span>
    <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">10</span>
    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">ref</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_beta_divergence</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-323</span>
    <span class="identifier">res</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_beta_divergence</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">res</span><span class="punctuation">,</span> <span class="identifier">ref</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dtype_in, dtype_out"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int32</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"solver", ["cd", "mu"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"regularization"</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">"both", "components", "transformation"</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_dtype_match</span><span class="grouping">(</span><span class="identifier">dtype_in</span><span class="punctuation">,</span> <span class="identifier">dtype_out</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that NMF preserves dtype (float32 and float64)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype_in</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># FIXME : should be removed in 1.1</span>
    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'nndsvda'</span>
    <span class="identifier">nmf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype_out</span>
    <span class="keyword">assert</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype_out</span>
    <span class="keyword">assert</span> <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">dtype_out</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"solver", ["cd", "mu"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"regularization"</span><span class="punctuation">,</span>
                         <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="string-literal">"both", "components", "transformation"</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_nmf_float32_float64_consistency</span><span class="grouping">(</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that the result of NMF is the same between float32 and float64</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># FIXME : should be removed in 1.1</span>
    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'nndsvda'</span>
    <span class="identifier">nmf32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>
    <span class="identifier">W32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf32</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">nmf64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="identifier">solver</span><span class="punctuation">,</span> <span class="identifier">regularization</span><span class="arithmetic-assignment">=</span><span class="identifier">regularization</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="grouping">)</span>
    <span class="identifier">W64</span> <span class="arithmetic-assignment">=</span> <span class="identifier">nmf64</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">W32</span><span class="punctuation">,</span> <span class="identifier">W64</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-6</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_nmf_custom_init_dtype_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that an error is raise if custom H and/or W don't have the same</span>
    <span class="comment"># dtype as X.</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">H</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">15</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">W</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"should have the same dtype as X"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'custom'</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">W</span><span class="arithmetic-assignment">=</span><span class="identifier">W</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"should have the same dtype as X"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">non_negative_factorization</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">H</span><span class="arithmetic-assignment">=</span><span class="identifier">H</span><span class="punctuation">,</span> <span class="identifier">update_H</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>


<span class="comment"># FIXME : should be removed in 1.1</span>
<span class="keyword">def</span> <span class="identifier">test_init_default_deprecation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test FutureWarning on init default</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"The 'init' value, when 'init=None' and "</span>
           <span class="identifier">r</span><span class="string-literal">"n_components is less than n_samples and "</span>
           <span class="identifier">r</span><span class="string-literal">"n_features, will be changed from 'nndsvd' to "</span>
           <span class="identifier">r</span><span class="string-literal">"'nndsvda' in 1.1 \(renaming of 0.26\)."</span><span class="grouping">)</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">mtrand</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">nmf</span><span class="punctuation">.</span><span class="identifier">_initialize_nmf</span><span class="grouping">(</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">NMF</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">non_negative_factorization</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span>

    </pre>
  </body>
</html>