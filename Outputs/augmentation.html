<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Processes the augmentation of images for feeding into a Faceswap model. """</span>
<span class="keyword">import</span> <span class="identifier">logging</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">interpolate</span> <span class="keyword">import</span> <span class="identifier">griddata</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="identifier">batch_convert_color</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint: disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">ImageAugmentation</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Performs augmentation on batches of training images.

    Parameters
    ----------
    batchsize: int
        The number of images that will be fed through the augmentation functions at once.
    is_display: bool
        Whether the images being fed through will be used for Preview or Time-lapse. Disables
        the "warp" augmentation for these images.
    input_size: int
        The expected input size for the model. It is assumed that the input to the model is always
        a square image. This is the size, in pixels, of the `width` and the `height` of the input
        to the model.
    output_shapes: list
        A list of tuples defining the output shapes from the model, in the order that the outputs
        are returned. The tuples should be in (`height`, `width`, `channels`) format.
    coverage_ratio: float
        The ratio of the training image to be trained on. Dictates how much of the image will be
        cropped out. E.G: a coverage ratio of 0.625 will result in cropping a 160px box from a
        256px image (:math:`256 * 0.625 = 160`)
    config: dict
        The configuration `dict` generated from :file:`config.train.ini` containing the trainer
        plugin configuration options.

    Attributes
    ----------
    initialized: bool
        Flag to indicate whether :class:`ImageAugmentation` has been initialized with the training
        image size in order to cache certain augmentation operations (see :func:`initialize`)
    is_display: bool
        Flag to indicate whether these augmentations are for time-lapses/preview images (``True``)
        or standard training data (``False``)
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batchsize</span><span class="punctuation">,</span> <span class="identifier">is_display</span><span class="punctuation">,</span> <span class="identifier">input_size</span><span class="punctuation">,</span> <span class="identifier">output_shapes</span><span class="punctuation">,</span> <span class="identifier">coverage_ratio</span><span class="punctuation">,</span> <span class="identifier">config</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing %s: (batchsize: %s, is_display: %s, input_size: %s, "</span>
                     <span class="string-literal">"output_shapes: %s, coverage_ratio: %s, config: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">batchsize</span><span class="punctuation">,</span> <span class="identifier">is_display</span><span class="punctuation">,</span> <span class="identifier">input_size</span><span class="punctuation">,</span> <span class="identifier">output_shapes</span><span class="punctuation">,</span>
                     <span class="identifier">coverage_ratio</span><span class="punctuation">,</span> <span class="identifier">config</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_display</span> <span class="arithmetic-assignment">=</span> <span class="identifier">is_display</span>

        <span class="comment"># Set on first image load from initialize</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batchsize</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">config</span>
        <span class="comment"># Transform and Warp args</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_sizes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">shape</span> <span class="relational-operator">in</span> <span class="identifier">output_shapes</span> <span class="keyword">if</span> <span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Output sizes: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_sizes</span><span class="grouping">)</span>
        <span class="comment"># Warp args</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_coverage_ratio</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coverage_ratio</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>  <span class="comment"># Normal random variable scale</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">initialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">training_size</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initializes the caching of constants for use in various image augmentations.

        The training image size is not known prior to loading the images from disk and commencing
        training, so it cannot be set in the :func:`__init__` method. When the first training batch
        is loaded this function should be called to initialize the class and perform various
        calculations based on this input size to cache certain constants for image augmentation
        calculations.

        Parameters
        ----------
        training_size: int
             The size of the training images stored on disk that are to be fed into
             :class:`ImageAugmentation`. The training images should always be square and of the
             same size. This is the size, in pixels, of the `width` and the `height` of the
             training images.
         """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing constants. training_size: %s"</span><span class="punctuation">,</span> <span class="identifier">training_size</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">training_size</span>
        <span class="identifier">coverage</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_coverage_ratio</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span>

        <span class="comment"># Color Aug</span>
        <span class="identifier">clahe_base_contrast</span> <span class="arithmetic-assignment">=</span> <span class="identifier">training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">128</span>
        <span class="comment"># Target Images</span>
        <span class="identifier">tgt_slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="identifier">coverage</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                           <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">coverage</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span>

        <span class="comment"># Random Warp</span>
        <span class="identifier">warp_range_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span> <span class="arithmetic-operator">-</span> <span class="identifier">coverage</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span>
                                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">coverage</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">warp_mapx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">broadcast_to</span><span class="grouping">(</span><span class="identifier">warp_range_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">warp_mapy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">broadcast_to</span><span class="grouping">(</span><span class="identifier">warp_mapx</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>

        <span class="identifier">warp_pad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">1.25</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_size</span><span class="grouping">)</span>
        <span class="identifier">warp_slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">warp_pad</span> <span class="arithmetic-operator">//</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">warp_pad</span> <span class="arithmetic-operator">//</span> <span class="int-literal">10</span><span class="grouping">)</span>

        <span class="comment"># Random Warp Landmarks</span>
        <span class="identifier">p_mx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="identifier">p_hf</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="identifier">edge_anchors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">p_mx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_mx</span><span class="punctuation">,</span> <span class="identifier">p_mx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_mx</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="grouping">(</span><span class="identifier">p_hf</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_hf</span><span class="punctuation">,</span> <span class="identifier">p_mx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_mx</span><span class="punctuation">,</span> <span class="identifier">p_hf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">p_hf</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span>
        <span class="identifier">edge_anchors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">broadcast_to</span><span class="grouping">(</span><span class="identifier">edge_anchors</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">grids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mgrid</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">p_mx</span><span class="punctuation">:</span><span class="identifier">complex</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">p_mx</span><span class="punctuation">:</span><span class="identifier">complex</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">clahe_base_contrast</span><span class="arithmetic-assignment">=</span><span class="identifier">clahe_base_contrast</span><span class="punctuation">,</span>
                               <span class="identifier">tgt_slices</span><span class="arithmetic-assignment">=</span><span class="identifier">tgt_slices</span><span class="punctuation">,</span>
                               <span class="identifier">warp_mapx</span><span class="arithmetic-assignment">=</span><span class="identifier">warp_mapx</span><span class="punctuation">,</span>
                               <span class="identifier">warp_mapy</span><span class="arithmetic-assignment">=</span><span class="identifier">warp_mapy</span><span class="punctuation">,</span>
                               <span class="identifier">warp_pad</span><span class="arithmetic-assignment">=</span><span class="identifier">warp_pad</span><span class="punctuation">,</span>
                               <span class="identifier">warp_slices</span><span class="arithmetic-assignment">=</span><span class="identifier">warp_slices</span><span class="punctuation">,</span>
                               <span class="identifier">warp_lm_edge_anchors</span><span class="arithmetic-assignment">=</span><span class="identifier">edge_anchors</span><span class="punctuation">,</span>
                               <span class="identifier">warp_lm_grids</span><span class="arithmetic-assignment">=</span><span class="identifier">grids</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">initialized</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized constants: %s"</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">v</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="identifier">v</span>
                                                   <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>

    <span class="comment"># &lt;&lt;&lt; TARGET IMAGES &gt;&gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">get_targets</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Returns the target images, and masks, if required.

        Parameters
        ----------
        batch: :class:`numpy.ndarray`
            This should be a 4+-dimensional array of training images in the format (`batchsize`,
            `height`, `width`, `channels`). Targets should be requested after performing image
            transformations but prior to performing warps.

            The 4th channel should be the mask. Any channels above the 4th should be any additional
            masks that are requested.

        Returns
        -------
        dict
            The following keys will be within the returned dictionary:

            * **targets** (`list`) - A list of 4-dimensional :class:`numpy.ndarray` s in the \
            order and size of each output of the model as defined in :attr:`output_shapes`. The \
            format of these arrays will be (`batchsize`, `height`, `width`, `3`). **NB:** \
            masks are not included in the `targets` list. If masks are to be included in the \
            output they will be returned as their own item from the `masks` key.

            * **masks** (:class:`numpy.ndarray`) - A 4-dimensional array containing the target \
            masks in the format (`batchsize`, `height`, `width`, `1`).
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Compiling targets: batch shape: %s"</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"tgt_slices"</span><span class="grouping">]</span>
        <span class="identifier">target_batch</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">[</span><span class="identifier">slices</span><span class="punctuation">,</span> <span class="identifier">slices</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                                             <span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">,</span>
                                             <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span><span class="grouping">)</span>
                                  <span class="keyword">for</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">batch</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">255</span><span class="punctuation">.</span>
                        <span class="keyword">for</span> <span class="identifier">size</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_output_sizes</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Target image shapes: %s"</span><span class="punctuation">,</span>
                     <span class="grouping">[</span><span class="identifier">tgt_images</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">for</span> <span class="identifier">tgt_images</span> <span class="relational-operator">in</span> <span class="identifier">target_batch</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_separate_target_mask</span><span class="grouping">(</span><span class="identifier">target_batch</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Final targets: %s"</span><span class="punctuation">,</span>
                     <span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="identifier">img</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">v</span><span class="grouping">]</span>
                      <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_separate_target_mask</span><span class="grouping">(</span><span class="identifier">target_batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the batch and the batch of final masks

        Parameters
        ----------
        target_batch: list
            List of 4 dimension :class:`numpy.ndarray` objects resized the model outputs.
            The 4th channel of the array contains the face mask, any additional channels after
            this are additional masks (e.g. eye mask and mouth mask)

        Returns
        -------
        dict:
            The targets and the masks separated into their own items. The targets are a list of
            3 channel, 4 dimensional :class:`numpy.ndarray` objects sized for each output from the
            model. The masks are a :class:`numpy.ndarray` of the final output size. Any additional
            masks(e.g. eye and mouth masks) will be collated together into a :class:`numpy.ndarray`
            of the final output size. The number of channels will be the number of additional
            masks available
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"target_batch shapes: %s"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">tgt</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">for</span> <span class="identifier">tgt</span> <span class="relational-operator">in</span> <span class="identifier">target_batch</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">targets</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">batch</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">batch</span> <span class="relational-operator">in</span> <span class="identifier">target_batch</span><span class="grouping">]</span><span class="punctuation">,</span>
                      <span class="identifier">masks</span><span class="arithmetic-assignment">=</span><span class="identifier">target_batch</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">target_batch</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">4</span><span class="punctuation">:</span>
            <span class="identifier">retval</span><span class="grouping">[</span><span class="string-literal">"additional_masks"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">target_batch</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"returning: %s"</span><span class="punctuation">,</span> <span class="grouping">{</span><span class="identifier">k</span><span class="punctuation">:</span> <span class="identifier">v</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span> <span class="keyword">else</span> <span class="grouping">[</span><span class="identifier">tgt</span><span class="punctuation">.</span><span class="identifier">shape</span>
                                                                                     <span class="keyword">for</span> <span class="identifier">tgt</span> <span class="relational-operator">in</span> <span class="identifier">v</span><span class="grouping">]</span>
                                       <span class="keyword">for</span> <span class="identifier">k</span><span class="punctuation">,</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="comment"># &lt;&lt;&lt; COLOR AUGMENTATION &gt;&gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">color_adjust</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform color augmentation on the passed in batch.

        The color adjustment parameters are set in :file:`config.train.ini`

        Parameters
        ----------
        batch: :class:`numpy.ndarray`
            The batch should be a 4-dimensional array of shape (`batchsize`, `height`, `width`,
            `3`) and in `BGR` format.

        Returns
        ----------
        :class:`numpy.ndarray`
            A 4-dimensional array of the same shape as :attr:`batch` with color augmentation
            applied.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_display</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Augmenting color"</span><span class="grouping">)</span>
            <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch_convert_color</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="string-literal">"BGR2LAB"</span><span class="grouping">)</span>
            <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_random_clahe</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span>
            <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_random_lab</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span>
            <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch_convert_color</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="string-literal">"LAB2BGR"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">_random_clahe</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Randomly perform Contrast Limited Adaptive Histogram Equalization on
        a batch of images """</span>
        <span class="identifier">base_contrast</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"clahe_base_contrast"</span><span class="grouping">]</span>

        <span class="identifier">batch_random</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="grouping">)</span>
        <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">batch_random</span> <span class="relational-operator">&lt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"color_clahe_chance"</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">any</span><span class="grouping">(</span><span class="identifier">indices</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">batch</span>

        <span class="identifier">grid_bases</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">rint</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                               <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"color_clahe_max_size"</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span>
                                               <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">indices</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"uint8"</span><span class="grouping">)</span>
        <span class="identifier">contrast_adjustment</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">grid_bases</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">base_contrast</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">grid_sizes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">contrast_adjustment</span> <span class="arithmetic-operator">+</span> <span class="identifier">base_contrast</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Adjusting Contrast. Grid Sizes: %s"</span><span class="punctuation">,</span> <span class="identifier">grid_sizes</span><span class="grouping">)</span>

        <span class="identifier">clahes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">createCLAHE</span><span class="grouping">(</span><span class="identifier">clipLimit</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="punctuation">,</span>  <span class="comment"># pylint: disable=no-member</span>
                                  <span class="identifier">tileGridSize</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">grid_size</span><span class="punctuation">,</span> <span class="identifier">grid_size</span><span class="grouping">)</span><span class="grouping">)</span>
                  <span class="keyword">for</span> <span class="identifier">grid_size</span> <span class="relational-operator">in</span> <span class="identifier">grid_sizes</span><span class="grouping">]</span>

        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">clahe</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">clahes</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">batch</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clahe</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">_random_lab</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform random color/lightness adjustment in L*a*b* color space on a batch of
        images """</span>
        <span class="identifier">amount_l</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"color_lightness"</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span>
        <span class="identifier">amount_ab</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"color_ab"</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span>
        <span class="identifier">adjust</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">amount_l</span><span class="punctuation">,</span> <span class="identifier">amount_ab</span><span class="punctuation">,</span> <span class="identifier">amount_ab</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">randoms</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
            <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">adjust</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">adjust</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Random LAB adjustments: %s"</span><span class="punctuation">,</span> <span class="identifier">randoms</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">rand</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">randoms</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">rand</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">adjustment</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rand</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
                <span class="keyword">if</span> <span class="identifier">adjustment</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                    <span class="identifier">image</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">255</span> <span class="arithmetic-operator">-</span> <span class="identifier">image</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">adjustment</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">image</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">image</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">adjustment</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="comment"># &lt;&lt;&lt; IMAGE AUGMENTATION &gt;&gt;&gt; #</span>
    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform random transformation on the passed in batch.

        The transformation parameters are set in :file:`config.train.ini`

        Parameters
        ----------
        batch: :class:`numpy.ndarray`
            The batch should be a 4-dimensional array of shape (`batchsize`, `height`, `width`,
            `channels`) and in `BGR` format.

        Returns
        ----------
        :class:`numpy.ndarray`
            A 4-dimensional array of the same shape as :attr:`batch` with transformation applied.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_display</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">batch</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Randomly transforming image"</span><span class="grouping">)</span>
        <span class="identifier">rotation_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"rotation_range"</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
        <span class="identifier">zoom_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"zoom_amount"</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span>
        <span class="identifier">shift_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"shift_range"</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span>

        <span class="identifier">rotation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">rotation_range</span><span class="punctuation">,</span>
                                     <span class="identifier">rotation_range</span><span class="punctuation">,</span>
                                     <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">zoom_range</span><span class="punctuation">,</span>
                                  <span class="int-literal">1</span> <span class="arithmetic-operator">+</span> <span class="identifier">zoom_range</span><span class="punctuation">,</span>
                                  <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">tform</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span>
            <span class="arithmetic-operator">-</span><span class="identifier">shift_range</span><span class="punctuation">,</span>
            <span class="identifier">shift_range</span><span class="punctuation">,</span>
            <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span>

        <span class="identifier">mats</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
            <span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">getRotationMatrix2D</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span>
                                     <span class="identifier">rot</span><span class="punctuation">,</span>
                                     <span class="identifier">scl</span><span class="grouping">)</span>
             <span class="keyword">for</span> <span class="identifier">rot</span><span class="punctuation">,</span> <span class="identifier">scl</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">rotation</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">mats</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">tform</span>

        <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">warpAffine</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span>
                                         <span class="identifier">mat</span><span class="punctuation">,</span>
                                         <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span><span class="grouping">)</span><span class="punctuation">,</span>
                                         <span class="identifier">borderMode</span><span class="arithmetic-assignment">=</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">BORDER_REPLICATE</span><span class="grouping">)</span>
                          <span class="keyword">for</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">mat</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">mats</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Randomly transformed image"</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">random_flip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform random horizontal flipping on the passed in batch.

        The probability of flipping an image is set in :file:`config.train.ini`

        Parameters
        ----------
        batch: :class:`numpy.ndarray`
            The batch should be a 4-dimensional array of shape (`batchsize`, `height`, `width`,
            `channels`) and in `BGR` format.

        Returns
        ----------
        :class:`numpy.ndarray`
            A 4-dimensional array of the same shape as :attr:`batch` with transformation applied.
        """</span>
        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">is_display</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Randomly flipping image"</span><span class="grouping">)</span>
            <span class="identifier">randoms</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="grouping">)</span>
            <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">randoms</span> <span class="relational-operator">&gt;</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_config</span><span class="punctuation">.</span><span class="identifier">get</span><span class="grouping">(</span><span class="string-literal">"random_flip"</span><span class="punctuation">,</span> <span class="int-literal">50</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">batch</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="grouping">[</span><span class="identifier">indices</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Randomly flipped %s images of %s"</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">indices</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">warp</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">to_landmarks</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform random warping on the passed in batch by one of two methods.

        Parameters
        ----------
        batch: :class:`numpy.ndarray`
            The batch should be a 4-dimensional array of shape (`batchsize`, `height`, `width`,
            `3`) and in `BGR` format.
        to_landmarks: bool, optional
            If ``False`` perform standard random warping of the input image. If ``True`` perform
            warping to semi-random similar corresponding landmarks from the other side. Default:
            ``False``
        kwargs: dict
            If :attr:`to_landmarks` is ``True`` the following additional kwargs must be passed in:

            * **batch_src_points** (:class:`numpy.ndarray`) - A batch of 68 point landmarks for \
            the source faces. This is a 3-dimensional array in the shape (`batchsize`, `68`, `2`).

            * **batch_dst_points** (:class:`numpy.ndarray`) - A batch of randomly chosen closest \
            match destination faces landmarks. This is a 3-dimensional array in the shape \
            (`batchsize`, `68`, `2`).
        Returns
        ----------
        :class:`numpy.ndarray`
            A 4-dimensional array of the same shape as :attr:`batch` with warping applied.
        """</span>
        <span class="keyword">if</span> <span class="identifier">to_landmarks</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_random_warp_landmarks</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">255.0</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_random_warp</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">255.0</span>

    <span class="keyword">def</span> <span class="identifier">_random_warp</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Randomly warp the input batch """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Randomly warping batch"</span><span class="grouping">)</span>
        <span class="identifier">mapx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"warp_mapx"</span><span class="grouping">]</span>
        <span class="identifier">mapy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"warp_mapy"</span><span class="grouping">]</span>
        <span class="identifier">pad</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"warp_pad"</span><span class="grouping">]</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"warp_slices"</span><span class="grouping">]</span>

        <span class="identifier">rands</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">batch_maps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">stack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">mapx</span><span class="punctuation">,</span> <span class="identifier">mapy</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">rands</span>
        <span class="identifier">batch_interp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">map_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">pad</span><span class="punctuation">,</span> <span class="identifier">pad</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="identifier">slices</span><span class="punctuation">,</span> <span class="identifier">slices</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">map_</span> <span class="relational-operator">in</span> <span class="identifier">maps</span><span class="grouping">]</span>
                                 <span class="keyword">for</span> <span class="identifier">maps</span> <span class="relational-operator">in</span> <span class="identifier">batch_maps</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">warped_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">remap</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">interp</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">interp</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_LINEAR</span><span class="grouping">)</span>
                                 <span class="keyword">for</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">interp</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">batch_interp</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Warped image shape: %s"</span><span class="punctuation">,</span> <span class="identifier">warped_batch</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">warped_batch</span>

    <span class="keyword">def</span> <span class="identifier">_random_warp_landmarks</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">batch_src_points</span><span class="punctuation">,</span> <span class="identifier">batch_dst_points</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" From dfaker. Warp the image to a similar set of landmarks from the opposite side """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Randomly warping landmarks"</span><span class="grouping">)</span>
        <span class="identifier">edge_anchors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"warp_lm_edge_anchors"</span><span class="grouping">]</span>
        <span class="identifier">grids</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"warp_lm_grids"</span><span class="grouping">]</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"tgt_slices"</span><span class="grouping">]</span>

        <span class="identifier">batch_dst</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">batch_dst_points</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">batch_dst_points</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span>
                                                         <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">face_cores</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">convexHull</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">src</span><span class="grouping">[</span><span class="int-literal">17</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">[</span><span class="int-literal">17</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
                      <span class="keyword">for</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch_src_points</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span><span class="punctuation">,</span>
                                          <span class="identifier">batch_dst</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"int32"</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">batch_src</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">batch_src_points</span><span class="punctuation">,</span> <span class="identifier">edge_anchors</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">batch_dst</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">batch_dst</span><span class="punctuation">,</span> <span class="identifier">edge_anchors</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">rem_indices</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">list</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">idx</span> <span class="keyword">for</span> <span class="identifier">fpl</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="grouping">)</span>
                                <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">pty</span><span class="punctuation">,</span> <span class="identifier">ptx</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">fpl</span><span class="grouping">)</span>
                                <span class="keyword">if</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">pointPolygonTest</span><span class="grouping">(</span><span class="identifier">face_core</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">pty</span><span class="punctuation">,</span> <span class="identifier">ptx</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
                       <span class="keyword">for</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">face_core</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch_src</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">18</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                      <span class="identifier">batch_dst</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">18</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                      <span class="identifier">face_cores</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">batch_src</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">idxs</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">idxs</span><span class="punctuation">,</span> <span class="identifier">src</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">rem_indices</span><span class="punctuation">,</span> <span class="identifier">batch_src</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">batch_dst</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">idxs</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">idxs</span><span class="punctuation">,</span> <span class="identifier">dst</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">rem_indices</span><span class="punctuation">,</span> <span class="identifier">batch_dst</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">grid_z</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">griddata</span><span class="grouping">(</span><span class="identifier">dst</span><span class="punctuation">,</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">grids</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">grids</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="grouping">)</span>
                           <span class="keyword">for</span> <span class="identifier">src</span><span class="punctuation">,</span> <span class="identifier">dst</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch_src</span><span class="punctuation">,</span> <span class="identifier">batch_dst</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">maps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_z</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_batchsize</span><span class="punctuation">,</span>
                               <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span><span class="punctuation">,</span>
                               <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_training_size</span><span class="punctuation">,</span>
                               <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
        <span class="identifier">warped_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">remap</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span>
                                           <span class="identifier">map_</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                           <span class="identifier">map_</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                           <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_LINEAR</span><span class="punctuation">,</span>
                                           <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">BORDER_TRANSPARENT</span><span class="grouping">)</span>
                                 <span class="keyword">for</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">map_</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">maps</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">warped_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">[</span><span class="identifier">slices</span><span class="punctuation">,</span> <span class="identifier">slices</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                                            <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_size</span><span class="grouping">)</span><span class="punctuation">,</span>
                                            <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span><span class="grouping">)</span>
                                 <span class="keyword">for</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">warped_batch</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Warped batch shape: %s"</span><span class="punctuation">,</span> <span class="identifier">warped_batch</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">warped_batch</span>

    <span class="keyword">def</span> <span class="identifier">skip_warp</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Returns the images resized and cropped for feeding the model, if warping has been
        disabled.

        Parameters
        ----------
        batch: :class:`numpy.ndarray`
            The batch should be a 4-dimensional array of shape (`batchsize`, `height`, `width`,
            `3`) and in `BGR` format.

        Returns
        -------
        :class:`numpy.ndarray`
            The given batch cropped and resized for feeding the model
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"Compiling skip warp images: batch shape: %s"</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_constants</span><span class="grouping">[</span><span class="string-literal">"tgt_slices"</span><span class="grouping">]</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">[</span><span class="identifier">slices</span><span class="punctuation">,</span> <span class="identifier">slices</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                                      <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_input_size</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">INTER_AREA</span><span class="grouping">)</span>
                           <span class="keyword">for</span> <span class="identifier">image</span> <span class="relational-operator">in</span> <span class="identifier">batch</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">255</span><span class="punctuation">.</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"feed batch shape: %s"</span><span class="punctuation">,</span> <span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    </pre>
  </body>
</html>