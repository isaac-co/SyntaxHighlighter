<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Authors: Tom Dupre la Tour &lt;tom.dupre-la-tour@m4x.org&gt;</span>
<span class="comment">#          Olivier Grisel &lt;olivier.grisel@ensta.org&gt;</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">matplotlib</span><span class="punctuation">.</span><span class="identifier">pyplot</span> <span class="keyword">as</span> <span class="identifier">plt</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Memory</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">gc</span>
<span class="keyword">import</span> <span class="identifier">time</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">LogisticRegression</span><span class="punctuation">,</span> <span class="identifier">SGDClassifier</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">fetch_rcv1</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span><span class="punctuation">.</span><span class="identifier">_sag</span> <span class="keyword">import</span> <span class="identifier">get_auto_step_size</span>

<span class="keyword">try</span><span class="punctuation">:</span>
    <span class="keyword">import</span> <span class="identifier">lightning</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">c</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span> <span class="keyword">as</span> <span class="identifier">lightning_clf</span>
<span class="keyword">except</span> <span class="invalid">I</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
    <span class="identifier">lightning_clf</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>

<span class="identifier">m</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Memory</span><span class="grouping">(</span><span class="identifier">cachedir</span><span class="arithmetic-assignment">=</span><span class="string-literal">'.'</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>


<span class="comment"># compute logistic loss</span>
<span class="keyword">def</span> <span class="identifier">get_loss</span><span class="grouping">(</span><span class="identifier">w</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="punctuation">,</span> <span class="identifier">myX</span><span class="punctuation">,</span> <span class="identifier">myy</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">myX</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">myy</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">myX</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">intercept</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"%f + %f"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">C</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">w</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">w</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">C</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>
    <span class="keyword">return</span> <span class="identifier">p</span>


<span class="comment"># We use joblib to cache individual fits. Note that we do not pass the dataset</span>
<span class="comment"># as argument as the hashing would be too slow, so we assume that the dataset</span>
<span class="comment"># never changes.</span>
<span class="punctuation">@</span><span class="identifier">m</span><span class="punctuation">.</span><span class="identifier">cache</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">bench_one</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">clf_type</span><span class="punctuation">,</span> <span class="identifier">clf_params</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf_type</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">clf_params</span><span class="grouping">)</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="keyword">except</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">n_iter</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="identifier">st</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>
    <span class="keyword">except</span><span class="punctuation">:</span>
        <span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">C</span>

    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">intercept_</span>
    <span class="keyword">except</span><span class="punctuation">:</span>
        <span class="identifier">intercept</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>

    <span class="identifier">train_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_loss</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="grouping">)</span>
    <span class="identifier">train_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">test_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>
    <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">end</span> <span class="arithmetic-operator">-</span> <span class="identifier">st</span>

    <span class="keyword">return</span> <span class="identifier">train_loss</span><span class="punctuation">,</span> <span class="identifier">train_score</span><span class="punctuation">,</span> <span class="identifier">test_score</span><span class="punctuation">,</span> <span class="identifier">duration</span>


<span class="keyword">def</span> <span class="identifier">bench</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">iter_range</span><span class="punctuation">,</span> <span class="identifier">train_losses</span><span class="punctuation">,</span> <span class="identifier">train_scores</span><span class="punctuation">,</span>
         <span class="identifier">test_scores</span><span class="punctuation">,</span> <span class="identifier">durations</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"training %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">name</span><span class="grouping">)</span>
        <span class="identifier">clf_type</span> <span class="arithmetic-assignment">=</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">clf</span><span class="grouping">)</span>
        <span class="identifier">clf_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">n_iter</span> <span class="relational-operator">in</span> <span class="identifier">iter_range</span><span class="punctuation">:</span>
            <span class="identifier">gc</span><span class="punctuation">.</span><span class="identifier">collect</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="identifier">train_loss</span><span class="punctuation">,</span> <span class="identifier">train_score</span><span class="punctuation">,</span> <span class="identifier">test_score</span><span class="punctuation">,</span> <span class="identifier">duration</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bench_one</span><span class="grouping">(</span>
                <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">clf_type</span><span class="punctuation">,</span> <span class="identifier">clf_params</span><span class="punctuation">,</span> <span class="identifier">n_iter</span><span class="grouping">)</span>

            <span class="identifier">train_losses</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">train_loss</span><span class="grouping">)</span>
            <span class="identifier">train_scores</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">train_score</span><span class="grouping">)</span>
            <span class="identifier">test_scores</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">test_score</span><span class="grouping">)</span>
            <span class="identifier">durations</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">duration</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"classifier: %s"</span> <span class="arithmetic-operator">%</span> <span class="identifier">name</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"train_loss: %.8f"</span> <span class="arithmetic-operator">%</span> <span class="identifier">train_loss</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"train_score: %.8f"</span> <span class="arithmetic-operator">%</span> <span class="identifier">train_score</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"test_score: %.8f"</span> <span class="arithmetic-operator">%</span> <span class="identifier">test_score</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"time for fit: %.8f seconds"</span> <span class="arithmetic-operator">%</span> <span class="identifier">duration</span><span class="grouping">)</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">""</span><span class="grouping">)</span>

        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">""</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">clfs</span>


<span class="keyword">def</span> <span class="identifier">plot_train_losses</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">train_losses</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">durations</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">durations</span><span class="punctuation">,</span> <span class="identifier">train_losses</span><span class="punctuation">,</span> <span class="string-literal">'-o'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"seconds"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"train loss"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">plot_train_scores</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">train_scores</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">durations</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">durations</span><span class="punctuation">,</span> <span class="identifier">train_scores</span><span class="punctuation">,</span> <span class="string-literal">'-o'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"seconds"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"train score"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="grouping">(</span><span class="float-literal">0.92</span><span class="punctuation">,</span> <span class="float-literal">0.96</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">plot_test_scores</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">test_scores</span><span class="punctuation">,</span> <span class="identifier">durations</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">durations</span><span class="punctuation">,</span> <span class="identifier">test_scores</span><span class="punctuation">,</span> <span class="string-literal">'-o'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"seconds"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"test score"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylim</span><span class="grouping">(</span><span class="grouping">(</span><span class="float-literal">0.92</span><span class="punctuation">,</span> <span class="float-literal">0.96</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">plot_dloss</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">figure</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">pobj_final</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">train_losses</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">durations</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">pobj_final</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">train_losses</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">pobj_final</span><span class="grouping">)</span>
    <span class="identifier">pobj_best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pobj_final</span><span class="grouping">[</span><span class="identifier">indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">train_losses</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">durations</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">clfs</span><span class="punctuation">:</span>
        <span class="identifier">log_pobj</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">train_losses</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">pobj_best</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span>

        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">durations</span><span class="punctuation">,</span> <span class="identifier">log_pobj</span><span class="punctuation">,</span> <span class="string-literal">'-o'</span><span class="punctuation">,</span> <span class="identifier">label</span><span class="arithmetic-assignment">=</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">legend</span><span class="grouping">(</span><span class="identifier">loc</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">xlabel</span><span class="grouping">(</span><span class="string-literal">"seconds"</span><span class="grouping">)</span>
        <span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">ylabel</span><span class="grouping">(</span><span class="string-literal">"log(best - train_loss)"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">get_max_squared_sum</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Get the maximum row-wise sum of squares"""</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">X</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>

<span class="identifier">rcv1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fetch_rcv1</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rcv1</span><span class="punctuation">.</span><span class="identifier">data</span>
<span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>

<span class="comment"># consider the binary classification problem 'CCAT' vs the rest</span>
<span class="identifier">ccat_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rcv1</span><span class="punctuation">.</span><span class="identifier">target_names</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">index</span><span class="grouping">(</span><span class="string-literal">'CCAT'</span><span class="grouping">)</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rcv1</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">ccat_idx</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
<span class="identifier">y</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>

<span class="comment"># parameters</span>
<span class="identifier">C</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>
<span class="identifier">fit_intercept</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
<span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0e-14</span>

<span class="comment"># max_iter range</span>
<span class="identifier">sgd_iter_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">121</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">newton_iter_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">25</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">lbfgs_iter_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">242</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">liblinear_iter_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">37</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">liblinear_dual_iter_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">85</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">sag_iter_range</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">37</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">clfs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">"LR-liblinear"</span><span class="punctuation">,</span>
     <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
                        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"liblinear"</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span>
                        <span class="identifier">intercept_scaling</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">liblinear_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"LR-liblinear-dual"</span><span class="punctuation">,</span>
     <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">dual</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"liblinear"</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span>
                        <span class="identifier">intercept_scaling</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">liblinear_dual_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"LR-SAG"</span><span class="punctuation">,</span>
     <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
                        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sag"</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">sag_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"LR-newton-cg"</span><span class="punctuation">,</span>
     <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"newton-cg"</span><span class="punctuation">,</span>
                        <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">newton_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"LR-lbfgs"</span><span class="punctuation">,</span>
     <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="identifier">C</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
                        <span class="identifier">solver</span><span class="arithmetic-assignment">=</span><span class="string-literal">"lbfgs"</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">lbfgs_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"SGD"</span><span class="punctuation">,</span>
     <span class="identifier">SGDClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">C</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">penalty</span><span class="arithmetic-assignment">=</span><span class="string-literal">'l2', loss='log'</span><span class="punctuation">,</span>
                   <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">fit_intercept</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="identifier">sgd_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>


<span class="keyword">if</span> <span class="identifier">lightning_clf</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">fit_intercept</span><span class="punctuation">:</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">C</span> <span class="arithmetic-operator">/</span> <span class="identifier">n_samples</span>
    <span class="comment"># compute the same step_size than in LR-sag</span>
    <span class="identifier">max_squared_sum</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_max_squared_sum</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">step_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">get_auto_step_size</span><span class="grouping">(</span><span class="identifier">max_squared_sum</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="string-literal">"log"</span><span class="punctuation">,</span>
                                   <span class="identifier">fit_intercept</span><span class="grouping">)</span>

    <span class="identifier">clfs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="string-literal">"Lightning-SVRG"</span><span class="punctuation">,</span>
         <span class="identifier">lightning_clf</span><span class="punctuation">.</span><span class="identifier">SVRGClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="arithmetic-assignment">=</span><span class="identifier">step_size</span><span class="punctuation">,</span>
                                      <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"log"</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">sag_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clfs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span>
        <span class="grouping">(</span><span class="string-literal">"Lightning-SAG"</span><span class="punctuation">,</span>
         <span class="identifier">lightning_clf</span><span class="punctuation">.</span><span class="identifier">SAGClassifier</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">eta</span><span class="arithmetic-assignment">=</span><span class="identifier">step_size</span><span class="punctuation">,</span>
                                     <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">loss</span><span class="arithmetic-assignment">=</span><span class="string-literal">"log"</span><span class="grouping">)</span><span class="punctuation">,</span>
         <span class="identifier">sag_iter_range</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># We keep only 200 features, to have a dense dataset,</span>
    <span class="comment"># and compare to lightning SAG, which seems incorrect in the sparse case.</span>
    <span class="identifier">X_csc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsc</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">nnz_in_each_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csc</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">X_csc</span><span class="punctuation">.</span><span class="identifier">indptr</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csc</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">nnz_in_each_features</span><span class="grouping">)</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">200</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">"dataset: %.3f MB"</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">nbytes</span> <span class="arithmetic-operator">/</span> <span class="float-literal">1e6</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment"># Split training and testing. Switch train and test subset compared to</span>
<span class="comment"># LYRL2004 split, to have a larger training dataset.</span>
<span class="identifier">n</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">23149</span>
<span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
<span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n</span><span class="grouping">]</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="identifier">n</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">n</span><span class="punctuation">:</span><span class="grouping">]</span>

<span class="identifier">clfs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bench</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span>

<span class="identifier">plot_train_scores</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span>
<span class="identifier">plot_test_scores</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span>
<span class="identifier">plot_train_losses</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span>
<span class="identifier">plot_dloss</span><span class="grouping">(</span><span class="identifier">clfs</span><span class="grouping">)</span>
<span class="identifier">plt</span><span class="punctuation">.</span><span class="identifier">show</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>