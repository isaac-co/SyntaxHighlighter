<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># -*- coding: utf-8 -*-</span>

<span class="comment"># Author: Henry Lin &lt;hlin117@gmail.com&gt;</span>
<span class="comment">#         Tom Dupr√© la Tour</span>

<span class="comment"># License: BSD</span>


<span class="keyword">import</span> <span class="identifier">numbers</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>

<span class="keyword">from</span> <span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">OneHotEncoder</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_array</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span>


<span class="keyword">class</span> <span class="identifier">KBinsDiscretizer</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Bin continuous data into intervals.

    Read more in the :ref:`User Guide &lt;preprocessing_discretization&gt;`.

    .. versionadded:: 0.20

    Parameters
    ----------
    n_bins : int or array-like of shape (n_features,), default=5
        The number of bins to produce. Raises ValueError if ``n_bins &lt; 2``.

    encode : {'onehot', 'onehot-dense', 'ordinal'}, default='onehot'
        Method used to encode the transformed result.

        onehot
            Encode the transformed result with one-hot encoding
            and return a sparse matrix. Ignored features are always
            stacked to the right.
        onehot-dense
            Encode the transformed result with one-hot encoding
            and return a dense array. Ignored features are always
            stacked to the right.
        ordinal
            Return the bin identifier encoded as an integer value.

    strategy : {'uniform', 'quantile', 'kmeans'}, default='quantile'
        Strategy used to define the widths of the bins.

        uniform
            All bins in each feature have identical widths.
        quantile
            All bins in each feature have the same number of points.
        kmeans
            Values in each bin have the same nearest center of a 1D k-means
            cluster.

    dtype : {np.float32, np.float64}, default=None
        The desired data-type for the output. If None, output dtype is
        consistent with input dtype. Only np.float32 and np.float64 are
        supported.

        .. versionadded:: 0.24

    Attributes
    ----------
    n_bins_ : ndarray of shape (n_features,), dtype=np.int_
        Number of bins per feature. Bins whose width are too small
        (i.e., &lt;= 1e-8) are removed with a warning.

    bin_edges_ : ndarray of ndarray of shape (n_features,)
        The edges of each bin. Contain arrays of varying shapes ``(n_bins_, )``
        Ignored features will have empty arrays.

    See Also
    --------
    Binarizer : Class used to bin values as ``0`` or
        ``1`` based on a parameter ``threshold``.

    Notes
    -----
    In bin edges for feature ``i``, the first and last values are used only for
    ``inverse_transform``. During transform, bin edges are extended to::

      np.concatenate([-np.inf, bin_edges_[i][1:-1], np.inf])

    You can combine ``KBinsDiscretizer`` with
    :class:`~sklearn.compose.ColumnTransformer` if you only want to preprocess
    part of the features.

    ``KBinsDiscretizer`` might produce constant features (e.g., when
    ``encode = 'onehot'`` and certain bins do not contain any data).
    These features can be removed with feature selection algorithms
    (e.g., :class:`~sklearn.feature_selection.VarianceThreshold`).

    Examples
    --------
    &gt;&gt;&gt; X = [[-2, 1, -4,   -1],
    ...      [-1, 2, -3, -0.5],
    ...      [ 0, 3, -2,  0.5],
    ...      [ 1, 4, -1,    2]]
    &gt;&gt;&gt; est = KBinsDiscretizer(n_bins=3, encode='ordinal', strategy='uniform')
    &gt;&gt;&gt; est.fit(X)
    KBinsDiscretizer(...)
    &gt;&gt;&gt; Xt = est.transform(X)
    &gt;&gt;&gt; Xt  # doctest: +SKIP
    array([[ 0., 0., 0., 0.],
           [ 1., 1., 1., 0.],
           [ 2., 2., 2., 1.],
           [ 2., 2., 2., 2.]])

    Sometimes it may be useful to convert the data back into the original
    feature space. The ``inverse_transform`` function converts the binned
    data into the original feature space. Each value will be equal to the mean
    of the two bin edges.

    &gt;&gt;&gt; est.bin_edges_[0]
    array([-2., -1.,  0.,  1.])
    &gt;&gt;&gt; est.inverse_transform(Xt)
    array([[-1.5,  1.5, -3.5, -0.5],
           [-0.5,  2.5, -2.5, -0.5],
           [ 0.5,  3.5, -1.5,  0.5],
           [ 0.5,  3.5, -1.5,  1.5]])

    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">encode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'onehot', strategy='quantile'</span><span class="punctuation">,</span>
                 <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span> <span class="arithmetic-assignment">=</span> <span class="identifier">encode</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">strategy</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dtype</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Fit the estimator.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Data to be discretized.

        y : None
            Ignored. This parameter exists only for compatibility with
            :class:`~sklearn.pipeline.Pipeline`.

        Returns
        -------
        self
        """</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'numeric'</span><span class="grouping">)</span>

        <span class="identifier">supported_dtype</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">supported_dtype</span><span class="punctuation">:</span>
            <span class="identifier">output_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dtype</span>
        <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">output_dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">dtype</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="identifier">f</span><span class="string-literal">"Valid options for 'dtype' are "</span>
                <span class="identifier">f</span><span class="string-literal">"{supported_dtype + (None,)}. Got dtype={self.dtype} "</span>
                <span class="identifier">f</span><span class="string-literal">" instead."</span>
            <span class="grouping">)</span>

        <span class="identifier">valid_encode</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'onehot', 'onehot-dense', 'ordinal'</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">valid_encode</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Valid options for 'encode' are {}. "</span>
                             <span class="string-literal">"Got encode={!r} instead."</span>
                             <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">valid_encode</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">valid_strategy</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">'uniform', 'quantile', 'kmeans'</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">valid_strategy</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Valid options for 'strategy' are {}. "</span>
                             <span class="string-literal">"Got strategy={!r} instead."</span>
                             <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">valid_strategy</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_n_bins</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>

        <span class="identifier">bin_edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">object</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">jj</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">column</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span>
            <span class="identifier">col_min</span><span class="punctuation">,</span> <span class="identifier">col_max</span> <span class="arithmetic-assignment">=</span> <span class="identifier">column</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">column</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">col_min</span> <span class="relational-operator">==</span> <span class="identifier">col_max</span><span class="punctuation">:</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">"Feature %d is constant and will be "</span>
                              <span class="string-literal">"replaced with 0."</span> <span class="arithmetic-operator">%</span> <span class="identifier">jj</span><span class="grouping">)</span>
                <span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
                <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="keyword">continue</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span> <span class="relational-operator">==</span> <span class="string-literal">'uniform'</span><span class="punctuation">:</span>
                <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">col_min</span><span class="punctuation">,</span> <span class="identifier">col_max</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>

            <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span> <span class="relational-operator">==</span> <span class="string-literal">'quantile'</span><span class="punctuation">:</span>
                <span class="identifier">quantiles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
                <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">percentile</span><span class="grouping">(</span><span class="identifier">column</span><span class="punctuation">,</span> <span class="identifier">quantiles</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="keyword">elif</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span> <span class="relational-operator">==</span> <span class="string-literal">'kmeans'</span><span class="punctuation">:</span>
                <span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">cluster</span> <span class="keyword">import</span> <span class="identifier">KMeans</span>  <span class="comment"># fixes import loops</span>

                <span class="comment"># Deterministic initialization with uniform spacing</span>
                <span class="identifier">uniform_edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="identifier">col_min</span><span class="punctuation">,</span> <span class="identifier">col_max</span><span class="punctuation">,</span> <span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
                <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">uniform_edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">uniform_edges</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>

                <span class="comment"># 1D k-means procedure</span>
                <span class="identifier">km</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KMeans</span><span class="grouping">(</span><span class="identifier">n_clusters</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">n_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                            <span class="identifier">algorithm</span><span class="arithmetic-assignment">=</span><span class="string-literal">'full'</span><span class="grouping">)</span>
                <span class="identifier">centers</span> <span class="arithmetic-assignment">=</span> <span class="identifier">km</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">column</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">cluster_centers_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
                <span class="comment"># Must sort, centers may be unsorted even with sorted init</span>
                <span class="identifier">centers</span><span class="punctuation">.</span><span class="identifier">sort</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">centers</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">centers</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>
                <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="identifier">col_min</span><span class="punctuation">,</span> <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">col_max</span><span class="grouping">]</span>

            <span class="comment"># Remove bins whose width are too small (i.e., &lt;= 1e-8)</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">strategy</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="string-literal">'quantile', 'kmeans'</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ediff1d</span><span class="grouping">(</span><span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">to_begin</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="float-literal">1e-8</span>
                <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">mask</span><span class="grouping">]</span>
                <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span> <span class="relational-operator">!=</span> <span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">'Bins whose width are too small (i.e., &lt;= '</span>
                                  <span class="string-literal">'1e-8) in feature %d are removed. Consider '</span>
                                  <span class="string-literal">'decreasing the number of bins.'</span> <span class="arithmetic-operator">%</span> <span class="identifier">jj</span><span class="grouping">)</span>
                    <span class="identifier">n_bins</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bin_edges_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_edges</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span>

        <span class="keyword">if</span> <span class="string-literal">'onehot'</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span> <span class="arithmetic-assignment">=</span> <span class="identifier">OneHotEncoder</span><span class="grouping">(</span>
                <span class="identifier">categories</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins_</span><span class="grouping">]</span><span class="punctuation">,</span>
                <span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span> <span class="relational-operator">==</span> <span class="string-literal">'onehot'</span><span class="punctuation">,</span>
                <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">output_dtype</span><span class="grouping">)</span>
            <span class="comment"># Fit the OneHotEncoder with toy datasets</span>
            <span class="comment"># so that it's ready for use after the KBinsDiscretizer is fitted</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins_</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">_validate_n_bins</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Returns n_bins_, the number of bins per feature.
        """</span>
        <span class="identifier">orig_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">orig_bins</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Number</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">orig_bins</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{} received an invalid n_bins type. "</span>
                                 <span class="string-literal">"Received {}, expected int."</span>
                                 <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">KBinsDiscretizer</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span>
                                         <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">orig_bins</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">orig_bins</span> <span class="relational-operator">&lt;</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{} received an invalid number "</span>
                                 <span class="string-literal">"of bins. Received {}, expected at least 2."</span>
                                 <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">KBinsDiscretizer</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">orig_bins</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">orig_bins</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>

        <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">orig_bins</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                             <span class="identifier">ensure_2d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">n_bins</span><span class="punctuation">.</span><span class="identifier">ndim</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span> <span class="logical-operator">or</span> <span class="identifier">n_bins</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">n_features</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"n_bins must be a scalar or array "</span>
                             <span class="string-literal">"of shape (n_features,)."</span><span class="grouping">)</span>

        <span class="identifier">bad_nbins_value</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">n_bins</span> <span class="relational-operator">&lt;</span> <span class="int-literal">2</span><span class="grouping">)</span> <span class="bitwise-operator">|</span> <span class="grouping">(</span><span class="identifier">n_bins</span> <span class="relational-operator">!=</span> <span class="identifier">orig_bins</span><span class="grouping">)</span>

        <span class="identifier">violating_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">bad_nbins_value</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">violating_indices</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">", "</span><span class="punctuation">.</span><span class="identifier">join</span><span class="grouping">(</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">violating_indices</span><span class="grouping">)</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"{} received an invalid number "</span>
                             <span class="string-literal">"of bins at indices {}. Number of bins "</span>
                             <span class="string-literal">"must be at least 2, and must be an int."</span>
                             <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">KBinsDiscretizer</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">n_bins</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Discretize the data.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Data to be discretized.

        Returns
        -------
        Xt : {ndarray, sparse matrix}, dtype={np.float32, np.float64}
            Data in the binned space. Will be a sparse matrix if
            `self.encode='onehot'` and ndarray otherwise.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="comment"># check input and attribute dtypes</span>
        <span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dtype</span>
        <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="identifier">bin_edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bin_edges_</span>
        <span class="keyword">for</span> <span class="identifier">jj</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># Values which are close to a bin edge are susceptible to numeric</span>
            <span class="comment"># instability. Add eps to X so these values are binned correctly</span>
            <span class="comment"># with respect to their decimal truncation. See documentation of</span>
            <span class="comment"># numpy.isclose for an explanation of ``rtol`` and ``atol``.</span>
            <span class="identifier">rtol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="identifier">e</span><span class="arithmetic-operator">-</span><span class="int-literal">5</span>
            <span class="identifier">atol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="identifier">e</span><span class="arithmetic-operator">-</span><span class="int-literal">8</span>
            <span class="identifier">eps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">atol</span> <span class="arithmetic-operator">+</span> <span class="identifier">rtol</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">Xt</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">digitize</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">eps</span><span class="punctuation">,</span> <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins_</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">out</span><span class="arithmetic-assignment">=</span><span class="identifier">Xt</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span> <span class="relational-operator">==</span> <span class="string-literal">'ordinal'</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">Xt</span>

        <span class="identifier">dtype_init</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="keyword">if</span> <span class="string-literal">'onehot'</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span><span class="punctuation">:</span>
            <span class="identifier">dtype_init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span><span class="punctuation">.</span><span class="identifier">dtype</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xt</span><span class="punctuation">.</span><span class="identifier">dtype</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="identifier">Xt_enc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>
        <span class="keyword">finally</span><span class="punctuation">:</span>
            <span class="comment"># revert the initial dtype to avoid modifying self.</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dtype_init</span>
        <span class="keyword">return</span> <span class="identifier">Xt_enc</span>

    <span class="keyword">def</span> <span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">Xt</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        Transform discretized data back to original feature space.

        Note that this function does not regenerate the original data
        due to discretization rounding.

        Parameters
        ----------
        Xt : array-like of shape (n_samples, n_features)
            Transformed data in the binned space.

        Returns
        -------
        Xinv : ndarray, dtype={np.float32, np.float64}
            Data in the original feature space.
        """</span>
        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="string-literal">'onehot'</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">encode</span><span class="punctuation">:</span>
            <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_encoder</span><span class="punctuation">.</span><span class="identifier">inverse_transform</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>

        <span class="identifier">Xinv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_bins_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">Xinv</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">n_features</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">"Incorrect number of features. Expecting {}, "</span>
                             <span class="string-literal">"received {}."</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">Xinv</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">jj</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">bin_edges</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">bin_edges_</span><span class="grouping">[</span><span class="identifier">jj</span><span class="grouping">]</span>
            <span class="identifier">bin_centers</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">bin_edges</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">bin_edges</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>
            <span class="identifier">Xinv</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bin_centers</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int_</span><span class="grouping">(</span><span class="identifier">Xinv</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">jj</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="keyword">return</span> <span class="identifier">Xinv</span>

    </pre>
  </body>
</html>