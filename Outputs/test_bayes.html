<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Author: Alexandre Gramfort &lt;alexandre.gramfort@inria.fr&gt;</span>
<span class="comment">#         Fabian Pedregosa &lt;fabian.pedregosa@inria.fr&gt;</span>
<span class="comment">#</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">math</span> <span class="keyword">import</span> <span class="identifier">log</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">linalg</span> <span class="keyword">import</span> <span class="identifier">pinvh</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>


<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">BayesianRidge</span><span class="punctuation">,</span> <span class="identifier">ARDRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">Ridge</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">datasets</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">fast_logdet</span>

<span class="identifier">diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_n_iter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check value of n_iter."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"n_iter should be greater than or equal to 1."</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_ridge_scores</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check scores attribute shape"""</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_ridge_score_values</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check value of score on toy example.

    Compute log marginal likelihood with equation (36) in Sparse Bayesian
    Learning and the Relevance Vector Machine (Tipping, 2001):

    - 0.5 * (log |Id/alpha + X.X^T/lambda| +
             y^T.(Id/alpha + X.X^T/lambda).y + n * log(2 * pi))
    + lambda_1 * log(lambda) - lambda_2 * lambda
    + alpha_1 * log(alpha) - alpha_2 * alpha

    and check equality with the score computed during training.
    """</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="comment"># check with initial values of alpha and lambda (see code for the values)</span>
    <span class="identifier">eps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span>
    <span class="identifier">alpha_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">eps</span><span class="grouping">)</span>
    <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span>

    <span class="comment"># value of the parameters of the Gamma hyperpriors</span>
    <span class="identifier">alpha_1</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>
    <span class="identifier">alpha_2</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>
    <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">1</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>
    <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">2</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.1</span>

    <span class="comment"># compute score using formula of docstring</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">log</span><span class="grouping">(</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">alpha_1</span> <span class="arithmetic-operator">*</span> <span class="identifier">log</span><span class="grouping">(</span><span class="identifier">alpha_</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">alpha_2</span> <span class="arithmetic-operator">*</span> <span class="identifier">alpha_</span>
    <span class="identifier">M</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="identifier">alpha_</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>
    <span class="identifier">M_inv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pinvh</span><span class="grouping">(</span><span class="identifier">M</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">+=</span> <span class="arithmetic-operator">-</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">fast_logdet</span><span class="grouping">(</span><span class="identifier">M</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">M_inv</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                      <span class="identifier">n_samples</span> <span class="arithmetic-operator">*</span> <span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># compute score with BayesianRidge</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">alpha_1</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha_1</span><span class="punctuation">,</span> <span class="identifier">alpha_2</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha_2</span><span class="punctuation">,</span>
                        <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">1</span><span class="arithmetic-assignment">=</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">2</span><span class="arithmetic-assignment">=</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="int-literal">2</span><span class="punctuation">,</span>
                        <span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">scores_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">9</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_ridge_parameter</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test correctness of lambda_ and alpha_ parameters (GitHub issue #8224)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># A Ridge regression model using an alpha value equal to the ratio of</span>
    <span class="comment"># lambda_ and alpha_ from the Bayesian Ridge model must be identical</span>
    <span class="identifier">br_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">rr_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">br_model</span><span class="punctuation">.</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span> <span class="arithmetic-operator">/</span> <span class="identifier">br_model</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rr_model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">br_model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rr_model</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">br_model</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_sample_weights</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test correctness of the sample_weights method</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># A Ridge regression model using an alpha value equal to the ratio of</span>
    <span class="comment"># lambda_ and alpha_ from the Bayesian Ridge model must be identical</span>
    <span class="identifier">br_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">w</span><span class="grouping">)</span>
    <span class="identifier">rr_model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Ridge</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">br_model</span><span class="punctuation">.</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span> <span class="arithmetic-operator">/</span> <span class="identifier">br_model</span><span class="punctuation">.</span><span class="identifier">alpha_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">w</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rr_model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="punctuation">,</span> <span class="identifier">br_model</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">rr_model</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="punctuation">,</span> <span class="identifier">br_model</span><span class="punctuation">.</span><span class="identifier">intercept_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_toy_bayesian_ridge_object</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test BayesianRidge on toy</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="comment"># Check that the model could approximately learn the identity function</span>
    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_bayesian_initial_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test BayesianRidge with initial values (alpha_init, lambda_init)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vander</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>    <span class="comment"># y = (x^3 - 6x^2 + 8x) / 3</span>

    <span class="comment"># In this case, starting from the default initial values will increase</span>
    <span class="comment"># the bias of the fitted curve. So, lambda_init should be small.</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="identifier">alpha_init</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="invalid">l</span><span class="invalid">a</span><span class="invalid">m</span><span class="invalid">b</span><span class="invalid">d</span><span class="invalid">a</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">i</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>
    <span class="comment"># Check the R2 score nearly equals to one.</span>
    <span class="identifier">r2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">r2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_prediction_bayesian_ridge_ard_with_constant_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test BayesianRidge and ARDRegression predictions for edge case of</span>
    <span class="comment"># constant target vectors</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">constant_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">constant_value</span><span class="punctuation">,</span>
                <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">constant_value</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">expected</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">constant_value</span><span class="punctuation">,</span>
                       <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">constant_value</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">clf</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">expected</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_std_bayesian_ridge_ard_with_constant_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test BayesianRidge and ARDRegression standard dev. for edge case of</span>
    <span class="comment"># constant target vector</span>
    <span class="comment"># The standard dev. should be relatively small (&lt; 0.01 is tested here)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">constant_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">random_sample</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">constant_value</span><span class="punctuation">,</span>
                <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">constant_value</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dtype</span><span class="grouping">)</span>
    <span class="identifier">expected_upper_boundary</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.01</span>

    <span class="keyword">for</span> <span class="identifier">clf</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">y_std</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">y_std</span><span class="punctuation">,</span> <span class="identifier">expected_upper_boundary</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_update_of_sigma_in_ard</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checks that `sigma_` is updated correctly after the last iteration</span>
    <span class="comment"># of the ARDRegression algorithm. See issue #10128.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="identifier">n_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="comment"># With the inputs above, ARDRegression prunes both of the two coefficients</span>
    <span class="comment"># in the first iteration. Hence, the expected shape of `sigma_` is (0, 0).</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">sigma_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="comment"># Ensure that no error is thrown at prediction stage</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_toy_ard_object</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test BayesianRegression ARD classifier</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="identifier">compute_score</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>

    <span class="comment"># Check that the model could approximately learn the identity function</span>
    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'n_samples, n_features'</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ard_accuracy_on_easy_problem</span><span class="grouping">(</span><span class="identifier">seed</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that ARD converges with reasonable accuracy on an easy problem</span>
    <span class="comment"># (Github issue #14055)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">250</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>

    <span class="identifier">regressor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">abs_coef_error</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">regressor</span><span class="punctuation">.</span><span class="identifier">coef_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">abs_coef_error</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1e-10</span>


<span class="keyword">def</span> <span class="identifier">test_return_std</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test return_std option for both Bayesian regressors</span>
    <span class="keyword">def</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">w</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">b</span>

    <span class="keyword">def</span> <span class="identifier">f_noise</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">noise_mult</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">noise_mult</span>

    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_train</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">50</span>
    <span class="identifier">n_test</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>

    <span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">b</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">random</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">random</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">decimal</span><span class="punctuation">,</span> <span class="identifier">noise_mult</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">f_noise</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">noise_mult</span><span class="grouping">)</span>

        <span class="identifier">m1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BayesianRidge</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">m1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">y_mean1</span><span class="punctuation">,</span> <span class="identifier">y_std1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_std1</span><span class="punctuation">,</span> <span class="identifier">noise_mult</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="identifier">decimal</span><span class="grouping">)</span>

        <span class="identifier">m2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">m2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">y_mean2</span><span class="punctuation">,</span> <span class="identifier">y_std2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">m2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_std2</span><span class="punctuation">,</span> <span class="identifier">noise_mult</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="identifier">decimal</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'seed'</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_update_sigma</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure the two update_sigma() helpers are equivalent. The woodbury</span>
    <span class="comment"># formula is used when n_samples &lt; n_features, and the other one is used</span>
    <span class="comment"># otherwise.</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span>

    <span class="comment"># set n_samples == n_features to avoid instability issues when inverting</span>
    <span class="comment"># the matrices. Using the woodbury formula would be unstable when</span>
    <span class="comment"># n_samples &gt; n_features</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">lmbda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">keep_lambda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="bool-literal">True</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">n_features</span><span class="grouping">)</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">sigma</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">_update_sigma</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">lmbda</span><span class="punctuation">,</span> <span class="identifier">keep_lambda</span><span class="grouping">)</span>
    <span class="identifier">sigma_woodbury</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">_update_sigma_woodbury</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">lmbda</span><span class="punctuation">,</span> <span class="identifier">keep_lambda</span><span class="grouping">)</span>

    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">sigma</span><span class="punctuation">,</span> <span class="identifier">sigma_woodbury</span><span class="grouping">)</span>


<span class="comment"># FIXME: 'normalize' to be removed in 1.2 in LinearRegression</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span><span class="string-literal">"ignore:'normalize' was deprecated"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_ard_regression_predict_normalize_true</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that we can predict with `normalize=True` and `return_std=True`.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/issues/18605
    """</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ARDRegression</span><span class="grouping">(</span><span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    </pre>
  </body>
</html>