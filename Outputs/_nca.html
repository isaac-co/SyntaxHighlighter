<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># coding: utf-8</span>
<span class="comment">"""
Neighborhood Component Analysis
"""</span>

<span class="comment"># Authors: William de Vazelhes &lt;wdevazelhes@gmail.com&gt;</span>
<span class="comment">#          John Chiotellis &lt;ioannis.chiotellis@in.tum.de&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">from</span> <span class="identifier">__future__</span> <span class="keyword">import</span> <span class="identifier">print_function</span>

<span class="keyword">from</span> <span class="identifier">warnings</span> <span class="keyword">import</span> <span class="identifier">warn</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">time</span>
<span class="keyword">import</span> <span class="identifier">numbers</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">optimize</span> <span class="keyword">import</span> <span class="identifier">minimize</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">extmath</span> <span class="keyword">import</span> <span class="identifier">softmax</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">pairwise_distances</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">BaseEstimator</span><span class="punctuation">,</span> <span class="identifier">TransformerMixin</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">LabelEncoder</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">decomposition</span> <span class="keyword">import</span> <span class="identifier">PCA</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">multiclass</span> <span class="keyword">import</span> <span class="identifier">check_classification_targets</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">random</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_is_fitted</span><span class="punctuation">,</span> <span class="identifier">check_array</span><span class="punctuation">,</span> <span class="identifier">check_scalar</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>


<span class="keyword">class</span> <span class="identifier">NeighborhoodComponentsAnalysis</span><span class="grouping">(</span><span class="identifier">TransformerMixin</span><span class="punctuation">,</span> <span class="identifier">BaseEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Neighborhood Components Analysis

    Neighborhood Component Analysis (NCA) is a machine learning algorithm for
    metric learning. It learns a linear transformation in a supervised fashion
    to improve the classification accuracy of a stochastic nearest neighbors
    rule in the transformed space.

    Read more in the :ref:`User Guide &lt;nca&gt;`.

    Parameters
    ----------
    n_components : int, default=None
        Preferred dimensionality of the projected space.
        If None it will be set to ``n_features``.

    init : {'auto', 'pca', 'lda', 'identity', 'random'} or ndarray of shape \
            (n_features_a, n_features_b), default='auto'
        Initialization of the linear transformation. Possible options are
        'auto', 'pca', 'lda', 'identity', 'random', and a numpy array of shape
        (n_features_a, n_features_b).

        'auto'
            Depending on ``n_components``, the most reasonable initialization
            will be chosen. If ``n_components &lt;= n_classes`` we use 'lda', as
            it uses labels information. If not, but
            ``n_components &lt; min(n_features, n_samples)``, we use 'pca', as
            it projects data in meaningful directions (those of higher
            variance). Otherwise, we just use 'identity'.

        'pca'
            ``n_components`` principal components of the inputs passed
            to :meth:`fit` will be used to initialize the transformation.
            (See :class:`~sklearn.decomposition.PCA`)

        'lda'
            ``min(n_components, n_classes)`` most discriminative
            components of the inputs passed to :meth:`fit` will be used to
            initialize the transformation. (If ``n_components &gt; n_classes``,
            the rest of the components will be zero.) (See
            :class:`~sklearn.discriminant_analysis.LinearDiscriminantAnalysis`)

        'identity'
            If ``n_components`` is strictly smaller than the
            dimensionality of the inputs passed to :meth:`fit`, the identity
            matrix will be truncated to the first ``n_components`` rows.

        'random'
            The initial transformation will be a random array of shape
            `(n_components, n_features)`. Each value is sampled from the
            standard normal distribution.

        numpy array
            n_features_b must match the dimensionality of the inputs passed to
            :meth:`fit` and n_features_a must be less than or equal to that.
            If ``n_components`` is not None, n_features_a must match it.

    warm_start : bool, default=False
        If True and :meth:`fit` has been called before, the solution of the
        previous call to :meth:`fit` is used as the initial linear
        transformation (``n_components`` and ``init`` will be ignored).

    max_iter : int, default=50
        Maximum number of iterations in the optimization.

    tol : float, default=1e-5
        Convergence tolerance for the optimization.

    callback : callable, default=None
        If not None, this function is called after every iteration of the
        optimizer, taking as arguments the current solution (flattened
        transformation matrix) and the number of iterations. This might be
        useful in case one wants to examine or store the transformation
        found after each iteration.

    verbose : int, default=0
        If 0, no progress messages will be printed.
        If 1, progress messages will be printed to stdout.
        If &gt; 1, progress messages will be printed and the ``disp``
        parameter of :func:`scipy.optimize.minimize` will be set to
        ``verbose - 2``.

    random_state : int or numpy.RandomState, default=None
        A pseudo random number generator object or a seed for it if int. If
        ``init='random'``, ``random_state`` is used to initialize the random
        transformation. If ``init='pca'``, ``random_state`` is passed as an
        argument to PCA when initializing the transformation. Pass an int
        for reproducible results across multiple function calls.
        See :term: `Glossary &lt;random_state&gt;`.

    Attributes
    ----------
    components_ : ndarray of shape (n_components, n_features)
        The linear transformation learned during fitting.

    n_iter_ : int
        Counts the number of iterations performed by the optimizer.

    random_state_ : numpy.RandomState
        Pseudo random number generator object used during initialization.

    Examples
    --------
    &gt;&gt;&gt; from sklearn.neighbors import NeighborhoodComponentsAnalysis
    &gt;&gt;&gt; from sklearn.neighbors import KNeighborsClassifier
    &gt;&gt;&gt; from sklearn.datasets import load_iris
    &gt;&gt;&gt; from sklearn.model_selection import train_test_split
    &gt;&gt;&gt; X, y = load_iris(return_X_y=True)
    &gt;&gt;&gt; X_train, X_test, y_train, y_test = train_test_split(X, y,
    ... stratify=y, test_size=0.7, random_state=42)
    &gt;&gt;&gt; nca = NeighborhoodComponentsAnalysis(random_state=42)
    &gt;&gt;&gt; nca.fit(X_train, y_train)
    NeighborhoodComponentsAnalysis(...)
    &gt;&gt;&gt; knn = KNeighborsClassifier(n_neighbors=3)
    &gt;&gt;&gt; knn.fit(X_train, y_train)
    KNeighborsClassifier(...)
    &gt;&gt;&gt; print(knn.score(X_test, y_test))
    0.933333...
    &gt;&gt;&gt; knn.fit(nca.transform(X_train), y_train)
    KNeighborsClassifier(...)
    &gt;&gt;&gt; print(knn.score(nca.transform(X_test), y_test))
    0.961904...

    References
    ----------
    .. [1] J. Goldberger, G. Hinton, S. Roweis, R. Salakhutdinov.
           "Neighbourhood Components Analysis". Advances in Neural Information
           Processing Systems. 17, 513-520, 2005.
           http://www.cs.nyu.edu/~roweis/papers/ncanips.pdf

    .. [2] Wikipedia entry on Neighborhood Components Analysis
           https://en.wikipedia.org/wiki/Neighbourhood_components_analysis

    """</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="arithmetic-assignment">=</span><span class="string-literal">'auto'</span><span class="punctuation">,</span> <span class="identifier">warm_start</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                 <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="identifier">callback</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_components</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">init</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">warm_start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">warm_start</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">callback</span> <span class="arithmetic-assignment">=</span> <span class="identifier">callback</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">verbose</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fit the model according to the given training data.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            The training samples.

        y : array-like of shape (n_samples,)
            The corresponding training labels.

        Returns
        -------
        self : object
            returns a trained NeighborhoodComponentsAnalysis model.
        """</span>

        <span class="comment"># Verify inputs X and y and NCA parameters, and transform a copy if</span>
        <span class="comment"># needed</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_params</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># Initialize the random generator</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state</span><span class="grouping">)</span>

        <span class="comment"># Measure the total training time</span>
        <span class="identifier">t_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="comment"># Compute a mask that stays fixed during optimization:</span>
        <span class="identifier">same_class_mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="comment"># (n_samples, n_samples)</span>

        <span class="comment"># Initialize the transformation</span>
        <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_initialize</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="grouping">)</span>

        <span class="comment"># Create a dictionary of parameters to be passed to the optimizer</span>
        <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span> <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span> <span class="keyword">else</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span>
        <span class="identifier">optimizer_params</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'method': 'L-BFGS-B'</span><span class="punctuation">,</span>
                            <span class="string-literal">'fun'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_grad_lbfgs</span><span class="punctuation">,</span>
                            <span class="string-literal">'args'</span><span class="punctuation">:</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">same_class_mask</span><span class="punctuation">,</span> <span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="string-literal">'jac'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="punctuation">,</span>
                            <span class="string-literal">'x0'</span><span class="punctuation">:</span> <span class="identifier">transformation</span><span class="punctuation">,</span>
                            <span class="string-literal">'tol'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
                            <span class="string-literal">'options'</span><span class="punctuation">:</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">maxiter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">disp</span><span class="arithmetic-assignment">=</span><span class="identifier">disp</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="string-literal">'callback'</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_callback</span>
                            <span class="grouping">}</span>

        <span class="comment"># Call the optimizer</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
        <span class="identifier">opt_result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">minimize</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">optimizer_params</span><span class="grouping">)</span>

        <span class="comment"># Reshape the solution found by the optimizer</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">opt_result</span><span class="punctuation">.</span><span class="identifier">x</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Stop timer</span>
        <span class="identifier">t_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t_train</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
            <span class="identifier">cls_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>

            <span class="comment"># Warn the user if the algorithm did not converge</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">opt_result</span><span class="punctuation">.</span><span class="identifier">success</span><span class="punctuation">:</span>
                <span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">'[{}] NCA did not converge: {}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                    <span class="identifier">cls_name</span><span class="punctuation">,</span> <span class="identifier">opt_result</span><span class="punctuation">.</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">,</span>
                     <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>

            <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[{}] Training took {:8.2f}s.'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">cls_name</span><span class="punctuation">,</span> <span class="identifier">t_train</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="keyword">def</span> <span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Applies the learned transformation to the given data.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Data samples.

        Returns
        -------
        X_embedded: ndarray of shape (n_samples, n_components)
            The data samples transformed.

        Raises
        ------
        NotFittedError
            If :meth:`fit` has not been called before.
        """</span>

        <span class="identifier">check_is_fitted</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">reset</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_validate_params</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Validate parameters as soon as :meth:`fit` is called.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            The training samples.

        y : array-like of shape (n_samples,)
            The corresponding training labels.

        Returns
        -------
        X : ndarray of shape (n_samples, n_features)
            The validated training samples.

        y : ndarray of shape (n_samples,)
            The validated training labels, encoded to be integers in
            the range(0, n_classes).

        init : str or ndarray of shape (n_features_a, n_features_b)
            The validated initialization of the linear transformation.

        Raises
        -------
        TypeError
            If a parameter is not an instance of the desired type.

        ValueError
            If a parameter's value violates its legal value range or if the
            combination of two or more given parameters is incompatible.
        """</span>

        <span class="comment"># Validate the inputs X and y, and converts y to numerical classes.</span>
        <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">ensure_min_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">check_classification_targets</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LabelEncoder</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># Check the preferred dimensionality of the projected space</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">check_scalar</span><span class="grouping">(</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="string-literal">'n_components'</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="punctuation">,</span> <span class="identifier">min_val</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">&gt;</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'The preferred dimensionality of the '</span>
                                 <span class="string-literal">'projected space `n_components` ({}) cannot '</span>
                                 <span class="string-literal">'be greater than the given data '</span>
                                 <span class="string-literal">'dimensionality ({})!'</span>
                                 <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># If warm_start is enabled, check that the inputs are consistent</span>
        <span class="identifier">check_scalar</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">warm_start</span><span class="punctuation">,</span> <span class="string-literal">'warm_start'</span><span class="punctuation">,</span> <span class="identifier">bool</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">warm_start</span> <span class="logical-operator">and</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'components_'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'The new inputs dimensionality ({}) does not '</span>
                                 <span class="string-literal">'match the input dimensionality of the '</span>
                                 <span class="string-literal">'previously learned transformation ({}).'</span>
                                 <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
                                         <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">check_scalar</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="string-literal">'max_iter'</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="punctuation">,</span> <span class="identifier">min_val</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">check_scalar</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="string-literal">'tol'</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Real</span><span class="punctuation">,</span> <span class="identifier">min_val</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span>
        <span class="identifier">check_scalar</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="string-literal">'verbose'</span><span class="punctuation">,</span> <span class="identifier">numbers</span><span class="punctuation">.</span><span class="identifier">Integral</span><span class="punctuation">,</span> <span class="identifier">min_val</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">callback</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">callable</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">callback</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'`callback` is not callable.'</span><span class="grouping">)</span>

        <span class="comment"># Check how the linear transformation should be initialized</span>
        <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">init</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_array</span><span class="grouping">(</span><span class="identifier">init</span><span class="grouping">)</span>

            <span class="comment"># Assert that init.shape[1] = X.shape[1]</span>
            <span class="keyword">if</span> <span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                    <span class="string-literal">'The input dimensionality ({}) of the given '</span>
                    <span class="string-literal">'linear transformation `init` must match the '</span>
                    <span class="string-literal">'dimensionality of the given inputs `X` ({}).'</span>
                    <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># Assert that init.shape[0] &lt;= init.shape[1]</span>
            <span class="keyword">if</span> <span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                    <span class="string-literal">'The output dimensionality ({}) of the given '</span>
                    <span class="string-literal">'linear transformation `init` cannot be '</span>
                    <span class="string-literal">'greater than its input dimensionality ({}).'</span>
                    <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="comment"># Assert that self.n_components = init.shape[0]</span>
                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="relational-operator">!=</span> <span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">:</span>
                    <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'The preferred dimensionality of the '</span>
                                     <span class="string-literal">'projected space `n_components` ({}) does'</span>
                                     <span class="string-literal">' not match the output dimensionality of '</span>
                                     <span class="string-literal">'the given linear transformation '</span>
                                     <span class="string-literal">'`init` ({})!'</span>
                                     <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                             <span class="identifier">init</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">init</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'auto', 'pca', 'lda', 'identity', 'random'</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="keyword">pass</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span>
                <span class="string-literal">"`init` must be 'auto', 'pca', 'lda', 'identity', 'random' "</span>
                <span class="string-literal">"or a numpy array of shape (n_components, n_features)."</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init</span>

    <span class="keyword">def</span> <span class="identifier">_initialize</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">init</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Initialize the transformation.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            The training samples.

        y : array-like of shape (n_samples,)
            The training labels.

        init : str or ndarray of shape (n_features_a, n_features_b)
            The validated initialization of the linear transformation.

        Returns
        -------
        transformation : ndarray of shape (n_components, n_features)
            The initialized linear transformation.

        """</span>

        <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">init</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">warm_start</span> <span class="logical-operator">and</span> <span class="identifier">hasattr</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="string-literal">'components_'</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">components_</span>
        <span class="keyword">elif</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">init</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">pass</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span>
            <span class="identifier">n_components</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_components</span> <span class="logical-operator">or</span> <span class="identifier">n_features</span>
            <span class="keyword">if</span> <span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'auto'</span><span class="punctuation">:</span>
                <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">unique</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">n_components</span> <span class="relational-operator">&lt;=</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_classes</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'lda'</span>
                <span class="keyword">elif</span> <span class="identifier">n_components</span> <span class="relational-operator">&lt;</span> <span class="identifier">min</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'pca'</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">init</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'identity'</span>
            <span class="keyword">if</span> <span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'identity'</span><span class="punctuation">:</span>
                <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'random'</span><span class="punctuation">:</span>
                <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state_</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                                                          <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="keyword">elif</span> <span class="identifier">init</span> <span class="relational-operator">in</span> <span class="grouping">{</span><span class="string-literal">'pca', 'lda'</span><span class="grouping">}</span><span class="punctuation">:</span>
                <span class="identifier">init_time</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'pca'</span><span class="punctuation">:</span>
                    <span class="identifier">pca</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PCA</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="punctuation">,</span>
                              <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">random_state_</span><span class="grouping">)</span>
                    <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Finding principal components... ', end=''</span><span class="grouping">)</span>
                        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">flush</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
                    <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pca</span><span class="punctuation">.</span><span class="identifier">components_</span>
                <span class="keyword">elif</span> <span class="identifier">init</span> <span class="relational-operator">==</span> <span class="string-literal">'lda'</span><span class="punctuation">:</span>
                    <span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">discriminant_analysis</span> <span class="keyword">import</span> <span class="grouping">(</span>
                        <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">)</span>
                    <span class="identifier">lda</span> <span class="arithmetic-assignment">=</span> <span class="identifier">LinearDiscriminantAnalysis</span><span class="grouping">(</span><span class="identifier">n_components</span><span class="arithmetic-assignment">=</span><span class="identifier">n_components</span><span class="grouping">)</span>
                    <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                        <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'Finding most discriminative components... '</span><span class="punctuation">,</span>
                              <span class="identifier">end</span><span class="arithmetic-assignment">=</span><span class="string-literal">''</span><span class="grouping">)</span>
                        <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">flush</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
                    <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lda</span><span class="punctuation">.</span><span class="identifier">scalings_</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_components</span><span class="grouping">]</span>
                <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                    <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'done in {:5.2f}s'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">init_time</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">transformation</span>

    <span class="keyword">def</span> <span class="identifier">_callback</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">transformation</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Called after each iteration of the optimizer.

        Parameters
        ----------
        transformation : ndarray of shape (n_components * n_features,)
            The solution computed by the optimizer in this iteration.
        """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">callback</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">callback</span><span class="grouping">(</span><span class="identifier">transformation</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span><span class="grouping">)</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>

    <span class="keyword">def</span> <span class="identifier">_loss_grad_lbfgs</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">transformation</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">same_class_mask</span><span class="punctuation">,</span> <span class="identifier">sign</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute the loss and the loss gradient w.r.t. ``transformation``.

        Parameters
        ----------
        transformation : ndarray of shape (n_components * n_features,)
            The raveled linear transformation on which to compute loss and
            evaluate gradient.

        X : ndarray of shape (n_samples, n_features)
            The training samples.

        same_class_mask : ndarray of shape (n_samples, n_samples)
            A mask where ``mask[i, j] == 1`` if ``X[i]`` and ``X[j]`` belong
            to the same class, and ``0`` otherwise.

        Returns
        -------
        loss : float
            The loss computed for the given transformation.

        gradient : ndarray of shape (n_components * n_features,)
            The new (flattened) gradient of the loss.
        """</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
                <span class="identifier">header_fields</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'Iteration', 'Objective Value', 'Time(s)'</span><span class="grouping">]</span>
                <span class="identifier">header_fmt</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'{:&gt;10} {:&gt;20} {:&gt;10}'</span>
                <span class="identifier">header</span> <span class="arithmetic-assignment">=</span> <span class="identifier">header_fmt</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">header_fields</span><span class="grouping">)</span>
                <span class="identifier">cls_name</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[{}]'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">cls_name</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[{}] {}\n[{}] {}'</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">cls_name</span><span class="punctuation">,</span> <span class="identifier">header</span><span class="punctuation">,</span>
                                                <span class="identifier">cls_name</span><span class="punctuation">,</span> <span class="string-literal">'-'</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">header</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">t_funcall</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">transformation</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformation</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">X_embedded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">transformation</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>  <span class="comment"># (n_samples, n_components)</span>

        <span class="comment"># Compute softmax distances</span>
        <span class="identifier">p_ij</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_distances</span><span class="grouping">(</span><span class="identifier">X_embedded</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fill_diagonal</span><span class="grouping">(</span><span class="identifier">p_ij</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="grouping">)</span>
        <span class="identifier">p_ij</span> <span class="arithmetic-assignment">=</span> <span class="identifier">softmax</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">p_ij</span><span class="grouping">)</span>  <span class="comment"># (n_samples, n_samples)</span>

        <span class="comment"># Compute loss</span>
        <span class="identifier">masked_p_ij</span> <span class="arithmetic-assignment">=</span> <span class="identifier">p_ij</span> <span class="arithmetic-operator">*</span> <span class="identifier">same_class_mask</span>
        <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">masked_p_ij</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>  <span class="comment"># (n_samples, 1)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">p</span><span class="grouping">)</span>

        <span class="comment"># Compute gradient of loss w.r.t. `transform`</span>
        <span class="identifier">weighted_p_ij</span> <span class="arithmetic-assignment">=</span> <span class="identifier">masked_p_ij</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_ij</span> <span class="arithmetic-operator">*</span> <span class="identifier">p</span>
        <span class="identifier">weighted_p_ij_sym</span> <span class="arithmetic-assignment">=</span> <span class="identifier">weighted_p_ij</span> <span class="arithmetic-operator">+</span> <span class="identifier">weighted_p_ij</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fill_diagonal</span><span class="grouping">(</span><span class="identifier">weighted_p_ij_sym</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">weighted_p_ij</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">gradient</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">X_embedded</span><span class="punctuation">.</span><span class="identifier">T</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">weighted_p_ij_sym</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="comment"># time complexity of the gradient: O(n_components x n_samples x (</span>
        <span class="comment"># n_samples + n_features))</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">:</span>
            <span class="identifier">t_funcall</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t_funcall</span>
            <span class="identifier">values_fmt</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'[{}] {:&gt;10} {:&gt;20.6e} {:&gt;10.2f}'</span>
            <span class="identifier">print</span><span class="grouping">(</span><span class="identifier">values_fmt</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span><span class="punctuation">,</span>
                                    <span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">t_funcall</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stdout</span><span class="punctuation">.</span><span class="identifier">flush</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">sign</span> <span class="arithmetic-operator">*</span> <span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">sign</span> <span class="arithmetic-operator">*</span> <span class="identifier">gradient</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_more_tags</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="grouping">{</span><span class="string-literal">'requires_y'</span><span class="punctuation">:</span> <span class="bool-literal">True</span><span class="grouping">}</span>

    </pre>
  </body>
</html>