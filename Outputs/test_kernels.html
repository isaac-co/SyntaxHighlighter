<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""Testing for kernels for Gaussian processes."""</span>

<span class="comment"># Author: Jan Hendrik Metzen &lt;jhm@informatik.uni-bremen.de&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">inspect</span> <span class="keyword">import</span> <span class="identifier">signature</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span><span class="punctuation">.</span><span class="identifier">kernels</span> <span class="keyword">import</span> <span class="identifier">_approx_fprime</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span><span class="punctuation">.</span><span class="identifier">pairwise</span> <span class="invalid">\</span>
    <span class="keyword">import</span> <span class="identifier">PAIRWISE_KERNEL_FUNCTIONS</span><span class="punctuation">,</span> <span class="identifier">euclidean_distances</span><span class="punctuation">,</span> <span class="identifier">pairwise_kernels</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">gaussian_process</span><span class="punctuation">.</span><span class="identifier">kernels</span> <span class="invalid">\</span>
    <span class="keyword">import</span> <span class="grouping">(</span><span class="identifier">RBF</span><span class="punctuation">,</span> <span class="identifier">Matern</span><span class="punctuation">,</span> <span class="identifier">RationalQuadratic</span><span class="punctuation">,</span> <span class="identifier">ExpSineSquared</span><span class="punctuation">,</span> <span class="identifier">DotProduct</span><span class="punctuation">,</span>
            <span class="identifier">ConstantKernel</span><span class="punctuation">,</span> <span class="identifier">WhiteKernel</span><span class="punctuation">,</span> <span class="identifier">PairwiseKernel</span><span class="punctuation">,</span> <span class="identifier">KernelOperator</span><span class="punctuation">,</span>
            <span class="identifier">Exponentiation</span><span class="punctuation">,</span> <span class="identifier">CompoundKernel</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">base</span> <span class="keyword">import</span> <span class="identifier">clone</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
                                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="punctuation">,</span>
                                    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span>
                                    <span class="identifier">fails_if_pypy</span><span class="grouping">)</span>


<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">Y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">normal</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>

<span class="identifier">kernel_rbf_plus_white</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">WhiteKernel</span><span class="grouping">(</span><span class="identifier">noise_level</span><span class="arithmetic-assignment">=</span><span class="float-literal">3.0</span><span class="grouping">)</span>
<span class="identifier">kernels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">ConstantKernel</span><span class="grouping">(</span><span class="identifier">constant_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">10.0</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.33</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">kernel_rbf_plus_white</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.33</span><span class="punctuation">,</span> <span class="identifier">length_scale_bounds</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fixed"</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.5</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">3.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">2.0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="float-literal">4.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">RationalQuadratic</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">ExpSineSquared</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">periodicity</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span><span class="punctuation">,</span>
           <span class="identifier">DotProduct</span><span class="grouping">(</span><span class="identifier">sigma_0</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">DotProduct</span><span class="grouping">(</span><span class="identifier">sigma_0</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span>
           <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="keyword">for</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="identifier">PAIRWISE_KERNEL_FUNCTIONS</span><span class="punctuation">:</span>
    <span class="keyword">if</span> <span class="identifier">metric</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"additive_chi2", "chi2"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">continue</span>
    <span class="identifier">kernels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">PairwiseKernel</span><span class="grouping">(</span><span class="identifier">gamma</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">metric</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment"># Numerical precisions errors in PyPy</span>
<span class="punctuation">@</span><span class="identifier">fails_if_pypy</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_gradient</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Compare analytic and numeric gradient of kernels.</span>
    <span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">K_gradient</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">K_gradient</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">K_gradient</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">eval_kernel_for_theta</span><span class="grouping">(</span><span class="identifier">theta</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">kernel_clone</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">clone_with_theta</span><span class="grouping">(</span><span class="identifier">theta</span><span class="grouping">)</span>
        <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel_clone</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">K</span>

    <span class="identifier">K_gradient_approx</span> <span class="arithmetic-assignment">=</span> <span class="invalid">\</span>
        <span class="identifier">_approx_fprime</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">eval_kernel_for_theta</span><span class="punctuation">,</span> <span class="float-literal">1e-10</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K_gradient</span><span class="punctuation">,</span> <span class="identifier">K_gradient_approx</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">'kernel'</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="identifier">kernel</span> <span class="keyword">for</span> <span class="identifier">kernel</span> <span class="relational-operator">in</span> <span class="identifier">kernels</span>
         <span class="comment"># skip non-basic kernels</span>
         <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="grouping">(</span><span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">KernelOperator</span><span class="grouping">)</span>
                 <span class="logical-operator">or</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">Exponentiation</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_theta</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that parameter vector theta of kernel is set correctly.</span>
    <span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">K_gradient</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># Determine kernel parameters that contribute to theta</span>
    <span class="identifier">init_sign</span> <span class="arithmetic-assignment">=</span> <span class="identifier">signature</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">parameters</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="keyword">for</span> <span class="identifier">p</span> <span class="relational-operator">in</span> <span class="identifier">init_sign</span> <span class="keyword">if</span> <span class="identifier">p</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">!=</span> <span class="string-literal">'self'</span><span class="grouping">]</span>
    <span class="identifier">theta_vars</span> <span class="arithmetic-assignment">=</span> <span class="identifier">map</span><span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="identifier">s</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="identifier">len</span><span class="grouping">(</span><span class="string-literal">"_bounds"</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">filter</span><span class="grouping">(</span><span class="keyword">lambda</span> <span class="identifier">s</span><span class="punctuation">:</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">endswith</span><span class="grouping">(</span><span class="string-literal">"_bounds"</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">args</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="grouping">(</span>
        <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span>
            <span class="keyword">for</span> <span class="identifier">hyperparameter</span> <span class="relational-operator">in</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="grouping">)</span> <span class="relational-operator">==</span>
        <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">theta_vars</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check that values returned in theta are consistent with</span>
    <span class="comment"># hyperparameter values (being their logarithms)</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">hyperparameter</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Fixed kernel parameters must be excluded from theta and gradient.</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">hyperparameter</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># create copy with certain hyperparameter fixed</span>
        <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">params</span><span class="grouping">[</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="arithmetic-operator">+</span> <span class="string-literal">"_bounds"] = "fixed"</span>
        <span class="identifier">kernel_class</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">__class__</span>
        <span class="identifier">new_kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel_class</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
        <span class="comment"># Check that theta and K_gradient are identical with the fixed</span>
        <span class="comment"># dimension left out</span>
        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">K_gradient_new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">new_kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">eval_gradient</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">theta</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">new_kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">assert</span> <span class="identifier">K_gradient</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">K_gradient_new</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">if</span> <span class="identifier">i</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">theta</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">i</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">new_kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">i</span><span class="grouping">]</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K_gradient</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">K_gradient_new</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="identifier">i</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span> <span class="relational-operator">&lt;</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">new_kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">:</span><span class="grouping">]</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K_gradient</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">K_gradient_new</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Check that values of theta are modified correctly</span>
    <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">hyperparameter</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
        <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">theta</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">42</span><span class="grouping">)</span>

        <span class="identifier">setattr</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="int-literal">43</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">43</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">kernel</span> <span class="keyword">for</span> <span class="identifier">kernel</span> <span class="relational-operator">in</span> <span class="identifier">kernels</span>
                          <span class="comment"># Identity is not satisfied on diagonal</span>
                          <span class="keyword">if</span> <span class="identifier">kernel</span> <span class="relational-operator">!=</span> <span class="identifier">kernel_rbf_plus_white</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_auto_vs_cross</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Auto-correlation and cross-correlation should be consistent.</span>
    <span class="identifier">K_auto</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K_cross</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K_auto</span><span class="punctuation">,</span> <span class="identifier">K_cross</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_diag</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that diag method of kernel returns consistent results.</span>
    <span class="identifier">K_call_diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K_diag</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K_call_diag</span><span class="punctuation">,</span> <span class="identifier">K_diag</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kernel_operator_commutative</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Adding kernels and multiplying kernels should be commutative.</span>
    <span class="comment"># Check addition</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">2.0</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">+</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check multiplication</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">(</span><span class="float-literal">3.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">2.0</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">3.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_kernel_anisotropic</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Anisotropic kernel should be consistent with isotropic kernels.</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">3.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">4</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">3.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K1</span><span class="grouping">)</span>

    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">X2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">/=</span> <span class="int-literal">4</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">3.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="float-literal">0.5</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="comment"># Check getting and setting via theta</span>
    <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">6.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">k2</span><span class="punctuation">.</span><span class="identifier">length_scale</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">kernel</span> <span class="keyword">for</span> <span class="identifier">kernel</span> <span class="relational-operator">in</span> <span class="identifier">kernels</span>
                          <span class="keyword">if</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">is_stationary</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_stationary</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test stationarity of kernels.</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span>  <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_input_type</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test whether kernels is for vectors or structured data</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">Exponentiation</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span> <span class="relational-operator">==</span>
               <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">KernelOperator</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">assert</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span> <span class="relational-operator">==</span>
               <span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">k1</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span> <span class="logical-operator">or</span>
                <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">k2</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_compound_kernel_input_type</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CompoundKernel</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">WhiteKernel</span><span class="grouping">(</span><span class="identifier">noise_level</span><span class="arithmetic-assignment">=</span><span class="float-literal">3.0</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="logical-operator">not</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span>

    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CompoundKernel</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">WhiteKernel</span><span class="grouping">(</span><span class="identifier">noise_level</span><span class="arithmetic-assignment">=</span><span class="float-literal">3.0</span><span class="grouping">)</span><span class="punctuation">,</span>
                             <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">requires_vector_input</span>


<span class="keyword">def</span> <span class="identifier">check_hyperparameters_equal</span><span class="grouping">(</span><span class="identifier">kernel1</span><span class="punctuation">,</span> <span class="identifier">kernel2</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that hyperparameters of two kernels are equal</span>
    <span class="keyword">for</span> <span class="identifier">attr</span> <span class="relational-operator">in</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">dir</span><span class="grouping">(</span><span class="identifier">kernel1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">dir</span><span class="grouping">(</span><span class="identifier">kernel2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">attr</span><span class="punctuation">.</span><span class="identifier">startswith</span><span class="grouping">(</span><span class="string-literal">"hyperparameter_"</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">attr_value1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">kernel1</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span>
            <span class="identifier">attr_value2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">kernel2</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">attr_value1</span> <span class="relational-operator">==</span> <span class="identifier">attr_value2</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"kernel"</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_clone</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that sklearn's clone works correctly on kernels.</span>
    <span class="identifier">kernel_cloned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span>

    <span class="comment"># XXX: Should this be fixed?</span>
    <span class="comment"># This differs from the sklearn's estimators equality check.</span>
    <span class="keyword">assert</span> <span class="identifier">kernel</span> <span class="relational-operator">==</span> <span class="identifier">kernel_cloned</span>
    <span class="keyword">assert</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">kernel_cloned</span><span class="grouping">)</span>

    <span class="comment"># Check that all constructor parameters are equal.</span>
    <span class="keyword">assert</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">kernel_cloned</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Check that all hyperparameters are equal.</span>
    <span class="identifier">check_hyperparameters_equal</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">kernel_cloned</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'kernel'</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_clone_after_set_params</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># This test is to verify that using set_params does not</span>
    <span class="comment"># break clone on kernels.</span>
    <span class="comment"># This used to break because in kernels such as the RBF, non-trivial</span>
    <span class="comment"># logic that modified the length scale used to be in the constructor</span>
    <span class="comment"># See https://github.com/scikit-learn/scikit-learn/issues/6961</span>
    <span class="comment"># for more details.</span>
    <span class="identifier">bounds</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="float-literal">1e-5</span><span class="punctuation">,</span> <span class="float-literal">1e5</span><span class="grouping">)</span>
    <span class="identifier">kernel_cloned</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># RationalQuadratic kernel is isotropic.</span>
    <span class="identifier">isotropic_kernels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">ExpSineSquared</span><span class="punctuation">,</span> <span class="identifier">RationalQuadratic</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="string-literal">'length_scale'</span> <span class="relational-operator">in</span> <span class="identifier">params</span> <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">,</span>
                                                   <span class="identifier">isotropic_kernels</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">length_scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'length_scale'</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">iterable</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># XXX unreached code as of v0.22</span>
            <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'length_scale'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">length_scale</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'length_scale_bounds'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bounds</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'length_scale'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">length_scale</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span>
            <span class="identifier">params</span><span class="grouping">[</span><span class="string-literal">'length_scale_bounds'</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bounds</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span>
        <span class="identifier">kernel_cloned</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span>
        <span class="identifier">kernel_cloned_clone</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clone</span><span class="grouping">(</span><span class="identifier">kernel_cloned</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">kernel_cloned_clone</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">kernel_cloned</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">kernel_cloned_clone</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="identifier">id</span><span class="grouping">(</span><span class="identifier">kernel_cloned</span><span class="grouping">)</span>
        <span class="identifier">check_hyperparameters_equal</span><span class="grouping">(</span><span class="identifier">kernel_cloned</span><span class="punctuation">,</span> <span class="identifier">kernel_cloned_clone</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_matern_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test consistency of Matern kernel for special values of nu.</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="comment"># the diagonal elements of a matern kernel are 1</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">K</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="comment"># matern kernel for coef0==0.5 is equal to absolute exponential kernel</span>
    <span class="identifier">K_absexp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">euclidean_distances</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">squared</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K_absexp</span><span class="grouping">)</span>
    <span class="comment"># matern kernel with coef0==inf is equal to RBF kernel</span>
    <span class="identifier">K_rbf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span><span class="punctuation">,</span> <span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K_rbf</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">,</span> <span class="identifier">K_rbf</span><span class="grouping">)</span>
    <span class="comment"># test that special cases of matern kernel (coef0 in [0.5, 1.5, 2.5])</span>
    <span class="comment"># result in nearly identical results as the general case for coef0 in</span>
    <span class="comment"># [0.5 + tiny, 1.5 + tiny, 2.5 + tiny]</span>
    <span class="identifier">tiny</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-10</span>
    <span class="keyword">for</span> <span class="identifier">nu</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">2.5</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span><span class="punctuation">,</span> <span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">nu</span> <span class="arithmetic-operator">+</span> <span class="identifier">tiny</span><span class="punctuation">,</span> <span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>
    <span class="comment"># test that coef0==large is close to RBF</span>
    <span class="identifier">large</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Matern</span><span class="grouping">(</span><span class="identifier">nu</span><span class="arithmetic-assignment">=</span><span class="identifier">large</span><span class="punctuation">,</span> <span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RBF</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="punctuation">,</span> <span class="identifier">decimal</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"kernel"</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_kernel_versus_pairwise</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that GP kernels can also be used as pairwise kernels.</span>

    <span class="comment"># Test auto-kernel</span>
    <span class="keyword">if</span> <span class="identifier">kernel</span> <span class="relational-operator">!=</span> <span class="identifier">kernel_rbf_plus_white</span><span class="punctuation">:</span>
        <span class="comment"># For WhiteKernel: k(X) != k(X,X). This is assumed by</span>
        <span class="comment"># pairwise_kernels</span>
        <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>

    <span class="comment"># Test cross-kernel</span>
    <span class="identifier">K1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="grouping">)</span>
    <span class="identifier">K2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pairwise_kernels</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Y</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="arithmetic-assignment">=</span><span class="identifier">kernel</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">K1</span><span class="punctuation">,</span> <span class="identifier">K2</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"kernel"</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_set_get_params</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that set_params()/get_params() is consistent with kernel.theta.</span>

    <span class="comment"># Test get_params()</span>
    <span class="identifier">index</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">get_params</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">hyperparameter</span> <span class="relational-operator">in</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="string-literal">"string"</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">bounds</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">bounds</span> <span class="relational-operator">==</span> <span class="string-literal">"fixed"</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">n_elements</span>
        <span class="keyword">if</span> <span class="identifier">size</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>  <span class="comment"># anisotropic kernels</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">index</span><span class="punctuation">:</span><span class="identifier">index</span> <span class="arithmetic-operator">+</span> <span class="identifier">size</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">params</span><span class="grouping">[</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">index</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">size</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">index</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">params</span><span class="grouping">[</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">index</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
    <span class="comment"># Test set_params()</span>
    <span class="identifier">index</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>  <span class="comment"># arbitrary value</span>
    <span class="keyword">for</span> <span class="identifier">hyperparameter</span> <span class="relational-operator">in</span> <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">hyperparameters</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="string-literal">"string"</span><span class="punctuation">,</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">bounds</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">bounds</span> <span class="relational-operator">==</span> <span class="string-literal">"fixed"</span><span class="punctuation">:</span>
                <span class="keyword">continue</span>
        <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">n_elements</span>
        <span class="keyword">if</span> <span class="identifier">size</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>  <span class="comment"># anisotropic kernels</span>
            <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="identifier">value</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">size</span><span class="grouping">}</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">index</span><span class="punctuation">:</span><span class="identifier">index</span> <span class="arithmetic-operator">+</span> <span class="identifier">size</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="grouping">[</span><span class="identifier">value</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">size</span><span class="grouping">)</span>
            <span class="identifier">index</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">size</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="grouping">{</span><span class="identifier">hyperparameter</span><span class="punctuation">.</span><span class="identifier">name</span><span class="punctuation">:</span> <span class="identifier">value</span><span class="grouping">}</span><span class="grouping">)</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="punctuation">.</span><span class="identifier">theta</span><span class="grouping">[</span><span class="identifier">index</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">value</span><span class="grouping">)</span>
            <span class="identifier">index</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"kernel"</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_repr_kernels</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Smoke-test for repr in kernels.</span>

    <span class="identifier">repr</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_rational_quadratic_kernel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RationalQuadratic</span><span class="grouping">(</span><span class="identifier">length_scale</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">message</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
        <span class="string-literal">"RationalQuadratic kernel only supports isotropic "</span>
        <span class="string-literal">"version, please use a single "</span>
        <span class="string-literal">"scalar for length_scale"</span>
    <span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">AttributeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">kernel</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    </pre>
  </body>
</html>