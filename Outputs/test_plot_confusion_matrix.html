<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># TODO: remove this file when plot_confusion_matrix will be deprecated in 1.2</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">compose</span> <span class="keyword">import</span> <span class="identifier">make_column_transformer</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">datasets</span> <span class="keyword">import</span> <span class="identifier">make_classification</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LogisticRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">make_pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="identifier">StandardScaler</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">svm</span> <span class="keyword">import</span> <span class="identifier">SVC</span><span class="punctuation">,</span> <span class="identifier">SVR</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">confusion_matrix</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">plot_confusion_matrix</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">ConfusionMatrixDisplay</span>


<span class="comment"># TODO: Remove when https://github.com/numpy/numpy/issues/14397 is resolved</span>
<span class="identifier">pytestmark</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore:In future, it will be an error for 'np.bool_':DeprecationWarning:"</span>
    <span class="string-literal">"matplotlib.*"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">fixture</span><span class="grouping">(</span><span class="identifier">scope</span><span class="arithmetic-assignment">=</span><span class="string-literal">"module"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">n_classes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="int-literal">5</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">fixture</span><span class="grouping">(</span><span class="identifier">scope</span><span class="arithmetic-assignment">=</span><span class="string-literal">"module"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">data</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                               <span class="identifier">n_classes</span><span class="arithmetic-assignment">=</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">fixture</span><span class="grouping">(</span><span class="identifier">scope</span><span class="arithmetic-assignment">=</span><span class="string-literal">"module"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">fitted_clf</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">return</span> <span class="identifier">SVC</span><span class="grouping">(</span><span class="identifier">kernel</span><span class="arithmetic-assignment">=</span><span class="string-literal">'linear'</span><span class="punctuation">,</span> <span class="identifier">C</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">data</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">fixture</span><span class="grouping">(</span><span class="identifier">scope</span><span class="arithmetic-assignment">=</span><span class="string-literal">"module"</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">y_pred</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="keyword">return</span> <span class="identifier">fitted_clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_error_on_regressor</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SVR</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"plot_confusion_matrix only supports classifiers"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_error_on_invalid_option</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">r</span><span class="string-literal">"normalize must be one of \{'true', 'pred', 'all', "</span>
           <span class="identifier">r</span><span class="string-literal">"None\}"</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="string-literal">'invalid'</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"with_labels"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"with_display_labels"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_plot_confusion_matrix_custom_labels</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span>
                                             <span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="punctuation">,</span>
                                             <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">gca</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span> <span class="keyword">else</span> <span class="none-literal">None</span>
    <span class="identifier">display_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">'b', 'd', 'a', 'e', 'f'</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span> <span class="keyword">else</span> <span class="none-literal">None</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="identifier">labels</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                 <span class="identifier">ax</span><span class="arithmetic-assignment">=</span><span class="identifier">ax</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="identifier">display_labels</span><span class="punctuation">,</span>
                                 <span class="identifier">labels</span><span class="arithmetic-assignment">=</span><span class="identifier">labels</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">d</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">p</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">display_labels</span>
    <span class="keyword">elif</span> <span class="invalid">w</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">_</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">b</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">labels</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_display_labels_str</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>
                                   <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">expected_display_labels</span><span class="grouping">]</span>

    <span class="identifier">x_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_yticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">display_labels</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"normalize"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'true', 'pred', 'all'</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"include_values"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span>
                               <span class="identifier">normalize</span><span class="punctuation">,</span> <span class="identifier">include_values</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">ax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">gca</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">cmap</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'plasma'</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                 <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="identifier">normalize</span><span class="punctuation">,</span>
                                 <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">cmap</span><span class="punctuation">,</span> <span class="identifier">ax</span><span class="arithmetic-assignment">=</span><span class="identifier">ax</span><span class="punctuation">,</span>
                                 <span class="identifier">include_values</span><span class="arithmetic-assignment">=</span><span class="identifier">include_values</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span> <span class="relational-operator">==</span> <span class="identifier">ax</span>

    <span class="keyword">if</span> <span class="identifier">normalize</span> <span class="relational-operator">==</span> <span class="string-literal">'true'</span><span class="punctuation">:</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cm</span> <span class="arithmetic-operator">/</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">normalize</span> <span class="relational-operator">==</span> <span class="string-literal">'pred'</span><span class="punctuation">:</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cm</span> <span class="arithmetic-operator">/</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">elif</span> <span class="identifier">normalize</span> <span class="relational-operator">==</span> <span class="string-literal">'all'</span><span class="punctuation">:</span>
        <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cm</span> <span class="arithmetic-operator">/</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>
    <span class="keyword">import</span> <span class="identifier">matplotlib</span> <span class="keyword">as</span> <span class="identifier">mpl</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">,</span> <span class="identifier">mpl</span><span class="punctuation">.</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">AxesImage</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_cmap</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="identifier">cmap</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">,</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">Axes</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">figure_</span><span class="punctuation">,</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">Figure</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_ylabel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"True label"</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xlabel</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="string-literal">"Predicted label"</span>

    <span class="identifier">x_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_yticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">expected_display_labels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">expected_display_labels_str</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>
                                   <span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">expected_display_labels</span><span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">display_labels</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_display_labels_str</span><span class="grouping">)</span>

    <span class="identifier">image_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_array</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">image_data</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>

    <span class="keyword">if</span> <span class="identifier">include_values</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>
        <span class="identifier">fmt</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'.2g'</span>
        <span class="identifier">expected_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">fmt</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">text_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
            <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_text</span><span class="punctuation">,</span> <span class="identifier">text_text</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_display</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">normalize</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                                 <span class="identifier">include_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="string-literal">'viridis'</span><span class="punctuation">,</span>
                                 <span class="identifier">xticks_rotation</span><span class="arithmetic-assignment">=</span><span class="float-literal">45.0</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>

    <span class="identifier">rotations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_rotation</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">rotations</span><span class="punctuation">,</span> <span class="float-literal">45.0</span><span class="grouping">)</span>

    <span class="identifier">image_data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_array</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">image_data</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="string-literal">'plasma'</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">get_cmap</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="relational-operator">==</span> <span class="string-literal">'plasma'</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">include_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">xticks_rotation</span><span class="arithmetic-assignment">=</span><span class="float-literal">90.0</span><span class="grouping">)</span>
    <span class="identifier">rotations</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_rotation</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">rotations</span><span class="punctuation">,</span> <span class="float-literal">90.0</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">values_format</span><span class="arithmetic-assignment">=</span><span class="string-literal">'e'</span><span class="grouping">)</span>
    <span class="identifier">expected_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="string-literal">'e'</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">text_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_text</span><span class="punctuation">,</span> <span class="identifier">text_text</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_contrast</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># make sure text color is appropriate depending on background</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">eye</span><span class="grouping">(</span><span class="int-literal">2</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span><span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">gray</span><span class="grouping">)</span>
    <span class="comment"># diagonal text is black</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># off-diagonal text is white</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">gray_r</span><span class="grouping">)</span>
    <span class="comment"># diagonal text is white</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># off-diagonal text is black</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Regression test for #15920</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">19</span><span class="punctuation">,</span> <span class="int-literal">34</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="int-literal">58</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span><span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">cmap</span><span class="arithmetic-assignment">=</span><span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">Blues</span><span class="grouping">)</span>
    <span class="identifier">min_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">Blues</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">max_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pyplot</span><span class="punctuation">.</span><span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">Blues</span><span class="grouping">(</span><span class="int-literal">255</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_color</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_color</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_color</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">get_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">min_color</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"clf"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
            <span class="identifier">make_pipeline</span><span class="grouping">(</span><span class="identifier">make_column_transformer</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">StandardScaler</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">LogisticRegression</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_pipeline</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">confusion_matrix</span><span class="punctuation">,</span> <span class="identifier">cm</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"colorbar"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_plot_confusion_matrix_colorbar</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">colorbar</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>

    <span class="keyword">def</span> <span class="identifier">_check_colorbar</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">,</span> <span class="identifier">has_colorbar</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="identifier">has_colorbar</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">colorbar</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span>
            <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">colorbar</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span> <span class="relational-operator">==</span> <span class="string-literal">"Colorbar"</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">im_</span><span class="punctuation">.</span><span class="identifier">colorbar</span> <span class="relational-operator">is</span> <span class="none-literal">None</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">colorbar</span><span class="arithmetic-assignment">=</span><span class="identifier">colorbar</span><span class="grouping">)</span>
    <span class="identifier">_check_colorbar</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">,</span> <span class="identifier">colorbar</span><span class="grouping">)</span>
    <span class="comment"># attempt a plot with the opposite effect of colorbar</span>
    <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="identifier">colorbar</span><span class="arithmetic-assignment">=</span><span class="logical-operator">not</span> <span class="identifier">colorbar</span><span class="grouping">)</span>
    <span class="identifier">_check_colorbar</span><span class="grouping">(</span><span class="identifier">disp</span><span class="punctuation">,</span> <span class="logical-operator">not</span> <span class="identifier">colorbar</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"values_format"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">'e', 'n'</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_text_format</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="punctuation">,</span>
                                      <span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">values_format</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Make sure plot text is formatted with 'values_format'.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confusion_matrix</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                 <span class="identifier">include_values</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                 <span class="identifier">values_format</span><span class="arithmetic-assignment">=</span><span class="identifier">values_format</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>

    <span class="identifier">expected_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">v</span><span class="punctuation">,</span> <span class="identifier">values_format</span><span class="grouping">)</span>
                              <span class="keyword">for</span> <span class="identifier">v</span> <span class="relational-operator">in</span> <span class="identifier">cm</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">text_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">text_</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_text</span><span class="punctuation">,</span> <span class="identifier">text_text</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_confusion_matrix_standard_format</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">10000000</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">123456</span><span class="punctuation">,</span> <span class="int-literal">12345678</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">plotted_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span>
        <span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">text_</span>
    <span class="comment"># Values should be shown as whole numbers 'd',</span>
    <span class="comment"># except the first number which should be shown as 1e+07 (longer length)</span>
    <span class="comment"># and the last number will be shown as 1.2e+07 (longer length)</span>
    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">plotted_text</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">test</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="string-literal">'1e+07', '0', '123456', '1.2e+07'</span><span class="grouping">]</span>

    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="float-literal">0.525</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">plotted_text</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span>
        <span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">text_</span>
    <span class="comment"># Values should now formatted as '.2g', since there's a float in</span>
    <span class="comment"># Values are have two dec places max, (e.g 100 becomes 1e+02)</span>
    <span class="identifier">test</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">t</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">t</span> <span class="relational-operator">in</span> <span class="identifier">plotted_text</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">assert</span> <span class="identifier">test</span> <span class="relational-operator">==</span> <span class="grouping">[</span><span class="string-literal">'0.1', '10', '1e+02', '0.53'</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"display_labels, expected_labels"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="string-literal">"0", "1"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"cat", "dog"], ["cat", "dog"</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_default_labels</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="punctuation">,</span> <span class="identifier">expected_labels</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">cm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">120</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ConfusionMatrixDisplay</span><span class="grouping">(</span><span class="identifier">cm</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="arithmetic-assignment">=</span><span class="identifier">display_labels</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">plot</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">x_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">y_ticks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_yticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">x_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_labels</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_ticks</span><span class="punctuation">,</span> <span class="identifier">expected_labels</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">filterwarnings</span><span class="grouping">(</span>
    <span class="string-literal">"ignore: Function plot_confusion_matrix is deprecated"</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_error_on_a_dataset_with_unseen_labels</span><span class="grouping">(</span>
    <span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">n_classes</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check that when labels=None, the unique values in `y_pred` and `y_true`
    will be used.
    Non-regression test for:
    https://github.com/scikit-learn/scikit-learn/pull/18405
    """</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span>

    <span class="comment"># create unseen labels in `y_true` not seen during fitting and not present</span>
    <span class="comment"># in 'fitted_clf.classes_'</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">disp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">display_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">tick</span><span class="punctuation">.</span><span class="identifier">get_text</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">tick</span> <span class="relational-operator">in</span> <span class="identifier">disp</span><span class="punctuation">.</span><span class="identifier">ax_</span><span class="punctuation">.</span><span class="identifier">get_xticklabels</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">expected_labels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">str</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_classes</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">expected_labels</span><span class="punctuation">,</span> <span class="identifier">display_labels</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_plot_confusion_matrix_deprecation_warning</span><span class="grouping">(</span><span class="identifier">pyplot</span><span class="punctuation">,</span> <span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">plot_confusion_matrix</span><span class="grouping">(</span><span class="identifier">fitted_clf</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="identifier">data</span><span class="grouping">)</span>

    </pre>
  </body>
</html>