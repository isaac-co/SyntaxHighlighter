<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment"># Authors: Emmanuelle Gouillart &lt;emmanuelle.gouillart@normalesup.org&gt;</span>
<span class="comment">#          Gael Varoquaux &lt;gael.varoquaux@normalesup.org&gt;</span>
<span class="comment"># License: BSD 3 clause</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">scipy</span> <span class="keyword">as</span> <span class="identifier">sp</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">ndimage</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csgraph</span> <span class="keyword">import</span> <span class="identifier">connected_components</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">feature_extraction</span><span class="punctuation">.</span><span class="identifier">image</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">img_to_graph</span><span class="punctuation">,</span> <span class="identifier">grid_to_graph</span><span class="punctuation">,</span> <span class="identifier">extract_patches_2d</span><span class="punctuation">,</span>
    <span class="identifier">reconstruct_from_patches_2d</span><span class="punctuation">,</span> <span class="identifier">PatchExtractor</span><span class="punctuation">,</span> <span class="identifier">_extract_patches</span><span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>


<span class="keyword">def</span> <span class="identifier">test_img_to_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">x</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mgrid</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="int-literal">10</span>
    <span class="identifier">grad_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_to_graph</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
    <span class="identifier">grad_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_to_graph</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">grad_x</span><span class="punctuation">.</span><span class="identifier">nnz</span> <span class="relational-operator">==</span> <span class="identifier">grad_y</span><span class="punctuation">.</span><span class="identifier">nnz</span>
    <span class="comment"># Negative elements are the diagonal: the elements of the original</span>
    <span class="comment"># image. Positive elements are the values of the gradient, they</span>
    <span class="comment"># should all be equal on grad_x and grad_y</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">grad_x</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">grad_x</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">grad_y</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">grad_y</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_grid_to_graph</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Checking that the function works with graphs containing no edges</span>
    <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">roi_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="comment"># Generating two convex parts with one vertex</span>
    <span class="comment"># Thus, edges will be empty in _to_graph</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="identifier">mask</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">roi_size</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="identifier">roi_size</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="identifier">mask</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="identifier">roi_size</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">roi_size</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mask</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">size</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ndarray</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">connected_components</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="comment"># Checking that the function works whatever the type of mask is</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">int16</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">connected_components</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="comment"># Checking dtype of the graph</span>
    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">bool</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">bool</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">int</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="identifier">n_x</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_y</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">n_z</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span>
                      <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">DeprecationWarning</span><span class="grouping">)</span>  <span class="comment"># scipy deprecation inside face</span>
<span class="keyword">def</span> <span class="identifier">test_connect_regions</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">AttributeError</span><span class="punctuation">:</span>
        <span class="comment"># Newer versions of scipy have face in misc</span>
        <span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">misc</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">misc</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="comment"># subsample by 4 to reduce run time</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">thr</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="int-literal">50</span><span class="punctuation">,</span> <span class="int-literal">150</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span> <span class="relational-operator">&gt;</span> <span class="identifier">thr</span>
        <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img_to_graph</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">ndimage</span><span class="punctuation">.</span><span class="identifier">label</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">connected_components</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">DeprecationWarning</span><span class="grouping">)</span>  <span class="comment"># scipy deprecation inside face</span>
<span class="keyword">def</span> <span class="identifier">test_connect_regions_with_grid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">AttributeError</span><span class="punctuation">:</span>
        <span class="comment"># Newer versions of scipy have face in misc</span>
        <span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">misc</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">misc</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

    <span class="comment"># subsample by 4 to reduce run time</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span>

    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span> <span class="relational-operator">&gt;</span> <span class="int-literal">50</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ndimage</span><span class="punctuation">.</span><span class="identifier">label</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">connected_components</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span> <span class="relational-operator">&gt;</span> <span class="int-literal">150</span>
    <span class="identifier">graph</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_to_graph</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">mask</span><span class="arithmetic-assignment">=</span><span class="identifier">mask</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">ndimage</span><span class="punctuation">.</span><span class="identifier">label</span><span class="grouping">(</span><span class="identifier">mask</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">connected_components</span><span class="grouping">(</span><span class="identifier">graph</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>


<span class="keyword">def</span> <span class="identifier">_downsampled_face</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sp</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">AttributeError</span><span class="punctuation">:</span>
        <span class="comment"># Newer versions of scipy have face in misc</span>
        <span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">misc</span>
        <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">misc</span><span class="punctuation">.</span><span class="identifier">face</span><span class="grouping">(</span><span class="identifier">gray</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">/=</span> <span class="float-literal">16.0</span>
    <span class="keyword">return</span> <span class="identifier">face</span>


<span class="keyword">def</span> <span class="identifier">_orange_face</span><span class="grouping">(</span><span class="identifier">face</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_downsampled_face</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">face</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">face</span>
    <span class="identifier">face_color</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="arithmetic-operator">+</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">face_color</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span> <span class="arithmetic-operator">-</span> <span class="identifier">face</span>
    <span class="identifier">face_color</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span> <span class="arithmetic-operator">-</span> <span class="identifier">face</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>
    <span class="identifier">face_color</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">256</span> <span class="arithmetic-operator">-</span> <span class="identifier">face</span> <span class="arithmetic-operator">/</span> <span class="int-literal">4</span>
    <span class="keyword">return</span> <span class="identifier">face_color</span>


<span class="keyword">def</span> <span class="identifier">_make_images</span><span class="grouping">(</span><span class="identifier">face</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_downsampled_face</span><span class="grouping">(</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">face</span> <span class="relational-operator">is</span> <span class="none-literal">None</span> <span class="keyword">else</span> <span class="identifier">face</span>
    <span class="comment"># make a collection of faces</span>
    <span class="identifier">images</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">images</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span>
    <span class="identifier">images</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
    <span class="identifier">images</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span>
    <span class="keyword">return</span> <span class="identifier">images</span>

<span class="identifier">downsampled_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_downsampled_face</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">orange_face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_orange_face</span><span class="grouping">(</span><span class="identifier">downsampled_face</span><span class="grouping">)</span>
<span class="identifier">face_collection</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_images</span><span class="grouping">(</span><span class="identifier">downsampled_face</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_all</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">16</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_all_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orange_face</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">16</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_all_rect</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">32</span><span class="punctuation">:</span><span class="int-literal">97</span><span class="grouping">]</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">12</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_max_patches</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">16</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>

    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="float-literal">-1.0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patch_same_size_image</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="comment"># Request patches of the same size as image</span>
    <span class="comment"># Should return just the single patch a.k.a. the image</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_less_than_max_patches</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">i_h</span> <span class="arithmetic-operator">//</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span> <span class="arithmetic-operator">*</span> <span class="identifier">i_w</span> <span class="arithmetic-operator">//</span> <span class="int-literal">4</span>
    <span class="comment"># this is 3185</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="int-literal">4000</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_reconstruct_patches_perfect</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">16</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">face_reconstructed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reconstruct_from_patches_2d</span><span class="grouping">(</span><span class="identifier">patches</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">face_reconstructed</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_reconstruct_patches_perfect_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">orange_face</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">16</span><span class="punctuation">,</span> <span class="int-literal">16</span>

    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">face_reconstructed</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reconstruct_from_patches_2d</span><span class="grouping">(</span><span class="identifier">patches</span><span class="punctuation">,</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">testing</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">face_reconstructed</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_patch_extractor_fit</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_collection</span>
    <span class="identifier">extr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">patch_size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">extr</span> <span class="relational-operator">==</span> <span class="identifier">extr</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_patch_extractor_max_patches</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_collection</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span>

    <span class="identifier">max_patches</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">max_patches</span>
    <span class="identifier">extr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">patch_size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="identifier">max_patches</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extr</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>

    <span class="identifier">max_patches</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.5</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">int</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
                                          <span class="arithmetic-operator">*</span> <span class="identifier">max_patches</span><span class="grouping">)</span>
    <span class="identifier">extr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">patch_size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="identifier">max_patches</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extr</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_patch_extractor_max_patches_default</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_collection</span>
    <span class="identifier">extr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">max_patches</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extr</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">19</span><span class="punctuation">,</span> <span class="int-literal">25</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_patch_extractor_all_patches</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face_collection</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">extr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">patch_size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extr</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_patch_extractor_color</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">faces</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_make_images</span><span class="grouping">(</span><span class="identifier">orange_face</span><span class="grouping">)</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">faces</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">8</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_h</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p_w</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">extr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PatchExtractor</span><span class="grouping">(</span><span class="identifier">patch_size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">extr</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">faces</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="punctuation">,</span> <span class="identifier">p_h</span><span class="punctuation">,</span> <span class="identifier">p_w</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_strided</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>

    <span class="identifier">image_shapes_1D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">patch_sizes_1D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">patch_steps_1D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">expected_views_1D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">9</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">last_patch_1D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">8</span><span class="punctuation">,</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">image_shapes_2D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">patch_sizes_2D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">patch_steps_2D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">expected_views_2D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">last_patch_2D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">14</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">image_shapes_3D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">patch_sizes_3D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">patch_steps_3D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">expected_views_3D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="identifier">last_patch_3D</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">]</span>

    <span class="identifier">image_shapes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image_shapes_1D</span> <span class="arithmetic-operator">+</span> <span class="identifier">image_shapes_2D</span> <span class="arithmetic-operator">+</span> <span class="identifier">image_shapes_3D</span>
    <span class="identifier">patch_sizes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patch_sizes_1D</span> <span class="arithmetic-operator">+</span> <span class="identifier">patch_sizes_2D</span> <span class="arithmetic-operator">+</span> <span class="identifier">patch_sizes_3D</span>
    <span class="identifier">patch_steps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">patch_steps_1D</span> <span class="arithmetic-operator">+</span> <span class="identifier">patch_steps_2D</span> <span class="arithmetic-operator">+</span> <span class="identifier">patch_steps_3D</span>
    <span class="identifier">expected_views</span> <span class="arithmetic-assignment">=</span> <span class="identifier">expected_views_1D</span> <span class="arithmetic-operator">+</span> <span class="identifier">expected_views_2D</span> <span class="arithmetic-operator">+</span> <span class="identifier">expected_views_3D</span>
    <span class="identifier">last_patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">last_patch_1D</span> <span class="arithmetic-operator">+</span> <span class="identifier">last_patch_2D</span> <span class="arithmetic-operator">+</span> <span class="identifier">last_patch_3D</span>

    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">image_shape</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="punctuation">,</span> <span class="identifier">patch_step</span><span class="punctuation">,</span> <span class="identifier">expected_view</span><span class="punctuation">,</span>
         <span class="identifier">last_patch</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">image_shapes</span><span class="punctuation">,</span> <span class="identifier">patch_sizes</span><span class="punctuation">,</span> <span class="identifier">patch_steps</span><span class="punctuation">,</span>
                            <span class="identifier">expected_views</span><span class="punctuation">,</span> <span class="identifier">last_patches</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">prod</span><span class="grouping">(</span><span class="identifier">image_shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">image_shape</span><span class="grouping">)</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_extract_patches</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">patch_shape</span><span class="arithmetic-assignment">=</span><span class="identifier">patch_size</span><span class="punctuation">,</span>
                                   <span class="identifier">extraction_step</span><span class="arithmetic-assignment">=</span><span class="identifier">patch_step</span><span class="grouping">)</span>

        <span class="identifier">ndim</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">image_shape</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">ndim</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">expected_view</span>
        <span class="identifier">last_patch_slices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">slice</span><span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="identifier">j</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span> <span class="relational-operator">in</span>
                                  <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">last_patch</span><span class="punctuation">,</span> <span class="identifier">patch_size</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">patches</span><span class="grouping">[</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">ndim</span><span class="grouping">]</span> <span class="relational-operator">==</span>
                <span class="identifier">image</span><span class="grouping">[</span><span class="identifier">last_patch_slices</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_extract_patches_square</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test same patch size for all dimensions</span>
    <span class="identifier">face</span> <span class="arithmetic-assignment">=</span> <span class="identifier">downsampled_face</span>
    <span class="identifier">i_h</span><span class="punctuation">,</span> <span class="identifier">i_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">face</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span>
    <span class="identifier">expected_n_patches</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">i_h</span> <span class="arithmetic-operator">-</span> <span class="identifier">p</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">i_w</span> <span class="arithmetic-operator">-</span> <span class="identifier">p</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_extract_patches</span><span class="grouping">(</span><span class="identifier">face</span><span class="punctuation">,</span> <span class="identifier">patch_shape</span><span class="arithmetic-assignment">=</span><span class="identifier">p</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">patches</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">expected_n_patches</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
                             <span class="identifier">expected_n_patches</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="punctuation">,</span> <span class="identifier">p</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_width_patch</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># width and height of the patch should be less than the image</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">extract_patches_2d</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>