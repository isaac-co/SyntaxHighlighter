<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" Custom Loss Functions for faceswap.py """</span>

<span class="keyword">from</span> <span class="identifier">__future__</span> <span class="keyword">import</span> <span class="identifier">absolute_import</span>

<span class="keyword">import</span> <span class="identifier">logging</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">tensorflow</span> <span class="keyword">as</span> <span class="identifier">tf</span>
<span class="keyword">from</span> <span class="identifier">tensorflow</span><span class="punctuation">.</span><span class="identifier">python</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">engine</span> <span class="keyword">import</span> <span class="identifier">compile_utils</span>

<span class="keyword">from</span> <span class="identifier">keras</span> <span class="keyword">import</span> <span class="identifier">backend</span> <span class="keyword">as</span> <span class="identifier">K</span>

<span class="identifier">logger</span> <span class="arithmetic-assignment">=</span> <span class="identifier">logging</span><span class="punctuation">.</span><span class="identifier">getLogger</span><span class="grouping">(</span><span class="identifier">__name__</span><span class="grouping">)</span>  <span class="comment"># pylint:disable=invalid-name</span>


<span class="keyword">class</span> <span class="identifier">DSSIMObjective</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">losses</span><span class="punctuation">.</span><span class="identifier">Loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" DSSIM Loss Function

    Difference of Structural Similarity (DSSIM loss function). Clipped between 0 and 0.5

    Parameters
    ----------
    k_1: float, optional
        Parameter of the SSIM. Default: `0.01`
    k_2: float, optional
        Parameter of the SSIM. Default: `0.03`
    kernel_size: int, optional
        Size of the sliding window Default: `3`
    max_value: float, optional
        Max value of the output. Default: `1.0`

    Notes
    ------
    You should add a regularization term like a l2 loss in addition to this one.

    References
    ----------
    https://github.com/keras-team/keras-contrib/blob/master/keras_contrib/losses/dssim.py

    MIT License

    Copyright (c) 2017 Fariz Rahman

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">k_1</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">k_2</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.03</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">max_value</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"DSSIMObjective"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kernel_size</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k_1</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">k_2</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_value</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">c_1</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k_1</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_value</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">c_2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">k_2</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_value</span><span class="grouping">)</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dim_ordering</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">image_data_format</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_int_shape</span><span class="grouping">(</span><span class="identifier">input_tensor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Returns the shape of tensor or variable as a tuple of int or None entries.

        Parameters
        ----------
        input_tensor: tensor or variable
            The input to return the shape for

        Returns
        -------
        tuple
            A tuple of integers (or None entries)
        """</span>
        <span class="keyword">return</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">input_tensor</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call the DSSIM Loss Function.

        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value

        Returns
        -------
        tensor
            The DSSIM Loss value

        Notes
        -----
        There are additional parameters for this function. some of the 'modes' for edge behavior
        do not yet have a gradient definition in the Theano tree and cannot be used for learning
        """</span>

        <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kernel_size</span><span class="grouping">]</span>
        <span class="identifier">y_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_int_shape</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_int_shape</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">patches_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extract_image_patches</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span>
                                                  <span class="identifier">kernel</span><span class="punctuation">,</span>
                                                  <span class="identifier">kernel</span><span class="punctuation">,</span>
                                                  <span class="string-literal">'valid'</span><span class="punctuation">,</span>
                                                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dim_ordering</span><span class="grouping">)</span>
        <span class="identifier">patches_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">extract_image_patches</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span>
                                                  <span class="identifier">kernel</span><span class="punctuation">,</span>
                                                  <span class="identifier">kernel</span><span class="punctuation">,</span>
                                                  <span class="string-literal">'valid'</span><span class="punctuation">,</span>
                                                  <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">dim_ordering</span><span class="grouping">)</span>

        <span class="comment"># Get mean</span>
        <span class="identifier">u_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">patches_true</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">u_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">patches_pred</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="comment"># Get variance</span>
        <span class="identifier">var_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">patches_true</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">var_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">var</span><span class="grouping">(</span><span class="identifier">patches_pred</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="comment"># Get standard deviation</span>
        <span class="identifier">covar_true_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span>
            <span class="identifier">patches_true</span> <span class="arithmetic-operator">*</span> <span class="identifier">patches_pred</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">u_true</span> <span class="arithmetic-operator">*</span> <span class="identifier">u_pred</span>

        <span class="identifier">ssim</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">u_true</span> <span class="arithmetic-operator">*</span> <span class="identifier">u_pred</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">c_1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span>
            <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">covar_true_pred</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">c_2</span><span class="grouping">)</span>
        <span class="identifier">denom</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">square</span><span class="grouping">(</span><span class="identifier">u_true</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">square</span><span class="grouping">(</span><span class="identifier">u_pred</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">c_1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span>
            <span class="identifier">var_pred</span> <span class="arithmetic-operator">+</span> <span class="identifier">var_true</span> <span class="arithmetic-operator">+</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">c_2</span><span class="grouping">)</span>
        <span class="identifier">ssim</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">denom</span>  <span class="comment"># no need for clipping, c_1 + c_2 make the denorm non-zero</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="float-literal">1.0</span> <span class="arithmetic-operator">-</span> <span class="identifier">ssim</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.0</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_preprocess_padding</span><span class="grouping">(</span><span class="identifier">padding</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Convert keras padding to tensorflow padding.

        Parameters
        ----------
        padding: string,
            `"same"` or `"valid"`.

        Returns
        -------
        str
            `"SAME"` or `"VALID"`.

        Raises
        ------
        ValueError
            If `padding` is invalid.
        """</span>
        <span class="keyword">if</span> <span class="identifier">padding</span> <span class="relational-operator">==</span> <span class="string-literal">'same'</span><span class="punctuation">:</span>
            <span class="identifier">padding</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'SAME'</span>
        <span class="keyword">elif</span> <span class="identifier">padding</span> <span class="relational-operator">==</span> <span class="string-literal">'valid'</span><span class="punctuation">:</span>
            <span class="identifier">padding</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">'VALID'</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">raise</span> <span class="identifier">ValueError</span><span class="grouping">(</span><span class="string-literal">'Invalid padding:'</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">padding</span>

    <span class="keyword">def</span> <span class="identifier">extract_image_patches</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_tensor</span><span class="punctuation">,</span> <span class="identifier">k_sizes</span><span class="punctuation">,</span> <span class="identifier">s_sizes</span><span class="punctuation">,</span>
                              <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'same', data_format='channels_last'</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Extract the patches from an image.

        Parameters
        ----------
        input_tensor: tensor
            The input image
        k_sizes: tuple
            2-d tuple with the kernel size
        s_sizes: tuple
            2-d tuple with the strides size
        padding: str, optional
            `"same"` or `"valid"`. Default: `"same"`
        data_format: str, optional.
            `"channels_last"` or `"channels_first"`. Default: `"channels_last"`

        Returns
        -------
        The (k_w, k_h) patches extracted
            Tensorflow ==&gt; (batch_size, w, h, k_w, k_h, c)
            Theano ==&gt; (batch_size, w, h, c, k_w, k_h)
        """</span>
        <span class="identifier">kernel</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">k_sizes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">k_sizes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">strides</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">s_sizes</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">s_sizes</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="identifier">padding</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_preprocess_padding</span><span class="grouping">(</span><span class="identifier">padding</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">data_format</span> <span class="relational-operator">==</span> <span class="string-literal">'channels_first'</span><span class="punctuation">:</span>
            <span class="identifier">input_tensor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">permute_dimensions</span><span class="grouping">(</span><span class="identifier">input_tensor</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">patches</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">extract_patches</span><span class="grouping">(</span><span class="identifier">input_tensor</span><span class="punctuation">,</span> <span class="identifier">kernel</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">patches</span>


<span class="keyword">class</span> <span class="identifier">GeneralizedLoss</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">losses</span><span class="punctuation">.</span><span class="identifier">Loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""  Generalized function used to return a large variety of mathematical loss functions.

    The primary benefit is a smooth, differentiable version of L1 loss.

    References
    ----------
    Barron, J. A More General Robust Loss Function - https://arxiv.org/pdf/1701.03077.pdf

    Example
    -------
    &gt;&gt;&gt; a=1.0, x&gt;&gt;c , c=1.0/255.0  # will give a smoothly differentiable version of L1 / MAE loss
    &gt;&gt;&gt; a=1.999999 (limit as a-&gt;2), beta=1.0/255.0 # will give L2 / RMSE loss

    Parameters
    ----------
    alpha: float, optional
        Penalty factor. Larger number give larger weight to large deviations. Default: `1.0`
    beta: float, optional
        Scale factor used to adjust to the input scale (i.e. inputs of mean `1e-4` or `256`).
        Default: `1.0/255.0`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">beta</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="arithmetic-operator">/</span><span class="float-literal">255.0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"generalized_loss"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span> <span class="arithmetic-assignment">=</span> <span class="identifier">beta</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call the Generalized Loss Function

        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value

        Returns
        -------
        tensor
            The loss value from the results of function(y_pred - y_true)
        """</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_pred</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_true</span>
        <span class="identifier">second</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">pow</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">pow</span><span class="grouping">(</span><span class="identifier">diff</span><span class="arithmetic-operator">/</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span>
                        <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">second</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">loss</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">beta</span>
        <span class="keyword">return</span> <span class="identifier">loss</span>


<span class="keyword">class</span> <span class="identifier">LInfNorm</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">losses</span><span class="punctuation">.</span><span class="identifier">Loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Calculate the L-inf norm as a loss function. """</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call the L-inf norm loss function.

        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value

        Returns
        -------
        tensor
            The loss value
        """</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y_true</span> <span class="arithmetic-operator">-</span> <span class="identifier">y_pred</span><span class="grouping">)</span>
        <span class="identifier">max_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">diff</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">max_loss</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">loss</span>


<span class="keyword">class</span> <span class="identifier">GradientLoss</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">losses</span><span class="punctuation">.</span><span class="identifier">Loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Gradient Loss Function.

    Calculates the first and second order gradient difference between pixels of an image in the x
    and y dimensions. These gradients are then compared between the ground truth and the predicted
    image and the difference is taken. When used as a loss, its minimization will result in
    predicted images approaching the same level of sharpness / blurriness as the ground truth.

    References
    ----------
    TV+TV2 Regularization with Non-Convex Sparseness-Inducing Penalty for Image Restoration,
    Chengwu Lu & Hua Huang, 2014 - http://downloads.hindawi.com/journals/mpe/2014/790547.pdf
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"generalized_loss"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generalized_loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">GeneralizedLoss</span><span class="grouping">(</span><span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.9999</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call the gradient loss function.

        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value

        Returns
        -------
        tensor
            The loss value
        """</span>
        <span class="identifier">tv_weight</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
        <span class="identifier">tv2_weight</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1.0</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">tv_weight</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generalized_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_x</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_x</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generalized_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_y</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_y</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">tv2_weight</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generalized_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_xx</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_xx</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generalized_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_yy</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_yy</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span>
                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">generalized_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_xy</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_diff_xy</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="grouping">)</span><span class="grouping">)</span>
                              <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">)</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">loss</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">tv_weight</span> <span class="arithmetic-operator">+</span> <span class="identifier">tv2_weight</span><span class="grouping">)</span>
        <span class="comment"># TODO simplify to use MSE instead</span>
        <span class="keyword">return</span> <span class="identifier">loss</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_diff_x</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" X Difference """</span>
        <span class="identifier">x_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">x_inner</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">x_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">x_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x_left</span><span class="punctuation">,</span> <span class="identifier">x_inner</span><span class="punctuation">,</span> <span class="identifier">x_right</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">x_out</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_diff_y</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Y Difference """</span>
        <span class="identifier">y_top</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y_inner</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y_bot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y_top</span><span class="punctuation">,</span> <span class="identifier">y_inner</span><span class="punctuation">,</span> <span class="identifier">y_bot</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">y_out</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_diff_xx</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" X-X Difference """</span>
        <span class="identifier">x_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">x_inner</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">x_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">x_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x_left</span><span class="punctuation">,</span> <span class="identifier">x_inner</span><span class="punctuation">,</span> <span class="identifier">x_right</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">x_out</span> <span class="arithmetic-operator">-</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">img</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_diff_yy</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Y-Y Difference """</span>
        <span class="identifier">y_top</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y_inner</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y_bot</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">y_out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y_top</span><span class="punctuation">,</span> <span class="identifier">y_inner</span><span class="punctuation">,</span> <span class="identifier">y_bot</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">y_out</span> <span class="arithmetic-operator">-</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">img</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_diff_xy</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">img</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" X-Y Difference """</span>
        <span class="comment"># xout1</span>
        <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">inner_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">bot_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">xy_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">inner_left</span><span class="punctuation">,</span> <span class="identifier">bot_left</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">top_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">mid_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">bot_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">xy_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">top_mid</span><span class="punctuation">,</span> <span class="identifier">mid_mid</span><span class="punctuation">,</span> <span class="identifier">bot_mid</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">top_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">inner_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">bot_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">xy_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">top_right</span><span class="punctuation">,</span> <span class="identifier">inner_right</span><span class="punctuation">,</span> <span class="identifier">bot_right</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="comment"># Xout2</span>
        <span class="identifier">top_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">inner_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">bot_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">xy_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">top_left</span><span class="punctuation">,</span> <span class="identifier">inner_left</span><span class="punctuation">,</span> <span class="identifier">bot_left</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">top_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">mid_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">bot_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">xy_mid</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">top_mid</span><span class="punctuation">,</span> <span class="identifier">mid_mid</span><span class="punctuation">,</span> <span class="identifier">bot_mid</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">top_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">inner_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">bot_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">img</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>
        <span class="identifier">xy_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">top_right</span><span class="punctuation">,</span> <span class="identifier">inner_right</span><span class="punctuation">,</span> <span class="identifier">bot_right</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">xy_out1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">xy_left</span><span class="punctuation">,</span> <span class="identifier">xy_mid</span><span class="punctuation">,</span> <span class="identifier">xy_right</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">xy_out2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">xy_left</span><span class="punctuation">,</span> <span class="identifier">xy_mid</span><span class="punctuation">,</span> <span class="identifier">xy_right</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">(</span><span class="identifier">xy_out1</span> <span class="arithmetic-operator">-</span> <span class="identifier">xy_out2</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.25</span>


<span class="keyword">class</span> <span class="identifier">GMSDLoss</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">losses</span><span class="punctuation">.</span><span class="identifier">Loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Gradient Magnitude Similarity Deviation Loss.

    Improved image quality metric over MS-SSIM with easier calculations

    References
    ----------
    http://www4.comp.polyu.edu.hk/~cslzhang/IQA/GMSD/GMSD.htm
    https://arxiv.org/ftp/arxiv/papers/1308/1308.3052.pdf
    """</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Return the Gradient Magnitude Similarity Deviation Loss.


        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value

        Returns
        -------
        tensor
            The loss value
        """</span>
        <span class="identifier">true_edge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scharr_edges</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">pred_edge</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scharr_edges</span><span class="grouping">(</span><span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">ephsilon</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0025</span>
        <span class="identifier">upper</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">2.0</span> <span class="arithmetic-operator">*</span> <span class="identifier">true_edge</span> <span class="arithmetic-operator">*</span> <span class="identifier">pred_edge</span>
        <span class="identifier">lower</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">square</span><span class="grouping">(</span><span class="identifier">true_edge</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">square</span><span class="grouping">(</span><span class="identifier">pred_edge</span><span class="grouping">)</span>
        <span class="identifier">gms</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">upper</span> <span class="arithmetic-operator">+</span> <span class="identifier">ephsilon</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">lower</span> <span class="arithmetic-operator">+</span> <span class="identifier">ephsilon</span><span class="grouping">)</span>
        <span class="identifier">gmsd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">gms</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="identifier">gmsd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="identifier">gmsd</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">gmsd</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_scharr_edges</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">magnitude</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Returns a tensor holding modified Scharr edge maps.

        Parameters
        ----------
        image: tensor
            Image tensor with shape [batch_size, h, w, d] and type float32. The image(s) must be
            2x2 or larger.
        magnitude: bool
            Boolean to determine if the edge magnitude or edge direction is returned

        Returns
        -------
        tensor
            Tensor holding edge maps for each channel. Returns a tensor with shape `[batch_size, h,
            w, d, 2]` where the last two dimensions hold `[[dy[0], dx[0]], [dy[1], dx[1]], ...,
            [dy[d-1], dx[d-1]]]` calculated using the Scharr filter.
        """</span>

        <span class="comment"># Define vertical and horizontal Scharr filters.</span>
        <span class="identifier">static_image_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="punctuation">.</span><span class="identifier">get_shape</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">image_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">(</span><span class="identifier">image</span><span class="grouping">)</span>

        <span class="comment"># 5x5 modified Scharr kernel ( reshape to (5,5,1,2) )</span>
        <span class="identifier">matrix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00070</span><span class="punctuation">,</span> <span class="float-literal">0.00070</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00520</span><span class="punctuation">,</span> <span class="float-literal">0.00370</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.03700</span><span class="punctuation">,</span> <span class="float-literal">0.00000</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00520</span><span class="punctuation">,</span> <span class="float-literal">-0.0037</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00070</span><span class="punctuation">,</span> <span class="float-literal">-0.0007</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00370</span><span class="punctuation">,</span> <span class="float-literal">0.00520</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.11870</span><span class="punctuation">,</span> <span class="float-literal">0.11870</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.25890</span><span class="punctuation">,</span> <span class="float-literal">0.00000</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.11870</span><span class="punctuation">,</span> <span class="float-literal">-0.1187</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00370</span><span class="punctuation">,</span> <span class="float-literal">-0.0052</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00000</span><span class="punctuation">,</span> <span class="float-literal">0.03700</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00000</span><span class="punctuation">,</span> <span class="float-literal">0.25890</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00000</span><span class="punctuation">,</span> <span class="float-literal">0.00000</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00000</span><span class="punctuation">,</span> <span class="float-literal">-0.2589</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.00000</span><span class="punctuation">,</span> <span class="float-literal">-0.0370</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0037</span><span class="punctuation">,</span> <span class="float-literal">0.00520</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.1187</span><span class="punctuation">,</span> <span class="float-literal">0.11870</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.2589</span><span class="punctuation">,</span> <span class="float-literal">0.00000</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.1187</span><span class="punctuation">,</span> <span class="float-literal">-0.1187</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0037</span><span class="punctuation">,</span> <span class="float-literal">-0.0052</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0007</span><span class="punctuation">,</span> <span class="float-literal">0.00070</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0052</span><span class="punctuation">,</span> <span class="float-literal">0.00370</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0370</span><span class="punctuation">,</span> <span class="float-literal">0.00000</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0052</span><span class="punctuation">,</span> <span class="float-literal">-0.0037</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-0.0007</span><span class="punctuation">,</span> <span class="float-literal">-0.0007</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">num_kernels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="identifier">kernels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">constant</span><span class="grouping">(</span><span class="identifier">matrix</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">'float32'</span><span class="grouping">)</span>
        <span class="identifier">kernels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">tile</span><span class="grouping">(</span><span class="identifier">kernels</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">image_shape</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Use depth-wise convolution to calculate edge maps per channel.</span>
        <span class="comment"># Output tensor has shape [batch_size, h, w, d * num_kernels].</span>
        <span class="identifier">pad_sizes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">padded</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">pad</span><span class="grouping">(</span><span class="identifier">image</span><span class="punctuation">,</span> <span class="identifier">pad_sizes</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'REFLECT'</span><span class="grouping">)</span>
        <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">depthwise_conv2d</span><span class="grouping">(</span><span class="identifier">padded</span><span class="punctuation">,</span> <span class="identifier">kernels</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">magnitude</span><span class="punctuation">:</span>  <span class="comment"># direction of edges</span>
            <span class="comment"># Reshape to [batch_size, h, w, d, num_kernels].</span>
            <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">image_shape</span><span class="punctuation">,</span> <span class="identifier">num_kernels</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="identifier">output</span><span class="punctuation">,</span> <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">shape</span><span class="grouping">)</span>
            <span class="identifier">output</span><span class="punctuation">.</span><span class="identifier">set_shape</span><span class="grouping">(</span><span class="identifier">static_image_shape</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">num_kernels</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">atan</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="identifier">output</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">output</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># magnitude of edges -- unified x & y edges don't work well with Neural Networks</span>
        <span class="keyword">return</span> <span class="identifier">output</span>


<span class="keyword">class</span> <span class="identifier">LossWrapper</span><span class="grouping">(</span><span class="identifier">tf</span><span class="punctuation">.</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">losses</span><span class="punctuation">.</span><span class="identifier">Loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" A wrapper class for multiple keras losses to enable multiple weighted loss functions on a
    single output.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"LossWrapper"</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_functions</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_weights</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_channels</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">add_loss</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">function</span><span class="punctuation">,</span> <span class="identifier">weight</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Add the given loss function with the given weight to the loss function chain.

        Parameters
        ----------
        function: :class:`keras.losses.Loss`
            The loss function to add to the loss chain
        weight: float, optional
            The weighting to apply to the loss function. Default: `1.0`
        mask_channel: int, optional
            The channel in the `y_true` image that the mask exists in. Set to `-1` if there is no
            mask for the given loss function. Default: `-1`
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Adding loss: (function: %s, weight: %s, mask_channel: %s)"</span><span class="punctuation">,</span>
                     <span class="identifier">function</span><span class="punctuation">,</span> <span class="identifier">weight</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_functions</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">compile_utils</span><span class="punctuation">.</span><span class="identifier">LossesContainer</span><span class="grouping">(</span><span class="identifier">function</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_weights</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">weight</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_channels</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">mask_channel</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call the sub loss functions for the loss wrapper.

        Weights are returned as the weighted sum of the chosen losses.

        If a mask is being applied to the loss, then the appropriate mask is extracted from y_true
        and added as the 4th channel being passed to the penalized loss function.

        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value

        Returns
        -------
        tensor
            The final loss value
        """</span>
        <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
        <span class="keyword">for</span> <span class="identifier">func</span><span class="punctuation">,</span> <span class="identifier">weight</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_functions</span><span class="punctuation">,</span>
                                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_loss_weights</span><span class="punctuation">,</span>
                                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_mask_channels</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Processing loss function: (func: %s, weight: %s, mask_channel: %s)"</span><span class="punctuation">,</span>
                         <span class="identifier">func</span><span class="punctuation">,</span> <span class="identifier">weight</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="grouping">)</span>
            <span class="identifier">n_true</span><span class="punctuation">,</span> <span class="identifier">n_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_apply_mask</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="grouping">)</span>
            <span class="identifier">loss</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">(</span><span class="identifier">func</span><span class="grouping">(</span><span class="identifier">n_true</span><span class="punctuation">,</span> <span class="identifier">n_pred</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">weight</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">loss</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">_apply_mask</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="punctuation">,</span> <span class="identifier">mask_prop</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Apply the mask to the input y_true and y_pred. If a mask is not required then
        return the unmasked inputs.

        Parameters
        ----------
        y_true: tensor or variable
            The ground truth value
        y_pred: tensor or variable
            The predicted value
        mask_channel: int
            The channel within y_true that the required mask resides in
        mask_prop: float, optional
            The amount of mask propagation. Default: `1.0`

        Returns
        -------
        tuple
            (n_true, n_pred): The ground truth and predicted value tensors with the mask applied
        """</span>
        <span class="keyword">if</span> <span class="identifier">mask_channel</span> <span class="relational-operator">==</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"No mask to apply"</span><span class="grouping">)</span>
            <span class="keyword">return</span> <span class="identifier">y_true</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>

        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Applying mask from channel %s"</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="grouping">)</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">expand_dims</span><span class="grouping">(</span><span class="identifier">y_true</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="identifier">mask_channel</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">mask_as_k_inv_prop</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="arithmetic-operator">-</span> <span class="identifier">mask_prop</span>
        <span class="identifier">mask</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">mask</span> <span class="arithmetic-operator">*</span> <span class="identifier">mask_prop</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">mask_as_k_inv_prop</span>

        <span class="identifier">n_true</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y_true</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">:</span><span class="identifier">i</span><span class="arithmetic-operator">+</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">mask</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">n_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y_pred</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="punctuation">:</span><span class="identifier">i</span><span class="arithmetic-operator">+</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">mask</span> <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="identifier">n_true</span><span class="punctuation">,</span> <span class="identifier">n_pred</span>

    </pre>
  </body>
</html>