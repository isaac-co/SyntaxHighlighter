<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""GraphicalLasso: sparse inverse covariance estimation with an l1-penalized
estimator.
"""</span>

<span class="comment"># Author: Gael Varoquaux &lt;gael.varoquaux@normalesup.org&gt;</span>
<span class="comment"># License: BSD 3 clause</span>
<span class="comment"># Copyright: INRIA</span>
<span class="keyword">from</span> <span class="identifier">collections</span><span class="punctuation">.</span><span class="identifier">abc</span> <span class="keyword">import</span> <span class="identifier">Sequence</span>
<span class="keyword">import</span> <span class="identifier">warnings</span>
<span class="keyword">import</span> <span class="identifier">operator</span>
<span class="keyword">import</span> <span class="identifier">sys</span>
<span class="keyword">import</span> <span class="identifier">time</span>

<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">linalg</span>
<span class="keyword">from</span> <span class="identifier">joblib</span> <span class="keyword">import</span> <span class="identifier">Parallel</span>

<span class="keyword">from</span> <span class="punctuation">.</span> <span class="keyword">import</span> <span class="identifier">empirical_covariance</span><span class="punctuation">,</span> <span class="identifier">EmpiricalCovariance</span><span class="punctuation">,</span> <span class="identifier">log_likelihood</span>

<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">ConvergenceWarning</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">e</span><span class="invalid">d</span>
<span class="comment"># mypy error: Module 'sklearn.linear_model' has no attribute '_cd_fast'</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">_cd_fast</span> <span class="keyword">as</span> <span class="identifier">cd_fast</span>  <span class="comment"># type: ignore</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">lars_path_gram</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">check_cv</span><span class="punctuation">,</span> <span class="identifier">cross_val_score</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">deprecation</span> <span class="keyword">import</span> <span class="identifier">deprecated</span>


<span class="comment"># Helper functions to compute the objective and dual objective functions</span>
<span class="comment"># of the l1-penalized estimator</span>
<span class="keyword">def</span> <span class="identifier">_objective</span><span class="grouping">(</span><span class="identifier">mle</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Evaluation of the graphical-lasso objective function

    the objective function is made of a shifted scaled version of the
    normalized log-likelihood (i.e. its empirical mean over the samples) and a
    penalisation term to promote sparsity
    """</span>
    <span class="identifier">p</span> <span class="arithmetic-assignment">=</span> <span class="identifier">precision_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">cost</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">log_likelihood</span><span class="grouping">(</span><span class="identifier">mle</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">p</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="grouping">)</span>
    <span class="identifier">cost</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
                     <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">cost</span>


<span class="keyword">def</span> <span class="identifier">_dual_gap</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Expression of the dual gap convergence criterion

    The specific definition is given in Duchi "Projected Subgradient Methods
    for Learning Sparse Gaussians".
    """</span>
    <span class="identifier">gap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">emp_cov</span> <span class="arithmetic-operator">*</span> <span class="identifier">precision_</span><span class="grouping">)</span>
    <span class="identifier">gap</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">precision_</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">gap</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">alpha</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span>
                    <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diag</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">gap</span>


<span class="keyword">def</span> <span class="identifier">alpha_max</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Find the maximum alpha for which there are some non-zeros off-diagonal.

    Parameters
    ----------
    emp_cov : ndarray of shape (n_features, n_features)
        The sample covariance matrix.

    Notes
    -----
    This results from the bound for the all the Lasso that are solved
    in GraphicalLasso: each time, the row of cov corresponds to Xy. As the
    bound for alpha is given by `max(abs(Xy))`, the result follows.
    """</span>
    <span class="identifier">A</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="grouping">)</span>
    <span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">A</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">A</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment"># The g-lasso algorithm</span>
<span class="keyword">def</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">cov_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cd'</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span>
                    <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                    <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">eps</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span><span class="punctuation">,</span>
                    <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""l1-penalized covariance estimator

    Read more in the :ref:`User Guide &lt;sparse_inverse_covariance&gt;`.

    .. versionchanged:: v0.20
        graph_lasso has been renamed to graphical_lasso

    Parameters
    ----------
    emp_cov : ndarray of shape (n_features, n_features)
        Empirical covariance from which to compute the covariance estimate.

    alpha : float
        The regularization parameter: the higher alpha, the more
        regularization, the sparser the inverse covariance.
        Range is (0, inf].

    cov_init : array of shape (n_features, n_features), default=None
        The initial guess for the covariance. If None, then the empirical
        covariance is used.

    mode : {'cd', 'lars'}, default='cd'
        The Lasso solver to use: coordinate descent or LARS. Use LARS for
        very sparse underlying graphs, where p &gt; n. Elsewhere prefer cd
        which is more numerically stable.

    tol : float, default=1e-4
        The tolerance to declare convergence: if the dual gap goes below
        this value, iterations are stopped. Range is (0, inf].

    enet_tol : float, default=1e-4
        The tolerance for the elastic net solver used to calculate the descent
        direction. This parameter controls the accuracy of the search direction
        for a given column update, not of the overall parameter estimate. Only
        used for mode='cd'. Range is (0, inf].

    max_iter : int, default=100
        The maximum number of iterations.

    verbose : bool, default=False
        If verbose is True, the objective function and dual gap are
        printed at each iteration.

    return_costs : bool, default=Flase
        If return_costs is True, the objective function and dual gap
        at each iteration are returned.

    eps : float, default=eps
        The machine-precision regularization in the computation of the
        Cholesky diagonal factors. Increase this for very ill-conditioned
        systems. Default is `np.finfo(np.float64).eps`.

    return_n_iter : bool, default=False
        Whether or not to return the number of iterations.

    Returns
    -------
    covariance : ndarray of shape (n_features, n_features)
        The estimated covariance matrix.

    precision : ndarray of shape (n_features, n_features)
        The estimated (sparse) precision matrix.

    costs : list of (objective, dual_gap) pairs
        The list of values of the objective function and the dual gap at
        each iteration. Returned only if return_costs is True.

    n_iter : int
        Number of iterations. Returned only if `return_n_iter` is set to True.

    See Also
    --------
    GraphicalLasso, GraphicalLassoCV

    Notes
    -----
    The algorithm employed to solve this problem is the GLasso algorithm,
    from the Friedman 2008 Biostatistics paper. It is the same algorithm
    as in the R `glasso` package.

    One possible difference with the `glasso` R package is that the
    diagonal coefficients are not penalized.
    """</span>
    <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="identifier">emp_cov</span><span class="punctuation">.</span><span class="identifier">shape</span>
    <span class="keyword">if</span> <span class="identifier">alpha</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">:</span>
            <span class="identifier">precision_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="grouping">)</span>
            <span class="identifier">cost</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span> <span class="int-literal">2</span><span class="punctuation">.</span> <span class="arithmetic-operator">*</span> <span class="identifier">log_likelihood</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="grouping">)</span>
            <span class="identifier">cost</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span><span class="grouping">)</span>
            <span class="identifier">d_gap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">emp_cov</span> <span class="arithmetic-operator">*</span> <span class="identifier">precision_</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">n_features</span>
            <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">cost</span><span class="punctuation">,</span> <span class="identifier">d_gap</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">cost</span><span class="punctuation">,</span> <span class="identifier">d_gap</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">0</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="keyword">return</span> <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">inv</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">cov_init</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">emp_cov</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cov_init</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># As a trivial regularization (Tikhonov like), we scale down the</span>
    <span class="comment"># off-diagonal coefficients of our starting point: This is needed, as</span>
    <span class="comment"># in the cross-validation the cov_init can easily be</span>
    <span class="comment"># ill-conditioned, and the CV loop blows. Beside, this takes</span>
    <span class="comment"># conservative stand-point on the initial conditions, and it tends to</span>
    <span class="comment"># make the convergence go faster.</span>
    <span class="identifier">covariance_</span> <span class="arithmetic-assignment">*=</span> <span class="float-literal">0.95</span>
    <span class="identifier">diagonal</span> <span class="arithmetic-assignment">=</span> <span class="identifier">emp_cov</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">covariance_</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="identifier">n_features</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diagonal</span>
    <span class="identifier">precision_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linalg</span><span class="punctuation">.</span><span class="identifier">pinvh</span><span class="grouping">(</span><span class="identifier">covariance_</span><span class="grouping">)</span>

    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">costs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="comment"># The different l1 regression solver have different numerical errors</span>
    <span class="keyword">if</span> <span class="identifier">mode</span> <span class="relational-operator">==</span> <span class="string-literal">'cd'</span><span class="punctuation">:</span>
        <span class="identifier">errors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">over</span><span class="arithmetic-assignment">=</span><span class="string-literal">'raise', invalid='ignore'</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">errors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">invalid</span><span class="arithmetic-assignment">=</span><span class="string-literal">'raise'</span><span class="grouping">)</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="comment"># be robust to the max_iter=0 edge case, see:</span>
        <span class="comment"># https://github.com/scikit-learn/scikit-learn/issues/4134</span>
        <span class="identifier">d_gap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
        <span class="comment"># set a sub_covariance buffer</span>
        <span class="identifier">sub_covariance</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="identifier">covariance_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">'C'</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">max_iter</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># To keep the contiguous matrix `sub_covariance` equal to</span>
                <span class="comment"># covariance_[indices != idx].T[indices != idx]</span>
                <span class="comment"># we only need to update 1 column and 1 line when idx changes</span>
                <span class="keyword">if</span> <span class="identifier">idx</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                    <span class="identifier">di</span> <span class="arithmetic-assignment">=</span> <span class="identifier">idx</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
                    <span class="identifier">sub_covariance</span><span class="grouping">[</span><span class="identifier">di</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covariance_</span><span class="grouping">[</span><span class="identifier">di</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="grouping">]</span>
                    <span class="identifier">sub_covariance</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">di</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covariance_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">di</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="grouping">]</span>
                <span class="keyword">else</span><span class="punctuation">:</span>
                    <span class="identifier">sub_covariance</span><span class="grouping">[</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">covariance_</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
                <span class="identifier">row</span> <span class="arithmetic-assignment">=</span> <span class="identifier">emp_cov</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="grouping">]</span>
                <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">errors</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="keyword">if</span> <span class="identifier">mode</span> <span class="relational-operator">==</span> <span class="string-literal">'cd'</span><span class="punctuation">:</span>
                        <span class="comment"># Use coordinate descent</span>
                        <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
                                  <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1000</span> <span class="arithmetic-operator">*</span> <span class="identifier">eps</span><span class="grouping">)</span><span class="grouping">)</span>
                        <span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cd_fast</span><span class="punctuation">.</span><span class="identifier">enet_coordinate_descent_gram</span><span class="grouping">(</span>
                            <span class="identifier">coefs</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">sub_covariance</span><span class="punctuation">,</span>
                            <span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">enet_tol</span><span class="punctuation">,</span>
                            <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span>
                    <span class="keyword">else</span><span class="punctuation">:</span>
                        <span class="comment"># Use LARS</span>
                        <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">lars_path_gram</span><span class="grouping">(</span>
                            <span class="identifier">Xy</span><span class="arithmetic-assignment">=</span><span class="identifier">row</span><span class="punctuation">,</span> <span class="identifier">Gram</span><span class="arithmetic-assignment">=</span><span class="identifier">sub_covariance</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">row</span><span class="punctuation">.</span><span class="identifier">size</span><span class="punctuation">,</span>
                            <span class="identifier">alpha_min</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">n_features</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">copy_Gram</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                            <span class="identifier">eps</span><span class="arithmetic-assignment">=</span><span class="identifier">eps</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="arithmetic-assignment">=</span><span class="string-literal">'lars'</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">h</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>
                <span class="comment"># Update the precision matrix</span>
                <span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                    <span class="int-literal">1</span><span class="punctuation">.</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">covariance_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
                          <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">covariance_</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">coefs</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span> <span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
                                                   <span class="arithmetic-operator">*</span> <span class="identifier">coefs</span><span class="grouping">)</span>
                <span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="arithmetic-operator">-</span> <span class="identifier">precision_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span>
                                                   <span class="arithmetic-operator">*</span> <span class="identifier">coefs</span><span class="grouping">)</span>
                <span class="identifier">coefs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">sub_covariance</span><span class="punctuation">,</span> <span class="identifier">coefs</span><span class="grouping">)</span>
                <span class="identifier">covariance_</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coefs</span>
                <span class="identifier">covariance_</span><span class="grouping">[</span><span class="identifier">indices</span> <span class="relational-operator">!=</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">coefs</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">FloatingPointError</span><span class="grouping">(</span><span class="string-literal">'The system is too ill-conditioned '</span>
                                         <span class="string-literal">'for this solver'</span><span class="grouping">)</span>
            <span class="identifier">d_gap</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_dual_gap</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>
            <span class="identifier">cost</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_objective</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">verbose</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[graphical_lasso] Iteration '</span>
                      <span class="string-literal">'% 3i, cost % 3.2e, dual gap %.3e'</span>
                      <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">cost</span><span class="punctuation">,</span> <span class="identifier">d_gap</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">:</span>
                <span class="identifier">costs</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">cost</span><span class="punctuation">,</span> <span class="identifier">d_gap</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">d_gap</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol</span><span class="punctuation">:</span>
                <span class="keyword">break</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">cost</span><span class="grouping">)</span> <span class="logical-operator">and</span> <span class="identifier">i</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">FloatingPointError</span><span class="grouping">(</span><span class="string-literal">'Non SPD result: the system is '</span>
                                         <span class="string-literal">'too ill-conditioned for this solver'</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">warn</span><span class="grouping">(</span><span class="string-literal">'graphical_lasso: did not converge after '</span>
                          <span class="string-literal">'%i iteration: dual gap: %.3e'</span>
                          <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">d_gap</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">FloatingPointError</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
        <span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">args</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">e</span><span class="punctuation">.</span><span class="identifier">args</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
                  <span class="arithmetic-operator">+</span> <span class="string-literal">'. The system is too ill-conditioned for this solver'</span><span class="punctuation">,</span><span class="grouping">)</span>
        <span class="keyword">raise</span> <span class="identifier">e</span>

    <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">s</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">costs</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">costs</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="keyword">return</span> <span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">precision_</span>


<span class="keyword">class</span> <span class="identifier">GraphicalLasso</span><span class="grouping">(</span><span class="identifier">EmpiricalCovariance</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Sparse inverse covariance estimation with an l1-penalized estimator.

    Read more in the :ref:`User Guide &lt;sparse_inverse_covariance&gt;`.

    .. versionchanged:: v0.20
        GraphLasso has been renamed to GraphicalLasso

    Parameters
    ----------
    alpha : float, default=0.01
        The regularization parameter: the higher alpha, the more
        regularization, the sparser the inverse covariance.
        Range is (0, inf].

    mode : {'cd', 'lars'}, default='cd'
        The Lasso solver to use: coordinate descent or LARS. Use LARS for
        very sparse underlying graphs, where p &gt; n. Elsewhere prefer cd
        which is more numerically stable.

    tol : float, default=1e-4
        The tolerance to declare convergence: if the dual gap goes below
        this value, iterations are stopped. Range is (0, inf].

    enet_tol : float, default=1e-4
        The tolerance for the elastic net solver used to calculate the descent
        direction. This parameter controls the accuracy of the search direction
        for a given column update, not of the overall parameter estimate. Only
        used for mode='cd'. Range is (0, inf].

    max_iter : int, default=100
        The maximum number of iterations.

    verbose : bool, default=False
        If verbose is True, the objective function and dual gap are
        plotted at each iteration.

    assume_centered : bool, default=False
        If True, data are not centered before computation.
        Useful when working with data whose mean is almost, but not exactly
        zero.
        If False, data are centered before computation.

    Attributes
    ----------
    location_ : ndarray of shape (n_features,)
        Estimated location, i.e. the estimated mean.

    covariance_ : ndarray of shape (n_features, n_features)
        Estimated covariance matrix

    precision_ : ndarray of shape (n_features, n_features)
        Estimated pseudo inverse matrix.

    n_iter_ : int
        Number of iterations run.

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.covariance import GraphicalLasso
    &gt;&gt;&gt; true_cov = np.array([[0.8, 0.0, 0.2, 0.0],
    ...                      [0.0, 0.4, 0.0, 0.0],
    ...                      [0.2, 0.0, 0.3, 0.1],
    ...                      [0.0, 0.0, 0.1, 0.7]])
    &gt;&gt;&gt; np.random.seed(0)
    &gt;&gt;&gt; X = np.random.multivariate_normal(mean=[0, 0, 0, 0],
    ...                                   cov=true_cov,
    ...                                   size=200)
    &gt;&gt;&gt; cov = GraphicalLasso().fit(X)
    &gt;&gt;&gt; np.around(cov.covariance_, decimals=3)
    array([[0.816, 0.049, 0.218, 0.019],
           [0.049, 0.364, 0.017, 0.034],
           [0.218, 0.017, 0.322, 0.093],
           [0.019, 0.034, 0.093, 0.69 ]])
    &gt;&gt;&gt; np.around(cov.location_, decimals=3)
    array([0.073, 0.04 , 0.038, 0.143])

    See Also
    --------
    graphical_lasso, GraphicalLassoCV
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">.01</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cd'</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span>
                 <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mode</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">enet_tol</span> <span class="arithmetic-assignment">=</span> <span class="identifier">enet_tol</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max_iter</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">verbose</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fits the GraphicalLasso model to X.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Data from which to compute the covariance estimate

        y : Ignored
            Not used, present for API consistency by convention.

        Returns
        -------
        self : object
        """</span>
        <span class="comment"># Covariance does not make sense for a single feature</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ensure_min_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">ensure_min_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span>
                                <span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">location_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">location_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span>
            <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
            <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">enet_tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>


<span class="comment"># Cross-validation with GraphicalLasso</span>
<span class="keyword">def</span> <span class="identifier">graphical_lasso_path</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">cov_init</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cd'</span><span class="punctuation">,</span>
                         <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""l1-penalized covariance estimator along a path of decreasing alphas

    Read more in the :ref:`User Guide &lt;sparse_inverse_covariance&gt;`.

    Parameters
    ----------
    X : ndarray of shape (n_samples, n_features)
        Data from which to compute the covariance estimate.

    alphas : array-like of shape (n_alphas,)
        The list of regularization parameters, decreasing order.

    cov_init : array of shape (n_features, n_features), default=None
        The initial guess for the covariance.

    X_test : array of shape (n_test_samples, n_features), default=None
        Optional test matrix to measure generalisation error.

    mode : {'cd', 'lars'}, default='cd'
        The Lasso solver to use: coordinate descent or LARS. Use LARS for
        very sparse underlying graphs, where p &gt; n. Elsewhere prefer cd
        which is more numerically stable.

    tol : float, default=1e-4
        The tolerance to declare convergence: if the dual gap goes below
        this value, iterations are stopped. The tolerance must be a positive
        number.

    enet_tol : float, default=1e-4
        The tolerance for the elastic net solver used to calculate the descent
        direction. This parameter controls the accuracy of the search direction
        for a given column update, not of the overall parameter estimate. Only
        used for mode='cd'. The tolerance must be a positive number.

    max_iter : int, default=100
        The maximum number of iterations. This parameter should be a strictly
        positive integer.

    verbose : int or bool, default=False
        The higher the verbosity flag, the more information is printed
        during the fitting.

    Returns
    -------
    covariances_ : list of shape (n_alphas,) of ndarray of shape \
            (n_features, n_features)
        The estimated covariance matrices.

    precisions_ : list of shape (n_alphas,) of ndarray of shape \
            (n_features, n_features)
        The estimated (sparse) precision matrices.

    scores_ : list of shape (n_alphas,), dtype=float
        The generalisation error (log-likelihood) on the test data.
        Returned only if test data is passed.
    """</span>
    <span class="identifier">inner_verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">verbose</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">cov_init</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">emp_cov</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">covariance_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cov_init</span>
    <span class="identifier">covariances_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">precisions_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">scores_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">X_test</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="identifier">test_emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span><span class="identifier">X_test</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">alpha</span> <span class="relational-operator">in</span> <span class="identifier">alphas</span><span class="punctuation">:</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="comment"># Capture the errors, and move on</span>
            <span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">precision_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span>
                <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">cov_init</span><span class="arithmetic-assignment">=</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span>
                <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">enet_tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">inner_verbose</span><span class="grouping">)</span>
            <span class="identifier">covariances_</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">covariance_</span><span class="grouping">)</span>
            <span class="identifier">precisions_</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">precision_</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">X_test</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">this_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">log_likelihood</span><span class="grouping">(</span><span class="identifier">test_emp_cov</span><span class="punctuation">,</span> <span class="identifier">precision_</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="identifier">FloatingPointError</span><span class="punctuation">:</span>
            <span class="identifier">this_score</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
            <span class="identifier">covariances_</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span>
            <span class="identifier">precisions_</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">X_test</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">this_score</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">this_score</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
            <span class="identifier">scores_</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">this_score</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">verbose</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="identifier">sys</span><span class="punctuation">.</span><span class="identifier">stderr</span><span class="punctuation">.</span><span class="identifier">write</span><span class="grouping">(</span><span class="string-literal">'.'</span><span class="grouping">)</span>
        <span class="keyword">elif</span> <span class="identifier">verbose</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">X_test</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[graphical_lasso_path] alpha: %.2e, score: %.2e'</span>
                      <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">this_score</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[graphical_lasso_path] alpha: %.2e'</span> <span class="arithmetic-operator">%</span> <span class="identifier">alpha</span><span class="grouping">)</span>
    <span class="keyword">if</span> <span class="identifier">X_test</span> <span class="relational-operator">is</span> <span class="logical-operator">not</span> <span class="none-literal">None</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">covariances_</span><span class="punctuation">,</span> <span class="identifier">precisions_</span><span class="punctuation">,</span> <span class="identifier">scores_</span>
    <span class="keyword">return</span> <span class="identifier">covariances_</span><span class="punctuation">,</span> <span class="identifier">precisions_</span>


<span class="keyword">class</span> <span class="identifier">GraphicalLassoCV</span><span class="grouping">(</span><span class="identifier">GraphicalLasso</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Sparse inverse covariance w/ cross-validated choice of the l1 penalty.

    See glossary entry for :term:`cross-validation estimator`.

    Read more in the :ref:`User Guide &lt;sparse_inverse_covariance&gt;`.

    .. versionchanged:: v0.20
        GraphLassoCV has been renamed to GraphicalLassoCV

    Parameters
    ----------
    alphas : int or array-like of shape (n_alphas,), dtype=float, default=4
        If an integer is given, it fixes the number of points on the
        grids of alpha to be used. If a list is given, it gives the
        grid to be used. See the notes in the class docstring for
        more details. Range is (0, inf] when floats given.

    n_refinements : int, default=4
        The number of times the grid is refined. Not used if explicit
        values of alphas are passed. Range is [1, inf).

    cv : int, cross-validation generator or iterable, default=None
        Determines the cross-validation splitting strategy.
        Possible inputs for cv are:

        - None, to use the default 5-fold cross-validation,
        - integer, to specify the number of folds.
        - :term:`CV splitter`,
        - An iterable yielding (train, test) splits as arrays of indices.

        For integer/None inputs :class:`KFold` is used.

        Refer :ref:`User Guide &lt;cross_validation&gt;` for the various
        cross-validation strategies that can be used here.

        .. versionchanged:: 0.20
            ``cv`` default value if None changed from 3-fold to 5-fold.

    tol : float, default=1e-4
        The tolerance to declare convergence: if the dual gap goes below
        this value, iterations are stopped. Range is (0, inf].

    enet_tol : float, default=1e-4
        The tolerance for the elastic net solver used to calculate the descent
        direction. This parameter controls the accuracy of the search direction
        for a given column update, not of the overall parameter estimate. Only
        used for mode='cd'. Range is (0, inf].

    max_iter : int, default=100
        Maximum number of iterations.

    mode : {'cd', 'lars'}, default='cd'
        The Lasso solver to use: coordinate descent or LARS. Use LARS for
        very sparse underlying graphs, where number of features is greater
        than number of samples. Elsewhere prefer cd which is more numerically
        stable.

    n_jobs : int, default=None
        number of jobs to run in parallel.
        ``None`` means 1 unless in a :obj:`joblib.parallel_backend` context.
        ``-1`` means using all processors. See :term:`Glossary &lt;n_jobs&gt;`
        for more details.

        .. versionchanged:: v0.20
           `n_jobs` default changed from 1 to None

    verbose : bool, default=False
        If verbose is True, the objective function and duality gap are
        printed at each iteration.

    assume_centered : bool, default=False
        If True, data are not centered before computation.
        Useful when working with data whose mean is almost, but not exactly
        zero.
        If False, data are centered before computation.

    Attributes
    ----------
    location_ : ndarray of shape (n_features,)
        Estimated location, i.e. the estimated mean.

    covariance_ : ndarray of shape (n_features, n_features)
        Estimated covariance matrix.

    precision_ : ndarray of shape (n_features, n_features)
        Estimated precision matrix (inverse covariance).

    alpha_ : float
        Penalization parameter selected.

    cv_alphas_ : list of shape (n_alphas,), dtype=float
        All penalization parameters explored.

        .. deprecated:: 0.24
            The `cv_alphas_` attribute is deprecated in version 0.24 in favor
            of `cv_results_['alphas']` and will be removed in version
            1.1 (renaming of 0.26).

    grid_scores_ : ndarray of shape (n_alphas, n_folds)
        Log-likelihood score on left-out data across folds.

        .. deprecated:: 0.24
            The `grid_scores_` attribute is deprecated in version 0.24 in favor
            of `cv_results_` and will be removed in version
            1.1 (renaming of 0.26).

    cv_results_ : dict of ndarrays
        A dict with keys:

        alphas : ndarray of shape (n_alphas,)
            All penalization parameters explored.

        split(k)_score : ndarray of shape (n_alphas,)
            Log-likelihood score on left-out data across (k)th fold.

        mean_score : ndarray of shape (n_alphas,)
            Mean of scores over the folds.

        std_score : ndarray of shape (n_alphas,)
            Standard deviation of scores over the folds.

        .. versionadded:: 0.24

    n_iter_ : int
        Number of iterations run for the optimal alpha.

    Examples
    --------
    &gt;&gt;&gt; import numpy as np
    &gt;&gt;&gt; from sklearn.covariance import GraphicalLassoCV
    &gt;&gt;&gt; true_cov = np.array([[0.8, 0.0, 0.2, 0.0],
    ...                      [0.0, 0.4, 0.0, 0.0],
    ...                      [0.2, 0.0, 0.3, 0.1],
    ...                      [0.0, 0.0, 0.1, 0.7]])
    &gt;&gt;&gt; np.random.seed(0)
    &gt;&gt;&gt; X = np.random.multivariate_normal(mean=[0, 0, 0, 0],
    ...                                   cov=true_cov,
    ...                                   size=200)
    &gt;&gt;&gt; cov = GraphicalLassoCV().fit(X)
    &gt;&gt;&gt; np.around(cov.covariance_, decimals=3)
    array([[0.816, 0.051, 0.22 , 0.017],
           [0.051, 0.364, 0.018, 0.036],
           [0.22 , 0.018, 0.322, 0.094],
           [0.017, 0.036, 0.094, 0.69 ]])
    &gt;&gt;&gt; np.around(cov.location_, decimals=3)
    array([0.073, 0.04 , 0.038, 0.143])

    See Also
    --------
    graphical_lasso, GraphicalLasso

    Notes
    -----
    The search for the optimal penalization parameter (alpha) is done on an
    iteratively refined grid: first the cross-validated scores on a grid are
    computed, then a new refined grid is centered around the maximum, and so
    on.

    One of the challenges which is faced here is that the solvers can
    fail to converge to a well-conditioned estimate. The corresponding
    values of alpha then come out as missing values, but the optimum may
    be close to these missing values.
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">*</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">n_refinements</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span>
                 <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-4</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="string-literal">'cd'</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span>
                 <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span>
            <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">mode</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">tol</span><span class="punctuation">,</span> <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">verbose</span><span class="punctuation">,</span> <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">enet_tol</span><span class="punctuation">,</span>
            <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">max_iter</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alphas</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_refinements</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_refinements</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_jobs</span>

    <span class="keyword">def</span> <span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Fits the GraphicalLasso covariance model to X.

        Parameters
        ----------
        X : array-like of shape (n_samples, n_features)
            Data from which to compute the covariance estimate

        y : Ignored
            Not used, present for API consistency by convention.

        Returns
        -------
        self : object
        """</span>
        <span class="comment"># Covariance does not make sense for a single feature</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_validate_data</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">ensure_min_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">estimator</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">location_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">location_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">emp_cov</span> <span class="arithmetic-assignment">=</span> <span class="identifier">empirical_covariance</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">)</span>

        <span class="identifier">cv</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_cv</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

        <span class="comment"># List of (alpha, scores, covs)</span>
        <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">n_alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alphas</span>
        <span class="identifier">inner_verbose</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">n_alphas</span><span class="punctuation">,</span> <span class="identifier">Sequence</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alphas</span>
            <span class="identifier">n_refinements</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">n_refinements</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_refinements</span>
            <span class="identifier">alpha_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alpha_max</span><span class="grouping">(</span><span class="identifier">emp_cov</span><span class="grouping">)</span>
            <span class="identifier">alpha_0</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">1e-2</span> <span class="arithmetic-operator">*</span> <span class="identifier">alpha_1</span>
            <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log10</span><span class="grouping">(</span><span class="identifier">alpha_0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log10</span><span class="grouping">(</span><span class="identifier">alpha_1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">n_alphas</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="identifier">t0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_refinements</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">catch_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># No need to see the convergence warnings on this grid:</span>
                <span class="comment"># they will always be points that will not converge</span>
                <span class="comment"># during the cross-validation</span>
                <span class="identifier">warnings</span><span class="punctuation">.</span><span class="identifier">simplefilter</span><span class="grouping">(</span><span class="string-literal">'ignore'</span><span class="punctuation">,</span> <span class="identifier">ConvergenceWarning</span><span class="grouping">)</span>
                <span class="comment"># Compute the cross-validated loss on the current grid</span>

                <span class="comment"># NOTE: Warm-restarting graphical_lasso_path has been tried,</span>
                <span class="comment"># and this did not allow to gain anything</span>
                <span class="comment"># (same execution time with or without).</span>
                <span class="identifier">this_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Parallel</span><span class="grouping">(</span>
                    <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span>
                    <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span>
                <span class="grouping">)</span><span class="grouping">(</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">e</span><span class="invalid">d</span><span class="grouping">(</span><span class="identifier">graphical_lasso_path</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">train</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">alphas</span><span class="arithmetic-assignment">=</span><span class="identifier">alphas</span><span class="punctuation">,</span>
                                                <span class="identifier">X_test</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">test</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span><span class="punctuation">,</span>
                                                <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
                                                <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">enet_tol</span><span class="punctuation">,</span>
                                                <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">.1</span> <span class="arithmetic-operator">*</span>
                                                             <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">inner_verbose</span><span class="grouping">)</span>
                  <span class="keyword">for</span> <span class="identifier">train</span><span class="punctuation">,</span> <span class="identifier">test</span> <span class="relational-operator">in</span> <span class="identifier">cv</span><span class="punctuation">.</span><span class="identifier">split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>

            <span class="comment"># Little danse to transform the list in what we need</span>
            <span class="identifier">covs</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">this_path</span><span class="grouping">)</span>
            <span class="identifier">covs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">covs</span><span class="grouping">)</span>
            <span class="identifier">scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">scores</span><span class="grouping">)</span>
            <span class="identifier">path</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="punctuation">,</span> <span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">covs</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">path</span><span class="punctuation">,</span> <span class="identifier">key</span><span class="arithmetic-assignment">=</span><span class="identifier">operator</span><span class="punctuation">.</span><span class="identifier">itemgetter</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">reverse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>

            <span class="comment"># Find the maximum (avoid using built in 'max' function to</span>
            <span class="comment"># have a fully-reproducible selection of the smallest alpha</span>
            <span class="comment"># in case of equality)</span>
            <span class="identifier">best_score</span> <span class="arithmetic-assignment">=</span> <span class="arithmetic-operator">-</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">inf</span>
            <span class="identifier">last_finite_idx</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="keyword">for</span> <span class="identifier">index</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">alpha</span><span class="punctuation">,</span> <span class="identifier">scores</span><span class="punctuation">,</span> <span class="identifier">_</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">path</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">this_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">scores</span><span class="grouping">)</span>
                <span class="keyword">if</span> <span class="identifier">this_score</span> <span class="relational-operator">&gt;=</span> <span class="float-literal">.1</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">finfo</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">eps</span><span class="punctuation">:</span>
                    <span class="identifier">this_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan</span>
                <span class="keyword">if</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">this_score</span><span class="grouping">)</span><span class="punctuation">:</span>
                    <span class="identifier">last_finite_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">index</span>
                <span class="keyword">if</span> <span class="identifier">this_score</span> <span class="relational-operator">&gt;=</span> <span class="identifier">best_score</span><span class="punctuation">:</span>
                    <span class="identifier">best_score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">this_score</span>
                    <span class="identifier">best_index</span> <span class="arithmetic-assignment">=</span> <span class="identifier">index</span>

            <span class="comment"># Refine the grid</span>
            <span class="keyword">if</span> <span class="identifier">best_index</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="comment"># We do not need to go back: we have chosen</span>
                <span class="comment"># the highest value of alpha for which there are</span>
                <span class="comment"># non-zero coefficients</span>
                <span class="identifier">alpha_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
                <span class="identifier">alpha_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">elif</span> <span class="grouping">(</span><span class="identifier">best_index</span> <span class="relational-operator">==</span> <span class="identifier">last_finite_idx</span>
                    <span class="logical-operator">and</span> <span class="logical-operator">not</span> <span class="identifier">best_index</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">path</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># We have non-converged models on the upper bound of the</span>
                <span class="comment"># grid, we need to refine the grid there</span>
                <span class="identifier">alpha_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="identifier">best_index</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
                <span class="identifier">alpha_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="identifier">best_index</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">elif</span> <span class="identifier">best_index</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">path</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">alpha_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="identifier">best_index</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
                <span class="identifier">alpha_0</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.01</span> <span class="arithmetic-operator">*</span> <span class="identifier">path</span><span class="grouping">[</span><span class="identifier">best_index</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">alpha_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="identifier">best_index</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
                <span class="identifier">alpha_0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">path</span><span class="grouping">[</span><span class="identifier">best_index</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">n_alphas</span><span class="punctuation">,</span> <span class="identifier">Sequence</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logspace</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log10</span><span class="grouping">(</span><span class="identifier">alpha_1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log10</span><span class="grouping">(</span><span class="identifier">alpha_0</span><span class="grouping">)</span><span class="punctuation">,</span>
                                     <span class="identifier">n_alphas</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">)</span>
                <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alphas</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

            <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">verbose</span> <span class="logical-operator">and</span> <span class="identifier">n_refinements</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span><span class="punctuation">:</span>
                <span class="identifier">print</span><span class="grouping">(</span><span class="string-literal">'[GraphicalLassoCV] Done refinement % 2i out of'</span>
                      <span class="string-literal">' %i: % 3is'</span> <span class="arithmetic-operator">%</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">n_refinements</span><span class="punctuation">,</span> <span class="identifier">time</span><span class="punctuation">.</span><span class="identifier">time</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">t0</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">path</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">grid_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">path</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="comment"># Finally, compute the score with alpha = 0</span>
        <span class="identifier">alphas</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">grid_scores</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">cross_val_score</span><span class="grouping">(</span><span class="identifier">EmpiricalCovariance</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span>
                                           <span class="identifier">cv</span><span class="arithmetic-assignment">=</span><span class="identifier">cv</span><span class="punctuation">,</span> <span class="identifier">n_jobs</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_jobs</span><span class="punctuation">,</span>
                                           <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">inner_verbose</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">grid_scores</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">grid_scores</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">'alphas'</span><span class="punctuation">:</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">alphas</span><span class="grouping">)</span><span class="grouping">}</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">grid_scores</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">key</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"split{}_score"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="identifier">key</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">grid_scores</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">]</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">"mean_score"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">grid_scores</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">"std_score"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">std</span><span class="grouping">(</span><span class="identifier">grid_scores</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>

        <span class="identifier">best_alpha</span> <span class="arithmetic-assignment">=</span> <span class="identifier">alphas</span><span class="grouping">[</span><span class="identifier">best_index</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">alpha_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">best_alpha</span>

        <span class="comment"># Finally fit the model with the selected alpha</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">covariance_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">precision_</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">n_iter_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">graphical_lasso</span><span class="grouping">(</span>
            <span class="identifier">emp_cov</span><span class="punctuation">,</span> <span class="identifier">alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">best_alpha</span><span class="punctuation">,</span> <span class="identifier">mode</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">mode</span><span class="punctuation">,</span> <span class="identifier">tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">tol</span><span class="punctuation">,</span>
            <span class="identifier">enet_tol</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">enet_tol</span><span class="punctuation">,</span> <span class="identifier">max_iter</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">max_iter</span><span class="punctuation">,</span>
            <span class="identifier">verbose</span><span class="arithmetic-assignment">=</span><span class="identifier">inner_verbose</span><span class="punctuation">,</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">r</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">self</span>

    <span class="comment"># TODO: Remove in 1.1 when grid_scores_ is deprecated</span>
    <span class="comment"># mypy error: Decorated property not supported</span>
    <span class="punctuation">@</span><span class="identifier">deprecated</span><span class="grouping">(</span>  <span class="comment"># type: ignore</span>
        <span class="string-literal">"The grid_scores_ attribute is deprecated in version 0.24 in favor "</span>
        <span class="string-literal">"of cv_results_ and will be removed in version 1.1 (renaming of 0.26)."</span>
    <span class="grouping">)</span>
    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">grid_scores_</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># remove 3 for mean_score, std_score, and alphas</span>
        <span class="identifier">n_alphas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">3</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span>
            <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">"split{}_score"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">i</span><span class="grouping">)</span><span class="grouping">]</span>
             <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_alphas</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># TODO: Remove in 1.1 when cv_alphas_ is deprecated</span>
    <span class="comment"># mypy error: Decorated property not supported</span>
    <span class="punctuation">@</span><span class="identifier">deprecated</span><span class="grouping">(</span>  <span class="comment"># type: ignore</span>
        <span class="string-literal">"The cv_alphas_ attribute is deprecated in version 0.24 in favor "</span>
        <span class="string-literal">"of cv_results_['alpha'] and will be removed in version 1.1 "</span>
        <span class="string-literal">"(renaming of 0.26)."</span>
    <span class="grouping">)</span>
    <span class="punctuation">@</span><span class="identifier">property</span>
    <span class="keyword">def</span> <span class="identifier">cv_alphas_</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">cv_results_</span><span class="grouping">[</span><span class="string-literal">'alphas'</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>

    </pre>
  </body>
</html>