<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">from</span> <span class="identifier">scipy</span> <span class="keyword">import</span> <span class="identifier">sparse</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">random</span> <span class="keyword">as</span> <span class="identifier">sparse_random</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>

<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="punctuation">,</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">interpolate</span> <span class="keyword">import</span> <span class="identifier">BSpline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">linear_model</span> <span class="keyword">import</span> <span class="identifier">LinearRegression</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">pipeline</span> <span class="keyword">import</span> <span class="identifier">Pipeline</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">preprocessing</span> <span class="keyword">import</span> <span class="grouping">(</span>
    <span class="identifier">KBinsDiscretizer</span><span class="punctuation">,</span> <span class="identifier">PolynomialFeatures</span><span class="punctuation">,</span> <span class="identifier">SplineTransformer</span>
<span class="grouping">)</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">fixes</span> <span class="keyword">import</span> <span class="identifier">linspace</span><span class="punctuation">,</span> <span class="identifier">sp_version</span><span class="punctuation">,</span> <span class="identifier">parse_version</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"est"</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">PolynomialFeatures</span><span class="punctuation">,</span> <span class="identifier">SplineTransformer</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_and_spline_array_order</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that output array has the given order."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">is_c_contiguous</span><span class="grouping">(</span><span class="identifier">a</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfortran</span><span class="grouping">(</span><span class="identifier">a</span><span class="punctuation">.</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">is_c_contiguous</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">is_c_contiguous</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfortran</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">(</span><span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"F"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"params, err_msg"</span><span class="punctuation">,</span>
    <span class="grouping">[</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"degree": -1}, "degree must be a non-negative integer."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"degree": 2.5}, "degree must be a non-negative integer."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"degree": "string"}, "degree must be a non-negative integer."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"n_knots": 1}, "n_knots must be a positive integer &gt;= 2."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"n_knots": 1}, "n_knots must be a positive integer &gt;= 2."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"n_knots": 2.5}, "n_knots must be a positive integer &gt;= 2."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"n_knots": "string"}, "n_knots must be a positive integer &gt;= 2."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"knots": 1}, "Expected 2D array, got scalar array instead:"</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"knots": [1, 2]}, "Expected 2D array, got 1D array instead:"</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"knots"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="identifier">r</span><span class="string-literal">"Number of knots, knots.shape\[0\], must be &gt;= 2."</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"knots"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="identifier">r</span><span class="string-literal">"knots.shape\[1\] == n_features is violated."</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"knots"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="string-literal">"knots must be sorted without duplicates."</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"knots": [[2], [1]]}, "knots must be sorted without duplicates."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"extrapolation"</span><span class="punctuation">:</span> <span class="none-literal">None</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="string-literal">"extrapolation must be one of 'error', 'constant', 'linear', "</span>
            <span class="string-literal">"'continue' or 'periodic'."</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"extrapolation"</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="string-literal">"extrapolation must be one of 'error', 'constant', 'linear', "</span>
            <span class="string-literal">"'continue' or 'periodic'."</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"extrapolation": "string"</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="string-literal">"extrapolation must be one of 'error', 'constant', 'linear', "</span>
            <span class="string-literal">"'continue' or 'periodic'."</span><span class="punctuation">,</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"include_bias": None}, "include_bias must be bool."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"include_bias": 1}, "include_bias must be bool."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"include_bias": "string"}, "include_bias must be bool."</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"extrapolation": "periodic", "n_knots": 3, "degree"</span><span class="punctuation">:</span> <span class="int-literal">3</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="string-literal">"Periodic splines require degree &lt; n_knots. Got n_knots="</span>
            <span class="string-literal">"3 and degree=3."</span>
        <span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">(</span>
            <span class="grouping">{</span><span class="string-literal">"extrapolation": "periodic", "knots": [[0], [1]], "degree"</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="grouping">}</span><span class="punctuation">,</span>
            <span class="string-literal">"Periodic splines require degree &lt; n_knots. Got n_knots=2 and "</span>
            <span class="string-literal">"degree=2."</span>
        <span class="grouping">)</span>
    <span class="grouping">]</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_input_validation</span><span class="grouping">(</span><span class="identifier">params</span><span class="punctuation">,</span> <span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that we raise errors for invalid input in SplineTransformer."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">err_msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">SplineTransformer</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spline_transformer_manual_knot_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test that array-like knot positions in SplineTransformer are accepted.
    """</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">st1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="identifier">knots</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">knots</span><span class="grouping">)</span>
    <span class="identifier">st2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="identifier">knots</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">st1</span><span class="punctuation">.</span><span class="identifier">bsplines_</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">t</span><span class="punctuation">,</span> <span class="identifier">st2</span><span class="punctuation">.</span><span class="identifier">bsplines_</span><span class="grouping">[</span><span class="identifier">i</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">t</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"extrapolation", ["continue", "periodic"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_integer_knots</span><span class="grouping">(</span><span class="identifier">extrapolation</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that SplineTransformer accepts integer value knot positions."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">knots</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="identifier">knots</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="identifier">extrapolation</span>
    <span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spline_transformer_feature_names</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that SplineTransformer generates correct features name."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">20</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span><span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">feature_names</span><span class="punctuation">,</span>
        <span class="grouping">[</span>
            <span class="string-literal">"x0_sp_0"</span><span class="punctuation">,</span>
            <span class="string-literal">"x0_sp_1"</span><span class="punctuation">,</span>
            <span class="string-literal">"x0_sp_2"</span><span class="punctuation">,</span>
            <span class="string-literal">"x0_sp_3"</span><span class="punctuation">,</span>
            <span class="string-literal">"x0_sp_4"</span><span class="punctuation">,</span>
            <span class="string-literal">"x1_sp_0"</span><span class="punctuation">,</span>
            <span class="string-literal">"x1_sp_1"</span><span class="punctuation">,</span>
            <span class="string-literal">"x1_sp_2"</span><span class="punctuation">,</span>
            <span class="string-literal">"x1_sp_3"</span><span class="punctuation">,</span>
            <span class="string-literal">"x1_sp_4"</span><span class="punctuation">,</span>
        <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">)</span>

    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span><span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"a", "b"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span>
        <span class="identifier">feature_names</span><span class="punctuation">,</span>
        <span class="grouping">[</span>
            <span class="string-literal">"a_sp_0"</span><span class="punctuation">,</span>
            <span class="string-literal">"a_sp_1"</span><span class="punctuation">,</span>
            <span class="string-literal">"a_sp_2"</span><span class="punctuation">,</span>
            <span class="string-literal">"a_sp_3"</span><span class="punctuation">,</span>
            <span class="string-literal">"b_sp_0"</span><span class="punctuation">,</span>
            <span class="string-literal">"b_sp_1"</span><span class="punctuation">,</span>
            <span class="string-literal">"b_sp_2"</span><span class="punctuation">,</span>
            <span class="string-literal">"b_sp_3"</span><span class="punctuation">,</span>
        <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"degree"</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_knots"</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"knots", ["uniform", "quantile"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"extrapolation", ["constant", "periodic"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_unity_decomposition</span><span class="grouping">(</span>
    <span class="identifier">degree</span><span class="punctuation">,</span>
    <span class="identifier">n_knots</span><span class="punctuation">,</span>
    <span class="identifier">knots</span><span class="punctuation">,</span>
    <span class="identifier">extrapolation</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that B-splines are indeed a decomposition of unity.

    Splines basis functions must sum up to 1 per row, if we stay in between
    boundaries.
    """</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="comment"># make the boundaries 0 and 1 part of X_train, for sure.</span>
    <span class="identifier">X_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">r_</span><span class="grouping">[</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span>

    <span class="keyword">if</span> <span class="identifier">extrapolation</span> <span class="relational-operator">==</span> <span class="string-literal">"periodic"</span><span class="punctuation">:</span>
        <span class="identifier">n_knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_knots</span> <span class="arithmetic-operator">+</span> <span class="identifier">degree</span>  <span class="comment"># periodic splines require degree &lt; n_knots</span>

    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="identifier">n_knots</span><span class="punctuation">,</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="identifier">knots</span><span class="punctuation">,</span>
        <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="identifier">extrapolation</span>
    <span class="grouping">)</span>
    <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"bias", "intercept"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_linear_regression</span><span class="grouping">(</span><span class="identifier">bias</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that B-splines fit a sinusodial curve pretty well."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span>  <span class="comment"># +2 to avoid the value 0 in assert_allclose</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span>
        <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
            <span class="grouping">(</span>
                <span class="string-literal">"spline"</span><span class="punctuation">,</span>
                <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
                    <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">15</span><span class="punctuation">,</span>
                    <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                    <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">bias</span><span class="punctuation">,</span>
                    <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="string-literal">"ols"</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">intercept</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"knots, n_knots, degree"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">"uniform"</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"uniform"</span><span class="punctuation">,</span> <span class="int-literal">12</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span>
        <span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">2.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">3.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">5.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="int-literal">100</span><span class="punctuation">,</span>  <span class="comment"># this gets ignored.</span>
        <span class="int-literal">3</span>
    <span class="grouping">)</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_periodicity_of_extrapolation</span><span class="grouping">(</span>
    <span class="identifier">knots</span><span class="punctuation">,</span> <span class="identifier">n_knots</span><span class="punctuation">,</span> <span class="identifier">degree</span>
<span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that the SplineTransformer is periodic for multiple features."""</span>
    <span class="identifier">X_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linspace</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">X_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">linspace</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>

    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="identifier">knots</span><span class="punctuation">,</span>
        <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="identifier">n_knots</span><span class="punctuation">,</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"periodic"</span>
    <span class="grouping">)</span>
    <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_1</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X_2</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"bias", "intercept"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_periodic_linear_regression</span><span class="grouping">(</span><span class="identifier">bias</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that B-splines fit a periodic curve pretty well."""</span>
    <span class="comment"># "+ 3" to avoid the value 0 in assert_allclose</span>
    <span class="keyword">def</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sin</span><span class="grouping">(</span><span class="int-literal">8</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">pi</span> <span class="arithmetic-operator">*</span> <span class="identifier">x</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">3</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">101</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span>
        <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span>
            <span class="grouping">(</span>
                <span class="string-literal">"spline"</span><span class="punctuation">,</span>
                <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
                    <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span>
                    <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                    <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">bias</span><span class="punctuation">,</span>
                    <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"periodic"</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">(</span><span class="string-literal">"ols"</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">intercept</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span>
        <span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Generate larger array to check periodic extrapolation</span>
    <span class="identifier">X_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">301</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">predictions</span><span class="punctuation">,</span> <span class="identifier">f</span><span class="grouping">(</span><span class="identifier">X_</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">atol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">predictions</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">predictions</span><span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">:</span><span class="int-literal">200</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-3</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">skipif</span><span class="grouping">(</span>
    <span class="identifier">sp_version</span> <span class="relational-operator">&lt;</span> <span class="identifier">parse_version</span><span class="grouping">(</span><span class="string-literal">"1.0.0"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="identifier">reason</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Periodic extrapolation not yet implemented for BSpline."</span><span class="punctuation">,</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_periodic_spline_backport</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that the backport of extrapolate="periodic" works correctly"""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="float-literal">3.5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">degree</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="comment"># Use periodic extrapolation backport in SplineTransformer</span>
    <span class="identifier">transformer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"periodic"</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">-1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Use periodic extrapolation in BSpline</span>
    <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">spl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">BSpline</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">coef</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="string-literal">"periodic"</span><span class="grouping">)</span>
    <span class="identifier">Xspl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">spl</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="punctuation">,</span> <span class="identifier">Xspl</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spline_transformer_periodic_splines_periodicity</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test if shifted knots result in the same transformation up to permutation.
    """</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">101</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>

    <span class="identifier">transformer_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"periodic"</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">4.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">5.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">8.0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="grouping">)</span>

    <span class="identifier">transformer_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"periodic"</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">4.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">5.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">8.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">9.0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="grouping">)</span>

    <span class="identifier">Xt_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer_1</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">Xt_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer_2</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">Xt_1</span><span class="punctuation">,</span> <span class="identifier">Xt_2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"degree"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_periodic_splines_smoothness</span><span class="grouping">(</span><span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that spline transformation is smooth at first / last knot."""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="invalid">_</span><span class="int-literal">000</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>

    <span class="identifier">transformer</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
        <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"periodic"</span><span class="punctuation">,</span>
        <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="float-literal">0.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">3.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">4.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">5.0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">8.0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">transformer</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">tol</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span> <span class="arithmetic-operator">*</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span>

    <span class="identifier">dXt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Xt</span>
    <span class="comment"># We expect splines of degree `degree` to be (`degree`-1) times</span>
    <span class="comment"># continuously differentiable. I.e. for d = 0, ..., `degree` - 1 the d-th</span>
    <span class="comment"># derivative should be continous. This is the case if the (d+1)-th</span>
    <span class="comment"># numerical derivative is reasonably small (smaller than `tol` in absolute</span>
    <span class="comment"># value). We thus compute d-th numeric derivatives for d = 1, ..., `degree`</span>
    <span class="comment"># and compare them to `tol`.</span>
    <span class="comment">#</span>
    <span class="comment"># Note that the 0-th derivative is the function itself, such that we are</span>
    <span class="comment"># also checking its continuity.</span>
    <span class="keyword">for</span> <span class="identifier">d</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">degree</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Check continuity of the (d-1)-th derivative</span>
        <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">dXt</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&lt;</span> <span class="identifier">tol</span>
        <span class="comment"># Compute d-th numeric derivative</span>
        <span class="identifier">dXt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diff</span> <span class="arithmetic-operator">/</span> <span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="invalid">t</span><span class="invalid">a</span>

    <span class="comment"># As degree `degree` splines are not `degree` times continously</span>
    <span class="comment"># differentiable at the knots, the `degree + 1`-th numeric derivative</span>
    <span class="comment"># should have spikes at the knots.</span>
    <span class="identifier">diff</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">dXt</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">diff</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">1</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"bias", "intercept"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"degree"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_extrapolation</span><span class="grouping">(</span><span class="identifier">bias</span><span class="punctuation">,</span> <span class="identifier">intercept</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that B-spline extrapolation works correctly."""</span>
    <span class="comment"># we use a straight line for that</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">squeeze</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># 'constant'</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span>
        <span class="grouping">[</span>
            <span class="grouping">[</span>
                <span class="string-literal">"spline"</span><span class="punctuation">,</span>
                <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
                    <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                    <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
                    <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">bias</span><span class="punctuation">,</span>
                    <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"constant"</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="string-literal">"ols"</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">intercept</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># 'linear'</span>
    <span class="identifier">pipe</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Pipeline</span><span class="grouping">(</span>
        <span class="grouping">[</span>
            <span class="grouping">[</span>
                <span class="string-literal">"spline"</span><span class="punctuation">,</span>
                <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
                    <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span>
                    <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
                    <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">bias</span><span class="punctuation">,</span>
                    <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"linear"</span><span class="punctuation">,</span>
                <span class="grouping">)</span><span class="punctuation">,</span>
            <span class="grouping">]</span><span class="punctuation">,</span>
            <span class="grouping">[</span><span class="string-literal">"ols"</span><span class="punctuation">,</span> <span class="identifier">LinearRegression</span><span class="grouping">(</span><span class="identifier">fit_intercept</span><span class="arithmetic-assignment">=</span><span class="identifier">intercept</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">]</span>
    <span class="grouping">)</span>
    <span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">pipe</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># 'error'</span>
    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">bias</span><span class="punctuation">,</span> <span class="identifier">extrapolation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"error"</span>
    <span class="grouping">)</span>
    <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_spline_transformer_kbindiscretizer</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that a B-spline of degree=0 is equivalent to KBinsDiscretizer."""</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">97531</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">200</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">n_bins</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">5</span>
    <span class="identifier">n_knots</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_bins</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="identifier">n_knots</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">knots</span><span class="arithmetic-assignment">=</span><span class="string-literal">"quantile"</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span>
    <span class="grouping">)</span>
    <span class="identifier">splines</span> <span class="arithmetic-assignment">=</span> <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">kbd</span> <span class="arithmetic-assignment">=</span> <span class="identifier">KBinsDiscretizer</span><span class="grouping">(</span>
        <span class="identifier">n_bins</span><span class="arithmetic-assignment">=</span><span class="identifier">n_bins</span><span class="punctuation">,</span> <span class="identifier">encode</span><span class="arithmetic-assignment">=</span><span class="string-literal">"onehot-dense", strategy="quantile"</span>
    <span class="grouping">)</span>
    <span class="identifier">kbins</span> <span class="arithmetic-assignment">=</span> <span class="identifier">kbd</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="comment"># Though they should be exactly equal, we test approximately with high</span>
    <span class="comment"># accuracy.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">splines</span><span class="punctuation">,</span> <span class="identifier">kbins</span><span class="punctuation">,</span> <span class="identifier">rtol</span><span class="arithmetic-assignment">=</span><span class="float-literal">1e-13</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_knots"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"include_bias"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"degree"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_spline_transformer_n_features_out</span><span class="grouping">(</span><span class="identifier">n_knots</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that transform results in n_features_out_ features."""</span>
    <span class="identifier">splt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">SplineTransformer</span><span class="grouping">(</span>
        <span class="identifier">n_knots</span><span class="arithmetic-assignment">=</span><span class="identifier">n_knots</span><span class="punctuation">,</span>
        <span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="identifier">degree</span><span class="punctuation">,</span>
        <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">include_bias</span>
    <span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">]</span>
    <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">splt</span><span class="punctuation">.</span><span class="identifier">n_features_out_</span>


<span class="keyword">def</span> <span class="identifier">test_polynomial_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test Polynomial Features</span>
    <span class="identifier">X1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">P1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones_like</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">,</span>
                    <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">X1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">X1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">deg1</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>

    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">x1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">x2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>
    <span class="identifier">P2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">0</span> <span class="arithmetic-operator">*</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                    <span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                    <span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">0</span> <span class="arithmetic-operator">*</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                    <span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span> <span class="arithmetic-operator">*</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">0</span><span class="punctuation">,</span>
                    <span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">1</span> <span class="arithmetic-operator">*</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">1</span><span class="punctuation">,</span>
                    <span class="identifier">x1</span> <span class="arithmetic-operator">**</span> <span class="int-literal">0</span> <span class="arithmetic-operator">*</span> <span class="identifier">x2</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">deg2</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="grouping">)</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">deg1</span><span class="punctuation">,</span> <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">P1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">deg2</span><span class="punctuation">,</span> <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">P2</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">P_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">P_test</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="grouping">)</span>

        <span class="identifier">P_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">P_test</span><span class="punctuation">,</span> <span class="identifier">P</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">interact</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span>
    <span class="identifier">X_poly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">interact</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">X_poly</span><span class="punctuation">,</span> <span class="identifier">P2</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">interact</span><span class="punctuation">.</span><span class="identifier">powers_</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">interact</span><span class="punctuation">.</span><span class="identifier">n_output_features_</span><span class="punctuation">,</span>
                                      <span class="identifier">interact</span><span class="punctuation">.</span><span class="identifier">n_input_features_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_polynomial_feature_names</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">30</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
    <span class="identifier">poly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">poly</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'1', 'x0', 'x1', 'x2', 'x0^2', 'x0 x1'</span><span class="punctuation">,</span>
                        <span class="string-literal">'x0 x2', 'x1^2', 'x1 x2', 'x2^2'</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">feature_names</span><span class="grouping">)</span>

    <span class="identifier">poly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">poly</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"a", "b", "c"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'a', 'b', 'c', 'a^2', 'a b', 'a c', 'b^2'</span><span class="punctuation">,</span>
                        <span class="string-literal">'b c', 'c^2', 'a^3', 'a^2 b', 'a^2 c'</span><span class="punctuation">,</span>
                        <span class="string-literal">'a b^2', 'a b c', 'a c^2', 'b^3', 'b^2 c'</span><span class="punctuation">,</span>
                        <span class="string-literal">'b c^2', 'c^3'</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">feature_names</span><span class="grouping">)</span>
    <span class="comment"># test some unicode</span>
    <span class="identifier">poly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">degree</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">feature_names</span> <span class="arithmetic-assignment">=</span> <span class="identifier">poly</span><span class="punctuation">.</span><span class="identifier">get_feature_names</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="string-literal">"\u0001F40D", "\u262E", "\u05D0"</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">"1", "\u0001F40D", "\u262E", "\u05D0"</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">feature_names</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'deg', 'include_bias', 'interaction_only', 'dtype'</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_features_csc_X</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_csc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">include_bias</span><span class="punctuation">,</span>
                             <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="grouping">)</span>
    <span class="identifier">Xt_csc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csc</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xt_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Xt_csc</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csc_matrix</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xt_csc</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">Xt_dense</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt_csc</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">Xt_dense</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'deg', 'include_bias', 'interaction_only', 'dtype'</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_features_csr_X</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">include_bias</span><span class="punctuation">,</span>
                             <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="grouping">)</span>
    <span class="identifier">Xt_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xt_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">Xt_dense</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">Xt_dense</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"n_features"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"degree"</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"interaction_only"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"include_bias"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_num_combinations</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""
    Test that n_output_features_ is calculated correctly.
    """</span>
    <span class="identifier">x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">n_features</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span>
        <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">include_bias</span>
    <span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">)</span>
    <span class="identifier">num_combos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">n_output_features_</span>

    <span class="identifier">combos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="punctuation">.</span><span class="identifier">_combinations</span><span class="grouping">(</span>
        <span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">degree</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">include_bias</span>
    <span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">num_combos</span> <span class="relational-operator">==</span> <span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">1</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">combos</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'deg', 'include_bias', 'interaction_only', 'dtype'</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_features_csr_X_floats</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="punctuation">,</span>
                                          <span class="identifier">interaction_only</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_random</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">include_bias</span><span class="punctuation">,</span>
                             <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="grouping">)</span>
    <span class="identifier">Xt_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">Xt_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dtype</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">Xt_dense</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">Xt_dense</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'zero_row_index', 'deg', 'interaction_only'</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_features_csr_X_zero_row</span><span class="grouping">(</span><span class="identifier">zero_row_index</span><span class="punctuation">,</span> <span class="identifier">deg</span><span class="punctuation">,</span>
                                            <span class="identifier">interaction_only</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_random</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_csr</span><span class="grouping">[</span><span class="identifier">zero_row_index</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                             <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="grouping">)</span>
    <span class="identifier">Xt_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="grouping">)</span>
    <span class="identifier">Xt_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">Xt_dense</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">Xt_dense</span><span class="grouping">)</span>


<span class="comment"># This degree should always be one more than the highest degree supported by</span>
<span class="comment"># _csr_expansion.</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'include_bias', 'interaction_only'</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">True</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="bool-literal">False</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_features_csr_X_degree_4</span><span class="grouping">(</span><span class="identifier">include_bias</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_random</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">include_bias</span><span class="arithmetic-assignment">=</span><span class="identifier">include_bias</span><span class="punctuation">,</span>
                             <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="grouping">)</span>
    <span class="identifier">Xt_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="grouping">)</span>
    <span class="identifier">Xt_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">Xt_dense</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">Xt_dense</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="grouping">[</span><span class="string-literal">'deg', 'dim', 'interaction_only'</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_polynomial_features_csr_X_dim_edges</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">dim</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_random</span><span class="grouping">(</span><span class="int-literal">1000</span><span class="punctuation">,</span> <span class="identifier">dim</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_csr</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PolynomialFeatures</span><span class="grouping">(</span><span class="identifier">deg</span><span class="punctuation">,</span> <span class="identifier">interaction_only</span><span class="arithmetic-assignment">=</span><span class="identifier">interaction_only</span><span class="grouping">)</span>
    <span class="identifier">Xt_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X_csr</span><span class="grouping">)</span>
    <span class="identifier">Xt_dense</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit_transform</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">isinstance</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="punctuation">.</span><span class="identifier">csr_matrix</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">dtype</span> <span class="relational-operator">==</span> <span class="identifier">Xt_dense</span><span class="punctuation">.</span><span class="identifier">dtype</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">Xt_csr</span><span class="punctuation">.</span><span class="identifier">A</span><span class="punctuation">,</span> <span class="identifier">Xt_dense</span><span class="grouping">)</span>

    </pre>
  </body>
</html>