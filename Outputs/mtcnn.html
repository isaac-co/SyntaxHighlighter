<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" MTCNN Face detection plugin """</span>

<span class="keyword">from</span> <span class="identifier">__future__</span> <span class="keyword">import</span> <span class="identifier">absolute_import</span><span class="punctuation">,</span> <span class="identifier">division</span><span class="punctuation">,</span> <span class="identifier">print_function</span>

<span class="keyword">import</span> <span class="identifier">cv2</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="comment"># pylint:disable=import-error</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span> <span class="keyword">import</span> <span class="identifier">Conv2D</span><span class="punctuation">,</span> <span class="identifier">Dense</span><span class="punctuation">,</span> <span class="identifier">Flatten</span><span class="punctuation">,</span> <span class="identifier">Input</span><span class="punctuation">,</span> <span class="identifier">MaxPool2D</span><span class="punctuation">,</span> <span class="identifier">Permute</span><span class="punctuation">,</span> <span class="identifier">PReLU</span>
<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">session</span> <span class="keyword">import</span> <span class="identifier">KSession</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">Detector</span><span class="punctuation">,</span> <span class="identifier">logger</span>


<span class="keyword">class</span> <span class="identifier">Detect</span><span class="grouping">(</span><span class="identifier">Detector</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" MTCNN detector for face recognition """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">git_model_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
        <span class="identifier">model_filename</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"mtcnn_det_v2.1.h5", "mtcnn_det_v2.2.h5", "mtcnn_det_v2.3.h5"</span><span class="grouping">]</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">git_model_id</span><span class="arithmetic-assignment">=</span><span class="identifier">git_model_id</span><span class="punctuation">,</span> <span class="identifier">model_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">model_filename</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"MTCNN"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">640</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">320</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram_warnings</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">64</span>  <span class="comment"># Will run at this with warnings</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram_per_batch</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">32</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">batchsize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"batch-size"</span><span class="grouping">]</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">validate_kwargs</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">color_format</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"RGB"</span>

    <span class="keyword">def</span> <span class="identifier">validate_kwargs</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Validate that config options are correct. If not reset to default """</span>
        <span class="identifier">valid</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">True</span>
        <span class="identifier">threshold</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"threshold_1"</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"threshold_2"</span><span class="grouping">]</span><span class="punctuation">,</span>
                     <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"threshold_3"</span><span class="grouping">]</span><span class="grouping">]</span>
        <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"minsize": self.config["minsize"</span><span class="grouping">]</span><span class="punctuation">,</span>
                  <span class="string-literal">"threshold"</span><span class="punctuation">:</span> <span class="identifier">threshold</span><span class="punctuation">,</span>
                  <span class="string-literal">"factor": self.config["scalefactor"</span><span class="grouping">]</span><span class="grouping">}</span>

        <span class="keyword">if</span> <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">"minsize"</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">10</span><span class="punctuation">:</span>
            <span class="identifier">valid</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="identifier">all</span><span class="grouping">(</span><span class="float-literal">0.0</span> <span class="relational-operator">&lt;</span> <span class="identifier">threshold</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">1.0</span> <span class="keyword">for</span> <span class="identifier">threshold</span> <span class="relational-operator">in</span> <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">'threshold'</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">valid</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>
        <span class="keyword">elif</span> <span class="logical-operator">not</span> <span class="float-literal">0.0</span> <span class="relational-operator">&lt;</span> <span class="identifier">kwargs</span><span class="grouping">[</span><span class="string-literal">'factor'</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="float-literal">1.0</span><span class="punctuation">:</span>
            <span class="identifier">valid</span> <span class="arithmetic-assignment">=</span> <span class="bool-literal">False</span>

        <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">valid</span><span class="punctuation">:</span>
            <span class="identifier">kwargs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="string-literal">"minsize"</span><span class="punctuation">:</span> <span class="int-literal">20</span><span class="punctuation">,</span>  <span class="comment"># minimum size of face</span>
                      <span class="string-literal">"threshold"</span><span class="punctuation">:</span> <span class="grouping">[</span><span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="grouping">]</span><span class="punctuation">,</span>  <span class="comment"># three steps threshold</span>
                      <span class="string-literal">"factor"</span><span class="punctuation">:</span> <span class="float-literal">0.709</span><span class="grouping">}</span>               <span class="comment"># scale factor</span>
            <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"Invalid MTCNN options in config. Running with defaults"</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Using mtcnn kwargs: %s"</span><span class="punctuation">,</span> <span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">kwargs</span>

    <span class="keyword">def</span> <span class="identifier">init_model</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize S3FD Model"""</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MTCNN</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_path</span><span class="punctuation">,</span>
                           <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"allow_growth"</span><span class="grouping">]</span><span class="punctuation">,</span>
                           <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_exclude_gpus</span><span class="punctuation">,</span>
                           <span class="arithmetic-operator">**</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process_input</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile the detection image(s) for prediction """</span>
        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"feed"] = (batch["image"</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="float-literal">127.5</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="float-literal">127.5</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Run model to get predictions """</span>
        <span class="identifier">prediction</span><span class="punctuation">,</span> <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">detect_faces</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"feed"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"filename: %s, prediction: %s, mtcnn_points: %s"</span><span class="punctuation">,</span>
                     <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"filename"</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">prediction</span><span class="punctuation">,</span> <span class="identifier">points</span><span class="grouping">)</span>
        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"prediction"], batch["mtcnn_points"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">prediction</span><span class="punctuation">,</span> <span class="identifier">points</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">process_output</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Post process the detected faces """</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>


<span class="comment"># MTCNN Detector</span>
<span class="comment"># Code adapted from: https://github.com/xiangrufan/keras-mtcnn</span>
<span class="comment">#</span>
<span class="comment"># Keras implementation of the face detection / alignment algorithm</span>
<span class="comment"># found at</span>
<span class="comment"># https://github.com/kpzhang93/MTCNN_face_detection_alignment</span>
<span class="comment">#</span>
<span class="comment"># MIT License</span>
<span class="comment">#</span>
<span class="comment"># Copyright (c) 2016 Kaipeng Zhang</span>
<span class="comment">#</span>
<span class="comment"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="comment"># of this software and associated documentation files (the "Software"), to deal</span>
<span class="comment"># in the Software without restriction, including without limitation the rights</span>
<span class="comment"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="comment"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="comment"># furnished to do so, subject to the following conditions:</span>
<span class="comment">#</span>
<span class="comment"># The above copyright notice and this permission notice shall be included in all</span>
<span class="comment"># copies or substantial portions of the Software.</span>
<span class="comment">#</span>
<span class="comment"># THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="comment"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="comment"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="comment"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="comment"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="comment"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="comment"># SOFTWARE.</span>


<span class="keyword">class</span> <span class="identifier">PNet</span><span class="grouping">(</span><span class="identifier">KSession</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Keras P-Net model for MTCNN """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="string-literal">"MTCNN-PNet"</span><span class="punctuation">,</span>
                         <span class="identifier">model_path</span><span class="punctuation">,</span>
                         <span class="identifier">allow_growth</span><span class="arithmetic-assignment">=</span><span class="identifier">allow_growth</span><span class="punctuation">,</span>
                         <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_definition</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">load_model_weights</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">model_definition</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Keras P-Network for MTCNN """</span>
        <span class="identifier">input_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Input</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">input_</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'PReLU1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPool2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">16</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'PReLU2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'PReLU3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">'softmax', name='conv4-1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">bbox_regress</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'conv4-2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">[</span><span class="identifier">input_</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">bbox_regress</span><span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">RNet</span><span class="grouping">(</span><span class="identifier">KSession</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Keras R-Net model for MTCNN """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="string-literal">"MTCNN-RNet"</span><span class="punctuation">,</span>
                         <span class="identifier">model_path</span><span class="punctuation">,</span>
                         <span class="identifier">allow_growth</span><span class="arithmetic-assignment">=</span><span class="identifier">allow_growth</span><span class="punctuation">,</span>
                         <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_definition</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">load_model_weights</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">model_definition</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Keras R-Network for MTCNN """</span>
        <span class="identifier">input_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Input</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">24</span><span class="punctuation">,</span> <span class="int-literal">24</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">28</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">input_</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPool2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'same'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">48</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPool2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Permute</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">128</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'conv4'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu4'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">'softmax', name='conv5-1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">bbox_regress</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'conv5-2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">[</span><span class="identifier">input_</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">bbox_regress</span><span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">ONet</span><span class="grouping">(</span><span class="identifier">KSession</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Keras O-Net model for MTCNN """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="string-literal">"MTCNN-ONet"</span><span class="punctuation">,</span>
                         <span class="identifier">model_path</span><span class="punctuation">,</span>
                         <span class="identifier">allow_growth</span><span class="arithmetic-assignment">=</span><span class="identifier">allow_growth</span><span class="punctuation">,</span>
                         <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_definition</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">load_model_weights</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">model_definition</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Keras O-Network for MTCNN """</span>
        <span class="identifier">input_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Input</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">32</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">input_</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPool2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'same'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPool2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">64</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPool2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">128</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">padding</span><span class="arithmetic-assignment">=</span><span class="string-literal">'valid', name='conv4'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">shared_axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu4'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Permute</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Flatten</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'conv5'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PReLU</span><span class="grouping">(</span><span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'prelu5'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">'softmax', name='conv6-1'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">bbox_regress</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'conv6-2'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">landmark_regress</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Dense</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">'conv6-3'</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">[</span><span class="identifier">input_</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">i</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">e</span><span class="invalid">r</span><span class="punctuation">,</span> <span class="identifier">bbox_regress</span><span class="punctuation">,</span> <span class="identifier">landmark_regress</span><span class="grouping">]</span>


<span class="keyword">class</span> <span class="identifier">MTCNN</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" MTCNN Detector for face alignment """</span>
    <span class="comment"># TODO Batching for r-net and o-net</span>

    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="punctuation">,</span> <span class="identifier">minsize</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""
        minsize: minimum faces' size
        threshold: threshold=[th1, th2, th3], th1-3 are three steps threshold
        factor: the factor used to create a scaling pyramid of face sizes to
                detect in the image.
        p-net, r-net, o-net: caffemodel
        """</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s: (model_path: '%s', allow_growth: %s, exclude_gpus: %s, "</span>
                     <span class="string-literal">"minsize: %s, threshold: %s, factor: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span>
                     <span class="identifier">model_path</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="punctuation">,</span> <span class="identifier">minsize</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">minsize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">minsize</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">threshold</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">factor</span> <span class="arithmetic-assignment">=</span> <span class="identifier">factor</span>

        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pnet</span> <span class="arithmetic-assignment">=</span> <span class="identifier">PNet</span><span class="grouping">(</span><span class="identifier">model_path</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rnet</span> <span class="arithmetic-assignment">=</span> <span class="identifier">RNet</span><span class="grouping">(</span><span class="identifier">model_path</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">onet</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ONet</span><span class="grouping">(</span><span class="identifier">model_path</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pnet_scales</span> <span class="arithmetic-assignment">=</span> <span class="none-literal">None</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">detect_faces</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Detects faces in an image, and returns bounding boxes and points for them.
        batch: input batch
        """</span>
        <span class="identifier">origin_h</span><span class="punctuation">,</span> <span class="identifier">origin_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
        <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">detect_pnet</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">origin_h</span><span class="punctuation">,</span> <span class="identifier">origin_w</span><span class="grouping">)</span>
        <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">detect_rnet</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">rectangles</span><span class="punctuation">,</span> <span class="identifier">origin_h</span><span class="punctuation">,</span> <span class="identifier">origin_w</span><span class="grouping">)</span>
        <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">detect_onet</span><span class="grouping">(</span><span class="identifier">batch</span><span class="punctuation">,</span> <span class="identifier">rectangles</span><span class="punctuation">,</span> <span class="identifier">origin_h</span><span class="punctuation">,</span> <span class="identifier">origin_w</span><span class="grouping">)</span>
        <span class="identifier">ret_boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">ret_points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">rects</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="identifier">rects</span><span class="punctuation">:</span>
                <span class="identifier">total_boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">result</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">result</span> <span class="relational-operator">in</span> <span class="identifier">rects</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">result</span><span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">result</span> <span class="relational-operator">in</span> <span class="identifier">rects</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="identifier">total_boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">points</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">ret_boxes</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">total_boxes</span><span class="grouping">)</span>
            <span class="identifier">ret_points</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">points</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">ret_boxes</span><span class="punctuation">,</span> <span class="identifier">ret_points</span>

    <span class="keyword">def</span> <span class="identifier">detect_pnet</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">images</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># pylint: disable=too-many-locals</span>
        <span class="comment">""" first stage - fast proposal network (p-net) to obtain face candidates """</span>
        <span class="keyword">if</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pnet_scales</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pnet_scales</span> <span class="arithmetic-assignment">=</span> <span class="identifier">calculate_scales</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">minsize</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">factor</span><span class="grouping">)</span>
        <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">_</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">images</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">batch_items</span> <span class="arithmetic-assignment">=</span> <span class="identifier">images</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">for</span> <span class="identifier">scale</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_pnet_scales</span><span class="punctuation">:</span>
            <span class="identifier">rwidth</span><span class="punctuation">,</span> <span class="identifier">rheight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">width</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span>
            <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">empty</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">batch_items</span><span class="punctuation">,</span> <span class="identifier">rheight</span><span class="punctuation">,</span> <span class="identifier">rwidth</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">batch_items</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">batch</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">images</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">rwidth</span><span class="punctuation">,</span> <span class="identifier">rheight</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">pnet</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">)</span>
            <span class="identifier">cls_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">out_h</span><span class="punctuation">,</span> <span class="identifier">out_w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls_prob</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
            <span class="identifier">out_side</span> <span class="arithmetic-assignment">=</span> <span class="identifier">max</span><span class="grouping">(</span><span class="identifier">out_h</span><span class="punctuation">,</span> <span class="identifier">out_w</span><span class="grouping">)</span>
            <span class="identifier">cls_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">swapaxes</span><span class="grouping">(</span><span class="identifier">cls_prob</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
            <span class="identifier">roi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">swapaxes</span><span class="grouping">(</span><span class="identifier">roi</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">idx</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">batch_items</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># first index 0 = class score, 1 = one hot representation</span>
                <span class="identifier">rectangle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">detect_face_12net</span><span class="grouping">(</span><span class="identifier">cls_prob</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                                              <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">idx</span><span class="punctuation">,</span> <span class="punctuation">.</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span>
                                              <span class="identifier">out_side</span><span class="punctuation">,</span>
                                              <span class="int-literal">1</span> <span class="arithmetic-operator">/</span> <span class="identifier">scale</span><span class="punctuation">,</span>
                                              <span class="identifier">width</span><span class="punctuation">,</span>
                                              <span class="identifier">height</span><span class="punctuation">,</span>
                                              <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">extend</span><span class="grouping">(</span><span class="identifier">rectangle</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="grouping">[</span><span class="identifier">nms</span><span class="grouping">(</span><span class="identifier">x</span><span class="punctuation">,</span> <span class="float-literal">0.7</span><span class="punctuation">,</span> <span class="string-literal">'iou'</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">detect_rnet</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">images</span><span class="punctuation">,</span> <span class="identifier">rectangle_batch</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" second stage - refinement of face candidates with r-net """</span>
        <span class="identifier">ret</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
        <span class="comment"># TODO: batching</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">rectangles</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">rectangle_batch</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
                <span class="identifier">ret</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">images</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span>
            <span class="identifier">crop_number</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="identifier">predict_24_batch</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">rect</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
                <span class="identifier">crop_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
                <span class="identifier">scale_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">crop_img</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">24</span><span class="punctuation">,</span> <span class="int-literal">24</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">predict_24_batch</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">scale_img</span><span class="grouping">)</span>
                <span class="identifier">crop_number</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="identifier">predict_24_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">predict_24_batch</span><span class="grouping">)</span>
            <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">rnet</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">predict_24_batch</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">128</span><span class="grouping">)</span>
            <span class="identifier">cls_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">cls_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">cls_prob</span><span class="grouping">)</span>
            <span class="identifier">roi_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">roi_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">roi_prob</span><span class="grouping">)</span>
            <span class="identifier">ret</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">filter_face_24net</span><span class="grouping">(</span>
                <span class="identifier">cls_prob</span><span class="punctuation">,</span> <span class="identifier">roi_prob</span><span class="punctuation">,</span> <span class="identifier">rectangles</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">ret</span>

    <span class="keyword">def</span> <span class="identifier">detect_onet</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">images</span><span class="punctuation">,</span> <span class="identifier">rectangle_batch</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" third stage - further refinement and facial landmarks positions with o-net """</span>
        <span class="identifier">ret</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="comment"># TODO: batching</span>
        <span class="keyword">for</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">rectangles</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">rectangle_batch</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
                <span class="identifier">ret</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">continue</span>
            <span class="identifier">image</span> <span class="arithmetic-assignment">=</span> <span class="identifier">images</span><span class="grouping">[</span><span class="identifier">idx</span><span class="grouping">]</span>
            <span class="identifier">crop_number</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
            <span class="identifier">predict_batch</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
            <span class="keyword">for</span> <span class="identifier">rect</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
                <span class="identifier">crop_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">image</span><span class="grouping">[</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span><span class="identifier">int</span><span class="grouping">(</span><span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">]</span>
                <span class="identifier">scale_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cv2</span><span class="punctuation">.</span><span class="identifier">resize</span><span class="grouping">(</span><span class="identifier">crop_img</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">48</span><span class="punctuation">,</span> <span class="int-literal">48</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="identifier">predict_batch</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">scale_img</span><span class="grouping">)</span>
                <span class="identifier">crop_number</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
            <span class="identifier">predict_batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">predict_batch</span><span class="grouping">)</span>
            <span class="identifier">output</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">onet</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">predict_batch</span><span class="punctuation">,</span> <span class="identifier">batch_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">128</span><span class="grouping">)</span>
            <span class="identifier">cls_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">roi_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">pts_prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">output</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>  <span class="comment"># index</span>
            <span class="identifier">ret</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">filter_face_48net</span><span class="grouping">(</span>
                <span class="identifier">cls_prob</span><span class="punctuation">,</span>
                <span class="identifier">roi_prob</span><span class="punctuation">,</span>
                <span class="identifier">pts_prob</span><span class="punctuation">,</span>
                <span class="identifier">rectangles</span><span class="punctuation">,</span>
                <span class="identifier">width</span><span class="punctuation">,</span>
                <span class="identifier">height</span><span class="punctuation">,</span>
                <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span>
            <span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">ret</span>


<span class="keyword">def</span> <span class="identifier">detect_face_12net</span><span class="grouping">(</span><span class="identifier">cls_prob</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="punctuation">,</span> <span class="identifier">out_side</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># pylint: disable=too-many-locals, too-many-arguments</span>
    <span class="comment">""" Detect face position and calibrate bounding box on 12net feature map(matrix version)
    Input:
        cls_prob : softmax feature map for face classify
        roi      : feature map for regression
        out_side : feature map's largest size
        scale    : current input image scale in multi-scales
        width    : image's origin width
        height   : image's origin height
        threshold: 0.6 can have 99% recall rate
    """</span>
    <span class="identifier">in_side</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span><span class="arithmetic-operator">*</span><span class="identifier">out_side</span><span class="arithmetic-operator">+</span><span class="int-literal">11</span>
    <span class="identifier">stride</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="keyword">if</span> <span class="identifier">out_side</span> <span class="relational-operator">!=</span> <span class="int-literal">1</span><span class="punctuation">:</span>
        <span class="identifier">stride</span> <span class="arithmetic-assignment">=</span> <span class="identifier">float</span><span class="grouping">(</span><span class="identifier">in_side</span><span class="arithmetic-operator">-</span><span class="int-literal">12</span><span class="grouping">)</span><span class="arithmetic-operator">/</span><span class="grouping">(</span><span class="identifier">out_side</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">)</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">cls_prob</span> <span class="relational-operator">&gt;=</span> <span class="identifier">threshold</span><span class="grouping">)</span>
    <span class="identifier">boundingbox</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">bb1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">stride</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">boundingbox</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">0</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span>
    <span class="identifier">bb2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">fix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">stride</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">boundingbox</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">11</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">scale</span><span class="grouping">)</span>
    <span class="identifier">boundingbox</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">bb1</span><span class="punctuation">,</span> <span class="identifier">bb2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">dx_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">]</span>
    <span class="identifier">dx_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">]</span>
    <span class="identifier">dx3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">]</span>
    <span class="identifier">dx4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">[</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">]</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">cls_prob</span><span class="grouping">[</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="identifier">var_y</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">dx_1</span><span class="punctuation">,</span> <span class="identifier">dx_2</span><span class="punctuation">,</span> <span class="identifier">dx3</span><span class="punctuation">,</span> <span class="identifier">dx4</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">boundingbox</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boundingbox</span> <span class="arithmetic-operator">+</span> <span class="identifier">offset</span><span class="arithmetic-operator">*</span><span class="float-literal">12.0</span><span class="arithmetic-operator">*</span><span class="identifier">scale</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">boundingbox</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rect2square</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="grouping">)</span>
    <span class="identifier">pick</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">rect</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
        <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">sc_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">x_2</span> <span class="relational-operator">&gt;</span> <span class="identifier">x_1</span> <span class="logical-operator">and</span> <span class="identifier">y_2</span> <span class="relational-operator">&gt;</span> <span class="identifier">y_1</span><span class="punctuation">:</span>
            <span class="identifier">pick</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="punctuation">,</span> <span class="identifier">sc_</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">nms</span><span class="grouping">(</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="string-literal">"iou"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">filter_face_24net</span><span class="grouping">(</span><span class="identifier">cls_prob</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="punctuation">,</span> <span class="identifier">rectangles</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># pylint: disable=too-many-locals, too-many-arguments</span>
    <span class="comment">""" Filter face position and calibrate bounding box on 12net's output
    Input:
        cls_prob  : softmax feature map for face classify
        roi_prob  : feature map for regression
        rectangles: 12net's predict
        width     : image's origin width
        height    : image's origin height
        threshold : 0.6 can have 97% recall rate
    Output:
        rectangles: possible face positions
    """</span>
    <span class="identifier">prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls_prob</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">pick</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">prob</span> <span class="relational-operator">&gt;=</span> <span class="identifier">threshold</span><span class="grouping">)</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="grouping">)</span>
    <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">sc_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">prob</span><span class="grouping">[</span><span class="identifier">pick</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">dx_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">dx_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">dx3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">dx4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">r_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_2</span><span class="arithmetic-operator">-</span><span class="identifier">x_1</span>
    <span class="identifier">r_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_2</span><span class="arithmetic-operator">-</span><span class="identifier">y_1</span>
    <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">x_1</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx_1</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">y_1</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx_2</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_height</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">x_2</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx3</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">y_2</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx4</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_height</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="punctuation">,</span> <span class="identifier">sc_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rect2square</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="grouping">)</span>
    <span class="identifier">pick</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">rect</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
        <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">sc_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span>
        <span class="keyword">if</span> <span class="identifier">x_2</span> <span class="relational-operator">&gt;</span> <span class="identifier">x_1</span> <span class="logical-operator">and</span> <span class="identifier">y_2</span> <span class="relational-operator">&gt;</span> <span class="identifier">y_1</span><span class="punctuation">:</span>
            <span class="identifier">pick</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="punctuation">,</span> <span class="identifier">sc_</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">nms</span><span class="grouping">(</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="string-literal">'iou'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">filter_face_48net</span><span class="grouping">(</span><span class="identifier">cls_prob</span><span class="punctuation">,</span> <span class="identifier">roi</span><span class="punctuation">,</span> <span class="identifier">pts</span><span class="punctuation">,</span> <span class="identifier">rectangles</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># pylint: disable=too-many-locals, too-many-arguments</span>
    <span class="comment">""" Filter face position and calibrate bounding box on 12net's output
    Input:
        cls_prob  : cls_prob[1] is face possibility
        roi       : roi offset
        pts       : 5 landmark
        rectangles: 12net's predict, rectangles[i][0:3] is the position, rectangles[i][4] is score
        width     : image's origin width
        height    : image's origin height
        threshold : 0.7 can have 94% recall rate on CelebA-database
    Output:
        rectangles: face positions and landmarks
    """</span>
    <span class="identifier">prob</span> <span class="arithmetic-assignment">=</span> <span class="identifier">cls_prob</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">pick</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">prob</span> <span class="relational-operator">&gt;=</span> <span class="identifier">threshold</span><span class="grouping">)</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="grouping">)</span>
    <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">sc_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">prob</span><span class="grouping">[</span><span class="identifier">pick</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">dx_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">dx_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">dx3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">dx4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">roi</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">r_width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">x_2</span><span class="arithmetic-operator">-</span><span class="identifier">x_1</span>
    <span class="identifier">r_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y_2</span><span class="arithmetic-operator">-</span><span class="identifier">y_1</span>
    <span class="identifier">pts0</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_width</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">x_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_width</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">x_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_width</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">x_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts6</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_width</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">x_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts7</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts8</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_width</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">x_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">pts9</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">r_height</span> <span class="arithmetic-operator">*</span> <span class="identifier">pts</span><span class="grouping">[</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="int-literal">9</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">y_1</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">x_1</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx_1</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">y_1</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx_2</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_height</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">x_2</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx3</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_width</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">(</span><span class="identifier">y_2</span> <span class="arithmetic-operator">+</span> <span class="identifier">dx4</span> <span class="arithmetic-operator">*</span> <span class="identifier">r_height</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">rectangles</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="punctuation">,</span> <span class="identifier">sc_</span><span class="punctuation">,</span>
                                 <span class="identifier">pts0</span><span class="punctuation">,</span> <span class="identifier">pts1</span><span class="punctuation">,</span> <span class="identifier">pts2</span><span class="punctuation">,</span> <span class="identifier">pts3</span><span class="punctuation">,</span> <span class="identifier">pts4</span><span class="punctuation">,</span> <span class="identifier">pts5</span><span class="punctuation">,</span> <span class="identifier">pts6</span><span class="punctuation">,</span> <span class="identifier">pts7</span><span class="punctuation">,</span> <span class="identifier">pts8</span><span class="punctuation">,</span> <span class="identifier">pts9</span><span class="grouping">)</span><span class="punctuation">,</span>
                                <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">pick</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">rect</span> <span class="relational-operator">in</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
        <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">max</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">x_2</span> <span class="relational-operator">&gt;</span> <span class="identifier">x_1</span> <span class="logical-operator">and</span> <span class="identifier">y_2</span> <span class="relational-operator">&gt;</span> <span class="identifier">y_1</span><span class="punctuation">:</span>
            <span class="identifier">pick</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="punctuation">,</span>
                         <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">6</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">7</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">9</span><span class="grouping">]</span><span class="punctuation">,</span>
                         <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">10</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">11</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">12</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">13</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">rect</span><span class="grouping">[</span><span class="int-literal">14</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">nms</span><span class="grouping">(</span><span class="identifier">pick</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="string-literal">'iom'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">nms</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="punctuation">,</span> <span class="identifier">method</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># pylint:disable=too-many-locals</span>
    <span class="comment">""" apply non-maximum suppression on ROIs in same scale(matrix version)
    Input:
        rectangles: rectangles[i][0:3] is the position, rectangles[i][4] is score
    Output:
        rectangles: same as input
    """</span>
    <span class="keyword">if</span> <span class="logical-operator">not</span> <span class="identifier">rectangles</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">rectangles</span>
    <span class="identifier">boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="grouping">)</span>
    <span class="identifier">x_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">y_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">x_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span>
    <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="identifier">var_s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span>
    <span class="identifier">area</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">multiply</span><span class="grouping">(</span><span class="identifier">x_2</span><span class="arithmetic-operator">-</span><span class="identifier">x_1</span><span class="arithmetic-operator">+</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="arithmetic-operator">-</span><span class="identifier">y_1</span><span class="arithmetic-operator">+</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">s_sort</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">var_s</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">pick</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">while</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">s_sort</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
        <span class="comment"># s_sort[-1] have highest prob score, s_sort[0:-1]-&gt;others</span>
        <span class="identifier">xx_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">x_1</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x_1</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">yy_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">y_1</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">xx_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">x_2</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">yy_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">y_2</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="identifier">xx_2</span> <span class="arithmetic-operator">-</span> <span class="identifier">xx_1</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="identifier">yy_2</span> <span class="arithmetic-operator">-</span> <span class="identifier">yy_1</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">inter</span> <span class="arithmetic-assignment">=</span> <span class="identifier">width</span> <span class="arithmetic-operator">*</span> <span class="identifier">height</span>
        <span class="keyword">if</span> <span class="identifier">method</span> <span class="relational-operator">==</span> <span class="string-literal">'iom'</span><span class="punctuation">:</span>
            <span class="identifier">var_o</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inter</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">area</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">area</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">var_o</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inter</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">area</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">area</span><span class="grouping">[</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">inter</span><span class="grouping">)</span>
        <span class="identifier">pick</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">s_sort</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">s_sort</span> <span class="arithmetic-assignment">=</span> <span class="identifier">s_sort</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">var_o</span> <span class="relational-operator">&lt;=</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">result_rectangle</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">pick</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">tolist</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">result_rectangle</span>


<span class="keyword">def</span> <span class="identifier">calculate_scales</span><span class="grouping">(</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">minsize</span><span class="punctuation">,</span> <span class="identifier">factor</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Calculate multi-scale
        Input:
            height: Original image height
            width: Original image width
            minsize: Minimum size for a face to be accepted
            factor: Scaling factor
        Output:
            scales  : Multi-scale
    """</span>
    <span class="identifier">factor_count</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">minl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">amin</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">height</span><span class="punctuation">,</span> <span class="identifier">width</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">var_m</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">12.0</span> <span class="arithmetic-operator">/</span> <span class="identifier">minsize</span>
    <span class="identifier">minl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">minl</span> <span class="arithmetic-operator">*</span> <span class="identifier">var_m</span>
    <span class="comment"># create scale pyramid</span>
    <span class="identifier">scales</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">while</span> <span class="identifier">minl</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">12</span><span class="punctuation">:</span>
        <span class="identifier">scales</span> <span class="arithmetic-assignment">+=</span> <span class="grouping">[</span><span class="identifier">var_m</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">power</span><span class="grouping">(</span><span class="identifier">factor</span><span class="punctuation">,</span> <span class="identifier">factor_count</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">minl</span> <span class="arithmetic-assignment">=</span> <span class="identifier">minl</span> <span class="arithmetic-operator">*</span> <span class="identifier">factor</span>
        <span class="identifier">factor_count</span> <span class="arithmetic-assignment">+=</span> <span class="int-literal">1</span>
    <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="identifier">scales</span><span class="grouping">)</span>
    <span class="keyword">return</span> <span class="identifier">scales</span>


<span class="keyword">def</span> <span class="identifier">rect2square</span><span class="grouping">(</span><span class="identifier">rectangles</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" change rectangles into squares (matrix version)
    Input:
        rectangles: rectangles[i][0:3] is the position, rectangles[i][4] is score
    Output:
        squares: same as input
    """</span>
    <span class="identifier">width</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">length</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">width</span><span class="punctuation">,</span> <span class="identifier">height</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">width</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">-</span> <span class="identifier">length</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>
    <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">height</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span> <span class="arithmetic-operator">-</span> <span class="identifier">length</span> <span class="arithmetic-operator">*</span> <span class="float-literal">0.5</span>
    <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rectangles</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">length</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="keyword">return</span> <span class="identifier">rectangles</span>

    </pre>
  </body>
</html>