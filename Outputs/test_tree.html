<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">"""
Testing for the tree module (sklearn.tree).
"""</span>
<span class="keyword">import</span> <span class="identifier">copy</span>
<span class="keyword">import</span> <span class="identifier">pickle</span>
<span class="keyword">from</span> <span class="identifier">itertools</span> <span class="keyword">import</span> <span class="identifier">product</span>
<span class="keyword">import</span> <span class="identifier">struct</span>

<span class="keyword">import</span> <span class="identifier">pytest</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">from</span> <span class="identifier">numpy</span><span class="punctuation">.</span><span class="identifier">testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csc_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">csr_matrix</span>
<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">sparse</span> <span class="keyword">import</span> <span class="identifier">coo_matrix</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">random_projection</span> <span class="keyword">import</span> <span class="identifier">_sparse_random_matrix</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">dummy</span> <span class="keyword">import</span> <span class="identifier">DummyRegressor</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">accuracy_score</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_squared_error</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">metrics</span> <span class="keyword">import</span> <span class="identifier">mean_poisson_deviance</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">model_selection</span> <span class="keyword">import</span> <span class="identifier">train_test_split</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">e</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">create_memmap_backed_data</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">ignore_warnings</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">_testing</span> <span class="keyword">import</span> <span class="identifier">skip_if_32bit</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">estimator_checks</span> <span class="keyword">import</span> <span class="identifier">check_sample_weights_invariance</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span><span class="punctuation">.</span><span class="identifier">validation</span> <span class="keyword">import</span> <span class="identifier">check_random_state</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="invalid">e</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">s</span> <span class="keyword">import</span> <span class="identifier">NotFittedError</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">DecisionTreeRegressor</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">ExtraTreeClassifier</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span> <span class="keyword">import</span> <span class="identifier">ExtraTreeRegressor</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">tree</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span> <span class="keyword">import</span> <span class="identifier">TREE_LEAF</span><span class="punctuation">,</span> <span class="identifier">TREE_UNDEFINED</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_classes</span> <span class="keyword">import</span> <span class="identifier">CRITERIA_CLF</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_classes</span> <span class="keyword">import</span> <span class="identifier">CRITERIA_REG</span>
<span class="keyword">from</span> <span class="identifier">sklearn</span> <span class="keyword">import</span> <span class="identifier">datasets</span>

<span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">utils</span> <span class="keyword">import</span> <span class="identifier">compute_sample_weight</span>

<span class="identifier">CLF_CRITERIONS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"gini", "entropy"</span><span class="grouping">)</span>
<span class="identifier">REG_CRITERIONS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="string-literal">"squared_error", "absolute_error", "friedman_mse", "poisson"</span><span class="grouping">)</span>

<span class="identifier">CLF_TREES</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"DecisionTreeClassifier"</span><span class="punctuation">:</span> <span class="identifier">DecisionTreeClassifier</span><span class="punctuation">,</span>
    <span class="string-literal">"ExtraTreeClassifier"</span><span class="punctuation">:</span> <span class="identifier">ExtraTreeClassifier</span><span class="punctuation">,</span>
<span class="grouping">}</span>

<span class="identifier">REG_TREES</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"DecisionTreeRegressor"</span><span class="punctuation">:</span> <span class="identifier">DecisionTreeRegressor</span><span class="punctuation">,</span>
    <span class="string-literal">"ExtraTreeRegressor"</span><span class="punctuation">:</span> <span class="identifier">ExtraTreeRegressor</span><span class="punctuation">,</span>
<span class="grouping">}</span>

<span class="identifier">ALL_TREES</span><span class="punctuation">:</span> <span class="identifier">dict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="identifier">CLF_TREES</span><span class="grouping">)</span>
<span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="identifier">REG_TREES</span><span class="grouping">)</span>

<span class="identifier">SPARSE_TREES</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="string-literal">"DecisionTreeClassifier", "DecisionTreeRegressor"</span><span class="punctuation">,</span>
                <span class="string-literal">"ExtraTreeClassifier", "ExtraTreeRegressor"</span><span class="grouping">]</span>


<span class="identifier">X_small</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
    <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">14</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-4.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">2.1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-4.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-1.2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="float-literal">2.11</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">-0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">-3.2</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

<span class="identifier">y_small</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span>
           <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>
<span class="identifier">y_small_reg</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">2.1</span><span class="punctuation">,</span> <span class="float-literal">1.2</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="float-literal">2.4</span><span class="punctuation">,</span> <span class="float-literal">3.1</span><span class="punctuation">,</span> <span class="float-literal">1.01</span><span class="punctuation">,</span> <span class="float-literal">0.01</span><span class="punctuation">,</span> <span class="float-literal">2.98</span><span class="punctuation">,</span> <span class="float-literal">3.1</span><span class="punctuation">,</span> <span class="float-literal">1.1</span><span class="punctuation">,</span>
               <span class="float-literal">0.0</span><span class="punctuation">,</span> <span class="float-literal">1.2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">4.5</span><span class="punctuation">,</span> <span class="float-literal">0.201</span><span class="punctuation">,</span> <span class="float-literal">1.06</span><span class="punctuation">,</span> <span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span>

<span class="comment"># toy sample</span>
<span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
<span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
<span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>
<span class="identifier">true_result</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>

<span class="comment"># also load the iris dataset</span>
<span class="comment"># and randomly permute it</span>
<span class="identifier">iris</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_iris</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="comment"># also load the diabetes dataset</span>
<span class="comment"># and randomly permute it</span>
<span class="identifier">diabetes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_diabetes</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="identifier">digits</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">load_digits</span><span class="grouping">(</span><span class="grouping">)</span>
<span class="identifier">perm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">size</span><span class="grouping">)</span>
<span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>
<span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="arithmetic-assignment">=</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="identifier">perm</span><span class="grouping">]</span>

<span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
<span class="identifier">X_multilabel</span><span class="punctuation">,</span> <span class="identifier">y_multilabel</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_multilabel_classification</span><span class="grouping">(</span>
    <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">30</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>

<span class="comment"># NB: despite their names X_sparse_* are numpy arrays (and not sparse matrices)</span>
<span class="identifier">X_sparse_pos</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">X_sparse_pos</span><span class="grouping">[</span><span class="identifier">X_sparse_pos</span> <span class="relational-operator">&lt;=</span> <span class="float-literal">0.8</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span><span class="punctuation">.</span>
<span class="identifier">y_random</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span>
<span class="identifier">X_sparse_mix</span> <span class="arithmetic-assignment">=</span> <span class="identifier">_sparse_random_matrix</span><span class="grouping">(</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">density</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.25</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="identifier">DATASETS</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span>
    <span class="string-literal">"iris": {"X": iris.data, "y"</span><span class="punctuation">:</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"diabetes": {"X": diabetes.data, "y"</span><span class="punctuation">:</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"digits": {"X": digits.data, "y"</span><span class="punctuation">:</span> <span class="identifier">digits</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"toy": {"X": X, "y"</span><span class="punctuation">:</span> <span class="identifier">y</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"clf_small": {"X": X_small, "y"</span><span class="punctuation">:</span> <span class="identifier">y_small</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"reg_small": {"X": X_small, "y"</span><span class="punctuation">:</span> <span class="identifier">y_small_reg</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"multilabel": {"X": X_multilabel, "y"</span><span class="punctuation">:</span> <span class="identifier">y_multilabel</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"sparse-pos": {"X": X_sparse_pos, "y"</span><span class="punctuation">:</span> <span class="identifier">y_random</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"sparse-neg": {"X": - X_sparse_pos, "y"</span><span class="punctuation">:</span> <span class="identifier">y_random</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"sparse-mix": {"X": X_sparse_mix, "y"</span><span class="punctuation">:</span> <span class="identifier">y_random</span><span class="grouping">}</span><span class="punctuation">,</span>
    <span class="string-literal">"zeros": {"X": np.zeros((20, 3)), "y"</span><span class="punctuation">:</span> <span class="identifier">y_random</span><span class="grouping">}</span>
<span class="grouping">}</span>

<span class="keyword">for</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">DATASETS</span><span class="punctuation">:</span>
    <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X_sparse"] = csc_matrix(DATASETS[name]["X"</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">,</span> <span class="identifier">message</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">node_count</span> <span class="relational-operator">==</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="string-literal">"{0}: inequal number of node ({1} != {2})"</span>
        <span class="string-literal">""</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">message</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="punctuation">,</span>
                       <span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal children_right"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="punctuation">,</span>
                       <span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal children_left"</span><span class="grouping">)</span>

    <span class="identifier">external</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">children_right</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span>
    <span class="identifier">internal</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">logical_not</span><span class="grouping">(</span><span class="identifier">external</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">feature</span><span class="grouping">[</span><span class="identifier">internal</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">feature</span><span class="grouping">[</span><span class="identifier">internal</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal features"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">internal</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">internal</span><span class="grouping">]</span><span class="punctuation">,</span>
                       <span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal threshold"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal sum(n_node_samples)"</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="punctuation">,</span>
                       <span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal n_node_samples"</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="punctuation">,</span>
                        <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal impurity"</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">external</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">external</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="identifier">message</span> <span class="arithmetic-operator">+</span> <span class="string-literal">": inequal value"</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_classification_toy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check classification on a toy dataset.</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="punctuation">,</span>
                           <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="punctuation">,</span>
                           <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_weighted_classification_toy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check classification on a weighted toy dataset.</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="punctuation">,</span>
                           <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="punctuation">,</span>
                           <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Tree"</span><span class="punctuation">,</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"criterion"</span><span class="punctuation">,</span> <span class="identifier">REG_CRITERIONS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_regression_toy</span><span class="grouping">(</span><span class="identifier">Tree</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check regression on a toy dataset.</span>
    <span class="keyword">if</span> <span class="identifier">criterion</span> <span class="relational-operator">==</span> <span class="string-literal">"poisson"</span><span class="punctuation">:</span>
        <span class="comment"># make target positive while not touching the original y and</span>
        <span class="comment"># true_result</span>
        <span class="identifier">a</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">a</span>
        <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">true_result</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">a</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">y_train</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span>
        <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">true_result</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_test</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_xor</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check on a XOR problem</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">5</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>

    <span class="identifier">gridx</span><span class="punctuation">,</span> <span class="identifier">gridy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">indices</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">gridx</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">gridy</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>

        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check consistency on dataset iris.</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">criterion</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">CLF_CRITERIONS</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">accuracy_score</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.9</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"Failed with {0}, criterion = {1} and score = {2}"</span>
            <span class="string-literal">""</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">accuracy_score</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"Failed with {0}, criterion = {1} and score = {2}"</span>
            <span class="string-literal">""</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name, Tree"</span><span class="punctuation">,</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"criterion"</span><span class="punctuation">,</span> <span class="identifier">REG_CRITERIONS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_diabetes_overfit</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check consistency of overfitted trees on the diabetes dataset</span>
    <span class="comment"># since the trees will overfit, we expect an MSE of 0</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_squared_error</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
        <span class="identifier">f</span><span class="string-literal">"Failed with {name}, criterion = {criterion} and score = {score}"</span>
    <span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">skip_if_32bit</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name, Tree"</span><span class="punctuation">,</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"criterion, max_depth, metric, max_loss"</span><span class="punctuation">,</span>
    <span class="grouping">[</span><span class="grouping">(</span><span class="string-literal">"squared_error"</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">mean_squared_error</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">"absolute_error"</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">mean_squared_error</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">"friedman_mse"</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">mean_squared_error</span><span class="punctuation">,</span> <span class="int-literal">60</span><span class="grouping">)</span><span class="punctuation">,</span>
     <span class="grouping">(</span><span class="string-literal">"poisson"</span><span class="punctuation">,</span> <span class="int-literal">15</span><span class="punctuation">,</span> <span class="identifier">mean_poisson_deviance</span><span class="punctuation">,</span> <span class="int-literal">30</span><span class="grouping">)</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_diabetes_underfit</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="punctuation">,</span> <span class="identifier">metric</span><span class="punctuation">,</span> <span class="identifier">max_loss</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># check consistency of trees when the depth and the number of features are</span>
    <span class="comment"># limited</span>

    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span>
        <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="punctuation">,</span>
        <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span>
    <span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">loss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">metric</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="int-literal">0</span> <span class="relational-operator">&lt;</span> <span class="identifier">loss</span> <span class="relational-operator">&lt;</span> <span class="identifier">max_loss</span>


<span class="keyword">def</span> <span class="identifier">test_probability</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Predict probabilities using DecisionTreeClassifier.</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>

        <span class="identifier">prob_predict</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">prob_predict</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argmax</span><span class="grouping">(</span><span class="identifier">prob_predict</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span>
                           <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span>
                            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">8</span><span class="punctuation">,</span>
                            <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_arrayrepr</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check the array representation.</span>
    <span class="comment"># Check resize</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10000</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">10000</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_pure_set</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check when y is pure.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeClassifier</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                           <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeRegressor</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                            <span class="identifier">err_msg</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_numerical_stability</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check numerical stability.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span>
        <span class="grouping">[</span><span class="float-literal">152.08097839</span><span class="punctuation">,</span> <span class="float-literal">140.40744019</span><span class="punctuation">,</span> <span class="float-literal">129.75102234</span><span class="punctuation">,</span> <span class="float-literal">159.90493774</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">142.50700378</span><span class="punctuation">,</span> <span class="float-literal">135.81935120</span><span class="punctuation">,</span> <span class="float-literal">117.82884979</span><span class="punctuation">,</span> <span class="float-literal">162.75781250</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">127.28772736</span><span class="punctuation">,</span> <span class="float-literal">140.40744019</span><span class="punctuation">,</span> <span class="float-literal">129.75102234</span><span class="punctuation">,</span> <span class="float-literal">159.90493774</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">132.37025452</span><span class="punctuation">,</span> <span class="float-literal">143.71923828</span><span class="punctuation">,</span> <span class="float-literal">138.35694885</span><span class="punctuation">,</span> <span class="float-literal">157.84558105</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">103.10237122</span><span class="punctuation">,</span> <span class="float-literal">143.71928406</span><span class="punctuation">,</span> <span class="float-literal">138.35696411</span><span class="punctuation">,</span> <span class="float-literal">157.84559631</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">127.71276855</span><span class="punctuation">,</span> <span class="float-literal">143.71923828</span><span class="punctuation">,</span> <span class="float-literal">138.35694885</span><span class="punctuation">,</span> <span class="float-literal">157.84558105</span><span class="grouping">]</span><span class="punctuation">,</span>
        <span class="grouping">[</span><span class="float-literal">120.91514587</span><span class="punctuation">,</span> <span class="float-literal">140.40744019</span><span class="punctuation">,</span> <span class="float-literal">129.75102234</span><span class="punctuation">,</span> <span class="float-literal">159.90493774</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span>
        <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">0.70209277</span><span class="punctuation">,</span> <span class="float-literal">0.53896582</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">0.90914464</span><span class="punctuation">,</span> <span class="float-literal">0.48026916</span><span class="punctuation">,</span> <span class="float-literal">0.49622521</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">errstate</span><span class="grouping">(</span><span class="identifier">all</span><span class="arithmetic-assignment">=</span><span class="string-literal">"raise"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
            <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_importances</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check variable importances.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">5000</span><span class="punctuation">,</span>
                                        <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                        <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                        <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                        <span class="identifier">n_repeated</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                        <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">Tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span>
        <span class="identifier">n_important</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.1</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="invalid">i</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">s</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">n_important</span> <span class="relational-operator">==</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>

    <span class="comment"># Check on iris that importances are the same for all builders</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                  <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span>
                       <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_importances_raises</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check if variable importance before fit raises ValueError.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">,</span> <span class="string-literal">'feature_importances_'</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_importances_gini_equal_squared_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that gini is equivalent to squared_error for binary output variable</span>

    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">2000</span><span class="punctuation">,</span>
                                        <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                        <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                        <span class="identifier">n_redundant</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                        <span class="identifier">n_repeated</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                                        <span class="identifier">shuffle</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="punctuation">,</span>
                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># The gini index and the mean square error (variance) might differ due</span>
    <span class="comment"># to numerical instability. Since those instabilities mainly occurs at</span>
    <span class="comment"># high tree depth, we restrict this maximal depth.</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"gini"</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                 <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_error"</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                                <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">feature</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">feature</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="punctuation">,</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_max_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check max_features.</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeRegressor</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeRegressor</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="string-literal">"auto"</span><span class="grouping">)</span>
        <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeClassifier</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="string-literal">"auto"</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="string-literal">"sqrt"</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span>
                <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="string-literal">"log2"</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span>
                <span class="identifier">int</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">log2</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="int-literal">3</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.01</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.5</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span>
                <span class="identifier">int</span><span class="grouping">(</span><span class="float-literal">0.5</span> <span class="arithmetic-operator">*</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">max_features_</span> <span class="relational-operator">==</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="comment"># use values of max_features that are invalid</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.5</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="string-literal">"foobar"</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_error</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that it gives proper exception on deficient input.</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># predict before fit</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>  <span class="comment"># wrong feature shape for sample</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">.6</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.51</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">2.5</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># min_impurity_split warning</span>
        <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="identifier">category</span><span class="arithmetic-assignment">=</span><span class="identifier">FutureWarning</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_impurity_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_impurity_decrease</span><span class="arithmetic-assignment">=</span><span class="float-literal">-1.0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># Wrong dimensions</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="grouping">)</span>

        <span class="comment"># Test with arrays that are non-contiguous.</span>
        <span class="identifier">Xf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">Xf</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">true_result</span><span class="grouping">)</span>

        <span class="comment"># predict before fitting</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>

        <span class="comment"># predict on vector with different dims</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">t</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">t</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># wrong sample shape</span>
        <span class="identifier">Xt</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">Xt</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">Xt</span><span class="grouping">)</span>

        <span class="comment"># apply before fitting</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">NotFittedError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>

    <span class="comment"># non positive target for Poisson splitting Criterion</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"poisson"</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"y is not positive.*Poisson"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"Some.*y are negative.*Poisson"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="float-literal">-0.1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_min_samples_split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test min_samples_split parameter"""</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="comment"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="comment"># by setting max_leaf_nodes</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

        <span class="comment"># test for integer parameter</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># count samples on nodes, -1 means it is a leaf</span>
        <span class="identifier">node_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">[</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">!=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">node_samples</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>

        <span class="comment"># test for float parameter</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.2</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="comment"># count samples on nodes, -1 means it is a leaf</span>
        <span class="identifier">node_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">[</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">!=</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>

        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">node_samples</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">9</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_min_samples_leaf</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if leaves contain more than leaf_count training examples</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="comment"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="comment"># by setting max_leaf_nodes</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

        <span class="comment"># test integer parameter</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">node_counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_counts</span><span class="grouping">[</span><span class="identifier">node_counts</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_count</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>

        <span class="comment"># test float parameter</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">node_counts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_count</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_counts</span><span class="grouping">[</span><span class="identifier">node_counts</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_count</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="string-literal">"Failed with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_min_weight_fraction_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">datasets</span><span class="punctuation">,</span> <span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test if leaves contain at least min_weight_fraction_leaf of the
    training set"""</span>
    <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">datasets</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X_sparse"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">datasets</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">datasets</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"y"</span><span class="grouping">]</span>

    <span class="identifier">weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">total_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">weights</span><span class="grouping">)</span>

    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="comment"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="comment"># by setting max_leaf_nodes</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">frac</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">frac</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">node_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">weights</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_weights</span><span class="grouping">[</span><span class="identifier">node_weights</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_weights</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span>
            <span class="identifier">total_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">"Failed with {0} min_weight_fraction_leaf={1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                    <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># test case with no weights passed in</span>
    <span class="identifier">total_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">frac</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">frac</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">node_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_weights</span><span class="grouping">[</span><span class="identifier">node_weights</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_weights</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span>
            <span class="identifier">total_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">"Failed with {0} min_weight_fraction_leaf={1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                    <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_weight_fraction_leaf_on_dense_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_weight_fraction_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"iris"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">SPARSE_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_weight_fraction_leaf_on_sparse_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_weight_fraction_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"multilabel"</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_min_weight_fraction_leaf_with_min_samples_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">datasets</span><span class="punctuation">,</span>
                                                         <span class="identifier">sparse</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test the interaction between min_weight_fraction_leaf and
    min_samples_leaf when sample_weights is not provided in fit."""</span>
    <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">datasets</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X_sparse"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">datasets</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X"</span><span class="grouping">]</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">datasets</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"y"</span><span class="grouping">]</span>

    <span class="identifier">total_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">frac</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># test integer min_samples_leaf</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">frac</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">node_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_weights</span><span class="grouping">[</span><span class="identifier">node_weights</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_weights</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span>
            <span class="identifier">max</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">total_weight</span> <span class="arithmetic-operator">*</span>
                 <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                     <span class="string-literal">"Failed with {0} min_weight_fraction_leaf={1}, "</span>
                     <span class="string-literal">"min_samples_leaf={2}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                         <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="punctuation">,</span>
                         <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_samples_leaf</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">frac</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">linspace</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># test float min_samples_leaf</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">frac</span><span class="punctuation">,</span>
                            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">.1</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">sparse</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">tocsr</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">out</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="identifier">node_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">out</span><span class="grouping">)</span>
        <span class="comment"># drop inner nodes</span>
        <span class="identifier">leaf_weights</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_weights</span><span class="grouping">[</span><span class="identifier">node_weights</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="grouping">(</span>
            <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">leaf_weights</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span>
            <span class="identifier">max</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">total_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="grouping">)</span><span class="punctuation">,</span>
                <span class="grouping">(</span><span class="identifier">total_weight</span> <span class="arithmetic-operator">*</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_samples_leaf</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="string-literal">"Failed with {0} min_weight_fraction_leaf={1}, "</span>
                    <span class="string-literal">"min_samples_leaf={2}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span>
                                                  <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_weight_fraction_leaf</span><span class="punctuation">,</span>
                                                  <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_samples_leaf</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_weight_fraction_leaf_with_min_samples_leaf_on_dense_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_weight_fraction_leaf_with_min_samples_leaf</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"iris"</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">SPARSE_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_weight_fraction_leaf_with_min_samples_leaf_on_sparse_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_weight_fraction_leaf_with_min_samples_leaf</span><span class="grouping">(</span>
            <span class="identifier">name</span><span class="punctuation">,</span> <span class="string-literal">"multilabel"</span><span class="punctuation">,</span> <span class="bool-literal">True</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_min_impurity_split</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test if min_impurity_split creates leaves with impurity</span>
    <span class="comment"># [0, min_impurity_split) when min_samples_leaf = 1 and</span>
    <span class="comment"># min_samples_split = 2.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">n</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="comment"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="comment"># by setting max_leaf_nodes</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
        <span class="identifier">min_impurity_split</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.5</span>

        <span class="comment"># verify leaf nodes without min_impurity_split less than</span>
        <span class="comment"># impurity 1e-7</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_split</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"Failed, min_impurity_split = {0} != None"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_split</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">try</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">except</span> <span class="invalid">A</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">E</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">o</span><span class="invalid">r</span><span class="punctuation">:</span>
            <span class="keyword">pass</span>
        <span class="keyword">for</span> <span class="identifier">node</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span> <span class="logical-operator">or</span>
                    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="string-literal">"Failed with {0} min_impurity_split={1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_split</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="comment"># verify leaf nodes have impurity [0,min_impurity_split] when using</span>
        <span class="comment"># min_impurity_split</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                            <span class="identifier">min_impurity_split</span><span class="arithmetic-assignment">=</span><span class="identifier">min_impurity_split</span><span class="punctuation">,</span>
                            <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">g</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                             <span class="string-literal">"Use the min_impurity_decrease"</span><span class="punctuation">,</span>
                             <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">node</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span> <span class="logical-operator">or</span>
                    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="string-literal">"Failed with {0}, min_impurity_split={1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_split</span><span class="grouping">)</span><span class="grouping">)</span>
                <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">&lt;=</span> <span class="identifier">min_impurity_split</span><span class="punctuation">,</span> <span class="grouping">(</span>
                    <span class="string-literal">"Failed with {0}, min_impurity_split={1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span><span class="punctuation">,</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_split</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_min_impurity_decrease</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># test if min_impurity_decrease ensure that a split is made only if</span>
    <span class="comment"># if the impurity decrease is atleast that value</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_classification</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">10000</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>

    <span class="comment"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="comment"># by setting max_leaf_nodes</span>
    <span class="keyword">for</span> <span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">name</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="grouping">(</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

        <span class="comment"># Check default value of min_impurity_decrease, 1e-7</span>
        <span class="identifier">est1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># Check with explicit value of 0.05</span>
        <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                             <span class="identifier">min_impurity_decrease</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.05</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># Check with a much lower value of 0.0001</span>
        <span class="identifier">est3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                             <span class="identifier">min_impurity_decrease</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0001</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="comment"># Check with a much lower value of 0.1</span>
        <span class="identifier">est4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">max_leaf_nodes</span><span class="punctuation">,</span>
                             <span class="identifier">min_impurity_decrease</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">est</span><span class="punctuation">,</span> <span class="identifier">expected_decrease</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="grouping">(</span><span class="identifier">est1</span><span class="punctuation">,</span> <span class="float-literal">1e-7</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">est2</span><span class="punctuation">,</span> <span class="float-literal">0.05</span><span class="grouping">)</span><span class="punctuation">,</span>
                                       <span class="grouping">(</span><span class="identifier">est3</span><span class="punctuation">,</span> <span class="float-literal">0.0001</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">est4</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_decrease</span> <span class="relational-operator">&lt;=</span> <span class="identifier">expected_decrease</span><span class="punctuation">,</span> <span class="grouping">(</span>
                <span class="string-literal">"Failed, min_impurity_decrease = {0} &gt; {1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span>
                    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">min_impurity_decrease</span><span class="punctuation">,</span>
                    <span class="identifier">expected_decrease</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">node</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="grouping">)</span><span class="punctuation">:</span>
                <span class="comment"># If current node is a not leaf node, check if the split was</span>
                <span class="comment"># justified w.r.t the min_impurity_decrease</span>
                <span class="keyword">if</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="relational-operator">!=</span> <span class="identifier">TREE_LEAF</span><span class="punctuation">:</span>
                    <span class="identifier">imp_parent</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span>
                    <span class="identifier">wtd_n_node</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">weighted_n_node_samples</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span>

                    <span class="identifier">left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span>
                    <span class="identifier">wtd_n_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">weighted_n_node_samples</span><span class="grouping">[</span><span class="identifier">left</span><span class="grouping">]</span>
                    <span class="identifier">imp_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">left</span><span class="grouping">]</span>
                    <span class="identifier">wtd_imp_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">wtd_n_left</span> <span class="arithmetic-operator">*</span> <span class="identifier">imp_left</span>

                    <span class="identifier">right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_right</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span>
                    <span class="identifier">wtd_n_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">weighted_n_node_samples</span><span class="grouping">[</span><span class="identifier">right</span><span class="grouping">]</span>
                    <span class="identifier">imp_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">right</span><span class="grouping">]</span>
                    <span class="identifier">wtd_imp_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">wtd_n_right</span> <span class="arithmetic-operator">*</span> <span class="identifier">imp_right</span>

                    <span class="identifier">wtd_avg_left_right_imp</span> <span class="arithmetic-assignment">=</span> <span class="identifier">wtd_imp_right</span> <span class="arithmetic-operator">+</span> <span class="identifier">wtd_imp_left</span>
                    <span class="identifier">wtd_avg_left_right_imp</span> <span class="arithmetic-assignment">/=</span> <span class="identifier">wtd_n_node</span>

                    <span class="identifier">fractional_node_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span>
                        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">weighted_n_node_samples</span><span class="grouping">[</span><span class="identifier">node</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

                    <span class="identifier">actual_decrease</span> <span class="arithmetic-assignment">=</span> <span class="identifier">fractional_node_weight</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span>
                        <span class="identifier">imp_parent</span> <span class="arithmetic-operator">-</span> <span class="identifier">wtd_avg_left_right_imp</span><span class="grouping">)</span>

                    <span class="keyword">assert</span> <span class="identifier">actual_decrease</span> <span class="relational-operator">&gt;=</span> <span class="identifier">expected_decrease</span><span class="punctuation">,</span> <span class="grouping">(</span>
                        <span class="string-literal">"Failed with {0} expected min_impurity_decrease={1}"</span>
                        <span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">actual_decrease</span><span class="punctuation">,</span>
                                <span class="identifier">expected_decrease</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">if</span> <span class="string-literal">"Classifier"</span> <span class="relational-operator">in</span> <span class="identifier">name</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span>

        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">fitted_attribute</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">attribute</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"max_depth", "node_count", "capacity"</span><span class="grouping">]</span><span class="punctuation">:</span>
            <span class="identifier">fitted_attribute</span><span class="grouping">[</span><span class="identifier">attribute</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">attribute</span><span class="grouping">)</span>

        <span class="identifier">serialized_object</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>
        <span class="identifier">est2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">serialized_object</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">type</span><span class="grouping">(</span><span class="identifier">est2</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">__class__</span>
        <span class="identifier">score2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">score</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">score</span> <span class="relational-operator">==</span> <span class="identifier">score2</span><span class="punctuation">,</span> <span class="grouping">(</span>
            <span class="string-literal">"Failed to generate same score  after pickling "</span>
            <span class="string-literal">"with {0}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">attribute</span> <span class="relational-operator">in</span> <span class="identifier">fitted_attribute</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">est2</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">attribute</span><span class="grouping">)</span> <span class="relational-operator">==</span>
                    <span class="identifier">fitted_attribute</span><span class="grouping">[</span><span class="identifier">attribute</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="grouping">(</span>
                        <span class="string-literal">"Failed to generate same attribute {0} after "</span>
                        <span class="string-literal">"pickling with {1}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">attribute</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_multioutput</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check estimators on multi-output problems.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="identifier">T</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y_true</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>

    <span class="comment"># toy classification problem</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeClassifier</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y_hat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_hat</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">y_hat</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>

        <span class="identifier">proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">proba</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="keyword">assert</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>

        <span class="identifier">log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">log_proba</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">log_proba</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span>

    <span class="comment"># toy regression problem</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeRegressor</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">y_hat</span> <span class="arithmetic-assignment">=</span> <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">T</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">y_hat</span><span class="punctuation">,</span> <span class="identifier">y_true</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">y_hat</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_classes_shape</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that n_classes_ and classes_ have proper shape.</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeClassifier</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># Classification, single output</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_classes_</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="comment"># Classification, multi-output</span>
        <span class="identifier">_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_classes_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">n_classes_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_unbalanced_iris</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check class rebalancing.</span>
    <span class="identifier">unbalanced_X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">125</span><span class="grouping">]</span>
    <span class="identifier">unbalanced_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">125</span><span class="grouping">]</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">compute_sample_weight</span><span class="grouping">(</span><span class="string-literal">"balanced"</span><span class="punctuation">,</span> <span class="identifier">unbalanced_y</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeClassifier</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">unbalanced_X</span><span class="punctuation">,</span> <span class="identifier">unbalanced_y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">unbalanced_X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">unbalanced_y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_memory_layout</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check that it works no matter the memory layout</span>
    <span class="keyword">for</span> <span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                <span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

        <span class="comment"># Nothing</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># C-order</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"C"</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># F-order</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">order</span><span class="arithmetic-assignment">=</span><span class="string-literal">"F"</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># Contiguous</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">u</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># csr matrix</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># csc_matrix</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="comment"># Strided</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">dtype</span><span class="grouping">)</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="int-literal">3</span><span class="grouping">]</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sample_weight</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check sample weighting.</span>
    <span class="comment"># Test that zero-weighted samples are not taken into account</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Test that low weighted samples are not taken into account at low depth</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">200</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="int-literal">200</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">50</span><span class="punctuation">:</span><span class="int-literal">100</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">:</span><span class="int-literal">200</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>
    <span class="identifier">X</span><span class="grouping">[</span><span class="int-literal">100</span><span class="punctuation">:</span><span class="int-literal">200</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">200</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">200</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.51</span>  <span class="comment"># Samples of class '2' are still weightier</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="float-literal">149.5</span>

    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">y</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">.5</span>  <span class="comment"># Samples of class '2' are no longer weightier</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">==</span> <span class="float-literal">49.5</span>  <span class="comment"># Threshold should have moved</span>

    <span class="comment"># Test that sample weighting is the same as having duplicates</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="identifier">duplicates</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="int-literal">100</span><span class="grouping">)</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="identifier">duplicates</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="identifier">duplicates</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">bincount</span><span class="grouping">(</span><span class="identifier">duplicates</span><span class="punctuation">,</span> <span class="identifier">minlength</span><span class="arithmetic-assignment">=</span><span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>

    <span class="identifier">internal</span> <span class="arithmetic-assignment">=</span> <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">!=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">TREE_LEAF</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">internal</span><span class="grouping">]</span><span class="punctuation">,</span>
                              <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">internal</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_sample_weight_invalid</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Check sample weighting raises errors.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">newaxis</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">100</span><span class="grouping">)</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">50</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="float-literal">0.0</span>

    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>

    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">expected_err</span> <span class="arithmetic-assignment">=</span> <span class="identifier">r</span><span class="string-literal">"Singleton.* cannot be considered a valid collection"</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">expected_err</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_class_weights</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check class_weights resemble sample_weights behavior."""</span>
    <span class="identifier">TreeClassifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CLF_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="comment"># Iris is balanced, so no effect expected for using 'balanced' weights</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="comment"># Make a multi-output problem with three copies of Iris</span>
    <span class="identifier">iris_multi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>
    <span class="comment"># Create user-defined weights that should balance over the outputs</span>
    <span class="identifier">clf3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span><span class="punctuation">,</span>
                                        <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">}</span><span class="punctuation">,</span>
                                        <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">2</span><span class="punctuation">.</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris_multi</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>
    <span class="comment"># Check against multi-output "auto" which should also have no effect</span>
    <span class="identifier">clf4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'balanced'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf4</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris_multi</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf3</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf4</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="comment"># Inflate importance of class 1, check against user-defined weights</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">)</span>
    <span class="identifier">sample_weight</span><span class="grouping">[</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span> <span class="relational-operator">==</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-assignment">*=</span> <span class="int-literal">100</span>
    <span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span> <span class="arithmetic-assignment">=</span> <span class="grouping">{</span><span class="int-literal">0</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">100</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>

    <span class="comment"># Check that sample_weight and class_weight are multiplicative</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span> <span class="arithmetic-operator">**</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">feature_importances_</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">CLF_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weights</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_class_weights</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_class_weight_errors</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if class_weight raises errors and warnings when expected.</span>
    <span class="identifier">TreeClassifier</span> <span class="arithmetic-assignment">=</span> <span class="identifier">CLF_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">_y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">T</span>

    <span class="comment"># Invalid preset string</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="string-literal">'the larch'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>

    <span class="comment"># Not a list or preset for multi-output</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>

    <span class="comment"># Incorrect length list for multi-output</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeClassifier</span><span class="grouping">(</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">w</span><span class="invalid">e</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">h</span><span class="invalid">t</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">{</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">:</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">:</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">}</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">_y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">CLF_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_class_weight_errors</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_class_weight_errors</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_max_leaf_nodes</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test greedy trees with max_depth + 1 leafs.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">k</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">get_n_leaves</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">k</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span>

        <span class="comment"># max_leaf_nodes in (0, 1) should raise ValueError</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.1</span><span class="grouping">)</span>
        <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_max_leaf_nodes_max_depth</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test precedence of max_leaf_nodes over max_depth.</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_hastie_10_2</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">k</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">k</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">get_depth</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>


<span class="keyword">def</span> <span class="identifier">test_arrays_persist</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Ensure property arrays' memory stays alive when tree disappears</span>
    <span class="comment"># non-regression for #2726</span>
    <span class="keyword">for</span> <span class="identifier">attr</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'n_classes', 'value', 'children_left', 'children_right'</span><span class="punctuation">,</span>
                 <span class="string-literal">'threshold', 'impurity', 'feature', 'n_node_samples'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">value</span> <span class="arithmetic-assignment">=</span> <span class="identifier">getattr</span><span class="grouping">(</span><span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                                                     <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">attr</span><span class="grouping">)</span>
        <span class="comment"># if pointing to freed memory, contents may be arbitrary</span>
        <span class="keyword">assert</span> <span class="arithmetic-operator">-</span><span class="int-literal">3</span> <span class="relational-operator">&lt;=</span> <span class="identifier">value</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="relational-operator">&lt;</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="invalid">\</span>
            <span class="string-literal">'Array points to arbitrary memory'</span>


<span class="keyword">def</span> <span class="identifier">test_only_constant_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">20</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">test_behaviour_constant_feature_after_splits</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">transpose</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">vstack</span><span class="grouping">(</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span>
                               <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">ALL_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment"># do not check extra random trees</span>
        <span class="keyword">if</span> <span class="string-literal">"ExtraTree"</span> <span class="logical-operator">not</span> <span class="relational-operator">in</span> <span class="identifier">name</span><span class="punctuation">:</span>
            <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
            <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">2</span>
            <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span> <span class="relational-operator">==</span> <span class="int-literal">5</span>


<span class="keyword">def</span> <span class="identifier">test_with_only_one_non_constant_features</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">hstack</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">,</span>
                   <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">1000</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">TreeEstimator</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">full</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_big_input</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test if the warning for too large inputs is appropriate.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">repeat</span><span class="grouping">(</span><span class="int-literal">10</span> <span class="arithmetic-operator">**</span> <span class="int-literal">40</span><span class="punctuation">.</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float64</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">try</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="keyword">except</span> <span class="identifier">ValueError</span> <span class="keyword">as</span> <span class="identifier">e</span><span class="punctuation">:</span>
        <span class="keyword">assert</span> <span class="string-literal">"float32"</span> <span class="relational-operator">in</span> <span class="identifier">str</span><span class="grouping">(</span><span class="identifier">e</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_realloc</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">from</span> <span class="identifier">sklearn</span><span class="punctuation">.</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_utils</span> <span class="keyword">import</span> <span class="identifier">_realloc_test</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">MemoryError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">_realloc_test</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_huge_allocations</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">n_bits</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">8</span> <span class="arithmetic-operator">*</span> <span class="identifier">struct</span><span class="punctuation">.</span><span class="identifier">calcsize</span><span class="grouping">(</span><span class="string-literal">"P"</span><span class="grouping">)</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">10</span><span class="grouping">)</span>

    <span class="comment"># Sanity check: we cannot request more memory than the size of the address</span>
    <span class="comment"># space. Currently raises OverflowError.</span>
    <span class="identifier">huge</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="grouping">(</span><span class="identifier">n_bits</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">splitter</span><span class="arithmetic-assignment">=</span><span class="string-literal">'best'</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">huge</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="invalid">E</span><span class="invalid">x</span><span class="invalid">c</span><span class="invalid">e</span><span class="invalid">p</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">o</span><span class="invalid">n</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="comment"># Non-regression test: MemoryError used to be dropped by Cython</span>
    <span class="comment"># because of missing "except *".</span>
    <span class="identifier">huge</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="grouping">(</span><span class="identifier">n_bits</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">splitter</span><span class="arithmetic-assignment">=</span><span class="string-literal">'best'</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="identifier">huge</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">MemoryError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_sparse_input</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">tree</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X"</span><span class="grouping">]</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X_sparse"</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"y"</span><span class="grouping">]</span>

    <span class="comment"># Gain testing time</span>
    <span class="keyword">if</span> <span class="identifier">dataset</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">"digits", "diabetes"</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">5</span>
        <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
        <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>
        <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="grouping">]</span>

    <span class="keyword">for</span> <span class="identifier">sparse_format</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">coo_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_format</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="grouping">)</span>

        <span class="comment"># Check the default (depth first search)</span>
        <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                          <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                          <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="identifier">y_pred</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">:</span>
            <span class="identifier">y_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
            <span class="identifier">y_log_proba</span> <span class="arithmetic-assignment">=</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">sparse_matrix</span> <span class="relational-operator">in</span> <span class="grouping">(</span><span class="identifier">csr_matrix</span><span class="punctuation">,</span> <span class="identifier">csc_matrix</span><span class="punctuation">,</span> <span class="identifier">coo_matrix</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">X_sparse_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">sparse_matrix</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>

            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_sparse_test</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y_pred</span><span class="grouping">)</span>

            <span class="keyword">if</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">:</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X_sparse_test</span><span class="grouping">)</span><span class="punctuation">,</span>
                                          <span class="identifier">y_proba</span><span class="grouping">)</span>
                <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict_log_proba</span><span class="grouping">(</span><span class="identifier">X_sparse_test</span><span class="grouping">)</span><span class="punctuation">,</span>
                                          <span class="identifier">y_log_proba</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"tree_type"</span><span class="punctuation">,</span> <span class="identifier">SPARSE_TREES</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
        <span class="string-literal">"dataset"</span><span class="punctuation">,</span>
        <span class="grouping">(</span><span class="string-literal">"clf_small", "toy", "digits", "multilabel"</span><span class="punctuation">,</span>
         <span class="string-literal">"sparse-pos", "sparse-neg", "sparse-mix"</span><span class="punctuation">,</span>
         <span class="string-literal">"zeros"</span><span class="grouping">)</span>
<span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sparse_input</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">max_depth</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span> <span class="keyword">if</span> <span class="identifier">dataset</span> <span class="relational-operator">==</span> <span class="string-literal">"digits"</span> <span class="keyword">else</span> <span class="none-literal">None</span>
    <span class="identifier">check_sparse_input</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"tree_type"</span><span class="punctuation">,</span>
                         <span class="identifier">sorted</span><span class="grouping">(</span><span class="identifier">set</span><span class="grouping">(</span><span class="identifier">SPARSE_TREES</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">intersection</span><span class="grouping">(</span><span class="identifier">REG_TREES</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dataset", ["diabetes", "reg_small"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sparse_input_reg_trees</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Due to numerical instability of MSE and too strict test, we limit the</span>
    <span class="comment"># maximal depth</span>
    <span class="identifier">check_sparse_input</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_sparse_parameters</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">tree</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X"</span><span class="grouping">]</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X_sparse"</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"y"</span><span class="grouping">]</span>

    <span class="comment"># Check max_features</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                      <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                      <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                      <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check min_samples_split</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                      <span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                      <span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                      <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                      <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check min_samples_leaf</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                      <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span>
                      <span class="identifier">min_samples_leaf</span><span class="arithmetic-assignment">=</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                      <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                      <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Check best-first search</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                      <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                      <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_sparse_criterion</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">tree</span><span class="grouping">]</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X"</span><span class="grouping">]</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"X_sparse"</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span><span class="grouping">[</span><span class="string-literal">"y"</span><span class="grouping">]</span>

    <span class="comment"># Check various criterion</span>
    <span class="identifier">CRITERIONS</span> <span class="arithmetic-assignment">=</span> <span class="identifier">REG_CRITERIONS</span> <span class="keyword">if</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">REG_TREES</span> <span class="keyword">else</span> <span class="identifier">CLF_CRITERIONS</span>
    <span class="keyword">for</span> <span class="identifier">criterion</span> <span class="relational-operator">in</span> <span class="identifier">CRITERIONS</span><span class="punctuation">:</span>
        <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                          <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                          <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                          <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                          <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"tree_type"</span><span class="punctuation">,</span> <span class="identifier">SPARSE_TREES</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dataset"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="string-literal">"sparse-pos", "sparse-neg", "sparse-mix", "zeros"</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"check"</span><span class="punctuation">,</span>
                         <span class="grouping">[</span><span class="identifier">check_sparse_parameters</span><span class="punctuation">,</span> <span class="identifier">check_sparse_criterion</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_sparse</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="punctuation">,</span> <span class="identifier">check</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_explicit_sparse_zeros</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                                <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">tree</span><span class="grouping">]</span>

    <span class="comment"># n_samples set n_feature to ease construction of a simultaneous</span>
    <span class="comment"># construction of a csr and csc matrix</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_features</span>
    <span class="identifier">samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>

    <span class="comment"># Generate X, y</span>
    <span class="identifier">random_state</span> <span class="arithmetic-assignment">=</span> <span class="identifier">check_random_state</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="identifier">offset</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="identifier">indptr</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">offset</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">n_features</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">n_nonzero_i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
        <span class="identifier">indices_i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">permutation</span><span class="grouping">(</span><span class="identifier">samples</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_nonzero_i</span><span class="grouping">]</span>
        <span class="identifier">indices</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">indices_i</span><span class="grouping">)</span>
        <span class="identifier">data_i</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">binomial</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_nonzero_i</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="int-literal">1</span>
        <span class="identifier">data</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">data_i</span><span class="grouping">)</span>
        <span class="identifier">offset</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">n_nonzero_i</span>
        <span class="identifier">indptr</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">offset</span><span class="grouping">)</span>

    <span class="identifier">indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">indices</span><span class="grouping">)</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="identifier">data</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">float32</span><span class="grouping">)</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span>
                          <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_sparse_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">indices</span><span class="punctuation">,</span> <span class="identifier">indptr</span><span class="grouping">)</span><span class="punctuation">,</span>
                               <span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse_test</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">random_state</span><span class="punctuation">.</span><span class="identifier">randint</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Ensure that X_sparse_test owns its data, indices and indptr array</span>
    <span class="identifier">X_sparse_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_sparse_test</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="comment"># Ensure that we have explicit zeros</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>
    <span class="keyword">assert</span> <span class="grouping">(</span><span class="identifier">X_sparse_test</span><span class="punctuation">.</span><span class="identifier">data</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">.</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span>

    <span class="comment"># Perform the comparison</span>
    <span class="identifier">d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">s</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="identifier">max_depth</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_sparse</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span>
                      <span class="string-literal">"{0} with dense and sparse format gave different "</span>
                      <span class="string-literal">"trees"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">tree</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">Xs</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">X_sparse_test</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">X1</span><span class="punctuation">,</span> <span class="identifier">X2</span> <span class="relational-operator">in</span> <span class="identifier">product</span><span class="grouping">(</span><span class="identifier">Xs</span><span class="punctuation">,</span> <span class="identifier">Xs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                                  <span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="identifier">tree</span> <span class="relational-operator">in</span> <span class="identifier">CLF_TREES</span><span class="punctuation">:</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">s</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X1</span><span class="grouping">)</span><span class="punctuation">,</span>
                                      <span class="identifier">d</span><span class="punctuation">.</span><span class="identifier">predict_proba</span><span class="grouping">(</span><span class="identifier">X2</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"tree_type"</span><span class="punctuation">,</span> <span class="identifier">SPARSE_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_explicit_sparse_zeros</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_explicit_sparse_zeros</span><span class="grouping">(</span><span class="identifier">tree_type</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">ignore_warnings</span>
<span class="keyword">def</span> <span class="identifier">check_raise_error_on_1d_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">ravel</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">X_2d</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_2d</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_1d_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">with</span> <span class="identifier">ignore_warnings</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">check_raise_error_on_1d_input</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">_check_min_weight_leaf_split_level</span><span class="grouping">(</span><span class="identifier">TreeEstimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">1</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">min_weight_fraction_leaf</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.4</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="keyword">def</span> <span class="identifier">check_min_weight_leaf_split_level</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">sample_weight</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span>
    <span class="identifier">_check_min_weight_leaf_split_level</span><span class="grouping">(</span><span class="identifier">TreeEstimator</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="grouping">)</span>

    <span class="identifier">_check_min_weight_leaf_split_level</span><span class="grouping">(</span><span class="identifier">TreeEstimator</span><span class="punctuation">,</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span>
                                       <span class="identifier">sample_weight</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_min_weight_leaf_split_level</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_min_weight_leaf_split_level</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_public_apply</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_small32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_small</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="punctuation">,</span> <span class="identifier">y_small</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X_small32</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_public_apply_sparse</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_small32</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="punctuation">,</span> <span class="identifier">y_small</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X_small32</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_public_apply_all_trees</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_public_apply</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">SPARSE_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_public_apply_sparse_trees</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_public_apply_sparse</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_decision_path_hardcoded</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">node_indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">node_indicator</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_decision_path</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">data</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">iris</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>

    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">max_depth</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">node_indicator_csr</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">node_indicator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_indicator_csr</span><span class="punctuation">.</span><span class="identifier">toarray</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">node_indicator</span><span class="punctuation">.</span><span class="identifier">shape</span> <span class="relational-operator">==</span> <span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span><span class="grouping">)</span>

    <span class="comment"># Assert that leaves index are correct</span>
    <span class="identifier">leaves</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
    <span class="identifier">leave_indicator</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">node_indicator</span><span class="grouping">[</span><span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">i</span><span class="punctuation">,</span> <span class="identifier">j</span> <span class="relational-operator">in</span> <span class="identifier">enumerate</span><span class="grouping">(</span><span class="identifier">leaves</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">leave_indicator</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Ensure only one leave node per sample</span>
    <span class="identifier">all_leaves</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">dot</span><span class="grouping">(</span><span class="identifier">node_indicator</span><span class="punctuation">,</span> <span class="identifier">all_leaves</span><span class="grouping">)</span><span class="punctuation">,</span>
                              <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="identifier">n_samples</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="comment"># Ensure max depth is consistent with sum of indicator</span>
    <span class="identifier">max_depth</span> <span class="arithmetic-assignment">=</span> <span class="identifier">node_indicator</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">&lt;=</span> <span class="identifier">max_depth</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_decision_path</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_decision_path</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_no_sparse_y_support</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">X_multilabel</span><span class="punctuation">,</span> <span class="identifier">csr_matrix</span><span class="grouping">(</span><span class="identifier">y_multilabel</span><span class="grouping">)</span>
    <span class="identifier">TreeEstimator</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span>
    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">TypeError</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_no_sparse_y_support</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Currently we don't support sparse y</span>
    <span class="identifier">check_no_sparse_y_support</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_mae</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Check MAE criterion produces correct results on small toy dataset:

    ------------------
    | X | y | weight |
    ------------------
    | 3 | 3 |  0.1   |
    | 5 | 3 |  0.3   |
    | 8 | 4 |  1.0   |
    | 3 | 6 |  0.6   |
    | 5 | 7 |  0.3   |
    ------------------
    |sum wt:|  2.3   |
    ------------------

    Because we are dealing with sample weights, we cannot find the median by
    simply choosing/averaging the centre value(s), instead we consider the
    median where 50% of the cumulative weight is found (in a y sorted data set)
    . Therefore with regards to this test data, the cumulative weight is &gt;= 50%
    when y = 4.  Therefore:
    Median = 4

    For all the samples, we can get the total error by summing:
    Absolute(Median - y) * weight

    I.e., total error = (Absolute(4 - 3) * 0.1)
                      + (Absolute(4 - 3) * 0.3)
                      + (Absolute(4 - 4) * 1.0)
                      + (Absolute(4 - 6) * 0.6)
                      + (Absolute(4 - 7) * 0.3)
                      = 2.5

    Impurity = Total error / total weight
             = 2.5 / 2.3
             = 1.08695652173913
             ------------------

    From this root node, the next best split is between X values of 3 and 5.
    Thus, we have left and right child nodes:

    LEFT                    RIGHT
    ------------------      ------------------
    | X | y | weight |      | X | y | weight |
    ------------------      ------------------
    | 3 | 3 |  0.1   |      | 5 | 3 |  0.3   |
    | 3 | 6 |  0.6   |      | 8 | 4 |  1.0   |
    ------------------      | 5 | 7 |  0.3   |
    |sum wt:|  0.7   |      ------------------
    ------------------      |sum wt:|  1.6   |
                            ------------------

    Impurity is found in the same way:
    Left node Median = 6
    Total error = (Absolute(6 - 3) * 0.1)
                + (Absolute(6 - 6) * 0.6)
                = 0.3

    Left Impurity = Total error / total weight
            = 0.3 / 0.7
            = 0.428571428571429
            -------------------

    Likewise for Right node:
    Right node Median = 4
    Total error = (Absolute(4 - 3) * 0.3)
                + (Absolute(4 - 4) * 1.0)
                + (Absolute(4 - 7) * 0.3)
                = 1.2

    Right Impurity = Total error / total weight
            = 1.2 / 1.6
            = 0.75
            ------
    """</span>
    <span class="identifier">dt_mae</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"absolute_error"</span><span class="punctuation">,</span>
                                   <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span>

    <span class="comment"># Test MAE where sample weights are non-uniform (as illustrated above):</span>
    <span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="float-literal">0.6</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="punctuation">,</span> <span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="float-literal">0.3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">2.5</span> <span class="arithmetic-operator">/</span> <span class="float-literal">2.3</span><span class="punctuation">,</span> <span class="float-literal">0.3</span> <span class="arithmetic-operator">/</span> <span class="float-literal">0.7</span><span class="punctuation">,</span> <span class="float-literal">1.2</span> <span class="arithmetic-operator">/</span> <span class="float-literal">1.6</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">value</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">4.0</span><span class="punctuation">,</span> <span class="float-literal">6.0</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Test MAE where all sample weights are uniform:</span>
    <span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
               <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">4.0</span> <span class="arithmetic-operator">/</span> <span class="float-literal">3.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">value</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="float-literal">4.5</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># Test MAE where a `sample_weight` is not explicitly provided.</span>
    <span class="comment"># This is equivalent to providing uniform sample weights, though</span>
    <span class="comment"># the internal logic is different:</span>
    <span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">8</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">5</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">6</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="float-literal">1.4</span><span class="punctuation">,</span> <span class="float-literal">1.5</span><span class="punctuation">,</span> <span class="float-literal">4.0</span> <span class="arithmetic-operator">/</span> <span class="float-literal">3.0</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">dt_mae</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">value</span><span class="punctuation">.</span><span class="identifier">flat</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="float-literal">4.5</span><span class="punctuation">,</span> <span class="float-literal">4.0</span><span class="grouping">]</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_criterion_copy</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Let's check whether copy of our criterion has the same type</span>
    <span class="comment"># and properties as original</span>
    <span class="identifier">n_outputs</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">3</span>
    <span class="identifier">n_classes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">arange</span><span class="grouping">(</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">intp</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">100</span>

    <span class="keyword">def</span> <span class="identifier">_pickle_copy</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="keyword">return</span> <span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">loads</span><span class="grouping">(</span><span class="identifier">pickle</span><span class="punctuation">.</span><span class="identifier">dumps</span><span class="grouping">(</span><span class="identifier">obj</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">copy_func</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">copy</span><span class="punctuation">,</span> <span class="identifier">copy</span><span class="punctuation">.</span><span class="identifier">deepcopy</span><span class="punctuation">,</span> <span class="identifier">_pickle_copy</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">typename</span> <span class="relational-operator">in</span> <span class="identifier">CRITERIA_CLF</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">criteria</span> <span class="arithmetic-assignment">=</span> <span class="identifier">typename</span><span class="grouping">(</span><span class="identifier">n_outputs</span><span class="punctuation">,</span> <span class="identifier">n_classes</span><span class="grouping">)</span>
            <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copy_func</span><span class="grouping">(</span><span class="identifier">criteria</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__reduce__</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">typename_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_outputs_</span><span class="punctuation">,</span> <span class="identifier">n_classes_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">result</span>
            <span class="keyword">assert</span> <span class="identifier">typename</span> <span class="relational-operator">==</span> <span class="identifier">typename_</span>
            <span class="keyword">assert</span> <span class="identifier">n_outputs</span> <span class="relational-operator">==</span> <span class="identifier">n_outputs_</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">n_classes</span><span class="punctuation">,</span> <span class="identifier">n_classes_</span><span class="grouping">)</span>

        <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">typename</span> <span class="relational-operator">in</span> <span class="identifier">CRITERIA_REG</span><span class="punctuation">.</span><span class="identifier">items</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">criteria</span> <span class="arithmetic-assignment">=</span> <span class="identifier">typename</span><span class="grouping">(</span><span class="identifier">n_outputs</span><span class="punctuation">,</span> <span class="identifier">n_samples</span><span class="grouping">)</span>
            <span class="identifier">result</span> <span class="arithmetic-assignment">=</span> <span class="identifier">copy_func</span><span class="grouping">(</span><span class="identifier">criteria</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__reduce__</span><span class="grouping">(</span><span class="grouping">)</span>
            <span class="identifier">typename_</span><span class="punctuation">,</span> <span class="grouping">(</span><span class="identifier">n_outputs_</span><span class="punctuation">,</span> <span class="identifier">n_samples_</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">result</span>
            <span class="keyword">assert</span> <span class="identifier">typename</span> <span class="relational-operator">==</span> <span class="identifier">typename_</span>
            <span class="keyword">assert</span> <span class="identifier">n_outputs</span> <span class="relational-operator">==</span> <span class="identifier">n_outputs_</span>
            <span class="keyword">assert</span> <span class="identifier">n_samples</span> <span class="relational-operator">==</span> <span class="identifier">n_samples_</span>


<span class="keyword">def</span> <span class="identifier">test_empty_leaf_infinite_threshold</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># try to make empty leaf by using near infinite value.</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">randn</span><span class="grouping">(</span><span class="int-literal">100</span><span class="punctuation">,</span> <span class="int-literal">11</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="float-literal">2e38</span>
    <span class="identifier">data</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">nan_to_num</span><span class="grouping">(</span><span class="identifier">data</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="string-literal">'float32'</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_full</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="identifier">X_sparse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">csc_matrix</span><span class="grouping">(</span><span class="identifier">X_full</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">data</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">X</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="identifier">X_full</span><span class="punctuation">,</span> <span class="identifier">X_sparse</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">terminal_regions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">apply</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span>
        <span class="identifier">left_leaf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">set</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">children_left</span> <span class="relational-operator">==</span> <span class="identifier">TREE_LEAF</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">empty_leaf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">left_leaf</span><span class="punctuation">.</span><span class="identifier">difference</span><span class="grouping">(</span><span class="identifier">terminal_regions</span><span class="grouping">)</span>
        <span class="identifier">infinite_threshold</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="bitwise-operator">~</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">isfinite</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">infinite_threshold</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">empty_leaf</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"criterion"</span><span class="punctuation">,</span> <span class="identifier">CLF_CRITERIONS</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"dataset", sorted(set(DATASETS.keys()) - {"reg_small", "diabetes"</span><span class="grouping">}</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"tree_cls"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">DecisionTreeClassifier</span><span class="punctuation">,</span> <span class="identifier">ExtraTreeClassifier</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_prune_tree_classifier_are_subtrees</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="punctuation">,</span> <span class="identifier">tree_cls</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="grouping">[</span><span class="string-literal">"X"], dataset["y"</span><span class="grouping">]</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree_cls</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">cost_complexity_pruning_path</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">pruning_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">info</span><span class="punctuation">.</span><span class="identifier">ccp_alphas</span>
    <span class="identifier">impurities</span> <span class="arithmetic-assignment">=</span> <span class="identifier">info</span><span class="punctuation">.</span><span class="identifier">impurities</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">pruning_path</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">impurities</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree_cls</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">pruning_path</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"criterion"</span><span class="punctuation">,</span> <span class="identifier">REG_CRITERIONS</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"dataset"</span><span class="punctuation">,</span> <span class="identifier">DATASETS</span><span class="punctuation">.</span><span class="identifier">keys</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"tree_cls"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">DecisionTreeRegressor</span><span class="punctuation">,</span> <span class="identifier">ExtraTreeRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_prune_tree_regression_are_subtrees</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">dataset</span><span class="punctuation">,</span> <span class="identifier">tree_cls</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">dataset</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DATASETS</span><span class="grouping">[</span><span class="identifier">dataset</span><span class="grouping">]</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dataset</span><span class="grouping">[</span><span class="string-literal">"X"], dataset["y"</span><span class="grouping">]</span>

    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree_cls</span><span class="grouping">(</span><span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">info</span> <span class="arithmetic-assignment">=</span> <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">cost_complexity_pruning_path</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">pruning_path</span> <span class="arithmetic-assignment">=</span> <span class="identifier">info</span><span class="punctuation">.</span><span class="identifier">ccp_alphas</span>
    <span class="identifier">impurities</span> <span class="arithmetic-assignment">=</span> <span class="identifier">info</span><span class="punctuation">.</span><span class="identifier">impurities</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">pruning_path</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">diff</span><span class="grouping">(</span><span class="identifier">impurities</span><span class="grouping">)</span> <span class="relational-operator">&gt;=</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree_cls</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">pruning_path</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_prune_single_node_tree</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># single node tree</span>
    <span class="identifier">clf1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="comment"># pruned single node tree</span>
    <span class="identifier">clf2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">ccp_alpha</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="grouping">)</span>
    <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>

    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">clf1</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">clf2</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">p</span><span class="invalid">r</span><span class="invalid">u</span><span class="invalid">n</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">g</span><span class="invalid">_</span><span class="invalid">c</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">a</span><span class="invalid">t</span><span class="invalid">e</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">estimator_cls</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">pruning_path</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># generate trees with increasing alphas</span>
    <span class="identifier">estimators</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">]</span>
    <span class="keyword">for</span> <span class="identifier">ccp_alpha</span> <span class="relational-operator">in</span> <span class="identifier">pruning_path</span><span class="punctuation">:</span>
        <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">estimator_cls</span><span class="grouping">(</span>
            <span class="identifier">max_leaf_nodes</span><span class="arithmetic-assignment">=</span><span class="int-literal">20</span><span class="punctuation">,</span> <span class="identifier">ccp_alpha</span><span class="arithmetic-assignment">=</span><span class="identifier">ccp_alpha</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
        <span class="identifier">estimators</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">est</span><span class="grouping">)</span>

    <span class="comment"># A pruned tree must be a subtree of the previous tree (which had a</span>
    <span class="comment"># smaller ccp_alpha)</span>
    <span class="keyword">for</span> <span class="identifier">prev_est</span><span class="punctuation">,</span> <span class="identifier">next_est</span> <span class="relational-operator">in</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">estimators</span><span class="punctuation">,</span> <span class="identifier">estimators</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">prev_est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">,</span> <span class="identifier">next_est</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">_</span><span class="invalid">s</span><span class="invalid">u</span><span class="invalid">b</span><span class="invalid">t</span><span class="invalid">r</span><span class="invalid">e</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">subtree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="keyword">assert</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">node_count</span> <span class="relational-operator">&gt;=</span> <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">node_count</span>
    <span class="keyword">assert</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">max_depth</span> <span class="relational-operator">&gt;=</span> <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">max_depth</span>

    <span class="identifier">tree_c_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">children_left</span>
    <span class="identifier">tree_c_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">children_right</span>
    <span class="identifier">subtree_c_left</span> <span class="arithmetic-assignment">=</span> <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">children_left</span>
    <span class="identifier">subtree_c_right</span> <span class="arithmetic-assignment">=</span> <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">children_right</span>

    <span class="identifier">stack</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span>
    <span class="keyword">while</span> <span class="identifier">stack</span><span class="punctuation">:</span>
        <span class="identifier">tree_node_idx</span><span class="punctuation">,</span> <span class="identifier">subtree_node_idx</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stack</span><span class="punctuation">.</span><span class="identifier">pop</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                                  <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">value</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">impurity</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">n_node_samples</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">weighted_n_node_samples</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                            <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">weighted_n_node_samples</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">if</span> <span class="grouping">(</span><span class="identifier">subtree_c_left</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span> <span class="relational-operator">==</span>
                <span class="identifier">subtree_c_right</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="comment"># is a leaf</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">TREE_UNDEFINED</span><span class="punctuation">,</span>
                                <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="comment"># not a leaf</span>
            <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">subtree</span><span class="punctuation">.</span><span class="identifier">threshold</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">stack</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">tree_c_left</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="identifier">subtree_c_left</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="identifier">stack</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">tree_c_right</span><span class="grouping">[</span><span class="identifier">tree_node_idx</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="identifier">subtree_c_right</span><span class="grouping">[</span><span class="identifier">subtree_node_idx</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_prune_tree_raises_negative_ccp_alpha</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">clf</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeClassifier</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">msg</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"ccp_alpha must be greater than or equal to 0"</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">ccp_alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">-1.0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">ccp_alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.0</span><span class="grouping">)</span>
    <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">i</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">s</span><span class="grouping">(</span><span class="identifier">ValueError</span><span class="punctuation">,</span> <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">msg</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">set_params</span><span class="grouping">(</span><span class="identifier">ccp_alpha</span><span class="arithmetic-assignment">=</span><span class="float-literal">-1.0</span><span class="grouping">)</span>
        <span class="identifier">clf</span><span class="punctuation">.</span><span class="identifier">_prune_tree</span><span class="grouping">(</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">check_apply_path_readonly</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_readonly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">t</span><span class="invalid">y</span><span class="invalid">p</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="punctuation">,</span>
                                                          <span class="identifier">copy</span><span class="arithmetic-assignment">=</span><span class="bool-literal">False</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">y_readonly</span> <span class="arithmetic-assignment">=</span> <span class="identifier">create_memmap_backed_data</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">y_small</span><span class="punctuation">,</span>
                                                    <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">_tree</span><span class="punctuation">.</span><span class="identifier">DTYPE</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">est</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ALL_TREES</span><span class="grouping">[</span><span class="identifier">name</span><span class="grouping">]</span><span class="grouping">(</span><span class="grouping">)</span>
    <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_readonly</span><span class="punctuation">,</span> <span class="identifier">y_readonly</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_readonly</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="invalid">_</span><span class="invalid">e</span><span class="invalid">q</span><span class="invalid">u</span><span class="invalid">a</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X_readonly</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">todense</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">,</span>
                       <span class="identifier">est</span><span class="punctuation">.</span><span class="identifier">decision_path</span><span class="grouping">(</span><span class="identifier">X_small</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">todense</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"name"</span><span class="punctuation">,</span> <span class="identifier">ALL_TREES</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_apply_path_readonly_all_trees</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">check_apply_path_readonly</span><span class="grouping">(</span><span class="identifier">name</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span>
    <span class="string-literal">"criterion", ["squared_error", "friedman_mse", "poisson"</span><span class="grouping">]</span>
<span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Tree"</span><span class="punctuation">,</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_balance_property</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="punctuation">,</span> <span class="identifier">Tree</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that sum(y_pred)=sum(y_true) on training set.</span>
    <span class="comment"># This works if the mean is predicted (should even be true for each leaf).</span>
    <span class="comment"># MAE predicts the median and is therefore excluded from this test.</span>

    <span class="comment"># Choose a training set with non-negative targets (for poisson)</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">data</span><span class="punctuation">,</span> <span class="identifier">diabetes</span><span class="punctuation">.</span><span class="identifier">target</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">approx</span><span class="grouping">(</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"seed"</span><span class="punctuation">,</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_poisson_zero_nodes</span><span class="grouping">(</span><span class="identifier">seed</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># Test that sum(y)=0 and therefore y_pred=0 is forbidden on nodes.</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span>
         <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span>
    <span class="comment"># Note that X[:, 0] == 0 is a 100% indicator for y == 0. The tree can</span>
    <span class="comment"># easily learn that:</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_error"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">amin</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="int-literal">0</span>
    <span class="comment"># whereas Poisson must predict strictly positive numbers</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"poisson"</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span>

    <span class="comment"># Test additional dataset where something could go wrong.</span>
    <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span>
    <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_regression</span><span class="grouping">(</span>
        <span class="identifier">effective_rank</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">tail_strength</span><span class="arithmetic-assignment">=</span><span class="float-literal">0.6</span><span class="punctuation">,</span>
        <span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="invalid">_</span><span class="int-literal">000</span><span class="punctuation">,</span>
        <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span>
        <span class="identifier">n_informative</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">//</span> <span class="int-literal">3</span><span class="punctuation">,</span>
        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="punctuation">,</span>
    <span class="grouping">)</span>
    <span class="comment"># some excess zeros</span>
    <span class="identifier">y</span><span class="grouping">[</span><span class="grouping">(</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span> <span class="relational-operator">&lt;</span> <span class="identifier">y</span><span class="grouping">)</span> <span class="bitwise-operator">&</span> <span class="grouping">(</span><span class="identifier">y</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="grouping">)</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">0</span>
    <span class="comment"># make sure the target is positive</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">abs</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span>
    <span class="identifier">reg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">'poisson'</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">seed</span><span class="grouping">)</span>
    <span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="keyword">assert</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">all</span><span class="grouping">(</span><span class="identifier">reg</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="grouping">)</span>


<span class="keyword">def</span> <span class="identifier">test_poisson_vs_mse</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment"># For a Poisson distributed target, Poisson loss should give better results</span>
    <span class="comment"># than squared error measured in Poisson deviance as metric.</span>
    <span class="comment"># We have a similar test, test_poisson(), in</span>
    <span class="comment"># sklearn/ensemble/_hist_gradient_boosting/tests/test_gradient_boosting.py</span>
    <span class="comment"># Note: Some fine tuning was needed to have metric_poi &lt; metric_dummy on</span>
    <span class="comment"># the test set!</span>
    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="identifier">n_train</span><span class="punctuation">,</span> <span class="identifier">n_test</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">500</span><span class="punctuation">,</span> <span class="int-literal">10</span>
    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">datasets</span><span class="punctuation">.</span><span class="identifier">make_low_rank_matrix</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="arithmetic-assignment">=</span><span class="identifier">n_train</span> <span class="arithmetic-operator">+</span> <span class="identifier">n_test</span><span class="punctuation">,</span>
                                      <span class="identifier">n_features</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="comment"># We create a log-linear Poisson model and downscale coef as it will get</span>
    <span class="comment"># exponentiated.</span>
    <span class="identifier">coef</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">uniform</span><span class="grouping">(</span><span class="identifier">low</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">high</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_features</span><span class="grouping">)</span> <span class="arithmetic-operator">/</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">max</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">poisson</span><span class="grouping">(</span><span class="identifier">lam</span><span class="arithmetic-assignment">=</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">X</span> <span class="punctuation">@</span> <span class="identifier">coef</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">X_test</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="identifier">y_test</span> <span class="arithmetic-assignment">=</span> <span class="identifier">train_test_split</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">test_size</span><span class="arithmetic-assignment">=</span><span class="identifier">n_test</span><span class="punctuation">,</span>
                                                        <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="comment"># We prevent some overfitting by setting min_samples_split=10.</span>
    <span class="identifier">tree_poi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"poisson"</span><span class="punctuation">,</span>
                                     <span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>
    <span class="identifier">tree_mse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="string-literal">"squared_error"</span><span class="punctuation">,</span>
                                     <span class="identifier">min_samples_split</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span>
                                     <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="identifier">rng</span><span class="grouping">)</span>

    <span class="identifier">tree_poi</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">tree_mse</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>
    <span class="identifier">dummy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DummyRegressor</span><span class="grouping">(</span><span class="identifier">strategy</span><span class="arithmetic-assignment">=</span><span class="string-literal">"mean"</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="grouping">)</span>

    <span class="keyword">for</span> <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">val</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">X_train</span><span class="punctuation">,</span> <span class="identifier">y_train</span><span class="punctuation">,</span> <span class="string-literal">"train"), (X_test, y_test, "test"</span><span class="grouping">)</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">metric_poi</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_poisson_deviance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">tree_poi</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># squared_error might produce non-positive predictions =&gt; clip</span>
        <span class="identifier">metric_mse</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_poisson_deviance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">clip</span><span class="grouping">(</span><span class="identifier">tree_mse</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span>
                                                      <span class="float-literal">1e-15</span><span class="punctuation">,</span> <span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">metric_dummy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">mean_poisson_deviance</span><span class="grouping">(</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">dummy</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="comment"># As squared_error might correctly predict 0 in train set, its train</span>
        <span class="comment"># score can be better than Poisson. This is no longer the case for the</span>
        <span class="comment"># test set.</span>
        <span class="keyword">if</span> <span class="identifier">val</span> <span class="relational-operator">==</span> <span class="string-literal">"test"</span><span class="punctuation">:</span>
            <span class="keyword">assert</span> <span class="identifier">metric_poi</span> <span class="relational-operator">&lt;</span> <span class="identifier">metric_mse</span>
        <span class="keyword">assert</span> <span class="identifier">metric_poi</span> <span class="relational-operator">&lt;</span> <span class="identifier">metric_dummy</span>


<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">'criterion'</span><span class="punctuation">,</span> <span class="identifier">REG_CRITERIONS</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_decision_tree_regressor_sample_weight_consistentcy</span><span class="grouping">(</span>
        <span class="identifier">criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">"""Test that the impact of sample_weight is consistent."""</span>
    <span class="identifier">tree_params</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">criterion</span><span class="grouping">)</span>
    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">tree_params</span><span class="punctuation">,</span> <span class="identifier">random_state</span><span class="arithmetic-assignment">=</span><span class="int-literal">42</span><span class="grouping">)</span>
    <span class="keyword">for</span> <span class="identifier">kind</span> <span class="relational-operator">in</span> <span class="grouping">[</span><span class="string-literal">'zeros', 'ones'</span><span class="grouping">]</span><span class="punctuation">:</span>
        <span class="identifier">check_sample_weights_invariance</span><span class="grouping">(</span><span class="string-literal">"DecisionTreeRegressor_"</span> <span class="arithmetic-operator">+</span> <span class="identifier">criterion</span><span class="punctuation">,</span>
                                        <span class="identifier">tree</span><span class="punctuation">,</span> <span class="identifier">kind</span><span class="arithmetic-assignment">=</span><span class="string-literal">'zeros'</span><span class="grouping">)</span>

    <span class="identifier">rng</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">random</span><span class="punctuation">.</span><span class="identifier">RandomState</span><span class="grouping">(</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">10</span><span class="punctuation">,</span> <span class="int-literal">5</span>

    <span class="identifier">X</span> <span class="arithmetic-assignment">=</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="punctuation">,</span> <span class="identifier">n_features</span><span class="grouping">)</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">mean</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="identifier">rng</span><span class="punctuation">.</span><span class="identifier">rand</span><span class="grouping">(</span><span class="identifier">n_samples</span><span class="grouping">)</span>
    <span class="comment"># make it positive in order to work also for poisson criterion</span>
    <span class="identifier">y</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">0.1</span>

    <span class="comment"># check that multiplying sample_weight by 2 is equivalent</span>
    <span class="comment"># to repeating corresponding samples twice</span>
    <span class="identifier">X2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">X</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="arithmetic-operator">//</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>
    <span class="identifier">y2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="arithmetic-operator">//</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
    <span class="identifier">sample_weight_1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">ones</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">y</span><span class="grouping">)</span><span class="grouping">)</span>
    <span class="identifier">sample_weight_1</span><span class="grouping">[</span><span class="punctuation">:</span><span class="identifier">n_samples</span><span class="arithmetic-operator">//</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span>

    <span class="identifier">tree1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">tree_params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
            <span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="identifier">sample_weight_1</span>
    <span class="grouping">)</span>

    <span class="identifier">tree2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">DecisionTreeRegressor</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">tree_params</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span>
            <span class="identifier">X2</span><span class="punctuation">,</span> <span class="identifier">y2</span><span class="punctuation">,</span> <span class="identifier">sample_weight</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span>
    <span class="grouping">)</span>

    <span class="keyword">assert</span> <span class="identifier">tree1</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span> <span class="relational-operator">==</span> <span class="identifier">tree2</span><span class="punctuation">.</span><span class="identifier">tree_</span><span class="punctuation">.</span><span class="identifier">node_count</span>
    <span class="comment"># Thresholds, tree.tree_.threshold, and values, tree.tree_.value, are not</span>
    <span class="comment"># exactly the same, but on the training set, those differences do not</span>
    <span class="comment"># matter and thus predictions are the same.</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree1</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">tree2</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove in v1.1</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"TreeEstimator"</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">DecisionTreeClassifier</span><span class="punctuation">,</span>
                                           <span class="identifier">DecisionTreeRegressor</span><span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_X_idx_sorted_deprecated</span><span class="grouping">(</span><span class="identifier">TreeEstimator</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">X_idx_sorted</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="grouping">)</span>

    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">TreeEstimator</span><span class="grouping">(</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="string-literal">"The parameter 'X_idx_sorted' is deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="punctuation">,</span> <span class="identifier">X_idx_sorted</span><span class="arithmetic-assignment">=</span><span class="identifier">X_idx_sorted</span><span class="grouping">)</span>


<span class="comment"># TODO: Remove in v1.2</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"Tree"</span><span class="punctuation">,</span> <span class="identifier">REG_TREES</span><span class="punctuation">.</span><span class="identifier">values</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">)</span>
<span class="punctuation">@</span><span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">mark</span><span class="punctuation">.</span><span class="identifier">parametrize</span><span class="grouping">(</span><span class="string-literal">"old_criterion, new_criterion"</span><span class="punctuation">,</span> <span class="grouping">[</span>
    <span class="grouping">(</span><span class="string-literal">"mse", "squared_error"</span><span class="grouping">)</span><span class="punctuation">,</span>
    <span class="grouping">(</span><span class="string-literal">"mae", "absolute_error"</span><span class="grouping">)</span><span class="punctuation">,</span>
<span class="grouping">]</span><span class="grouping">)</span>
<span class="keyword">def</span> <span class="identifier">test_criterion_deprecated</span><span class="grouping">(</span><span class="identifier">Tree</span><span class="punctuation">,</span> <span class="identifier">old_criterion</span><span class="punctuation">,</span> <span class="identifier">new_criterion</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="identifier">tree</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">old_criterion</span><span class="grouping">)</span>

    <span class="keyword">with</span> <span class="identifier">pytest</span><span class="punctuation">.</span><span class="identifier">warns</span><span class="grouping">(</span><span class="identifier">FutureWarning</span><span class="punctuation">,</span>
                      <span class="identifier">match</span><span class="arithmetic-assignment">=</span><span class="identifier">f</span><span class="string-literal">"Criterion '{old_criterion}' was deprecated"</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>

    <span class="identifier">tree_new</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Tree</span><span class="grouping">(</span><span class="identifier">criterion</span><span class="arithmetic-assignment">=</span><span class="identifier">new_criterion</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">fit</span><span class="grouping">(</span><span class="identifier">X</span><span class="punctuation">,</span> <span class="identifier">y</span><span class="grouping">)</span>
    <span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">e</span><span class="invalid">r</span><span class="invalid">t</span><span class="invalid">_</span><span class="invalid">a</span><span class="invalid">l</span><span class="invalid">l</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">o</span><span class="invalid">s</span><span class="invalid">e</span><span class="grouping">(</span><span class="identifier">tree</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">tree_new</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">X</span><span class="grouping">)</span><span class="grouping">)</span>

    </pre>
  </body>
</html>