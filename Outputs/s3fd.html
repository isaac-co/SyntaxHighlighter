<html>
  <head>
    <title>Python Lexical Highliter</title>
    <link rel="stylesheet" href="token_colors.css">
  </head>
  <body>
    <pre><span class="comment">#!/usr/bin/env python3</span>
<span class="comment">""" S3FD Face detection plugin
https://arxiv.org/abs/1708.05237

Adapted from S3FD Port in FAN:
https://github.com/1adrianb/face-alignment
"""</span>

<span class="keyword">from</span> <span class="identifier">scipy</span><span class="punctuation">.</span><span class="identifier">special</span> <span class="keyword">import</span> <span class="identifier">logsumexp</span>
<span class="keyword">import</span> <span class="identifier">numpy</span> <span class="keyword">as</span> <span class="identifier">np</span>
<span class="keyword">import</span> <span class="identifier">keras</span>  <span class="comment"># pylint:disable=import-error</span>
<span class="keyword">import</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">backend</span> <span class="keyword">as</span> <span class="identifier">K</span>  <span class="comment"># pylint:disable=import-error</span>
<span class="keyword">from</span> <span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span> <span class="keyword">import</span> <span class="identifier">Concatenate</span><span class="punctuation">,</span> <span class="identifier">Conv2D</span><span class="punctuation">,</span> <span class="identifier">Input</span><span class="punctuation">,</span> <span class="identifier">Maximum</span><span class="punctuation">,</span> <span class="identifier">MaxPooling2D</span><span class="punctuation">,</span> <span class="identifier">ZeroPadding2D</span>

<span class="keyword">from</span> <span class="identifier">lib</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">session</span> <span class="keyword">import</span> <span class="identifier">KSession</span>
<span class="keyword">from</span> <span class="punctuation">.</span><span class="identifier">_base</span> <span class="keyword">import</span> <span class="identifier">Detector</span><span class="punctuation">,</span> <span class="identifier">logger</span>


<span class="keyword">class</span> <span class="identifier">Detect</span><span class="grouping">(</span><span class="identifier">Detector</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" S3FD detector for face recognition """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">git_model_id</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">11</span>
        <span class="identifier">model_filename</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"s3fd_keras_v2.h5"</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">git_model_id</span><span class="arithmetic-assignment">=</span><span class="identifier">git_model_id</span><span class="punctuation">,</span> <span class="identifier">model_filename</span><span class="arithmetic-assignment">=</span><span class="identifier">model_filename</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"S3FD"</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">input_size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">640</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">4112</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram_warnings</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1024</span>  <span class="comment"># Will run at this with warnings</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">vram_per_batch</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">208</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">batchsize</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"batch-size"</span><span class="grouping">]</span>

    <span class="keyword">def</span> <span class="identifier">init_model</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Initialize S3FD Model"""</span>
        <span class="identifier">confidence</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"confidence"</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="int-literal">100</span>
        <span class="identifier">model_kwargs</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">custom_objects</span><span class="arithmetic-assignment">=</span><span class="identifier">dict</span><span class="grouping">(</span><span class="identifier">L2Norm</span><span class="arithmetic-assignment">=</span><span class="identifier">L2Norm</span><span class="punctuation">,</span> <span class="identifier">SliceO2K</span><span class="arithmetic-assignment">=</span><span class="identifier">SliceO2K</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span> <span class="arithmetic-assignment">=</span> <span class="identifier">S3fd</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_path</span><span class="punctuation">,</span>
                          <span class="identifier">model_kwargs</span><span class="punctuation">,</span>
                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">config</span><span class="grouping">[</span><span class="string-literal">"allow_growth"</span><span class="grouping">]</span><span class="punctuation">,</span>
                          <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_exclude_gpus</span><span class="punctuation">,</span>
                          <span class="identifier">confidence</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">process_input</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile the detection image(s) for prediction """</span>
        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"feed"] = self.model.prepare_batch(batch["image"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Run model to get predictions """</span>
        <span class="identifier">predictions</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">predict</span><span class="grouping">(</span><span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"feed"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">batch</span><span class="grouping">[</span><span class="string-literal">"prediction"</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model</span><span class="punctuation">.</span><span class="identifier">finalize_predictions</span><span class="grouping">(</span><span class="identifier">predictions</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">trace</span><span class="grouping">(</span><span class="string-literal">"filename: %s, prediction: %s", batch["filename"], batch["prediction"</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">process_output</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Compile found faces for output """</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>


<span class="comment">################################################################################</span>
<span class="comment"># CUSTOM KERAS LAYERS</span>
<span class="comment">################################################################################</span>
<span class="keyword">class</span> <span class="identifier">L2Norm</span><span class="grouping">(</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="punctuation">.</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" L2 Normalization layer for S3FD.

    Parameters
    ----------
    n_channels: int
        The number of channels to normalize
    scale: float, optional
        The scaling for initial weights. Default: `1.0`
    """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">n_channels</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_n_channels</span> <span class="arithmetic-assignment">=</span> <span class="identifier">n_channels</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale</span> <span class="arithmetic-assignment">=</span> <span class="identifier">scale</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">add_weight</span><span class="grouping">(</span><span class="string-literal">"l2norm"</span><span class="punctuation">,</span>  <span class="comment"># pylint:disable=invalid-name</span>
                                 <span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_n_channels</span><span class="punctuation">,</span> <span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">trainable</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="punctuation">,</span>
                                 <span class="identifier">initializer</span><span class="arithmetic-assignment">=</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">initializers</span><span class="punctuation">.</span><span class="identifier">Constant</span><span class="grouping">(</span><span class="identifier">value</span><span class="arithmetic-assignment">=</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale</span><span class="grouping">)</span><span class="punctuation">,</span>
                                 <span class="identifier">dtype</span><span class="arithmetic-assignment">=</span><span class="string-literal">"float32"</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Call the L2 Normalization Layer.

        Parameters
        ----------
        inputs: tensor
            The input to the L2 Normalization Layer

        Returns
        -------
        tensor:
            The output from the L2 Normalization Layer
        """</span>
        <span class="identifier">norm</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">sqrt</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">sum</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">pow</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span> <span class="arithmetic-operator">+</span> <span class="float-literal">1e-10</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inputs</span> <span class="arithmetic-operator">/</span> <span class="identifier">norm</span> <span class="arithmetic-operator">*</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">w</span>
        <span class="keyword">return</span> <span class="identifier">var_x</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Returns the config of the layer.

        Returns
        -------
        dict
            The configuration for the layer
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"n_channels"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_n_channels</span><span class="punctuation">,</span>
                       <span class="string-literal">"scale"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_scale</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">config</span>


<span class="keyword">class</span> <span class="identifier">SliceO2K</span><span class="grouping">(</span><span class="identifier">keras</span><span class="punctuation">.</span><span class="identifier">layers</span><span class="punctuation">.</span><span class="identifier">Layer</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Custom Keras Slice layer generated by onnx2keras. """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">starts</span><span class="punctuation">,</span> <span class="identifier">ends</span><span class="punctuation">,</span> <span class="identifier">axes</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_starts</span> <span class="arithmetic-assignment">=</span> <span class="identifier">starts</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_ends</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ends</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">axes</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_steps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">steps</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">_get_slices</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">dimensions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Obtain slices for the given number of dimensions.

        Parameters
        ----------
        dimensions: int
            The number of dimensions to obtain slices for

        Returns
        -------
        list
            The slices for the given number of dimensions
        """</span>
        <span class="identifier">axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_axes</span>
        <span class="identifier">steps</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_steps</span>
        <span class="keyword">if</span> <span class="identifier">axes</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">axes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">range</span><span class="grouping">(</span><span class="identifier">dimensions</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">if</span> <span class="identifier">steps</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
            <span class="identifier">steps</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">axes</span><span class="grouping">)</span>
        <span class="keyword">assert</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">axes</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">steps</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_starts</span><span class="grouping">)</span> <span class="relational-operator">==</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_ends</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">zip</span><span class="grouping">(</span><span class="identifier">axes</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_starts</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_ends</span><span class="punctuation">,</span> <span class="identifier">steps</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">compute_output_shape</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">input_shape</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Computes the output shape of the layer.

        Assumes that the layer will be built to match that input shape provided.

        Parameters
        ----------
        input_shape: tuple or list of tuples
            Shape tuple (tuple of integers) or list of shape tuples (one per output tensor of the
            layer). Shape tuples can include ``None`` for free dimensions, instead of an integer.

        Returns
        -------
        tuple
            An output shape tuple.
        """</span>
        <span class="identifier">input_shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">a_x</span><span class="punctuation">,</span> <span class="identifier">start</span><span class="punctuation">,</span> <span class="identifier">end</span><span class="punctuation">,</span> <span class="identifier">steps</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_slices</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">a_x</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">a_x</span> <span class="relational-operator">==</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="keyword">raise</span> <span class="identifier">AttributeError</span><span class="grouping">(</span><span class="string-literal">"Can not slice batch axis."</span><span class="grouping">)</span>
            <span class="keyword">if</span> <span class="identifier">size</span> <span class="relational-operator">is</span> <span class="none-literal">None</span><span class="punctuation">:</span>
                <span class="keyword">if</span> <span class="identifier">start</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span> <span class="logical-operator">or</span> <span class="identifier">end</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                    <span class="keyword">raise</span> <span class="identifier">AttributeError</span><span class="grouping">(</span><span class="string-literal">"Negative slices not supported on symbolic axes"</span><span class="grouping">)</span>
                <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">warning</span><span class="grouping">(</span><span class="string-literal">"Slicing symbolic axis might lead to problems."</span><span class="grouping">)</span>
                <span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">a_x</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">end</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">steps</span>
                <span class="keyword">continue</span>
            <span class="keyword">if</span> <span class="identifier">start</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">start</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span>
            <span class="keyword">if</span> <span class="identifier">end</span> <span class="relational-operator">&lt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">end</span> <span class="arithmetic-assignment">=</span> <span class="identifier">size</span> <span class="arithmetic-operator">-</span> <span class="identifier">end</span>
            <span class="identifier">input_shape</span><span class="grouping">[</span><span class="identifier">a_x</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">min</span><span class="grouping">(</span><span class="identifier">size</span><span class="punctuation">,</span> <span class="identifier">end</span><span class="grouping">)</span> <span class="arithmetic-operator">-</span> <span class="identifier">start</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="identifier">steps</span>
        <span class="keyword">return</span> <span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">input_shape</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">call</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="arithmetic-operator">**</span><span class="identifier">kwargs</span><span class="grouping">)</span><span class="punctuation">:</span>  <span class="comment"># pylint:disable=unused-argument</span>
        <span class="comment">"""This is where the layer's logic lives.

        Parameters
        ----------
        inputs: Input tensor, or list/tuple of input tensors.
            The input to the layer
        **kwargs: Additional keyword arguments.
            Required for parent class but unused
        Returns
        -------
        A tensor or list/tuple of tensors.
            The layer output
        """</span>
        <span class="identifier">ax_map</span> <span class="arithmetic-assignment">=</span> <span class="identifier">dict</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">x</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">x</span> <span class="relational-operator">in</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_get_slices</span><span class="grouping">(</span><span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">ndim</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">shape</span> <span class="arithmetic-assignment">=</span> <span class="identifier">K</span><span class="punctuation">.</span><span class="identifier">int_shape</span><span class="grouping">(</span><span class="identifier">inputs</span><span class="grouping">)</span>
        <span class="identifier">slices</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="grouping">(</span><span class="identifier">ax_map</span><span class="grouping">[</span><span class="identifier">a</span><span class="grouping">]</span> <span class="keyword">if</span> <span class="identifier">a</span> <span class="relational-operator">in</span> <span class="identifier">ax_map</span> <span class="keyword">else</span> <span class="identifier">slice</span><span class="grouping">(</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">)</span> <span class="keyword">for</span> <span class="identifier">a</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">shape</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inputs</span><span class="grouping">[</span><span class="identifier">tuple</span><span class="grouping">(</span><span class="identifier">slices</span><span class="grouping">)</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">retval</span>

    <span class="keyword">def</span> <span class="identifier">get_config</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Returns the config of the layer.

        Returns
        -------
        dict
            The configuration for the layer
        """</span>
        <span class="identifier">config</span> <span class="arithmetic-assignment">=</span> <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">get_config</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">config</span><span class="punctuation">.</span><span class="identifier">update</span><span class="grouping">(</span><span class="grouping">{</span><span class="string-literal">"starts"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_starts</span><span class="punctuation">,</span>
                       <span class="string-literal">"ends"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_ends</span><span class="punctuation">,</span>
                       <span class="string-literal">"axes"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_axes</span><span class="punctuation">,</span>
                       <span class="string-literal">"steps"</span><span class="punctuation">:</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_steps</span><span class="grouping">}</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">config</span>


<span class="keyword">class</span> <span class="identifier">S3fd</span><span class="grouping">(</span><span class="identifier">KSession</span><span class="grouping">)</span><span class="punctuation">:</span>
    <span class="comment">""" Keras Network """</span>
    <span class="keyword">def</span> <span class="identifier">__init__</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="punctuation">,</span> <span class="identifier">model_kwargs</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="punctuation">,</span> <span class="identifier">confidence</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initializing: %s: (model_path: '%s', model_kwargs: %s, allow_growth: %s, "</span>
                     <span class="string-literal">"exclude_gpus: %s, confidence: %s)"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="punctuation">,</span> <span class="identifier">model_path</span><span class="punctuation">,</span>
                     <span class="identifier">model_kwargs</span><span class="punctuation">,</span> <span class="identifier">allow_growth</span><span class="punctuation">,</span> <span class="identifier">exclude_gpus</span><span class="punctuation">,</span> <span class="identifier">confidence</span><span class="grouping">)</span>
        <span class="identifier">super</span><span class="grouping">(</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">__init__</span><span class="grouping">(</span><span class="string-literal">"S3FD"</span><span class="punctuation">,</span>
                         <span class="identifier">model_path</span><span class="punctuation">,</span>
                         <span class="identifier">model_kwargs</span><span class="arithmetic-assignment">=</span><span class="identifier">model_kwargs</span><span class="punctuation">,</span>
                         <span class="identifier">allow_growth</span><span class="arithmetic-assignment">=</span><span class="identifier">allow_growth</span><span class="punctuation">,</span>
                         <span class="identifier">exclude_gpus</span><span class="arithmetic-assignment">=</span><span class="identifier">exclude_gpus</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">f</span><span class="invalid">i</span><span class="invalid">n</span><span class="invalid">e</span><span class="invalid">_</span><span class="invalid">m</span><span class="invalid">o</span><span class="invalid">d</span><span class="invalid">e</span><span class="invalid">l</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">model_definition</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">load_model_weights</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">confidence</span> <span class="arithmetic-assignment">=</span> <span class="identifier">confidence</span>
        <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">average_img</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="float-literal">104.0</span><span class="punctuation">,</span> <span class="float-literal">117.0</span><span class="punctuation">,</span> <span class="float-literal">123.0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">logger</span><span class="punctuation">.</span><span class="identifier">debug</span><span class="grouping">(</span><span class="string-literal">"Initialized: %s"</span><span class="punctuation">,</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">__class__</span><span class="punctuation">.</span><span class="identifier">__name__</span><span class="grouping">)</span>

    <span class="keyword">def</span> <span class="identifier">model_definition</span><span class="grouping">(</span><span class="identifier">self</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Keras S3FD Model Definition, adapted from FAN pytorch implementation. """</span>
        <span class="identifier">input_</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Input</span><span class="grouping">(</span><span class="identifier">shape</span><span class="arithmetic-assignment">=</span><span class="grouping">(</span><span class="int-literal">640</span><span class="punctuation">,</span> <span class="int-literal">640</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_block</span><span class="grouping">(</span><span class="identifier">input_</span><span class="punctuation">,</span> <span class="int-literal">64</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPooling2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_block</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPooling2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_block</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">f3_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var_x</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPooling2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_block</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="int-literal">512</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">f4_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var_x</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPooling2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_block</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="int-literal">512</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span>
        <span class="identifier">f5_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var_x</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">MaxPooling2D</span><span class="grouping">(</span><span class="identifier">pool_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">2</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>

        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">3</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">1024</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"relu", name="fc6"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">1024</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"relu", name="fc7"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="identifier">ffc7</span> <span class="arithmetic-assignment">=</span> <span class="identifier">var_x</span>

        <span class="identifier">f6_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_up</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="punctuation">,</span> <span class="int-literal">256</span><span class="punctuation">,</span> <span class="int-literal">6</span><span class="grouping">)</span>
        <span class="identifier">f7_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">conv_up</span><span class="grouping">(</span><span class="identifier">f6_2</span><span class="punctuation">,</span> <span class="int-literal">128</span><span class="punctuation">,</span> <span class="int-literal">7</span><span class="grouping">)</span>

        <span class="identifier">f3_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">L2Norm</span><span class="grouping">(</span><span class="int-literal">256</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">10</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv3_3_norm"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f3_3</span><span class="grouping">)</span>
        <span class="identifier">f4_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">L2Norm</span><span class="grouping">(</span><span class="int-literal">512</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">8</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv4_3_norm"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f4_3</span><span class="grouping">)</span>
        <span class="identifier">f5_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">L2Norm</span><span class="grouping">(</span><span class="int-literal">512</span><span class="punctuation">,</span> <span class="identifier">scale</span><span class="arithmetic-assignment">=</span><span class="int-literal">5</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv5_3_norm"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f5_3</span><span class="grouping">)</span>

        <span class="identifier">f3_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f3_3</span><span class="grouping">)</span>
        <span class="identifier">cls1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv3_3_norm_mbox_conf"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f3_3</span><span class="grouping">)</span>
        <span class="identifier">reg1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv3_3_norm_mbox_loc"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f3_3</span><span class="grouping">)</span>

        <span class="identifier">f4_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f4_3</span><span class="grouping">)</span>
        <span class="identifier">cls2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv4_3_norm_mbox_conf"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f4_3</span><span class="grouping">)</span>
        <span class="identifier">reg2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv4_3_norm_mbox_loc"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f4_3</span><span class="grouping">)</span>

        <span class="identifier">f5_3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f5_3</span><span class="grouping">)</span>
        <span class="identifier">cls3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv5_3_norm_mbox_conf"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f5_3</span><span class="grouping">)</span>
        <span class="identifier">reg3</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv5_3_norm_mbox_loc"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f5_3</span><span class="grouping">)</span>

        <span class="identifier">ffc7</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">ffc7</span><span class="grouping">)</span>
        <span class="identifier">cls4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fc7_mbox_conf"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">ffc7</span><span class="grouping">)</span>
        <span class="identifier">reg4</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"fc7_mbox_loc"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">ffc7</span><span class="grouping">)</span>

        <span class="identifier">f6_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f6_2</span><span class="grouping">)</span>
        <span class="identifier">cls5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv6_2_mbox_conf"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f6_2</span><span class="grouping">)</span>
        <span class="identifier">reg5</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv6_2_mbox_loc"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f6_2</span><span class="grouping">)</span>

        <span class="identifier">f7_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f7_2</span><span class="grouping">)</span>
        <span class="identifier">cls6</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">2</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv7_2_mbox_conf"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f7_2</span><span class="grouping">)</span>
        <span class="identifier">reg6</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="int-literal">4</span><span class="punctuation">,</span> <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span> <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"conv7_2_mbox_loc"</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">f7_2</span><span class="grouping">)</span>

        <span class="comment"># max-out background label</span>
        <span class="identifier">chunks</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">SliceO2K</span><span class="grouping">(</span><span class="identifier">starts</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ends</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">cls1</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">SliceO2K</span><span class="grouping">(</span><span class="identifier">starts</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ends</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">cls1</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">SliceO2K</span><span class="grouping">(</span><span class="identifier">starts</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ends</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">cls1</span><span class="grouping">)</span><span class="punctuation">,</span>
                  <span class="identifier">SliceO2K</span><span class="grouping">(</span><span class="identifier">starts</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">ends</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axes</span><span class="arithmetic-assignment">=</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">steps</span><span class="arithmetic-assignment">=</span><span class="none-literal">None</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">cls1</span><span class="grouping">)</span><span class="grouping">]</span>

        <span class="identifier">bmax</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Maximum</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">chunks</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">chunks</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">chunks</span><span class="grouping">[</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="identifier">cls1</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Concatenate</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">bmax</span><span class="punctuation">,</span> <span class="identifier">chunks</span><span class="grouping">[</span><span class="int-literal">3</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>

        <span class="keyword">return</span> <span class="grouping">[</span><span class="identifier">input_</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="grouping">[</span><span class="identifier">cls1</span><span class="punctuation">,</span> <span class="identifier">reg1</span><span class="punctuation">,</span> <span class="identifier">cls2</span><span class="punctuation">,</span> <span class="identifier">reg2</span><span class="punctuation">,</span> <span class="identifier">cls3</span><span class="punctuation">,</span> <span class="identifier">reg3</span><span class="punctuation">,</span> <span class="identifier">cls4</span><span class="punctuation">,</span> <span class="identifier">reg4</span><span class="punctuation">,</span> <span class="identifier">cls5</span><span class="punctuation">,</span> <span class="identifier">reg5</span><span class="punctuation">,</span> <span class="identifier">cls6</span><span class="punctuation">,</span> <span class="identifier">reg6</span><span class="grouping">]</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">conv_block</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">filters</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="punctuation">,</span> <span class="identifier">recursions</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" First round convolutions with zero padding added.

        Parameters
        ----------
        inputs: tensor
            The input tensor to the convolution block
        filters: int
            The number of filters
        idx: int
            The layer index for naming
        recursions: int
            The number of recursions of the block to perform

        Returns
        -------
        tensor
            The output tensor from the convolution block
        """</span>
        <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"conv{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inputs</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">recursions</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">rec_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">)</span>
            <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"{}.zeropad"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">rec_name</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
            <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="identifier">filters</span><span class="punctuation">,</span>
                           <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="punctuation">,</span>
                           <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="punctuation">,</span>
                           <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"relu"</span><span class="punctuation">,</span>
                           <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">rec_name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">var_x</span>

    <span class="punctuation">@</span><span class="invalid">c</span><span class="invalid">l</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">s</span><span class="invalid">m</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">h</span><span class="invalid">o</span><span class="invalid">d</span>
    <span class="keyword">def</span> <span class="identifier">conv_up</span><span class="grouping">(</span><span class="identifier">cls</span><span class="punctuation">,</span> <span class="identifier">inputs</span><span class="punctuation">,</span> <span class="identifier">filters</span><span class="punctuation">,</span> <span class="identifier">idx</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Convolution up filter blocks with zero padding added.

        Parameters
        ----------
        inputs: tensor
            The input tensor to the convolution block
        filters: int
            The initial number of filters
        idx: int
            The layer index for naming

        Returns
        -------
        tensor
            The output tensor from the convolution block
        """</span>
        <span class="identifier">name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"conv{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">idx</span><span class="grouping">)</span>
        <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">inputs</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">rec_name</span> <span class="arithmetic-assignment">=</span> <span class="string-literal">"{}_{}"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">name</span><span class="punctuation">,</span> <span class="identifier">i</span><span class="grouping">)</span>
            <span class="identifier">size</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">1</span> <span class="keyword">if</span> <span class="identifier">i</span> <span class="relational-operator">==</span> <span class="int-literal">1</span> <span class="keyword">else</span> <span class="int-literal">3</span>
            <span class="keyword">if</span> <span class="identifier">i</span> <span class="relational-operator">==</span> <span class="int-literal">2</span><span class="punctuation">:</span>
                <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ZeroPadding2D</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="string-literal">"{}.zeropad"</span><span class="punctuation">.</span><span class="invalid">f</span><span class="invalid">o</span><span class="invalid">r</span><span class="invalid">m</span><span class="invalid">a</span><span class="invalid">t</span><span class="grouping">(</span><span class="identifier">rec_name</span><span class="grouping">)</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
            <span class="identifier">var_x</span> <span class="arithmetic-assignment">=</span> <span class="identifier">Conv2D</span><span class="grouping">(</span><span class="identifier">filters</span> <span class="arithmetic-operator">*</span> <span class="identifier">i</span><span class="punctuation">,</span>
                           <span class="identifier">kernel_size</span><span class="arithmetic-assignment">=</span><span class="identifier">size</span><span class="punctuation">,</span>
                           <span class="identifier">strides</span><span class="arithmetic-assignment">=</span><span class="identifier">i</span><span class="punctuation">,</span>
                           <span class="identifier">activation</span><span class="arithmetic-assignment">=</span><span class="string-literal">"relu"</span><span class="punctuation">,</span>
                           <span class="identifier">name</span><span class="arithmetic-assignment">=</span><span class="identifier">rec_name</span><span class="grouping">)</span><span class="grouping">(</span><span class="identifier">var_x</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">var_x</span>

    <span class="keyword">def</span> <span class="identifier">prepare_batch</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">batch</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Prepare a batch for prediction.

        Normalizes the feed images.

        Parameters
        ----------
        batch: class:`numpy.ndarray`
            The batch to be fed to the model

        Returns
        -------
        class:`numpy.ndarray`
            The normalized images for feeding to the model
        """</span>
        <span class="identifier">batch</span> <span class="arithmetic-assignment">=</span> <span class="identifier">batch</span> <span class="arithmetic-operator">-</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">average_img</span>
        <span class="keyword">return</span> <span class="identifier">batch</span>

    <span class="keyword">def</span> <span class="identifier">finalize_predictions</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bounding_boxes_scales</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Process the output from the model to obtain faces

        Parameters
        ----------
        bounding_boxes_scales: list
            The output predictions from the S3FD model
        """</span>
        <span class="identifier">ret</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="identifier">batch_size</span> <span class="arithmetic-assignment">=</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">bounding_boxes_scales</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">shape</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">img</span> <span class="relational-operator">in</span> <span class="identifier">batch_size</span><span class="punctuation">:</span>
            <span class="identifier">bboxlist</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="identifier">scale</span><span class="grouping">[</span><span class="identifier">img</span><span class="punctuation">:</span><span class="identifier">img</span><span class="arithmetic-operator">+</span><span class="int-literal">1</span><span class="grouping">]</span> <span class="keyword">for</span> <span class="identifier">scale</span> <span class="relational-operator">in</span> <span class="identifier">bounding_boxes_scales</span><span class="grouping">]</span>
            <span class="identifier">boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_post_process</span><span class="grouping">(</span><span class="identifier">bboxlist</span><span class="grouping">)</span>
            <span class="identifier">bboxlist</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">_nms</span><span class="grouping">(</span><span class="identifier">boxes</span><span class="punctuation">,</span> <span class="float-literal">0.5</span><span class="grouping">)</span>
            <span class="identifier">ret</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">bboxlist</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="identifier">ret</span>

    <span class="keyword">def</span> <span class="identifier">_post_process</span><span class="grouping">(</span><span class="identifier">self</span><span class="punctuation">,</span> <span class="identifier">bboxlist</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform post processing on output
            TODO: do this on the batch.
        """</span>
        <span class="identifier">retval</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bboxlist</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">bboxlist</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">softmax</span><span class="grouping">(</span><span class="identifier">bboxlist</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">3</span><span class="grouping">)</span>
        <span class="keyword">for</span> <span class="identifier">i</span> <span class="relational-operator">in</span> <span class="identifier">range</span><span class="grouping">(</span><span class="identifier">len</span><span class="grouping">(</span><span class="identifier">bboxlist</span><span class="grouping">)</span> <span class="arithmetic-operator">//</span> <span class="int-literal">2</span><span class="grouping">)</span><span class="punctuation">:</span>
            <span class="identifier">ocls</span><span class="punctuation">,</span> <span class="identifier">oreg</span> <span class="arithmetic-assignment">=</span> <span class="identifier">bboxlist</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">bboxlist</span><span class="grouping">[</span><span class="identifier">i</span> <span class="arithmetic-operator">*</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">stride</span> <span class="arithmetic-assignment">=</span> <span class="int-literal">2</span> <span class="arithmetic-operator">**</span> <span class="grouping">(</span><span class="identifier">i</span> <span class="arithmetic-operator">+</span> <span class="int-literal">2</span><span class="grouping">)</span>    <span class="comment"># 4,8,16,32,64,128</span>
            <span class="identifier">poss</span> <span class="arithmetic-assignment">=</span> <span class="identifier">zip</span><span class="grouping">(</span><span class="arithmetic-operator">*</span><span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">where</span><span class="grouping">(</span><span class="identifier">ocls</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="relational-operator">&gt;</span> <span class="float-literal">0.05</span><span class="grouping">)</span><span class="grouping">)</span>
            <span class="keyword">for</span> <span class="identifier">_</span><span class="punctuation">,</span> <span class="identifier">hindex</span><span class="punctuation">,</span> <span class="identifier">windex</span> <span class="relational-operator">in</span> <span class="identifier">poss</span><span class="punctuation">:</span>
                <span class="identifier">axc</span><span class="punctuation">,</span> <span class="identifier">ayc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">stride</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">windex</span> <span class="arithmetic-operator">*</span> <span class="identifier">stride</span><span class="punctuation">,</span> <span class="identifier">stride</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span> <span class="arithmetic-operator">+</span> <span class="identifier">hindex</span> <span class="arithmetic-operator">*</span> <span class="identifier">stride</span>
                <span class="identifier">score</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ocls</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">hindex</span><span class="punctuation">,</span> <span class="identifier">windex</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
                <span class="keyword">if</span> <span class="identifier">score</span> <span class="relational-operator">&gt;=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">confidence</span><span class="punctuation">:</span>
                    <span class="identifier">loc</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="invalid">a</span><span class="invalid">s</span><span class="invalid">c</span><span class="invalid">o</span><span class="invalid">n</span><span class="invalid">t</span><span class="invalid">i</span><span class="invalid">g</span><span class="invalid">u</span><span class="invalid">o</span><span class="invalid">u</span><span class="invalid">s</span><span class="invalid">a</span><span class="invalid">r</span><span class="invalid">r</span><span class="invalid">a</span><span class="invalid">y</span><span class="grouping">(</span><span class="identifier">oreg</span><span class="grouping">[</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">hindex</span><span class="punctuation">,</span> <span class="identifier">windex</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="grouping">]</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">reshape</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">)</span><span class="grouping">)</span>
                    <span class="identifier">priors</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="grouping">[</span><span class="grouping">[</span><span class="identifier">axc</span> <span class="arithmetic-operator">/</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">ayc</span> <span class="arithmetic-operator">/</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">stride</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span> <span class="arithmetic-operator">/</span> <span class="float-literal">1.0</span><span class="punctuation">,</span> <span class="identifier">stride</span> <span class="arithmetic-operator">*</span> <span class="int-literal">4</span> <span class="arithmetic-operator">/</span> <span class="float-literal">1.0</span><span class="grouping">]</span><span class="grouping">]</span><span class="grouping">)</span>
                    <span class="identifier">box</span> <span class="arithmetic-assignment">=</span> <span class="identifier">self</span><span class="punctuation">.</span><span class="identifier">decode</span><span class="grouping">(</span><span class="identifier">loc</span><span class="punctuation">,</span> <span class="identifier">priors</span><span class="grouping">)</span>
                    <span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span> <span class="arithmetic-assignment">=</span> <span class="identifier">box</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="float-literal">1.0</span>
                    <span class="identifier">retval</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="grouping">[</span><span class="identifier">x_1</span><span class="punctuation">,</span> <span class="identifier">y_1</span><span class="punctuation">,</span> <span class="identifier">x_2</span><span class="punctuation">,</span> <span class="identifier">y_2</span><span class="punctuation">,</span> <span class="identifier">score</span><span class="grouping">]</span><span class="grouping">)</span>
        <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">y</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">array</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span> <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">retval</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span> <span class="keyword">else</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">zeros</span><span class="grouping">(</span><span class="grouping">(</span><span class="int-literal">1</span><span class="punctuation">,</span> <span class="int-literal">5</span><span class="grouping">)</span><span class="grouping">)</span>
        <span class="keyword">return</span> <span class="invalid">r</span><span class="invalid">e</span><span class="invalid">t</span><span class="invalid">u</span><span class="invalid">r</span><span class="invalid">n</span><span class="invalid">_</span><span class="invalid">n</span><span class="invalid">u</span><span class="invalid">m</span><span class="invalid">p</span><span class="invalid">y</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">softmax</span><span class="grouping">(</span><span class="identifier">inp</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Compute softmax values for each sets of scores in x."""</span>
        <span class="keyword">return</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">inp</span> <span class="arithmetic-operator">-</span> <span class="identifier">logsumexp</span><span class="grouping">(</span><span class="identifier">inp</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="identifier">axis</span><span class="punctuation">,</span> <span class="identifier">keepdims</span><span class="arithmetic-assignment">=</span><span class="bool-literal">True</span><span class="grouping">)</span><span class="grouping">)</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">decode</span><span class="grouping">(</span><span class="identifier">location</span><span class="punctuation">,</span> <span class="identifier">priors</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">"""Decode locations from predictions using priors to undo the encoding we did for offset
        regression at train time.

        Parameters
        ----------
        location: tensor
            location predictions for location layers,
        priors: tensor
            Prior boxes in center-offset form.

        Returns
        -------
        :class:`numpy.ndarray`
            decoded bounding box predictions
        """</span>
        <span class="identifier">variances</span> <span class="arithmetic-assignment">=</span> <span class="grouping">[</span><span class="float-literal">0.1</span><span class="punctuation">,</span> <span class="float-literal">0.2</span><span class="grouping">]</span>
        <span class="identifier">boxes</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">concatenate</span><span class="grouping">(</span><span class="grouping">(</span><span class="identifier">priors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">location</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">variances</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">priors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span><span class="punctuation">,</span>
                                <span class="identifier">priors</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">exp</span><span class="grouping">(</span><span class="identifier">location</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">variances</span><span class="grouping">[</span><span class="int-literal">1</span><span class="grouping">]</span><span class="grouping">)</span><span class="grouping">)</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-assignment">-=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-operator">/</span> <span class="int-literal">2</span>
        <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="grouping">]</span> <span class="arithmetic-assignment">+=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">boxes</span>

    <span class="punctuation">@</span><span class="identifier">staticmethod</span>
    <span class="keyword">def</span> <span class="identifier">_nms</span><span class="grouping">(</span><span class="identifier">boxes</span><span class="punctuation">,</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="punctuation">:</span>
        <span class="comment">""" Perform Non-Maximum Suppression """</span>
        <span class="identifier">retained_box_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">list</span><span class="grouping">(</span><span class="grouping">)</span>

        <span class="identifier">areas</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span> <span class="arithmetic-operator">*</span> <span class="grouping">(</span><span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">3</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
        <span class="identifier">ranked_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">.</span><span class="identifier">argsort</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">:</span><span class="arithmetic-operator">-</span><span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">while</span> <span class="identifier">ranked_indices</span><span class="punctuation">.</span><span class="identifier">size</span> <span class="relational-operator">&gt;</span> <span class="int-literal">0</span><span class="punctuation">:</span>
            <span class="identifier">best</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ranked_indices</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">rest</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ranked_indices</span><span class="grouping">[</span><span class="int-literal">1</span><span class="punctuation">:</span><span class="grouping">]</span>

            <span class="identifier">max_of_xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">best</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">rest</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">2</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">min_of_xy</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">minimum</span><span class="grouping">(</span><span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">best</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">rest</span><span class="punctuation">,</span> <span class="int-literal">2</span><span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>
            <span class="identifier">width_height</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">maximum</span><span class="grouping">(</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">min_of_xy</span> <span class="arithmetic-operator">-</span> <span class="identifier">max_of_xy</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">)</span>
            <span class="identifier">intersection_areas</span> <span class="arithmetic-assignment">=</span> <span class="identifier">width_height</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">0</span><span class="grouping">]</span> <span class="arithmetic-operator">*</span> <span class="identifier">width_height</span><span class="grouping">[</span><span class="punctuation">:</span><span class="punctuation">,</span> <span class="int-literal">1</span><span class="grouping">]</span>
            <span class="identifier">iou</span> <span class="arithmetic-assignment">=</span> <span class="identifier">intersection_areas</span> <span class="arithmetic-operator">/</span> <span class="grouping">(</span><span class="identifier">areas</span><span class="grouping">[</span><span class="identifier">best</span><span class="grouping">]</span> <span class="arithmetic-operator">+</span> <span class="identifier">areas</span><span class="grouping">[</span><span class="identifier">rest</span><span class="grouping">]</span> <span class="arithmetic-operator">-</span> <span class="identifier">intersection_areas</span><span class="grouping">)</span>

            <span class="identifier">overlapping_boxes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">iou</span> <span class="relational-operator">&gt;</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">nonzero</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="keyword">if</span> <span class="identifier">len</span><span class="grouping">(</span><span class="identifier">overlapping_boxes</span><span class="grouping">)</span> <span class="relational-operator">!=</span> <span class="int-literal">0</span><span class="punctuation">:</span>
                <span class="identifier">overlap_set</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ranked_indices</span><span class="grouping">[</span><span class="identifier">overlapping_boxes</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
                <span class="identifier">vote</span> <span class="arithmetic-assignment">=</span> <span class="identifier">np</span><span class="punctuation">.</span><span class="identifier">average</span><span class="grouping">(</span><span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">overlap_set</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span><span class="punctuation">,</span> <span class="identifier">axis</span><span class="arithmetic-assignment">=</span><span class="int-literal">0</span><span class="punctuation">,</span> <span class="identifier">weights</span><span class="arithmetic-assignment">=</span><span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">overlap_set</span><span class="punctuation">,</span> <span class="int-literal">4</span><span class="grouping">]</span><span class="grouping">)</span>
                <span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">best</span><span class="punctuation">,</span> <span class="punctuation">:</span><span class="int-literal">4</span><span class="grouping">]</span> <span class="arithmetic-assignment">=</span> <span class="identifier">vote</span>
            <span class="identifier">retained_box_indices</span><span class="punctuation">.</span><span class="identifier">append</span><span class="grouping">(</span><span class="identifier">best</span><span class="grouping">)</span>

            <span class="identifier">non_overlapping_boxes</span> <span class="arithmetic-assignment">=</span> <span class="grouping">(</span><span class="identifier">iou</span> <span class="relational-operator">&lt;=</span> <span class="identifier">threshold</span><span class="grouping">)</span><span class="punctuation">.</span><span class="identifier">nonzero</span><span class="grouping">(</span><span class="grouping">)</span><span class="grouping">[</span><span class="int-literal">0</span><span class="grouping">]</span>
            <span class="identifier">ranked_indices</span> <span class="arithmetic-assignment">=</span> <span class="identifier">ranked_indices</span><span class="grouping">[</span><span class="identifier">non_overlapping_boxes</span> <span class="arithmetic-operator">+</span> <span class="int-literal">1</span><span class="grouping">]</span>
        <span class="keyword">return</span> <span class="identifier">boxes</span><span class="grouping">[</span><span class="identifier">retained_box_indices</span><span class="grouping">]</span>

    </pre>
  </body>
</html>